<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec44"></a>Spawning enemies with the help of a trigger</h2></div></div><hr /></div><p>Enemies are<a id="id344" class="indexterm"></a> computationally <a id="id345" class="indexterm"></a>expensive to have spawned throughout the entire game project. A little trick that we use as game developers is spawning enemies right before a player enters an area; this way, they don't need to be created until they're ready to be seen! We can to this through the use of a property called a <a id="id346" class="indexterm"></a>
<span class="strong"><strong>trigger</strong></span>.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Let's first open the level that we created in <a class="link" href="#" linkend="ch03">Chapter 3</a>, <span class="emphasis"><em>Prototyping Levels with Prototype</em></span> that we used earlier in this chapter. We will need to add in navigation data to make things easier to work with. Create an empty game object by navigating to <span class="strong"><strong>GameObject</strong></span> | <span class="strong"><strong>Create Empty</strong></span> and set <span class="strong"><strong>Position</strong></span> as <code class="literal">0,0,0</code>. Then, call the game <code class="literal">Environment</code>.</p></li><li><p>Once we <a id="id347" class="indexterm"></a>have <a id="id348" class="indexterm"></a>the object created, drag and drop all our cubes and rooms into it as children. After this, click on the <span class="strong"><strong>Static</strong></span> button to ensure that the objects don't move by selecting <span class="strong"><strong>Yes, change children</strong></span>. This is an optional step as RAIN can still make a NavMesh without this, but it's a way for us to show that we will not, make these objects move. If you are using Shooter AI, however, you must perform this step.</p><p>For RAIN, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Now, in order for the RAIN characters to recognize where to travel, we need to use RAIN's own Navigation Meshes. To do this, we will need to go to the toolbar at the top of the window and navigate to <span class="strong"><strong>RAIN</strong></span> | <span class="strong"><strong>Create New</strong></span> | <span class="strong"><strong>Navigation Mesh</strong></span>. This will create a white box within which we will want to have our entire area fit in by scaling the object.</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_47.jpg" /></div></li><li><p>Once you've finished resizing, click on the <span class="strong"><strong>Generate Navigation Mesh</strong></span> button and wait for it to finish its calculations.</p></li><li><p>After this, switch to the navigation tab and under the <span class="strong"><strong>Bake</strong></span> section, click <a id="id349" class="indexterm"></a>on the <span class="strong"><strong>Bake</strong></span> button. You'll see it complete, but the steps <a id="id350" class="indexterm"></a>will not show up correctly.</p></li><li><p>Set <span class="strong"><strong>Step Height</strong></span> to <code class="literal">.9</code> and run it again.</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_48.jpg" /></div></li><li><p>Now, jump to step 3.</p></li></ol></div><p>For Shooter AI, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Switch to the navigation tab and under the <span class="strong"><strong>Bake</strong></span> section, click on the <span class="strong"><strong>Bake</strong></span> button. You'll see it complete, but the steps will not show up correctly.</p></li><li><p>Set <span class="strong"><strong>Step Height</strong></span> to <code class="literal">.9</code> and run it again.</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_20.jpg" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note60"></a>Note</h3><p>Another way to use navigation is through a system called <span class="strong"><strong>A*</strong></span>, which finds paths at runtime and is included in Shooter AI. For more information on how to set it up, check out <a class="ulink" href="https://www.youtube.com/watch?v=4p3ZehTNL6s" target="_blank">https://www.youtube.com/watch?v=4p3ZehTNL6s</a>.</p></div></li><li><p>Now, jump to the next step.</p></li></ol></div></li><li><p>Now<a id="id351" class="indexterm"></a> that <a id="id352" class="indexterm"></a>we have our navigation mesh (NavMesh for short) completed, it's time to spawn our enemies. My plan is that when we exit the first door, an enemy will be spawned in the other room and run out to see the player.</p></li><li><p>Open up Prototype again, which we learned before in <a class="link" href="#" linkend="ch03">Chapter 3</a>, <span class="emphasis"><em>Prototyping Levels with Prototype</em></span>, and create a cube (<span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>K</em></span>) that covers the door to the first room.</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_21.jpg" /></div></li><li><p>Once you <a id="id353" class="indexterm"></a>have the room<a id="id354" class="indexterm"></a> created, from the Prototype window, switch to Object mode if you haven't already, and then click on the <span class="strong"><strong>Set Trigger</strong></span> button. You'll see that it has changed color to a yellow semi-transparent box, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_22.jpg" /></div></li><li><p>You'll also <a id="id355" class="indexterm"></a>notice that on <a id="id356" class="indexterm"></a>the <span class="strong"><strong>Mesh Collider</strong></span> component, the <span class="strong"><strong>Is Trigger</strong></span> property has also been toggled. This means that Unity will let us know when a collision has occurred, but it will not stop the player from moving.</p><p>Now we need to create a new component for the trigger to spawn our enemy. In order to do this, we will need to dive into some code.</p></li><li><p>Go to the <code class="literal">MyGame/Scripts</code> folder, navigate to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>New C# Script</strong></span>, and call it <code class="literal">SpawnEnemyOnTrigger</code>. Once finished, double-click on the created file to open up MonoDevelop, the built-in development environment for Unity.</p></li><li><p>Once inside, change the code to this:</p><p>If you are using RAIN:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class SpawnEnemyOnTrigger : MonoBehaviour {
  
  // Enemy to spawn
  public GameObject enemy;
  
  // Where to be spawned at
  public Transform spawnPoint;
  
  // Has this happened already?
  private bool hasTriggered = false;
  
  void OnTriggerEnter(Collider other) 
  {
    //If the player touches the trigger, and if 
      //it hasn't been triggered before
    if(other.tag == "Player" &amp;&amp; hasTriggered == false)
    {
      // Spawn a new enemy using the properties from the 
        // spawnPoint object
      GameObject newEnemy = Instantiate(enemy, 
                               spawnPoint.position, 
                               spawnPoint.rotation) 
                               as GameObject;
      
      // We only want this to happen once.
      hasTriggered = true;
    }
  }
}</pre></div><p>If you <a id="id357" class="indexterm"></a>are using <a id="id358" class="indexterm"></a>Shooter AI, add the following code to have the AI go to the player:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class SpawnEnemyOnTrigger : MonoBehaviour {

  // Enemy to spawn
  public GameObject enemy;

  // Where to be spawned at
  public Transform spawnPoint;

  // Has this happened already?
  private bool hasTriggered = false;

  void OnTriggerEnter(Collider other) 
  {
    //If the player touches the trigger, and 
      //if it hasn't been triggered before
    if(other.tag == "Player" &amp;&amp; hasTriggered == false)
    {
      // Spawn a new enemy using the properties from the 
         // spawnPoint object
      GameObject newEnemy = Instantiate(enemy, 
                           spawnPoint.position, 
                            spawnPoint.rotation) 
                            as GameObject;

      //Tell enemy to go to the player
      newEnemy.GetComponent&lt;NavMeshAgent&gt;().SetDestination(other.transform.position);

      // We only want this to happen once.
      hasTriggered = true;
    }
  }
}</pre></div><p>This <a id="id359" class="indexterm"></a>code does a <a id="id360" class="indexterm"></a>number of things for us. It uses three variables and a single function. Variables are holders for data, and functions are ways for us to act upon this data. The two public properties we have here are for the object that we wish to spawn (the enemy) and where we want to spawn it (in the room). We also have a private property, which is only available to the class. Since we only want to trigger this once, we need to know whether we've executed this before or not.</p><p>The <code class="literal">OnTriggerEnter</code> function is a built-in method in Unity that is called for us whenever an object of any kind has touched the trigger or when the object has a collider and the <span class="strong"><strong>Is Trigger</strong></span> option is toggled. We first check if it's the player and if it is, we then spawn an enemy. We can later extend this to make it fit a more interesting encounter, but this is a good starting point.</p></li><li><p>Next, we need to attach this component to our trigger. Select it and then drag and drop the appropriate <code class="literal">SpawnEnemyonTrigger</code> file on top of it. If you are using RAIN, follow along; if you are using Shooter AI, skip ahead to just after step 16.</p></li><li><p>Once the <a id="id361" class="indexterm"></a>component is <a id="id362" class="indexterm"></a>attached, drag and drop our <code class="literal">RAIN_Enemy</code> prefab under the Enemy property and the <code class="literal">SimpleAITurret</code> object as the spawn point. This way, we will use the turret's position and rotation when we spawn our enemy, but we could also create an empty object and use this as well.</p><p>Now, if we were to run the game now and run up to the enemy, he would indeed start chasing us… but there's a bit of a problem:</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_49.jpg" /></div><p>By default, the <a id="id363" class="indexterm"></a>
<span class="strong"><strong>motor</strong></span> that the object is using is called a <code class="literal">BasicMotor</code>, which is great and efficient but doesn't make use of gravity. Thankfully, there is another motor class included called a <code class="literal">CharacterControllerMotor</code> that we can add, which will work well for us.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note61"></a>Note</h3><p>For more information on the different kinds of motors as well as how to make your own, check out <a class="ulink" href="http://rivaltheory.com/wiki/rainelements/charactercontrollermotor" target="_blank">http://rivaltheory.com/wiki/rainelements/charactercontrollermotor</a>.</p></div></li><li><p>First, in <a id="id364" class="indexterm"></a>order to make it easier to <a id="id365" class="indexterm"></a>modify the prefab, let's bring one into the scene. So with this in mind, from the <span class="strong"><strong>Project </strong></span>tab go to the <code class="literal">MyGame/Prefabs</code> folder, and then drag and drop a <code class="literal">RAIN_Enemy</code> prefab into the scene.</p></li><li><p>From the <span class="strong"><strong>Hierarchy</strong></span> tab, extend the newly created object's children and select the AI object. From here, click on the feet icon to open the <span class="strong"><strong>Motion</strong></span> tab. Then, change the<span class="strong"><strong> Motor</strong></span> property to <code class="literal">CharacterControllerMotor </code>from the dropdown that has popped up.</p></li><li><p>This will require our <code class="literal">RAIN_Enemy </code>object to have a <span class="strong"><strong>CharacterController</strong></span> component, so let's add one real quick. Select the parent object from the <span class="strong"><strong>Hierarchy</strong></span> tab, and then from the top bar, navigate to <span class="strong"><strong>Component</strong></span> | <span class="strong"><strong>Physics</strong></span> | <span class="strong"><strong>CharacterController</strong></span>.</p><p>You'll notice that there is now a new capsule that's been added. This is what RAIN will use to base its movement on.</p></li><li><p>From the <span class="strong"><strong>Inspector</strong></span> tab, scroll down to the <span class="strong"><strong>Character Controller</strong></span> component and change the <span class="strong"><strong>Center Y</strong></span> property to <code class="literal">1</code>, <span class="strong"><strong>Radius</strong></span> to <code class="literal">.9</code> (slightly smaller than the collider we created to receive hit events), and leave <span class="strong"><strong>Height</strong></span> at <code class="literal">2</code>.</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_50.jpg" /></div></li><li><p>After <a id="id366" class="indexterm"></a>making all these changes, let's update our original prefab by scrolling up to the top of the <span class="strong"><strong>Inspector</strong></span> tab, and <a id="id367" class="indexterm"></a>then from the top <span class="strong"><strong>Prefab</strong></span> section, click on the <span class="strong"><strong>Apply</strong></span> button. This is so that our prefab object now has all the changes we made to the previous version.</p></li><li><p>After this, you can delete the object from our <span class="strong"><strong>Hierarchy</strong></span> as we won't need it anymore.</p><p>At this point our enemy will now go up and down stairs correctly and move towards us. However, if we happen to go back to our first room to hide from the enemy...</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_51.jpg" /></div><p>Our bullets aren't going through the trigger. This is because when we shoot in UFPS it draws an invisible line and sees if anything hits it. Right now, the trigger we created counts as something so it uses that as what it hits. (by default, things will be hit by bullets even if their colliders are triggers). Thankfully, this is a pretty simple fix.</p></li><li><p>Select our <a id="id368" class="indexterm"></a>trigger object, and from the <span class="strong"><strong>Inspector</strong></span> tab, select <span class="strong"><strong>Layer</strong></span> and <span class="strong"><strong>IgnoreBullets</strong></span>.
</p><p>The enemy can't follow us and our bullets aren't going through the trigger. This is because the bullet is drawing a line and seeing that there is something there due to the layer that it has (by default, things will be hit by bullets even if their colliders are triggers). Thankfully, this is a pretty simple fix.</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_23.jpg" /></div></li></ol></div><p>If you're <a id="id369" class="indexterm"></a>using Shooter AI, you <a id="id370" class="indexterm"></a>should now do the following:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select our trigger object and from the <span class="strong"><strong>Inspector</strong></span> tab, select <span class="strong"><strong>Layer</strong></span> and <span class="strong"><strong>Trigger</strong></span>.</p></li><li><p>Now, save your scene and run again!</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_24.jpg" /></div></li></ol></div><p>With all this <a id="id371" class="indexterm"></a>place, we now have our trigger working perfectly, and we can shoot through it as well! Now, go ahead and skip the rest of this <a id="id372" class="indexterm"></a>section and continue on to the <span class="emphasis"><em>Clean Up Date AI</em></span> section.</p><p>We may also want to have the AI move rather than just stay in place for the beginning of the combat. Our current behavior tree states that if we don't have an enemy nearby, we can search for a Waypoint Route component from an object called <code class="literal">SimpleWayPointRig</code> (which you can check out for yourself in the Behaviour Editor from the <code class="literal">waypointpatrol</code> decision). If you're using RAIN, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>From the toolbar at the top of the window, navigate to <span class="strong"><strong>RAIN</strong></span> | <span class="strong"><strong>Create New</strong></span> | <span class="strong"><strong>Waypoint Route</strong></span>. From <span class="strong"><strong>Inspector</strong></span>, rename this object to <code class="literal">SimpleWayPointRig</code>. Next, click on the <span class="strong"><strong>Add </strong></span>button to add a waypoint and you'll see a single circle there, which will be the first place that the enemy will go to.</p></li><li><p>After creating this first key, press <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>W</em></span> to create a new key, which will show up nearby and you can move this via translation tools. You can create as many parts of this key as you like to create a patrol route for the AI to take.</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_53.jpg" /></div><p>Currently, when <a id="id373" class="indexterm"></a>you <a id="id374" class="indexterm"></a>finish the route, you will go back to the previous waypoints, so there is no need to try to make them all match.</p></li><li><p>Now, save your scene and run it again!</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_52.jpg" /></div></li></ol></div><p>As you can see, our <a id="id375" class="indexterm"></a>enemy will now spawn and <a id="id376" class="indexterm"></a>follow the route we've created, and if we have him get to the trigger, bullets will fire as well!</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_54.jpg" /></div><p>Now, our <a id="id377" class="indexterm"></a>enemy's <a id="id378" class="indexterm"></a>functioning as we want it to!</p></div>