<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec42"></a>Integrating an AI system – RAIN</h2></div></div><hr /></div><p>
<span class="strong"><strong>Artificial intelligence</strong></span> (<span class="strong"><strong>AI</strong></span>) is <a id="id269" class="indexterm"></a>one of the<a id="id270" class="indexterm"></a> things that can make or break a game. In this section, you will <a id="id271" class="indexterm"></a>learn how to integrate an AI package for Unity in order to have characters roam around and attack players.</p><p>At the time of writing this, people generally tend to either use RAIN by Rival Theory (<a class="ulink" href="http://rivaltheory.com/rain/download/" target="_blank">http://rivaltheory.com/rain/download/</a>) or Shooter AI by Gateway Games (<a class="ulink" href="https://www.assetstore.unity3d.com/#/content/11292" target="_blank">https://www.assetstore.unity3d.com/#/content/11292</a>) if they are not writing their own package when dealing with AI using UFPS.</p><p>In this book, we <a id="id272" class="indexterm"></a>will discuss both tools using RAIN to create a melee attacking enemy and Shooter AI to create a basic ranged shooting enemy. This is so that you have a better idea of how each works, and you can then weigh their pros and cons for your own title.</p><p>Note that I will mention the differences in using both tools in this chapter, but in later chapters, you will be able to choose which of the following you'd like to use for your own levels and encounters.</p><p>To start off, we<a id="id273" class="indexterm"></a> will use<a id="id274" class="indexterm"></a> RAIN in this particular example as it is a free solution that has been out for a while and is pretty mature since it is the most widely used AI engine in digital entertainment. It also has its own active community that can help you should you wish to take this example further.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Before starting, create a copy of your current project to save the progress you've made so far. While there shouldn't be any problems when using this project, it's always better to be safe than sorry.</p></li><li><p>To download it, we'll need to visit Rival Theory's website to download RAIN. So, keeping this in mind, open up your web browser and go to <a class="ulink" href="http://rivaltheory.com/rain/download/" target="_blank">http://rivaltheory.com/rain/download/</a>:</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_28.jpg" /></div></li><li><p>From there, click on the <span class="strong"><strong>RAIN – UNITY 5 </strong></span>button to download the latest version of RAIN.</p></li><li><p>After this, we <a id="id275" class="indexterm"></a>will want to download a <a id="id276" class="indexterm"></a>sample project, which will contain an animated character with sample behavior, that we can plug into the game. CodersExpo has created such a sample project that can be found in Rival Theory's forum under the Sample Projects section at <a class="ulink" href="http://rivaltheory.com/forums/topic/using-waypoint-routes-and-paths/" target="_blank">http://rivaltheory.com/forums/topic/using-waypoint-routes-and-paths/</a>.</p></li><li><p>From there, click on the <code class="literal">PatrolDetectAttackSearchExamples.unitypackage</code> file for us to use at <a class="ulink" href="http://rivaltheory.com/?ddownload=10240" target="_blank">http://rivaltheory.com/?ddownload=10240</a>.</p></li><li><p>Once the <code class="literal">PatrolDetectAttackSearchExamples.unitypackage</code> and <code class="literal">RAIN_U5_2.1.11.0.unitypackage</code> files finish downloading, it's time to import them into our Unity project. Start with the Sample Project, click on the <span class="strong"><strong>Import</strong></span> button, and wait for the project to finish importing:</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_29.jpg" /></div></li><li><p>While importing, it <a id="id277" class="indexterm"></a>may ask you to update your scripts. Since we already made a backup in step 1, click on the <span class="strong"><strong>I Made a Backup. Go Ahead!</strong></span> button.</p></li><li><p>You may need <a id="id278" class="indexterm"></a>to wait for the <span class="strong"><strong>Updating RAIN Components</strong></span> menu. Afterwards, it will ask you if you'd like to automatically search for any updates. In our case, we want to do it manually, so for now, click on <span class="strong"><strong>Don't Allow</strong></span> and then <span class="strong"><strong>Ok </strong></span>in the following dialog box.</p></li><li><p>Next, let's update RAIN to the latest version ourselves by double clicking to open the RAIN unitypackage file and unchecking the files in the <code class="literal">RAIN/Editor/ScriptTemplates</code> folder as it will attempt to create duplicates of the files that are already causing errors.</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_30.jpg" /></div></li><li><p>Once<a id="id279" class="indexterm"></a> imported, you<a id="id280" class="indexterm"></a> may see the Console window open up with an error in the <code class="literal">Assets/Actions/AIRandomWander.cs</code> file. If so, open it in MonoDevelop (you can double-click on the warning/error that's to be taken to the line) and change line 36 with the following code (I've made the changes in bold):</p><div class="informalexample"><pre class="programlisting">found = NavigationManager.<span class="strong"><strong>Instance.</strong></span>GraphsForPoints(ai.Kinematic.Position, loc, <span class="strong"><strong>ai.Motor.MaxHeightOffset</strong></span>, NavigationManager.GraphType.Navmesh, ((BasicNavigator)ai.Navigator).GraphTags);</pre></div><p>To help clarify where in the file to look, take a look at the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_31.jpg" /></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip06"></a>Tip</h3><p>
<span class="strong"><strong>Downloading the example code</strong></span>
</p><p>You can download the example code files from your account at <a class="ulink" href="http://www.packtpub.com" target="_blank">http://www.packtpub.com</a> for all the Packt Publishing books you have purchased. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.packtpub.com/support" target="_blank">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p></div></li><li><p>Save the file, and then once all of the errors have gone away, open the <code class="literal">PatrolAttackSearch.unity</code> file from the <code class="literal">Assets</code> folder in the <span class="strong"><strong>Project</strong></span> tab. To verify whether <a id="id281" class="indexterm"></a>everything is working <a id="id282" class="indexterm"></a>properly, if you play the game, you should see a character called Max walking along a path defined in the scene.</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_32.jpg" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note49"></a>Note</h3><p>To see an explanation of what this sample project consists of, how it was built, and what each of these things mean, in more detail, check out CodersExpo's own video on starting projects with RAIN at <a class="ulink" href="https://www.youtube.com/watch?v=sQlewYFwCOU" target="_blank">https://www.youtube.com/watch?v=sQlewYFwCOU</a>. You can also check out this Quick Start guide by RAIN's creator, Rival Theory, at <a class="ulink" href="https://www.youtube.com/watch?v=YuaBBCL5PSs" target="_blank">https://www.youtube.com/watch?v=YuaBBCL5PSs</a>.</p></div></li></ol></div><p>You may also notice that if you move the white enemies closer to Max, he will run up and attempt to punch them:</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_33.jpg" /></div><p>Now, RAIN and UFPS <a id="id283" class="indexterm"></a>are two separate systems that work <a id="id284" class="indexterm"></a>well in their respective fields, but we can make them work together if we can give RAIN a way to receive damage from UFPS as well as make RAIN damage a UFPS player. Keeping this in mind, we will need to create two scripts in order to carry out these actions:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>To start off with, we need some way to communicate our health to RAIN. To do so, go to the <span class="strong"><strong>Hierarchy</strong></span> tab, extend the <code class="literal">MAX</code> object, and select its child, which is named <code class="literal">AI</code>. From there, you should see the <span class="strong"><strong>AI Rig</strong></span> component in the <span class="strong"><strong>Inspector </strong></span>tab. Next, click on the lightbulb button to open the <span class="strong"><strong>Memory </strong></span>tab.</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_34.jpg" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note50"></a>Note</h3><p>Information on the AI Rig component and what each tab does can be found at <a class="ulink" href="http://rivaltheory.com/wiki/rainelements/airig" target="_blank">http://rivaltheory.com/wiki/rainelements/airig</a>.</p></div></li><li><p>The <span class="strong"><strong>Memory</strong></span> tab is <a id="id285" class="indexterm"></a>used to store and share <a id="id286" class="indexterm"></a>values within different AI elements that exist. We want the AI elements to be able to die at some point, so we will need to add in the ability to check when our health is 0. To do this, from the <span class="strong"><strong>Add Variable</strong></span> dropdown, select <span class="strong"><strong>float</strong></span> and see the new item that's to be added. With regard to this new item, change its <span class="strong"><strong>Name</strong></span> to <code class="literal">currentHealth </code>and the <span class="strong"><strong>Value</strong></span> to <code class="literal">2</code>.</p><p>A regular pistol bullet that can be found in the <code class="literal">UFPS/Base/Content/Prefabs/Projectiles</code> folder, currently has a <span class="strong"><strong>Damage</strong></span> value of <code class="literal">1</code> from its <span class="strong"><strong>Vp_Hitscan Bullet</strong></span> component. Therefore, it will require the player to shoot our enemy twice in order to defeat it.</p></li><li><p>Create a new C# Script called <code class="literal">RAIN_DamageReciever</code>. Open it in MonoDevelop and fill it with the following code:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using RAIN.Core;       // AIRig
using RAIN.Memory;     // RAINMemory

/// &lt;summary&gt;
/// Allows RAIN to receive damage messages from UFPS
/// &lt;/summary&gt;
public class RAIN_DamageReciever : MonoBehaviour 
{
  private AIRig aiRig;
  private RAINMemory memory;
  
  void Start() 
  {
    // Access the AI Rig component which allows us to use
    // any of the properties in them
    aiRig = GetComponent&lt;AIRig&gt;();

    if (aiRig != null) 
    {
      memory = aiRig.AI.WorkingMemory;
    }
  }

  void Damage(float damage) 
  {
    if (memory != null) 
    {
      // Get our current health from RAIN
      float currentHealth = 
                 memory.GetItem&lt;float&gt;("currentHealth");

      // Subtract damage from the current health value
      currentHealth -= damage;

      // Update RAIN where our health is at
      memory.SetItem&lt;float&gt;("currentHealth", currentHealth);
    }
  }
  
  // Secondary support for this function when using
  // projectiles
  private void Damage(vp_DamageInfo projectileInfo)
  {
    Damage(projectileInfo.Damage);
  }
}</pre></div><p>This script allows us to receive the damage events sent by UFPS. Once UFPS finds a bullet that collides with another object (which means it needs to have a collider of some sort), it will attempt to call a function called Damage using either a float or the <code class="literal">vp_DamageInfo</code> input. We then take this information and modify the <code class="literal">currentHealth</code> variable we created earlier in the Memory tab. Later on, we will see the enemy die as a result of falling down.</p></li><li><p>Attach the <a id="id287" class="indexterm"></a>newly <a id="id288" class="indexterm"></a>created component to the AI child of the MAX object.</p></li><li><p>Next, create a new file called <code class="literal">RAIN_DamageSender</code> and use the following code:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;

public class RAIN_DamageSender : MonoBehaviour 
{
  /// &lt;summary&gt;
  /// When called will send a message to the target as 
  /// well as its 
  /// parent objects to call the Damage function if it 
  /// exists.
  /// Note: UFPS uses a function called Damage to damage 
  /// the player
  /// &lt;/summary&gt;
  /// &lt;param name="target"&gt;The target to inflict 
  /// damage.&lt;/param&gt;
  /// &lt;param name="damage"&gt;The amount of damage to do to 
  /// the player.&lt;/param&gt;
  public static void SendDamage(Transform target, float damage)
  {
    target.SendMessageUpwards("Damage", damage, 
                   SendMessageOptions.DontRequireReceiver);
  }
}</pre></div><p>Since we've made this function static, it allows us to use the function without having to create an instance of the class, and we can simply refer to it as <code class="literal">RAIN_DamageSender.SendDamage</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note51"></a>Note</h3><p>For more information on the static modifier, check out: <a class="ulink" href="https://msdn.microsoft.com/en-us/library/98f28cdx.aspx" target="_blank">https://msdn.microsoft.com/en-us/library/98f28cdx.aspx</a>.</p></div></li><li><p>We then need to write new behavior for actually having this AI damage the player. To do this, we <a id="id289" class="indexterm"></a>will create a new script <a id="id290" class="indexterm"></a>called <code class="literal">ForwardAttackBehaviour</code>, which will look like this:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class ForwardAttackBehaviour : MonoBehaviour {
  /// &lt;summary&gt;
  /// Where the Raycast will start drawing from.
  /// &lt;/summary&gt;
  public Transform origin = null;
  
  /// &lt;summary&gt;
  /// How far from the origin will we look for an object to 
  /// hit.
  /// &lt;/summary&gt;
  public float distance = 2.2f;
  
  
  public void AttemptAttack(float damage)
  {
    RaycastHit hit;
    Vector3 direction = Quaternion.Euler(0, 90, 0) * origin.forward;
    
    if(Physics.Raycast(origin.position, direction, out hit, 
                       distance))
    {
      RAIN_DamageSender.SendDamage(hit.transform, damage);
    }
  }

  private void OnDrawGizmos() 
  {
    if(origin != null)
    {
      Vector3 direction = Quaternion.Euler(0, 90, 0) *  
                          origin.forward;
      Debug.DrawLine(origin.position, 
              origin.position + (direction * distance), 
                       Color.red);
    }
  }
}</pre></div></li><li><p>Add the <span class="strong"><strong>ForwardAttackBehaviour</strong></span> component to the <code class="literal">MAX </code>object, and then from the <span class="strong"><strong>Inspector</strong></span> tab, go<a id="id291" class="indexterm"></a> to the component and <a id="id292" class="indexterm"></a>assign <span class="strong"><strong>Origin </strong></span>to the child of Max called <code class="literal">Bip 001 R Hand</code> (use the <span class="strong"><strong>Hierarchy</strong></span> tab's search bar to find the object easily).</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_35.jpg" /></div></li></ol></div><p>Note the red line being drawn. This is due to the <code class="literal">OnDrawGizmos</code> function that we added previously, which draws a line in the editor for us to see exactly where we will be checking when <code class="literal">AttemptAttack</code> is called.</p><p>Next, we need to customize our punch animation so that it calls the <code class="literal">SendDamage</code> function for us when the AI attacks. When the <code class="literal">.fbx</code> file is imported with animations, it is in a <span class="strong"><strong>ReadOnly</strong></span> mode, so we will need to duplicate it in order to make any modifications to the original version of the animation by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>To do this, go to the <code class="literal">Assets/max</code> folder and select the punch animation. Once selected, hit <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>D </em></span>in order to duplicate <code class="literal">AnimationClip</code>. Rename the newly created animation as <code class="literal">punchDamage</code>.</p></li><li><p>Then, we need to tell the character to use this punching animation instead. To do this, go the <span class="strong"><strong>Hierarchy</strong></span> tab, select the <span class="strong"><strong>MAX </strong></span>object, and from the <span class="strong"><strong>Animation</strong></span> component, expand the <span class="strong"><strong>Animations</strong></span> property. From there, replace <span class="strong"><strong>Element 5</strong></span> from <code class="literal">punch</code> to our <code class="literal">punchDamage</code> by dragging and dropping the new element into it.</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_36.jpg" /></div></li><li><p>We also <a id="id293" class="indexterm"></a>need to update <code class="literal">AI</code> so that it plays the correct <a id="id294" class="indexterm"></a>animation. Select the<code class="literal"> AI</code> object, and then from the <span class="strong"><strong>AI Rig</strong></span> component, select the <span class="strong"><strong>Animation</strong></span> tab, which looks like a running person. From there, scroll down until you get to the punch state, and then change <span class="strong"><strong>Animation Clip</strong></span> to <code class="literal">punchDamage</code>.</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_37.jpg" /></div></li><li><p>Next, we <a id="id295" class="indexterm"></a>need to actually modify our animation, which <a id="id296" class="indexterm"></a>we can take a look at by selecting the <span class="strong"><strong>MAX</strong></span> object and then navigating to <span class="strong"><strong>Window</strong></span> | <span class="strong"><strong>Animation</strong></span>.</p></li><li><p>After this, go to the drop-down menu below the record button and select the <code class="literal">punchDamage</code> option:</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_38.jpg" /></div><p>Once this is done, you'll see a number of little diamonds that are keys and ways in which an animator can set where each part of this character will be at a certain time.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note52"></a>Note</h3><p>If you have not used the <span class="strong"><strong>Animation</strong></span> tab before, or you want to know more about this, check out <a class="ulink" href="http://docs.unity3d.com/Manual/animeditor-UsingAnimationEditor.html" target="_blank">http://docs.unity3d.com/Manual/animeditor-UsingAnimationEditor.html</a>.</p></div></li><li><p>We <a id="id297" class="indexterm"></a>want<a id="id298" class="indexterm"></a> to attempt an attack when the enemy's fist is all the way extended, which is at frame 19, so from the little box that currently says <code class="literal">0</code>, type <code class="literal">19</code> and hit <span class="emphasis"><em>Enter</em></span>.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip07"></a>Tip</h3><p>Alternatively, you can also use the <span class="strong"><strong>playback head</strong></span> (the red line) to view the animation and find where you'd like to place your keyframe.</p></div></li><li><p>From here to the right-hand side of the little box showing the frame we are at, you'll see two buttons to the right-hand side of the first one with a diamond (<span class="strong"><strong>Add Key</strong></span>). Then, you'll see the second one, which looks like a vertical rectangle with a pointed end. This one is called <span class="strong"><strong>Add Event</strong></span>; click on it.</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_39.jpg" /></div></li><li><p>In the menu that pops up from the <span class="strong"><strong>Function:</strong></span> menu, select the <code class="literal">AttemptAttack</code> function, and then for the <span class="strong"><strong>Float</strong></span> value, put in the amount of damage <a id="id299" class="indexterm"></a>you <a id="id300" class="indexterm"></a>want to do to the player if he punches you. In my own case, I'll use <code class="literal">1</code>.</p><p>Currently, in the <code class="literal">AdvancedPlayer</code> prefab, the <span class="strong"><strong>Vp_FP Player Damage Handler</strong></span> component lists our player's <span class="strong"><strong>Max Health</strong></span> as <code class="literal">10</code>, so if we decrease the value by 1, it'll be 10% of their health:</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_40.jpg" /></div></li><li><p>Next, let's bring in a player and create a scenario where our RAIN character recognizes this player. Drag and drop an <code class="literal">AdvancedPlayer</code> prefab from the <code class="literal">Assets/UFPS/Base/Content/Prefabs/Players</code> folder into the game world. After adding our player, we won't need to have <code class="literal">Main Camera</code> in the scene anymore. So, select it in the <span class="strong"><strong>Hierarchy</strong></span> tab and then delete it by hitting the <span class="emphasis"><em>Delete</em></span> key.</p><p>If you were to play the game, you'd notice that Max doesn't notice us because we aren't registered as an enemy to him.</p></li><li><p>From the <span class="strong"><strong>Hierarchy</strong></span> tab, select the <code class="literal">Enemy</code> object and expand it to show its child named <code class="literal">Entity</code>. Select this object and note that it has an <span class="strong"><strong>EntityRig </strong></span>component.</p><p>RAIN provides the <span class="strong"><strong>Entity</strong></span> component<a id="id301" class="indexterm"></a> as a way to encapsulate the attributes, properties, or characteristics of the game object it is associated with, which the AI can then reference later on in its behavior. This can be done by defining custom elements and/or aspects. In this instance, we have said that this object has an aspect called <code class="literal">aEnemy</code>.</p><p>If we open <span class="strong"><strong>Behavior Editor</strong></span> for the <code class="literal">MAX</code> object by navigating to <span class="strong"><strong>RAIN</strong></span> | <span class="strong"><strong>Behavior Tree Editor</strong></span>, you'll notice that the <code class="literal">CanSee </code>sensor is looking for an aspect of <code class="literal">aEnemy</code>. If it finds it, it will assign the <code class="literal">varEnemy</code> variable to <a id="id302" class="indexterm"></a>this object, and when <code class="literal">varEnemy </code>has a value, the AI will follow this enemy to the best of its ability.</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_41.jpg" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note53"></a>Note</h3><p>For more information on <a id="id303" class="indexterm"></a>RAIN's Entity Rig component, check out <a class="ulink" href="http://rivaltheory.com/wiki/gettingstarted/createentity" target="_blank">http://rivaltheory.com/wiki/gettingstarted/createentity</a>.</p></div></li><li><p>Duplicate<a id="id304" class="indexterm"></a> the Entity object (<span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>D</em></span>), and then drag it over to be a child of the <code class="literal">AdvancedPlayer</code> object that we created in the <span class="strong"><strong>Hierarchy</strong></span> tab. Next, change the <span class="strong"><strong>Entity Rig</strong></span> component's <span class="strong"><strong>Form</strong></span> variable to the <code class="literal">AdvancedPlayer</code> object by dragging and dropping the object into the slot.</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_42.jpg" /></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip08"></a>Tip</h3><p>It's also possible for you to create an Entity by selecting the <span class="strong"><strong>Advanced Player</strong></span> object from Hierarchy. Then, from the toolbar at the top of the window, navigate to <span class="strong"><strong>RAIN</strong></span> | <span class="strong"><strong>Create New</strong></span> | <span class="strong"><strong>Entity</strong></span>. After it's created, move over to the Inspector tab and go down to our newly created component. From there, select <span class="strong"><strong>Visual Aspect</strong></span> from the <span class="strong"><strong>Add Aspect</strong></span> dropdown, and then from the newly created aspect, change <span class="strong"><strong>Aspect Name</strong></span> to <code class="literal">aEnemy</code>. Remove the value for <span class="strong"><strong>Mount Point</strong></span> by selecting it and hitting the <span class="emphasis"><em>Delete</em></span> key.</p></div></li><li><p>Save <a id="id305" class="indexterm"></a>our <a id="id306" class="indexterm"></a>project and play the game to verify that everything is working correctly.</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_43.jpg" /></div><p>And as you can see, we can now be attacked by the character and UFPS updates its health correctly! Now, we just need to get the other way around working.</p></li><li><p>The <a id="id307" class="indexterm"></a>first <a id="id308" class="indexterm"></a>thing we need to do is create a collider of some sort for UFPS to recognize that the player has been hit as the current AI has no collision. Select the AI object once again and add a <span class="strong"><strong>Capsule Collider</strong></span> component. Once done, change the <span class="strong"><strong>Y</strong></span> value of <span class="strong"><strong>Center</strong></span> to <code class="literal">1</code>, <span class="strong"><strong>Radius</strong></span> to <code class="literal">.1</code>, and <span class="strong"><strong>Height</strong></span> to <code class="literal">2</code>. This is done so that UFPS can communicate with the <span class="strong"><strong>RAIN_Damage Reciever</strong></span> function.</p><p>If we wanted the character's collision box to be very accurate, we can always add the <code class="literal">Box Collider</code> and <code class="literal">DamageReciever</code> components around each of the parts of the character rig. However, the more you add, the more computationally expensive the calculations will be. The advantage of doing this is that your bullet marks will look much better.</p></li><li><p>After this, we need to have the AI react to taking damage and dying. Select <code class="literal">MAX</code>, go to the toolbar at the top of the window, and navigate to <span class="strong"><strong>RAIN</strong></span> | <span class="strong"><strong>Behavior Tree Editor</strong></span>.</p></li><li><p>Once there, right-click <a id="id309" class="indexterm"></a>on the <code class="literal">StateSelect</code> option <a id="id310" class="indexterm"></a>by navigating to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Decisions</strong></span> | <span class="strong"><strong>Constraint</strong></span>. Then, change <span class="strong"><strong>Name</strong></span> of the newly created constraint to <code class="literal">Death</code>, and under <span class="strong"><strong>Constraint</strong></span>, add <code class="literal">currentHealth &lt;= 0</code>.</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_44.jpg" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note54"></a>Note</h3><p>For more information on the <a id="id311" class="indexterm"></a>Behaviour Tree Editor and to see how you can debug it while the game is on, check out <a class="ulink" href="http://rivaltheory.com/wiki/behaviortrees/behaviortreeeditor" target="_blank">http://rivaltheory.com/wiki/behaviortrees/behaviortreeeditor</a>.</p></div></li><li><p>Next, we need it to play the proper animation, so right-click on the Death constraint, and then navigate to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Actions</strong></span> | <span class="strong"><strong>Animate</strong></span>. In <span class="strong"><strong>Animation State:</strong></span>, put in <code class="literal">death</code>. This is done so that it plays the death animation.</p></li><li><p>After this, we<a id="id312" class="indexterm"></a> don't want the character to <a id="id313" class="indexterm"></a>start moving again as we want it to get destroyed after a while. So, let's create a new yield action first by right-clicking on and navigating to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Actions</strong></span> | <span class="strong"><strong>Yield</strong></span>.</p></li><li><p>Afterwards, create a timer by navigating to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Actions</strong></span> | <span class="strong"><strong>Timer</strong></span> and plug in <code class="literal">5</code> for <span class="strong"><strong>Seconds</strong></span>.</p><p>This is done so that when we die, we can play the animation before removing the character from the scene.</p></li><li><p>Next, we need to add in some custom code to actually destroy our character, so right-click on <code class="literal">Death </code>once again, and this time, navigate to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Actions</strong></span> | <span class="strong"><strong>Custom Action</strong></span>. From the <span class="strong"><strong>Class: </strong></span>property, select <code class="literal">Create New Custom Action</code>. Under <span class="strong"><strong>Custom action name:</strong></span>, add <code class="literal">DestroyBodyAction </code>and make sure that <span class="strong"><strong>Script type:</strong></span> is still at <code class="literal">CSharp</code>.</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_45.jpg" /></div></li><li><p>Once you've <a id="id314" class="indexterm"></a>confirmed the values, click <a id="id315" class="indexterm"></a>on the <span class="strong"><strong>OK</strong></span> button and open up the script MonoDevelop (it's located in your <code class="literal">Assets/AI/Actions</code> folder) and put in the following bold lines:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
//using System.Collections;
//using System.Collections.Generic;
using RAIN.Core;
using RAIN.Action;

[RAINAction]
public class DestroyBodyAction : RAINAction
{
    public DestroyBodyAction()
    {
        actionName = "DestroyBodyAction";
    }

    public override void Start(AI ai)
    {
        base.Start(ai);
    }

    public override ActionResult Execute(AI ai)
    {
      <span class="strong"><strong>MonoBehaviour.Destroy(ai.Body);</strong></span>
        return ActionResult.SUCCESS;
    }

    public override void Stop(AI ai)
    {
        base.Stop(ai);
    }
}</pre></div><p>In addition to this, you can also remove the lines that I've commented out since the script doesn't actually use them.</p></li><li><p>In <a id="id316" class="indexterm"></a>the <a id="id317" class="indexterm"></a>behavior tree, we also need to make sure that we can exit out of the constraints in order to go to <code class="literal">Death</code>. Under <span class="strong"><strong>Can See</strong></span> for <span class="strong"><strong>Constraint</strong></span>, put in: <code class="literal">(varEnemy != null) &amp;&amp; (currentHealth &gt; 0)</code>. For <span class="strong"><strong>Can't See</strong></span>, use <code class="literal">varEnemy == null &amp;&amp; DoSearch == 0 &amp;&amp; currentHealth &gt; 0</code>. Then, under the first constraint, put in <code class="literal">varEnemy==null &amp;&amp; DoSearch==1 &amp;&amp; currentHealth &gt; 0</code>. With this in place, we should be finished with the behavior, so go ahead and exit the menu!</p></li><li><p>Finally, let's rename <code class="literal">MAX </code>to <code class="literal">RAIN_Enemy</code> and drag and drop it to the <code class="literal">MyGame\Prefabs</code> folder so that it can be used later on.</p></li><li><p>In addition to this, select the <span class="strong"><strong>Advanced Player</strong></span> object, and click on the Prefab Apply button so that the other advanced players contains the changes we've made as well.</p></li><li><p>Save your script and now try out the project!</p><div class="mediaobject"><img src="/graphics/9781782174806/graphics/B04317_05_46.jpg" /></div></li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note55"></a>Note</h3><p>For those of you interested in using RAIN, check out another useful tutorial that is specific to RAIN itself at <a class="ulink" href="http://cocoateam.com/post/105258624839/creating-a-fully-functional-enemy-behavior-using" target="_blank">http://cocoateam.com/post/105258624839/creating-a-fully-functional-enemy-behavior-using</a>.</p></div><p>At this <a id="id318" class="indexterm"></a>point, we <a id="id319" class="indexterm"></a>now have an enemy that can both damage us as well as be damaged, and we've also touched on how to remove enemies from a scene after a period of time!</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note56"></a>Note</h3><p>Rival Theory have a premium version of AI characters made in RAIN called Squad Command or the Advanced Warfighter AI, which can be found at Unity Asset Store. This can be useful for those of you who wish to get more complex AI up and running fairly quickly, but it does cost money. At the time of writing this, you'll also still need to add the changes we made in this tutorial to get it to work with UFPS characters. If you're interested in checking the assets out, take a look at <a class="ulink" href="https://www.assetstore.unity3d.com/en/#!/content/23526" target="_blank">https://www.assetstore.unity3d.com/en/#!/content/23526</a>.</p></div></div>