<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec48"></a>Implementing the Ouya payment framework</h2></div></div><hr /></div><p>The Ouya examples provide a really good stub class for your In-App Purchase needs, we'll import that in to our project as a base for the code. The file is located in the folder where you <a id="id260" class="indexterm"></a>installed the Ouya Unity repository to in <a class="link" href="#" linkend="ch02">Chapter 2</a>, <span class="emphasis"><em>Setting Up Unity and the Ouya Plugin</em></span>. From inside that folder navigate to <code class="literal">Assets\Ouya\Examples\Scripts</code> and drag the <code class="literal">OuyaShowProducts</code> file in to the <code class="literal">Scripts</code> folder in our <span class="strong"><strong>Project</strong></span> panel. Double-click on it to edit it in MonoDevelop, and have a look at the method names to become familiar with the method names that we will need to call and respond to. At the moment we're going to use the script as it is. There is some code already in the script that will build a <span class="strong"><strong>Graphical User Interface</strong></span> (<span class="strong"><strong>GUI</strong></span>) and <a id="id261" class="indexterm"></a>display a menu system for seeing your products.</p><p>Back in Unity, open your <span class="strong"><strong>SetUp</strong></span> scene and add a new, empty game object to it. Call it <code class="literal">IAP</code> and drag your <code class="literal">OuyaShowProducts</code> script on to it. We need to make sure that this new, empty game object persists across all scenes as well as <code class="literal">OuyaGameObject</code>, so let's create a script that we can use for both the game objects.</p><p>Create a new C# script and call it <code class="literal">DontDestroyOnLoad</code>. Edit the script as shown in the following code:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class DontDestroyOnLoad : MonoBehaviour {

  // Use this for initialization
  void Awake () {
    
    // Make it so this object persists
    DontDestroyOnLoad(this);
  }
}</pre></div><p>Save the script and drag it on to your <code class="literal">IAP</code> game object and <code class="literal">OuyaGameObject</code>. This will make sure that they persist across all scenes. The final thing we need to do before we can see some results is to let <code class="literal">OuyaGameObject</code> know about the names of the products it will need to request information about initially. To do this, click on <code class="literal">OuyaGameObject</code> in Unity and the <span class="strong"><strong>Inspector</strong></span> panel will show the word <span class="strong"><strong>Purchasables</strong></span> in <span class="strong"><strong>Ouya Game Object (Script)</strong></span>. If this isn't expanded then expand <span class="strong"><strong>Purchasables</strong></span> and you'll see a <span class="strong"><strong>Size</strong></span> property, change it to <code class="literal">1</code>. In the <span class="strong"><strong>Element 0</strong></span> label add <code class="literal">SokobanUnlock</code>.</p><p>If you want to sell multiple products in the future you'll need to increase the size of the <span class="strong"><strong>Purchasables</strong></span> array and add the names to it. With the exception of the <span class="strong"><strong>DEVELOPER_ID</strong></span>, you can see how the <span class="strong"><strong>Inspector</strong></span> panel should appear in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783559701/graphics/9701OS_06_1.jpg" /></div><p>Make sure Ouya is connected to the Internet and run the game on it. You will see that there is now some text and three buttons on the screen. You have to wait until the In-App Purchase<a id="id262" class="indexterm"></a> system is initialized before you call anything on it. You can see the status in the top-left of the screen. When you see the <span class="strong"><strong>IAP is initialized</strong></span> message, you're good to go. Using the mouse-like area of the Ouya controller to bring up a mouse pointer, click on the <span class="strong"><strong>Get Products</strong></span> button and you'll see your <span class="strong"><strong>Sokoban Unlock</strong></span> appear. Click on the <span class="strong"><strong>Purchase</strong></span> button next to it and you'll be presented with the In-App Purchase screen for the Ouya.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note09"></a>Note</h3><p>If your Ouya developer login ID is the same as the account you logged in to your Ouya with, then you won't be charged for your In-App Purchases.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec24"></a>How to manage your purchases</h3></div></div></div><p>While testing <a id="id263" class="indexterm"></a>your code to check if In-App Purchases works, you'll need to buy it over and over again, thankfully Ouya took this<a id="id264" class="indexterm"></a> in to consideration and made it easy to manage any purchases you have made of your own products. After you have bought your In-App Purchase, and providing your Ouya developer login is the same as the account you logged in to your Ouya with, you will be able to see your purchase on the Ouya Developer website: <a class="ulink" href="https://devs.ouya.tv/developers/purchases" target="_blank">https://devs.ouya.tv/developers/purchases</a>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec25"></a>Getting the list of products</h3></div></div></div><p>As we know our In-App Purchases are now set up correctly on the website and we can start to properly<a id="id265" class="indexterm"></a> implement them in our game. Double-click on the <code class="literal">OuyaShowProducts</code> script to open it in MonoDevelop and scroll to <a id="id266" class="indexterm"></a>the bottom of the file. You'll see a method called <code class="literal">OnGUI</code>, when you find it comment out the whole method using <code class="literal">/*</code> and <code class="literal">*/</code>. This is a way of commenting out entire blocks of code without having to use <code class="literal">//</code> on every line.</p><p>Let's create a method that will get our products and store them in an array. At the top of our file, where the variables are defined add the following line of code:</p><div class="informalexample"><pre class="programlisting">bool iAPDone = false;</pre></div><p>We create this Boolean as we're going to have an <code class="literal">if</code> statement that we only want to be called once. The <code class="literal">if</code> statement will need to called in the <code class="literal">Update</code> method. The method should be <a id="id267" class="indexterm"></a>written as following:</p><div class="informalexample"><pre class="programlisting">void Update () {
  
  // Is the IAP engine initialized and have we NOT called
  // this code previously?
  if (OuyaSDK.isIAPInitComplete() &amp;&amp; iAPDone == false) {
    
    // Make it so we don't call this code again
    iAPDone = true;
    
    // Create a List (like an array) to store our products
    List&lt;OuyaSDK.Purchasable&gt; productIdentifierList = new List&lt;OuyaSDK.Purchasable&gt;();
    
    // Loop through all the purchasables specified in the 
    // OuyaGameObject
    foreach (string productId in OuyaGameObject.Singleton.Purchasables)
    {
      // Add the product name to the List
      productIdentifierList.Add(new OuyaSDK.Purchasable(productId));
    }
    
    // Initiate a request to get the reciepts.
    // This will be used to check if we have already bought 
    // any of these items
    OuyaSDK.requestReceiptList();
    
    // Get the information about the products in the List
    OuyaSDK.requestProductList(productIdentifierList);
  }
}</pre></div><p>Comments <a id="id268" class="indexterm"></a>have been left in the code to provide a line by line explanation but the overview is:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Has the In-App Purchase engine initialized and not been called before</p></li><li style="list-style-type: disc"><p>Set a Boolean so this code won't be called again</p></li><li style="list-style-type: disc"><p>Create <code class="literal">List</code> to store any products we need to get information on</p></li><li style="list-style-type: disc"><p>Loop through the <code class="literal">Purchasables</code> array in <code class="literal">OuyaGameObject</code>
</p></li><li style="list-style-type: disc"><p>Add any <code class="literal">Purchasables</code> to <code class="literal">List</code>
</p></li><li style="list-style-type: disc"><p>Get <a id="id269" class="indexterm"></a>the list of receipts to<a id="id270" class="indexterm"></a> see if any of the products have already been bought</p></li><li style="list-style-type: disc"><p>Get information about all the products listed in <code class="literal">productIdentifierList</code>
</p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec26"></a>Limiting your levels</h3></div></div></div><p>If you're just dealing with an entitlement In-App Purchase then it's easier to build the game completely and then add in the In-App Purchase code afterwards. We've added three levels to our game already so that's a good place to start. We're going to limit it so there is only one<a id="id271" class="indexterm"></a> level until you pay to unlock them all. Double-click on your <code class="literal">Sokoban</code> script to open it in MonoDevelop and, at the top of the <a id="id272" class="indexterm"></a>script where the variables are defined, add the following line of code:</p><div class="informalexample"><pre class="programlisting">int trialLevelAmount = 1;</pre></div><p>We now need to modify our <code class="literal">MovePlayer</code> method. Scroll to the bottom of the method and find the <code class="literal">if (haveFinishedLevel())</code> condition. We need to edit it as shown in the following code:</p><div class="informalexample"><pre class="programlisting">if (haveFinishedLevel()) {
  
  currentLevel++;
  
  if ((PlayerPrefs.HasKey("purchased") &amp;&amp; currentLevel &lt; levels.Length) || currentLevel &lt; trialLevelAmount) {
    Invoke("LoadNextLevel", 1.0f);
  } else {
    currentLevel = 0;
    Invoke("LoadTitleScreen", 1.0f);
  }
  
  PlayerPrefs.SetInt("currentLevel", currentLevel);
}</pre></div><p>You can see that the <code class="literal">if</code> statement that we perform now is slightly different. We check if the player has purchased the full unlock and whether the current level is less than the full array of levels, if the game has not been purchased we only check if the current level is less than the trial-level amount. This means that the player will be sent back to the title screen when they have finished all the levels if they have bought the game, or when they finish the first level if they haven't bought it.</p><p>We have called a new method, <code class="literal">LoadTitleScreen</code>, which we also need to create. It's very simple, add the following code:</p><div class="informalexample"><pre class="programlisting">void LoadTitleScreen () {
  Application.LoadLevel("TitleScreen");
}</pre></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec27"></a>Unlocking levels for people who have paid</h3></div></div></div><p>If the player has already paid for the unlockable levels we need to make sure they are always available. We'll achieve this by using two systems; first we'll check if <code class="literal">int</code> has been set in <code class="literal">PlayerPrefs</code>. Secondly, we'll download the receipts and see if this product has been <a id="id273" class="indexterm"></a>purchased previously. We have to do<a id="id274" class="indexterm"></a> both as if the game is deleted from the user's Ouya then the <code class="literal">PlayerPrefs</code> information will be deleted. You'll remember earlier that in <code class="literal">OuyaShowProducts</code> we added the <code class="literal">Update</code> method and, in there, called the <code class="literal">OuyaSDK.requestReceiptList</code> method. When the receipts come down from the server, <code class="literal">OuyaGetReceiptsOnSuccess</code> is called. There was already a stub method in place so let's expand on it:</p><div class="informalexample"><pre class="programlisting">public void OuyaGetReceiptsOnSuccess(List&lt;OuyaSDK.Receipt&gt; receipts)
{
  // Clear the current receipts List
  m_receipts.Clear();
  
  // Loop through all the receipts and verify we have one 
  // with our SokobanUnlock identifier in
  foreach (OuyaSDK.Receipt receipt in receipts)
  {
    if (receipt.getIdentifier() == "SokobanUnlock") {
      
      // If we have previously purchased the 
      // SokobanUnlock then store it in the PlayerPrefs
      PlayerPrefs.SetInt("purchased", 1);
    }
    m_receipts.Add(receipt);
  }
}</pre></div><p>The method will pass a list of receipts, all we need to do is loop through all the receipts and see if any of them have the identifier of <code class="literal">SokobanUnlock</code>. If they do, then we know that the user has purchased the game and we can set <code class="literal">int</code> in <code class="literal">PlayerPrefs</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec28"></a>Buying your product</h3></div></div></div><p>The<a id="id275" class="indexterm"></a> majority of the hard work has already<a id="id276" class="indexterm"></a> been done by this point; we have our trial-level amount code, we have our receipt checking, the only thing left to do is to create a mechanism to actually buy the game. As we now drop the game back to the title screen when we finish the demo or the full game, the title screen is a perfect place to offer the game for sale. It's good <span class="strong"><strong>User Experience</strong></span> (<span class="strong"><strong>UX</strong></span>) to<a id="id277" class="indexterm"></a> not offer the purchase to people who have already bought the game. The tasks are to add a new menu items to the title screen, call the buy <a id="id278" class="indexterm"></a>method if that item is <a id="id279" class="indexterm"></a>selected, and hide the item if the game has already been purchased. Let's start with the first of those.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec03"></a>Adding a new menu item</h4></div></div></div><p>In Unity, double-click on your <span class="strong"><strong>TitleScreen</strong></span> scene to edit it. We're going to add some more text <a id="id280" class="indexterm"></a>just like we did earlier to navigate to <span class="strong"><strong>GameObject</strong></span> | <span class="strong"><strong>Create Other</strong></span> | <span class="strong"><strong>3D Text</strong></span>. Change the name of the new game object to <code class="literal">Purchase Instructions</code>. Click<a id="id281" class="indexterm"></a> and drag the new text in to the Main Camera's game object and then change the following settings:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Set <span class="strong"><strong>Position</strong></span> to <span class="strong"><strong>X</strong></span>: <code class="literal">0</code> <span class="strong"><strong>Y</strong></span>: <code class="literal">-5</code> <span class="strong"><strong>Z</strong></span>: <code class="literal">50</code>
</p></li><li style="list-style-type: disc"><p>Set <span class="strong"><strong>Text</strong></span> to <code class="literal">Press A to Purchase</code>
</p></li><li style="list-style-type: disc"><p>Set <span class="strong"><strong>Anchor</strong></span> to <span class="strong"><strong>middle center</strong></span>
</p></li><li style="list-style-type: disc"><p>Set <span class="strong"><strong>Font Size</strong></span> to <code class="literal">50</code>
</p></li></ul></div><p>You will also have to edit the <code class="literal">Play Instructions</code> game object to get it positioned correctly with the new menu entry:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Set the <span class="strong"><strong>Y</strong></span> of the <code class="literal">Play Instructions</code> game object to <code class="literal">5</code>
</p></li></ul></div><p>Test your game inside Unity and your title screen should look like the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783559701/graphics/9701OS_06_2.jpg" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec04"></a>The buy method</h4></div></div></div><p>We now need to <a id="id282" class="indexterm"></a>create a method that is going to purchase our product <a id="id283" class="indexterm"></a>upon pressing the A button on the Ouya controller, the best place for this is within our <code class="literal">OuyaShowProducts</code> script. Create a new method in the script called <code class="literal">BuyFullGame</code> and add the following code:</p><div class="informalexample"><pre class="programlisting">public void BuyFullGame () {
  if (PlayerPrefs.HasKey("purchased")) {
    // The game has already been brought, don't continue
    return;
  }
  
  foreach (OuyaSDK.Product product in m_products)
  {
    // Is this the product we want to buy?
    if (product.getIdentifier() == "SokobanUnlock") {
      OuyaSDK.requestPurchase(product.getIdentifier());
    }
  }
}</pre></div><p>First we check that we haven't already bought the game, obviously we don't want to be able to purchase it twice. After that we loop through all the objects that we stored in our <code class="literal">m_products</code> list earlier when we called <code class="literal">OuyaSDK.requestProductList</code>. The <code class="literal">m_products</code> list is created for you by the code in the <code class="literal">OuyaShowProducts</code> script. This will then bring up<a id="id284" class="indexterm"></a> the Ouya purchase dialog that you saw earlier and, upon <a id="id285" class="indexterm"></a>clicking on <span class="strong"><strong>PURCHASE</strong></span>, will trigger the <code class="literal">OuyaPurchaseOnSuccess</code> method.</p><p>To hook up the A button, we need to edit our <code class="literal">ControlsTitleScreen</code> script. Double-click on the <code class="literal">ControlsTitleScreen</code> script to edit it in MonoDevelop and go to the <code class="literal">Update</code> method. We're going to add an <code class="literal">else</code> condition to the <code class="literal">if</code> statement:</p><div class="informalexample"><pre class="programlisting">if (Input.GetKeyDown(KeyCode.Space) || OuyaInput.GetButtonDown(OuyaButton.O, player)){
  Application.LoadLevel("GameScreen");
} else if (OuyaInput.GetButtonDown(OuyaButton.A, player)) {
  
  GameObject iap = GameObject.Find("IAP");
  OuyaShowProducts showProductsScript = iap.GetComponent&lt;OuyaShowProducts&gt;();
  showProductsScript.BuyFullGame();
}</pre></div><p>Here we have added a check for the A button, and if that is pressed, we find the <code class="literal">IAP</code> game object. As previously stated, the <code class="literal">Find</code> operation is expensive, but as this won't be called often it's fine to use in this instance. Once we have found it we need to get a reference to the <code class="literal">OuyaShowProducts</code> script that's attached to it, that's what the <code class="literal">GetComponent </code>method achieves. As we made our <code class="literal">BuyFullGame</code> method public, it means we call it from this script.</p><p>Once a purchase has been successful the <code class="literal">OuyaPurchaseOnSuccess</code> method will be called. Modify the method as shown in the following code:</p><div class="informalexample"><pre class="programlisting">public void OuyaPurchaseOnSuccess(OuyaSDK.Product product)
{
  PlayerPrefs.SetInt("purchased", 1);
  
  Application.LoadLevel("TitleScreen");
  
  // Once the purchase is complete get a list of all receipts
  OuyaSDK.requestReceiptList();
}</pre></div><p>You can see that on a successful purchase we now store a value in <code class="literal">PlayerPrefs</code>, reload the <span class="strong"><strong>TitleScreen</strong></span> scene, and request the receipt list. This last step is done for completeness. You'll see why we reload the scene in out next section.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec05"></a>Hiding menu items</h4></div></div></div><p>We've got a functioning method to buy our level now but the message when you load the game still has <a id="id286" class="indexterm"></a>the option to buy it. We need to detect if the app has already been <a id="id287" class="indexterm"></a>purchased and hide the purchase option if it has. The first step for this is to delete your purchases in case you have already purchased the product, this can be done at <a class="ulink" href="https://devs.ouya.tv/developers/purchases" target="_blank">https://devs.ouya.tv/developers/purchases</a>.</p><p>Create a new script in the <code class="literal">Scripts</code> folder and call it <code class="literal">HideIfPurchased</code>. Click and drag the script on to our <code class="literal">Purchase Instructions</code> game object and then double-click on the file to edit it in MonoDevelop. Edit the <code class="literal">Start</code> method as shown in the following code:</p><div class="informalexample"><pre class="programlisting">void Start () {
  if (PlayerPrefs.HasKey("purchased")) {
    this.transform.gameObject.SetActive(false);
  }
}</pre></div><p>We simply check if we have a value for <code class="literal">purchased</code> in our <code class="literal">PlayerPrefs</code>, if we do then we hide the game object. If you recall, we set <code class="literal">purchased</code> to <code class="literal">1</code> and reload the <span class="strong"><strong>TitleScreen</strong></span> scene when <code class="literal">OuyaPurchaseOnSuccess</code> gets called.</p></div></div></div>