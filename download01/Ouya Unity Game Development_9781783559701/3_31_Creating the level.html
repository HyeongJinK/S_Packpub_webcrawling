<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec35"></a>Creating the level</h2></div></div><hr /></div><p>Start by opening the <span class="strong"><strong>GameScreen</strong></span> scene you created earlier by double-clicking on it. There <a id="id149" class="indexterm"></a>should just be a <span class="strong"><strong>Main Camera</strong></span> and nothing else. Make the background <a id="id150" class="indexterm"></a>color of the <span class="strong"><strong>Main Camera</strong></span> black, just like you did earlier, and set the position to <code class="literal">X: 3, Y: 6, Z: -10</code>.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec16"></a>Prefabs</h3></div></div></div><p>A <span class="strong"><strong>prefab</strong></span> is a type of asset, a reusable GameObject that is accessible from the <span class="strong"><strong>Project</strong></span> panel. Prefabs<a id="id151" class="indexterm"></a> can be added into any scene, multiple times per scene. When you <a id="id152" class="indexterm"></a>add a prefab to a scene, an instance is created of it. All prefab instances are linked to the original prefab. No matter how many instances exist in your project, when you make a change to the prefab, you will see the change applied to all instances of it.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl3sec02"></a>Creating a Prefab</h4></div></div></div><p>In order to <a id="id153" class="indexterm"></a>create a prefab, drag a GameObject that you've created in the scene into the <span class="strong"><strong>Project</strong></span> panel, we're using the <code class="literal">Prefabs</code> folder to store ours. The GameObject's name will turn blue to show that it is a prefab.</p><p>We're going to need five prefabs in our game; a wall, a floor, a goal, a crate, and a player. Let's just use cubes for now, we can pretty things up later. Click on <span class="strong"><strong>GameObject</strong></span> | <span class="strong"><strong>CreateOther</strong></span> | <span class="strong"><strong>Cube</strong></span>, and a cube will appear in your <span class="strong"><strong>Hierarchy</strong></span> panel. Click on it to select it, then click on <span class="strong"><strong>Edit</strong></span> | <span class="strong"><strong>Duplicate</strong></span>, you'll need to keep doing that until you have created five cubes in total. Click on each one in turn and rename it. Call them <code class="literal">wall</code>, <code class="literal">floor</code>, <code class="literal">goal</code>, <code class="literal">crate</code>, and <code class="literal">player</code>. Before we make them prefabs, we need to set up the transform of some of them.</p><p>Click on the <code class="literal">goal</code> GameObject and in the <span class="strong"><strong>Information</strong></span> panel, set the scale to <code class="literal">X: 1, Y: 0.1, Z: 1</code>, and then do the same with the <code class="literal">floor</code> GameObject.</p><p>Drag each of the new GameObjects in to the <code class="literal">Prefabs</code> folder we created in the <span class="strong"><strong>Projects</strong></span> panel. They should appear in the folder along with a blue cube icon. The GameObject will remain in the <span class="strong"><strong>Hierarchy</strong></span> panel but the color of its name will have changed from white to blue. Once you have dragged all five GameObjects in the <code class="literal">Prefabs</code> folder, you can delete them from the <span class="strong"><strong>Hierarchy</strong></span> panel.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec17"></a>Materials</h3></div></div></div><p>Our game would be pretty boring with gray cubes for every single model so let's give them<a id="id154" class="indexterm"></a> some color. For the purposes of this book, we're just going to use self-illuminating, diffused materials on the prefabs, but if you are good with a graphics <a id="id155" class="indexterm"></a>package you can easily drag a texture into these materials to add some polish to your game. Right-click on the <code class="literal">Materials</code> folder in your <span class="strong"><strong>Project</strong></span> panel and click on <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Material</strong></span>. Call the new material wall. In the <span class="strong"><strong>Inspector</strong></span> panel, click on the drop-down menu next to <span class="strong"><strong>Shader</strong></span> and select <span class="strong"><strong>Self-Illumin</strong></span> | <span class="strong"><strong>Diffuse</strong></span>. Just below that, you'll see <span class="strong"><strong>Main Color</strong></span> with a white color swatch next to it. Click on the swatch and change the color to red then close the color palette window. With your new material selected, click on <span class="strong"><strong>Edit</strong></span> | <span class="strong"><strong>Duplicate</strong></span>, you'll need to keep doing that until you have created five materials in total. Click on each one of the duplicated materials and rename it. We already have the <span class="strong"><strong>wall</strong></span> material, so call the duplicated ones <code class="literal">floor</code>, <code class="literal">goal</code>, <code class="literal">crate</code>, and <code class="literal">player</code>. Set colors in the same way as before for each one in turn. Make <code class="literal">floor</code> as light gray, <code class="literal">goal</code> as bright green, <code class="literal">crate</code> as brown, and <code class="literal">player</code> as blue.</p><p>Click and drag each material to its respective prefab, this will assign the material to the prefab and make out game more colorful.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec18"></a>Multidimensional arrays</h3></div></div></div><p>An array<a id="id156" class="indexterm"></a> is a reference to a list of objects that you can iterate through numerically. We<a id="id157" class="indexterm"></a> are going to be storing tile IDs in our array. The ID of the tile will tell us if it's a floor, a wall, a crate, a player or a goal. You will see in the following code that a list is supplied that shows what kind of tile each number represents.</p><p>You may have<a id="id158" class="indexterm"></a> heard of <span class="strong"><strong>two-dimensional</strong></span> arrays, these are <a id="id159" class="indexterm"></a>arrays where each object is an array; they are useful for storing map data of a tile based game in as you have columns and rows. We're going to be using a <span class="strong"><strong>three-dimensional</strong></span> array<a id="id160" class="indexterm"></a>. The top-level of the array is going to be <a id="id161" class="indexterm"></a>the number of the level <a id="id162" class="indexterm"></a>we're on, each element inside that top-level array will <a id="id163" class="indexterm"></a>represent a row of the game map and each element of the second-level array is going to be a tile ID.</p><p>By using an array to store our level data, it means we can easily store our level layouts in a matter of bytes, and by establishing where our play is in the array we get collision detection for very little effort.</p><p>Create a new C# script in the scripts folder and call it <code class="literal">Sokoban</code>, then double-click on the script to edit it. Add the following code just above the <code class="literal">Start</code> method:</p><div class="informalexample"><pre class="programlisting">// Legend
// 0 = Floor
// 1 = Wall
// 2 = Goal
// 3 = Crate
// 4 = Player
// -1 = Empty tile


// Create the top array, this will store the level arrays
int[][][] levels = 
{
  // Create the level array, this will store the row array
  new int [][] {
    // Create all row array, these will store column data
    new int[] {1,1,1,1,1,1,1,1},
    new int[] {1,0,0,1,0,0,0,1},
    new int[] {1,0,3,3,0,3,0,1},
    new int[] {1,0,0,1,0,1,0,1},
    new int[] {1,0,0,1,3,1,0,1},
    new int[] {1,0,0,2,2,2,2,1},
    new int[] {1,0,0,1,0,4,1,1},
    new int[] {1,1,1,1,1,1,1,1}
  }
};</pre></div><p>We're <a id="id164" class="indexterm"></a>only going to have one level for the moment. You can <a id="id165" class="indexterm"></a>visualize the level quite easily when you look at the<a id="id166" class="indexterm"></a> three-dimensional array like this.</p><p>Now add the following code below the closing bracket of our levels array:</p><div class="informalexample"><pre class="programlisting">public Transform wall;
public Transform floor;
public Transform goal;
public Transform crate;
public Transform player;
int playerRow;
int playerCol;
Transform thePlayer;
string movingCrate = "";
int amountOfCrates = 0;</pre></div><p>Defining the variables here means we will be able to access them from all methods in this class. The ones that are prefixed with public will be exposed inside the Unity development environment. The <code class="literal">playerRow</code> and <code class="literal">playerCol</code> methods are going to be used in our level-rendering code and the <code class="literal">crate</code> related ones are going to be for moving the crates and checking if we've finished the level or not.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec19"></a>The BuildLevel method</h3></div></div></div><p>We now <a id="id167" class="indexterm"></a>have the level map in our three-dimensional array, our prefabs to act as the building blocks for our level, and the materials to give them some <a id="id168" class="indexterm"></a>color, which means we're ready to actually build the level now!</p><p>Double-click on your <code class="literal">Sokoban</code> script to open it in MonoDevelop, and above the <code class="literal">Start</code> method, add the following code:</p><div class="informalexample"><pre class="programlisting">void BuildLevel () {
  // Loop through the level array
  for (int i = 0; i&lt; levels[0].Length; i++) {
    
    // Loop through the row array
    for (int j = 0; j &lt; levels[0][i].Length; j++) {
      
      // What value is the tile in this column
      switch (levels[0][i][j]) {
        case 0: // Floor
        Instantiate(floor, 
          new Vector3 (i, -0.6f, j), 
        Quaternion.identity);
        break;
        case 1: // Wall, add a floor below it
        Instantiate(
          floor, 
          new Vector3 (i, -0.6f, j), 
        Quaternion.identity);
        
        
        Instantiate(
          wall, 
          new Vector3 (i, 0, j), 
        Quaternion.identity);
        break;
        case 2: // Goal
        Instantiate(
          goal, 
          new Vector3 (i, -0.6f, j), 
        Quaternion.identity);
        break;
        case 3: // Create, add a floor below it
        Instantiate(
          floor, 
          new Vector3 (i, -0.6f, j), 
        Quaternion.identity);
        Transform crateCubeInstance = Instantiate(
          crate, 
          new Vector3 (i, 0, j), 
        Quaternion.identity) as Transform;
        crateCubeInstance.name = 
        "crate_" + i + "_" + j;
        amountOfCrates++;
        break;
        case 4: // Player, add a floor below it
        Instantiate(
          floor, 
          new Vector3 (i, -0.6f, j), 
        Quaternion.identity);
        thePlayer = Instantiate(
          player, 
          new Vector3 (i,0, j), 
        Quaternion.identity) as Transform;
        thePlayer.name = "Player";
        playerRow = i;
        playerCol = j;
        break;
      }
    }
  }
}</pre></div><p>That does<a id="id169" class="indexterm"></a> look like quite a lot of code but it's only using three <a id="id170" class="indexterm"></a>principles, let's go through what they are:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">for</code> loop: The first <code class="literal">for</code> loop is iterating through the rows in level 1, we only have<a id="id171" class="indexterm"></a> one of those so far, so we're just using index 0 in the array. The second for loop is iterating through each column segment in that row.</p></li><li style="list-style-type: disc"><p>The <code class="literal">switch</code> statement: We pass the tile ID, which we get from the column array, into <a id="id172" class="indexterm"></a>the switch statement which will evaluate what was passed in and respond with the appropriate case.</p></li><li style="list-style-type: disc"><p>The <code class="literal">Instantiate</code> method: This is the method that loads the prefabs we created<a id="id173" class="indexterm"></a> earlier and attaches them to the scene. You will see that we pass <code class="literal">Instantiate</code> to one of the <code class="literal">public Transform</code> variables we created earlier.</p></li></ul></div><p>We have to call the method after creating it so change <code class="literal">Start</code> to <code class="literal">Awake</code> and add the method call inside there. The final method should look like the following code:</p><div class="informalexample"><pre class="programlisting">void Awake () {
  BuildLevel();
}</pre></div><p>As our prefabs are all one unit in size in both X and Z axis, we can just use the <code class="literal">int</code> that are defined in the <code class="literal">for</code> loops. As we are setting the walls, player, and crate <code class="literal">Y</code> to <code class="literal">0</code>, their Y boundaries will be from <code class="literal">-0.5</code> to <code class="literal">0.5</code> as Unity will place the center of the GameObject at the location<a id="id174" class="indexterm"></a> specified. It is for this reason that we set the <code class="literal">Y</code> position <a id="id175" class="indexterm"></a>of the <code class="literal">floor</code> and <code class="literal">goal</code> GameObjects to <code class="literal">-0.6</code>.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Click on <span class="strong"><strong>GameObject</strong></span> | <span class="strong"><strong>Create Empty</strong></span> and a new GameObject will appear in the <span class="strong"><strong>Hierarchy</strong></span> panel with the name <span class="strong"><strong>GameObject</strong></span>.</p></li><li><p>It should already be highlighted, so click on it once more and the name will become editable; call it <code class="literal">Sokoban</code>.</p></li><li><p>Drag the <code class="literal">Sokoban</code> script to the GameObject, and you will see your five exposed, public <code class="literal">Transform</code> variables in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>Click and drag each prefab to its respective <span class="strong"><strong>Transform</strong></span> variable, this will assign the prefab to the variable.</p></li><li><p>Click on <span class="strong"><strong>Build, Run and Compile Application</strong></span> on the <span class="strong"><strong>Ouya</strong></span> panel, and then proceed past the title screen and you should hopefully see a screen like the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783559701/graphics/9701OS_03_04.jpg" /></div></li></ol></div><p>Common <a id="id176" class="indexterm"></a>fail points are forgetting to add the script to a new <a id="id177" class="indexterm"></a>GameObject in this scene or neglecting to add the prefabs to the exposed public <code class="literal">Transform</code> variables in the <span class="strong"><strong>Inspector</strong></span> panel.</p></div></div>