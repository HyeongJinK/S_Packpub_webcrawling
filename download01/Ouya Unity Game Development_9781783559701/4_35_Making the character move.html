<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec38"></a>Making the character move</h2></div></div><hr /></div><p>Our game is shaping up nicely, we have the level-building code complete and the camera will, in theory, follow the player around when they move. Let's put that to the test.</p><p>As in the <a id="id186" class="indexterm"></a>previous chapter, we'll get all the input working<a id="id187" class="indexterm"></a> with the keyboard and then implement the Ouya input.</p><p>We are going to make it so the person playing the game can turn left, turn right, and move forward. This will always happen one tile at a time.</p><p>Edit your <code class="literal">Sokoban</code> script file and add the following code below the <code class="literal">int amountOfCrates = 0;</code> line:</p><div class="informalexample"><pre class="programlisting">GameObject theCrate;
bool isPlayerMoving;
bool isPlayerRotating;
int rotationSpeed;
int movingSteps;
int tRow;
int tCol;</pre></div><p>The items these variables will represent are:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<code class="literal">theCrate</code>: This is a reference to the crate game object that the player is currently pushing</p></li><li style="list-style-type: disc"><p>
<code class="literal">isPlayerMoving</code>: This is a Boolean that will be set to <code class="literal">true</code> if the player is moving, else it will be <code class="literal">false</code>
</p></li><li style="list-style-type: disc"><p>
<code class="literal">isPlayerRotating</code>: This is a Boolean that will be set to <code class="literal">true</code> if the player is moving, else it will be <code class="literal">false</code>
</p></li><li style="list-style-type: disc"><p>
<code class="literal">rotationSpeed</code>: This indicates how fast the player turn will happen</p></li><li style="list-style-type: disc"><p>
<code class="literal">movingSteps</code>: This indicates the number of steps it will take the movement method to move the player one unit</p></li><li style="list-style-type: disc"><p>
<code class="literal">tRow</code>: This is the row that the player will be attempting to move to</p></li><li style="list-style-type: disc"><p>
<code class="literal">tCol</code>: This is the column that the player will be attempting to move to</p></li></ul></div><p>The method we're going to add next is going to work out if we can move to the tile when we try to. As <a id="id188" class="indexterm"></a>we're storing the players X and Y tile position and <a id="id189" class="indexterm"></a>we know their rotation, we can check the element in the array that represents forwards to the player. The code for this is as follows:</p><div class="informalexample"><pre class="programlisting">// Check if the player is attempting to move
void CheckIfPlayerIsAttempingToMove () {
  
  // Has the player tried to move forwards?
  if (Input.GetKeyDown (KeyCode.UpArrow)) {
    
    // What direction is the player currently facing?
    // Depending on the angle we get a different row and 
    // column in the array for where we are going to move
    switch((int)Mathf.Round(thePlayer.transform.eulerAngles.y)) {
      case 0 :
      tRow = 0;
      tCol = 1;
      break;
      case 90 :
      tRow = 1;
      tCol = 0;
      break;
      case 180 :
      tRow = 0;
      tCol = -1;
      break;
      case 270 :
      tRow = -1;
      tCol = 0;
      break;
    }
    
    // Is the target tile a floor, 0, or a goal, 2?
    if (levels[0][pRow + tRow][pCol+tCol] == 0 ||levels[0][pRow + tRow][pCol + tCol] == 2)
    {
      
      isPlayerMoving = true;
      movingSteps = 0;
      
    } else if (levels[0][pRow + tRow][pCol + tCol] == 3 || levels[0][pRow + tRow][pCol + tCol] == 5) 
    {
      // Is the target tile a crate on a floor tile, 3, or a
      // crate on a goal tile, 5?
      
      // At this point we know the player is pushing a 
      // crate so we need to check if the crate can be 
      // pushed to the target location
      
      // Is the target tile a floor, 0, or a goal, 2?
      if (levels[0][pRow + 2 * tRow][pCol + 2 * tCol] == 0 || levels[0][pRow + 2 * tRow][pCol + 2 * tCol] == 2)
      {
        
        // Store a reference to the moving crate's name
        movingCrate = "crate_" +
                      (pRow + tRow) + 
                      "_" + 
                      (pCol + tCol);
        
        isPlayerMoving = true;
        movingSteps = 0;
      }
    }
  } else {
    
    // Is the player turning left or right?
    // The rotationSpeed variable can be tweaked but MUST go 
    // exactly in to 90
    // Example: 90 / 5 = 18 - OK
    // Example: 90 / 6 = 15 - OK
    // Example: 90 / 7 = 12.85 - FAIL
    if (Input.GetKeyDown (KeyCode.RightArrow)) {
      isPlayerRotating = true;
      rotationSpeed = 5;
    }
    else if (Input.GetKeyDown (KeyCode.LeftArrow)) {
      isPlayerRotating = true;
      rotationSpeed = -5;
    }
  }
}</pre></div><p>There are <a id="id190" class="indexterm"></a>comments in the code so you can see, line by line, what <a id="id191" class="indexterm"></a>each part does, but let's go over the method now, from top to bottom and explain what it does generally:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Check if the Up arrow key has been pressed. If it has:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Check the direction the player is facing and establish what forwards means in terms of which array element to access. Depending on the results of the <code class="literal">switch</code> statement, it sets <code class="literal">tRow</code> and <code class="literal">tCol</code> to the correct values to represent the forwards direction.</p></li><li style="list-style-type: disc"><p>Check if there is an empty floor or goal tile for the player's target row and column. If there is then we set the <code class="literal">isPlayerMoving</code> Boolean to <code class="literal">true</code> and set the <code class="literal">movingSteps</code> variable to <code class="literal">0</code>.</p></li><li style="list-style-type: disc"><p>Check if the tile in front is a crate.</p></li><li style="list-style-type: disc"><p>If <code class="literal">true</code> then check if there is an empty floor or goal tile for the crate's target row and column. If there is, then we set the <code class="literal">isPlayerMoving</code> Boolean to <code class="literal">true</code>, set the <code class="literal">movingSteps</code> variable to <code class="literal">0</code> and store a reference crate's name in <code class="literal">movingCrate</code>.</p></li></ul></div></li><li style="list-style-type: disc"><p>If it hasn't:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Check if the Left arrow key has been pressed. If it has, then we set the <code class="literal">isPlayerRotating</code> Boolean to <code class="literal">true</code> and set the <code class="literal">rotationSpeed</code> variable to <code class="literal">-5</code>.</p></li><li style="list-style-type: disc"><p>Check if the Right arrow key has been pressed. If it has, then we set the <code class="literal">isPlayerRotating</code> Boolean to <code class="literal">true</code> and set the <code class="literal">rotationSpeed</code> variable to <code class="literal">5</code>.</p></li></ul></div></li></ul></div><p>Now we have written the<a id="id192" class="indexterm"></a> method, let's add it in the <code class="literal">Update</code> method:</p><div class="informalexample"><pre class="programlisting">void Update () {
  
  // Is the player is stationary at the moment?
  if (!isPlayerMoving &amp;&amp; !isPlayerRotating) {
    CheckIfPlayerIsAttempingToMove();
  }
}</pre></div><p>As you can see, we check if the player is not currently moving or rotating, and if both of those checks pass, we check if the player is attempting to move. While we're working in the <code class="literal">Update</code> method <a id="id193" class="indexterm"></a>lets add the next piece of code, add it just below the end of the if statement:</p><div class="informalexample"><pre class="programlisting">if (isPlayerMoving) {
  MovePlayer();
}

// Do we need to rotate the character
// This is an interative process and will occur every frame until 
// we have rotated 90 degrees
if (isPlayerRotating) {
  RotatePlayer();
}</pre></div><p>Let's look <a id="id194" class="indexterm"></a>at what is happening in the code now:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<code class="literal">Update</code> is called once per frame</p></li><li style="list-style-type: disc"><p>If the <a id="id195" class="indexterm"></a>player is not moving, check if they are attempting to</p></li><li style="list-style-type: disc"><p>If an attempt to move forwards is successful, set <code class="literal">isPlayerMoving</code> to <code class="literal">true</code>
</p></li><li style="list-style-type: disc"><p>If the player has rotated set <code class="literal">isPlayerRotating</code> to <code class="literal">true</code>
</p></li><li style="list-style-type: disc"><p>If <code class="literal">isPlayerMoving</code> is <code class="literal">true</code>, then call the <code class="literal">MovePlayer</code> method to move the player model</p></li><li style="list-style-type: disc"><p>
<code class="literal">IfisPlayerRotating</code> is <code class="literal">true</code>, then call the <code class="literal">RotatePlayer</code> method to rotate the player</p></li></ul></div><p>Once the <code class="literal">isPlayerMoving</code> or <code class="literal">isPlayerRotating</code> Booleans are set to true they will not be set to false until the <code class="literal">MovePlayer</code> or <code class="literal">RotatePlayer</code> methods have completed. After we add these next two methods we should be able to test our game and play through the level. Add the following two methods:</p><div class="informalexample"><pre class="programlisting">void MovePlayer () {
  
  // Move the player forward. We move in 10 steps and need to 
  // move 1 unit for 1 complete move
  // so we move 0.1 for each step taken. 0.1 * 10 = 1
  thePlayer.transform.Translate(Vector3.forward * 0.1f);
  
  // Are we moving a crate?
  if (movingCrate != "") {
    
    // Get a reference to the crate
    theCrate = GameObject.Find(movingCrate);
    
    // What direction is the player currently facing?
    switch((int)Mathf.Round(thePlayer.transform.eulerAngles.y)) {
      case 0 :
      theCrate.transform.Translate(Vector3.forward * 0.1f);
      break;
      case 90 :
      theCrate.transform.Translate(Vector3.right * 0.1f);
      break;
      case 180 :
      theCrate.transform.Translate(Vector3.forward * -0.1f);
      break;
      case 270 :
      theCrate.transform.Translate(Vector3.right * -0.1f);
      break;
    }
  }
  movingSteps++;
  
  // Have we finished the move?
  if (movingSteps == 10) {
    
    isPlayerMoving = false;
    
    // 4 is the tile reference for the player so add 4 to 
    // the tile we have moved to
    // Example: A goal, 2, would become 6 as we have added 4 
    //for the player
    // Add to the tile we have moved to
    levels[0][pRow + tRow][pCol + tCol] += 4;
    
    // Remove player from the tile we have moved from
    levels[0][pRow][pCol] -= 4;
    
    // Are we moving a crate?
    if (movingCrate != "") {
      
      // 3 is the tile reference for a crate so add 3 to 
      //the tile the crate moved to
      // Example: A goal, 2, would become 5 as we have added 
      //3 for the crate
      // Add to the tile we have moved to
      levels[0][pRow + 2 * tRow][pCol + 2 * tCol] += 3;
      
      // Remove from the tile we have moved from
      levels[0][pRow + tRow][pCol + tCol] -= 3;
      
      // Adjust the name of the crate and move the
      // reference to it as we are no longer pushing it
      theCrate.name = "crate_" + 
                      (pRow + 2 * tRow) + 
                      "_" + 
                      (pCol + 2 * tCol);
      movingCrate = "";
    }
    
    // Adjust the stored player location on the map and in 
    // the array
    pRow += tRow;
    pCol += tCol;
  }
}

void RotatePlayer () {
  
  // Adjust the transform
  thePlayer.transform.Rotate(0, rotationSpeed, 0);
  
  // Have we rotated a full 90 degrees?
  if (Mathf.Round(thePlayer.transform.eulerAngles.y) % 90 == 0)
  {
    isPlayerRotating = false;
  }
}</pre></div><p>Again, there <a id="id196" class="indexterm"></a>are comments in the code so that you can see what<a id="id197" class="indexterm"></a> each part does and gives a general <a id="id198" class="indexterm"></a>break down of what the code path for each method is. For the <code class="literal">MovePlayer</code> method:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Modify player's <code class="literal">transform</code> by <code class="literal">0.1</code> of a unit forwards (the direction the player is facing). We use <code class="literal">0.1</code> as this method will run ten times before setting <code class="literal">isPlayerMoving</code> to <code class="literal">true</code>.</p></li><li style="list-style-type: disc"><p>Check if we have a string reference in <code class="literal">movingCrate</code>.</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>If we do then find the crate</p></li><li style="list-style-type: disc"><p>Modify crate's <code class="literal">transform</code> by <code class="literal">0.1</code> of a unit in the same direction as the player</p></li></ul></div></li><li style="list-style-type: disc"><p>Increment the <code class="literal">movingSteps</code> variable, this is our step counter and we will stop executing this method when this has completed ten steps.</p></li><li style="list-style-type: disc"><p>Check the value of <code class="literal">movingSteps</code>, if this value is <code class="literal">10</code> then set the array entries and stop this method being called again.</p></li><li style="list-style-type: disc"><p>Set the value of <code class="literal">isPlayerMoving</code> to <code class="literal">false</code>, this is what will stop the method being called in <code class="literal">Update</code> again until a key press or Ouya controller press occurs.</p></li><li style="list-style-type: disc"><p>Add <code class="literal">4</code> to the value of the array entry that the player has moved to, this means we can still establish what the original tile is without the player on it.</p></li><li style="list-style-type: disc"><p>Remove <a id="id199" class="indexterm"></a>four from the array entry we have <a id="id200" class="indexterm"></a>moved from.</p></li><li style="list-style-type: disc"><p>Check if we have a string reference in <code class="literal">movingCrate</code>.</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>If we do then add three to the value of the array entry that the crate has moved to</p></li><li style="list-style-type: disc"><p>Remove three from the array entry the crate has moved from</p></li><li style="list-style-type: disc"><p>Adjust the crates name to reflect its new position in the array</p></li><li style="list-style-type: disc"><p>Set <code class="literal">movingCrate</code> to an empty string in case we don't move it next move</p></li></ul></div></li><li style="list-style-type: disc"><p>Modify the <code class="literal">pCol</code> and <code class="literal">pRow</code> variables by the values stored in <code class="literal">tCol</code> and <code class="literal">tRow</code>, this way we always have the current index of the player.</p></li></ul></div><p>The <code class="literal">RotatePlayer</code> method<a id="id201" class="indexterm"></a> is much simpler:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Modify player's<code class="literal"> transform.Rotate</code> of the <code class="literal">Vector3</code> rotation type by the <code class="literal">rotationSpeed</code> variable defined earlier around the y axis</p></li><li style="list-style-type: disc"><p>Check if we have rotated a full 90 degrees by checking that dividing the current rotation by ninety leaves no remainder. In case you are not sure, the <code class="literal">%</code> operator is called modulo</p></li><li style="list-style-type: disc"><p>If we have rotated a full 90 degrees then set <code class="literal">isPlayerRotating</code> to <code class="literal">false</code>
</p></li></ul></div><p>Close the script, go back to Unity, and press the play icon at the top middle of the Unity screen. Try using the Left arrow and Right arrow keys to turn left and right and the Up arrow key move forwards. The camera should pan smoothly around the player as you turn.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec20"></a>Ouya controller support</h3></div></div></div><p>As we have already added the <code class="literal">OuyaInput.unitypackage</code> package in our previous chapter, we can <a id="id202" class="indexterm"></a>go right ahead and <a id="id203" class="indexterm"></a>implement the controller support. The Ouya team have made it so simple to integrate the controller once all the necessary files are imported, just add the following lines inside our public class definition in our <code class="literal">Sokoban</code> script:</p><div class="informalexample"><pre class="programlisting">public bool continuousScan = true;
public OuyaPlayer player = OuyaPlayer.P01;</pre></div><p>Also as before, add the following <a id="id204" class="indexterm"></a>lines to the <code class="literal">Awake</code> method:</p><div class="informalexample"><pre class="programlisting">OuyaInput.SetContinuousScanning(continuousScan);
OuyaInput.UpdateControllers();</pre></div><p>At the start of the <code class="literal">Update</code> method<a id="id205" class="indexterm"></a> add:</p><div class="informalexample"><pre class="programlisting">OuyaInput.UpdateControllers();</pre></div><p>Now edit the <code class="literal">CheckIfPlayerIsAttempingToMove</code> method and edit the following three lines:</p><div class="informalexample"><pre class="programlisting">if (Input.GetKeyDown (KeyCode.UpArrow)) {
if (Input.GetKeyDown (KeyCode.LeftArrow)) {
if (Input.GetKeyDown (KeyCode.RightArrow)) {</pre></div><p>They need to become:</p><div class="informalexample"><pre class="programlisting">if (Input.GetKeyDown (KeyCode.UpArrow) || OuyaInput.GetButtonDown(OuyaButton.DU, player)) {

if (Input.GetKeyDown (KeyCode.LeftArrow) || OuyaInput.GetButtonDown(OuyaButton.DL, player)) {

if (Input.GetKeyDown (KeyCode.RightArrow) || OuyaInput.GetButtonDown(OuyaButton.DR, player)) {</pre></div><p>Press <span class="strong"><strong>Build, Run and Compile Application</strong></span> on the <span class="strong"><strong>Ouya Panel</strong></span> and go through the steps to get to the game, try the directional pad on the controller and you'll see that the game responds just as it did when you were pressing the arrow keys on your keyboard.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec21"></a>Animating the character</h3></div></div></div><p>While there is already some basic animation in the character in terms of moving them smoothly <a id="id206" class="indexterm"></a>between tiles, wouldn't it be nicer to have an actual <a id="id207" class="indexterm"></a>character? It would! <span class="strong"><strong>Unity Asset Store</strong></span>, <span class="strong"><strong>TurboSquid</strong></span>, and <a id="id208" class="indexterm"></a>many others offer models for free or a very low cost. For our <a id="id209" class="indexterm"></a>game we're going to use an asset that Unity provides in one of their demos. Unity very kindly allows you to include their assets in your own projects and still offer them for sale.</p><p>The character in question is from a demo called Astro Dude and he looks like this:</p><div class="mediaobject"><img src="/graphics/9781783559701/graphics/9701OS_04_02.jpg" /></div><p>Import the <code class="literal">playerModel.unitypackage</code> package from the source files for this chapter. Once all the files<a id="id210" class="indexterm"></a> are imported you'll have a new <code class="literal">Player</code> folder<a id="id211" class="indexterm"></a> inside your <code class="literal">Prefabs</code> folder, click on the <span class="strong"><strong>playerAnimated</strong></span> prefab inside the <span class="strong"><strong>PlayerModel</strong></span> prefab and look at the <span class="strong"><strong>Inspector</strong></span> panel, you should see two animations listed:</p><div class="mediaobject"><img src="/graphics/9781783559701/graphics/9701OS_04_03.jpg" /></div><p>Make a note of the two animation names as we'll be using them later. The names are <span class="strong"><strong>idle</strong></span> and <span class="strong"><strong>runforward</strong></span>.</p><p>Drag the new <span class="strong"><strong>PlayerModel</strong></span> prefab in to the <code class="literal">Player</code> transform slot on the script that is attached to your <code class="literal">Sokoban</code> game object.</p><p>This model's sizes are a little different so we're going to need to adjust the instantiation code in the <code class="literal">BuildLevel</code> method<a id="id212" class="indexterm"></a> as we're also going to have to trigger the built in animations <a id="id213" class="indexterm"></a>already in the model when they are required. Let's start <a id="id214" class="indexterm"></a>with the model position, it's taller than the one unit that our cube is so to adjust the Y position when we instantiate it change the following line from:</p><div class="informalexample"><pre class="programlisting">thePlayer = Instantiate(player, new Vector3 (i,0, j), Quaternion.identity) as Transform;</pre></div><p>To:</p><div class="informalexample"><pre class="programlisting">thePlayer = Instantiate(player, new Vector3 (i,1, j), Quaternion.identity) as Transform;</pre></div><p>The change is small, we've just changed <code class="literal">0</code> to <code class="literal">1</code>. There is slightly more code for the animations, but don't worry it's not too much. First we need to declare a variable at the top of our script to store the reference to <code class="literal">Animation</code> so add the following line inside our public class definition:</p><div class="informalexample"><pre class="programlisting">Animation thePlayerAnimation;</pre></div><p>If we think about the points we need to trigger our character's animation it's only actually a few places. They are:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>When the script loads, after the <code class="literal">BuildLevel</code> method, we need to trigger the <span class="strong"><strong>idle</strong></span> animation</p></li><li style="list-style-type: disc"><p>If the Up arrow key is pressed, we need to trigger the <span class="strong"><strong>runforward</strong></span> animation</p></li><li style="list-style-type: disc"><p>If the player has finished moving, we need to trigger the <span class="strong"><strong>idle</strong></span> animation</p></li></ul></div><p>First we need to get the reference to the animations so add the following lines to the <code class="literal">Awake</code> method:</p><div class="informalexample"><pre class="programlisting">thePlayerAnimation = GameObject.Find("playerAnimated").animation;
thePlayerAnimation.Play("idle");</pre></div><p>Next, just after the <code class="literal">GetKeyDown</code> method check inside the <code class="literal">CheckIfPlayerIsAttemptingToMove</code> method add:</p><div class="informalexample"><pre class="programlisting">thePlayerAnimation.CrossFade ("runforward");</pre></div><p>Finally, add to following after the <code class="literal">if (movingSteps == 10) {</code> line in the <code class="literal">MovePlayer</code> method:</p><div class="informalexample"><pre class="programlisting">thePlayerAnimation.CrossFade ("idle");</pre></div><p>Test <a id="id215" class="indexterm"></a>your game and now and behold! Proper animation<a id="id216" class="indexterm"></a> and a fancy character in your game.</p></div></div>