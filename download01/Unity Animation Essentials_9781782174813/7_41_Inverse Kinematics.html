<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec41"></a>Inverse Kinematics</h2></div></div><hr /></div><p>Inverse kinematics<a id="id241" class="indexterm"></a> is often shortened to IK, and it's highly important for achieving easy and believable character animation. Practically, IK lets you position hand or feet bones in a rig, and the remaining joints and bones will rotate and move automatically to achieve a believable look. In other words, for creating walk animations or pick-up animations, where a foot or hand comes in contact with a surface, IK saves the effort of animating all the bones involved, between either the foot and the hip, or the hand and the shoulder.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_07_08.jpg" /><div class="caption"><p>Configuring IK in Blender</p></div></div><p>Most 3D applications, such as Maya, 3ds Max, and Blender, provide options and features for creating IK. The <a id="id242" class="indexterm"></a>purpose of these features is to help artists make animation simpler and easier. However, different programs store IK data differently, and this data is not typically transferable into Unity, even via FBX Files. This means that your character models will almost always be imported without IK data. This, however, doesn't mean that IK animations created in your 3D software will look any different when imported into Unity. It only means that all IK animations will be imported into Unity as <a id="id243" class="indexterm"></a>
<span class="strong"><strong>Forward Kinematics</strong></span> (<span class="strong"><strong>FK</strong></span>). They will look identical, but will not give you any access to the IK features, not allowing you to easily pose and move your skeleton dynamically using IK. To fix this, you'll need to manually configure IK for your bones in Unity if you want access to IK features to dynamically pose the hands and feet of your characters.</p><p>To get IK to work properly, we first import a rigged character model into Unity. Then we select the model from the Project panel and enable the <span class="strong"><strong>Humanoid</strong></span> rig, simply by switching to the <span class="strong"><strong>Rig</strong></span> tab in the Object Inspector and selecting <span class="strong"><strong>Humanoid</strong></span> for <span class="strong"><strong>Animation Type</strong></span>. This <a id="id244" class="indexterm"></a>does not enable IK per se, but configures your model to use the Mecanim Avatar system, which is required for IK. A suitable character model is included in the companion files in the <code class="literal">Chapter07/IK</code> folder.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_07_09.jpg" /><div class="caption"><p>Configuring a character as a Humanoid rig</p></div></div><p>Let's now jump into using IK to control the character's hands, giving us independent control over hand placement and ensuring that all other arm bones will automatically bend and change to match the hand positions. To do this, create two new empty game objects in the scene. These will represent the control bones of the game character. These bones will be used to position the character's hands. Name the bones <code class="literal">IK_LeftHand</code> and <code class="literal">IK_RightHand</code>.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_07_10.jpg" /><div class="caption"><p>Creating IK bones from empty game objects</p></div></div><p>By default, the <a id="id245" class="indexterm"></a>bones are not visible in the viewport unless selected in the Hierarchy panel. To make the bones into visible and clickable objects, select the cube tag icon in the Object Inspector and assign a 2D Gizmo representation to the object. Once selected, the bones can be both seen and selected from the viewport.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_07_11.jpg" /><div class="caption"><p>Making empties visible</p></div></div><p>Position each bone in the scene in front of the hand to be movedâ€”the left bone in front of the left hand, and the right bone in front of the right hand.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_07_12.jpg" /><div class="caption"><p>Positioning the IK bones</p></div></div><p>Create a<a id="id246" class="indexterm"></a> new <span class="strong"><strong>Animator Controller</strong></span> asset (<code class="literal">animCharControl</code>) and link the <span class="strong"><strong>Entry</strong></span> node to an empty state. To create an empty state, simply right-click inside the graph and go to <span class="strong"><strong>Create State</strong></span> | <span class="strong"><strong>Empty</strong></span> from the context menu. Make sure that the empty state is the default node. Creating an <span class="strong"><strong>Animator Controller</strong></span> asset is important for both animating a character and working with IK.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_07_13.jpg" /><div class="caption"><p>Creating a new Animator Controller asset</p></div></div><p>Make sure that <a id="id247" class="indexterm"></a>the <span class="strong"><strong>Animator Controller</strong></span> asset enables an <span class="strong"><strong>IK Pass</strong></span>, allowing you to control the character IK programmatically in script. This is essential for using IK in Unity. To do this, click on the cog icon of <span class="strong"><strong>Base Layer</strong></span> in the Animator window. Then select the <span class="strong"><strong>IK Pass</strong></span> checkbox.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_07_14.jpg" /><div class="caption"><p>Enabling an IK Pass</p></div></div><p>Assign the controller<a id="id248" class="indexterm"></a> to the character by dragging and dropping the <span class="strong"><strong>Animator Controller</strong></span> asset from the Project panel onto the character mesh in the scene.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_07_15.jpg" /><div class="caption"><p>Assigning an Animator Controller asset to the character</p></div></div><p>Next, create the following script file and attach it to the character. This script file allows us to use the left- and right-hand control objects as IK targets for the arms. Because the <span class="strong"><strong>IK Pass</strong></span> checkbox was selected, the <span class="strong"><strong>Animator Controller</strong></span> asset will automatically call the <code class="literal">OnAnimatorIK</code> event function to position the arms of the skeleton on the specified objects:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class ArmIK : MonoBehaviour 
{
  public float leftHandPositionWeight;
  public float leftHandRotationWeight;

  public float rightHandPositionWeight;
  public float rightHandRotationWeight;

  public Transform leftHandObj;
  public Transform rightHandObj;
  private Animator animator;

  void Start() {
    animator = GetComponent&lt;Animator&gt;();
  }
  void OnAnimatorIK(int layerIndex) {
    animator.SetIKPositionWeight(AvatarIKGoal.LeftHand, leftHandPositionWeight);
    animator.SetIKRotationWeight(AvatarIKGoal.LeftHand, leftHandRotationWeight);
    animator.SetIKPosition(AvatarIKGoal.LeftHand, leftHandObj.position);
    animator.SetIKRotation(AvatarIKGoal.LeftHand, leftHandObj.rotation);

    animator.SetIKPositionWeight(AvatarIKGoal.RightHand, rightHandPositionWeight);
    animator.SetIKRotationWeight(AvatarIKGoal.RightHand, rightHandRotationWeight);
    animator.SetIKPosition(AvatarIKGoal.RightHand, rightHandObj.position);
    animator.SetIKRotation(AvatarIKGoal.RightHand, rightHandObj.rotation);
  }
}</pre></div><p>Attach the script<a id="id249" class="indexterm"></a> file to the character. Then drag and drop the left- and right-hand objects into the appropriate <code class="literal">Transform</code> slots in the Object Inspector. Next, set the weightings to <span class="strong"><strong>100</strong></span> to ensure that the bones will affect the object.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_07_16.jpg" /><div class="caption"><p>Controlling IK bone weighting</p></div></div><p>Now take the game<a id="id250" class="indexterm"></a> for a test run and see IK in action. The character should begin in a default pose, but his arms will magnetize towards the control objects for the hands.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_07_17.jpg" /><div class="caption"><p>Testing the IK bones</p></div></div><p>For test purposes, when moving control objects in the scene viewport, you'll see the character's arms move, bend, and <a id="id251" class="indexterm"></a>rotate to match the positions of the hands. Congratulations! You now have the ability to configure a Mecanim character for real-time IK and animation.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_07_18.jpg" /><div class="caption"><p>Positioning the hands</p></div></div></div>