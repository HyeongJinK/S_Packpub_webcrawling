<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec35"></a>Blend Trees</h2></div></div><hr /></div><p>When we<a id="id212" class="indexterm"></a> think about the playable character carefully, as shown in in the following screenshot, we can identify several states in which he can be in relation to the player input. Specifically, when the player is pressing nothing, the character should be in an idle-neutral pose, standing still and not moving at all.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_06_03.jpg" /><div class="caption"><p>A MakeHuman character to be animated</p></div></div><p>If the player presses either the left or right button only, the character should remain where he stands and <a id="id213" class="indexterm"></a>turn in the appropriate direction. If the player presses the forward or up arrow key, the character should walk or run forward. Here, we can then identify a range of states for the character, such as idle, walk, run and turn. However, things are not as simple as this, because the character could turn <span class="emphasis"><em>while</em></span> walking, or turn <span class="emphasis"><em>while</em></span> running. In these cases, two directions of movement are provided by the player simultaneously, and we need the character to respond appropriately in these situations as well. For walking and turning, an animation should play, but it must also blend seamlessly and easily with animations from all other states to create the look and feel of an organic character. To achieve this, we can use Blend Trees, which allow us to smoothly blend multiple humanoid animations. To create a Blend Tree, first display the <span class="strong"><strong>Animator</strong></span> window for the new <span class="strong"><strong>Animator Controller</strong></span> asset. To do this, go to <span class="strong"><strong>Window</strong></span> | <span class="strong"><strong>Animator </strong></span>from the application menu, as shown here:</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_06_04.jpg" /><div class="caption"><p>Show animator window</p></div></div><p>To create<a id="id214" class="indexterm"></a> the Blend Tree, right-click inside the animator graph and go to <span class="strong"><strong>Create State</strong></span> | <span class="strong"><strong>From New Blend Tree</strong></span>, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_06_05.jpg" /><div class="caption"><p>Creating a new Blend Tree</p></div></div><p>Once created, the <a id="id215" class="indexterm"></a>Blend Tree appears as a regular animation node. If it's the first created node, then it'll appear in orange and be connected to the <span class="strong"><strong>Entry</strong></span> node, since it automatically becomes the default node. If the Blend Tree node is not automatically connected like this, then right-click on the node and choose <span class="strong"><strong>Set as Layer Default State</strong></span> to make the Blend Tree default. This means that the Blend Tree will automatically play when the game runs and the <span class="strong"><strong>Animator</strong></span> is activated.</p><p>The Blend Tree, however, is a complex node compared to most animation nodes. It can be double-clicked on to reveal more options. By double-clicking on the Blend Tree in the graph, a new mode will be displayed in the Animator window, revealing more options. Using the Blend Tree interface, we can piece together a complex character animation. Notice that at the top of the Animator window, we can use the <span class="strong"><strong>Bread Crumb</strong></span> trail to return to our previous view when we need to, simply by clicking on the <span class="strong"><strong>Base Layer</strong></span> button.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_06_06.jpg" /><div class="caption"><p>Using the Blend Tree mode</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec35"></a>Dimensions</h3></div></div></div><p>By default, every<a id="id216" class="indexterm"></a> Blend Tree is configured to be one-dimensional. In other words, by default, every Blend Tree blends across a linear sequence of different animations. We can see this in the Object Inspector, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_06_07.jpg" /><div class="caption"><p>Setting the Blend Tree dimensions</p></div></div><p>One-dimensional Blend Trees may work well in a scenario where our character walks only forward and backward along a line, changing between idle, walk, and run states according to the player input. But in this case, our character should be able to turn, rotating to face new directions. Essentially, our character can move around on a 2D floor plane, and he responds to input from two axes (horizontal and vertical) instead of one. We should be able to use the up, down, left, and right keys to control the movement anywhere in the level. For this reason, change the Blend Tree type from <span class="strong"><strong>1D</strong></span> to <span class="strong"><strong>2D Freeform Cartesian</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_06_08.jpg" /><div class="caption"><p>Using a 2D Blend Tree</p></div></div><p>When you <a id="id217" class="indexterm"></a>create a 2D Blend Tree, the Object Inspector allows us to define motion fields to add to the graph. A <span class="strong"><strong>motion field</strong></span>
<a id="id218" class="indexterm"></a> simply refers to an animation clip that should be part of the Blend Tree. The character in this scenario will have idle, walk, run and turn animations, and so there should be motion fields for each of these states. Let's create some motion fields in the graph. To do this, click on the <span class="strong"><strong>+</strong></span> button in the <span class="strong"><strong>Motions</strong></span> panel in the Object Inspector, and then choose <span class="strong"><strong>Add Motion Field</strong></span> from the Context menu.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_06_09.jpg" /><div class="caption"><p>Adding motion fields</p></div></div><p>Click on the <span class="strong"><strong>+</strong></span> button nine times to add nine motion fields. These will correspond to the following possible states for the character: idle, idle-turn-left, idle-turn-right, walk, walk-turn-left, walk-turn-right, run, run-turn-left, and run-turn-right. Each state requires us to use a slightly different animation clip, and we'll need the Blend Tree to blend them when the player <a id="id219" class="indexterm"></a>provides an input. When you create two or more motion fields, a graphical representation of them appears in the Object Inspector.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_06_10.jpg" /><div class="caption"><p>Visualizing motion fields</p></div></div><p>The added motion fields will likely create a scattered arrangement of nodes inside the graph, and this is not appropriate. We'll fix it in a moment. First, let's assign animation clips to the fields. To do this, go to the <span class="strong"><strong>Assets</strong></span> | <span class="strong"><strong>Characters</strong></span> | <span class="strong"><strong>ThirdPersonController</strong></span> | <span class="strong"><strong>Animation</strong></span> folder and assign clips to each appropriate slot. I've used the assignments shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_06_11.jpg" /><div class="caption"><p>Assigning animation clips to motion fields</p></div></div><p>The animation<a id="id220" class="indexterm"></a> clips have now been assigned to the relevant motion fields, but the fields themselves are inside the graph (as shown in the Object Inspector), and they still appear scattered, rather than systematically arranged in rows and columns. Let's fix this now by changing the <span class="strong"><strong>Pos X</strong></span> and <span class="strong"><strong>Pos Y</strong></span> values for each motion field. Doing this will arrange the motion fields to accept 2D input data appropriately. Consider this screenshot:</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_06_12.jpg" /><div class="caption"><p>Positioning motion fields within the graph</p></div></div><p>Let's consider the <a id="id221" class="indexterm"></a>arrangement of motion fields more carefully. The idle state is the neutral or resting pose, so this appears as the (<span class="emphasis"><em>0</em></span>, <span class="emphasis"><em>0</em></span>) position in the graph. In contrast, running in a straight line is coded as (<span class="emphasis"><em>0</em></span>, <span class="emphasis"><em>1</em></span>) and walking is coded as (<span class="emphasis"><em>0</em></span>, <span class="emphasis"><em>0.5</em></span>), representing a state midway between resting and running. The turn states, by contrast, exist at the extremes of the <span class="emphasis"><em>x</em></span> axis. Therefore, a running turn is represented by (<span class="emphasis"><em>-1</em></span>, <span class="emphasis"><em>1</em></span>) (turning left) and (<span class="emphasis"><em>1</em></span>, <span class="emphasis"><em>1</em></span>) (turning right).</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec36"></a>Mapping floats</h3></div></div></div><p>Now the 2D axes<a id="id222" class="indexterm"></a> of motion are defined for the character in the Blend Tree. Next, we must create two floating-point parameters, giving us control over which animations should be blended from the script. First, create two floating-point values by switching to the <span class="strong"><strong>Parameters</strong></span> tab in the <span class="strong"><strong>Animator</strong></span> window, like this:</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_06_13.jpg" /><div class="caption"><p>Accessing the Parameters Tab</p></div></div><p>Click on <a id="id223" class="indexterm"></a>the <span class="strong"><strong>+</strong></span> button to add two new <span class="strong"><strong>Float</strong></span> parameters (decimal numbers). Name them <span class="strong"><strong>Horz</strong></span> (for horizontal) and <span class="strong"><strong>Vert</strong></span> (for vertical). Together, these parameters will decide, or control, which animation is being played on the character rig when an input is provided.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_06_14.jpg" /><div class="caption"><p>Creating floating-point parameters</p></div></div><p>Now that we've created two parameters, one for each axis of player input, let's map them to the Blend Tree in 2D Space. To do this, set the <span class="strong"><strong>Parameters</strong></span> field in the Object Inspector. Click on the first (leftmost) drop-down list and assign it the value of <span class="strong"><strong>Horz</strong></span> to map the <span class="strong"><strong>Horz</strong></span> parameter to the <span class="emphasis"><em>x</em></span> axis. Then repeat this procedure for <span class="strong"><strong>Vert</strong></span>, mapping it to the <span class="emphasis"><em>y</em></span> axis.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_06_15.jpg" /><div class="caption"><p>Mapping float parameters to the Blend Tree</p></div></div><p>When the mapping is established in this way, you can finally preview the animation and blend tree as<a id="id224" class="indexterm"></a> a whole from the Preview panel in the Object Inspector. The Blend Tree node in the animator graph now features two sliders, representing your parameters. These allow you to scrub (slide) between the extremes, testing the blending combinations in the tree.</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_06_16.jpg" /><div class="caption"><p>Testing the Blend Tree</p></div></div><p>To test the Blend Tree and verify that your motion fields are configured correctly, press the <span class="strong"><strong>Play</strong></span> button on the<a id="id225" class="indexterm"></a> tool bar in the Object Inspector. Then, adjust the slider fields in the Blend Tree to see the resultant animation. Your character motions should be looking good!</p><div class="mediaobject"><img src="/graphics/9781782174813/graphics/B04103_06_17.jpg" /><div class="caption"><p>Playing the Blend Tree in the Preview panel</p></div></div></div></div>