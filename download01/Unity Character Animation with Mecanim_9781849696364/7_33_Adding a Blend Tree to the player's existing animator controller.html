<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec35"></a>Adding a Blend Tree to the player's existing animator controller</h2></div></div><hr /></div><p>We will <a id="id419" class="indexterm"></a>begin with the player character, which we previously worked with in <a class="link" href="#" linkend="ch03">Chapter 3</a>, <span class="emphasis"><em>Interacting with the Environment</em></span>:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open the <code class="literal">Chapter7_Start</code> scene in the Unity project.</p><p>The scene contains the <code class="literal">FPSController</code> prefab, which already has a character controller, animator controller, and a control script attached.</p><p>We will start by testing the controller setup to determine the modifications we are going to make.</p></li><li><p>Preview the game by pressing the <span class="strong"><strong>Play</strong></span> button in the top-center of the unity interface.</p></li></ol></div><p>When moving from side to side (by pressing the <span class="emphasis"><em>A</em></span> and <span class="emphasis"><em>S</em></span> or the cursor keys), there is no apparent change in the animation.</p><p>We will improve this in the next few steps by adding strafing animation, which will add some subtle variation to the character animation when the player moves to the left and right.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec54"></a>Adding strafing animation to the player character with a Blend Tree</h3></div></div></div><p>We will start by<a id="id420" class="indexterm"></a> implementing the Blend Tree in the animator controller and making some other small adjustments:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the Unity interface, drag the <span class="strong"><strong>Animator</strong></span> tab toward the top of the screen and release, undocking it from the main interface as a window.</p></li><li><p>Resize the window by dragging the corners until you can comfortably see the current states.</p></li><li><p>Select the <span class="strong"><strong>ShootIdle</strong></span> state.</p></li><li><p>Right-click on and choose <span class="strong"><strong>Create new BlendTree</strong></span> in <span class="strong"><strong>State</strong></span>.</p><p>In the <span class="strong"><strong>Inspector</strong></span> panel, the existing motion clip will be replaced by the Blend Tree.</p><p>We could also make a Blend Tree as a new state, but we would lose all of our transitions to the other states and have to start from scratch. Converting a state to a Blend Tree will preserve its transitions within the state machine.</p></li><li><p>Double-click on the <span class="strong"><strong>ShootIdle</strong></span> state in the <span class="strong"><strong>Animator</strong></span> window.</p><p>The properties of the Blend Tree will become visible in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li></ol></div><p>Currently, the Blend Tree does <a id="id421" class="indexterm"></a>not contain any motion clips. We will explain the properties associated with the Blend Tree before we add the motion clips.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec55"></a>Using Blend Tree properties</h3></div></div></div><p>The Blend Tree<a id="id422" class="indexterm"></a> properties in the <span class="strong"><strong>Inspector</strong></span> panel define which motion clips are used and how they are blended together:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_07_01.jpg" /></div><p>Let's see how to use these properties:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the field at the top is the Blend Tree's name. We will leave it named <code class="literal">Blend Tree</code> for this example.</p></li><li><p>The <span class="strong"><strong>parameter</strong></span> is chosen<a id="id423" class="indexterm"></a> from the parameters that you created in the <span class="strong"><strong>Animator</strong></span> window. Only <code class="literal">float</code> parameters will show up<a id="id424" class="indexterm"></a> in the drop-down list, as this is the only kind of parameter that the Blend Tree can use.</p></li><li><p>The <span class="strong"><strong>blending graph</strong></span> is a <a id="id425" class="indexterm"></a>graphic visualization of how the motion clips blend together. Each motion clip is represented as a blue triangle, with the peak representative of the full use of the clip. The blending graph will not be visible until at least two motion fields have been added to the Blend Tree.</p></li><li><p>The <span class="strong"><strong>motions</strong></span> group, contains<a id="id426" class="indexterm"></a> the motion clips that are usually dragged into the Blend Tree properties from the <span class="strong"><strong>Assets</strong></span> panel.</p><p>Numerous motion clips can be added to each Blend Tree in this way. Alternatively, you can click on the radio button beside the motion field to select a file from a list. You can also add a Blend Tree to a motion field, effectively nesting the Blend Trees.</p></li><li><p>Beside the <span class="strong"><strong>Motion</strong></span> field is the <span class="strong"><strong>Threshold</strong></span> field, which defines where the blended motion fits within the whole motion. By default, these fields are grayed out and inaccessible:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="strong"><strong>Automate Thresholds</strong></span>: This is checked by default. Unchecking this will allow us to access each of the motion field's thresholds.</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Compute Thresholds</strong></span>: This is visible only when <span class="strong"><strong>Automate Thresholds</strong></span> is unchecked. It allows the computation of the blended clip speeds by average or angular speeds.</p></li></ul></div></li></ol></div><p>In the next step, we will add the motion sequences to the Blend Tree and test it in the game.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec56"></a>Adding the motion clips to the Blend Tree</h3></div></div></div><p>Blend Trees are<a id="id427" class="indexterm"></a> specialized kinds of state. Like ordinary states, they contain motion clips that are played during the game:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Inspector</strong></span> panel, click on the <span class="strong"><strong>+</strong></span> symbol in the <span class="strong"><strong>Motion</strong></span> group.</p><p>This will add a motion slot to the list.</p></li><li><p>Repeat this twice to create three motion fields.</p></li><li><p>In the <span class="strong"><strong>Project</strong></span> panel, navigate to the <code class="literal">PACKT_Animations</code> folder and locate the <code class="literal">pistolIdles</code> asset.</p></li><li><p>Click on the <a id="id428" class="indexterm"></a>gray arrow next to the asset's icon to view its contents.</p><p>Three animation files have already been created from the <code class="literal">PistolIdles.FBX</code> file.</p></li><li><p>Locate <span class="strong"><strong>shootIdle_left</strong></span> and drag this into the first motion field.</p></li><li><p>Drag <span class="strong"><strong>shootIdle</strong></span> into the second motion field.</p></li><li><p>Drag <span class="strong"><strong>shootIdle_right</strong></span> into the third motion field.</p></li></ol></div><p>In the <span class="strong"><strong>Animator</strong></span> window, you will see the diagram update to display the Blend Tree's three child nodes:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_07_02.jpg" /></div><p>Next, we will set up the parameters that will allow the blending to be implemented.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl3sec62"></a>Adding and adjusting the Blend Tree parameters and thresholds</h4></div></div></div><p>There are a few <a id="id429" class="indexterm"></a>more steps that we need to take in order to get the motion clips to play.</p><p>Importantly, we have to<a id="id430" class="indexterm"></a> define a parameter which will enable the blending:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Click on the <a id="id431" class="indexterm"></a><span class="strong"><strong>Parameters</strong></span> tab in the upper-left of the <span class="strong"><strong>Animator</strong></span> window.</p></li><li><p>Click on the <span class="strong"><strong>+</strong></span> symbol to create a new parameter.</p></li><li><p>Choose <span class="strong"><strong>Float</strong></span> to create a floating point parameter.</p><p>Blend Trees can only use float parameters to blend between motions.</p></li><li><p>Rename the<a id="id432" class="indexterm"></a> parameter <code class="literal">HSpeed</code>.</p></li><li><p>Back in the <span class="strong"><strong>Inspector</strong></span> panel, designate the new parameter for the Blend Tree by clicking on the arrow next to the <span class="strong"><strong>Parameter</strong></span> field and choosing <code class="literal">HSpeed</code>.</p><p>Next, we need to set the thresholds for the motion clips to tell Unity when each should be played.</p></li><li><p>Uncheck the <span class="strong"><strong>Automate Thresholds</strong></span> checkbox.</p><p>This will allow us to manually set the thresholds of the three blending motion clips.</p></li><li><p>In the <span class="strong"><strong>Threshold</strong></span> field, next to the <span class="strong"><strong>ShootIdle_left</strong></span> clip, type <code class="literal">-1.0</code>.</p></li><li><p>The <span class="strong"><strong>shootIdle</strong></span> state's threshold should be set to <code class="literal">0.0</code>.</p></li><li><p>Leave <span class="strong"><strong>shootIdle_right</strong></span> clip's threshold at its default value of <code class="literal">1.0</code>.</p></li></ol></div><p>The <code class="literal">HSpeed</code> parameter will be driven by the player's horizontal movement input, which we will need to implement in the character script. In Unity, right is positive on the <span class="emphasis"><em>x</em></span> axis, so we define right as <code class="literal">1.0</code> and left as <code class="literal">-1.0</code>.</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_07_03.jpg" /></div><p>We still need to <a id="id433" class="indexterm"></a>check for the player's input to blend the animation. We will make<a id="id434" class="indexterm"></a> some adjustments<a id="id435" class="indexterm"></a> to our character<a id="id436" class="indexterm"></a> animation script next.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec57"></a>Updating the character script to use the Blend Tree</h3></div></div></div><p>Now that we<a id="id437" class="indexterm"></a> have updated the animator controller, it is necessary to add some code to the script to accommodate the Blend <a id="id438" class="indexterm"></a>Tree:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, navigate to the <code class="literal">PACKT_Scripts</code> folder.</p></li><li><p>Locate <code class="literal">FPSAnimation</code> and double-click on it to open it in MonoDevelop.</p></li><li><p>When the script opens, add the following line of code, following the other variables at the top of the script:</p><div class="informalexample"><pre class="programlisting">var horizontalSpeed : float = 0.0;</pre></div><p>This float value will be determined by the player's input. In turn, this will be used to control the blending in the animator controller. Setting its value to zero at the start will ensure that this does not happen automatically.</p></li><li><p>Within the <code class="literal">Update</code> function add the following lines of code:</p><div class="informalexample"><pre class="programlisting">horizontalSpeed = Input.GetAxis("Horizontal");
thisAnimator.SetFloat("HSpeed",horizontalSpeed);</pre></div><p>As we<a id="id439" class="indexterm"></a> demonstrated previously, the <code class="literal">Update</code> function is checked every frame, so it is the ideal place to check for input.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note30"></a>Note</h3><p>The same<a id="id440" class="indexterm"></a> input axis is used to control the player's movement. This is handled in the <code class="literal">FPSInputController</code> script that is attached to the <code class="literal">FPSController</code> prefab by default.</p></div><p>
<code class="literal">Input.GetAxis</code> returns a value between <code class="literal">-1</code> and <code class="literal">1</code> in float form, based on the left and right movement of the player. By default, the player is moved horizontally with the <span class="emphasis"><em>A</em></span> and <span class="emphasis"><em>D</em></span> keys (also the left and right cursor keys).</p><p>We can simply set our <code class="literal">HSpeed</code> Mecanim parameter using this value.</p><p>Now it is time to save our progress and check the results.</p></li><li><p>Save the script and minimize MonoDevelop.</p></li></ol></div><p>Now that we have set up the float variable and used it to drive a value in the animator controller, we should be able to see a change in the animation states in the game.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec58"></a>Testing the Blend Tree in the Game View</h3></div></div></div><p>Our Blend Tree should now be implemented in the character. We will test it in the game and make any<a id="id441" class="indexterm"></a> necessary adjustments:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Undock the <span class="strong"><strong>Animator</strong></span> panel or rescale it so that its contents are visible while you test the game.</p></li><li><p>Double-click on the <span class="strong"><strong>Idle</strong></span> state to view the Blend Tree contained within it.</p></li><li><p>Click on the <span class="strong"><strong>Game View</strong></span> tab in the top-center of the main view panel, and make sure the <span class="strong"><strong>Maximize on Play</strong></span> button is not active.</p></li><li><p>Press the <span class="strong"><strong>Play</strong></span> button in the top-center of the Unity interface to preview the game.</p></li><li><p>When <span class="emphasis"><em>A</em></span> or <span class="emphasis"><em>D</em></span> or left and right cursor keys are pressed, there should be a noticeable change in the animation:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_07_04.jpg" /></div></li></ol></div><p>Take a look at<a id="id442" class="indexterm"></a> the Blend Tree state in the <span class="strong"><strong>Animator</strong></span> window as you move the player character from side to side. The key input smoothly transitions between the three animated sequences:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_07_05.jpg" /></div><p>In the next example, we will demonstrate how this technique can be used to vary the <code class="literal">Pickup</code> animation<a id="id443" class="indexterm"></a> based on the weight of the object.</p></div></div>