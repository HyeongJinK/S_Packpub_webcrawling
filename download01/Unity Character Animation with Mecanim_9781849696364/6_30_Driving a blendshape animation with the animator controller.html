<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec33"></a>Driving a blendshape animation with the animator controller</h2></div></div><hr /></div><p>The zombie's face animation is a nice touch, to make it clear to the player that something is happening in the<a id="id404" class="indexterm"></a> game. The effect is quite subtle; due to the limited number of face bones that we can retarget in the <span class="strong"><strong>Humanoid</strong></span> rig type, we are not able to get a full range of expression across in the zombie's face.</p><p>One way to get<a id="id405" class="indexterm"></a> around this is to use a different kind of animation. <span class="strong"><strong>Blendshape</strong></span> or <span class="strong"><strong>Morph Target</strong></span> animation types do not <a id="id406" class="indexterm"></a>use bones or joints to deform the model, but use a second, altered version of the mesh. Blendshape animation sequences can be driven in the animator the same way that skeletal animation can.</p><p>Blendshape animation sequences are usually unique to a model. They are created by making a copy of the whole or part of a mesh and then moving, scaling, and rotating vertices to change the shape—creating a facial expression or some other kind of deformation.</p><p>After the blendshape has been linked to the model, it can be exported in the usual way as an FBX file. The FBX exporter has a <span class="strong"><strong>Deformation</strong></span> section with a checkbox for <span class="strong"><strong>Morphs</strong></span> that needs to be checked to export this feature.</p><p>We have a model in the project that has already been set up like this with a blendshape.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec51"></a>Viewing the blendshape in Unity</h3></div></div></div><p>In this section, we<a id="id407" class="indexterm"></a> will look at the model and preview the blendshape:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, select the <code class="literal">FBX_Imports</code> folder to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Locate <code class="literal">zombie_f_blend</code> and click on it to view its <span class="strong"><strong>Import</strong></span> settings in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>In the <span class="strong"><strong>Model</strong></span> tab, verify that the <span class="strong"><strong>Import BlendShapes</strong></span> checkbox is checked.</p><p>This should be checked by default.</p><p>Unlike skeletal animation, blendshapes cannot be previewed in the <span class="strong"><strong>Inspector</strong></span> panel. We need to do this in the scene.</p></li><li><p>Drag<a id="id408" class="indexterm"></a> <code class="literal">zombie_f_blend</code> into the <span class="strong"><strong>Hierarchy</strong></span> panel to instance it in the scene.</p><p>The zombie will instantiate with a blank material. We can add the correct material next.</p></li><li><p>In the <span class="strong"><strong>Project</strong></span> panel, select the <code class="literal">PACKT_Materials</code> folder to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Locate the <code class="literal">zombie_f</code> material and drag this onto the model in the scene view:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_06_07.jpg" /></div><p>Apart from the addition of the blendshape, this character is identical to the model that we have been working with previously. It too has a skeleton that has already been setup to work with Mecanim.</p></li><li><p>In the <span class="strong"><strong>Hierarchy</strong></span> panel, click on the small arrow next to <code class="literal">zombie_f_blend</code>, to expand its hierarchy.</p></li><li><p>Click on the<a id="id409" class="indexterm"></a> <code class="literal">zombie_f</code> child object to select it.</p><p>Its settings will appear in the <span class="strong"><strong>Inspector</strong></span> panel.</p><p>At the top of the <span class="strong"><strong>Skinned Mesh Renderer</strong></span> component, there is an expandable section for blendshapes.</p></li><li><p>Click on the small arrow next to <span class="strong"><strong>BlendShapes</strong></span> to expand its parameters.</p><p>The value for <code class="literal">zombie_f_snarl</code> is set to <code class="literal">0</code> by default.</p></li><li><p>Drag on <code class="literal">zombie_f_snarl</code> to increase the value.</p><p>You should see the zombie's expression change in the <span class="strong"><strong>Scene</strong></span> view.</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_06_08.jpg" /></div><p>The zombie's eyes will close slightly and her face will contract into an expression. There is little movement in the mouth, as this is still going to be handled by the skeletal animation.</p></li><li><p>Return the <code class="literal">zombie_f_snarl</code> blendshape value to <code class="literal">0</code>.</p></li></ol></div><p>Our next step will<a id="id410" class="indexterm"></a> help us get the blendshape into the animator.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec52"></a>Keyframing the face blendshape</h3></div></div></div><p>We have <a id="id411" class="indexterm"></a>got the face blendshape working, but we still need to set up the timing.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Hierarchy</strong></span> panel, click on the <code class="literal">zombie_f_blend</code> parent object to select it.</p></li><li><p>At the top of the <span class="strong"><strong>Inspector</strong></span> panel, you should see that the game object's animator component is currently empty.</p></li><li><p>Open the <span class="strong"><strong>Animation</strong></span> window by navigating to <span class="strong"><strong>Window</strong></span> | <span class="strong"><strong>Animation</strong></span>.</p><p>In the center of the <span class="strong"><strong>Animation</strong></span> window, you will see a prompt to create an animation clip for the currently selected object.</p><p>We need to set up an animation sequence for the blendshape to tie the value to a time line.</p></li><li><p>Click on the <span class="strong"><strong>Create</strong></span> button to create an animation clip.</p><p>Another dialog will appear prompting you to select a name and save the location for the new clip.</p></li><li><p>Name the clip <code class="literal">zombie_f_snarlBlend</code> and save it in the <code class="literal">PACKT_Animations</code> folder.</p><p>The empty timeline will appear in the <span class="strong"><strong>Animation</strong></span> window. The play/pause control in the main Unity interface will be displayed in red to indicate we are in <span class="strong"><strong>Record</strong></span> mode.</p><p>At the moment, our zombie is half-embedded in the floor. Do not worry about this at the moment.</p><p>Before we start creating keyframes in the timeline, we need to specify a property.</p></li><li><p>Click on the <span class="strong"><strong>Add Property</strong></span> button and select <span class="strong"><strong>zombie_f - Skinned Mesh Renderer - BlendShape.zombie_f_snarl</strong></span> from the expandable list.</p></li><li><p>Click on the small <span class="strong"><strong>+</strong></span> symbol next to this line to select the blendshape as the property we<a id="id412" class="indexterm"></a> want to animate.</p><p>The start and end keyframes will be created automatically in the timeline:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_06_09.jpg" /></div><p>The blendshape value is set to <code class="literal">0</code> in both keyframes and the animation is <code class="literal">1</code> second long.</p></li><li><p>Drag the playhead—the red line on the animation timeline, to frame <code class="literal">30</code> and create a new keyframe by clicking on the diamond shaped <span class="strong"><strong>Add Keyframe</strong></span> button.</p></li><li><p>Still in the <span class="strong"><strong>Animation</strong></span> window, increase the horizontal size of the <span class="strong"><strong>Properties</strong></span> list by dragging it to the right, so you can see the full name of the blendshape property and the value <code class="literal">0</code> displayed.</p></li><li><p>Click on the <code class="literal">0</code> to enter the value field and enter the number <code class="literal">100</code>.</p></li><li><p>Click on the <span class="strong"><strong>Play</strong></span> button in the top left of the animation window to play back the resulting animation.</p><p>The zombie will cycle in and out of the blendshape expression.</p><p>The animation has automatically been saved with the name and location that we already specified. At the moment, the clip does not quite sync up with our skeletal animation.</p><p>The snarl skeletal animation is <code class="literal">45</code> frames long. At <code class="literal">30</code> frames a second, this equals one and a half seconds.</p></li><li><p>In the <span class="strong"><strong>Animation</strong></span> window, enter the value <code class="literal">90</code> in the <span class="strong"><strong>Samples</strong></span> field to increase the timeline.</p></li><li><p>Drag the end keyframe to frame <code class="literal">90</code>.</p></li><li><p>Drag the midpoint keyframe—the point where our blendshape is at its maximum value to frame <code class="literal">45</code>.</p></li><li><p>Create <a id="id413" class="indexterm"></a>another keyframe at frame <code class="literal">75</code> and set the blendshape value to <code class="literal">60</code>.</p><p>This will slow down the return to the default facial expression.</p></li><li><p>Click on the <span class="strong"><strong>Curves</strong></span> tab at the bottom of the <span class="strong"><strong>Animation</strong></span> window to see the full curve of the animation:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_06_10.jpg" /></div><p>Next, we will set the animation up in the animator controller so that we can view it with the skeletal animation.</p></li><li><p>Add a character controller component and the <code class="literal">zombie_ready</code> script to the <code class="literal">zombie_f_blend</code> game object.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip10"></a>Tip</h3><p>A quick way to copy components between game objects while retaining parameters is by right-clicking on the source game object's component. Then, choose <span class="strong"><strong>Copy Component</strong></span> from the drop-down list.</p><p>Select the target game object, right-click on the <span class="strong"><strong>Inspector</strong></span> panel and choose <span class="strong"><strong>Paste Component</strong></span> as <span class="strong"><strong>New</strong></span> from the list.</p></div></li><li><p>Add the <code class="literal">ch6_Start</code> animator controller by dragging it into the slot near the top of the <span class="strong"><strong>Inspector</strong></span> panel.</p></li></ol></div><p>In the next step, we will update the animator and add the new blendshape animation.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec53"></a>Updating the animator to handle the blendshape animation</h3></div></div></div><p>When we added the<a id="id414" class="indexterm"></a> snarl skeletal animation, we set up a new layer in the animator. We will do something similar<a id="id415" class="indexterm"></a> for the blendshape animation:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Hierarchy</strong></span> panel, select <code class="literal">zombie_f_blend</code>.</p></li><li><p>In the <span class="strong"><strong>Animator</strong></span> window, click on the <span class="strong"><strong>Layers</strong></span> tab near the top-left corner.</p></li><li><p>Click on the small <span class="strong"><strong>+</strong></span> symbol to create a new layer.</p></li><li><p>Name the new layer <code class="literal">SnarlBlend</code>.</p></li><li><p>Click on the small gear icon next to the layer's name to open its properties.</p></li><li><p>Drag the <span class="strong"><strong>Weight</strong></span> value to <code class="literal">1</code> and set the <span class="strong"><strong>Blending</strong></span> type to <code class="literal">Additive</code>.</p><p>Using <code class="literal">Additive</code> will allow the blendshape to be used with the skeletal face animation.</p></li><li><p>Making sure that the <span class="strong"><strong>SnarlBlend</strong></span> layer is active, create a new state by right-clicking on an empty area of the graph and navigating to <span class="strong"><strong>Choose Create State</strong></span> | <span class="strong"><strong>Empty</strong></span>.</p></li><li><p>Select the new state and rename it <code class="literal">Null</code> in the <span class="strong"><strong>Inspector</strong></span> panel.</p><p>This is the state that will run when we do not want the blendshape to be in effect.</p></li><li><p>Create a second state and rename it <code class="literal">FaceBlend</code>.</p></li><li><p>In the <span class="strong"><strong>Project</strong></span> panel, select the <code class="literal">PACKT_Animations</code> folder to view its contents in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>Locate the <code class="literal">zombie_f_snarlBlend</code> animation clip and drag it into <span class="strong"><strong>FaceBlend</strong></span> state's motion field in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>Create transitions between the two states.</p></li><li><p>Assign <code class="literal">IsSnarling</code> as the condition for the <span class="strong"><strong>Null</strong></span> to <span class="strong"><strong>FaceBlend</strong></span> transition.</p></li><li><p>Leave the condition blank for the return transition, to allow it to just use <code class="literal">Exit Time</code>.</p><p>Our state machine is finished and because we are using an existing parameter, the blendshape will run without any additional code.</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_06_11.jpg" /></div></li><li><p>Preview the composite animation by pressing the <span class="strong"><strong>Play</strong></span> button in the main Unity interface.</p></li><li><p>Walk<a id="id416" class="indexterm"></a> close to the female zombie character before pressing the fire button:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_06_12.jpg" /></div></li></ol></div><p>If you completed these steps, the zombie will become alerted, snarl at the player, and walk toward the<a id="id417" class="indexterm"></a> first-person controller.</p><p>At this stage, the zombie does not hurt the player when she reaches them. The zombie's actual attack is covered in depth in <a class="link" href="#" linkend="ch09">Chapter 9</a>, <span class="emphasis"><em>Controlling Enemy Animation with AI and Triggers</em></span>.</p></div></div>