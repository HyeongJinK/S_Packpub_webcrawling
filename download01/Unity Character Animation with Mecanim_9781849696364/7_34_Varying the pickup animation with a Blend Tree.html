<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec36"></a>Varying the pickup animation with a Blend Tree</h2></div></div><hr /></div><p>Back in <a class="link" href="#" linkend="ch03">Chapter 3</a>, <span class="emphasis"><em>Interacting with the Environment</em></span>, we created character interaction with the environment by allowing the player character to pick up objects. A single animation sequence <a id="id444" class="indexterm"></a>was used for this.</p><p>In the game, the<a id="id445" class="indexterm"></a> character will need to pick up collectables of various sizes and weights. In order to visualize this variation in the game, we will be demonstrating a different use of Blend Trees.</p><p>In order to use a Blend Tree, a minimum of two motion clips is necessary. We supplemented the original pickup motion with another pickup animation to suit a heavier object.</p><p>Next, we will take a look at the differences between the two animation clips.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec59"></a>Viewing the pickup_heavy animation sequence</h3></div></div></div><p>Once again, we <a id="id446" class="indexterm"></a>will make use of the <code class="literal">zombie_m</code> character to preview the whole animation:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, click on the <code class="literal">PACKT_Animations</code> folder.</p></li><li><p>Locate the <code class="literal">pickups</code> asset.</p></li><li><p>Click on it to view its import settings in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li></ol></div><p>The two animation clips contained in this FBX file have already been set up. The FBX file does not contain a model, so we will need another rigged model to preview the animation:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, click on the <code class="literal">PACKT_Prefabs</code> folder.</p></li><li><p>Drag the <code class="literal">zombie_m</code> prefab from the <span class="strong"><strong>Assets</strong></span> panel into the animation preview panel at the bottom of the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>Take a look at the two motion clips to compare them:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_07_06.jpg" /></div></li></ol></div><p>The illustration compares the contact point in both animation sequences. The left panel shows the original pickup animation and the right panel shows the heavier variation.</p><p>We can see some<a id="id447" class="indexterm"></a> subtle differences in the pose, with the character's hips placed lower and feet spread further apart. In the context of the animation, this lower pose will convey more weight in the character's lift.</p><p>Note that the sequences are the same length.</p><p>Here we are only making minor changes that will blend together in the Blend Tree. If we wanted anything as extreme as a two-handed lift, it would be best to set this up in its own state.</p><p>The next stage will involve setting up the two animation sequences in a Blend Tree.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec60"></a>Creating a Blend Tree in the Pickup state</h3></div></div></div><p>We will return to the animator controller to set up the Blend Tree for the pickup:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <a id="id448" class="indexterm"></a><span class="strong"><strong>Animator</strong></span> window, right-click on the <span class="strong"><strong>Pickup</strong></span> state <a id="id449" class="indexterm"></a>and select <span class="strong"><strong>Create New Blend Tree</strong></span> in <span class="strong"><strong>State</strong></span>.</p></li><li><p>Double-click on the <span class="strong"><strong>Pickup</strong></span> state to open the Blend Tree properties in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>In the <span class="strong"><strong>Inspector</strong></span> panel, rename the Blend Tree <code class="literal">Pickup_Blend_Tree</code>.</p></li><li><p>Click on the <span class="strong"><strong>+</strong></span> symbol and select <span class="strong"><strong>Add Motion Field</strong></span>.</p></li><li><p>Repeat this process to add a second motion field.</p></li><li><p>In the <span class="strong"><strong>Project</strong></span> panel, navigate to the <code class="literal">PACKT_Animations</code> folder and locate the <code class="literal">Pickups</code> subfolder.</p></li><li><p>Click to expand <code class="literal">Pickups</code> and drag the pickup motion (indicated by the gray play button) into the first motion field in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>Drag the <code class="literal">pickup_heavy</code> motion into the second motion field.</p></li></ol></div><p>Now that we have added our motion clips, we can define the transition between them. We do this by first setting a parameter.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl3sec63"></a>Setting the pickup Blend Tree parameter</h4></div></div></div><p>Defining the<a id="id450" class="indexterm"></a> blend requires a parameter which will tell the state machine when one motion sequence should stop and the other should <a id="id451" class="indexterm"></a>start:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Locate the <span class="strong"><strong>Parameters</strong></span> box in the lower-left of the <span class="strong"><strong>Animator</strong></span> panel.</p></li><li><p>Click on the <span class="strong"><strong>+</strong></span> symbol to create a new parameter.</p></li><li><p>Set the type to <span class="strong"><strong>Float</strong></span>.</p></li><li><p>Rename the parameter <code class="literal">Weighting</code>.</p></li><li><p>Back in the <span class="strong"><strong>Inspector</strong></span> panel, set the Blend Tree parameter to <code class="literal">Weighting</code>.</p></li></ol></div><p>We are going to use the weight of the object (which will be contained in a variable) to determine the proportion of blend between the light pickup animation and the heavy pickup animation.</p><p>In theory, the value that is used to blend between the two clips can be anything we want, but we will do our best to use real-world values.</p><p>Unity uses <span class="strong"><strong>kilos</strong></span> for its physics simulations, so we will try to stay consistent with this for our object weight values.</p><p>Let's assume that the original pickup animation will be used for anything up to 1 kilo (just over 2 pounds in imperial weight). This would cover light items such as food collectables and small amounts of ammunition.</p><p>When an object's weight exceeds 1 kilo, we start blending in the heavy pickup animation.</p><p>To allow the pickup Blend Tree to process this, we will set the blending threshold.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl3sec64"></a>Setting the threshold for the pickup Blend Tree</h4></div></div></div><p>We will continue<a id="id452" class="indexterm"></a> adjusting the <code class="literal">Pickup_Blend_Tree</code> tree's parameters in the <span class="strong"><strong>Inspector</strong></span> panel:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Uncheck the <span class="strong"><strong>Automate Thresholds</strong></span> checkbox.</p></li><li><p>For the <code class="literal">pickup</code> clip, set the threshold to <code class="literal">1.0</code>.</p></li><li><p>Set the threshold for <code class="literal">pickup_heavy</code> to <code class="literal">4.0</code>.</p></li></ol></div><p>These values will ensure that the original pickup animation is used for everything up to <code class="literal">Weighting</code> value of <code class="literal">1.0</code>.</p><p>Once <code class="literal">Weighting</code> exceeds this value, the <code class="literal">pickup_heavy</code> clip is gradually blended in until it reaches a value of <code class="literal">4.0</code>. At this point, it is purely the <code class="literal">pickup_heavy</code> animation which is being played:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_07_07.jpg" /></div><p>The next stage<a id="id453" class="indexterm"></a> will involve storing the value of <code class="literal">object</code> in the character animation script.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec61"></a>Editing the character animation script to accommodate the pickup Blend Tree</h3></div></div></div><p>Now that we<a id="id454" class="indexterm"></a> have updated our animator controller, we will need to make a few changes to the character animation script to accommodate the additions:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, navigate to the <code class="literal">PACKT_Scripts</code> folder.</p></li><li><p>Click on it once, to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Locate <code class="literal">FPSAnimation</code> and double-click on it to open it in MonoDevelop.</p></li><li><p>At the top of the script, beneath the other variables add the following line of code:</p><div class="informalexample"><pre class="programlisting">var itemWeight : float;</pre></div><p>As our blending parameter is a float, we set up the same kind of variable within the script. This will make transferring the values very simple.</p><p>Next, we will define the relationship between this variable and our animator controller.</p></li><li><p>Near the top of the <code class="literal">Pick</code> function, after the first statement, add the following code:</p><div class="informalexample"><pre class="programlisting">    itemWeight = objectWeight;
    thisAnimator.SetFloat("Weighting", objectWeight);</pre></div><p>Here we tie together the animator parameter, <code class="literal">Weighting</code> with the script's variable <code class="literal">objectWeight</code>. </p></li><li><p>Save the script.</p></li><li><p>Minimize MonoDevelop.</p></li></ol></div><p>At this point, if <a id="id455" class="indexterm"></a>we test the game, the <code class="literal">pickup_heavy</code> animation will never be used, as there is nothing to tell the character animation script to set the <code class="literal">objectWeight</code> variable to a value higher than <code class="literal">1.0</code>.</p><p>Including this as a variable in the <code class="literal">collectable</code> script will make the value easy to adjust on individual collectable items.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec62"></a>Updating the Collectable script to include a weight variable</h3></div></div></div><p>We will start where <a id="id456" class="indexterm"></a>we left off in <a class="link" href="#" linkend="ch03">Chapter 3</a>, <span class="emphasis"><em>Interacting with the Environment</em></span>, with our <code class="literal">lunchBox</code> collectable prefab:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> <a id="id457" class="indexterm"></a>panel, click on the <code class="literal">PACKT_Prefabs</code> folder to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Locate the <code class="literal">lunchBox</code> prefab and drag it into the <span class="strong"><strong>Hierarchy</strong></span> panel to instance it in the scene.</p></li><li><p>Use the <span class="strong"><strong>Move</strong></span> tool to position the instanced <code class="literal">lunchBox</code> prefab somewhere in front of the player game object.</p></li><li><p>In the <span class="strong"><strong>Inspector</strong></span> panel, click on the <code class="literal">Collectable</code> script, inside the <span class="strong"><strong>Collectable</strong></span> component.</p><p>The script will become highlighted in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Double-click on the <code class="literal">Collectable</code> script in the <span class="strong"><strong>Assets</strong></span> panel to open it in MonoDevelop.</p></li><li><p>Near the top of the script and after the other variables, add the following line of code:</p><div class="informalexample"><pre class="programlisting">var objectWeight = 0.25;</pre></div></li></ol></div><p>We create a float variable with the default value of <code class="literal">1.0</code> kilos (just over a half pound in imperial weight). This value seems realistic for this type of collectable.</p><p>As an exposed variable, the <a id="id458" class="indexterm"></a>value of <code class="literal">objectWeight</code> will be visible and can be adjusted in the <span class="strong"><strong>Inspector</strong></span> panel.</p><p>Our <code class="literal">Collectable</code> script does<a id="id459" class="indexterm"></a> not yet pass its <code class="literal">objectWeight</code> value to the player animation script, so we will deal with that next.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec63"></a>Sending the objectWeight variable</h3></div></div></div><p>The <code class="literal">Collectable</code> script <a id="id460" class="indexterm"></a>already accesses the player animation script in order to tell it to set the <span class="strong"><strong>Picking Boolean</strong></span> to <code class="literal">true</code>, which in turn causes<a id="id461" class="indexterm"></a> the <span class="strong"><strong>Pickup</strong></span> state to run.</p><p>All we have to do is have it send the <code class="literal">objectWeight</code> value to this script:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In MonoDevelop, make sure that the <code class="literal">Collectable</code> script is active in the editing window.</p></li><li><p>Scroll down until you can see all of the <code class="literal">OnTriggerEnter</code> function.</p></li><li><p>Locate the following statement:</p><div class="informalexample"><pre class="programlisting">playerAnim.Pick();</pre></div></li><li><p>Within the brackets, type the name of the variable that we have just added to the script.</p></li></ol></div><p>The completed line of code should be:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>playerAnim.Pick(objectWeight);</strong></span>
</pre></div><p>As the <code class="literal">Collectable</code> script already triggers the players <code class="literal">Pick</code> function, we have merely added the variable. Passing variables to functions in this way is often done when applying damage. Sending a weight value is much the same.</p><p>The last step is to modify the <code class="literal">Pick</code> statement inside the character animation script in order to recognize the variable that is being sent to it.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec64"></a>Updating the Pick function in the character animation script</h3></div></div></div><p>In <a class="link" href="#" linkend="ch03">Chapter 3</a>, <span class="emphasis"><em>Interacting with the Environment</em></span>, we<a id="id462" class="indexterm"></a> created the<a id="id463" class="indexterm"></a> <code class="literal">Pick</code> function in the character animation script to enable the pickup animation to be played when the character comes in range of the collectable and presses a designated button.</p><p>Now that we included the <code class="literal">objectWeight</code> variable, we need to add this to the function to use the weight and blend the two motion clips accordingly:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In MonoDevelop, select <code class="literal">FPSAnimation</code>.</p></li><li><p>Scroll down until the <code class="literal">Pick</code> function is visible.</p></li><li><p>Within the title brackets of the <code class="literal">Pick</code> function, add the following code:</p><div class="informalexample"><pre class="programlisting">objectWeight : float</pre></div><p>The completed function should look like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>function Pick(objectWeight : float)</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>    thisAnimator.SetTrigger("Picking");</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div></li><li><p>Save the script.</p></li></ol></div><p>Next, we will add a few more items to the scene so we can test the Blend Tree.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec65"></a>Testing the blended animation in the game</h3></div></div></div><p>To check whether the<a id="id464" class="indexterm"></a> blended animation works correctly, we will instance three different collectable items into our scene. We will use the <code class="literal">lunchBox</code> collectable<a id="id465" class="indexterm"></a> that we worked with in <a class="link" href="#" linkend="ch03">Chapter 3</a>, <span class="emphasis"><em>Interacting with the Environment</em></span>, along with two heavier collectables—a first aid kit and a toolbox.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl3sec65"></a>Instancing the collectable prefabs</h4></div></div></div><p>The prefabs have <a id="id466" class="indexterm"></a>already been set up, ready to be instanced in the game:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Navigate to the <code class="literal">PACKT_Prefabs</code> folder and locate the <code class="literal">lunchBox</code>, <code class="literal">firstAidKit</code>, and <code class="literal">toolBox</code> prefabs.</p></li><li><p>Create instances of all three prefabs by dragging them from the <span class="strong"><strong>Assets</strong></span> panel into the <span class="strong"><strong>Hierarchy</strong></span> panel.</p></li><li><p>In the <span class="strong"><strong>Scene</strong></span> view, move the collectable prefab objects so they are placed on the floor and located around 2 meters from each other. Arrange the objects in the order of weight, with the <code class="literal">lunchBox</code> collectible first, then <code class="literal">firstAidKit</code>, and lastly <code class="literal">toolBox</code>.</p><p>We need to hook up the variables.</p></li><li><p>Select all three collectables in the <span class="strong"><strong>Hierarchy</strong></span> panel.</p></li><li><p>Drag the <code class="literal">player_m</code> game object from the <span class="strong"><strong>Hierarchy</strong></span> panel into the <span class="strong"><strong>Player Obj</strong></span> slot in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>Drag the <code class="literal">FirstPersonCharacter</code> game object into the <span class="strong"><strong>Player Camera</strong></span> slot.</p></li><li><p>Expand the <code class="literal">FPSController</code> game object's hierarchy if necessary and drag the <code class="literal">zombie_m_Head</code> game object into the <span class="strong"><strong>Head Bone</strong></span> slot.</p></li><li><p>Select the<a id="id467" class="indexterm"></a> <code class="literal">firstAidBox</code> game object and set its <code class="literal">Object Weight</code> variable to <code class="literal">2.5</code> in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>Select the <code class="literal">toolBox</code> game object and set its <code class="literal">Object Weight</code> to <code class="literal">4</code>.</p></li></ol></div><p>The collectable prefabs each have a trigger and a variable assigned for the weight, which will be interpreted by the character animation script that we just edited:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_07_08.jpg" /></div><p>Now that we have set up the Blend Tree, character animation script, and added the collectable prefabs to<a id="id468" class="indexterm"></a> the game, we can preview the animation.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl3sec66"></a>Previewing the blended animation</h4></div></div></div><p>To make sure that <a id="id469" class="indexterm"></a>our Blend Tree is working correctly, we will need to view the animator panel when we are previewing the game:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Drag the <span class="strong"><strong>Animator</strong></span> tab to the space beside the <span class="strong"><strong>Game</strong></span> view panel and scale it so that the Blend Tree is clearly visible.</p></li><li><p>Press the <span class="strong"><strong>Play</strong></span> button in the top-center of the Unity interface.</p></li><li><p>Using the <span class="emphasis"><em>W</em></span>, <span class="emphasis"><em>A</em></span>, <span class="emphasis"><em>S</em></span>, <span class="emphasis"><em>D</em></span>, or cursor keys, move the player to the first of the three instanced prefabs.</p></li><li><p>When he has picked up the <code class="literal">lunchBox</code> collectible, move on to the next collectable.</p></li></ol></div><p>Watch the animation in the game view, there should be a noticeable variation in the character's movement to suggest a difference in the weight of the objects.</p><p>This variation should also be evident in the Blend Tree display in the <span class="strong"><strong>Animator</strong></span> panel.</p><p>When the player <a id="id470" class="indexterm"></a>character is picking up the <code class="literal">lunchBox</code> collectible, the <code class="literal">pickup_light</code> blend field is active. When picking up the <code class="literal">toolBox</code> collectible, the <code class="literal">pickup_heavy</code> blend field is active, and when picking up <code class="literal">firstAidKit</code>, the Blend Tree mixes between the two blend fields:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_07_09.jpg" /></div></div></div></div>