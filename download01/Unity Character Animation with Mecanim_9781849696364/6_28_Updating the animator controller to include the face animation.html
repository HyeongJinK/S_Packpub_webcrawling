<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec31"></a>Updating the animator controller to include the face animation</h2></div></div><hr /></div><p>In the previous chapter, we <a id="id372" class="indexterm"></a>created masks for various parts of the body to add variation to our stock animation sequences. The animator controller connected to the zombie in our current scene is set up the same way, there are just a few changes that need to be made:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Click on the <code class="literal">zombie_f</code> game object in the <span class="strong"><strong>Hierarchy</strong></span> panel to select it.</p></li><li><p>Click on the <span class="strong"><strong>Animator</strong></span> tab in the top center of the Unity interface to switch to the <span class="strong"><strong>Animator</strong></span> panel.</p></li><li><p>In the top left of the <span class="strong"><strong>Animator</strong></span> panel, click on the <span class="strong"><strong>Layers</strong></span> tab to activate it.</p></li></ol></div><p>The zombie's animator controller consists of a base layer containing two states: <span class="strong"><strong>Idle</strong></span> and <span class="strong"><strong>Walk</strong></span>. We need to create a new layer for the face animation:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the top left of the <span class="strong"><strong>Animator</strong></span> panel, click on the <span class="strong"><strong>+</strong></span> symbol in the <span class="strong"><strong>Layers</strong></span> tab to create a new layer.</p></li><li><p>Rename the layer <code class="literal">Face</code>.</p></li><li><p>Set the layer's <span class="strong"><strong>Weight</strong></span> field to <code class="literal">1</code>.</p></li><li><p>In the<a id="id373" class="indexterm"></a> new <span class="strong"><strong>Face</strong></span> layer, click on the radio button next to the <span class="strong"><strong>Mask</strong></span> field and select <code class="literal">z_Head</code> from the list.</p></li><li><p>Leave the <span class="strong"><strong>Blending</strong></span> type set to its default value of <code class="literal">Override</code>.</p></li></ol></div><p>Refer to the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_06_02.jpg" /></div><p>Next, we need to create a new state to contain our snarl animation.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec45"></a>Adding the Snarl state</h3></div></div></div><p>We have set up<a id="id374" class="indexterm"></a> states manually in previous chapters, but if you know exactly which animation you want a state to use, you can also just drag the motion clip into the <span class="strong"><strong>Animator</strong></span> panel:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, select the <code class="literal">PACKT_Animations</code> folder.</p></li><li><p>When its contents appear in the <span class="strong"><strong>Assets</strong></span> panel, scroll down to locate <code class="literal">zombie_snarl</code>.</p></li><li><p>Click on the small arrow next to its name to view the contained assets.</p></li><li><p>Drag the animation file named <code class="literal">snarl</code> into an empty area of the <span class="strong"><strong>Animator</strong></span> panel.</p><p>A new state will be created with the same name as the motion clip that it contains.</p></li><li><p>In the <span class="strong"><strong>Inspector</strong></span> panel, capitalize the first letter of the state's name to keep it consistent with the other states on the animator controller's base layer.</p></li></ol></div><p>Unless we <a id="id375" class="indexterm"></a>want the <span class="strong"><strong>Snarl</strong></span> state to be constantly active, we will need to set up a <span class="strong"><strong>Null</strong></span> state in the same layer.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec46"></a>Creating a Null state</h3></div></div></div><p>As the <span class="strong"><strong>Face</strong></span> layer is <a id="id376" class="indexterm"></a>constantly active, we need to create a blank state that will be in effect whenever we do not want to see the zombie's snarl:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Right-click on a blank area of the <span class="strong"><strong>Animator</strong></span> panel.</p></li><li><p>Navigate to <span class="strong"><strong>Create State</strong></span> | <span class="strong"><strong>Empty</strong></span>.</p></li><li><p>In the <span class="strong"><strong>Inspector</strong></span> panel, rename the state <code class="literal">Null</code>.</p><p>Leaving the state's motion field empty will ensure that the base layer's current motion clip will be fully visible.</p><p>Because we created the <span class="strong"><strong>Snarl</strong></span> layer first, it is automatically the default layer and will run without being prompted. We can fix this by making <span class="strong"><strong>Null</strong></span> the default state.</p></li><li><p>Right-click on <span class="strong"><strong>Null</strong></span> in the <span class="strong"><strong>Animator</strong></span> window.</p></li><li><p>Choose <span class="strong"><strong>Set As Layer Default State</strong></span> from the list.</p></li></ol></div><p>The <span class="strong"><strong>Null</strong></span> state will turn orange, indicating that it is now the default:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_06_03.jpg" /></div><p>Next, we need to <a id="id377" class="indexterm"></a>connect the layer's two states with transitions.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec47"></a>Setting transitions between the Null and Snarl states</h3></div></div></div><p>In real-world terms, we<a id="id378" class="indexterm"></a> want the snarl to happen regardless of whether the zombie is idling, walking, or lying on the ground. Having created the two states, we connect them with <span class="strong"><strong>to</strong></span> and <span class="strong"><strong>return</strong></span><a id="id379" class="indexterm"></a> transitions:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a transition by right-clicking on <span class="strong"><strong>Null</strong></span> and choosing <span class="strong"><strong>Make Transition</strong></span>.</p></li><li><p>Click on the <span class="strong"><strong>Snarl</strong></span> state to terminate the transition.</p></li><li><p>Use the same process to create the <span class="strong"><strong>return</strong></span> transition from <span class="strong"><strong>Snarl</strong></span> to <span class="strong"><strong>Null</strong></span>.</p></li></ol></div><p>Next, we will create a parameter for the <span class="strong"><strong>Snarl</strong></span> state that will allow it to run.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec57"></a>Creating the IsSnarling parameter</h4></div></div></div><p>The parameter<a id="id380" class="indexterm"></a> required by the transition will be set within our <code class="literal">zombie_ready</code> script:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Click on the <span class="strong"><strong>+</strong></span> symbol in the<a id="id381" class="indexterm"></a> <span class="strong"><strong>Parameters</strong></span> box in the lower left of the <span class="strong"><strong>Animator</strong></span> panel.</p></li><li><p>Choose a <span class="strong"><strong>Trigger</strong></span> type parameter and rename it <code class="literal">IsSnarling</code>.</p></li><li><p>Leave the new parameter's radio button in its deactivated state, so the snarl animation does not override the original head animation by default.</p></li><li><p>Click on the transition to select it.</p></li><li><p>In the <span class="strong"><strong>Inspector</strong></span> panel, locate the <span class="strong"><strong>Conditions</strong></span> box and click on the drop down.</p></li><li><p>Choose <code class="literal">IsSnarling</code> as the condition.</p></li></ol></div><p>We can leave the return transition with its default settings. The <code class="literal">Exit Time</code> condition will wait for the snarling motion to play through before returning to the <span class="strong"><strong>Null</strong></span> state.</p><p>At this point, we will want to make a few small edits to our script to make sure that the <span class="strong"><strong>Face</strong></span> layer works correctly.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec58"></a>Editing the script to include the Face layer</h4></div></div></div><p>Next, we will make<a id="id382" class="indexterm"></a> some additions to the existing functions to make sure that the <span class="strong"><strong>Face</strong></span> layer becomes active during gameplay:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Edit the <code class="literal">TurnToPlayer</code> function to set the <code class="literal">IsSnarling</code> trigger:</p><div class="informalexample"><pre class="programlisting">function TurnToPlayer()
{
    transform.LookAt(target);
    yield WaitForSeconds(2);
    if(soundReady)
    {
        theAnimator.SetTrigger("IsSnarling");
    GetComponent.&lt;AudioSource&gt;().PlayOneShot(snarlSound);
        soundReady = false;
    }
    Walks();
}</pre></div><p>Here, we tie the <code class="literal">IsSnarling</code> Mecanim trigger to the <code class="literal">soundReady</code> boolean that already exists within this script.</p><p>The <code class="literal">soundReady</code> variable is set up to only be active once, so this is a great way to ensure that our animation only plays one time as well.</p></li><li><p>Save the script.</p></li><li><p>Preview<a id="id383" class="indexterm"></a> the game by pressing the <span class="strong"><strong>Play</strong></span> button in the top center of the Unity interface.</p></li><li><p>Move the <code class="literal">FPSController</code> game object close to the female zombie.</p></li><li><p>Click on the left mouse button to switch the zombie's behavior.</p></li></ol></div><p>The female zombie should turn toward the player and the snarl animation will play:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_06_04.jpg" /></div><p>Next, we will make some further improvements to the zombie's behavior by smoothing its rotation.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec59"></a>Smoothing the zombie's turn rotation</h4></div></div></div><p>The zombie is <a id="id384" class="indexterm"></a>currently set up to turn to face the player once they have been alerted. The script uses the<a id="id385" class="indexterm"></a> <code class="literal">transform.LookAt</code> method, which has an instantaneous effect. We need to adjust the script so that the zombie gradually and naturalistically turns:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Back in MonoDevelop, add the following variables near the top of the <code class="literal">zombie_ready</code> script:</p><div class="informalexample"><pre class="programlisting">var turnSpeed : float = 60.0;
var turning : boolean = false;
var angle : float;</pre></div><p>Here we are defining <code class="literal">turnSpeed</code>, which is the rate of the zombie's turn. The boolean variable <code class="literal">turning</code> will be used to play a turning animation while she rotates.</p><p>Lastly, the variable <code class="literal">angle</code> is used to determine the amount of rotation that the zombie needs to execute.</p></li><li><p>Scroll down to the <code class="literal">TurnToPlayer</code> function.</p></li><li><p>Replace the function's entire content with the following code:</p><div class="informalexample"><pre class="programlisting">var localRotate = transform.InverseTransformPoint(target.position);
angle = Mathf.Atan2 (localRotate.x, localRotate.z) * Mathf.Rad2Deg;
var maxRotation = turnSpeed * Time.deltaTime;
var turnAngle = Mathf.Clamp(angle, -maxRotation, maxRotation);
transform.Rotate(0, turnAngle, 0);
return angle;</pre></div><p>The first line of the function calculates the relative angle difference between the zombie game object's <code class="literal">transform</code> and the target's position, storing this as a local <code class="literal">Vector3</code> variable called <code class="literal">localRotate</code>.</p><p>The variable <code class="literal">angle</code>, defined at the top of the script is defined as the sum of <code class="literal">Mathf.Atan2</code>, which is a calculation along the same lines as <code class="literal">transform.LookAt</code>.</p><p>The next line defines a local variable named <code class="literal">maxRotation</code>, which is equal to <code class="literal">turnSpeed</code> multiplied by <code class="literal">Time.deltaTime</code>. The <code class="literal">deltaTime</code> object is time in seconds rather than elapsed frames.</p><p>A third local variable, called <code class="literal">turnAngle</code>, clamps the <code class="literal">angle</code> variable, keeping it within the value of <code class="literal">maxRotation</code> so that the zombie does not rotate faster than <code class="literal">turnSpeed</code>.</p><p>The next line of code actually rotates the zombie's <code class="literal">transform</code> by the value defined by <code class="literal">turnAngle</code>. The rotation only happens on the <span class="emphasis"><em>y</em></span> axis. The <code class="literal">Rotate</code> values of <span class="strong"><strong>X</strong></span> and <span class="strong"><strong>Z</strong></span> are set to <code class="literal">0</code>.</p><p>Finally, the variable <code class="literal">angle</code> is returned, allowing us to use it elsewhere in the script.</p></li><li><p>Save the script.</p></li><li><p>Preview the result by pressing the <span class="strong"><strong>Play</strong></span> button.</p></li></ol></div><p>When the <span class="strong"><strong>Fire1</strong></span> button is pressed, the zombie will now rotate smoothly toward the player before walking<a id="id386" class="indexterm"></a> toward him.</p><p>At the moment, the <code class="literal">Snarl</code> animation will not play, nor does the audio, because we deleted the code when we updated the <code class="literal">TurnToPlayer</code> function.</p><p>Before we add this back in, we will add some animation for the zombie's turn.</p></div></div></div>