<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec32"></a>Implementing the turn animation</h2></div></div><hr /></div><p>In this case, there is<a id="id387" class="indexterm"></a> a single animation sequence that will be played when the zombie is turning to the right or left.</p><p>The FBX file containing the animation has already been imported. The next step is to add the resulting motion clip to the animator controller in its own state.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec48"></a>Adding the turning state</h3></div></div></div><p>The turn<a id="id388" class="indexterm"></a> animation is a single looping sequence used for a left or right turn:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Make sure that the <span class="strong"><strong>Animator</strong></span> panel is visible and the base layer is active.</p></li><li><p>In the <span class="strong"><strong>Project</strong></span> panel, locate the <code class="literal">PACKT_Animations</code> folder and click on it once to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Locate the <code class="literal">zombie_turn</code> asset and expand its hierarchy by clicking on the arrow next to its name.</p></li><li><p>Drag the <code class="literal">zombie_turn</code> animation into a blank area of the <span class="strong"><strong>Animator</strong></span> panel to create a new state containing the clip.</p></li><li><p>In the<a id="id389" class="indexterm"></a> <span class="strong"><strong>Inspector</strong></span> panel, rename the state <code class="literal">Turn</code>:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_06_05.jpg" /></div></li></ol></div><p>Next, we will set up an appropriate parameter and create transitions to and from our existing states.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec49"></a>Setting up the IsTurning parameter</h3></div></div></div><p>We <a id="id390" class="indexterm"></a>want the <code class="literal">zombie_turn01</code> animation to play only when the zombie is turning toward the player, so we can use a boolean parameter<a id="id391" class="indexterm"></a> which can be easily switched on and off in the script:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Parameters</strong></span> box, click on the <code class="literal">+</code> symbol to create a new parameter and choose <code class="literal">Bool</code> as the type.</p></li><li><p>Rename the parameter <code class="literal">IsTurning</code> and leave it unchecked.</p></li></ol></div><p>We will use this parameter as a condition to allow us to transition to the <code class="literal">Turn</code> state.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec60"></a>Creating the transitions to connect the turning state</h4></div></div></div><p>The transitions will <a id="id392" class="indexterm"></a>connect <span class="strong"><strong>Turn</strong></span> to our existing states using the <code class="literal">IsTurning</code> parameter as the condition:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Right-click on the <span class="strong"><strong>Idle</strong></span> state.</p></li><li><p>Choose <span class="strong"><strong>Make Transition</strong></span> and click on the <span class="strong"><strong>Turn</strong></span> state to complete the transition.</p></li><li><p>Create the return transition by right-clicking on <span class="strong"><strong>Turn</strong></span> and then clicking on <span class="strong"><strong>Idle</strong></span> to specify it as the end state.</p></li></ol></div><p>The last step will complete our turn state in the animator controller.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec50"></a>Setting the transitions for the Turn state</h3></div></div></div><p>The transitions that <a id="id393" class="indexterm"></a>we have just set up require <span class="strong"><strong>Conditions</strong></span> to enable the state change:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Click on the transition connecting <span class="strong"><strong>Idle</strong></span> to <span class="strong"><strong>Turn</strong></span> to view its properties in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>In the <span class="strong"><strong>Conditions</strong></span> box, set the parameter to <code class="literal">IsTurning</code> by selecting it from the drop-down list.</p></li><li><p>Make sure that the conditional is set to <code class="literal">true</code>.</p></li><li><p>For the return transition, choose the <code class="literal">IsTurning</code> parameter once again, but this time, set its conditional to <code class="literal">False</code>.</p></li><li><p>Repeat this process for both of the transitions linking <span class="strong"><strong>Turn</strong></span> to <span class="strong"><strong>Walk</strong></span> state.</p></li><li><p>Add an extra condition for the return transition to <span class="strong"><strong>Walk</strong></span> specifying <code class="literal">IsWalking</code> as the parameter and <code class="literal">True</code> as the conditional.</p></li><li><p>Add a condition for the <span class="strong"><strong>Walk</strong></span> to <span class="strong"><strong>Turn</strong></span> transition, choosing <code class="literal">IsWalking</code> as the parameter and <code class="literal">false</code> as the conditional.</p></li></ol></div><p>This will ensure that the zombie is not trying to walk and turn at the same time.</p><p>Next, we will return to MonoDevelop to update our script to accommodate the state.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec61"></a>Updating the zombie_ready script to accommodate the Turn state</h4></div></div></div><p>The script currently <a id="id394" class="indexterm"></a>allows the zombie to rotate smoothly toward the player when he is targeted, but switching the animation states appropriately necessitates just a little more code:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>If it is not already open, double-click on <code class="literal">zombie_ready</code> in the <span class="strong"><strong>Assets</strong></span> panel to initialize it in MonoDevelop.</p></li><li><p>At the top of the <code class="literal">Update</code> function, add the following line of code:</p><div class="informalexample"><pre class="programlisting">theAnimator.SetBool("IsTurning", turning);</pre></div><p>This ties our Mecanim Bool parameter <code class="literal">IsTurning</code> to the boolean variable <code class="literal">turning</code> that we just added.</p><p>When we updated this script previously, we made the <code class="literal">TurnToPlayer</code> function return a variable named <code class="literal">angle</code> that is stored as a public variable in the script.</p><p>We will make use of this variable to get our turn animation playing.</p></li><li><p>In MonoDevelop, locate the second <code class="literal">if</code> statement in the <code class="literal">Update</code> function.</p><p>It should currently look like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>if(alerted)</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>    TurnToPlayer();</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div><p>As soon as the zombie is alerted (by the <span class="strong"><strong>Fire1</strong></span> button), the <code class="literal">TurnToPlayer</code> function is run.</p></li><li><p>Add the following code inside the <code class="literal">if(alerted)</code> statement:</p><div class="informalexample"><pre class="programlisting">if(angle &gt; 5 ||angle &lt; -5)
{
    turning = true;
}</pre></div><p>This further nested <code class="literal">if</code> statement checks whether the angle variable is greater than <code class="literal">5</code> or less than <code class="literal">-5</code>. When one of these conditions is met, then we will allow the turning animation to play.</p><p>With less of an angle, the rotation time would be too short resulting in a jumpy and incomplete animated transition.</p><p>We can define what happens in this case in the next statement.</p></li><li><p>Add the following code within the <code class="literal">if</code> statement:</p><div class="informalexample"><pre class="programlisting">else if(angle &lt; 5 &amp;&amp; angle &gt; -5)
{
    if(soundReady)
    {
        Snarl();
    }
}</pre></div><p>If <code class="literal">angle</code> is sufficiently low, we check to see if the <code class="literal">soundReady</code> variable is <code class="literal">true</code>. This boolean is a one shot deal, it never gets reset to <code class="literal">true</code>, ensuring that our zombie will only snarl once, when it is first alerted by the player.</p><p>The snarl animation and sound will be taken care of in the <code class="literal">Snarl</code> function a<a id="id395" class="indexterm"></a> little later on.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note29"></a>Note</h3><p>Containing pieces of behavior in their own functions like this makes it possible to trigger them with external events. We will cover some examples of this in <a class="link" href="#" linkend="ch09">Chapter 9</a>, <span class="emphasis"><em>Controlling Enemy Animation with AI and Triggers</em></span>.</p></div><p>So, what happens if the snarl animation has already been played? It seems natural for the zombie to move toward the player to attack.</p></li><li><p>Add the following code directly beneath the <code class="literal">else if</code> statement:</p><div class="informalexample"><pre class="programlisting">else
{
    turning = false;
    WalkTowards();
}</pre></div><p>The <code class="literal">else</code> statement directly follows an <code class="literal">if</code> statement and acts as a catch all.</p><p>The finished <code class="literal">Update</code> function should look like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>function Update()</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>    theAnimator.SetBool("IsTurning", turning);</strong></span>
<span class="strong"><strong>    if(Input.GetButton("Fire1") &amp;&amp; alerted == false)</strong></span>
<span class="strong"><strong>    {</strong></span>
<span class="strong"><strong>        alerted = true;</strong></span>
<span class="strong"><strong>    }    </strong></span>
<span class="strong"><strong>    if(alerted)</strong></span>
<span class="strong"><strong>    {</strong></span>
<span class="strong"><strong>        TurnToPlayer();</strong></span>
<span class="strong"><strong>        if(angle &gt; 5 ||angle &lt; -5)</strong></span>
<span class="strong"><strong>        {</strong></span>
<span class="strong"><strong>            turning = true;</strong></span>
<span class="strong"><strong>        }</strong></span>
<span class="strong"><strong>        else if(angle &lt; 5 &amp;&amp; angle &gt; -5)</strong></span>
<span class="strong"><strong>        {</strong></span>
<span class="strong"><strong>            if(soundReady)</strong></span>
<span class="strong"><strong>            {</strong></span>
<span class="strong"><strong>                Snarl();</strong></span>
<span class="strong"><strong>            }</strong></span>
<span class="strong"><strong>            else</strong></span>
<span class="strong"><strong>            {</strong></span>
<span class="strong"><strong>                turning = false;</strong></span>
<span class="strong"><strong>                WalkTowards();</strong></span>
<span class="strong"><strong>            }</strong></span>
<span class="strong"><strong>        }</strong></span>
<span class="strong"><strong>    }</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div><p>Our next step is to add the <code class="literal">WalkTowards</code> and <code class="literal">Snarl</code> functions that we already run in this code.</p></li><li><p>Add the<a id="id396" class="indexterm"></a> following code at the bottom of the script:</p><div class="informalexample"><pre class="programlisting">function WalkTowards()
{
    var direction = transform.TransformDirection(Vector3.forward * walkSpeed);
    charControl.SimpleMove(direction);
    theAnimator.SetBool("IsWalking", true);
}</pre></div><p>With our <code class="literal">TurnToPlayer</code> function, we have already turned the zombie toward the player, so all that is left is to move her forward.</p><p>Here, we define a <code class="literal">Vector3</code> variable named <code class="literal">direction</code> as <code class="literal">Vector3.forward</code> (or <code class="literal">positive Z</code>) multiplied by <code class="literal">walkSpeed</code>. As the zombie has a character controller component, we use the <code class="literal">SimpleMove</code> method.</p><p>We also set the Mecanim variable <code class="literal">IsWalking</code> to <code class="literal">true</code>, which will transition into the <span class="strong"><strong>Walk</strong></span> state allowing the appropriate animation to play.</p></li></ol></div><p>Next, we will get the snarl<a id="id397" class="indexterm"></a> working again and finish up the script.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch06lvl4sec16"></a>Creating the Snarl function</h5></div></div></div><p>We previously<a id="id398" class="indexterm"></a> tested the snarl animation, but removed the code when we added complexity to the script. Grouping commands together<a id="id399" class="indexterm"></a> in a custom function often makes for a cleaner and easier to read script, it also makes it much easier to add further effects.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>At the end of the script, add the following code:</p><div class="informalexample"><pre class="programlisting">function Snarl()
{
    GetComponent.&lt;AudioSource&gt;().PlayOneShot(snarlSound);
    theAnimator.SetTrigger("IsSnarling");
    soundReady = false;
}</pre></div></li><li><p>Save the script.</p></li></ol></div><p>After we put the audio back in, all we are doing here is setting the Mecanim trigger <code class="literal">IsSnarling</code> and switching off the <code class="literal">soundReady</code> boolean to ensure that the animation will not be triggered again.</p><p>If we test the game at this point, we should see the zombie transition from the turn animation back into walk whenever the player stays in the same place.</p><p>The snarl animation will play once, when the zombie is alerted. Our next objective is to synchronize and adjust the audio to improve the effect in the game.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch06lvl4sec17"></a>Synchronizing the snarl sound</h5></div></div></div><p>Currently, we<a id="id400" class="indexterm"></a> have the audio set up to play after a certain amount of time, but Unity will allow us to queue it up with our animation sequence more precisely using animation events.</p><p>In Unity, an <span class="strong"><strong>event</strong></span> is a marker set at a point within an animation sequence that can send a message to a game object to make something else happen.</p><p>For imported animation, like we are using for the characters, events are added to clips when they are defined in the <span class="strong"><strong>Import</strong></span> settings.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, locate the <code class="literal">PACKT_Animations</code> folder and click on it to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Click on the <code class="literal">zombie_snarl</code> asset to view its parameters in the <span class="strong"><strong>Inspector</strong></span> panel.</p><p>When<a id="id401" class="indexterm"></a> the <span class="strong"><strong>Animation</strong></span> import tab is active, you will see a single clip named <code class="literal">Snarl</code>.</p></li><li><p>Scroll to the bottom of the clip's parameters, and the click on the small arrow next to <span class="strong"><strong>Events</strong></span> to view the hidden parameters.</p></li><li><p>Click on the <span class="strong"><strong>Add Event</strong></span> icon.</p><p>A marker will appear on the timeline, and the <span class="strong"><strong>Edit Animation Event</strong></span> dialog will appear over the main Unity interface.</p><p>You can usually drag the time slider in the <span class="strong"><strong>Animation Preview</strong></span> panel to match a specific action in the animation, but as the animation is restricted to the face, we will need to know when the sound should start to play. For this clip, the sound needs to start on frame <code class="literal">10</code>.</p><p>Unfortunately, the events time slider is proportionate, rather than giving us specific frame numbers. However, we can scroll up to the clip time slider, which will let's define the duration in frames.</p></li><li><p>Move the event marker to the appropriate position on the time slider.</p><p>The event can send variables to a game object's script or run a function. In this case, we will set up our audio in its own function named <code class="literal">SnarlSound</code>.</p></li><li><p>In the <span class="strong"><strong>Edit Animation Event</strong></span> dialog, enter <code class="literal">SnarlSound</code> in the <span class="strong"><strong>Function</strong></span> field.</p></li><li><p>Select the name of the game object that this should be sent to in the <span class="strong"><strong>Object</strong></span> field, by clicking on the radio button and selecting <code class="literal">zombie_f</code> from the drop-down list:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_06_06.jpg" /></div></li><li><p>Make sure<a id="id402" class="indexterm"></a> to save the changes to the <span class="strong"><strong>Import</strong></span> settings, by clicking on the <span class="strong"><strong>Apply</strong></span> button located above the <span class="strong"><strong>Animation Preview</strong></span> panel.</p><p>Lastly, we need to add the <code class="literal">SnarlSound</code> function to our script.</p></li><li><p>At the bottom of the script, add the new function:</p><div class="informalexample"><pre class="programlisting">function SnarlSound()
{
    GetComponent.&lt;AudioSource&gt;().PlayOneShot(snarlSound);
    theAnimator.SetBool("IsSnarling",false);
    return;
}</pre></div></li><li><p>Delete the <code class="literal">GetComponent.&lt;AudioSource&gt;()</code> line from the previous function.</p></li><li><p>Save the script.</p></li></ol></div><p>When the game is previewed, the snarl animation will begin to play, triggering the snarl sound at the correct point. The <code class="literal">SnarlSound</code> function is triggered externally, from the tag in the motion<a id="id403" class="indexterm"></a> file. This is an accurate way to sync sounds and other functions.</p><p>We can take this a step further by adding a different type of animation to the face.</p></div></div></div></div>