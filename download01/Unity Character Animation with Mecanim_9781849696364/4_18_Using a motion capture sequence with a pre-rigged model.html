<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec23"></a>Using a motion capture sequence with a pre-rigged model</h2></div></div><hr /></div><p>To demonstrate<a id="id287" class="indexterm"></a> the use of motion capture <a id="id288" class="indexterm"></a>data in Mecanim we will continue with the male zombie character that we worked with in <a class="link" href="#" linkend="ch01">Chapter 1</a>, <span class="emphasis"><em>The Zombie Attacks!</em></span>.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec35"></a>Getting started</h3></div></div></div><p>We will begin this demonstration with the basic scene we assembled in the first chapter.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open the scene by navidating to <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Open Scene</strong></span>.</p></li><li><p>In the scene file dialog that opens up, select <code class="literal">Chapter4_Start</code> from the <code class="literal">PACKT_Scenes</code> folder.</p><p>The scene contains our <code class="literal">zombie_m</code> character and a ground plane, and is lit with the default directional light and skybox.</p><p>The character<a id="id289" class="indexterm"></a> already has an animator controller attached to it, though it only has the idle and attack animation sequences that we added in <a class="link" href="#" linkend="ch01">Chapter 1</a>, <span class="emphasis"><em>The Zombie Attacks!</em></span>.</p></li><li><p>Move the<a id="id290" class="indexterm"></a> default camera to a position where it clearly shows the <code class="literal">zombie_m</code> character and the extent of the <code class="literal">groundPlane</code> in front of it:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_04_01.jpg" /></div></li></ol></div><p>Setting up the scene in this way will make it easier to clearly see our motion sequences.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec36"></a>Importing the motion capture sequence</h3></div></div></div><p>The motion capture sequence contains the animated bones or markers that are stored in the file when the motion is captured. Mecanim allows us to transfer this data to our character's rig, which will usually have a different hierarchy of bones or joints than the source FBX.</p><p>When we import the<a id="id291" class="indexterm"></a> motion capture file, Unity will set up the asset with an Avatar, which will make it compatible with our existing character:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the unzipped project files that you downloaded for this book, locate the folder named <code class="literal">motionCapture</code>.</p></li><li><p>Open the folder to locate <code class="literal">zombie_walk.FBX</code>.</p><p>This file contains the motion capture sequence that we will be using in this chapter.</p></li><li><p>Back in Unity, locate the <code class="literal">PACKT_Animations</code> folder in the <span class="strong"><strong>Project</strong></span> panel.</p></li><li><p>Click it once to display its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Drag <code class="literal">zombie_walk.FBX</code> into the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Now that it has been imported, click <code class="literal">zombie_walk</code> to select it.</p></li></ol></div><p>Next, we will need to make some changes to the import settings.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl3sec45"></a>Adjusting the import settings</h4></div></div></div><p>The <span class="strong"><strong>Inspector</strong></span> panel will <a id="id292" class="indexterm"></a>display the FBX file's import settings, allowing us to adjust them.</p><p>Under the <span class="strong"><strong>Model</strong></span> tab, make sure that the scale is consistent with your model. In this case, the scale should be set to <code class="literal">1</code> by default.</p><p>We are only importing the animation here, so many of the checkboxes that deal with the mesh can be ignored:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_04_02.jpg" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch04lvl4sec14"></a>Adjusting the rig import settings</h5></div></div></div><p>As we<a id="id293" class="indexterm"></a> demonstrated earlier, the <span class="strong"><strong>Model</strong></span> import settings are where we specify the scale and format of the data that we are bringing in to Unity. We still need to adjust the <span class="strong"><strong>Rig</strong></span> settings to define how the skeleton is processed into an Avatar that Mecanim can use:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Inspector</strong></span> panel, click the <span class="strong"><strong>Rig</strong></span> tab.</p></li><li><p>Set the <span class="strong"><strong>Animation Type</strong></span> to <span class="strong"><strong>Humanoid</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_04_03.jpg" /></div></li><li><p>Click the <span class="strong"><strong>Configure...</strong></span> button. This will initialize the Avatar mapping diagram.</p><p>Often, Mecanim will do most of the work for you, but it is always a good idea to double check the mapping of the bones to make sure that the right bones have been assigned to the right slots within the character's Avatar.</p><p>If you <a id="id294" class="indexterm"></a>are using models and animations from different sources (as is the case here), this will be a crucial step, as the skeletons will not have the same naming conventions.</p><p>Sometimes there are additional bones in the arms, spine, and legs and we need to make sure that the bones we assign are in the same position in both rigs. If there are any compatibility issues, we can usually fix these within Mecanim.</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_04_04.jpg" /></div><p>Any errors in the mapping will be displayed with red warning labels in the viewport.</p></li><li><p>Once you are happy with the mapping, click <span class="strong"><strong>Done</strong></span> to save the changes to the Avatar.</p></li></ol></div><p>Next we will <a id="id295" class="indexterm"></a>define the range of the sequence in the <span class="strong"><strong>Animations</strong></span> import tab.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl3sec46"></a>Adjusting the sequence in the Animations tab</h4></div></div></div><p>The <span class="strong"><strong>Animations</strong></span> import settings are where we specify the range of the animation and whether it is a loop<a id="id296" class="indexterm"></a> or a single-shot sequence:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Click the <span class="strong"><strong>Animations</strong></span> tab in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>Make sure that the <span class="strong"><strong>Import Animation</strong></span> checkbox is checked. This should be the case by default.</p></li><li><p>Click the <span class="strong"><strong>Story anim stack</strong></span> clip in the <span class="strong"><strong>Clips</strong></span> list to access the additional animation settings.</p><p>When we imported the animation sequences in the last chapter, they were already prepared for us, but in this case we have a long animation sequence that needs to be trimmed to create a proper looping walk sequence for our zombie.</p><p>By default, all frames of the sequence are used in the current animation clip.</p><p>The <span class="strong"><strong>Animation Preview</strong></span> panel at the bottom of the <span class="strong"><strong>Inspector</strong></span> panel currently shows a default humanoid character. Let's preview the animation sequence on the <code class="literal">zombie_m</code> character instead.</p></li><li><p>Drag the <code class="literal">zombie_m</code> game object from the <span class="strong"><strong>Hierarchy</strong></span> panel onto the <span class="strong"><strong>Animation Preview</strong></span> panel.</p><p>The display should update to show the male zombie.</p></li><li><p>In the <span class="strong"><strong>Preview</strong></span> panel, click the <span class="strong"><strong>Play</strong></span> button to preview the sequence.</p></li><li><p>The animation sequence shows the zombie's walk. Importantly, in this motion capture file, there are several full cycles.</p><p>The walk sequence is not completely regular, and there are variations consistent with what we would expect for a zombie's walk.</p></li><li><p>Rename the sequence <code class="literal">zwalk01</code> by typing this into the name field just below the <span class="strong"><strong>Clips</strong></span> list.</p></li><li><p>Hit <span class="strong"><strong>Enter</strong></span> to store the name change.</p><p>Next we will specify the start and end frames of the sequence.</p></li><li><p>Click the <span class="strong"><strong>Clamp Range</strong></span> button, to allow you to specify the start and end of the new cycle within the source sequence.</p></li><li><p>Preview the animation and find the point in the walk sequence where the left foot comes to its full forward extent for the first time.</p></li><li><p>Drag the <a id="id297" class="indexterm"></a><span class="strong"><strong>Start</strong></span> frame tag to this point or type the number of the frame into the <span class="strong"><strong>Start</strong></span> field.</p><p>Frame <code class="literal">180</code> should be about right, but if you have chosen a different frame, this is also okay.</p></li><li><p>Drag the <span class="strong"><strong>End</strong></span> frame tag to the point in the sequence where the first cycle ends.</p><p>This will be where the left foot comes to its full forward extent for the second time.</p><p>Frame <code class="literal">225</code> should be about right. This number could also be typed into the <span class="strong"><strong>End</strong></span> field.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note24"></a>Note</h3><p>When you choose the end frame of a cycle, keep an eye on the colored circles on the right of the <span class="strong"><strong>Inspector</strong></span> panel. These help you to locate an appropriate start and end of a loop. All circles will turn green if you have a perfect match.</p><p>These circles represent the <span class="strong"><strong>Local Bone Rotations</strong></span>, <span class="strong"><strong>Root Transform Rotation</strong></span>, <span class="strong"><strong>Root Transform Position (Y)</strong></span>, and <span class="strong"><strong>Root Transform Position (XZ)</strong></span>.</p><p>It is okay if not all of these are displayed in green. At the moment, the first of these is the one that you should be the most concerned about. A green circle is the best match; yellow is the next best.</p></div></li><li><p>Check the <span class="strong"><strong>Loop Time</strong></span> and <span class="strong"><strong>Loop Pose</strong></span> checkboxes to make sure that the sequence is interpreted as a cycle.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note25"></a>Note</h3><p>Animation sequences always loop in the preview panel, but you will need to specify that they are loops in the <span class="strong"><strong>Animations</strong></span> import settings for them to actually loop when they run in the game.</p></div></li><li><p>In the <span class="strong"><strong>Root Transform Position (Y)</strong></span> group, set the <span class="strong"><strong>Based Upon (at Start)</strong></span> value to <a id="id298" class="indexterm"></a><code class="literal">Feet</code> using the drop-down list.</p></li><li><p>Check the <span class="strong"><strong>Bake into Pose</strong></span> checkbox for this group to make sure that the position of the feet in the pose are identified.</p><p>This will help to make sure that the feet do not penetrate the ground plane as the character walks.</p></li><li><p>Leave the remaining parameters with their default values.</p></li><li><p>Click the <span class="strong"><strong>Apply</strong></span> button to store the changes.</p></li><li><p>Preview the animation again, it should now start with the frame that you selected:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_04_05.jpg" /></div></li></ol></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec37"></a>Creating the second walk cycle</h3></div></div></div><p>We will get a little more mileage out of this motion capture sequence by creating another walk cycle that <a id="id299" class="indexterm"></a>uses a different portion of the original animation clip.</p><p>As our game <a id="id300" class="indexterm"></a>will involve multiple zombies walking around in our scene at any given time, this will help to add some variety. We could even set up these animation clips to play randomly:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Click on the <span class="strong"><strong>+</strong></span> symbol in the <span class="strong"><strong>Clips</strong></span> list to add another animation clip. The start and end tags will be reset to their original positions at the beginning and end of the original animation clip.</p></li><li><p>Rename the new clip <code class="literal">zwalk02</code>.</p></li><li><p>Again click the <span class="strong"><strong>Clamp Range</strong></span> button.</p></li><li><p>Making sure that the new clip is selected, move the <span class="strong"><strong>Start</strong></span> frame tag to the second instance in which the left foot has reached its forward extent, around frame 225.</p><p>This is the same frame as the end frame of the first walk cycle.</p></li><li><p>Move the <span class="strong"><strong>End</strong></span> frame tag to the next instance in which the left foot has reached its extent. Frame 264 should be a good end frame.</p></li><li><p>Make sure to check <span class="strong"><strong>Loop Time</strong></span> and <span class="strong"><strong>Loop Pose</strong></span>, and check the colored circles for a good match.</p></li><li><p>As before, select <span class="strong"><strong>Feet</strong></span> as the value in the <span class="strong"><strong>Based Upon (at Start)</strong></span> drop-down list in the <span class="strong"><strong>Root Transform Position (Y)</strong></span> group, and check the <span class="strong"><strong>Bake into Pose</strong></span> checkbox.</p></li><li><p>Click the <span class="strong"><strong>Apply</strong></span> button to save the changes made to <code class="literal">zwalk02</code>.</p></li><li><p>Preview the animation.</p></li></ol></div><p>Despite being derived from the same motion capture sequence, the two sequences should appear distinctly different.</p><p>In order to play the animations in the scene, we will need to add them to the animator controller and reference them in a short script to determine when each will play.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl3sec47"></a>Adding the new motion clips to the animation controller</h4></div></div></div><p>In the game, we would probably want a single zombie to use only one walk sequence, but for testing purposes <a id="id301" class="indexterm"></a>we will set up a script to switch between the two prepared cycles.</p><p>We will have our zombie walk automatically when we start the game, and have him switch animations when the <span class="emphasis"><em>B</em></span> key is pressed:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, navigate to the <code class="literal">PACKT_Controllers</code> folder.</p></li><li><p>Drag <code class="literal">walkTest</code> onto the <span class="strong"><strong>Controller</strong></span> slot in the zombie's animator component in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>Activate the <span class="strong"><strong>Animator</strong></span> tab, next to <span class="strong"><strong>Scene</strong></span> and <span class="strong"><strong>Game</strong></span> views in the center panel, by clicking it.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note26"></a>Note</h3><p>If the<a id="id302" class="indexterm"></a> <span class="strong"><strong>Animator</strong></span> tab is not visible, it can be activated from the <span class="strong"><strong>Menu</strong></span> tab by navigating to <span class="strong"><strong>Windows</strong></span> | <span class="strong"><strong>Animator</strong></span>.</p></div><p>If you expand or <span class="emphasis"><em>Alt</em></span> + drag the <span class="strong"><strong>Animator</strong></span> window, you will see that it contains only two additional states: <span class="strong"><strong>Walk01</strong></span> and <span class="strong"><strong>Walk02</strong></span>:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_04_06.jpg" /></div><p>The transitions between these two states are set up with a boolean parameter called <code class="literal">SwitchWalk</code>, which is set to <code class="literal">false (off)</code> by default, shown in the <span class="strong"><strong>Parameters</strong></span> box with an unchecked checkbox.</p></li><li><p>Click the <span class="strong"><strong>Walk01</strong></span> state and drag the <code class="literal">zwalk01</code> animation clip into the first motion field.</p></li><li><p>Do the same for <span class="strong"><strong>Walk02</strong></span>, assigning <code class="literal">zwalk02</code> to the second motion field.</p></li></ol></div><p>The next step <a id="id303" class="indexterm"></a>will involve triggering the transition between the states in a short script.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl3sec48"></a>Creating a script to see both animation loops in action</h4></div></div></div><p>In order to see the difference between our two walk animation loops, we will set up a simple script to<a id="id304" class="indexterm"></a> enable them to play in turn:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, select the <code class="literal">PACKT_Scripts</code> folder and create a new Javascript file within it by navigating to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Javascript</strong></span>.</p></li><li><p>Name the script <code class="literal">zombieWalkTest01</code>.</p></li><li><p>Double-click on the file to open it in MonoDevelop.</p></li><li><p>Replace the default code in the script with the following code:</p><div class="informalexample"><pre class="programlisting">var zombieControl : Animator;
var walkBool : boolean = false;

function Start () 
{
    zombieControl = GetComponent(Animator);
}

function Update () 
{
    if(Input.GetKeyDown("b"))
    {
        walkBool = !walkBool;
        zombieControl.SetBool("SwitchWalk", walkBool);
    }
}</pre></div></li></ol></div><p>At the top of the script, we create the variable <code class="literal">zombieControl</code> to maintain a connection between the character game object's animator component.</p><p>We create a boolean named <code class="literal">walkBool</code> that will be used within this script to determine when to switch between our two animation states. This is set to <code class="literal">false</code> by default.</p><p>Within the <code class="literal">Start</code> function, we<a id="id305" class="indexterm"></a> define the first variable as the animator component attached to the same game object as the script using the <a id="id306" class="indexterm"></a><code class="literal">GetComponent</code> method. We also set the Mecanim boolean <code class="literal">SwitchWalk</code> to <code class="literal">walkBool</code>, which has already been set to <code class="literal">false</code> as its default state.</p><p>In the <code class="literal">Update</code> function, we check for down input from the <span class="emphasis"><em>B</em></span> key. When this condition is met, we switch the <code class="literal">walkBool</code> boolean. We also set the Mecanim boolean <code class="literal">SwitchWalk</code> to the value returned by <code class="literal">walkBool</code>.</p><p>This is a very <a id="id307" class="indexterm"></a>simple example of how to set up a two-state behavior controlled with user input. The script could easily be adapted to respond to environmental triggers.</p><p>We will go into more detail with this in <a class="link" href="#" linkend="ch09">Chapter 9</a>, <span class="emphasis"><em>Controlling Enemy Animation with AI and Triggers</em></span>, which deals with enemy behavior.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch04lvl4sec15"></a>Adding the script and previewing the animation switch</h5></div></div></div><p>We have set up the zombie's animator controller but we still need to attach the script before we can<a id="id308" class="indexterm"></a> test the animation loops:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select the <a id="id309" class="indexterm"></a><code class="literal">zombie_m</code> game object in the <span class="strong"><strong>Hierarchy</strong></span> panel to expose its properties in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>Add the script by dragging it onto the game object in the <span class="strong"><strong>Hierarchy</strong></span> panel. <code class="literal">zombieWalkTest01</code> will show up as a script component in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>Press <span class="strong"><strong>Play</strong></span> to preview the animation.</p></li><li><p>Once the zombie has cycled through his first animation a couple of times, press <span class="emphasis"><em>B</em></span> on the keyboard and see the second walk cycle run.</p></li></ol></div><p>This will continue until you hit the <span class="emphasis"><em>B</em></span> key again:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_04_07.jpg" /></div><p>There<a id="id310" class="indexterm"></a> should be some noticeable differences between the two<a id="id311" class="indexterm"></a> walk cycles. Small variations in the pose and movement of the joints will give each walk cycle its own distinct character.</p></div></div></div></div>