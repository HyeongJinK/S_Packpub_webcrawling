<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec25"></a>Loading the scene</h2></div></div><hr /></div><p>This time, the starting scene has been prepared. It includes a basic environment, lighting and the <code class="literal">zombie_f</code> prefab already set up to work with Mecanim.</p><p>In the <a id="id312" class="indexterm"></a>Unity project, open the scene <code class="literal">Chapter5_Start</code>. The scene will load. The female zombie already has an Avatar, and has an animator component attached to it, containing a single, idling animation unique to the character.</p><p>The <code class="literal">zombie_f</code> prefab also has a short script, which is set up ready to play the idle and walk sequences:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_05_01.jpg" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec38"></a>Adding and previewing the animation</h3></div></div></div><p>At this point <a id="id313" class="indexterm"></a>we will add one of the walk sequences to the zombie's animator <a id="id314" class="indexterm"></a>controller:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Click the <span class="strong"><strong>Animator</strong></span> tab to view the character's animator controller.</p></li><li><p>In the <span class="strong"><strong>Animator</strong></span> window, click the <span class="strong"><strong>Walk</strong></span> state to view its parameters in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>In the <span class="strong"><strong>Project</strong></span> panel, click the <code class="literal">PACKT_Animations</code> folder to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Locate the <code class="literal">zombie_walk</code> asset and click the small arrow to the right of its icon to view its contents.</p></li><li><p>Drag <code class="literal">zWalk01</code> from the <span class="strong"><strong>Assets</strong></span> panel into the <span class="strong"><strong>Walk</strong></span> state's <span class="strong"><strong>Motion</strong></span> field in the <span class="strong"><strong>Inspector</strong></span> panel to add it to the state machine.</p></li><li><p>Press the <a id="id315" class="indexterm"></a><span class="strong"><strong>Play</strong></span> button in the top-center of the Unity interface to preview the game:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_05_02.jpg" /></div></li></ol></div><p>The female <a id="id316" class="indexterm"></a>zombie character will idle for a short time before launching into the walk sequence. It should be obvious that there are a few issues with the walk sequence:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>When the character starts walking, she floats to a position above the ground</p></li><li style="list-style-type: disc"><p>During the walk cycle, the character's arms intersect with her torso</p></li><li style="list-style-type: disc"><p>The ponytail<a id="id317" class="indexterm"></a> does not move along with the rest of the character:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_05_03.jpg" /></div></li></ul></div><p>These issues<a id="id318" class="indexterm"></a> will be fixed in the animation import settings.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec39"></a>Adjusting import settings to get a better fit</h3></div></div></div><p>In order to<a id="id319" class="indexterm"></a> adjust the import settings for the motion clip, we<a id="id320" class="indexterm"></a> need to locate the original FBX file that contains the motion capture data for the walk cycle:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, expand the <code class="literal">PACKT_Animations</code> folder.</p></li><li><p>Select the <code class="literal">zombie_walk</code> asset in the <span class="strong"><strong>Assets</strong></span> panel.</p><p>Its import settings will be displayed in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>Click the <span class="strong"><strong>Animations</strong></span> tab to view the current import settings.</p></li></ol></div><p>The initial <code class="literal">zwalk01</code> clip works fine for the male zombie, so we do not want to make any changes directly to this, so instead, we will create a new clip. This will allow us to tailor the sequence to<a id="id321" class="indexterm"></a> the <code class="literal">zombie_f</code> character.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec49"></a>Creating a duplicate walk cycle</h4></div></div></div><p>If we simply <a id="id322" class="indexterm"></a>duplicate the animation asset in the <span class="strong"><strong>Assets</strong></span> panel, we would lose the ability to adjust the motion clip's parameters. Making these changes in the root asset from which the clip is derived gives us much more control over the resulting clip:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Inspector</strong></span> panel, click the <span class="strong"><strong>+</strong></span> symbol at the bottom of the <span class="strong"><strong>Clips</strong></span> group to create a new clip.</p></li><li><p>Name the clip <code class="literal">zwalk01f</code> in the name field.</p></li><li><p>Click the <span class="strong"><strong>Clamp Range</strong></span> button to limit the frame range that the new clip will use.</p></li><li><p>Set the <span class="strong"><strong>Start</strong></span> and <span class="strong"><strong>End</strong></span> frames of the clip to <code class="literal">180</code> and <code class="literal">225</code> to match the parameters of <code class="literal">zwalk01</code>.</p></li><li><p>Click the <span class="strong"><strong>Apply</strong></span> button to save the changes to the asset.</p></li><li><p>Switch to the <span class="strong"><strong>Animator</strong></span> tab and replace the walk cycle in the state machine by clicking the <span class="strong"><strong>Walk</strong></span> state and dragging the <code class="literal">zwalk01f</code> clip into the motion clip field in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li></ol></div><p>At this point there should not be any noticeable changes, but replacing the clip in the state machine will allow us to visualize the new clip in the scene.</p><p>The next step will be to adjust the animation's height so that the character appears to walk on the floor.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec50"></a>Adjusting the motion parameters</h4></div></div></div><p>The animation<a id="id323" class="indexterm"></a> import settings will allow us to make changes to the way the animation data is interpreted to better suit the target character:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Assets</strong></span> panel, click <code class="literal">zombie_walk</code> to view the parameters in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>Make sure that the <span class="strong"><strong>Animations</strong></span> tab is selected and <code class="literal">zwalk01f</code> is highlighted in the <span class="strong"><strong>Clips</strong></span> box.</p></li><li><p>Check the checkboxes for <span class="strong"><strong>Loop Time</strong></span> and then <span class="strong"><strong>Loop Pose</strong></span> to make sure the sequence cycles smoothly.</p></li><li><p>Scroll down to the <span class="strong"><strong>Root Transform Position (Y)</strong></span> group. This is used to adjust the root height of the model when the motion clip is played.</p></li><li><p>Check the<a id="id324" class="indexterm"></a> <span class="strong"><strong>Bake into Pose</strong></span> checkbox.</p></li><li><p>Set the <span class="strong"><strong>Offset</strong></span> value to <code class="literal">0.08</code>.</p></li><li><p>Scroll to the bottom of the <span class="strong"><strong>Inspector</strong></span> panel and click the <span class="strong"><strong>Apply</strong></span> button.</p><p>You should notice the character drop slightly in the <span class="strong"><strong>Animation Preview</strong></span> panel at the bottom of the <span class="strong"><strong>Inspector</strong></span> panel.</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_05_04.jpg" /></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip09"></a>Tip</h3><p>To get a<a id="id325" class="indexterm"></a> better visualization of the offset, you can orbit the character in the <span class="strong"><strong>Animation Preview</strong></span> panel by dragging within it.</p><p>If you need to scale up the panel, drag the gray title bar of the <span class="strong"><strong>Animation Preview</strong></span> up to increase the panel's height within the <span class="strong"><strong>Inspector</strong></span> panel, or drag the entire <span class="strong"><strong>Inspector</strong></span> panel into the center of the interface to undock it.</p></div></li><li><p>Preview the<a id="id326" class="indexterm"></a> adjusted motion clip by clicking the <span class="strong"><strong>Play</strong></span> button in the main Unity interface:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_05_05.jpg" /></div></li><li><p>Check the position of the feet at various stages of the walk cycle using the <span class="strong"><strong>Pause</strong></span> button and adjust the <span class="strong"><strong>Offset</strong></span> value if necessary.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note27"></a>Note</h3><p>To fix the relative height of the motion clip, we adjusted the <span class="strong"><strong>Root Transform Position (Y)</strong></span> import setting.</p><p>There are also options to fix the <span class="strong"><strong>XZ</strong></span> position and the rotation of the animation. In this case, we did not need to adjust these parameters, but they are useful when the root joint has not been centered to the world or faces a different direction than the rigged character model that it is being applied to.</p><p>In the <span class="strong"><strong>Root Transform Position (Y)</strong></span> group, we left <span class="strong"><strong>Bake Into Pose</strong></span> unchecked. Checking this will apply the offset to the animation's root joint in its starting pose rather than recalculating it throughout the sequence.</p><p>We left<a id="id327" class="indexterm"></a> <span class="strong"><strong>Based Upon (at Start)</strong></span> to its default value of <span class="strong"><strong>Original</strong></span>. This applies <span class="strong"><strong>Offset</strong></span> to the position of the root joint at the start of the whole imported sequence. Setting this to <span class="strong"><strong>Center of Mass</strong></span> or <span class="strong"><strong>Feet</strong></span> using the dropdown will have different effects. <span class="strong"><strong>Center of Mass</strong></span> will apply the offset to a point equal to half the height of the animation rig.</p><p>These parameters are useful when we are working with animation from multiple sources.</p></div></li></ol></div><p>Our next objective is to adjust the joint rotation limits to prevent the character's arms from intersecting with her torso. We will achieve this in the next step by adjusting the muscle limits.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec51"></a>Adjusting the muscle limits</h4></div></div></div><p>With muscle<a id="id328" class="indexterm"></a> limits, we can define a joint's range of movement and therefore how the character will interpret the animation:</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note28"></a>Note</h3><p>We are covering muscle limits in this chapter because of their relevance to motion capture and retargeting. If you are creating animation sequences specifically for a single character, adjusting muscle limits is as unnecessary as retargeting.</p></div><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, locate the <code class="literal">FBX_Imports</code> folder and click it to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Click the <code class="literal">zombie_f</code> asset.</p><p>This is the asset used in the <code class="literal">zombie_f</code> prefab in our scene. Making changes to the original item will automatically be transferred to the prefab.</p><p>The <code class="literal">zombie_f</code> asset's parameters should now be visible in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>Click to select the <span class="strong"><strong>Rig</strong></span> tab.</p></li><li><p>Click the <span class="strong"><strong>Configure</strong></span> button.</p><p>At this point, you may be prompted to save the scene. In this case, it is an unnecessary step, as all of the changes so far have been made to prefabs and are already saved at the project level.</p><p>The <span class="strong"><strong>Inspector</strong></span> panel will now display the <span class="strong"><strong>Avatar Mapping Definition</strong></span> panel, where we defined the hierarchy of bones that make up the character's skeleton previously.</p></li><li><p>Click the<a id="id329" class="indexterm"></a> <span class="strong"><strong>Muscles</strong></span> tab.</p></li></ol></div><p>A number of muscle limit sliders will appear in the <span class="strong"><strong>Inspector</strong></span> panel, and the character will snap into a test pose in the <span class="strong"><strong>Scene</strong></span> view:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_05_06.jpg" /></div><p>The sliders in the <span class="strong"><strong>Muscle Group Preview</strong></span> box are for testing. Dragging sliders will preview the character Avatar's current muscle limits in the <span class="strong"><strong>Scene</strong></span> view. We will be making changes<a id="id330" class="indexterm"></a> to the character's muscle limits in the second box, which defines the <span class="strong"><strong>Per-Muscle Settings</strong></span>.</p><p>We will start with the right arm, which intersects with the torso during the walk cycle:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Click <span class="strong"><strong>Right Arm</strong></span> in the <span class="strong"><strong>Per-Muscle Settings</strong></span> list to view its muscle limit parameters.</p></li><li><p>In the list of parameters that appear beneath <span class="strong"><strong>Right Arm</strong></span>, click <span class="strong"><strong>Arm Down-Up</strong></span> to view its limits slider:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_05_07.jpg" /></div><p>The range of <span class="strong"><strong>Arm Down-Up</strong></span> is currently set with a lower limit of <code class="literal">-60</code> degrees and an upper limit of <code class="literal">100</code> degrees.</p></li><li><p>Drag the <span class="strong"><strong>Preview</strong></span> slider on the left to visualize this with the character in the <span class="strong"><strong>Scene</strong></span> view.</p><p>It should be apparent that the upper arm is rotating much further than it should.</p></li><li><p>Drag the <span class="strong"><strong>Preview</strong></span> slider all the way to the right and adjust the upper limit to restrict the movement of the joint. A value of around <code class="literal">80</code> should allow enough movement.</p></li><li><p>Drag the <span class="strong"><strong>Preview</strong></span> slider all the way to the left and adjust the muscle's lower limit. The<a id="id331" class="indexterm"></a> joint should stop rotating when it starts to intersect with the torso. A value of <code class="literal">-41</code> should work for this.</p></li><li><p>Click the <span class="strong"><strong>Apply</strong></span> button to store the changes:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_05_08.jpg" /></div></li><li><p>Repeat this process for the muscle limits in the <span class="strong"><strong>Left Arm</strong></span>.</p></li><li><p>Make sure to click the <span class="strong"><strong>Apply</strong></span> button to save your changes.</p></li><li><p>In the <span class="strong"><strong>Right Arm</strong></span> list, select <span class="strong"><strong>Forearm Stretch</strong></span>.</p><p>Dragging the <span class="strong"><strong>Preview</strong></span> slider for this muscle limit should show that the forearm intersects with the upper arm at its lower limit.</p></li><li><p>Move the lower limit further towards the center of the scale, or type in a new number so that the forearm no longer intersects with the upper arm. A value of <code class="literal">-65</code> should work pretty well.</p><p>In this case, it is not necessary to adjust the upper limit as the rotation comes to an end when the arm is straight.</p></li><li><p>Repeat<a id="id332" class="indexterm"></a> these changes in the <span class="strong"><strong>Forearm Stretch</strong></span> parameter for the <span class="strong"><strong>Left Arm</strong></span>.</p></li></ol></div><p>Test more of the <span class="strong"><strong>Preview</strong></span> sliders to see whether it is necessary to make more changes to the muscle limits. Remember this is only necessary if there is a conflict in the rotation of the joints in the animation sequence we are using, or if you want to add distinct characteristics to the animation when played with a particular character.</p><p>Different clothing, such as the female zombie's skirt and heels, could be factors that would limit the rotation of joints and ultimately how the character moves.</p><p>Another Mecanim tool that can be used to adapt motion sequences in Unity is the body mask. We will demonstrate this next with the male zombie character.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec40"></a>Working with Avatar Body Masks</h3></div></div></div><p>As well as <a id="id333" class="indexterm"></a>adapting motion sequences to specific character types with muscle limit definitions, Mecanim has the ability to blend together parts of different sequences using <span class="strong"><strong>Avatar Body Masks</strong></span>.</p><p>Much like masks <a id="id334" class="indexterm"></a>used to hide portions of still images in image-editing software such as Photoshop, Mecanim's body masks can be used to hide parts of a character animation allowing motion in an underlying layer to become visible.</p><p>This can be useful when it is necessary to add subtle differences to recurring animation sequences such as those used by the zombie enemies in this example.</p><p>In this section we will add an Avatar Body Mask and use it on the prefab male zombie character to vary his animation.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec52"></a>Opening the new scene</h4></div></div></div><p>The assets<a id="id335" class="indexterm"></a> needed to demonstrate body masks have been put together in a scene.</p><p>Open the scene <code class="literal">Chapter5_2</code>. This scene contains the conference room environment, along with the <code class="literal">zombie_m</code> character already set up with an animator controller and a script to enable him to switch between states.</p><p>If you test the game at this point, by pressing the <span class="strong"><strong>Play</strong></span> button, you will see the zombie idle for a while before starting his walk animation:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_05_09.jpg" /></div><p>In the next step <a id="id336" class="indexterm"></a>we will create our first mask:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, select and expand the <code class="literal">PACKT_Masks</code> folder.</p></li><li><p>To create the new mask asset, right-click in the <span class="strong"><strong>Assets</strong></span> panel and choose <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Avatar Mask</strong></span>.</p></li><li><p>When the icon for the mask appears in the folder, rename this <code class="literal">z_Legs</code>.</p></li><li><p>Click to expand the <span class="strong"><strong>Humanoid</strong></span> parameter in the <span class="strong"><strong>Inspector</strong></span> panel.</p><p>The<a id="id337" class="indexterm"></a> mask diagram will appear in the <span class="strong"><strong>Inspector</strong></span> panel.</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_05_10.jpg" /></div><p>The mask diagram is similar to the <span class="strong"><strong>Avatar Definition</strong></span> map in which we defined the bone positions within the rigged character model in the <span class="strong"><strong>Import</strong></span> settings.</p><p>In this case, the diagram is used to specify which parts of the animation will be masked. By default nothing is masked. You can click on each part of the body to remove it (or mask it out).</p><p>Avatar mask options are:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="strong"><strong>Head</strong></span>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Right Arm</strong></span>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Left Arm</strong></span>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Right Hand</strong></span>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Left Hand</strong></span>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Torso</strong></span>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Right Leg</strong></span>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Left Leg</strong></span>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Root</strong></span>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Right Arm IK</strong></span>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Left Arm IK</strong></span>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Right Leg IK</strong></span>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Left Leg IK</strong></span>
</p></li></ul></div><p>The root is<a id="id338" class="indexterm"></a> denoted by the circle at the feet of the character in the diagram. The <span class="strong"><strong>IK</strong></span> masks will cause the arm or leg's motion to be driven by the hand or foot respectively.</p></li><li><p>Now, click on all of the areas except for the right and left legs.</p><p>The areas that you have clicked will turn red in the diagram:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_05_11.jpg" /></div></li></ol></div><p>In the next stage we will be creating a new animation layer within the character's animator controller. Only the areas that are green in the diagram will run the new animation, the rest of the areas will use the controller's base layer of animation.</p><p>Using this technique, parts <a id="id339" class="indexterm"></a>of different animation sequences can be put together to create composite motion clips. The animator needs more than one layer to use a mask. We will create this in the next step.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec41"></a>Creating a second layer in the animator controller</h3></div></div></div><p>Multiple layers <a id="id340" class="indexterm"></a>can be added to an animator <a id="id341" class="indexterm"></a>controller, enabling parts of different <a id="id342" class="indexterm"></a>motion clips to be masked together. In this step we will add a second layer to the controller:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>If it is not already selected, use the <span class="strong"><strong>Hierarchy</strong></span> panel to select the <span class="strong"><strong>zombie_m</strong></span> game object.</p></li><li><p>In the top-center of the Unity interface, click the <span class="strong"><strong>Animator</strong></span> tab to open the <span class="strong"><strong>Animator</strong></span> panel.</p><p>By default, the controller's states and transitions are grouped in the base layer, but we will create a new layer to house the masking to enable the animation to happen at the same time without affecting the other parts of the skeleton.</p></li><li><p>Create the new layer by clicking on the <span class="strong"><strong>+</strong></span> symbol in the <span class="strong"><strong>Layers</strong></span> tab in the top-left corner of the <span class="strong"><strong>Animator</strong></span> panel.</p></li><li><p>Rename the new layer <span class="strong"><strong>Legs</strong></span>.</p></li><li><p>Click on the <span class="strong"><strong>Legs</strong></span> layer in the <span class="strong"><strong>Animator</strong></span> window. It will replace the base layer within the interface and appear as a default animation controller window with the two default states—<span class="strong"><strong>Any State</strong></span> and <span class="strong"><strong>Entry</strong></span>.</p></li><li><p>Click the settings icon on the right of the <span class="strong"><strong>Legs</strong></span> layer tab.</p><p>This will allow you to adjust settings associated with the layer.</p></li><li><p>Drag the <span class="strong"><strong>Weight</strong></span> slider to its maximum value, <code class="literal">1</code>.</p><p>This value defines the strength of the animation that will mask the original.</p></li><li><p>Click the radio button next to the <span class="strong"><strong>Mask</strong></span> field and choose the <code class="literal">z_Legs</code> mask in the dialogue that appears.</p></li></ol></div><p>In the <span class="strong"><strong>Legs</strong></span> layer we will define the motion sequence that will replace that in the base layer:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_05_12.jpg" /></div><p>We next need to<a id="id343" class="indexterm"></a> define the states and transitions as we <a id="id344" class="indexterm"></a>would usually do in an animator controller.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec53"></a>Creating states in the mask layer</h4></div></div></div><p>States in a<a id="id345" class="indexterm"></a> mask layer typically define when the layer is used:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new state within the <span class="strong"><strong>Animator</strong></span> panel by right-clicking and selecting <span class="strong"><strong>Create State</strong></span> | <span class="strong"><strong>Empty</strong></span>.</p></li><li><p>Click on the new state to open its properties within the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>Rename the new state <code class="literal">null</code> state.</p><p>The <code class="literal">null</code> state is the default state for the layer. It does not need a motion added to it because the base layer's animation will be visible when the <code class="literal">null</code> state is active.</p></li><li><p>Create a second state.</p></li><li><p>Rename the new state <code class="literal">AltWalk</code>.</p></li><li><p>In the <span class="strong"><strong>Project</strong></span> panel, open the <code class="literal">PACKT_Animations</code> folder.</p></li><li><p>Drag the <code class="literal">z_walk02</code> animation into the motion slot in the <span class="strong"><strong>Inspector</strong></span> panel, this will define the replacement animation that will be used just for the legs.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec54"></a>Setting the parameter and transitions in the mask layer</h4></div></div></div><p>Just like the<a id="id346" class="indexterm"></a> base layer, the <span class="strong"><strong>Leg</strong></span> layer <a id="id347" class="indexterm"></a>needs a parameter and transitions to effect its states:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new parameter by clicking the <span class="strong"><strong>+</strong></span> symbol in the <span class="strong"><strong>Parameters</strong></span> box in the lower left of the <span class="strong"><strong>Animator</strong></span> window.</p></li><li><p>Choose <span class="strong"><strong>Bool</strong></span> as the parameter type.</p></li><li><p>Rename the parameter <code class="literal">AltWalking</code>. Leave its checkbox unchecked.</p></li><li><p>Click <span class="strong"><strong>null State</strong></span> and select <span class="strong"><strong>Make Transition</strong></span>.</p></li><li><p>Click <span class="strong"><strong>AltWalk</strong></span> to select it as the target state for the transition.</p></li><li><p>Click the transition to expose its properties within the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>In the <span class="strong"><strong>Conditions</strong></span> group, choose <code class="literal">AltWalking</code> from the drop-down list.</p></li><li><p>Its case should be left to <code class="literal">true</code>.</p></li><li><p>Create a second transition to link the <span class="strong"><strong>AltWalk</strong></span> state back to the <span class="strong"><strong>null State</strong></span>.</p></li><li><p>Once again choose <code class="literal">AltWalking</code> as the condition, but this time choose <span class="strong"><strong>false</strong></span> as the case.</p></li></ol></div><p>That is it for the animator, but by default the secondary layer will not come into play, it needs to be set up within the character's animation script.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec55"></a>Editing the script</h4></div></div></div><p>Now we will<a id="id348" class="indexterm"></a> edit the script to activate the mask layer:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, click the <code class="literal">PACKT_Scripts</code> folder to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Double-click <code class="literal">zombie_m_idleWalk</code> to open it in MonoDevelop.</p></li><li><p>Add the following variable to the others near the top of the script:</p><div class="informalexample"><pre class="programlisting">var changeWalk : boolean = false;</pre></div><p>This boolean will allow us to change the Mecanim parameter in the script.</p></li><li><p>Add the following code to the<a id="id349" class="indexterm"></a> top of the <code class="literal">Update</code> function:</p><div class="informalexample"><pre class="programlisting">theAnimator.SetBool("AltWalking",changeWalk);

if(Input.GetKeyDown("b"))
{
    changeWalk = !changeWalk;
}</pre></div></li></ol></div><p>Firstly, we tie the script boolean <code class="literal">changeWalk</code> to the Mecanim boolean <code class="literal">AltWalking</code> in our animator controller.</p><p>Next we <a id="id350" class="indexterm"></a>check for input from the <span class="emphasis"><em>B</em></span> key to switch the boolean case of the <code class="literal">AltWalk</code> state to <code class="literal">true</code>, and play the replacement walk animation in the legs.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec56"></a>Previewing the masked animation</h4></div></div></div><p>We can stop at this <a id="id351" class="indexterm"></a>point and see what the masked animation currently looks like:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Preview the game by pressing the <span class="strong"><strong>Play</strong></span> button in the top center of the interface.</p></li><li><p>After idling for a short time, the character will go into a walk.</p></li><li><p>Press the <span class="emphasis"><em>B</em></span> key to activate the masked layer.</p></li></ol></div><p>The animation will switch to the alternate clip:</p><div class="mediaobject"><img src="/graphics/9781849696364/graphics/6364OT_05_13.jpg" /></div><p>The resulting composite animation uses the <code class="literal">zwalk01</code> motion derived from the motion capture file, but augments it with the leg animation from <code class="literal">zwalk02</code>.</p><p>Considering<a id="id352" class="indexterm"></a> that our game will feature a number of enemy characters on the screen at the same time, this technique could be used effectively to give the impression of individuality: making our zombies move differently without the memory overhead involved with creating a different set of animation sequences for each enemy.</p><p>In the next section we will further demonstrate these possibilities by creating variations with the two walk cycles.</p></div></div></div>