<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec89"></a>Creating XML text data automatically through serialization</h2></div></div><hr /></div><p>Another way to create <a id="id625" class="indexterm"></a>XML data structures from game objects and properties is by serializing the contents of an object automatically. This technique automatically generates XML for all the public properties of an object.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec311"></a>Getting ready</h3></div></div></div><p>In the <code class="literal">0423_08_06</code> folder, you'll find the listings for all four classes described in this recipe.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec312"></a>How to do it...</h3></div></div></div><p>To create XML text data through serialization, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a C# script called <code class="literal">PlayerScore</code>:</p><div class="informalexample"><pre class="programlisting">// file: PlayerScore.cs
public class PlayerScore 
{
    public string name; 
    public int score;

    // default constructor, needed for serialization
    public PlayerScore() {}

    public PlayerScore(string newName, int newScore) {
        name = newName;
        score = newScore;
    }
}</pre></div></li><li><p>Create a<a id="id626" class="indexterm"></a> C# script called <code class="literal">SerializeManager</code>:</p><div class="informalexample"><pre class="programlisting">// file: SerializeManager.cs
//
// acknowledgements - this code has been adapted from:
//www.eggheadcafe.com/articles/system.xml.xmlserialization.asp
using System.Xml;
using System.Xml.Serialization;
using System.IO;
using System.Text;
using System.Collections.Generic;

public class SerializeManager&lt;T&gt; {
    public string SerializeObject(T pObject) {
        string XmlizedString = null;
        MemoryStream memoryStream = new MemoryStream();
        XmlSerializer xs = new XmlSerializer(typeof(T));
        XmlTextWriter xmlTextWriter = new XmlTextWriter(memoryStream, Encoding.UTF8);
        xs.Serialize(xmlTextWriter, pObject);
        memoryStream = (MemoryStream)xmlTextWriter.BaseStream;
        XmlizedString = UTF8ByteArrayToString(memoryStream.ToArray());
        return XmlizedString;
    }

    public object DeserializeObject(string pXmlizedString) {
        XmlSerializer xs = new XmlSerializer(typeof(T));
        MemoryStream memoryStream = new MemoryStream(StringToUTF8ByteArray(pXmlizedString));
        return xs.Deserialize(memoryStream);
    }

    private string UTF8ByteArrayToString(byte[] characters) {
        UTF8Encoding encoding = new UTF8Encoding();
        string constructedString = encoding.GetString(characters);
        return (constructedString);
    }

    private byte[] StringToUTF8ByteArray(string pXmlString) {
        UTF8Encoding encoding = new UTF8Encoding();
        byte[] byteArray = encoding.GetBytes(pXmlString);
        return byteArray;
    }
}</pre></div></li><li><p>Add the<a id="id627" class="indexterm"></a> following C# script class to <span class="strong"><strong>Main Camera</strong></span>:</p><div class="informalexample"><pre class="programlisting">// file: SerialiseToXML.cs
using UnityEngine;
using System.Collections;
using System.Collections.Generic;

public class SerialiseToXML : MonoBehaviour {
    private string output = "(nothing yet)";

    void Start () {
        SerializeManager&lt;PlayerScore&gt; serializer = new SerializeManager&lt;PlayerScore&gt;();
        PlayerScore myData = new PlayerScore("matt", 200);
        output = serializer.SerializeObject(myData);
    }

    void OnGUI() {
        GUILayout.Label( output );
    }
}</pre></div></li><li><p>Run your game. You should see XML data displayed as a label on the screen.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec313"></a>How it works...</h3></div></div></div><p>The <code class="literal">Start()</code> method<a id="id628" class="indexterm"></a> creates <code class="literal">serializer</code>, a new <code class="literal">SerializeManager()</code> object<a id="id629" class="indexterm"></a> for objects of the <code class="literal">PlayerScore</code> class. A new <code class="literal">PlayerScore</code> object<a id="id630" class="indexterm"></a>, <code class="literal">myData</code>, is created with the values <code class="literal">"Matt"</code> and <code class="literal">200</code>. The <code class="literal">serializer</code> object is then passed the <code class="literal">myData</code> object, and the XML text data is returned as a string and stored in <code class="literal">output</code>. Our <code class="literal">OnGUI()</code> method displays the contents of <code class="literal">output</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note38"></a>Note</h3><p>The <code class="literal">SerializeManager</code> class has been adapted from the code published by EggHeadCafe at the following URL:</p><p><a class="ulink" href="http://www.eggheadcafe.com/articles/system.xml.xmlserialization.asp" target="_blank">www.eggheadcafe.com/articles/system.xml.xmlserialization.asp</a></p></div><p>You shouldn't need to worry too much about understanding all the code in this classâ€”unless you want to :-). We<a id="id631" class="indexterm"></a> have adapted the class so that it can be used for any data object class via C# generics; all you need to do is the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Replace <code class="literal">&lt;PlayerScore&gt;</code> with <code class="literal">&lt;YourDataClassName&gt;</code> when declaring and creating an instance of <code class="literal">SerializationManager</code>; in our example, this is in the first statement of the <code class="literal">Start()</code> method</p></li><li style="list-style-type: disc"><p>Pass in an object of your class as the argument to <code class="literal">serializer.SerializeObject()</code></p></li><li style="list-style-type: disc"><p>Ensure that your data class has a default constructor (that is public and takes no arguments)</p></li><li style="list-style-type: disc"><p>Make sure each property that you want included in the generated XML is public</p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note39"></a>Note</h3><p>The following site is a good place to learn more about Unity XML serialization:</p><p><a class="ulink" href="http://wiki.unity3d.com/index.php?title=Saving_and_Loading_Data:_XmlSerializer" target="_blank">http://wiki.unity3d.com/index.php?title=Saving_and_Loading_Data:_XmlSerializer</a></p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec314"></a>There's more...</h3></div></div></div><p>Some details you don't want to miss:</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch08lvl3sec72"></a>Protecting member properties with accessor methods</h4></div></div></div><p>Just having public <a id="id632" class="indexterm"></a>properties is generally considered poor practice, because any part of an application with a reference to an object can make any kind of changes to those properties. However, if you wish to use this serialization recipe, you have to have public properties.</p><p>A good solution is to provide public accessor methods, which behave like public properties but allow you to add a validation code behind the get/set methods for each corresponding hidden private property. Here, we have provided such an improved implementation of the <code class="literal">PlayerScore</code> class, <code class="literal">PlayerScore2</code>. Data is stored in the private variables <code class="literal">_name</code> and <code class="literal">_score</code>; they are accessed via the public variables <code class="literal">Name</code> and <code class="literal">Score</code>, which have get/set statements that handle changes to the private variables, and for which the appropriate validation logic could be implemented (for example, only changing <code class="literal">Score</code> if the new score is zero or higher, to prevent negative scores):</p><div class="informalexample"><pre class="programlisting">// file: PlayerScore2.cs
using System.Xml.Serialization;

[XmlRoot("player_score_2")]
public class PlayerScore2 
{
    private string _name; 
    private int _score;

    [XmlElement("name")]
    public string Name {
        get{ return _name; }
        set{ _name = value; }
    }

    [XmlElement("score")]
    public int Score {
        get{ return _score;}
        set{ _score = value;}
    }

    // default constructor, needed for serialization
    public PlayerScore2() {}

    public PlayerScore2(string newName, int newScore) {
        Name = newName;
        Score = newScore;
    }
}</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note40"></a>Note</h3><p>Variable naming styles vary between programmers and organizations. One approach <a id="id633" class="indexterm"></a>to naming private member variables is to prefix them with an underscore (as we have done in the previous code snippet). An alternative, which some programmers prefer, involves using no underscore and disambiguating the argument of a setter method from the member variable with the same identifier by using keyword <code class="literal">this</code>; for example, <code class="literal">this.name = name</code>.</p></div></div></div></div>