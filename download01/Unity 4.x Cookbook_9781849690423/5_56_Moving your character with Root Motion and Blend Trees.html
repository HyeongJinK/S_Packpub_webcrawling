<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec58"></a>Moving your character with Root Motion and Blend Trees</h2></div></div><hr /></div><p>The Mecanim animation system is capable of applying Root Motion<a id="id330" class="indexterm"></a> to characters. In other words, it actually moves the character according to the animation clip, as opposed to arbitrarily<a id="id331" class="indexterm"></a> translating the character <a id="id332" class="indexterm"></a>model while playing an in-place animation cycle. This makes most Mixamo animation clips perfect for use with Mecanim.</p><p>Another new feature for the animation system is Blend Trees, which can make transitions between animation states smooth and easy. In this recipe, we will take advantage of these new features to make our character walk and run forwards or backwards, and also strafe right and left, at different speeds.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec197"></a>Getting ready</h3></div></div></div><p>For this recipe, we have prepared a project named <code class="literal">MixamoProject</code>, containing several assets such as levels, animated characters, and props. You can find it inside the <code class="literal">0423_05_codes</code> folder.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec198"></a>How to do it...</h3></div></div></div><p>To apply Root Motion to your character using Blend Trees, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open the project, and then open the level named <span class="strong"><strong>05_02</strong></span> (inside the <span class="strong"><strong>Levels</strong></span> folder). Note that it includes a S.W.A.T. character that features the Animator component using the <span class="strong"><strong>swatController02</strong></span> Controller.</p></li><li><p>We need to configure our animation clips. From the <span class="strong"><strong>Original_Character</strong></span> folder, select the <span class="strong"><strong>Swat@rifle_run</strong></span> file.</p></li><li><p>Click on the <span class="strong"><strong>Rig</strong></span> tab. Change <span class="strong"><strong>Animation Type</strong></span> to <span class="strong"><strong>Humanoid</strong></span> and <span class="strong"><strong>Avatar Definition</strong></span> to <span class="strong"><strong>Copy From Other Avatar</strong></span>. Then, select <span class="strong"><strong>swatAvatar</strong></span> for <span class="strong"><strong>Source</strong></span> by choosing it from the list or dragging it from the <span class="strong"><strong>Project</strong></span> view into the slot. Confirm your changes by clicking on <span class="strong"><strong>Apply</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_08.jpg" /></div></li><li><p>Now click on the <span class="strong"><strong>Animations</strong></span> tab. Select the clip <span class="strong"><strong>rifle_run</strong></span> (from the <span class="strong"><strong>Clips</strong></span> list) and select<a id="id333" class="indexterm"></a> the <span class="strong"><strong>Loop Pose</strong></span> option. Under <span class="strong"><strong>Root Transform Rotation</strong></span>, check <a id="id334" class="indexterm"></a>
<span class="strong"><strong>Bake into Pose</strong></span> and set <span class="strong"><strong>Body Orientation</strong></span> for <span class="strong"><strong>Baked Upon (at Start)</strong></span>; Under<a id="id335" class="indexterm"></a> <span class="strong"><strong>Root Transform Position (Y)</strong></span>, check <span class="strong"><strong>Bake into Pose</strong></span> and set <span class="strong"><strong>Original</strong></span> for <span class="strong"><strong>Baked Upon (at Start)</strong></span>; Under <span class="strong"><strong>Root Transform Position (XZ)</strong></span>, leave the <span class="strong"><strong>Bake into Pose</strong></span> checkbox deselected. Finally, click on the <span class="strong"><strong>Clamp Range</strong></span> button to adjust the timeline (shown in the following screenshot). Click on <span class="strong"><strong>Apply</strong></span> to confirm changes.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_09.jpg" /></div></li><li><p>Repeat steps 3 and 4 for <a id="id336" class="indexterm"></a>each one of the following animation clips inside the <span class="strong"><strong>Original_Character</strong></span> folder: <span class="strong"><strong>Swat@run_backwards</strong></span>, <span class="strong"><strong>Swat@strafe</strong></span>, <span class="strong"><strong>Swat@strafe_2</strong></span>, <span class="strong"><strong>Swat@strafe_left</strong></span>, <span class="strong"><strong>Swat@strafe_right</strong></span>, <span class="strong"><strong>Swat@walking</strong></span>, and <span class="strong"><strong>Swat@walking_backwards</strong></span>.</p></li><li><p>From the <span class="strong"><strong>Hierarchy</strong></span> view, <a id="id337" class="indexterm"></a>select the <span class="strong"><strong>Swat</strong></span> game object and attach a Character Controller component<a id="id338" class="indexterm"></a> to it by going to <span class="strong"><strong>Component</strong></span> | <span class="strong"><strong>Physics</strong></span> | <span class="strong"><strong>Character Controller</strong></span>. Then, set the following coordinates for <span class="strong"><strong>Center</strong></span>: (<code class="literal">0</code>, <code class="literal">0.9</code>, <code class="literal">0</code>); change the entry in the <span class="strong"><strong>Radius</strong></span> field to <code class="literal">0.34</code> and the <span class="strong"><strong>Height</strong></span> field to <code class="literal">1.79</code>:</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_10.jpg" /></div></li><li><p>In the <span class="strong"><strong>Project</strong></span> view, open the <span class="strong"><strong>swatController02</strong></span> Controller.</p></li><li><p>In the bottom-left <a id="id339" class="indexterm"></a>corner of the <span class="strong"><strong>Animator</strong></span> view, create three new parameters (Float values) named <code class="literal">xSpeed</code>, <code class="literal">zSpeed</code>, and <code class="literal">Speed</code>.</p></li><li><p>Also, right-click on the <a id="id340" class="indexterm"></a>gridded<a id="id341" class="indexterm"></a> area and, from the context menu, select <span class="strong"><strong>From New Blend Tree</strong></span> under <span class="strong"><strong>Create State</strong></span>. Change its name to <span class="strong"><strong>Move</strong></span> in the <span class="strong"><strong>Inspector</strong></span> view.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_11.jpg" /></div></li><li><p>Double-click on the <span class="strong"><strong>Move</strong></span> state. You will see the empty Blend Tree you have created. Select<a id="id342" class="indexterm"></a> it and rename it to <span class="strong"><strong>Move</strong></span> in the <span class="strong"><strong>Inspector</strong></span> view.</p></li><li><p>In the <span class="strong"><strong>Inspector</strong></span> view, below the diagram on the top, leave the parameter in the <a id="id343" class="indexterm"></a>drop-down<a id="id344" class="indexterm"></a> menu as <span class="strong"><strong>xSpeed</strong></span>, but change the parameter values to <code class="literal">-1</code> and <code class="literal">1</code>. Also, use the button with the <span class="strong"><strong>+</strong></span> sign to add three new Blend Trees. From top to bottom, rename them as <code class="literal">StrafeLeft</code>, <code class="literal">WalkRun</code>, and <code class="literal">StrafeRight</code>.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_12.jpg" /></div></li><li><p>Select the <span class="strong"><strong>WalkRun</strong></span> node. In the <span class="strong"><strong>Inspector</strong></span> view, change the parameter to <span class="strong"><strong>zSpeed</strong></span>. Then,<a id="id345" class="indexterm"></a> change the parameter<a id="id346" class="indexterm"></a> values to <code class="literal">-2</code> and <code class="literal">2</code>, and use the button with the <span class="strong"><strong>+</strong></span> sign to add five Motion fields.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_13.jpg" /></div></li><li><p>Now, fill the Motion list with the following clips (from top to bottom): <span class="strong"><strong>run_backwards</strong></span>, <span class="strong"><strong>walking_backwards</strong></span>, <span class="strong"><strong>rifle_aiming_idle</strong></span>, <span class="strong"><strong>walking</strong></span>, and <span class="strong"><strong>rifle_run</strong></span>. You <a id="id347" class="indexterm"></a>can do this either by selecting them from the list, or if there is more than one clip with the same name, dragging them from the <span class="strong"><strong>Project</strong></span> view into the slot (by expanding the appropriate model icon).</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_14.jpg" /></div></li><li><p>Select<a id="id348" class="indexterm"></a> the <span class="strong"><strong>StrafeLeft</strong></span> node. In the <span class="strong"><strong>Inspector</strong></span> view, keep its parameter as <span class="strong"><strong>xSpeed</strong></span> but<a id="id349" class="indexterm"></a> change the<a id="id350" class="indexterm"></a> parameter values to <code class="literal">-2</code> and <code class="literal">0</code>; use the button with the <span class="strong"><strong>+</strong></span> sign to add three Motion fields.</p></li><li><p>Fill the Motion list with the following clips (from top to bottom): <span class="strong"><strong>strafe</strong></span>, <span class="strong"><strong>strafe_left</strong></span>, and <span class="strong"><strong>rifle_aiming_idle</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_15.jpg" /></div></li><li><p>Select the <span class="strong"><strong>StrafeRight</strong></span> node. In the <span class="strong"><strong>Inspector</strong></span> view, keep its parameter as <span class="strong"><strong>xSpeed</strong></span> but change the parameter values to <code class="literal">0</code> and <code class="literal">2</code>; use the button with the <span class="strong"><strong>+</strong></span> sign to add three Motion fields.</p></li><li><p>Fill the Motion list with the following clips (from top to bottom): <span class="strong"><strong>rifle_aiming_idle</strong></span>, <span class="strong"><strong>strafe_right</strong></span>, and <span class="strong"><strong>strafe_2</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_16.jpg" /></div></li><li><p>Let's go back<a id="id351" class="indexterm"></a> to the<a id="id352" class="indexterm"></a> base <a id="id353" class="indexterm"></a>layer. In the <span class="strong"><strong>Animator</strong></span> view, double-click on the gridded area or click on the <span class="strong"><strong>Base Layer</strong></span> tab.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_17.jpg" /></div></li><li><p>Right-click on the <span class="strong"><strong>Idle</strong></span> state box and select <span class="strong"><strong>Make Transition</strong></span> from the menu. Then, drag the white arrow into the <span class="strong"><strong>Move</strong></span> box.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_18.jpg" /></div></li><li><p>Select the arrow (it should turn blue). In the <span class="strong"><strong>Inspector</strong></span> view, we can now configure the conditions<a id="id354" class="indexterm"></a> that determine when and how the transition<a id="id355" class="indexterm"></a> from <span class="strong"><strong>Idle</strong></span> to <span class="strong"><strong>Move</strong></span> is made.</p></li><li><p>In the <span class="strong"><strong>Conditions</strong></span><a id="id356" class="indexterm"></a> box, select the options <span class="strong"><strong>Speed</strong></span>, <span class="strong"><strong>Greater</strong></span>, and <span class="strong"><strong>0.1</strong></span>. Then, expand the <span class="strong"><strong>BlendTree Parameters</strong></span> section, change <span class="strong"><strong>zSpeed</strong></span> to <code class="literal">2</code> and click on the play icon in the <span class="strong"><strong>Preview</strong></span> window. That should give you an idea on how the transition will be made.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_19.jpg" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note15"></a>Note</h3><p>You can experiment with narrowing and widening the blue segment of the timeline by using the handles to get a smoother transition.</p></div></li><li><p>Now <a id="id357" class="indexterm"></a>create a <a id="id358" class="indexterm"></a>transition <a id="id359" class="indexterm"></a>from the <span class="strong"><strong>Move</strong></span> box to the <span class="strong"><strong>Idle</strong></span> box. Then, select the arrow representing it.</p></li><li><p>In the <span class="strong"><strong>Conditions</strong></span> box, change the parameters to <span class="strong"><strong>Speed</strong></span>, <span class="strong"><strong>Less</strong></span>, and <span class="strong"><strong>0.1</strong></span> (as shown in the following screenshot):</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_20.jpg" /></div></li><li><p>Now that <a id="id360" class="indexterm"></a>we have established our animation states and transitions, we must create the script <a id="id361" class="indexterm"></a>that <a id="id362" class="indexterm"></a>will actually transform the player's input into those variables created to control the animation.</p></li><li><p>From the <span class="strong"><strong>Project</strong></span> view, create a new C# script and name it <code class="literal">BasicController02</code>.</p></li><li><p>Open your script and replace everything with the following code:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class BasicController02 : MonoBehaviour {
    private Animator animator;
    private CharacterController controller;
    public float transitionTime = 0.25f;

    void Start () {
        controller = GetComponent&lt;CharacterController&gt;();
        animator = GetComponent&lt;Animator&gt;();
        if(animator.layerCount &gt;= 2)
            animator.SetLayerWeight(1, 1);
    }

    void Update () {
        float accelerator = 1.0f;
        if(controller.isGrounded){
            if (Input.GetKey (KeyCode.RightShift) ||Input.GetKey (KeyCode.LeftShift) ){
                accelerator = 2.0f;
            } else if(Input.GetKey (KeyCode.RightAlt) ||Input.GetKey (KeyCode.LeftAlt) ){
                accelerator = 1.5f;
            } else {
                accelerator = 1.0f;
            }
            float h = Input.GetAxis("Horizontal");
            float v = Input.GetAxis("Vertical");
            float xSpeed = h * accelerator;
            float zSpeed = v * accelerator;
            animator.SetFloat("xSpeed", xSpeed, transitionTime, Time.deltaTime);
            animator.SetFloat("zSpeed", zSpeed, transitionTime, Time.deltaTime);
            animator.SetFloat("Speed", Mathf.Sqrt(h*h+v*v), transitionTime, Time.deltaTime);
            //transform.Rotate(Vector3.up * (Time.deltaTime * v * Input.GetAxis("Mouse X") * 90), Space.World);
        }
    }
}</pre></div></li><li><p>Save your<a id="id363" class="indexterm"></a> script and<a id="id364" class="indexterm"></a> attach it to the <span class="strong"><strong>Swat</strong></span> game object in the <span class="strong"><strong>Hierarchy</strong></span> view.</p></li><li><p>Play your<a id="id365" class="indexterm"></a> scene and test the game. You should be able to control your character with the arrow keys (or the <span class="emphasis"><em>W</em></span>, <span class="emphasis"><em>A</em></span>, <span class="emphasis"><em>S</em></span>, and <span class="emphasis"><em>D</em></span> keys). You should also be able to get your character to run by pressing the <code class="literal">Shift</code> key or walk faster by pressing <span class="emphasis"><em>Alt</em></span>.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec199"></a>How it works...</h3></div></div></div><p>Our script will detect the user's keyboard input and translate it into variables to be passed to the Animator Controller as its parameters <span class="strong"><strong>Speed</strong></span>, <span class="strong"><strong>xSpeed</strong></span>, and <span class="strong"><strong>vSpeed</strong></span>. These parameters will determine which animation clips should be played. For instance, if the player presses the down arrow and <span class="emphasis"><em>Shift</em></span> keys together, the parameters <span class="strong"><strong>Speed</strong></span>, <span class="strong"><strong>xSpeed</strong></span>, and <span class="strong"><strong>vSpeed</strong></span> will be passed with the values <code class="literal">1</code>, <code class="literal">0</code>, and <code class="literal">-2</code> respectively. A positive value for <span class="strong"><strong>Speed</strong></span> will trigger the transition from the <span class="strong"><strong>Idle</strong></span> state to the <span class="strong"><strong>Move</strong></span> state. Furthermore, an <span class="strong"><strong>xSpeed</strong></span> value of <code class="literal">0</code>, indicating that the left and right arrow keys are not being pressed, will favor the <span class="strong"><strong>WalkRun</strong></span> Blend Tree and not <span class="strong"><strong>StrafeLeft</strong></span> and <span class="strong"><strong>StrafeRight</strong></span>. Finally, the <span class="strong"><strong>vSpeed</strong></span> parameter (with a value of <code class="literal">-2</code>) will play the <span class="strong"><strong>walking_backwards</strong></span> motion clip within the <span class="strong"><strong>WalkRun</strong></span> Blend Tree. The character will then move according to the animation being played. Observe how pressing the <span class="emphasis"><em>Alt</em></span> key actually blends the animation clips for walking and running in real time.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec200"></a>There's more...</h3></div></div></div><p>If you want to learn more about Mecanim's animation system, there are some links you might want to check out, such as Unity's documentation at <a class="ulink" href="http://docs.unity3d.com/Documentation/Manual/MecanimAnimationSystem.html" target="_blank">http://docs.unity3d.com/Documentation/Manual/MecanimAnimationSystem.html</a>.</p><p>You can also check out Mecanim Example Scenes<a id="id366" class="indexterm"></a>, available at the Unity Asset Store at <a class="ulink" href="http://u3d.as/content/unity-technologies/mecanim-example-scenes/3Bs" target="_blank">http://u3d.as/content/unity-technologies/mecanim-example-scenes/3Bs</a> and the Mecanim video tutorials, at <a class="ulink" href="http://video.unity3d.com/video/7362044/unity-40-mecanim-animation" target="_blank">http://video.unity3d.com/video/7362044/unity-40-mecanim-animation</a>.</p></div></div>