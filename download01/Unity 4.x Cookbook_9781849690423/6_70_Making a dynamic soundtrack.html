<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec71"></a>Making a dynamic soundtrack</h2></div></div><hr /></div><p>Dynamic soundtracks<a id="id474" class="indexterm"></a> are the ones that change according to what is happening to the player in the game, musically reflecting that place or moment of the character's adventure. In this recipe, we will implement a soundtrack that changes when the player reaches specific targets. Also, we will have the option of fading the sound in and out.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec245"></a>Getting ready</h3></div></div></div><p>For this recipe, we have prepared a basic level and some soundtrack audio files in <code class="literal">.ogg</code> format. They are contained inside the Unity package named <code class="literal">DynamicSoundtrack</code>, which can be found in the <code class="literal">0423_06_06</code> folder.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec246"></a>How to do it...</h3></div></div></div><p>To make a <a id="id475" class="indexterm"></a>dynamic soundtrack, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Import the <code class="literal">DynamicSoundtrack</code> package into your Unity project. Also, import the <code class="literal">00_main</code>, <code class="literal">01_achievement</code>, and <code class="literal">02_danger</code> audio files.</p></li><li><p>Open the level named <span class="strong"><strong>SoundtrackScene</strong></span>. It should include a basic terrain, a <span class="strong"><strong>3rd Person Controller</strong></span> and three spheres named <code class="literal">Music Sphere</code>.</p></li><li><p>In the <span class="strong"><strong>Project</strong></span> view, create a new C# script and name it <code class="literal">DynamicSoundtrack</code>.</p></li><li><p>Open the script in your editor and replace everything with the following code:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class DynamicSoundtrack : MonoBehaviour{
    public AudioClip[] clips;
    public int startingTrack = 0;
    private int currentTrack;
    private int nextTrack;
    private bool isFadingOut = false;
    private float fadeOutTime = 1.0f;
    private bool isFadingIn = false;
    private float fadeInTime = 1.0f;
    private bool waitSequence = true;
    private bool keepTime = false;
    private float targetVolume = 1.0f;
    private float oldVolume = 0.0f;
    private float fadeOutStart = 0.0f;
    private float fadeInStart = 0.0f;

    void Start(){
        audio.clip = clips[startingTrack];
        audio.Play();
        currentTrack = startingTrack;
    }

    void Update(){
        if (isFadingOut){
            if (audio.volume &gt; 0){
                float elapsOut = Time.time - fadeOutStart;
                float indOut = elapsOut / fadeOutTime;
                audio.volume = oldVolume - (indOut * oldVolume);
            }else{
                isFadingOut = false;
                StartCoroutine(PlaySoundtrack());
            }
        }

        if (isFadingIn){
            if (audio.volume &lt; targetVolume){
                float elapsIn = Time.time - fadeInStart;
                float indIn = elapsIn / fadeInTime;
                audio.volume = indIn;
            }else{
                audio.volume = targetVolume;
                isFadingIn = false;
            }
        }
    }

    public void ChangeSoundtrack(int newClip, bool waitForSequence, bool keepPreviousTime, float trackVolume, float fadeIn, float fadeOutPrevious){
        nextTrack = newClip;
        waitSequence = waitForSequence;
        keepTime = keepPreviousTime;
        targetVolume = trackVolume;
        fadeInTime = fadeIn;

        if (newClip != currentTrack){
            currentTrack = newClip;
            if (fadeOutPrevious != 0){
                oldVolume = audio.volume;
                fadeOutStart = Time.time;
                fadeOutTime = fadeOutPrevious;
                isFadingOut = true;
            }else{
                StartCoroutine(PlaySoundtrack());
            }
        }
    }
    IEnumerator PlaySoundtrack(){
        if (waitSequence)
            yield return new WaitForSeconds(audio.clip.length - ((float)audio.timeSamples / (float)audio.clip.frequency));
  
if(fadeInTime !=0){
    audio.volume = 0;
    fadeInStart = Time.time;
    isFadingIn = true;
        }
        float StartingPoint = 0.0f;
        if (keepTime)
            StartingPoint = audio.timeSamples;

        audio.clip = clips[nextTrack];
        audio.timeSamples = Mathf.RoundToInt(StartingPoint);
        audio.Play();
    }
}</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note17"></a>Note</h3><p>In case you are wondering why we are using <code class="literal">timeSamples</code> instead of <code class="literal">time</code>, it's because the former is more accurate when working with compressed audio files. To find out its actual time, we used the expression <code class="literal">audio.timeSamples / audio.clip.frequency</code>. As this is not currently documented in Unity's Scripting Reference, we thank audio engineer Aldo Naletto for this tip (and reviewer Peter Bruun for reminding us of using <code class="literal">float</code>, for more precision).</p></div></li><li><p>Save your <a id="id476" class="indexterm"></a>script and attach it to the <span class="strong"><strong>Main Camera</strong></span> by dragging it from the <span class="strong"><strong>Project</strong></span> view to the <span class="strong"><strong>Main Camera</strong></span> game object in the <span class="strong"><strong>Hierarchy</strong></span> view.</p></li><li><p>Select the <span class="strong"><strong>Main Camera</strong></span> and, in the <span class="strong"><strong>Inspector</strong></span> view, access the <span class="strong"><strong>Dynamic Soundtrack</strong></span> component and change the <span class="strong"><strong>Size</strong></span> parameter of the <span class="strong"><strong>Clips</strong></span> variable to <span class="strong"><strong>3</strong></span>. Then, drag the <code class="literal">0_Main</code>, <code class="literal">1_Achievement</code>, and <code class="literal">2_Danger</code> sound files from the <span class="strong"><strong>Project</strong></span> view into the appropriate slots. Also, type in <code class="literal">0</code> into the slot named <span class="strong"><strong>Starting Track</strong></span>:</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_06_13.jpg" /></div></li><li><p>Now, access the <span class="strong"><strong>Audio Source</strong></span> component and make sure the <span class="strong"><strong>Loop</strong></span> option is checked:</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_06_14.jpg" /></div></li><li><p>In the <a id="id477" class="indexterm"></a>
<span class="strong"><strong>Project</strong></span> view, create a new C# script and name it <code class="literal">TriggerSoundtrack</code>.</p></li><li><p>Open the script in your editor and replace everything with the following code:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class TriggerSoundtrack : MonoBehaviour{
    public bool waitForSequence = true;
    public bool keepTimeAndVolume = false;
    public float trackVolume = 1.0f;
    public float fadeIn = 0.0f;
    public float fadeOutPrevious = 0.0f;
    public int clip;
    private DynamicSoundtrack soundtrack;

    void Awake(){
        soundtrack = Camera.main.GetComponent&lt;DynamicSoundtrack&gt;();
    }
    void OnTriggerEnter(Collider other){
        if (other.gameObject.CompareTag("Player"))
            soundtrack.ChangeSoundtrack(clip, waitForSequence, keepTimeAndVolume, trackVolume, fadeIn, fadeOutPrevious);
    }
}</pre></div></li><li><p>Save your <a id="id478" class="indexterm"></a>script and attach it to the each one of the music spheres by dragging it from the <span class="strong"><strong>Project</strong></span> view to the <span class="strong"><strong>Main Camera</strong></span> game object in the <span class="strong"><strong>Hierarchy</strong></span> view.</p></li><li><p>Select each <span class="strong"><strong>Music Sphere</strong></span> object and, in the <span class="strong"><strong>Inspector</strong></span> view, change the <span class="strong"><strong>Trigger Soundtrack</strong></span> parameters, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_06_15.jpg" /></div></li><li><p>Play your scene and direct the character towards each <span class="strong"><strong>Music Sphere</strong></span> object. The background music will change accordingly.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec247"></a>How it works...</h3></div></div></div><p>We have <a id="id479" class="indexterm"></a>created two different scripts. The one attached to the <span class="strong"><strong>Main Camera</strong></span>, <span class="strong"><strong>DynamicSoundtrack</strong></span>, is responsible for keeping a list of the audio files that make up the entire soundtrack for the level. It also contains all of the functions that control the audio playback, volume transition, and so on. The second one, <span class="strong"><strong>TriggerSoundtrack</strong></span>, is attached to the <span class="strong"><strong>Music Sphere</strong></span> objects and triggers soundtrack changes based on the preferences expressed in that component's parameters. They are:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Wait For Sequence</strong></span>: Leave this option checked if you want to wait until the end of the previous audio clip before playing the new part.</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Keep Time And Volume</strong></span>: Leave it checked to start a new audio clip from the same point where the previous clip was at. This also keeps the volume level from the previous clip.</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Track Volume</strong></span>: The volume for the new audio clip (from 0.0 to 1.0).</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Fade In</strong></span>: The amount of time in seconds it will take for the new audio clip's volume to fade in.</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Fade Out Previous</strong></span>: The <a id="id480" class="indexterm"></a>amount of time in seconds it will take for the previous audio clip's volume to fade out.</p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec248"></a>There's more...</h3></div></div></div><p>Here is some information on how to fine-tune and customize this recipe.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec56"></a>Hiding the triggers</h4></div></div></div><p>If having milestone objects as triggers feels too obvious for you and your players, you can always make it invisible by disabling the <span class="strong"><strong>Mesh Renderer</strong></span> component.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec57"></a>Dealing with audio file formats and compression rates</h4></div></div></div><p>To avoid loss of audio quality, you should import your sound clips using the appropriate file format, depending on your target platform. If you are not sure which format to use, please check out Unity's documentation on this subject at <a class="ulink" href="http://docs.unity3d.com/Documentation/Manual/AudioFiles.html" target="_blank">http://docs.unity3d.com/Documentation/Manual/AudioFiles.html</a>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec58"></a>Using 2D sound</h4></div></div></div><p>To make the sound volume and balance independent of the audio source position, make sure your audio clip is not set up as <span class="strong"><strong>3D Sound</strong></span> (you can check it out at <span class="strong"><strong>Import Settings</strong></span> in the <span class="strong"><strong>Inspector</strong></span> view, by selecting the file in the <span class="strong"><strong>Project</strong></span> view).</p></div></div></div>