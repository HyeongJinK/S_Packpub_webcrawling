<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec101"></a>Managing complex object behavior with the state pattern</h2></div></div><hr /></div><p>The previous pattern not<a id="id740" class="indexterm"></a> only illustrated the usefulness of modeling game states, but also how a game manager class can grow in size and become unmanageable. To manage the complexity of many states and complex behaviors of states, the <span class="strong"><strong>state pattern</strong></span><a id="id741" class="indexterm"></a> has been proposed in the software development community. <span class="strong"><strong>Design patterns</strong></span> <a id="id742" class="indexterm"></a>are general purpose software component architectures that have been tried and tested and found to be good solutions to commonly occurring software system features. The key features of the state pattern are that each state is modeled by its own class, and all states inherit (are sub-classed) from a single parent state class. The states need to know about each other in order to tell the game manager to change the current state. This is a small price to pay for the division of the complexity of the overall game behaviors into separate state classes.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec353"></a>How to do it...</h3></div></div></div><p>To manage an <a id="id743" class="indexterm"></a>object's behavior using the state pattern architecture, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new C# script class called <code class="literal">GameState</code>:</p><div class="informalexample"><pre class="programlisting">// file: GameState
using UnityEngine;
using System.Collections;

public abstract class GameState : MonoBehaviour {
  protected GameManager gameManager;
  protected void Awake() {
    gameManager = GetComponent&lt;GameManager&gt;();
  }

  public abstract void OnStateEntered();
  public abstract void OnStateExit();
  public abstract void StateUpdate();
  public abstract void StateGUI();
}</pre></div></li><li><p>Add the following script class to the <span class="strong"><strong>Main Camera</strong></span>:</p><div class="informalexample"><pre class="programlisting">// file: GameManager
using UnityEngine;
using System.Collections;

public class GameManager : MonoBehaviour {

  public StateGamePlaying stateGamePlaying;
  public StateGameWon stateGameWon;
  public StateGameLost stateGameLost;

  private GameState currentState;

  private void Awake () {
    stateGamePlaying = GetComponent&lt;StateGamePlaying&gt;();
    stateGameWon = GetComponent&lt;StateGameWon&gt;();
    stateGameLost = GetComponent&lt;StateGameLost&gt;();
  }

  private void Start () {
    NewGameState( stateGamePlaying );
  }

  private void Update () {
    if (currentState != null)
      currentState.StateUpdate();
  }
  
  private void OnGUI () {
    if (currentState != null)
      currentState.StateGUI();
  }

  public void NewGameState(GameState newState)
  {
    if( null != currentState)
      currentState.OnStateExit();

    currentState = newState;
    currentState.OnStateEntered();
  }
}</pre></div></li><li><p>Also add<a id="id744" class="indexterm"></a> the following script class to the <span class="strong"><strong>Main Camera</strong></span>:</p><div class="informalexample"><pre class="programlisting">// file: StateGamePlaying
using UnityEngine;
using System.Collections;

public class StateGamePlaying : GameState {
  public override void OnStateEntered(){}
  public override void OnStateExit(){}

  public override void StateGUI() {
    GUILayout.Label("state: GAME PLAYING");
    bool winGameButtonClicked = GUILayout.Button("WIN the game");
    bool loseGameButtonClicked = GUILayout.Button("LOSE the game");

    if( winGameButtonClicked )
      gameManager.NewGameState(gameManager.stateGameWon);

    if( loseGameButtonClicked )
      gameManager.NewGameState(gameManager.stateGameLost);
  }


  public override void StateUpdate() {	
    print ("StateGamePlaying::StateUpdate() - would do something here"); 
  }
}</pre></div></li><li><p>Then add the <a id="id745" class="indexterm"></a>following script class to the <span class="strong"><strong>Main Camera</strong></span>:</p><div class="informalexample"><pre class="programlisting">// file: StateGameWon
using UnityEngine;
using System.Collections;

public class StateGameWon : GameState {
  public override void OnStateEntered(){}
  public override void OnStateExit(){}

  public override void StateGUI() {
    GUILayout.Label("state: GAME WON");
  }

  public override void StateUpdate() {	
    print ("StateGameWon::StateUpdate() - would do something here"); 
  }
}</pre></div></li><li><p>Add the following script class to the <span class="strong"><strong>Main Camera</strong></span> too:</p><div class="informalexample"><pre class="programlisting">// file: StateGameLost
using UnityEngine;
using System.Collections;

public class StateGameLost : GameState {
  public override void OnStateEntered(){}
  public override void OnStateExit(){}

  public override void StateGUI() {
    GUILayout.Label("state: GAME LOST");
  }
  
  public override void StateUpdate() {
    print ("StateGameLost::StateUpdate() - would do something here"); 
  }
}</pre></div></li><li><p>The following screenshot shows how the <span class="strong"><strong>Main Camera</strong></span> has scripted components for the <code class="literal">GameManager</code> object, and each of the three state objects (<code class="literal">StateGameLost</code>, <code class="literal">StateGamePlaying</code>, and <code class="literal">StateGameWon</code>):</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_09_15.jpg" /></div></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec354"></a>How it works...</h3></div></div></div><p>The scene is very <a id="id746" class="indexterm"></a>straightforward for this recipe. There is the single GameObject <span class="strong"><strong>Main Camera</strong></span> which has four scripted object components attached to it:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">GameManager</code></p></li><li style="list-style-type: disc"><p><code class="literal">StateGamePlaying</code></p></li><li style="list-style-type: disc"><p><code class="literal">StateGameLost</code></p></li><li style="list-style-type: disc"><p><code class="literal">StateGameWon</code></p></li></ul></div><p>The <code class="literal">GameManager</code> class <a id="id747" class="indexterm"></a>has three public variables, one for each of the states (<code class="literal">StateGamePlaying</code>, <code class="literal">StateGameLost</code>, and <code class="literal">StateGameWon</code>). While these public variables are unassigned before the game runs, when the <code class="literal">Awake()</code> method is executed, <code class="literal">GetComponent()</code> statements are used to assigned these variables to the three state object components in the <span class="strong"><strong>Main Camera</strong></span>. See the information box to understand why this is necessary.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note49"></a>Note</h3><p><span class="strong"><strong>Cannot create MonoBehavior objects with the "new" keyword</strong></span></p><p>If we want our state objects to be able to respond to Unity messages such as <code class="literal">Update()</code> and <code class="literal">OnGUI()</code>,the <code class="literal">State</code> class must inherit from <code class="literal">MonoBehavior</code>. However, due to the way Unity works, <code class="literal">MonoBehavior</code> objects cannot be created using the <code class="literal">new</code> keyword.</p><p>The straightforward solution to this is to attach an object of each state to the same <code class="literal">GameObject</code> as the <code class="literal">GameManager</code>. The <code class="literal">GameManager</code> object is then able to use <code class="literal">GetComponent()</code> statements to access each state of the objects.</p><p>Another alternative would be to use Prefabs and <code class="literal">Instantiate()</code>.</p></div><p>The <code class="literal">GameManager</code> class has one other variable <code class="literal">currentState</code>, which is a reference to the current state object at any time while the game runs (initially, it will be <code class="literal">null</code>). Since it is of the <code class="literal">GameState</code> class (the parent of all state classes), it can refer to any of the different state objects.</p><p>After <code class="literal">Awake()</code>, <code class="literal">GameManager</code> will receive a <code class="literal">Start()</code> message. This method initializes the <code class="literal">currentState</code> to be the <code class="literal">gamePlayingState</code> object.</p><p>For each frame, the <code class="literal">GameManager</code> will receive <code class="literal">Update()</code> and <code class="literal">OnGUI()</code> messages. Upon receiving these messages, <code class="literal">GameManager</code> sends <code class="literal">StateUpdate()</code> and <code class="literal">StateGUI()</code> messages to the <code class="literal">currentState</code> object. So for each frame the object for the current state of the game will execute those methods. For example, when the <code class="literal">currentState</code> is set to game playing, for each frame the <code class="literal">gamePlayingObject</code> will display the win/lose GUI buttons, and will print a console message.</p><p>When the user clicks on a button, the <code class="literal">gamePlayingObject</code> will call the <code class="literal">GameManager</code> instance's <code class="literal">NewState()</code> method<a id="id748" class="indexterm"></a>, passing it the object corresponding to the new state. So if the user clicks on <span class="strong"><strong>Win the Game</strong></span>, the <code class="literal">NewState()</code> method is passed <code class="literal">gameManager.stateGameWon</code>.</p><p>A C# scripted class is defined for each state that the game needs to manage, for this example the three states <code class="literal">StateGamePlaying</code>, <code class="literal">StateGameWon</code> and <code class="literal">StateGameLost</code>. Each of these state classes is a subclass of <code class="literal">GameState</code>. <code class="literal">GameState</code> defines properties and methods that all subclass states will possess:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The variable <code class="literal">g</code>
<code class="literal">ameManager</code>: so each state object has a link to the game manager)</p></li><li style="list-style-type: disc"><p>The method <code class="literal">Awake()</code>: that automatically makes variable <code class="literal">gameManager</code> refer to the <code class="literal">GameManage</code>
<code class="literal">r</code> object in the Main Camera once the scene is running)</p></li><li style="list-style-type: disc"><p>The four abstract methods <code class="literal">OnStateEntered()</code>, <code class="literal">OnStateExit()</code>, <code class="literal">StateUpdate()</code> and <code class="literal">StateGUI()</code>: abstract methods must have their own implementation for each subclass</p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec355"></a>See also</h3></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <span class="emphasis"><em>Managing object behavior with states</em></span> recipe</p></li></ul></div></div></div>