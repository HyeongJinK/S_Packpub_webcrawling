<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec112"></a>Spreading long computations over several frames with coroutines</h2></div></div><hr /></div><p>Coroutines allow us<a id="id856" class="indexterm"></a> to write asynchronous codeâ€”we can ask a method to go off and calculate something, but the rest of the game can keep on running without having to wait for that calculation to end. Or we can call a coroutine method for each<a id="id857" class="indexterm"></a> frame from <code class="literal">Update()</code>and organize the method to complete part of a complex calculation each time it is called. When games start requiring complex computations, such as for artificial intelligence reasoning, it may not be possible to maintain acceptable game performance when trying to complete all calculations in a single frame; this is where coroutines can be an excellent solution.</p><p>This recipe illustrates how a complex calculation can be structured into several pieces, each to be completed one frame at a time.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note53"></a>Note</h3><p>An excellent description of coroutines (and other Unity topics) can be found on Ray Pendergraph's wikidot website at <a class="ulink" href="http://raypendergraph.wikidot.com/unity-developer-s-notes#toc6" target="_blank">http://raypendergraph.wikidot.com/unity-developer-s-notes#toc6</a>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec391"></a>How to do it...</h3></div></div></div><p>To spread computations over several frames, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Add the following script class <code class="literal">SegmentedCalculation.cs</code> in the <span class="strong"><strong>Main Camera</strong></span>:</p><div class="informalexample"><pre class="programlisting">// file: SegmentedCalculation.cs
using UnityEngine;
using System.Collections;

public class SegmentedCalculation : MonoBehaviour {
  private const int ARRAY_SIZE = 50;
  private const int SEGMENT_SIZE = 10;
  private int[] randomNumbers;

  private void Awake(){
    randomNumbers = new int[ARRAY_SIZE];
    for(int i=0; i&lt;ARRAY_SIZE; i++){
      randomNumbers[i] = Random.Range(0, 1000);
    }

    StartCoroutine( FindMinMax() );
  }

  private IEnumerator FindMinMax() {
    int min = 9999;
    int max = -1;

    for(int i=0; i&lt;ARRAY_SIZE; i++){
      if( i % SEGMENT_SIZE == 0){
        print("frame: " + Time.frameCount + ", i:" + i + ", min:" + min + ", max:" + max);

        // suspend for 1 frame since we've completed another segment
        yield return null;
      }

      if( randomNumbers[i] &gt; max){
        max = randomNumbers[i];
      } else if( randomNumbers[i] &lt; min){
        min = randomNumbers[i];
      }
    }

    // disable this scripted component
    print("** completed - disabling scripted component");
    enabled = false;
  }
}</pre></div></li><li><p>When <a id="id858" class="indexterm"></a>you<a id="id859" class="indexterm"></a> run the scene, you should see something similar to the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>frame:  1, i:0, min:9999, max:-1</strong></span>
<span class="strong"><strong>frame:  2, i:10, min:30, max:793</strong></span>
<span class="strong"><strong>frame:  3, i:20, min:30, max:892</strong></span>
<span class="strong"><strong>frame:  4, i:30, min:4, max:892</strong></span>
<span class="strong"><strong>frame:  5, i:40, min:4, max:905</strong></span>
<span class="strong"><strong>** completed - disabling scripted component</strong></span>
</pre></div></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec392"></a>How it works...</h3></div></div></div><p>An array called <code class="literal">randomNumbers</code> of random integers is created in <code class="literal">Awake()</code>. Then the <code class="literal">FindMinMax()</code> method is started as a coroutine. The size of the array is defined by the <code class="literal">ARRAY_SIZE</code> constant, and the number of elements to process each frame by <code class="literal">SEGMENT_SIZE</code>.</p><p>The <code class="literal">FindMinMax()</code> method<a id="id860" class="indexterm"></a>
<a id="id861" class="indexterm"></a> sets initial values for <code class="literal">min</code> and <code class="literal">max</code> and begins to loop through the array. If the current index is divisible <a id="id862" class="indexterm"></a>by the <code class="literal">SEGMENT_SIZE</code> (remainder 0), then we make the method display the current frame number and variable values, and suspend execution for one frame with a <code class="literal">yield null</code> statement. For each loop, the value for the current array index is compared with <code class="literal">min</code> and <code class="literal">max</code>, and those values are updated if a new minimum or maximum has been found. When the loop is completed, the scripted component disables itself.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec393"></a>There's more...</h3></div></div></div><p>The following are some details you don't want to miss:</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch10lvl3sec90"></a>Retrieving the complete Unity log text files from your system</h4></div></div></div><p>As well as seeing<a id="id863" class="indexterm"></a> log texts in the <span class="strong"><strong>Console</strong></span> panel, you can also access the Unity editor log text file as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Mac: <code class="literal">~/Library/Logs/Unity/Editor.log</code></p></li><li style="list-style-type: disc"><p>Windows: <code class="literal">C:\Users\username\AppData\Local\Unity\Editor\Editor.log</code></p></li></ul></div><p>For more information about Unity logfiles, see the online manual at <a class="ulink" href="http://docs.unity3d.com/Documentation/Manual/LogFiles.html" target="_blank">http://docs.unity3d.com/Documentation/Manual/LogFiles.html</a>.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec394"></a>See also</h3></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <span class="emphasis"><em>Executing methods regularly but independent of frame rate with coroutines</em></span> recipe</p></li></ul></div></div></div>