<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec99"></a>Following waypoints in a sequence</h2></div></div><hr /></div><p>Waypoints are often <a id="id720" class="indexterm"></a>used as a guide to make an autonomously moving NPC follow a path in a general way (but be able to respond with other directional behaviors, such as flee or seek, if predator/prey is sensed nearby). The waypoints are arranged in a sequence, so that when the character reaches or gets close to a waypoint, it will then select the next waypoint in the sequence as the target location to move towards. This recipe demonstrates an <code class="literal">Arrow</code> object moving towards a waypoint, and then when it gets close enough, choosing the next waypoint in the sequence as the new target destination. When the last waypoint has been reached, it starts again heading towards the first waypoint.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_09_12.jpg" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec346"></a>Getting ready</h3></div></div></div><p>This recipe builds <a id="id721" class="indexterm"></a>upon the player-controlled cube Unity project you created in a previous recipe. So make a copy of that project, open it, and then follow the steps of this recipe.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec347"></a>How to do it...</h3></div></div></div><p>To follow waypoints in a sequence, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a sphere named <code class="literal">Arrow</code>, positioned at (2, 0.5, 2) and with scale (1, 1, 1).</p></li><li><p>Create a second sphere, named <code class="literal">Sphere-small</code>, positioned at (2, 0.5, 2.5) and with scale (0.5, 0.5, 0.5).</p></li><li><p>Make <code class="literal">Sphere-small</code> a child-object of your GameObject <code class="literal">Arrow</code>.</p></li><li><p>Create a new capsule object named <code class="literal">Capsule-waypoint-0</code> at (-12, 0, 8), give it the tag <code class="literal">waypoint</code>.</p></li><li><p>Copy <code class="literal">Capsule-spawnPoint-0</code> naming the copy <code class="literal">Capsule-spawnPoint-1</code> and positioning this copy at (0, 0, 8).</p></li><li><p>Make four more copies (named <code class="literal">Capsule-spawnPoint-2.5</code>) positioning them as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">Capsule-spawnPoint-2</code>: <span class="strong"><strong>Position</strong></span> set as (12, 0, 8)</p></li><li style="list-style-type: disc"><p><code class="literal">Capsule-spawnPoint-3</code>: <span class="strong"><strong>Position</strong></span> set as (12, 0, -8)</p></li><li style="list-style-type: disc"><p><code class="literal">Capsule-spawnPoint-4</code>: <span class="strong"><strong>Position</strong></span> set as (0, 0, -8)</p></li><li style="list-style-type: disc"><p><code class="literal">Capsule-spawnPoint-5</code>: <span class="strong"><strong>Position</strong></span> set as (-12, 0, -8)</p></li></ul></div></li><li><p>Add the <a id="id722" class="indexterm"></a>following C# script class to GameObject <code class="literal">Arrow</code>:</p><div class="informalexample"><pre class="programlisting">// file: WaypointManager.cs
using UnityEngine;
using System.Collections;

public class WaypointManager : MonoBehaviour {
  public GameObject[] waypoints;

  public GameObject NextWaypoint(GameObject current){
    if( waypoints.Length &lt; 1)
      print ("ERROR - no waypoints have been added to array!");

    // default is first in the array
    int nextIndex = 0;
    
    // find array index of given waypoint
    int currentIndex = -1;
    for(int i = 0; i &lt; waypoints.Length; i++){
      if( current == waypoints[i] )
        currentIndex = i;
    }
    
    int lastIndex = (waypoints.Length - 1);
    if(currentIndex &gt; -1 &amp;&amp; currentIndex &lt; lastIndex)
      nextIndex = currentIndex + 1;

    return waypoints[nextIndex];
  }
}</pre></div></li><li><p>Add the following script class to GameObject <code class="literal">Arrow</code>:</p><div class="informalexample"><pre class="programlisting">// file: MoveTowardsWaypoint.cs
using UnityEngine;
using System.Collections;

public class MoveTowardsWaypoint : MonoBehaviour {
  public const float ARRIVE_DISTANCE = 3f;
  public float speed = 5.0F;
  private GameObject targetGO;
  private WaypointManager waypointManager;

  private void Awake(){
    waypointManager = GetComponent&lt;WaypointManager&gt;();
    targetGO = waypointManager.NextWaypoint(null);
  }

  private void Update () {
    transform.LookAt( targetGO.transform );
    float distance = speed * Time.deltaTime;
    Vector3 source = transform.position;
    Vector3 target = targetGO.transform.position;
    transform.position = Vector3.MoveTowards(source, target, distance);

    if( Vector3.Distance( source, target) &lt; ARRIVE_DISTANCE)
      targetGO = waypointManager.NextWaypoint( targetGO );
  }
}</pre></div></li><li><p>With <span class="strong"><strong>Arrow</strong></span> <a id="id723" class="indexterm"></a>selected in the <span class="strong"><strong>Hierarchy</strong></span> panel, in the <span class="strong"><strong>Waypoint Manager</strong></span> scripted component in the <span class="strong"><strong>Inspector</strong></span>, do the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Set the size of the <span class="strong"><strong>Waypoints</strong></span> public array to <span class="strong"><strong>6</strong></span></p></li><li style="list-style-type: disc"><p>Drag the six capsule waypoint objects into the array in sequence</p></li></ul></div><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_09_13.jpg" /></div></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec348"></a>How it works...</h3></div></div></div><p>The <code class="literal">WaypointManager</code> class<a id="id724" class="indexterm"></a> has an array <code class="literal">waypoints</code>, and a method <code class="literal">NextWaypoint()</code>. The array is public, and via the inspector we have assigned the waypoint GameObjects in sequence to this array. The <code class="literal">NextWaypoint()</code> method<a id="id725" class="indexterm"></a> takes as input a GameObject (or null), and returns a GameObject. The input is a waypoint, and the return value is the next waypoint GameObject in the array sequence, or the first in the array if the input object cannot be found.</p><p>The <code class="literal">MoveTowardsWaypoint</code> class<a id="id726" class="indexterm"></a> has the following four variables:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">ARRIVE_DISTANCE</code>: This<a id="id727" class="indexterm"></a> is the distance from a waypoint, at which point the <code class="literal">Arrow</code> will then choose the next waypoint as its target</p></li><li style="list-style-type: disc"><p><code class="literal">speed</code>: This<a id="id728" class="indexterm"></a> is the distance to be travelled in each second (so as usual it will be multiplied by <code class="literal">Time.deltaTime</code> for the distance per frame)</p></li><li style="list-style-type: disc"><p><code class="literal">targetGO</code>: This is <a id="id729" class="indexterm"></a>the GameObject of the current target waypoint object to move towards</p></li><li style="list-style-type: disc"><p><code class="literal">waypointManager</code>: This<a id="id730" class="indexterm"></a> is a reference to the <code class="literal">WaypointManager</code> object in the parent (<code class="literal">Arrow</code>) GameObject</p></li></ul></div><p>When an <code class="literal">Awake()</code> message is received, the <code class="literal">waypointManager</code> object is assigned to the <code class="literal">WaypointManager</code> in the <code class="literal">Arrow</code> object, and <code class="literal">targetGO</code> is set to be the first waypoint in the sequence (by sending the argument of <code class="literal">null</code>, the first waypoint in the array will always be returned).</p><p>The <code class="literal">Update()</code> method<a id="id731" class="indexterm"></a> is responsible for making the <code class="literal">Arrow</code> object move towards the location of <code class="literal">targetGO</code>. It does this making use of the <code class="literal">MoveTowards()</code> method<a id="id732" class="indexterm"></a> of <code class="literal">Vector3</code>. The final statement in the method then tests whether the current <code class="literal">targetGO</code> has been reached (distance is less than <code class="literal">ARRIVE_DISTANCE</code>). Once it has been reached, then <code class="literal">targetGO</code> is reassigned to the next waypoint in the sequence.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec349"></a>See also</h3></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <span class="emphasis"><em>Finding a random spawn point</em></span> recipe</p></li><li style="list-style-type: disc"><p>The <span class="emphasis"><em>Finding the nearest spawn point</em></span> recipe</p></li></ul></div></div></div>