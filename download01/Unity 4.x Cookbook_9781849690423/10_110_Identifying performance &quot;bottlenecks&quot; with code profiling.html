<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec107"></a>Identifying performance "bottlenecks" with code profiling</h2></div></div><hr /></div><p>Optimization principal 1: <span class="emphasis"><em>Work smart not hard</em></span>. The best performance improvements are achieved when effort is focused<a id="id796" class="indexterm"></a> to optimize those parts of the game that take up the most computer resources—the "bottlenecks".<a id="id797" class="indexterm"></a> Code profiling<a id="id798" class="indexterm"></a> involves identifying resource bottlenecks by analyzing how long different actions take to complete their tasks. For graphics-intensive operations, the <span class="strong"><strong>Stats</strong></span> panel of the game window can be used to record frame rates and "dropped calls". For memory and processor-intensive code, Unity-Pro offers detailed, frame-by-frame, code profiling. Finally, for those who do not have Unity Pro, there is a freely available code profiling class from the Unify Community Wiki, which we will demonstrate in this recipe. Code profiling involves timing how long it takes between starting to do something, and ending it. Individual statements or loops may be profiled within a method, or the duration of a complete method may be analyzed, or the time spent between one event and some other may be checked (for example, the time between Unity to be asked to load a new scene, and that scene to then load and start running).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note51"></a>Note</h3><p>The Unity C# code profiler demonstrated in this recipe is by Michael Garforth, and can be found at <a class="ulink" href="http://wiki.unity3d.com/index.php/Profiler" target="_blank">http://wiki.unity3d.com/index.php/Profiler</a>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec374"></a>Getting ready</h3></div></div></div><p>The C# script <a id="id799" class="indexterm"></a>required for this recipe named <code class="literal">Profile.cs</code> can be found in the <code class="literal">0423_10_05</code> folder:</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec375"></a>How to do it...</h3></div></div></div><p>To profile your code performance,<a id="id800" class="indexterm"></a> perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Start a new project, and import the C# script <code class="literal">Profile.cs</code>.</p></li><li><p>Add the following C# script class to the <span class="strong"><strong>Main Camera</strong></span>:</p><div class="informalexample"><pre class="programlisting">// file: ProfileScript.cs
using UnityEngine;
 
public class ProfileScript : MonoBehaviour
{
  private void Awake() {
    Profile.StartProfile("Game");
  }

  private void Start(){
    Profile.StartProfile("Start");
    int answer = 2 + 2;
    print("2 + 2 = " + answer);
    Profile.EndProfile("Start");
  }

  private void OnApplicationQuit() {
    Profile.EndProfile("Game");
    Profile.PrintResults();
  }
}</pre></div></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec376"></a>How it works...</h3></div></div></div><p>The <code class="literal">Profile</code> class<a id="id801" class="indexterm"></a> <a id="id802" class="indexterm"></a>defines three important static methods that can be called to record times for profiling: <code class="literal">StartProfile(&lt;taskName&gt;)</code>, <code class="literal">EndProfile(&lt; taskName&gt;)</code>, and <code class="literal">PrintResults()</code><a id="id803" class="indexterm"></a>. Different tasks can be timed by choosing an appropriate string (such as <code class="literal">Game</code>) and calling <code class="literal">StartProfile()</code><a id="id804" class="indexterm"></a> when they begin, and <code class="literal">EndProfile()</code><a id="id805" class="indexterm"></a> after they have completed. Finally, <code class="literal">PrintResults()</code> tells the <code class="literal">Profile</code> class to display the results of all recordings in the <span class="strong"><strong>Console</strong></span> window:</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_10_06.jpg" /></div><p>Our <code class="literal">ProfileScript</code> object<a id="id806" class="indexterm"></a> added to the <span class="strong"><strong>Main Camera</strong></span> requests two named tasks be profiled: the simple 2 + 2 calculation in the <code class="literal">Start()</code> method (tagged <span class="strong"><strong>Start</strong></span>); and the time between the <code class="literal">Awake()</code> method being<a id="id807" class="indexterm"></a> called and the application quitting, because the user stopped game execution (tagged <span class="strong"><strong>Game</strong></span>). As can be seen in the preceding screenshot, the profile for Start shows that the time taken was <span class="strong"><strong>0.009865000 seconds</strong></span>; and for <span class="strong"><strong>Game</strong></span> it was <span class="strong"><strong>1.266863000 seconds</strong></span>.</p><p>This recipe illustrates a straightforward way to measure the time taken between different points in your game.<a id="id808" class="indexterm"></a> If the same string "tags" are used for <code class="literal">StartProfile()</code> and <code class="literal">EndProfile()</code> many times (for example, in a loop), then the <code class="literal">Profile</code> class will output the average time the profiled task took to complete.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec377"></a>There's more...</h3></div></div></div><p>The following are some details you don't want to miss:</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch10lvl3sec86"></a>Unity Pro only – code profiling</h4></div></div></div><p>If you have Unity Pro then the Unity's code <span class="strong"><strong>Profiler</strong></span><a id="id809" class="indexterm"></a> can provide much more detailed timing analysis of your game on a frame-by-frame basis. For example (see the following screenshot), the number of objects in each frame can be analyzed (the middle line in the screenshot).</p><p>For more information, see Unity's documentation pages at <a class="ulink" href="http://docs.unity3d.com/Documentation/Manual/Profiler.html" target="_blank">http://docs.unity3d.com/Documentation/Manual/Profiler.html</a>.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_10_07.jpg" /></div></div></div></div>