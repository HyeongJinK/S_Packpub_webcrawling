<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec113"></a>Caching, rather than component lookups and "reflection" over objects</h2></div></div><hr /></div><p>Optimization principal 5: <span class="emphasis"><em>Minimize actions requiring Unity to perform "reflection" over objects</em></span>. <span class="strong"><strong>Reflection</strong></span> <a id="id864" class="indexterm"></a>is when<a id="id865" class="indexterm"></a> at run-time, Unity has to analyze objects to see whether they contain a given set of methods or components. An example of this would be the simple, useful, but slow, <code class="literal">FindObjectsByTag()</code><a id="id866" class="indexterm"></a>. Another action that slows Unity down is each time we make it look up an object's component, either explicitly using <code class="literal">GetComponent()</code>, or implicitly using a component <code class="literal">accessor</code> variable<a id="id867" class="indexterm"></a> such as <code class="literal">transform</code> or <code class="literal">renderer</code>. In this recipe, we'll incrementally refactor a method, making it more efficient at each step by removing reflection and component lookup actions. The method we improve finds half the distance from the <span class="strong"><strong>Main Camera</strong></span> (to which the script is attached) to another GameObject in the scene tagged <code class="literal">Player</code>.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec395"></a>Getting ready</h3></div></div></div><p>For this recipe we<a id="id868" class="indexterm"></a> have provided C# script <code class="literal">Profile.cs</code> in the <code class="literal">0423_10_11</code> folder.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec396"></a>How to do it...</h3></div></div></div><p>To improve code performance by <a id="id869" class="indexterm"></a>caching component lookups, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Start a new project and import the <code class="literal">Profile.cs</code> script.</p></li><li><p>Create a cube named <code class="literal">Cube-Player</code> at (1, 1, 1), and give it the tag <code class="literal">Player</code>.</p></li><li><p>Add the following C# script class <code class="literal">SimpleMath</code> to the <span class="strong"><strong>Main Camera</strong></span>:</p><div class="informalexample"><pre class="programlisting">// file: SimpleMath.cs
using UnityEngine;
using System.Collections;

public class SimpleMath : MonoBehaviour {
  public float Halve(float n){
    return n / 2;
  }
}</pre></div></li><li><p>Add the following C# script class <code class="literal">ProfileScript1</code> to the <span class="strong"><strong>Main Camera</strong></span>:</p><div class="informalexample"><pre class="programlisting">// file: ProfileScript1.cs
using UnityEngine;
using System.Collections;
 
public class ProfileScript1 : MonoBehaviour
{
  private int ITERATIONS = 2000;

  private void Start(){
    for(int i=0; i &lt; ITERATIONS; i++){
      FindDistanceMethod();
    }

    Profile.PrintResults();
  }

  private void FindDistanceMethod(){
    Profile.StartProfile("Method-1");
    Vector3 pos1 = transform.position;
    Transform playerTransform = GameObject.FindGameObjectWithTag("Player").transform;
    Vector3 pos2 = playerTransform.position;
    float distance = Vector3.Distance(pos1, pos2);
    SimpleMath mathObject = GetComponent&lt;SimpleMath&gt;();
    float halfDistance = mathObject.Halve(distance);
    Profile.EndProfile("Method-1");
  }
}</pre></div></li><li><p>When<a id="id870" class="indexterm"></a> you run the scene you should see something similar to the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Profile Method-1 took 0.012487000 seconds to complete over 2000 iterations, averaging 0.000006244 seconds per call = 6.243500000 micro-seconds per call</strong></span>
</pre></div></li><li><p>The <code class="literal">FindGameObjectsWithTag()</code> method<a id="id871" class="indexterm"></a> is slow, so let's fix that by adding a public <code class="literal">Transform</code> variable named <code class="literal">playerTransformCache</code>, and dragging <span class="strong"><strong>Cube-Player</strong></span> over this variable in the <span class="strong"><strong>Inspector</strong></span> when the <span class="strong"><strong>Main Camera</strong></span> is selected:</p><div class="informalexample"><pre class="programlisting">public Transform playerTransformCache;</pre></div></li><li><p>Now replace your <code class="literal">FindDistanceMethod()</code><a id="id872" class="indexterm"></a> with the following, which makes use of this cached reference to the transform of <code class="literal">Cube-Player</code>, avoiding the slow object-tag reflection lookup altogether:</p><div class="informalexample"><pre class="programlisting">  private void FindDistanceMethod(){
    Profile.StartProfile("Method-2");
    Vector3 pos1 = transform.position;
    Vector3 pos2 = playerTransformCache.position;
    float distance = Vector3.Distance(pos1, pos2);
    SimpleMath mathObject = GetComponent&lt;SimpleMath&gt;();
    float halfDistance = mathObject.Halve(distance);
    Profile.EndProfile("Method-2");
  }</pre></div></li><li><p>That should run faster (around 25-35% faster). But wait! Let's improve things some more. At the moment, to find <code class="literal">pos1</code> we are making Unity find the transform component of the <span class="strong"><strong>Main Camera</strong></span> every time the method is called. Since the camera is not moving, let's cache this <code class="literal">Vector3</code> position as follows:</p><div class="informalexample"><pre class="programlisting">private Vector3 pos1Cache = new Vector3();

  private void Awake(){
    pos1Cache = transform.position;
  }</pre></div></li><li><p>Now replace your <code class="literal">FindDistanceMethod()</code> with the following, which makes use of this cached <span class="strong"><strong>Main Camera</strong></span> position:</p><div class="informalexample"><pre class="programlisting">  private void FindDistanceMethod(){
    Profile.StartProfile("Method-3");
    Vector3 pos2 = playerTransformCache.position;
    float distance = Vector3.Distance(pos1Cache, pos2);
    SimpleMath mathObject = GetComponent&lt;SimpleMath&gt;();
    float halfDistance = mathObject.Halve(distance);
    Profile.EndProfile("Method-3");
  }</pre></div></li><li><p>That should<a id="id873" class="indexterm"></a> improve things around 10 percent. But we can still improve things—you'll notice an explicit <code class="literal">GetComponent()</code><a id="id874" class="indexterm"></a> call to get a reference to our <code class="literal">mathObject</code>. Let's cache this scripted component reference as well, to save <code class="literal">GetComponent()</code> for each iteration. We'll declare a variable called <code class="literal">mathObjectCache</code>, and in <code class="literal">Awake()</code>, we will set it to refer to our <code class="literal">SimpleMath</code> scripted component.</p><div class="informalexample"><pre class="programlisting">  private SimpleMath mathObjectCache;

  private void Awake(){
    pos1Cache = transform.position;
    mathObjectCache = GetComponent&lt;SimpleMath&gt;();
  }</pre></div></li><li><p>Now replace your <code class="literal">FindDistanceMethod()</code> with the following, which makes use of this cached component reference:</p><div class="informalexample"><pre class="programlisting">  private void FindDistanceMethod(){
    Profile.StartProfile("Method-4");
    Vector3 pos2 = playerTransformCache.position;
    float distance = Vector3.Distance(pos1Cache, pos2);
    float halfDistance = mathObjectCache.Halve(distance);
    Profile.EndProfile("Method-4");
  }</pre></div></li><li><p>After running the scene, after each improved method you should see something similar to the following, which gives us quantitative evidence of how the performance of our method is improving after each step in our refactoring process:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Profile Method-2 took 0.006818000 seconds to complete over 2000 iterations, averaging 0.000003409 seconds per call = 3.409000000 micro-seconds per call</strong></span>
<span class="strong"><strong>Profile Method-3 took 0.006009000 seconds to complete over 2000 iterations, averaging 0.000003005 seconds per call = 3.004500000 micro-seconds per call</strong></span>
<span class="strong"><strong>Profile Method-4 took 0.003555000 seconds to complete over 2000 iterations, averaging 0.000001778 seconds per call = 1.777500000 micro-seconds per call</strong></span>
</pre></div></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec397"></a>How it works...</h3></div></div></div><p>This recipe illustrates <a id="id875" class="indexterm"></a>how we try to cache references once, before any iteration, for variables whose value will not change. This can be done for items such as references to GameObjects and their components; and in this example, the <code class="literal">Vector3</code> position of the <span class="strong"><strong>Main Camera</strong></span>. Through this removing of implicit and explicit component and object lookups from a method that has to be executed many times, the performance improvement is clear to see.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note54"></a>Note</h3><p>Two good places to learn more about Unity performance optimization techniques are from the Performance Optimization web page in the Unity Script Reference; and Unity's Joachim Ante's <span class="strong"><strong>Unite07</strong></span><a id="id876" class="indexterm"></a>—a presentation on "Performance Optimization". Some of the recipes in this chapter had their origins from suggestions found in the following sources:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><a class="ulink" href="http://docs.unity3d.com/Documentation/ScriptReference/index.Performance_Optimization.html" target="_blank">docs.unity3d.com/Documentation/ScriptReference/index.Performance_Optimization.html</a></p></li><li style="list-style-type: disc"><p><a class="ulink" href="http://video.unity3d.com/video/3272748/0/unite-07-performance" target="_blank">http://video.unity3d.com/video/3272748/0/unite-07-performance</a></p></li></ul></div></div></div></div>