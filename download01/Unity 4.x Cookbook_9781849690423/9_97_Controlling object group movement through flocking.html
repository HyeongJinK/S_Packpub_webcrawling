<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec95"></a>Controlling object group movement through flocking</h2></div></div><hr /></div><p>Realistic, natural looking <a id="id674" class="indexterm"></a>flocking behavior<a id="id675" class="indexterm"></a> (for example, birds, antelopes, or bats) can be created through creating collections of objects with the following four simple rules:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Separation</strong></span>: Avoid getting too close to neighbors</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Avoid obstacles</strong></span>: Turn away from an obstacle which is immediately ahead</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Alignment</strong></span>: Move in the direction the flock is heading</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Cohesion</strong></span>: Move towards the location in the middle of the flock</p></li></ul></div><p>Each member of the "flock" acts independently, but needs to know about the current heading and location of the members of its flock. This recipe shows you how to create a scene of flocking cubes. To keep things simple, we'll only implement basic versions of the last two rules of the preceding list: alignment and cohesion.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec329"></a>Getting ready</h3></div></div></div><p>This recipe builds upon the player-controlled cube Unity project you created in the first recipe. So make a copy of that project, open it, and then follow the steps of this recipe.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec330"></a>How to do it...</h3></div></div></div><p>To make a group of objects flock together, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Add the following C# script class to the <span class="strong"><strong>Main Camera</strong></span>:</p><div class="informalexample"><pre class="programlisting">// file: Swarm
using UnityEngine;
using System.Collections;
using System.Collections.Generic;

public class Swarm : MonoBehaviour {
  public int droneCount = 20;
  public GameObject dronePrefab;

  private List&lt;Drone&gt; drones = new List&lt;Drone&gt;();

  private void Awake(){
    for (int i = 0; i &lt; droneCount; i++){
      AddDrone();
    }
  }

  private void AddDrone(){
    GameObject newDroneGO = (GameObject)Instantiate(dronePrefab);
    Drone newDrone = newDroneGO.GetComponent&lt;Drone&gt;();
    drones.Add( newDrone );

    float speed = 5f;
    float maxSpeed = 10f;
    float maxDirectionChange = .05f;
    newDrone.SetParameters(speed, maxSpeed, maxDirectionChange);
  }
  
  private void FixedUpdate(){
    Vector3 swarmCenter = SwarmCenterAverage();
    Vector3 swarmMovement = SwarmMovementAverage();

    foreach(Drone drone in drones ) {
      drone.UpdateVelocity(swarmCenter, swarmMovement);

    }
  }
  
  private Vector3 SwarmCenterAverage() {
    // cohesion (swarm center point)
    Vector3 locationTotal = Vector3.zero;

    foreach(Drone drone in drones ) {
      locationTotal += drone.transform.position;
    }
    
    return (locationTotal / drones.Count);
  }

  private Vector3 SwarmMovementAverage() {
    // alignment (swarm direction average)
    Vector3 velocityTotal = Vector3.zero;

    foreach(Drone drone in drones ) {
      velocityTotal += drone.rigidbody.velocity;
    }

    return (velocityTotal / drones.Count);	
  }
}</pre></div></li><li><p>Create a new cube GameObject named <code class="literal">Cube-boid</code>, at (0, 0, 0) and add a <span class="strong"><strong>RigidBody</strong></span> component from <span class="strong"><strong>Physics</strong></span> to <code class="literal">Cube-boid</code> with the following properties:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Mass</strong></span> as <span class="strong"><strong>1</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Drag</strong></span> is <span class="strong"><strong>0</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Angular Drag</strong></span> is <span class="strong"><strong>0.05</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Use Gravity</strong></span> and <span class="strong"><strong>Is Kinematic</strong></span> are both un-checked</p></li><li style="list-style-type: disc"><p>Under <span class="strong"><strong>Constrains Freeze Position</strong></span> for the <span class="strong"><strong>Y</strong></span> axis is checked</p></li></ul></div></li><li><p>You should<a id="id676" class="indexterm"></a> see the following Inspector values for your cube's rigid body component:</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_09_07.jpg" /></div></li><li><p>Add the following C# script class to <code class="literal">Cube-boid</code>:</p><div class="informalexample"><pre class="programlisting">// file: Drone.cs
using UnityEngine;
using System.Collections;
using System.Collections.Generic;

public class Drone : MonoBehaviour {
  public void SetParameters(float speed, float maxSpeed, float maxDirectionChange){
    _speed = speed;
    _maxSpeed = maxSpeed;
    _maxDirectionChange = maxDirectionChange;
  }
  
  private float _speed = 5f;
  private float _maxSpeed = 10f;
  private float _maxDirectionChange = .05f;

  public void UpdateVelocity(Vector3 swarmCenterAverage, Vector3 swarmMovementAverage){
    // calc velocity adjustment for swarm
    Vector3 moveTowardsSwarmCenter = VectorTowards( swarmCenterAverage );
    Vector3 adjustment = moveTowardsSwarmCenter + (2 * swarmMovementAverage );
    Vector3 swarmVelocityAdjustment = UsefulFunctions.ClampMagnitude(adjustment, _maxDirectionChange);

    // apply velocity adjustment to this drone
    rigidbody.velocity += (swarmVelocityAdjustment * _speed);
    rigidbody.velocity = UsefulFunctions.ClampMagnitude(rigidbody.velocity, _maxSpeed);
  }

  private Vector3 VectorTowards(Vector3 target) {
    Vector3 targetDirection = target - transform.position;
    targetDirection.Normalize();
    targetDirection *= _maxSpeed;
    return (targetDirection - rigidbody.velocity);
  }
}</pre></div></li><li><p>Create a new empty Prefab named <code class="literal">prefab_Boid</code>, and from the <span class="strong"><strong>Hierarchy</strong></span> panel drag <span class="strong"><strong>Cube-boid</strong></span> GameObject into this Prefab.</p></li><li><p>Delete <a id="id677" class="indexterm"></a>
<span class="strong"><strong>Cube-boid</strong></span> from the <span class="strong"><strong>Scene</strong></span> panel.</p></li><li><p>With <span class="strong"><strong>Main Camera</strong></span> selected in the <span class="strong"><strong>Hierarchy</strong></span> panel, drag <span class="strong"><strong>prefab_Boid</strong></span> from the <span class="strong"><strong>Project</strong></span> panel over the public variable of <code class="literal">Drone</code> Prefab.</p></li><li><p>Create a new cube named <code class="literal">wall-left</code>, with the following properties:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Position</strong></span>: (-15, 0.5, 0)</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Scale</strong></span>: (1, 1, 20)</p></li></ul></div></li><li><p>Duplicate the <code class="literal">wall-left</code> object naming the new object <code class="literal">wall-right</code>, and change the position of <code class="literal">wall-right</code> to (15, 0.5, 0).</p></li><li><p>Create a new cube named <code class="literal">wall-top</code>, with the following properties:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Position</strong></span>: (0, 0.5, 10)</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Scale</strong></span>: (31, 1, 1)</p></li></ul></div></li><li><p>Duplicate the <code class="literal">wall-top</code> object naming the new object <code class="literal">wall-bottom</code>, and change the position of <code class="literal">wall-bottom</code> to (0, 0.5, -10).</p></li><li><p>Finally, make the player's red cube larger, set its <span class="strong"><strong>Scale</strong></span> to (3, 3, 3).</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec331"></a>How it works...</h3></div></div></div><p>The <code class="literal">Swarm</code> class<a id="id678" class="indexterm"></a> contains the following three variables:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Integer <code class="literal">droneCount</code>: This is the number of swam members to be created</p></li><li style="list-style-type: disc"><p>GameObject <code class="literal">dronePrefab</code>: This is a reference to the Prefab to be cloned to create swarm members</p></li><li style="list-style-type: disc"><p>List of <code class="literal">Drone</code> object references <code class="literal">drones</code>: This is a list of all the scripted <code class="literal">Drone</code> components inside all of the swarm GameObjects that have been created</p></li></ul></div><p>Upon creation, <a id="id679" class="indexterm"></a>as the scene starts, the <code class="literal">Awake()</code> methods of the <code class="literal">Swarm</code> class loops to create <code class="literal">droneCount</code> swarm members by repeatedly calling the <code class="literal">AddDrone()</code> method<a id="id680" class="indexterm"></a>. This method instantiates a new GameObject from the Prefab and then sets variable <code class="literal">newDrone</code> to be a reference to the <code class="literal">Drone</code>-scripted object inside the new swarm member. Parameters for changing <code class="literal">speed</code>, <code class="literal">maxSpeed</code>, and <code class="literal">maxDirection</code> are set in the <code class="literal">newDrone</code> object.</p><p>Each frame <code class="literal">FixedUpdate()</code> method (used since physics is involved, so <code class="literal">Update()</code> would not be appropriate), loops through the list of <code class="literal">Drone</code> objects, calling their <code class="literal">UpdateVelocity()</code> methods, passing in the swarm center location and the average of all the swarm member velocities.</p><p>The rest of this <code class="literal">Swarm</code> class is made up of two methods: one (<code class="literal">SwarmCenterAverage</code>) returns a <code class="literal">Vector3</code> object representing the average position of all the <code class="literal">Drone</code> objects, and the other (<code class="literal">SwarmMovementAverage</code>) returns a <code class="literal">Vector3</code> object representing the average velocity (movement force) of all the <code class="literal">Drone</code> objects.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_09_08.jpg" /></div><p>The hard work is undertaken by the <code class="literal">Drone</code> class. The <code class="literal">SetParameters()</code> method<a id="id681" class="indexterm"></a> stores the movement settings <a id="id682" class="indexterm"></a>for the swarm into local variables for each Drone object's calculations.</p><p>The <code class="literal">UpdateVelocity()</code> method<a id="id683" class="indexterm"></a> inputs <code class="literal">Vector3</code> arguments:<a id="id684" class="indexterm"></a> <code class="literal">swarmCenterAverage</code> and <code class="literal">swarmMovementAverage</code><a id="id685" class="indexterm"></a>. This method then calculates the desired change in velocity for this particular <code class="literal">Drone</code> object (<code class="literal">swarmVelocityAdjustment</code>). The current movement velocity of the swarm member (<code class="literal">rigidbody.velocity</code>) has added to it <code class="literal">swarmVelocityAdjustment</code> multiplied by the <code class="literal">_speed</code> variable. The velocity of the <code class="literal">Drone</code> object is then limited to a maximum magnitude of <code class="literal">_maxSpeed</code> to prevent situations where the addition of the new velocity to the existing movement results in movement that is faster than their maximum speed.</p><p>In order to calculate <code class="literal">swarmVelocityAdjustment</code>, each <code class="literal">Drone</code> object needs to use the following to decide what to do:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">swarmMovementAverage</code></p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>What is the general direction the swarm is moving?</p></li><li style="list-style-type: disc"><p>This is known as <span class="strong"><strong>alignment</strong></span><a id="id686" class="indexterm"></a>—a swarm member attempting to move in the same direction as the swarm average</p></li></ul></div></li><li style="list-style-type: disc"><p><code class="literal">swarmCenterAverage</code></p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>What is the center position of the swarm?</p></li><li style="list-style-type: disc"><p>This is know as <span class="strong"><strong>cohesion</strong></span><a id="id687" class="indexterm"></a>—a swarm member attempting to move towards the center of the swarm</p></li></ul></div></li></ul></div><p>Variable <code class="literal">moveTowardsSwarmCenter</code><a id="id688" class="indexterm"></a> calculates a vector pointing towards the center of the swarm, by calling the <code class="literal">VectorTowards()</code> method and passing the swarm center position. The total swarm adjustment vector (<code class="literal">swarmVelocityAdjustment</code>) is the sum of this vector towards the swarm center, added to two times the average velocity of the swarm (<code class="literal">swarmMovementAverage</code>). This weighting of twice the average velocity compared to just one-times the swarm center position direction means that each <code class="literal">Drone</code> object will try to keep moving with the swarm, rather than just cluster at some center point. Without this weighting, the swarm may simply stop moving after it forms a tight grouping. The size of this weighted velocity adjustment is limited to the value of the <code class="literal">_maxDirectionChange</code> variable<a id="id689" class="indexterm"></a>, which prevents <code class="literal">Drone</code> objects from changing their direction too abruptly.</p><p>The <code class="literal">VectorTowards()</code> method<a id="id690" class="indexterm"></a> creates a unit vector in the direction of the given target position and then multiplies this by <code class="literal">_maxSpeed</code> to create a velocity vector of length <code class="literal">_maxSpeed</code> in the direction of the given target position. It then returns this vector with the Drone object's current velocity subtracted from it, that is, the force to be applied to make the already moving <code class="literal">Drone</code> object move towards the target position at speed equaling to <code class="literal">_maxSpeed</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec332"></a>See also</h3></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <span class="emphasis"><em>Controlling cube movement through player controls</em></span> recipe</p></li><li style="list-style-type: disc"><p>The <span class="emphasis"><em>Controlling object look-at behavior</em></span> recipe</p></li><li style="list-style-type: disc"><p>The <span class="emphasis"><em>Controlling object-to-object movements (seek, flee, follow at a distance)</em></span> recipe</p></li></ul></div></div></div>