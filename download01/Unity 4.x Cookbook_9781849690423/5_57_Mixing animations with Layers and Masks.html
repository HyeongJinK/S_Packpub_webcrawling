<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec59"></a>Mixing animations with Layers and Masks</h2></div></div><hr /></div><p>Mixing animations is a great way of adding complexity to your animated characters without<a id="id367" class="indexterm"></a> requiring a vast number of animated clips. Using <span class="strong"><strong>Layers</strong></span> and <span class="strong"><strong>Masks</strong></span>, we can combine different <a id="id368" class="indexterm"></a>animations by playing specific clips for specific body parts of the character. In this recipe, we will apply this technique to our animated character, triggering animation clips for firing a rifle and throwing a grenade with the character's upper body, while keeping the lower body moving or idle, according to the player's input.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec201"></a>Getting ready</h3></div></div></div><p>For this recipe, we have prepared a project named <code class="literal">MixamoProject</code>, containing several assets such as levels, animated characters, and props. You can find it inside the <code class="literal">0423_05_codes</code> folder.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec202"></a>How to do it...</h3></div></div></div><p>To mix animations using Layers and Masks, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open the project, and then open the level named <span class="strong"><strong>05_03</strong></span> (inside the <span class="strong"><strong>Levels</strong></span> folder). Note that it includes a S.W.A.T. character that features the Animator component using the <span class="strong"><strong>swatController03</strong></span> Controller.</p></li><li><p>We need to configure our animation clips. From the <span class="strong"><strong>Original_Character</strong></span> folder, select the <span class="strong"><strong>Swat@firing_rifle</strong></span> file.</p></li><li><p>Click on the <span class="strong"><strong>Rig</strong></span> tab. Change <span class="strong"><strong>Animation Type</strong></span> to <span class="strong"><strong>Humanoid</strong></span> and <span class="strong"><strong>Avatar Definition</strong></span> to <span class="strong"><strong>Copy From Other Avatar</strong></span>. Then, select <span class="strong"><strong>swatAvatar</strong></span> for <span class="strong"><strong>Source</strong></span> by choosing it from the list or dragging it from the <span class="strong"><strong>Project</strong></span> view into the slot. Confirm your changes by clicking on <span class="strong"><strong>Apply</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_21.jpg" /></div></li><li><p>Now click on the <span class="strong"><strong>Animations</strong></span> tab. Select the <span class="strong"><strong>firing_rifle</strong></span> clip from the <span class="strong"><strong>Clips</strong></span> list and <a id="id369" class="indexterm"></a>select the <span class="strong"><strong>Loop Pose</strong></span> checkbox. Under <span class="strong"><strong>Root Transform Rotation</strong></span>, check <span class="strong"><strong>Bake into Pose</strong></span> and set <span class="strong"><strong>Body Orientation</strong></span> for <span class="strong"><strong>Baked Upon (at Start)</strong></span>; Under <span class="strong"><strong>Root Transform Position (Y)</strong></span>, <a id="id370" class="indexterm"></a>check <span class="strong"><strong>Bake into Pose</strong></span> and set <span class="strong"><strong>Original</strong></span> for <span class="strong"><strong>Baked Upon (at Start)</strong></span>; Under <span class="strong"><strong>Root Transform Position (XZ)</strong></span>, leave the <span class="strong"><strong>Bake into Pose</strong></span> checkbox deselected. Finally, click on the <span class="strong"><strong>Clamp Range</strong></span> button to adjust the timeline (see the following screenshot). Click on <span class="strong"><strong>Apply</strong></span> to confirm the changes.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_22.jpg" /></div></li><li><p>Now, from the <span class="strong"><strong>Original_Character</strong></span> folder, select the <span class="strong"><strong>Swat@toss_grenade</strong></span> file. Click <a id="id371" class="indexterm"></a>on the <span class="strong"><strong>Rig</strong></span> tab. Change <span class="strong"><strong>Animation Type</strong></span> to <span class="strong"><strong>Humanoid</strong></span> and <span class="strong"><strong>Avatar Definition</strong></span> to <span class="strong"><strong>Copy From Other Avatar</strong></span>. Then, select <span class="strong"><strong>swatAvatar</strong></span> for <span class="strong"><strong>Source</strong></span> by choosing it from the list or dragging it from the <span class="strong"><strong>Project</strong></span> view into the slot. Confirm the changes by clicking on <span class="strong"><strong>Apply</strong></span>.</p></li><li><p>Now click <a id="id372" class="indexterm"></a>on the <span class="strong"><strong>Animations</strong></span> tab. Select the <span class="strong"><strong>toss_grenade</strong></span> clip from the <span class="strong"><strong>Clips</strong></span> list and leave the <span class="strong"><strong>Loop Pose</strong></span> checkbox deselected. Under <span class="strong"><strong>Root Transform Rotation</strong></span>, check <span class="strong"><strong>Bake into Pose</strong></span> and set <span class="strong"><strong>Body Orientation</strong></span> for <span class="strong"><strong>Baked Upon (at Start)</strong></span>; Under <span class="strong"><strong>Root Transform Position (Y)</strong></span>, check <span class="strong"><strong>Bake into Pose</strong></span> and set <span class="strong"><strong>Original</strong></span> for <span class="strong"><strong>Baked Upon (at Start)</strong></span>; Under <span class="strong"><strong>Root Transform Position (XZ)</strong></span>, leave the <span class="strong"><strong>Bake into Pose</strong></span> checkbox deselected. Finally, click on the <span class="strong"><strong>Clamp Range</strong></span> button to adjust the timeline. Click on <span class="strong"><strong>Apply</strong></span> to confirm the changes.</p></li><li><p>Let's create our Mask. In the <span class="strong"><strong>Project</strong></span> view, click on the <span class="strong"><strong>Create</strong></span> button and add an <a id="id373" class="indexterm"></a>Avatar<a id="id374" class="indexterm"></a> Body Mask to the project. Name it <code class="literal">BodyMask</code>.</p></li><li><p>Select the Body Mask and, in the <span class="strong"><strong>Inspector</strong></span> view, deselect the character's legs, base, and IK spots, turning their outline red.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_23.jpg" /></div></li><li><p>In the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>Swat</strong></span> model. Then, from the Animator component in the <span class="strong"><strong>Inspector</strong></span> view, double-click on <span class="strong"><strong>swatController03</strong></span> to open it.</p></li><li><p>In the <span class="strong"><strong>Animator</strong></span> view, create a new Layer by clicking on the <span class="strong"><strong>+</strong></span> sign on the <span class="strong"><strong>Layers</strong></span> tab at the top-left corner of the screen, under <span class="strong"><strong>Base Layer</strong></span>.</p></li><li><p>Name the new Layer <code class="literal">UpperBody</code> and select <span class="strong"><strong>BodyMask</strong></span> for the <span class="strong"><strong>Human</strong></span> field under <span class="strong"><strong>Masks</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_24.jpg" /></div></li><li><p>Now, in the <span class="strong"><strong>Animator</strong></span> view, with the <span class="strong"><strong>UpperBody</strong></span> layer selected, create three new empty<a id="id375" class="indexterm"></a> states (by right-clicking on the gridded area and selecting <span class="strong"><strong>Empty</strong></span> from the <span class="strong"><strong>Create State</strong></span> menu). Name<a id="id376" class="indexterm"></a> the default (orange colored) state <code class="literal">null</code>, and the other two, <code class="literal">Fire</code> and <code class="literal">Grenade</code>.</p></li><li><p>In the <span class="strong"><strong>Parameters</strong></span> field at the bottom-left corner of the screen, add two new parameters (of the type <code class="literal">Bool</code>), <code class="literal">Fire</code> and <code class="literal">Grenade</code>.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_25.jpg" /></div></li><li><p>Select the <span class="strong"><strong>Fire</strong></span> state and, in the <span class="strong"><strong>Inspector</strong></span> view, add the <span class="strong"><strong>firing_rifle</strong></span> animation clip to the <span class="strong"><strong>Motion</strong></span> field.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_26.jpg" /></div></li><li><p>Now select the <span class="strong"><strong>Grenade</strong></span> state and, in the <span class="strong"><strong>Inspector</strong></span> view, add the <span class="strong"><strong>toss_grenade</strong></span> animation clip to the <span class="strong"><strong>Motion</strong></span> field.</p></li><li><p>Right-click <a id="id377" class="indexterm"></a>on the <span class="strong"><strong>null</strong></span> state box<a id="id378" class="indexterm"></a> and select <span class="strong"><strong>Make Transition</strong></span> from the menu. Then, drag the white arrow into the box named <span class="strong"><strong>Fire</strong></span>.</p></li><li><p>Select the arrow (it should turn blue). Then, in the <span class="strong"><strong>Inspector</strong></span> view, inside the <span class="strong"><strong>Conditions</strong></span> box, select the options <span class="strong"><strong>Fire</strong></span> and <span class="strong"><strong>true</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_27.jpg" /></div></li><li><p>Now make a transition from <span class="strong"><strong>null</strong></span> to <span class="strong"><strong>Grenade</strong></span>. Select the arrow and, in the <span class="strong"><strong>Conditions</strong></span> box, select the options <span class="strong"><strong>Grenade</strong></span> and <span class="strong"><strong>true</strong></span>.</p></li><li><p>Now <a id="id379" class="indexterm"></a>create <a id="id380" class="indexterm"></a>transitions from <span class="strong"><strong>Fire</strong></span> to <span class="strong"><strong>null</strong></span>, and from <span class="strong"><strong>Grenade</strong></span> to <span class="strong"><strong>null</strong></span>. Select the arrow that goes from <span class="strong"><strong>Fire</strong></span> to <span class="strong"><strong>null</strong></span>, and in the <span class="strong"><strong>Conditions</strong></span> box, select the options <span class="strong"><strong>Fire</strong></span> and <span class="strong"><strong>false</strong></span>.</p></li><li><p>Finally, select the arrow that goes from <span class="strong"><strong>Grenade</strong></span> to <span class="strong"><strong>null</strong></span>, and in the <span class="strong"><strong>Conditions</strong></span> box, select the option <span class="strong"><strong>Exit Time</strong></span> and enter the number <code class="literal">0.92</code>.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_28.jpg" /></div></li><li><p>In the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>Swat</strong></span> model. In the <span class="strong"><strong>Inspector</strong></span> view, select the Basic Controller 03 component and open its script.</p></li><li><p>Immediately before the end of the <span class="strong"><strong>Update()</strong></span> function, add the following code:</p><div class="informalexample"><pre class="programlisting">  if(Input.GetKeyDown(KeyCode.F)){
    animator.SetBool("Grenade", true);
  } else {
    animator.SetBool("Grenade", false);
  }
  if(Input.GetButtonDown("Fire1")){
    animator.SetBool("Fire", true);
  }
  if(Input.GetButtonUp("Fire1")){
    animator.SetBool("Fire", false);
  }</pre></div></li><li><p>Save the <a id="id381" class="indexterm"></a>script and play your scene. <a id="id382" class="indexterm"></a>You should be able to trigger the Fire and Grenade animations by clicking on the <span class="strong"><strong>Fire</strong></span> button and pressing the <span class="emphasis"><em>F</em></span> key, respectively. Observe how the character's legs respond to the walking and running animations.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec203"></a>How it works...</h3></div></div></div><p>Once the Avatar Body Mask has been created, it can be used as a way of filtering which body parts will actually play the animation states of a particular layer. In our case, we have constrained our <span class="strong"><strong>fire_rifle</strong></span> and <span class="strong"><strong>toss_grenade</strong></span> animation clips to the upper body of our character, leaving the lower body free to play the movement-related animation clips such as walking, running, and strafing.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec204"></a>There's more...</h3></div></div></div><p>You might have noticed that the <code class="literal">UpperBody</code> layer has a parameter named <code class="literal">Blending</code>, which was set to <code class="literal">Override</code> by default. This means animation states in that layer will override animation states from lower layers when played. If changed to <code class="literal">Additive</code>, the animation from that layer would be added to the ones from lower layers.</p><p>For more information on Animation Layers and Avatar Body Masks, check out Unity's documentation at the following two locations:</p><p><a class="ulink" href="http://docs.unity3d.com/Documentation/Manual/AnimationLayers.html" target="_blank">http://docs.unity3d.com/Documentation/Manual/AnimationLayers.html</a></p><p><a class="ulink" href="http://docs.unity3d.com/Documentation/Manual/AvatarBodyMask.html" target="_blank">http://docs.unity3d.com/Documentation/Manual/AvatarBodyMask.html</a></p></div></div>