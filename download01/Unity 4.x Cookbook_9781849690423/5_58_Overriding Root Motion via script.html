<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec60"></a>Overriding Root Motion via script</h2></div></div><hr /></div><p>Applying Root Motion to <a id="id383" class="indexterm"></a>your character is a very practical and accurate way of animating it. However, every now and then you might need to manually control one or more aspects of the character's movement. Perhaps you only have an in-place animation to work with, or maybe you want the character's movement to be affected by other variables. In such cases, you will need to override Root Motion via script.</p><p>In this recipe,<a id="id384" class="indexterm"></a> we will control the character's movement via script, making it rotate and jump.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec205"></a>Getting ready</h3></div></div></div><p>For this recipe, we have prepared a project named <code class="literal">MixamoProject</code>, containing several assets such as levels, animated characters, and props. You can find it inside the <code class="literal">0423_05_codes</code> folder.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec206"></a>How to do it...</h3></div></div></div><p>To apply Root Motion via script, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open the project, and then open the level named <code class="literal">05_04</code> (inside the <code class="literal">Levels</code> folder). Note that it includes a S.W.A.T. character, featuring the Animator component using the <span class="strong"><strong>swatController03</strong></span> Controller.</p></li><li><p>We need to configure our animation clips. From the <span class="strong"><strong>Original_Character</strong></span> folder, select the <span class="strong"><strong>Swat@rifle_jump</strong></span> file.</p></li><li><p>Click on the <span class="strong"><strong>Rig</strong></span> tab. Change <span class="strong"><strong>Animation Type</strong></span> to <span class="strong"><strong>Humanoid</strong></span> and <span class="strong"><strong>Avatar Definition</strong></span> to <span class="strong"><strong>Copy From Other Avatar</strong></span>. Then, select <span class="strong"><strong>swatAvatar</strong></span> for <span class="strong"><strong>Source</strong></span> by choosing it from the list or dragging it from the <span class="strong"><strong>Project</strong></span> view into the slot. Confirm the changes by clicking on <span class="strong"><strong>Apply</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_29.jpg" /></div></li><li><p>Now activate the <span class="strong"><strong>Animations</strong></span> section. Select the clip <span class="strong"><strong>rifle_jump</strong></span> from the <span class="strong"><strong>Clips</strong></span> list and <a id="id385" class="indexterm"></a>leave the Loop Pose checkbox deselected. <span class="strong"><strong>Under Root Transform Rotation</strong></span>, check <span class="strong"><strong>Bake into Pose</strong></span> and set <span class="strong"><strong>Body Orientation</strong></span> for <span class="strong"><strong>Baked Upon (at Start)</strong></span>; Under <span class="strong"><strong>Root Transform Position (Y)</strong></span>, leave <span class="strong"><strong>Bake into Pose</strong></span> deselected; Under <span class="strong"><strong>Root Transform Position (XZ)</strong></span>, leave <span class="strong"><strong>Bake into Pose</strong></span> deselected. Finally, click on the <span class="strong"><strong>Clamp Range</strong></span> button to adjust the timeline. Click on <span class="strong"><strong>Apply</strong></span> to confirm the changes.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_30.jpg" /></div></li><li><p>Now, from the <span class="strong"><strong>Original_Character</strong></span> folder, select the <span class="strong"><strong>Swat@turn_left</strong></span> file.</p></li><li><p>Repeat <a id="id386" class="indexterm"></a>step 3 of this recipe, applying <span class="strong"><strong>SwatAvatar</strong></span> to <span class="strong"><strong>Swat@turn_left</strong></span> as the <span class="strong"><strong>Source</strong></span> for the <span class="strong"><strong>Humanoid Rig</strong></span>.</p></li><li><p>Now click on the <span class="strong"><strong>Animations</strong></span> tab. Select the clip <span class="strong"><strong>turn_left</strong></span> from the <span class="strong"><strong>Clips</strong></span> list and select the <span class="strong"><strong>Loop Pose</strong></span> checkbox. Under <span class="strong"><strong>Root Transform Rotation</strong></span>, check <span class="strong"><strong>Bake into Pose</strong></span> and set <span class="strong"><strong>Body Orientation</strong></span> for <span class="strong"><strong>Baked Upon (at Start)</strong></span>; Under <span class="strong"><strong>Root Transform Position (Y)</strong></span>, check <span class="strong"><strong>Bake into Pose</strong></span> and set <span class="strong"><strong>Original</strong></span> for <span class="strong"><strong>Baked Upon (at Start)</strong></span>; Under <span class="strong"><strong>Root Transform Position (XZ)</strong></span>, leave <span class="strong"><strong>Bake into Pose</strong></span> deselected. Finally, click on the <span class="strong"><strong>Clamp Range</strong></span> button to adjust the timeline. Click on <span class="strong"><strong>Apply</strong></span> to confirm the changes.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_31.jpg" /></div></li><li><p>Repeat steps 6 and 7 of this recipe for the <code class="literal">Swat@turning_right_45_degrees</code> file.</p></li><li><p>From the <a id="id387" class="indexterm"></a>
<span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>Swat</strong></span> model. Then, from the Animator component in the <span class="strong"><strong>Inspector</strong></span> view, open the <span class="strong"><strong>swatController04</strong></span> controller.</p></li><li><p>Using the <span class="strong"><strong>Parameters</strong></span> widget, create the Boolean parameters <code class="literal">Jump</code>, <code class="literal">TurnLeft</code>, and <code class="literal">TurnRight</code>. Then, in the gridded area, create the states <span class="strong"><strong>Jump</strong></span>, <span class="strong"><strong>TurnLeft</strong></span>, and <span class="strong"><strong>TurnRight</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_32.jpg" /></div></li><li><p>By right-clicking on each state and selecting the <span class="strong"><strong>Make Transition</strong></span> option, create transitions<a id="id388" class="indexterm"></a> between <span class="strong"><strong>Jump</strong></span> and <span class="strong"><strong>Idle</strong></span>, <span class="strong"><strong>Jump</strong></span> and <span class="strong"><strong>Move</strong></span>, <span class="strong"><strong>Turn Left</strong></span> and <span class="strong"><strong>Idle</strong></span>, and <span class="strong"><strong>Turn Right</strong></span> and <span class="strong"><strong>Idle</strong></span>. You should add return transitions as well.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_33.jpg" /></div></li><li><p>Select the arrow that goes from <span class="strong"><strong>Idle</strong></span> to <span class="strong"><strong>Jump</strong></span>. It should turn blue in color. Then, in the <span class="strong"><strong>Inspector</strong></span> view, in the <span class="strong"><strong>Conditions</strong></span> box, select the options <span class="strong"><strong>Jump</strong></span> and <span class="strong"><strong>true</strong></span>. Now select <a id="id389" class="indexterm"></a>the arrow that goes back from <span class="strong"><strong>Jump</strong></span> to <span class="strong"><strong>Idle</strong></span>, and select <span class="strong"><strong>Jump</strong></span> and <span class="strong"><strong>false</strong></span> in its <span class="strong"><strong>Conditions</strong></span> box.</p><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_34.jpg" /></div></li><li><p>Repeat the previous step with the arrow that goes from <span class="strong"><strong>Move</strong></span> to <span class="strong"><strong>Jump</strong></span> and vice-versa.</p></li><li><p>Again, apply the instructions from step 12 onwards to the arrows that go from <span class="strong"><strong>TurnLeft</strong></span> and <span class="strong"><strong>TurnRight</strong></span> to <span class="strong"><strong>Idle</strong></span> and vice-versa. In the <span class="strong"><strong>Conditions</strong></span> box, use <span class="strong"><strong>TurnLeft</strong></span> and <span class="strong"><strong>TurnRight</strong></span> (instead of <span class="strong"><strong>Jump</strong></span>) according to the selected state.</p></li><li><p>Select the <span class="strong"><strong>Jump</strong></span> state and, in the <span class="strong"><strong>Inspector</strong></span> view, apply the animated clip from <span class="strong"><strong>Swat:rifle_jump</strong></span> to its <span class="strong"><strong>Motion</strong></span> field.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note16"></a>Note</h3><p>You can experiment with widening the blue segment of the timeline illustrating the transition between <span class="strong"><strong>Jump</strong></span> and <span class="strong"><strong>Idle</strong></span> (and vice-versa), using the handles to get a smoother transition.</p></div><div class="mediaobject"><img src="/graphics/9781849690423/graphics/0423_05_35.jpg" /></div></li><li><p>As described in the previous step, apply the animation clips from <span class="strong"><strong>Swat:turn_left</strong></span> and <span class="strong"><strong>Swat:turning_right_45_degrees</strong></span> to the Motion clips of <span class="strong"><strong>TurnLeft</strong></span> and <span class="strong"><strong>TurnRight</strong></span> respectively.</p></li><li><p>From the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>Swat</strong></span> model. Then, in the <span class="strong"><strong>Inspector</strong></span> view, open the script from the Basic Controller 04 component.</p></li><li><p>Immediately after <a id="id390" class="indexterm"></a>the line <code class="literal">public float transitionTime = 0.25f;</code>, add the following code:</p><div class="informalexample"><pre class="programlisting">public float jumpSpeed = 4.0F;
public float gravity = 20.0F;
private float jumpPos = 0.0f;
private float verticalSpeed = 0;
private float xVelocity = 0.0f;
private float zVelocity = 0.0f;</pre></div></li><li><p>Immediately after the line <code class="literal">if(controller.isGrounded){</code>, add the following code:</p><div class="informalexample"><pre class="programlisting">if (Input.GetKey(KeyCode.Space)) {
    animator.SetBool("Jump", true);
    verticalSpeed = jumpSpeed;
}else{
    animator.SetBool("Jump", false);
}
if(Input.GetKey(KeyCode.Q)){
    animator.SetBool("TurnLeft", true);
    transform.Rotate(Vector3.up * (Time.deltaTime * -45.0f), Space.World);
} else {
    animator.SetBool("TurnLeft", false);	
}
if(Input.GetKey(KeyCode.E)){
    animator.SetBool("TurnRight", true);
    transform.Rotate(Vector3.up * (Time.deltaTime * 45.0f), Space.World);
} else {
    animator.SetBool("TurnRight", false);
}</pre></div></li><li><p>Finally, add the following lines immediately before the final closing bracket of the code:</p><div class="informalexample"><pre class="programlisting">    void OnAnimatorMove(){
        Vector3 deltaPosition = animator.deltaPosition;
        if(controller.isGrounded){
           xVelocity = animator.GetFloat("Speed")  * controller.velocity.x * 0.25f;
           zVelocity = animator.GetFloat("Speed") * controller.velocity.z * 0.25f;
        }
        verticalSpeed += Physics.gravity.y * Time.deltaTime;
        if(verticalSpeed &lt;= 0){
            animator.SetBool("Jump", false);
        }
        deltaPosition.y = verticalSpeed * Time.deltaTime;
        if(!controller.isGrounded){
          deltaPosition.x = xVelocity * Time.deltaTime;
          deltaPosition.z = zVelocity * Time.deltaTime;
        }
        controller.Move(deltaPosition);
        if ((controller.collisionFlags &amp; CollisionFlags.Below) != 0){
            verticalSpeed = 0;
        }
        transform.rotation = animator.rootRotation;
    }</pre></div></li><li><p>Save your <a id="id391" class="indexterm"></a>script and play the scene. You should be able to jump and turn around by using the Space bar, <span class="emphasis"><em>Q</em></span>, and <span class="emphasis"><em>E</em></span> keys respectively. Observe how the character can also turn around while moving.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec207"></a>How it works...</h3></div></div></div><p>We took two different paths to modify our character's transform settings. First, we used the <code class="literal">Rotate</code> command, as in <code class="literal">transform.Rotate(Vector3.up * (Time.deltaTime * -45.0f), Space.World)</code>, to make the character actually turn around when the <span class="emphasis"><em>Q</em></span> and <span class="emphasis"><em>E</em></span> keys are held down. This command was used in conjunction with <code class="literal">animator.SetBool("TurnLeft", true)</code>, which triggered the correct animation clip.</p><p>Also, we used Unity's <code class="literal">OnAnimatorMove()</code> function for overriding the animation's original Root Motion. Observe that, once this function is added to the script, the field <span class="strong"><strong>Apply Root Motion</strong></span> on the Animator component changes from a checked box to <span class="strong"><strong>Handled by Script</strong></span>. In our case, we used it to learn about the character's speed and direction while he is grounded, in order to apply it once he jumps. We also apply gravity when calculating his position, in case his feet are not touching any surface.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec208"></a>There's more...</h3></div></div></div><p>Want to change the character's direction using a horizontal mouse movement? Just uncomment the line <code class="literal">transform.Rotate(Vector3.up * (Time.deltaTime * v * Input.GetAxis("Mouse X") * 90), Space.World)</code>.</p></div></div>