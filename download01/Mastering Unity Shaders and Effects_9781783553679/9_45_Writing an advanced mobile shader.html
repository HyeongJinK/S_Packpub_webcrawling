<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec42"></a>Writing an advanced mobile shader</h2></div></div><hr /></div><p>When we reduced the complexity of the shaders for our mobile build, we lost some of the surface in our astronaut and alien. In this step, we will build a compromise shader that we can use for both of these characters that will improve their appearance and not contribute significantly to the loss of frame rate on our mobile build.</p><p>Both the astronaut and alien should require specular and normal maps to look really good. Unlike the rest of the scenery, they are lit real-time, so we will build a compromise shader that uses some of the <span class="strong"><strong>Physically Based Shading</strong></span> (<span class="strong"><strong>PBS</strong></span>) options:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, click on the <code class="literal">PACKT_Shaders</code> folder to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>In an empty area of the <span class="strong"><strong>Assets</strong></span> panel, right click and choose <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>New Shader</strong></span> | <span class="strong"><strong>Standard Surface Shader</strong></span> from the drop-down list.</p></li><li><p>When the new shader asset is created in the <span class="strong"><strong>Assets</strong></span> panel, rename it <code class="literal">m_character</code>.</p></li><li><p>Double-click on the new shader to open it in MonoDevelop.</p></li><li><p>In MonoDevelop, replace the first line of the shader with the following code:</p><pre class="programlisting">        Shader "PACKT/Mobile/Character" { &#13;
</pre><p>As with our last shader, we can make this one easier to find in our project by making it accessible in the <code class="literal">Mobile</code> subfolder in our <span class="strong"><strong>Shader</strong></span> drop-down list.</p></li><li><p>In the <code class="literal">Properties</code> block, delete the <code class="literal">_Color</code> property line.</p><p>The color tint is unnecessary here, as our albedo texture already handles the surface color.</p></li><li><p>Delete the properties for <code class="literal">_Glossiness</code> and <code class="literal">_Metallic</code>.</p></li><li><p>Add the following lines of code:</p><pre class="programlisting">        _Specular ("Specular", Range(0,1)) = 0.0 &#13;
        _BumpMap("Normal Map", 2D) = "bump" {} &#13;
</pre><p>We are using a range slider to define our specular value here, so we do not need to add an additional texture map to the project.</p><p>We will also define the <code class="literal">_BumpMap</code> property to handle the character's normal map.</p></li><li><p>Within the <code class="literal">CGProgram</code> snippet, amend the default shader directive to read as follows:</p><pre class="programlisting">        #pragma surface surf StandardSpecular fullforwardshadows &#13;
</pre><p>Using the <code class="literal">StandardSpecular</code> directive will allow us to use the specular workflow. Without this, our specular input will not be recognized.</p></li><li><p>Under the <code class="literal">sampler2D MainTex</code> variable definition, add the following line:</p><pre class="programlisting">        sampler2D _BumpMap; &#13;
</pre><p>This will handle the normal map texture.</p></li><li><p>Scroll down to locate the <code class="literal">half _Metallic</code>, <code class="literal">half _Glossiness</code>, and <code class="literal">float4 _Color</code> lines and delete them.</p></li><li><p>Add the following line:</p><pre class="programlisting">        half _Specular; &#13;
</pre><p>This will allow us to use our <code class="literal">_Specular</code> slider input in the shader code.</p></li><li><p>Amend the <code class="literal">surf</code> function line to include the <code class="literal">StandardSpecular</code> directive as follows:</p><pre class="programlisting">        void surf (Input IN, inout SurfaceOutputStandardSpecular o) { &#13;
</pre><p>As we have removed the <code class="literal">_Color</code> variable, we can also remove it from our albedo texture calculation.</p></li><li><p>Locate the <code class="literal">fixed4 c</code> line in the <code class="literal">surf</code> function and amend it to read as follows:</p><pre class="programlisting">        fixed4 c = tex2D (_MainTex, IN.uv_MainTex); &#13;
</pre></li><li><p>Locate the <code class="literal">o.Metallic</code> line and delete it.</p></li><li><p>Amend the <code class="literal">o.Smoothness</code> line to use the <code class="literal">_MainTex</code> alpha as follows:</p><pre class="programlisting">        o.Smoothness = c.a; &#13;
</pre></li><li><p>Add the following line to use the <code class="literal">_Specular</code> slider value as the <code class="literal">specular</code> output:</p><pre class="programlisting">        o.Specular = _Specular; &#13;
</pre></li><li><p>Finally, add the following code to unpack our normal map:</p><pre class="programlisting">        o.Normal = UnpackNormal (tex2D (_BumpMap, IN.uv_MainTex)); &#13;
</pre></li><li><p>Save the shader.</p></li><li><p>Minimize MonoDevelop and return to the main Unity interface.</p></li><li><p>In the <span class="strong"><strong>Hierarchy</strong></span> panel, select the <code class="literal">astronaut</code> game object.</p></li><li><p>In the <span class="strong"><strong>Inspector</strong></span>, modify the three materials to use the new shader.</p></li><li><p>Select the <span class="strong"><strong>Alien</strong></span> game object. Scroll to the bottom of the <span class="strong"><strong>Inspector</strong></span> to locate its material.</p></li><li><p>Replace the material's shader with the <code class="literal">Mobile - Character</code> shader by selecting it from the dropdown list.</p></li></ol></div><p>Open the <span class="strong"><strong>Build Settings</strong></span> window again and rebuild the app on the device.</p><p>Their should be an improvement in the appearance of the alien and astronaut models on the device, as seen in the following illustration:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_09_009.jpg" /><div class="caption">Android build with improved character shaders</div></div><p>
</p><p>If you check the <span class="strong"><strong>Profiler</strong></span> while testing the game, you will see a noticeable increase in the frame rate:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_09_010.jpg" /><div class="caption">The optimized build in the Profiler showing the connected Android device</div></div><p>
</p><p>The improvement in the performance will vary, depending on the device. Crucially, reducing the use of real-time lights, the number of shaders, and the complexity of the light calculations will make a major difference on mobile.</p></div>