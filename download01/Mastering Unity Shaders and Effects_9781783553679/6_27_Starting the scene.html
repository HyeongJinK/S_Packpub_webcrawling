<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec27"></a>Starting the scene</h2></div></div><hr /></div><p>The first scene file of this chapter contains the game objects and lighting setup that we need to get started.</p><p>Using the menu bar at the top of the Unity interface, open the <code class="literal">Chapter6_Start</code> scene by navigating to <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Open Scene</strong></span> | <span class="strong"><strong>Chapter6_Start</strong></span>.</p><p>The following scene shows the research station on the astronaut's arrival:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_06_001.jpg" /><div class="caption">The starting scene's initial state</div></div><p>
</p><p>In the next step, we will take a closer look at the crate model's material setup in the scene.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec30"></a>Altering the crate's secondary material at runtime</h3></div></div></div><p>The crate props in our scene use the standard material with an albedo, metallic, and normal map. As the crate props use the same material, the texture is the same on all the crates.</p><p>For this model, we want to create a slightly unique texture for each crate by applying a number to the albedo texture.</p><p>Let's start by testing the limits of the Standard Shader, firstly by applying the decal to the crate.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec31"></a>Applying a secondary albedo texture</h3></div></div></div><p>Back in <a class="link" href="#" linkend="ch01">Chapter 1</a>, <span class="emphasis"><em>Getting to Grips with Standard Shaders</em></span>, we applied some painted detail to the spacecraft using a secondary map. We will start with the same technique here:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Hierarchy</strong></span> panel, double-click on <code class="literal">crate01</code> to zoom in on it in the <span class="strong"><strong>Scene</strong></span> view:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_06_002.jpg" /><div class="caption">The crate model with its initial material</div></div><p>
</p><p>The crates have a standard material applied to them. The material currently uses an albedo, metallic, and normal map.</p></li><li><p>In the <span class="strong"><strong>Inspector</strong></span>, scroll down until the material properties are visible.</p></li><li><p>Click on the small arrow next to the <code class="literal">crate</code> material's name to see how the maps are applied:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_06_003.jpg" /><div class="caption">The crate material parameters in the Inspector</div></div><p>
</p><p>We need to assign the number decal next.</p></li><li><p>In the <span class="strong"><strong>Project</strong></span> panel, click on the <code class="literal">PACKT_Textures</code> folder to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Double-click on the <code class="literal">researchStation_ext</code> subfolder to open it.</p></li><li><p>In the <span class="strong"><strong>Assets</strong></span> panel, locate the <code class="literal">number3</code> asset and drag it to the crate material's <span class="strong"><strong>Detail Albedo x</strong></span> map slot in the <span class="strong"><strong>Secondary Maps</strong></span> group in the <span class="strong"><strong>Inspector</strong></span>.</p><p>You will see the number added to the texture in the <span class="strong"><strong>Scene</strong></span> view:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_06_004.jpg" /><div class="caption">The crate material with detail texture applied</div></div><p>
</p><p>Currently, all the pixels of JPG are being added to the texture. We need to fix the transparency by applying the alpha mask to the secondary texture.</p></li><li><p>Drag the <code class="literal">number3</code> asset onto the <span class="strong"><strong>Detail Mask</strong></span> slot in the <span class="strong"><strong>Inspector</strong></span>.</p></li></ol></div><p>The numbers are now blended a lot more nicely:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_06_005.jpg" /><div class="caption">The crate's secondary texture with Detail Mask applied</div></div><p>
</p><p>The next step is to scale down and position the number so that it fits within the texture.</p><p>At this point, we may run into an issue with the Standard Shader. <span class="strong"><strong>Detail Mask</strong></span> is set up to use the same UV coordinates as the material's base textures.</p><p>If we try to change the tiling or UV offset, all the maps are affected.</p><p>The best solution is to write another shader in which we have a separate set of coordinates.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec32"></a>Creating a custom decal shader for the crate</h3></div></div></div><p>We will begin writing our new decal shader so that we can apply the crate number correctly:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, double-click on the <code class="literal">PACKT_Shaders</code> folder to view its content in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Create a new shader asset by right-clicking on an empty part of the panel and going to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Shader</strong></span> | <span class="strong"><strong>Standard Surface Shader</strong></span>.</p></li><li><p>Rename the new shader <code class="literal">Decal</code>.</p></li><li><p>Double-click on it to open it in MonoDevelop.</p></li><li><p>Change the shader name definition in the first line to the following:</p><pre class="programlisting">            Shader "PACKT/Decal" { &#13;
</pre><p>This will ensure that the shader appears in the same list as the others that we have created.</p></li><li><p>Delete the <span class="strong"><strong>Properties</strong></span> definitions for <code class="literal">_Glossiness</code> and <code class="literal">_Metallic</code> and replace them with the following:</p><pre class="programlisting">            _Metallic ("Metal (R), Smoothness (A)", 2D) = "white" {} &#13;
            _DecalTex ("Decal Albedo (RGB)", 2D) = "white" {} &#13;
</pre><p>In the default shader base, <span class="strong"><strong>Metallic</strong></span> and <span class="strong"><strong>Glossiness</strong></span> properties are defined by sliders and we want to use a map such as the Standard Shader.</p><p>Smoothness uses the alpha channel of the Metallic texture map, so it does not need its own property.</p><p>The property definition for the decal, <code class="literal">_DecalTex</code>, is identical to the main texture.</p><p>After the start of the Cg snippet, you will see the <code class="literal">Sampler2D</code>
<code class="literal">_MainTex</code> property.</p></li><li><p>Directly after this, add the following lines:</p><pre class="programlisting">            sampler2D _Metallic; &#13;
            sampler2D _DecalTex; &#13;
</pre><p>These lines will allow us to use the texture maps in the shader.</p><p>Within the <code class="literal">input</code> struct, add the following code:</p><pre class="programlisting">            float2 uv_DecalTex; &#13;
</pre><p>We will add a float variable to handle the additional UV coordinates of the decal texture. It is not necessary to add these for the Metallic map, because it uses the same UV coordinates as <code class="literal">_MainTex</code>.</p></li><li><p>Delete the variable definitions for <code class="literal">_Glossiness</code> and <code class="literal">_Metallic</code>, as these are now handled by a texture map.</p></li><li><p>In the <code class="literal">surf</code> function that follows this, locate the following line of code:</p><pre class="programlisting">            fixed4 c = tex2D (_MainTex, IN.uv_MainTex) * _Color; &#13;
</pre><p>This line defines a variable named <code class="literal">c</code>, which combines the texture map with the tint color in the shader. It applies the texture using the UV coordinates. We can do something similar for the decal texture.</p><p>This is the method by which bitmap textures (which require UVs) are transferred into the <code class="literal">input</code> struct.</p></li><li><p>Add the following line of code directly after the <code class="literal">fixed4 c</code> line:</p><pre class="programlisting">            fixed4 d = tex2D (_DecalTex, IN.uv_DecalTex); &#13;
</pre><p>In this case, we just want to apply the texture with the appropriate UV coordinates. We will do the blending in a different line later on.</p></li><li><p>Next, add the following code:</p><pre class="programlisting">            fixed4 m = tex2D (_Metallic, IN.uv_MainTex); &#13;
</pre><p>The <code class="literal">_Metallic</code> map is applied using the <code class="literal">_MainTex</code> UV coordinates. We have no reason to offset it.</p><p>The next line in the shader defines the output albedo:</p><pre class="programlisting">            o.Albedo = c.rgb; &#13;
</pre><p>Let's add the decal texture to this.</p></li><li><p>Replace the <code class="literal">o.Albedo</code> line with the following code:</p><pre class="programlisting">            o.Albedo = lerp (c.rgb, d.rgb, d.a); &#13;
</pre><p>Rather than adding the two textures together here, we will use the <code class="literal">lerp</code> operator to blend the two sets of RGB values. The result is a linear interpolation of <code class="literal">c.rgb</code> and <code class="literal">d.rgb</code> with the weight of <code class="literal">d.a</code>.</p><p>This has the effect of subtracting the decal's alpha channel so that the void areas of the decal do not affect the original texture.</p></li><li><p>Finally, replace the output metallic and glossiness output with the following:</p><pre class="programlisting">            o.Metallic = m.r; &#13;
            o.Smoothness = m.a; &#13;
</pre><p>This will make them use RGB and channels of the <code class="literal">_Metallic</code> texture map respectively.</p></li><li><p>Save the shader.</p></li><li><p>Back in the main Unity interface, make sure that the <code class="literal">crate</code> material properties are still visible in the<span class="strong"><strong> Inspector</strong></span>.</p></li><li><p>Click on the <span class="strong"><strong>Shader</strong></span> selection dropdown at top of the <span class="strong"><strong>Material Properties</strong></span> and select <span class="strong"><strong>PACKT</strong></span> | <span class="strong"><strong>Decal</strong></span>.</p></li><li><p>Drag the <code class="literal">number3</code> texture to the decal texture slot.</p></li><li><p>Increase the <span class="strong"><strong>Tiling X</strong></span> and <span class="strong"><strong>Y</strong></span> values to <code class="literal">19.3</code>.</p><p>The decal texture's UV coordinates can be manipulated separately from those of the main texture:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_06_006.jpg" /><div class="caption">The crate model with the new decal shader</div></div><p>
</p><p>The <code class="literal">number3</code> decal is now tiling 19.3 times across and 19.3 times down our texture. Textures assets are set to tile by default, we need to adjust an import setting to get it to only show up once.</p></li><li><p>Click on the <code class="literal">number3</code> asset in the Assets panel to view the texture's import settings:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_06_007.jpg" /><div class="caption">The number3 texture asset's default import settings</div></div><p>
</p></li><li><p>Set the <span class="strong"><strong>Wrap Mode</strong></span> to <code class="literal">Clamp</code> and click on the <span class="strong"><strong>Apply</strong></span> button to store the change.</p><p>The number decal will disappear. Actually, it is being added to a part of the texture that we cannot see on screen.</p><p>One way to make the placement of the decal easier is to show the material on a flat quad. This way, we can line up the decal with the other details in the texture without having to worry about the geometry.</p></li><li><p>Create a quad using the menu bar by navigating to <span class="strong"><strong>GameObject</strong></span> | <span class="strong"><strong>3D Object</strong></span> | <span class="strong"><strong>Quad</strong></span>.</p></li><li><p>Move it so that it is visible in the <span class="strong"><strong>Scene</strong></span> view.</p></li><li><p>Locate the crate material again by navigating to the <code class="literal">PACKT_Materials</code> folder.</p></li><li><p>Drag the <code class="literal">crate</code> material to the quad in the <span class="strong"><strong>Scene</strong></span> view or <span class="strong"><strong>Hierarchy</strong></span> panel.</p></li><li><p>Use the offset and scale controls to line up the <code class="literal">number3</code> decal on the main texture:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_06_008.jpg" /><div class="caption">Completed decal setup with quad display</div></div><p>
</p></li></ol></div><p>The final values used here are as follows:</p><p>
<span class="strong"><strong>Tiling X</strong></span>: <code class="literal">19.3</code>, <span class="strong"><strong>Tiling Y</strong></span>: <code class="literal">19.3</code>
</p><p>
<span class="strong"><strong>Offset X</strong></span>: <code class="literal">-16.4</code>, <span class="strong"><strong>Offset Y</strong></span>: <code class="literal">-15.6</code>
</p><p>In the next step, we will switch the number decal.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec33"></a>Switching the decal texture at runtime</h3></div></div></div><p>Now that we have a decal added to the <code class="literal">crate</code> material, we can switch the actual number at runtime with a script:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, double-click on the <code class="literal">PACKT_Scripts</code> folder to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Create a new C# script in an empty part of the panel. Right-click and choose <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>C# Script</strong></span> from the drop-down list.</p></li><li><p>Rename the script <code class="literal">crateNumbers</code>.</p></li><li><p>Double-click on it to open it in MonoDevelop.</p><p>In the MonoDevelop window, we will start by creating some variables.</p></li><li><p>Directly inside the script's opening curly bracket, add the following code:</p><pre class="programlisting">            public GameObject [] crateObjects; &#13;
            public Texture2D [] crateTextures; &#13;
            public int arrayIndex; &#13;
</pre></li></ol></div><p>We will create an array of game objects named <code class="literal">crateObjects</code>. This allows us to keep track of the crates that we want to apply the script to.</p><p>Next, we create a texture array named <code class="literal">crateTextures</code> to store the number textures.</p><p>Our last variable, <code class="literal">arrayIndex</code>, stores the position in these arrays. We will apply a different number to each crate, so we only need one index number:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <code class="literal">Start</code> function, add the following code:</p><pre class="programlisting">            foreach (GameObject crate in crateObjects) &#13;
            { &#13;
                arrayIndex++; &#13;
                crate.GetComponent&lt;Renderer&gt;().material.SetTexture("_DecalTex", &#13;
                  crateTextures[arrayIndex]);&#13;
            } &#13;
</pre><p>Here, we will add a <code class="literal">foreach</code> statement that will loop through all the game objects in the <code class="literal">crateObjects</code> array and run the same code on each object.</p><p>Firstly, we will access the selected object's renderer and set its <code class="literal">_DecalTex</code> to the <code class="literal">crateTexture</code> array's current position.</p><p>Then, we will increase <code class="literal">arrayIndex</code> so that the game object and texture are different next time the code is run.</p></li><li><p>Save the script.</p></li><li><p>Minimize MonoDevelop.</p></li><li><p>Back in the main Unity interface, select the <code class="literal">crate_CTRL</code> object in the <span class="strong"><strong>Hierarchy</strong></span> panel.</p></li><li><p>Drag the <code class="literal">crateNumbers</code> script onto this object.</p><p>It may take a moment for the public variables to pop up in the <span class="strong"><strong>Inspector</strong></span> as the editor reads the script.</p></li><li><p>At the top right of the <code class="literal">Inspector</code>, click on the lock icon to maintain focus on the <code class="literal">crate_CTRL</code> object's properties.</p></li><li><p>In the <span class="strong"><strong>Hierarchy</strong></span> panel, select all of the crate objects and drag them to the <span class="strong"><strong>Crate Objects</strong></span> array within the <span class="strong"><strong>Crate Numbers (Script)</strong></span> component in the <span class="strong"><strong>Inspector</strong></span>.</p><p>This will add the crates to the script's array.</p></li><li><p>In the <span class="strong"><strong>Project</strong></span> panel, double-click on the <code class="literal">PACKT_Textures</code> folder to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Double-click on the <code class="literal">researchStation_ext</code> subfolder in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Select <code class="literal">number1</code>, <code class="literal">2</code>, and <code class="literal">3</code> and drag these onto the <span class="strong"><strong>Crate Textures</strong></span> array to populate the array.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip32"></a>Tip</h3><p>The order that you select items in a multiple selection will affect the order in which they are assigned.</p></div></li><li><p>Press the play button to view the effect:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_06_009.jpg" /><div class="caption">Crate material instances displaying unique decal numbers at runtime</div></div><p>
</p></li></ol></div><p>When the game runs, the numbers on each of the crates are unique. This works because the material assigned to a mesh renderer at runtime is a unique instance of the material in the project.</p><p>In the next step, we will take a closer look at Unity's built-in light models.</p></div></div>