<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec11"></a>Opening the project</h2></div></div><hr /></div><p>If you have not already done so, download and install the shaders and effects project ZIP from the Packt's website. This file contains the Unity asset package containing all the scene assets used throughout this book.</p><p>In <a class="link" href="#" linkend="ch01">Chapter 1</a>, <span class="emphasis"><em>Getting to Grips with Standard Shaders</em></span>, we set up <span class="strong"><strong>Standard Surface</strong></span> materials for most of the surfaces in our space scene. If you skipped this stage and have not set up the Unity project, you may want to do this so that you can follow the examples in this chapter.</p><p>One surface that we did not create a new material for is the planet's moon. We will start by creating a very basic shader to use with the moon in our scene.</p><p>This will be a good opportunity to see a shader work as we create it.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec13"></a>Opening the scene</h3></div></div></div><p>The scene file for this chapter contains the models and materials that we will be working on.</p><p>In the Unity project, load the <code class="literal">Chapter2_Start</code> scene. From the menu bar, select <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Open</strong></span>. In the dialog that appears, click to open the <code class="literal">PACKT_Scenes</code> folder and select <code class="literal">Chapter2_Start</code> from the list.</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_02_001.jpg" /><div class="caption">The Chapter2_Start scene initial state</div></div><p>
</p><p>We are starting at the same place we left in <a class="link" href="#" linkend="ch01">Chapter 1</a>, <span class="emphasis"><em>Getting to Grips with Standard Shaders</em></span>. The scene again shows the <span class="strong"><strong>Sotello</strong></span> spacecraft as it stops for repairs on its way to the planet <span class="strong"><strong>Ridley VI</strong></span>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec14"></a>Creating our first custom shader</h3></div></div></div><p>Unity shaders use <span class="strong"><strong>ShaderLab</strong></span> for the main part of the shader and often Cg for the more complex functions. We will start with the main part of the shader.</p><p>We will write this shader from scratch, explaining the structure and syntax as we go:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, click on the <code class="literal">PACKT_Shaders</code> folder.</p><p>The folders contents will become visible in the <span class="strong"><strong>Assets</strong></span> panel.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip12"></a>Tip</h3><p>The <code class="literal">Final_Shaders</code> subfolder currently contains the finalized code that you may use for reference.</p></div></li><li><p>Create a new shader by right-clicking on an empty area of the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Navigate to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Shader</strong></span> | <span class="strong"><strong>Standard Surface Shader</strong></span>.</p></li><li><p>Rename the shader<code class="literal"> Moon</code>.</p><p>The name of the shader asset is different from its name that will appear in the shader list, we will define that in the code.</p></li><li><p>Double-click on <code class="literal">Moon</code> in the <span class="strong"><strong>Assets</strong></span> panel to open it in <span class="strong"><strong>MonoDevelop</strong></span>.</p><p>The shader that we created contains the default code that we will delete. We will write this first shader from scratch to get a better handle on the syntax.</p></li><li><p>In MonoDevelop, select all the code (use the <span class="emphasis"><em>Ctrl + A</em></span> hotkey combination or <span class="emphasis"><em>command + A</em></span> if you are working on a Mac).</p></li><li><p>Delete the code (<span class="emphasis"><em>Delete</em></span> or <span class="emphasis"><em>command + Delete</em></span> on a Mac).</p><p>We will start by defining the name of the shader that will appear in the shader list that can be selected in a material.</p></li><li><p>Add the following line of code:</p><pre class="programlisting">        Shader "PACKT/Moon" {&#13;
        }</pre></li></ol></div><p>This defines the code as a shader and designates how it will be selected in the shader list within the project.</p><p>We can organize new shaders by adding the folder name before the name of the shader. If the folder name is not already defined by another shader, it will be created.</p><p>Here we designate the folder as <code class="literal">PACKT</code> to separate our created shaders from those provided in <code class="literal">Standard Assets</code>.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip13"></a>Tip</h3><p>The actual name of the shader is defined here and can be different from the name of the shader file that we defined in the <span class="strong"><strong>Assets</strong></span> panel, though this can make it more confusing when you want to go back and find a shader to make changes later on.</p></div><p>Next we will define the shader's properties.</p><p>Between the opening and closing curly brackets, add the following code:</p><pre class="programlisting">Properties { &#13;
    _Color ("Color", Color) = (1,1,1,1) &#13;
} &#13;
</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip14"></a>Tip</h3><p>The <code class="literal">Properties</code> block contains the raw materials of the shader, such as a defined color, diffuse texture, and a slider that can be tweaked in the material.</p><p>Properties are analogous to public variables in a regular <span class="strong"><strong>C#</strong></span> or <span class="strong"><strong>UnityScript</strong></span> code.</p></div><p>We are defining a property for <code class="literal">_Color</code>. The name of the property at the start of the line of code is usually prefixed with an underscore. This is the property name used in the main body of the shader.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip15"></a>Tip</h3><p>The name that we put in quotation marks is the name of the property that will appear in the <span class="strong"><strong>Material Inspector</strong></span>. Color properties are defined as a series of four decimal values: <span class="strong"><strong>R</strong></span>, <span class="strong"><strong>G</strong></span>, <span class="strong"><strong>B</strong></span>, and <span class="strong"><strong>A</strong></span>.</p></div><p>Here we are defining the color as full white, with the alpha at its maximum value. For our project, we can change this color here in the shader code or later when the shader is used in a material.</p><p>After the <code class="literal">Properties</code> block, add the following code:</p><pre class="programlisting">SubShader { &#13;
    Pass &#13;
    { &#13;
        Color[_Color] &#13;
    } &#13;
} &#13;
</pre><p>
<code class="literal">subShader</code> contains the main body of the shader and processes any input colors, textures, or other values.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip16"></a>Tip</h3><p>All shaders include at least one <code class="literal">subShader</code>. Their primary function is to separate different shader definitions. This feature allows us to create a shader that will work on multiple devices.</p><p>When a shader is used in an application, the system will run the next best <code class="literal">subShader</code> if the first is incompatible with the GPU.</p><p>We will be looking more closely at shader compatibility in <a class="link" href="#" linkend="ch09">Chapter 9</a>, <span class="emphasis"><em>Optimizing Shaders for Mobile</em></span>.</p></div><p>
<code class="literal">subShader</code> contains a single <code class="literal">Pass</code>, which is the minimum requirement for a shader such as this:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Add the following code inside the <code class="literal">Pass</code> brackets:</p><pre class="programlisting">        Color [_Color] &#13;
</pre></li><li><p>Save the shader.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note17"></a>Note</h3><p>This shader is written in <span class="strong"><strong>ShaderLab</strong></span>, which is the standard language and syntax for Unity shaders. Later examples will also use <span class="strong"><strong>Cg</strong></span>—a dialect of <span class="strong"><strong>C</strong></span>. The <span class="strong"><strong>g</strong></span> stands for graphics. This version is primarily used for shaders.</p></div><p>The finished code should appear as follows:</p><pre class="programlisting">        Shader "PACKT/Moon"&#13;
        {&#13;
            Properties {&#13;
                _Color ("Color", Color) = (1,0.5,0,1) &#13;
            } &#13;
 &#13;
            SubShader { &#13;
 &#13;
                Pass &#13;
                { &#13;
                    Color [_Color] &#13;
                } &#13;
            } &#13;
        } &#13;
</pre><p>This is just about as simple as we can get with a shader that will work in Unity 5.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip18"></a>Tip</h3><p>Be careful with opening/closing brackets, as missing one of these or putting it in the wrong place will prevent the shader from running.</p></div></li><li><p>Minimize MonoDevelop and return to the main Unity interface.</p></li></ol></div><p>In the next section, we will apply our newly created shader to a material and see how it looks in the scene.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl3sec2"></a>Seeing the shader in action</h4></div></div></div><p>At this point, we have created our first simple shader and want to see it on a surface in our scene. This stuff:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Hierarchy</strong></span> panel, double-click on the<code class="literal"> smallMoon</code> game object to select it and zoom in on it in our scene:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_02_002.jpg" /><div class="caption">The smallMoon game object in the scene</div></div><p>
</p><p>The <code class="literal">smallMoon</code> game object still uses Unity's default gray material. We need to create a unique material for it next.</p></li><li><p>In the <span class="strong"><strong>Project</strong></span> panel, click on the <code class="literal">PACKT_Materials</code> folder to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Right-click on an empty area of the <span class="strong"><strong>Assets</strong></span> panel and choose <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Material</strong></span> from the drop-down list.</p></li><li><p>When the material asset icon appears in the <span class="strong"><strong>Assets</strong></span> panel, rename it <code class="literal">Moon</code>.</p><p>The new material's properties will be visible in the <span class="strong"><strong>Inspector</strong></span>.</p></li><li><p>Click on the <span class="strong"><strong>Shader</strong></span> drop-down list at the top of the <span class="strong"><strong>Inspector</strong></span>.</p></li><li><p>Choose <span class="strong"><strong>PACKT/Moon</strong></span> from the list.</p><p>The material's properties will update in the <span class="strong"><strong>Inspector</strong></span>:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_02_003.jpg" /><div class="caption">The Moon material's properties in the Inspector</div></div><p>
</p><p>The material has a single <code class="literal">Color</code> property.</p></li><li><p>Apply the material to the <code class="literal">smallMoon</code> game object by dragging it from the <span class="strong"><strong>Assets </strong></span>panel onto the cube's surface.</p></li><li><p>In the <span class="strong"><strong>Inspector</strong></span>, click within the <span class="strong"><strong>Color</strong></span> swatch and define a deep red color.</p></li><li><p>In the <span class="strong"><strong>Scene</strong></span> view, the moon will change color:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_02_004.jpg" /><div class="caption">The Moon material with the custom shader and a color property applied</div></div><p>
</p></li></ol></div><p>The result of the shader is a uniform colored surface that has no shadows or highlights.</p><p>This is a typical unlit shader that is very cheap on performance.</p><p>In the next step, we will add a texture to the shader.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl3sec3"></a>Adding a texture to the moon shader</h4></div></div></div><p>We can improve the complexity of the moon's surface by adding a texture map to the material. To allow this, we need to make some edits to the shader:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Return to MonoDevelop.</p></li><li><p>In the <code class="literal">Properties</code> block, near the top of the shader, add the following code:</p><pre class="programlisting">        _MainTex ("Albedo (RGB)", 2D) = "white" {} &#13;
</pre><p>Here, we will define a property called <code class="literal">_MainTex</code>. This is the standard name used in Unity for a primary texture map, which is usually used for the Albedo component of a shader. The name in quotation marks is the label that will appear when we see the material in the <span class="strong"><strong>Inspector</strong></span>.</p></li><li><p>In the <code class="literal">Pass</code> block, add the following code after the <code class="literal">Color</code> line:</p><pre class="programlisting">        SetTexture [_MainTex] { &#13;
            Combine Primary * Texture &#13;
        } &#13;
</pre><p>Here, we will set the texture, calling it by its property name. We will then apply it, multiplying it over the original (or <code class="literal">Primary</code>) content.</p></li><li><p>Save the shader.</p></li><li><p>Return to the main Unity interface.</p><p>If the shader compiles correctly, a new texture slot will have appeared in the material properties section in the <span class="strong"><strong>Inspector</strong></span>:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_02_005.jpg" /><div class="caption">The Moon material with the new Albedo texture slot</div></div><p>
</p><p>We can now apply the appropriate texture.</p></li><li><p>In the <span class="strong"><strong>Project</strong></span> panel, click on the <code class="literal">PACKT_Textures</code> folder to open its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Locate the <code class="literal">moon_albedo</code> texture and drag this to the <code class="literal">Moon</code> material's <span class="strong"><strong>Albedo</strong></span> slot in the <span class="strong"><strong>Inspector</strong></span>.</p></li><li><p>In the <span class="strong"><strong>Scene</strong></span> view, the <code class="literal">smallMoon</code> game object will update to show the texture applied:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_02_006.jpg" /><div class="caption">The moon with its albedo texture applied</div></div><p>
</p></li></ol></div><p>The bitmap texture blends with the color on the surface of the moon.</p><p>This improves the appearance of the moon, but it is still not responding to our scene lighting.</p><p>To get shadows on the surface, we need to add more code to the shader.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl3sec4"></a>Making the moon shader compatible with the scene lighting</h4></div></div></div><p>We need to make some changes to the shader code to allow our <code class="literal">Moon</code> material to respond well to the scene lighting:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Return to MonoDevelop.</p><p>Most Unity shaders use Cg for their functions. In this case, this will replace our existing pass.</p></li><li><p>Select and delete the <span class="strong"><strong>Pass</strong></span> block in the shader.</p></li><li><p>Add the following code in its place:</p><pre class="programlisting">        CGPROGRAM &#13;
</pre><p>This is the start of our Cg snippet, where we will define and process our properties.</p></li><li><p>Tap <span class="emphasis"><em>
<span class="strong"><strong>Enter</strong></span>
</em></span> a few times to create a little space before adding the following line:</p><pre class="programlisting">        ENDCG &#13;
</pre><p>This is the end of the Cg snippet. Our Cg code needs to be contained between these two tags.</p><p>We will start adding more code between the Cg tags.</p></li><li><p>Add the following line directly after our opening <code class="literal">CGPROGRAM</code> tag:</p><pre class="programlisting">        #pragma surface surf Lambert &#13;
</pre><p>This line is called the <span class="strong"><strong>shader compilation directive</strong></span>.</p><p>A line such as this always follows the opening Cg tab. This defines the lighting model and the shader functions to be compiled when the shader runs.</p><p>In this case, we are using the <span class="strong"><strong>Lambert</strong></span> model, which allows shadows.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip19"></a>Tip</h3><p>The Cg tags and the shader directive are colored magenta within MonoDevelop, distinguishing them from the rest of the code.</p></div></li><li><p>Next, add the following code:</p><pre class="programlisting">        struct Input {&#13;
            float2 uv_MainTex;&#13;
        };</pre><p>The <code class="literal">Input</code> struct contains the UV data that will allow us to apply the texture to the model's surface correctly.</p><p>The UV data is contained here as <code class="literal">float2</code>: a variable consisting of two float values.</p></li><li><p>Next, add the following code:</p><pre class="programlisting">        sampler2D _MainTex; &#13;
        float4 _Color; &#13;
</pre><p>Here, we are processing our properties into Cg variables that can be calculated in the shader. Firstly, our texture, <code class="literal">_MainTex</code>, and then <code class="literal">_Color</code>, which is a <code class="literal">float4</code> variable consisting of R, G, B, and A channel values.</p><p>Finally, we will add the main part of the shader.</p></li><li><p>Add the following code:</p><pre class="programlisting">        void surf (Input IN, inout SurfaceOutput o) { &#13;
            o.Albedo = tex2D (_MainTex, IN.uv_MainTex).rgb * _Color.rgb; &#13;
        } &#13;
</pre><p>The <code class="literal">surf</code> function combines the input data and defines the shader output, denoted here with the <code class="literal">o</code> variable name.</p><p>The only output our shader has to deal with is the <code class="literal">Albedo</code> texture, as the lighting is already defined by the lighting model that we specified.</p><p>We will multiply the <code class="literal">_MainTex</code> 
<code class="literal">rgb</code> data by the <code class="literal">_Color</code> 
<code class="literal">rgb</code> data to get our output color.</p></li><li><p>Save the shader and return to the main Unity interface.</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_02_007.jpg" /><div class="caption">The moon with a Lambert shader applied</div></div><p>
</p></li></ol></div><p>When the shader compiles, we should be able to see a variation in the lightness of the surface as the moon responds to the single scene light.</p><p>In the next step, we will take a look at how physically-based rendering can be used to create a more sophisticated shader that also works with the scene lighting.</p><p>We will do this by creating a custom shader for the astronaut character's transparent helmet.</p></div></div></div>