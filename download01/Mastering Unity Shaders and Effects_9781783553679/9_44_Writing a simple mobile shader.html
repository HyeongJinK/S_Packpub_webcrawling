<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec41"></a>Writing a simple mobile shader</h2></div></div><hr /></div><p>Mobile shaders tend to be more efficient—ready to be run with fewer and smaller textures for a reduced screen size.</p><p>Unity comes with quite a few Mobile shaders ready to be used in a project. Unlike the Standard shaders, mobile shaders are not automatically optimized, so they need to include the exact inputs and features that you want to use in a material.</p><p>One shader that is missing is a <span class="strong"><strong>Mobile Diffuse Specular</strong></span> shader. We can write this shader and compare it in our mobile build:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the<span class="strong"><strong> Project</strong></span> panel, select the <code class="literal">PACKT_Shaders</code> folder to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>In an empty area of the <span class="strong"><strong>Assets</strong></span> panel, create a new shader asset. Right-click and choose <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Shader</strong></span> | <span class="strong"><strong>Standard Surface Shader</strong></span>.</p><p>A new shader will be created in the folder.</p></li><li><p>Rename the shader <code class="literal">m_diffuse_spec</code>.</p><p>In this case, we will be deleting all the default code and writing the shader from scratch, but we need the shader shell set up in the <span class="strong"><strong>Assets</strong></span> Unity project folder.</p></li><li><p>Double-click on the <code class="literal">m_diffuse_spec</code> asset to open the shader in <span class="strong"><strong>MonoDevelop</strong></span>.</p></li><li><p>In MonoDevelop, select and delete all of the default code.</p></li><li><p>Start the shader with the following line of code:</p><pre class="programlisting">        Shader "PACKT/Mobile/diffuse_specular" { &#13;
</pre><p>The first line defines the shader's name that will appear in the selection list of <span class="strong"><strong>Material</strong></span>. Here, we will add in another subfolder so that the mobile shaders will be distinct from the other shaders that we have in the project.</p></li><li><p>Next, add the following code:</p><pre class="programlisting">        Properties { &#13;
            _MainTex ("Base (RGB) Gloss (A)", 2D) = "white" {} &#13;
            _Shininess ("Shininess", Range (0.03, 1)) = 0.078125 &#13;
        } &#13;
</pre><p>We will add our common <code class="literal">_MainTex</code> property to handle our albedo texture. Unlike in some of the other shaders we have written, we will omit the <code class="literal">_Color</code> property. The tint color is an additional line of code that will increase the performance cost of the shader.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip38"></a>Tip</h3><p>The default code for the <code class="literal">_Color</code> variable also uses a <code class="literal">float4</code> variable, which is the highest precision float and largest data size. Omitting it will be a significant optimization to this shader.</p></div><p>In this case, the glossiness will be included as an alpha channel in the texture map, so we can define the specularity, or shininess, as a simple value.</p><p>Next, we will add the <code class="literal">SubShader</code> section.</p></li><li><p>Add the following code:</p><pre class="programlisting">        SubShader {&#13;
            Tags { "RenderType"="Opaque" } &#13;
            LOD 250 &#13;
</pre><p>The <code class="literal">SubShader</code> encapsulates the rest of the code in the shader and can be used to separate the different versions that can run on low-end devices if necessary. For now, we will use simple tags. The surface that the shader will be used for is not transparent, so we will use the <code class="literal">Opaque</code> render type.</p><p>The <code class="literal">LOD</code> value defines the distance in world units that the surface handled by the shader will still be written for. Giving a shader a higher <span class="strong"><strong>Level of Detail</strong></span> (<span class="strong"><strong>LOD</strong></span>) value ensures that it will still be written.</p><p>In this case, our scene is a small enclosed space, so the LOD value in this shader will never have to be compared.</p><p>Next, we will add our CG snippet.</p></li><li><p>Add the following code:</p><pre class="programlisting">        CGPROGRAM &#13;
        #pragma surface surf MobileBlinnPhong exclude_path:prepass &#13;
          nolightmap noforwardadd halfasview interpolateview&#13;
</pre><p>Within the CG part of the shader, we will include the shader compile directive that allows us to specify the kind of shader we are creating and the inputs to be read.</p><p>In this case, we are using the <code class="literal">MobileBlinnPhong</code> shader, which is defined in the <code class="literal">CGIncludes</code> file. We will set the shader to not use light maps; typically, textures used in fixed assets on mobiles incorporate lighting in their main texture.</p><p>The <code class="literal">noforwardadd</code> keyword restricts the scene lighting to a single directional light. Other lights in the scene can still affect the object if baked into light probes. The next keyword, <code class="literal">halfasview</code>, combines and normalizes the light direction and view direction, speeding up the lighting calculation.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip39"></a>Tip</h3><p>There are some more good suggestions for optimizing shaders on the Unity website at:
<a class="ulink" href="https://docs.unity3d.com/Manual/SL-ShaderPerformance.html" target="_blank">https://docs.unity3d.com/Manual/SL-ShaderPerformance.html</a>.</p></div><p>Next, we will define the shader's lighting interaction.</p></li><li><p>Add the following code:</p><pre class="programlisting">        inline fixed4 LightingMobileBlinnPhong (SurfaceOutput s, fixed3 &#13;
          lightDir, fixed3 halfDir, fixed atten)&#13;
        { &#13;
            fixed diff = max (0, dot (s.Normal, lightDir)); &#13;
            fixed nh = max (0, dot (s.Normal, halfDir)); &#13;
            fixed spec = pow (nh, s.Specular*128) * s.Gloss; &#13;
     &#13;
            fixed4 c; &#13;
            c.rgb = (s.Albedo * _LightColor0.rgb * diff + _LightColor0.rgb &#13;
              * spec) * atten;&#13;
            UNITY_OPAQUE_ALPHA(c.a); &#13;
            return c; &#13;
        } &#13;
</pre><p>Here, we will create variables to keep track of the light direction and attenuation that we will pass to the shader in order to determine the amount of specularity that we should add to the shader output.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip40"></a>Tip</h3><p>Using fixed float variables is a great optimization for mobile. Fixed floats are the lowest precision numbers and take less computing time than float or half types.</p></div><p>Next, we need to set up some variables to handle the texture map input.</p></li><li><p>Add the following code:</p><pre class="programlisting">        sampler2D _MainTex;&#13;
        half _Shininess; &#13;
</pre><p>We will add a <code class="literal">sampler2D</code> variable to process our <code class="literal">_MainTex</code> input and a <code class="literal">half</code> variable, four eight-bit channels, to handle the <code class="literal">_Shininess</code> slider input.</p><p>Next, we need to set up a variable to handle the UV coordinates for <code class="literal">_MainTex</code>.</p></li><li><p>Add the following code:</p><pre class="programlisting">        struct Input { &#13;
            float2 uv_MainTex; &#13;
        }; &#13;
</pre><p>The <code class="literal">uv_MainTex</code> float will be used in the <code class="literal">surf</code> output definition to apply our albedo texture.</p><p>Our next step is to set up the <code class="literal">surf</code> function.</p></li><li><p>Add the following code:</p><pre class="programlisting">        void surf (Input IN, inout SurfaceOutput o) { &#13;
            fixed4 tex = tex2D(_MainTex, IN.uv_MainTex); &#13;
            o.Albedo = tex.rgb; &#13;
            o.Gloss = tex.a; &#13;
            o.Alpha = tex.a; &#13;
            o.Specular = _Shininess; &#13;
        } &#13;
</pre><p>We will define the surface output values as we have done before. This time, the <code class="literal">_MainTex</code> values do not have to be multiplied by <code class="literal">_Color</code>, as this has been omitted.</p><p>In the <code class="literal">o.Albedo</code> line, we need to specify <code class="literal">tex.rgb</code> as the output because the texture has four channels and albedo can only use three.</p><p>We will specify the <code class="literal">Gloss</code> and <code class="literal">Alpha</code> output as <code class="literal">tex.a</code>. Note that we have to specify an output for <code class="literal">Alpha</code> to satisfy the shader type input requirements, even though, as an opaque shader, the transparency is never implemented.</p><p>We still need to close the CG snippet.</p></li><li><p>Add the following line:</p><pre class="programlisting">        ENDCG &#13;
</pre><p>We will then need to add a closing curly bracket to terminate <code class="literal">SubShader</code>, otherwise the shader will fail to compile.</p></li><li><p>Add the closing curly bracket in the next line.</p><p>Lastly, we can specify a suitable fallback shader that can be run on an older device that cannot handle this shader.</p></li><li><p>Add the following code:</p><pre class="programlisting">        FallBack "Mobile/VertexLit" &#13;
</pre></li><li><p>Add the closing bracket to end the shader.</p></li><li><p>Save the shader and minimize MonoDevelop.</p></li></ol></div><p>It is time to view the shader in the <span class="strong"><strong>Scene</strong></span> view and test it in our build.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec46"></a>Replacing shaders in scene materials</h3></div></div></div><p>At this point, we will need to replace the scene shaders with our new mobile shader.</p><p>We can quickly select all of our scene materials with the <span class="strong"><strong>Select Dependencies</strong></span> option in the <span class="strong"><strong>Assets</strong></span> panel:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, click on the <code class="literal">PACKT_Scenes</code> folder to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>In the <span class="strong"><strong>Assets</strong></span> panel, locate the <code class="literal">Chapter9_Start</code>.</p></li><li><p>Right-click on the <code class="literal">Chapter9_Start</code> asset.</p></li><li><p>Choose <span class="strong"><strong>Select Dependencies</strong></span> from the drop-down list that appears.</p><p>All the assets that the scene uses will appear in the <span class="strong"><strong>Assets</strong></span> panel.</p><p>In the <span class="strong"><strong>Inspector</strong></span>, you will see a list of the assets sorted by type:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_09_007.jpg" /><div class="caption">Selected scene materials</div></div><p>
</p></li><li><p>Click on the <span class="strong"><strong>Materials</strong></span> list item to select all the Materials in the scene.</p><p>There are a few materials that we don't want to replace with this shader.</p></li><li><p>Deselect the <span class="strong"><strong>Starfield</strong></span> and <span class="strong"><strong>Helmet</strong></span> materials in the <span class="strong"><strong>Assets</strong></span> panel by <span class="emphasis"><em>Ctrl</em></span> + clicking them (Use <span class="emphasis"><em>command</em></span> + click if you are working on Mac).</p><p>These materials require more complexity than our custom shader can handle, so we will leave this as they are.</p><p>The remaining scene materials are still selected and the sample spheres will be visible in the <span class="strong"><strong>Inspector</strong></span>.</p></li><li><p>At the top of the <span class="strong"><strong>Inspector</strong></span>, click on the <span class="strong"><strong>Shader</strong></span> selection and choose <span class="strong"><strong>PACKT</strong></span> | <span class="strong"><strong>Mobile</strong></span> | <span class="strong"><strong>diffuse_specular</strong></span> from the drop-down list.</p><p>This will cause the surfaces in the scene to be overlit. We can compensate for this by reducing the strength of the main light.</p></li><li><p>In the <span class="strong"><strong>Hierarchy</strong></span> panel select the <span class="strong"><strong>Directional Light</strong></span>.</p></li><li><p>In the <span class="strong"><strong>Inspector</strong></span>, reduce the <span class="strong"><strong>Intensity</strong></span> value to <code class="literal">0.5</code>.</p><p>This will result in more even lighting in the <span class="strong"><strong>Game</strong></span> and <span class="strong"><strong>Scene</strong></span> views:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_09_008.jpg" /><div class="caption">The scene is now using the custom mobile shader</div></div><p>
</p></li><li><p>Delete the previous build from your test device.</p></li><li><p>Open the <span class="strong"><strong>Build Settings</strong></span> window by navigating to <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Build Settings</strong></span>.</p></li><li><p>Run a new build by clicking on the <span class="strong"><strong>Build</strong></span> button.</p></li></ol></div><p>Generally speaking, the fewer shaders you can get away with using in a mobile project, the better.</p><p>The shader we just implemented is very simple and we may want to make hero assets in our scene, such as the astronaut and alien intruder, look a bit more special by incorporating some of the physically-based rendering techniques that Unity 5 gives us to work with.</p><p>These elements are likely to receive more scrutiny in the game and should be lit with real-time lights as they will move at runtime. We will write a more advanced shader next.</p></div></div>