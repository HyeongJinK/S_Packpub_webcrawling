<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec23"></a>Starting the scene</h2></div></div><hr /></div><p>The planet surface is represented by some basic primitives and other more complex models. In this section, we will be setting up environmental effects using transparent features available in the shaders:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, click on the <code class="literal">PACKT_Scenes</code> folder to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>In the <span class="strong"><strong>Assets</strong></span> panel, locate <code class="literal">Chapter5_Start</code> and double-click on it to load the scene:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_05_001.jpg" /><div class="caption">Our starting point</div></div><p>
</p></li></ol></div><p>The scene is currently set up with <span class="strong"><strong>Standard Shader</strong></span> materials and default lighting. In the next step, we will add fog to make the environment more ambient.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec27"></a>Creating the dust cloud material</h3></div></div></div><p>The surface of Ridley VI is made inhospitable by dangerous nitrogen storms. In our game scene, these are represented by dust cloud planes situated near to the surface.</p><p>Next, we need to set up the materials for these clouds, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, click on the <code class="literal">PACKT_Materials</code> folder to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>In the <span class="strong"><strong>Assets</strong></span> panel, right-click on an empty area and choose <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Material</strong></span>.</p></li><li><p>Rename the material <code class="literal">DustCloud</code>.</p></li><li><p>In the <span class="strong"><strong>Hierarchy</strong></span> panel, click to select the <code class="literal">dustCloud</code> game object.</p><p>The object's properties will appear in the <span class="strong"><strong>Inspector</strong></span>.</p></li><li><p>Drag the <code class="literal">DustCloud</code> material from the <span class="strong"><strong>Assets</strong></span> panel to the <span class="strong"><strong>Materials</strong></span> field in the <span class="strong"><strong>Mesh Renderer</strong></span> property that is visible in the <span class="strong"><strong>Inspector</strong></span>.</p><p>Next, we will set the texture map for the material.</p></li><li><p>Reselect the <code class="literal">DustCloud</code> material by clicking on it in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>Lock the <span class="strong"><strong>Inspector</strong></span> by clicking the small lock icon in the top right-hand corner of the panel.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip29"></a>Tip</h3><p>Locking the Inspector allows you to maintain focus on assets while you are hooking up an associated asset in your project.</p></div></li><li><p>In the <span class="strong"><strong>Project</strong></span> panel, click on the <code class="literal">PACKT_Textures</code> folder.</p></li><li><p>Locate the <code class="literal">strato</code> texture map and drag it to the <code class="literal">DustCloud</code> material's <span class="strong"><strong>albedo</strong></span> texture slot in the <span class="strong"><strong>Inspector</strong></span>.</p><p>The texture map contains four atlassed variations of the cloud effect. We need to adjust the amount of texture shown in the material.</p></li><li><p>In the <span class="strong"><strong>Inspector</strong></span>, set the <span class="strong"><strong>Tiling Y</strong></span> value to <code class="literal">0.25</code>.</p></li></ol></div><p>This will ensure that only a quarter of the complete height of the texture will be used in the material.</p><p>The texture map also contains opacity data. To use this in our material, we need to adjust the <span class="strong"><strong>Rendering Mode</strong></span>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note30"></a>Note</h3><p>The Standard Shader's rendering mode allows us to specify the opaque nature of a surface.</p><p>Most often, scene objects are <span class="strong"><strong>Opaque</strong></span>. Objects behind them are blocked by them and are not visible through their surface.</p><p>The next option, <span class="strong"><strong>Cutout</strong></span>, is used for surfaces containing areas of complete opacity and complete transparency, such as leaves on a tree or a chain link fence. Opacity is basically on or off for each pixel in a texture.</p><p>Fade allows objects to have cutout areas where the pixels are completely transparent or partially transparent.</p><p>The <span class="strong"><strong>Transparent </strong></span>option is suitable for truly transparent surfaces, such as windows, glass, and some kinds of plastic. When specular is used with a transparent material, it is applied over the entire surface, making it unsuitable for cutout effects.</p></div><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_05_002.jpg" /><div class="caption">Comparison of Standard Shader transparency types</div></div><p>
</p><p>The <span class="strong"><strong>Fade</strong></span> Rendering Mode is the best option for our <code class="literal">DustCloud</code> material as we want the cloud objects to be cutouts so that the edges of the quad where the material is applied to is not visible.</p><p>We want the surface to be partially transparent so that other <code class="literal">dustCloud</code> quads are visible behind them, blending the effect. We can make this change in the standard shader:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>At the top of the material properties in the <span class="strong"><strong>Inspector</strong></span>, click on the <span class="strong"><strong>Rendering Mode</strong></span> drop-down menu and set it to <code class="literal">Fade</code>.</p></li><li><p>Add the <code class="literal">DustCloud</code> material to other <code class="literal">dustCloud</code> objects by dragging the material onto them in the <span class="strong"><strong>Hierarchy</strong></span> panel.
The dust clouds' appearance will change in the <span class="strong"><strong>Scene</strong></span> and <span class="strong"><strong>Game</strong></span> views:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_05_003.jpg" /><div class="caption">Transparent DustCloud material applied</div></div><p>
</p></li></ol></div><p>The dust clouds should now be visible with their opacity reading correctly, as shown in the preceding image.</p><p>In the next step, we will add some further environmental effects to the scene.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec28"></a>Adding fog to the scene</h3></div></div></div><p>In this step, we will add fog to the scene. Fog can be set to fade out distant background elements to reduce the amount of scenery that needs to be rendered. It can be colored, allowing us to blend elements together and give our scene some depth:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>If the <span class="strong"><strong>Lighting</strong></span> tab is not already visible in the Unity project, activate it from the menu bar by going to <span class="strong"><strong>Windows</strong></span> | <span class="strong"><strong>Lighting</strong></span>.</p></li><li><p>Dock the <span class="strong"><strong>Lighting</strong></span> panel if necessary.</p></li><li><p>Scroll down to the bottom to locate the <span class="strong"><strong>Fog</strong></span> properties group.</p></li><li><p>Check the checkbox next to <span class="strong"><strong>Fog</strong></span> to enable it.</p><p>You will see that fog is added to the environment in the <span class="strong"><strong>Scene</strong></span> view as shown in the following image. The default values do not quite match what we need on the planet's surface environment:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_05_004.jpg" /><div class="caption">Unity's default fog effect</div></div><p>
</p></li><li><p>Click within the color swatch next to <span class="strong"><strong>Fog Color</strong></span> to define the color value.</p></li><li><p>When the color picker appears over the main Unity interface, type the hex code <code class="literal">E8BE80FF</code> in the <span class="strong"><strong>Hex Color</strong></span> field near the bottom, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_05_005.jpg" /><div class="caption">Fog effect color selection</div></div><p>
</p><p>This will define a yellow orange color that is appropriate for our planet's atmosphere.</p></li><li><p>Decrease the fog slightly by reducing the <span class="strong"><strong>Density</strong></span> value to <code class="literal">0.05</code>.
The fog will change in the <span class="strong"><strong>Game</strong></span> view, showing the reduced density:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_05_006.jpg" /><div class="caption">Adjusted fog blended with dust cloud transparencies</div></div><p>
</p></li></ol></div><p>Our dust cloud objects are getting blended in with the fog as shown in the preceding image. They look nice at this point, but we want to animate their transparency.</p><p>We will now write a short script to do this.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec29"></a>Animating the dust cloud transparency</h3></div></div></div><p>Now that we have applied a material to the dust clouds, we need to animate the effect by fading out the transparency and switching the texture atlas so that all four cloud variations are used.</p><p>We could animate this effect in the shader, but as the same shader is applied to all the dust clouds, the effect would be synchronous.</p><p>Materials are applied as instances to different objects in the scene, so if we manipulate the material rather than the shader, we can create a staggered effect for greater realism.</p><p>We can also animate certain material properties using the <span class="strong"><strong>Animation</strong></span> window, but this would involve adding multiple components to each game object and it is also less time effective. There is more potential to automate this effect by writing some code:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> panel, click on the <code class="literal">PACKT_Shaders</code> folder to view its contents in the <span class="strong"><strong>Assets</strong></span> panel.</p></li><li><p>In an empty area of the <span class="strong"><strong>Assets</strong></span> panel, create a new <span class="strong"><strong>C#</strong></span> script asset by clicking right mouse button and choosing <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>C# Script</strong></span>.</p></li><li><p>Rename the script <code class="literal">cloudAnim</code>.</p></li><li><p>Double-click on <code class="literal">cloudAnim</code> to open it in MonoDevelop.</p><p>Our first objective is to get the opacity of the objects to fade in and out.</p><p>We will start by declaring some variables.</p></li><li><p>Add the following code directly after the script's opening curly bracket:</p><pre class="programlisting">        public float currOpacity; &#13;
        public float fadeSpeed; &#13;
        public bool ping;  &#13;
        public Renderer rend; &#13;
</pre></li></ol></div><p>We will add a <code class="literal">currOpacity</code> float variable to keep track of the material reference's current state. This value will be defined later in the script.</p><p>We will also use a <code class="literal">float</code> value to define <code class="literal">fadeSpeed</code>, which will determine how quickly the dust clouds fade to completely transparent.</p><p>We want the cloud to fade in and out, so we will create a <code class="literal">ping</code>
<span class="strong"><strong>Boolean</strong></span> variable to allow us to determine whether the object is becoming more or less transparent.</p><p>Lastly, we will store a reference to the object's renderer with a <code class="literal">rend</code> variable.</p><p>In the <code class="literal">Start</code> state, we will initialize the dust cloud.</p><p>Add the following code inside the brackets of <code class="literal">void Start</code>:</p><pre class="programlisting">rend = GetComponent&lt;Renderer&gt;(); &#13;
currOpacity = Random.Range (0.05f, 0.95f); &#13;
</pre><p>The first line accesses the object's renderer component and stores it using the <code class="literal">rend</code> variable we just created.</p><p>In the next line, we will set the starting opacity to a random number. Set this a little above zero and a little under one respectively, so that the script does not get stuck in a loop.</p><p>We will put these elements together in the <code class="literal">Update</code> function.</p><p>Add the following code in the curly brackets of <code class="literal">void Update</code>:</p><pre class="programlisting">Color currColor = new Color(1,1,1,currOpacity); &#13;
rend.material.SetColor("_Color", currColor); &#13;
if(ping) &#13;
{ &#13;
    fadeSpeed = 0.35f; &#13;
} &#13;
else &#13;
{ &#13;
    fadeSpeed = -0.35f; &#13;
} &#13;
currOpacity += Time.deltaTime * fadeSpeed; &#13;
if(currOpacity &gt; 1f) &#13;
{ &#13;
    ping = !ping; &#13;
} &#13;
else if (currOpacity &lt; 0f) &#13;
{ &#13;
    ping = !ping; &#13;
} &#13;
</pre><p>We will start the function by declaring a local variable to handle the <code class="literal">_Color</code> component of the shader. This is where the transparency is stored. We will define the color's RGBA values as <code class="literal">1</code>, <code class="literal">1</code>, <code class="literal">1</code>, and the value of <code class="literal">currOpacity</code> for the alpha. Putting this code in the <code class="literal">Update</code> function means that it will run every frame.</p><p>In the next line, we will use our rend variable to access the object's renderer and set the color using our updated <code class="literal">currColor</code>.</p><p>To increase the value, we will check whether the <code class="literal">ping</code> Boolean is <code class="literal">true</code> using an <code class="literal">if</code> statement. When this condition is <code class="literal">true</code>, we will set <code class="literal">fadeSpeed</code> to a positive value, <code class="literal">0.35</code>.</p><p>We will use the <code class="literal">else</code> statement to define the consequences that exist when <code class="literal">ping</code> is <code class="literal">false</code>, setting <code class="literal">fadeSpeed</code> to a negative value, <code class="literal">-0.35</code>.</p><p>The next line increases <code class="literal">currOpacity</code> by time in seconds, multiplied by <code class="literal">fadeSpeed</code>, increasing or decreasing the value.</p><p>Following this, we use an <code class="literal">if</code> statement to clamp the value range of the opacity by toggling the <code class="literal">ping</code> Boolean so that the <code class="literal">currOpacity</code> value ping pongs when it reaches its minimum and maximum.</p><p>We could optimize the last part of the script a little by putting two conditionals in the same <code class="literal">if</code> statement, but we will be adding a little more code to the last statement.</p><p>For now, we will test the effect in the scene:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Save the script (<span class="emphasis"><em>
<span class="strong"><strong>Ctrl</strong></span>
</em></span> + <span class="emphasis"><em>
<span class="strong"><strong>S</strong></span>
</em></span>, or <span class="emphasis"><em>com<span class="strong"><strong>mand</strong></span>
</em></span> + <span class="emphasis"><em>
<span class="strong"><strong>S</strong></span>
</em></span> if you are working on a Mac).</p></li><li><p>Minimize MonoDevelop.</p></li><li><p>In the <span class="strong"><strong>Hierarchy</strong></span> panel, click to select the first <code class="literal">dustCloud</code> game object.</p><p>Its parameters will appear in the <span class="strong"><strong>Inspector</strong></span>.</p></li><li><p>Drag the <code class="literal">cloudAnim</code> script asset to the <span class="strong"><strong>Inspector</strong></span> to add it to the game object.</p></li><li><p>At the top of the <span class="strong"><strong>Inspector</strong></span>, click on the <span class="strong"><strong>Apply</strong></span> button to save the prefab.</p><p>The other <code class="literal">dustCloud</code> objects in the scene are instances, so changes made to one will be replicated.</p></li><li><p>At the top center of the main Unity interface, click on the <span class="strong"><strong>Play</strong></span> button to see the dust clouds animate:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_05_007.jpg" /><div class="caption">Fading dust cloud transparency</div></div><p>
</p></li></ol></div><p>Each cloud slowly fades in and out, but the realism is marred by the recurrence of the same texture alpha.</p><p>We will fix this in the next step by offsetting the UV coordinates so that the cloud uses a different part of the texture atlas each time.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec14"></a>Switching the cloud texture atlas positions</h4></div></div></div><p>The material's UV coordinates can be adjusted in the <span class="strong"><strong>Inspector</strong></span>. We will add a few more lines of code to automate this process and get the clouds looking a little more organic:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Maximize MonoDevelop.</p></li><li><p>Add the following code at the bottom of the list of variables that we wrote earlier:</p><pre class="programlisting">        public float atlasPosition; &#13;
        public float [] vValue = {0f, 0.25f, 0.5f, 0.75f}; &#13;
</pre><p>Here, we will add a new <code class="literal">atlasPosition</code> float variable to keep track of the material's vertical UV offset.</p><p>Next, we add a <code class="literal">vValue</code> float array and assign values in increments of <code class="literal">0.25</code>. These represent the four positions of the cloud images in the texture atlas.</p></li><li><p>At the bottom of the <code class="literal">Start</code> function, add the following code:</p><pre class="programlisting">        atlasPosition = vValue[Random.Range(0, 3)]; &#13;
        rend.material.SetTextureOffset("_MainTex", new Vector2(0, &#13;
          atlasPosition));&#13;
</pre></li></ol></div><p>Here, we define the value of <code class="literal">atlasPosition</code> as a number randomized from the <code class="literal">vValue </code>array. Potentially, this will cause each instance to start with a different image.</p><p>We access the game object's renderer that is already stored in our <code class="literal">rend</code> variable and use the <code class="literal">SetTextureOffset</code> method to set the starting offset for the <code class="literal">_MainTex</code> component.</p><p>We set the first value, which represents the horizontal (<span class="strong"><strong>U</strong></span>) axis to zero and set the second value, representing the vertical (<span class="strong"><strong>V</strong></span>) axis, to the value of <code class="literal">atlasPosition</code>.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Scroll down to the bottom of the script and locate <code class="literal">else if (currOpacity &lt; 0f)</code> in the <code class="literal">Update</code> function.</p></li><li><p>Add the following line of code inside the statement's curly brackets:</p><pre class="programlisting">        ChangeVPos(); &#13;
</pre><p>This line will run a new custom function, where we will change the vertical UV offset. We will separate this from the other code as it does not run every frame, just when the cloud object reaches zero opacity.</p></li><li><p>Add the following code after the <code class="literal">Update</code> function's closing curly bracket:</p><pre class="programlisting">        void ChangeVPos() &#13;
        { &#13;
            atlasPosition = vValue[Random.Range(0, 3)]; &#13;
            rend.material.SetTextureOffset("_MainTex", new Vector2(0, &#13;
              atlasPosition));&#13;
        } &#13;
</pre><p>Here, we set <code class="literal">atlasPosition</code> using the same lines of code that we used to initialize the dust cloud. This will switch it to a different cloud image within the texture atlas.</p></li><li><p>Save the script.</p></li><li><p>Minimize MonoDevelop and preview the effect by pressing the <span class="strong"><strong>Play</strong></span> button at the top center of the Unity interface:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781783553679/graphics/image_05_008.jpg" /><div class="caption">Varied dust cloud transparency</div></div><p>
</p></li></ol></div><p>The dust clouds fade in and out like before, but this time, they fade back in with a different cloud variation, creating a more believable environment, as shown in the preceding image.</p><p>The following is the final code of the <code class="literal">cloudAnim</code> script:</p><pre class="programlisting">using UnityEngine; &#13;
using System.Collections; &#13;
 &#13;
public class cloudAnim : MonoBehaviour  &#13;
{ &#13;
    &#13;
    public float currOpacity; &#13;
    public float fadeSpeed; &#13;
    public bool ping; //to pingpong the transparency effect &#13;
    public Renderer rend; &#13;
    public float atlasPosition;  &#13;
    public float [] vValue = {0f, 0.25f, 0.5f, 0.75f}; &#13;
 &#13;
    void Start ()  &#13;
    { &#13;
        rend = GetComponent&lt;Renderer&gt;();//set startOpacity &#13;
        currOpacity = Random.Range (0, 0.95f); &#13;
        atlasPosition = vValue[Random.Range(0, 3)]; &#13;
        rend.material.SetTextureOffset("_MainTex", new Vector2(0, &#13;
          atlasPosition));&#13;
    } &#13;
    &#13;
    void Update ()  &#13;
    { &#13;
        Color currColor = new Color(1,1,1,currOpacity); &#13;
        rend.material.SetColor("_Color", currColor); &#13;
        if(ping) &#13;
        { &#13;
            fadeSpeed = 0.35f; &#13;
        } &#13;
        else &#13;
        { &#13;
            fadeSpeed = -0.35f; &#13;
        } &#13;
        currOpacity += Time.deltaTime * fadeSpeed; &#13;
        if(currOpacity &gt; 1f) &#13;
        { &#13;
            ping = !ping; &#13;
        } &#13;
        else if (currOpacity &lt; 0f) &#13;
        { &#13;
            ping = !ping; &#13;
            ChangeVPos(); &#13;
        } &#13;
    } &#13;
 &#13;
    void ChangeVPos() &#13;
    { &#13;
        atlasPosition = vValue[Random.Range(0, 3)]; &#13;
        rend.material.SetTextureOffset("_MainTex", new Vector2(0, &#13;
          atlasPosition));&#13;
    } &#13;
} &#13;
</pre><p>Back in <a class="link" href="#" linkend="ch02">Chapter 2</a>, <span class="emphasis"><em>Creating Custom Shaders</em></span>, we improved the appearance of the astronaut's helmet by creating a two-sided glass material. We can improve this by making a more detailed and responsive PBR-based glass material.</p></div></div></div>