<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch11lvl1sec96"></a>Creating a generated level</h2></div></div><hr /></div><p>The level chunk is the most important part of a generated level. It's like a Lego piece. A single piece can't bring about much fun for the player. However, when you take a lot of Lego pieces and fit them together, you can build a structure that's really entertaining. Our level will work exactly the same way. Level chunks right next to each other will create a nice gaming experience (and fun) for the player.</p><p>Before we talk about coding the level chunks, we need to make sure that we understand the fundamental parts of each chunk:</p><div class="mediaobject"><img src="/graphics/9781788478922/graphics/d0630ccd-a107-4654-83a6-ed92bd9a4205.jpg" /></div><p>This is a level chunk. It can contain whatever you want to add to it. It's up to you to design the chunks. You need to remember, however, that every chunk must have the following features to fit your game:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>exitPoint–red dot</strong></span>: This is the point in 3D space where the next chunk will be placed to match this chunk</li><li style="list-style-type: disc"><span class="strong"><strong>startPoint–<span>green dot</span></strong></span>: This is the pivot point of the parent chunk that is plugged into the exit point of the previous chunk</li><li style="list-style-type: disc"><span class="strong"><strong>exit trigger–green trigger</strong></span> on the right–hand side: This detects when the player goes through the chunk to tell <code class="literal">LevelGenerator</code> to destroy the old piece and instantiate a new piece</li><li style="list-style-type: disc"><span class="strong"><strong>kill trigger–red box</strong></span>: This is an optional trigger that kills the player on contact</li></ul></div><p>So, this is it! A very simple part of a level that we call a level chunk. Let's do something exciting now and write a procedural level generation.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec62"></a>Planning the LevelGenerator class</h3></div></div></div><p>Remember that we are not writing any code without quick planning. Let's quickly think about the<code class="literal">LevelGenerator</code> script and the functionality.</p><p>We will definitely need to write methods for:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">AddPiece</code>: which is the level chunk right behind the last level chunk that is already generated</li><li style="list-style-type: disc"><code class="literal">RemoveOldestPiece</code>: to keep Unity clean of already–used level chunks</li><li style="list-style-type: disc"><code class="literal">RemoveAllPieces</code>: to cleanse the level of all chunks</li><li style="list-style-type: disc"><code class="literal">GenerateInitialPieces</code>: to generate a few pieces straight away when the game starts</li></ul></div><p><span>Before</span>we get to coding, let's prepare some assets.</p><p>Download and import <code class="literal">LevelPieceBasic.unitypackage</code>into your project. You will notice that the<code class="literal">PlayerPieceBasic</code>prefab has been imported into the prefabs folder. Drag this prefab into the <strong class="userinput"><code>Hierarchy</code></strong> window. Make sure that the entire<code class="literal">PlayerPieceBasic</code>game object in the <strong class="userinput"><code>Scene</code></strong> is placed on <code class="literal">GroundLayer</code>. Otherwise, the<code class="literal">Player</code>script won't detect that the player is on the ground. If we get this wrong, the player won't be able to jump.</p><p>At this stage, we will have quite a disorganized project hierarchy. It might be worth giving it a little cleanup. We won't use the <code class="literal">FloorShort</code>and <code class="literal">KillTrigger</code>game objects for a while, so let's delete them. Our <strong class="userinput"><code>Hierarchy</code></strong> and <strong class="userinput"><code>Scene</code></strong> windows should look more or less like this now:</p><div class="mediaobject"><img src="/graphics/9781788478922/graphics/d699dfbd-f551-4eae-8032-2b1fa7cc284b.jpg" /></div><p>Let's take a look at the prefab we just imported. As you can see, there is nothing fancy here. It's just a straight floor piece without any obstacles or holes. It's perfect for a start.</p><p>If you look closely at what's inside <code class="literal">LevelPieceBasic</code>, you will notice a very simple structure, as we have mentioned before. There are lots of individual floor pieces, <code class="literal">ExitPoint</code>, and <code class="literal">LeaveTrigger</code>. At the moment, we don't have any scripts attached to them.</p><p>The key element for generating the level is knowing the position where the elements will appear. We will use the<code class="literal">ExitPoint</code>world space position for this. I understand that this might sound a bit confusing again. Let's write a very simple piece of code that we will use to manage the <code class="literal">LevelPiece</code>and hold the reference to the <code class="literal">ExitPoint</code>game object.</p><p>Create a new C# script, call it <code class="literal">LevelPiece</code>, and add the <code class="literal">exitPointpublic</code> member, as shown here:</p><div class="mediaobject"><img src="/graphics/9781788478922/graphics/1c0c80ed-bd96-45d1-9240-36ca96ebb76e.png" /></div><p> </p><p>That's it! No complicated code here! We are using the <code class="literal">LevelPiece</code>component just to hold the <code class="literal">ExitPoint</code>transform reference.</p><p>Add the <code class="literal">LevelPiece</code>component to the <code class="literal">LevelPieceBasic</code> game object, and assign <code class="literal">ExitPoint</code>by dragging and dropping the <code class="literal">ExitPoint</code>game object on top of the slot, as shown in this screenshot:</p><div class="mediaobject"><img src="/graphics/9781788478922/graphics/4415ae9a-43f1-468d-a568-72e350925ee8.png" /></div><p>We are just about to build the <code class="literal">LevelGenerator</code> class that will spawn level pieces in the level. The <code class="literal">LevelPiece</code> class will help us manage the pieces that are already in the game and will massively speed up their positioning correctly through the <code class="literal">ExitPoint</code> reference.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec63"></a>Writing the script LevelGenerator</h3></div></div></div><p>We are ready to start writing the level generator. Woohoo! But before we proceed, let's have a recap of what functionality we have planned to include.</p><p>We will need to write methods for the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">AddPiece</code>: the level chunk right behind the last level chunk that is already generated</li><li style="list-style-type: disc"><code class="literal">RemoveOldestPiece</code>: to keep Unity free of already used level chunks</li><li style="list-style-type: disc"><code class="literal">RemoveAllPieces</code>: to clean up the level of all chunks</li><li style="list-style-type: disc"><code class="literal">GenerateInitialPieces</code>: to generate few pieces on the game start straight away</li></ul></div><p>Let's create a new script and call it <code class="literal">LevelGenerator</code>. Let's also change the way we talk about new code here. As <code class="literal">LevelGenerator</code> is quite an important class, I want you to understand it fully. That's why we will talk about variables as of now. Later, we will move on to methods.</p><p>Now add the following code to <code class="literal">LevelGenerator</code>:</p><div class="mediaobject"><img src="/graphics/9781788478922/graphics/0f40c4f7-1043-4646-b1db-3d55cafcdb14.png" /></div><p>As we can see in line <strong class="userinput"><code>7</code></strong>, we are declaring a static variable. You already know that we need this static variable for easy access using the singleton approach.</p><p>The <code class="literal">Game Level</code> lines <strong class="userinput"><code>8</code></strong>, <strong class="userinput"><code>9</code></strong>, and <strong class="userinput"><code>10</code></strong> declare some useful variables:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">levelPrefabs</code>: This is the list of all already prepared level pieces. We will store all different level pieces that we want the generator to copy from.</li><li style="list-style-type: disc"><code class="literal">levelStartPoint</code>: This is a transform. We will plug in a game object in the scene that we will use to describe where the level is starting. In simple words, this is the position of the very first level piece in the level.</li><li style="list-style-type: disc"><code class="literal">pieces</code>: This is another list of level pieces. We will use this variable to store all level pieces that are in the game at the time.</li></ul></div><p>What is the difference between the <code class="literal">levelPrefabs</code> and <code class="literal">pieces</code> variables? Basically, the <code class="literal">levelPrefabs</code> elements are our <code class="literal">blueprints</code>. Every time we ask the generator to add a new piece to the level, the generator will randomly pick one prefab (<code class="literal">blueprint</code>), make a copy of it, place it in the scene, and add this copied level piece at the end of the pieces list. So, remember that the <code class="literal">levelPrefabs</code> list won't change during the gameplay. The <code class="literal">pieces</code> list, however, will constantly change as the player progress through the level.</p></div></div>