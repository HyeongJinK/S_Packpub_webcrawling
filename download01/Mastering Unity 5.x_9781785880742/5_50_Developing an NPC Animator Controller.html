<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec50"></a>Developing an NPC Animator Controller</h2></div></div><hr /></div><p>The FSM must be complemented by a Mecanim animator graph, as each state involves a unique animation and each one should play at the appropriate time. You create a new animator asset simply by right-clicking inside the Project Panel and choosing <span class="strong"><strong>Create |Animator Controller</strong></span> from the context menu. Name this <code class="literal">controllerEnemy</code>.</p><p>Be sure to add this as an animator component to the zombie in the scene by dragging and dropping the asset from the Project Panel to the mesh in the Scene Viewport:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_05_011.jpg" /></div><p>
</p><p>Creating a new Animator Controller for the zombie NPC</p><p>First, create a new animator integer parameter, and name this <code class="literal">AnimState</code>. This parameter represents the currently active state of the zombie in the graph. Its values will match exactly the value of the <code class="literal">AIState</code> enum, coded for the <code class="literal">AIEnemy</code> class: <code class="literal">0</code> = <code class="literal">Idle</code>, <code class="literal">1</code> = <code class="literal">Chase</code>, <code class="literal">2</code> = <code class="literal">Attack</code>, and <code class="literal">3</code> = <code class="literal">Dead</code>:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_05_012.jpg" /></div><p>
</p><p>Creating a new Animator Controller for the zombie NPC</p><p>Now for the starting state, create a new Empty state by right-clicking in the graph and navigating to <span class="strong"><strong>Create |</strong></span>
<span class="strong"><strong>Empty</strong></span> from the context menu. Name the state <span class="strong"><strong>Start</strong></span>, and make it the default state (if it's not already) by right-clicking the state and choosing <span class="strong"><strong>Set as Layer Default State </strong></span>from the context menu. This ensures the zombie <span class="emphasis"><em>does nothing</em></span> when the level begins, until we explicitly force it into a state:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_05_013.jpg" /></div><p>
</p><p>Creating the zombie Start state</p><p>Now drag and drop each state-animation clip from the Project Panel into the animator graph, to create a new animation node for each state; one each for idle, chase, attack and death. These animations are included in the book's companion files:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_05_014.jpg" /></div><p>
</p><p>Adding zombie Animation-States to the graph</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note37"></a>Note</h3><p>Remember, the animator graph features three default nodes: <span class="strong"><strong>Entry, Any State</strong></span>, and <span class="strong"><strong>Exit</strong></span>. These nodes are auto-created with the animator graph. The <span class="strong"><strong>Entry</strong></span> node is invoked when the animator graph (state machine) begins, and any connected nodes are initiated too. The <span class="strong"><strong>Any State</strong></span> node effectively links to all other nodes and initiates those whenever the transition conditions (connections) are satisfied. The <span class="strong"><strong>Exit </strong></span>node is initiated on leaving any sub-state machine (this node is useful for creating nested animator graphs). For more information on these states and transitions, see the online Unity documentation at: <a class="ulink" href="https://docs.unity3d.com/Manual/StateMachineTransitions.html" target="_blank">https://docs.unity3d.com/Manual/StateMachineTransitions.html</a>
</p></div><p>Once the states have been added to the graph they must be wired together logically and consistently using the state machine code. Specifically, the zombie may transition from <span class="strong"><strong>Idle</strong></span> to <span class="strong"><strong>Chase</strong></span>, from <span class="strong"><strong>Chase</strong></span> to <span class="strong"><strong>Attack</strong></span>, back from <span class="strong"><strong>Attack</strong></span> to <span class="strong"><strong>Chase</strong></span>, and from <span class="strong"><strong>Chase</strong></span> to <span class="strong"><strong>Idle</strong></span>. The <span class="strong"><strong>Death</strong></span> state may, potentially, be invoked from anywhere. First, let's wire the connection from <span class="strong"><strong>Start</strong></span> to <span class="strong"><strong>Idle</strong></span> which happens when the <span class="strong"><strong>AnimState</strong></span> parameter is equal to <code class="literal">0</code>:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_05_015.jpg" /></div><p>
</p><p>Setting the Idle state from the Start node</p><p>The <span class="strong"><strong>Idle</strong></span> state simply plays a standing animation. However, it doesn't last long enough in itself and doesn't loop as well as I want. We can easily fix this type of looping problem directly from the <span class="strong"><strong>Animator</strong></span>, without changing any frames in the animation. We can do this simply by playing the animation forwards once and then playing it again backwards, looping back and forth with a ping-pong effect. Select the <span class="strong"><strong>Idle</strong></span> node in the graph and then duplicate it, and set the <span class="strong"><strong>Speed</strong></span> to <code class="literal">-1</code> to play backwards.
 Now the two duplicates can be wired together to play continuously:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_05_016.jpg" /></div><p>
</p><p>Looping an Idle through a ping-pong sequence</p><p>The Idle state (whether it's playing forwards or backwards) may transition to the Chase state (usually when the player's character appears). Conversely, the Chase state may transition back to the <span class="strong"><strong>Idle</strong></span> state. This can be configured in the graph with transitions that depend on the <span class="strong"><strong>AnimState </strong></span>field being equal to <code class="literal">1</code> (for <span class="strong"><strong>Chase</strong></span>) and <code class="literal">0</code> (for <span class="strong"><strong>Idle</strong></span>).
 Be sure to uncheck the <span class="strong"><strong>Has Exit Time</strong></span> checkbox for each transition, as these force the state to change immediately from one to another, as opposed to waiting for the animation to complete before changing:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_05_017.jpg" /></div><p>
</p><p>Creating connections between Idle and Chase</p><p>The <span class="strong"><strong>Chase</strong></span> state can also change to the Attack state, and the <span class="strong"><strong>Attack</strong></span> state can change to the <span class="strong"><strong>Chase</strong></span> state. Again, the change depends on the <span class="strong"><strong>AnimState</strong></span> parameter:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_05_018.jpg" /></div><p>
</p><p>Creating a transition between Chase and Attack</p><p>
<span class="strong"><strong>Any State</strong></span> should have a connection to <span class="strong"><strong>Death</strong></span>. This makes sense because the enemy AI could be in Idle, Chase, or Attack and, effectively, be killed. Create a transition from <span class="strong"><strong>Any State</strong></span> to <span class="strong"><strong>Death</strong></span>, based on the <code class="literal">AnimState</code> parameter being equal to <code class="literal">3</code>:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_05_019.jpg" /></div><p>
</p><p>Building the Death state in the animator graph</p><p>The animator graph is now fully configured to support the FSM for the zombie character. <span class="strong"><strong>Save</strong></span> the animator asset and associate it to an <span class="strong"><strong>Animator</strong></span> component for the zombie, if you've not already done so. The next step is to return to the <code class="literal">AIEnemy</code> script to code the remaining AI for the zombie:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_05_020.jpg" /></div><p>
</p><p>Configuring the zombie animator</p></div>