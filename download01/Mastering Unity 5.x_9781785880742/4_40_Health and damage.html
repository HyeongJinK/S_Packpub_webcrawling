<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec41"></a>Health and damage</h2></div></div><hr /></div><p>Next up, we consider health and damage. Health is an interesting property, especially because it is abstract. That is, many characters have health: the player character and enemies, including the zombies. Though zombies are neither alive nor dead, but are <span class="emphasis"><em>undead</em></span>, they still normally have an equivalent metric corresponding to health. When that property or resource is exhausted for any character, they expire, die, or are removed from the game. Because of the generic quality of health, it's a good idea to code it once such that it can be applied limitlessly as a component to any entity that has that property. For this reason, we'll create a <code class="literal">Health</code> class. Consider the following full source code and the comments that follow it:</p><pre class="programlisting">//------------------------------------ &#13;
using UnityEngine; &#13;
using System.Collections; &#13;
using UnityEngine.EventSystems; &#13;
using UnityEngine.Events; &#13;
//------------------------------------ &#13;
public class Health : MonoBehaviour &#13;
{ &#13;
    //------------------------------------ &#13;
    public float Value &#13;
    { &#13;
        get{return fValue;} &#13;
        set &#13;
        { &#13;
            fValue = value; &#13;
            OnHealthChanged.Invoke(); &#13;
         &#13;
            if (fValue &lt;= 0f) &#13;
                OnHealthExpired.Invoke(); &#13;
        }  &#13;
    } &#13;
 &#13;
    [SerializeField] &#13;
    [Range(0f,100f)] &#13;
    private float fValue = 100f; &#13;
    //------------------------------------ &#13;
    //Events called on health change &#13;
<span class="strong"><strong>    public UnityEvent OnHealthExpired;&#13;
</strong></span>
<span class="strong"><strong>    public UnityEvent OnHealthChanged;</strong></span> &#13;
    //------------------------------------ &#13;
} &#13;
</pre><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec50"></a>Comments</h3></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">fValue</code> private float variable stores the health value itself. It's declared with two C# attributes,<code class="literal"> SerializedField</code> (to show the value in the Inspector) and <code class="literal">Range</code>, to display as a slider.</p></li><li style="list-style-type: disc"><p>The <code class="literal">fValue</code> variable is accessed through the <code class="literal">Get</code> and <code class="literal">Set</code> methods for a C# property. The <code class="literal">Get</code> method simply returns <code class="literal">fValue</code>. The <code class="literal">set</code> method updates the value and validates it.</p></li><li style="list-style-type: disc"><p>The <code class="literal">Set</code> method invokes the <code class="literal">HealthChanged</code> event, since the health has changed. And, if the health equals or falls below zero, the <code class="literal">HealthExpired</code> event is invoked, allowing any visually scripted events in the object <span class="strong"><strong>Inspector</strong></span> to run.</p></li></ul></div><p>With the <code class="literal">Health</code> script coded, you can now attach it to any object that should have a health property, including the player and all his/her enemies. This demonstrates an effective coding practice when working in Unity, namely <span class="strong"><strong>Component Based Design</strong></span>. The basic idea is to encapsulate abstract and general properties (like health, or spell books, or character sheets), which can potentially apply to many different characters, into a single class. This class can then be attached to an object as a component, perhaps alongside other components, to collectively define that object, so that the object becomes the sum of its component parts.</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_04_034.jpg" /></div><p>
</p><p>Attaching the Health script to the Player object</p><p>Excellent! We now have a <code class="literal">Health</code> class. This alone doesn't do much, besides encode a health value for an object. But in collaboration with other classes and components, it'll make a big difference. To see this, let's create a health bar UI element for the player which will update as the health changes to reflect the current health of the player. To achieve this, create a new canvas object, by choosing <span class="strong"><strong>GameObject</strong></span> | <span class="strong"><strong>UI</strong></span> | <span class="strong"><strong>Canvas</strong></span> from the application menu. This adds a new canvas object to the scene, which will be dedicated to a health bar. Name this object <code class="literal">UIDamage</code>.</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_04_035.jpg" /></div><p>
</p><p>Creating a UI health canvas object</p><p>The health bar should act much like a traditional health bar in video games. It's presented as a horizontal bar or gauge. When full, the bar appears completely green, from left to right. When damage occurs, the green section of the bar moves further to the left, revealing a darker background behind it. When health has been exhausted, the bar fully retracts to the left, appearing empty.</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_04_036.jpg" /></div><p>
</p><p>Creating a health bar</p><p>To create this, we'll need two image objects overlapping each other in the screen space; one for the green front of the bar, and one for the darker background. Create the background by choosing <span class="strong"><strong>GameObject</strong></span> | <span class="strong"><strong>UI</strong></span> | <span class="strong"><strong>Image</strong></span> from the application menu. Name this object <code class="literal">Image_Health_Background</code>.</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_04_037.jpg" /></div><p>
</p><p>Creating a background image for the health bar</p><p>The health bar should be positioned at the bottom-left corner of the screen and the bar itself should be explicitly left-aligned so that, when damage occurs, the right-hand edge of the bar retracts leftwards, while the left-hand side remains in place. The width of the bar is therefore equivalent to the health value, so set it to <code class="literal">100</code>. To configure the bar this way, change its <span class="strong"><strong>Pivot</strong></span> in the <span class="strong"><strong>Rect Transform</strong></span> component to <code class="literal">0</code>,<code class="literal">0</code> from the object inspector (positioning the pivot at the bottom-left corner). In addition, set the bar anchor to the bottom-left screen corner, fixing the bar in place.</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_04_038.jpg" /></div><p>
</p><p>Setting the pivot and anchor for the health bar background</p><p>Good work! We've created the bar background, so let's now create the foreground. To do that, simply duplicate the background and then rename it to <code class="literal">Image_Health</code>. From the <span class="strong"><strong>Image</strong></span> component in the object <span class="strong"><strong>Inspector</strong></span>, select a green color for the <span class="strong"><strong>Color</strong></span> field, and leave the source image field empty to fill the image with a bold color.</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_04_039.jpg" /></div><p>
</p><p>Setting the image color for the foreground</p><p>You can already test the health bar by simply reducing the width of the <code class="literal">Image_Health</code> object; reducing it from <code class="literal">100</code> to a lower value above <code class="literal">0</code>. When you do this, the health bar should retract from the right to left, revealing a solid bar background behind.</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_04_040.jpg" /></div><p>
</p><p>Testing the health bar</p><p>We also need to connect the health bar to the health value for the player. To do this, we'll create a new script for the health bar UI and call it <code class="literal">UIHealth</code>. The following full source code includes comments afterwards. This script should be attached to the health bar foreground image:</p><pre class="programlisting">//------------------------------------ <span class="strong"><strong>&#13;
using</strong></span> UnityEngine; <span class="strong"><strong>&#13;
using</strong></span> System.Collections; &#13;
//------------------------------------ &#13;
<span class="strong"><strong>public class</strong></span> UIHealth : MonoBehaviour &#13;
{ &#13;
    <span class="strong"><strong>private</strong></span> Health PlayerHealth = <span class="strong"><strong>null</strong></span>; &#13;
    <span class="strong"><strong>private</strong></span> RectTransform ThisTransform = <span class="strong"><strong>null</strong></span>; &#13;
 &#13;
    // Use this for initialization &#13;
    <span class="strong"><strong>void</strong></span> Awake ()  &#13;
    { &#13;
        GameObject GO = GameObject.FindGameObjectWithTag ("Player"); &#13;
        PlayerHealth = GO.GetComponent&lt;Health&gt; (); &#13;
        ThisTransform = GetComponent&lt;RectTransform&gt; (); &#13;
    } &#13;
     &#13;
    // Update is called once per frame &#13;
    <span class="strong"><strong>public void</strong></span> UpdateHealth ()  &#13;
    { &#13;
        //Update player health &#13;
        ThisTransform.sizeDelta = new Vector2(PlayerHealth.Value, ThisTransform.sizeDelta.y); &#13;
    } &#13;
} &#13;
//------------------------------------  &#13;
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec51"></a>Comments</h3></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">PlayerHealth</code> variable references the health component on the player object. This variable is assigned during the <code class="literal">Awake</code> function by searching the scene for an object tagged as <code class="literal">Player</code>. Once found, the health component is retrieved. You could display health for other characters (like zombies), however, by exposing the <code class="literal">PlayerHealth</code> field as public and manually assigning a reference to a different object.</p></li><li style="list-style-type: disc"><p>The <code class="literal">UpdateHealth</code> function updates the <code class="literal">Width</code> of the health bar based on the health of the player. The variable <code class="literal">RectTransform.sizeDelta</code> controls the width of the health bar.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note33"></a>Note</h3><p>The <code class="literal">UpdateHealth</code> function could be called on every frame (such as in <span class="emphasis"><em>Update</em></span>) to update the GUI health status. However, continually using update in this way is performance prohibitive. Functionality like this, when distributed across classes, soon accumulates over all updates, which substantially impacts performance. For this reason, we should opt for an event-based approach. This means identifying all possible occasions when the health can change and then invoking an appropriate event. When the event occurs, the health must update. Using this technique means the health UI code only updates when health changes are possible, as opposed to indiscriminately on every frame.</p></div></li></ul></div><p>Make sure the health component is attached to the <span class="emphasis"><em>foreground</em></span> health image and not the <span class="emphasis"><em>background</em></span>.</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_04_041.jpg" /></div><p>
</p><p>Attaching the UI health script to the foreground health bar</p><p>Now we need to generate a health change event; we already have the mechanism in place to do this from the <code class="literal">Health</code> class. Select the <span class="strong"><strong>Player</strong></span> object and, from the <span class="strong"><strong>Health</strong></span> component, add an action for the <span class="strong"><strong>OnHealthChanged</strong></span> event in the object <span class="strong"><strong>Inspector</strong></span>.</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_04_042.jpg" /></div><p>
</p><p>The health script features two events, coded with Unity events</p><p>Next, add the HealthUI object to the target field, and run the <code class="literal">UpdateHealth</code> function from the<span class="strong"><strong> UIHealth </strong></span>component.</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_04_043.jpg" /></div><p>
</p><p>The Health script features two events, coded with Unity Events</p><p>That's it! The health changed event is now successfully linked to UI health updates. Right now, there is nothing dangerous in the scene to damage our health, but this will change in the next chapter! You can, of course, test out the damage functionality by using key presses inside an <code class="literal">Update</code> function.</p><p>In addition to responding to damage, we should also link the health expired event to the camera death animation that we created in the previous chapter. In that chapter, we developed an animation for the camera falling to the ground up on death. Having developed this, we can now link that to the health expired event from the object <span class="strong"><strong>Inspector</strong></span>, just as we did for the <span class="strong"><strong>OnHealthChanged</strong></span> event. </p><p>Simply create a new action for <span class="strong"><strong>OnHealthExpired </strong></span>(on the player's health component) and call the <span class="strong"><strong>Animator.SetTrigger</strong></span> (string) function to activate the <span class="strong"><strong>Die</strong></span> parameter in the graph.</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_04_044.jpg" /></div><p>
</p><p>The health script features two events, coded with Unity events.</p><p>The <span class="strong"><strong>Die</strong></span> parameter is simply a trigger in the animator graph that activates the death sequence. This was created in the previous chapter.</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785880742/graphics/image_04_045.jpg" /></div><p>
</p><p>Invoking the death sequence on health expired events</p></div></div>