<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec101"></a>Preparing motion capture files for humanoid characters</h2></div></div><hr /></div><p>Using <span>motion capture files</span><a id="id325241223" class="indexterm"></a> is not always easy. In most cases, we can use them directly (after exporting them to an <strong class="userinput"><code>FBX</code></strong> file) for characters using the <strong class="userinput"><code>Generic</code></strong> rig type. But we almost always want to use our motion capture files for <span>humanoid</span><a id="id325241238" class="indexterm"></a> characters. The problem occurs when our motion capture rig is not a standard Unity <strong class="userinput"><code>Humanoid</code></strong> rig (and again, it is almost always the case). We can expect all kinds of errors—bones rotating with an offset, deformations in the mesh, and so on.</p><p>This recipe shows how to retarget motion capture files onto a rig suitable for Unity humanoid animations. We are going to use Blender 3D.</p><p> </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec315"></a>Getting ready</h3></div></div></div><p>To follow this recipe, you will need a <span>humanoid</span><a id="id325241261" class="indexterm"></a> character ready to be rigged to a proper Unity <strong class="userinput"><code>Humanoid</code></strong> rig. We also need a motion capture animation. You can find a huge free-to-use library of motion capture data on the Carnegie Mellon University's website at <span><a class="ulink" href="http://mocap.cs.cmu.edu/" target="_blank">http://mocap.cs.cmu.edu/</a></span>. We are going to use the <code class="literal">01_01.bvh</code> file in this example.</p><p>You can also <span>download</span><a id="id325241356" class="indexterm"></a> the example Unity project provided and go to the <code class="literal">Chapter 10 Miscellaneous\Recipe 04 Preparing motion capture files for humanoid characters</code> directory. You can find the <code class="literal">Example.unity</code> scene there. If you play the game, you will see a character playing a retargeted motion capture animation. You can find the BVH file in the <code class="literal">Raw data</code> directory. The final FBX file is in the <code class="literal">Final FBX</code> directory, and all the <code class="literal">blend</code> files are located in the <code class="literal">Blend Files</code> directory.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec316"></a>How to do it...</h3></div></div></div><p>To use motion capture data for Humanoid characters, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>First we need to create a rig suitable for Unity's Humanoid characters. In Blender, creating such a rig is quite easy. First enable the <strong class="userinput"><code>Rigify</code></strong> add-on and create a new <strong class="userinput"><code>Human</code></strong> (<strong class="userinput"><code>metarig</code></strong>) object from the <strong class="userinput"><code>Armature</code></strong> section.</li><li>This rig has almost the same structure as Unity's Humanoid rig, but we need to adjust a few things. First, edit the rig and delete the <strong class="userinput"><code>heel.L</code></strong>, <strong class="userinput"><code>heel.R</code></strong>, <strong class="userinput"><code>heel.02.L</code></strong>, and <strong class="userinput"><code>heel.02.R</code></strong> bones from the feet.</li><li>Then delete the <strong class="userinput"><code>palm.01.L</code></strong>, <strong class="userinput"><code>palm.02.L</code></strong>, <strong class="userinput"><code>palm.03.L</code></strong>, <strong class="userinput"><code>palm.04.L</code></strong>, <strong class="userinput"><code>palm.01.R</code></strong>, <strong class="userinput"><code>palm.02.R</code></strong>, <strong class="userinput"><code>palm.03.R</code></strong>, and <strong class="userinput"><code>palm.04.R</code></strong> bones from the hands.</li><li>This gives us a proper Unity Humanoid rig. We can also adjust the T-Pose (a <strong class="userinput"><code>Rigify</code></strong> rig is created in a more relaxed T-Pose). This step is not a necessity. Name that rig <code class="literal">FinalRig</code>.</li><li>Now adjust the bone sizes for your character and skin the character to the rig.</li><li>Enter <strong class="userinput"><code>Pose Mode</code></strong> and click on both shoulders. Enable their <span class="emphasis"><em>Y</em></span> axis rotation (it is locked by default). This step is important for making the final animation.</li><li>Import your BVH file (<strong class="userinput"><code>File</code></strong> | <strong class="userinput"><code>Import</code></strong> | <strong class="userinput"><code>BVH</code></strong>). You may want to adjust the size of the rig in import settings.</li><li>Scale the imported BVH rig to roughly match the size of your character. Name the BVH rig <strong class="userinput"><code>ImportedRig</code></strong> for better clarity.</li></ol></div><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Now we will create a control rig that we will use to correct any errors. To do so, create an empty object in Blender and name it <code class="literal">Hips</code>. Create another empty object and name it <code class="literal">HipsTarget</code>. Make sure both objects have exactly the same position and rotation.</li><li>Parent <strong class="userinput"><code>HipsTarget</code></strong> to <strong class="userinput"><code>Hips</code></strong>.</li><li>To make the <span>objects</span><a id="id325509770" class="indexterm"></a> more visible, set the <strong class="userinput"><code>Display</code></strong> of <strong class="userinput"><code>Hips</code></strong> to <strong class="userinput"><code>Cube</code></strong> and the <strong class="userinput"><code>Display</code></strong> of <strong class="userinput"><code>HipsTarget</code></strong> to <strong class="userinput"><code>Sphere</code></strong>.</li><li>A pair of those empties is our bone node—we will create one for each bone of the <span>character</span><a id="id325509838" class="indexterm"></a>:</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/c409b1c1-f07d-4bd1-9dca-0606c4da68b3.png" /></div><p>Bone node—a pair of two empties</p><div class="orderedlist"><ol class="orderedlist arabic" start="13" type="1"><li>Select the <strong class="userinput"><code>Hips</code></strong> object and add the <strong class="userinput"><code>Copy Transforms</code></strong> constraint to it.</li><li>Select the <strong class="userinput"><code>ImportedRig</code></strong> as the <strong class="userinput"><code>Target</code></strong> and its <code class="literal">Hips</code> bone as the <strong class="userinput"><code>Bone</code></strong>.</li><li>Repeat steps 9-14 for every bone of the <strong class="userinput"><code>FinalRig</code></strong> (you can omit the fingers as not many motion capture files have data for fingers anyway). After completing this process, you should have a list of empties reflecting the structure of the <strong class="userinput"><code>FinalRig</code></strong>. It should look similar to the following: 
<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Hips (and <strong class="userinput"><code>HipsTarget</code></strong> parented to it)</li><li style="list-style-type: disc">Spine (and <strong class="userinput"><code>SpineTarget</code></strong> parented to it)</li><li style="list-style-type: disc">Chest (and <strong class="userinput"><code>ChestTarget</code></strong> parented to it)</li><li style="list-style-type: disc">Neck (and <strong class="userinput"><code>NeckTarget</code></strong> parented to it)</li><li style="list-style-type: disc">Head (and <strong class="userinput"><code>HeadTarget</code></strong> parented to it)</li><li style="list-style-type: disc">Shoulder.L (and <strong class="userinput"><code>ShoulderTarget.L</code></strong> parented to it)</li><li style="list-style-type: disc">Shoulder.R (and <strong class="userinput"><code>ShoulderTarget.R</code></strong> parented to it)</li><li style="list-style-type: disc">LegUp.L (and <strong class="userinput"><code>LegUpTarget.L</code></strong> parented to it)</li><li style="list-style-type: disc">LegUp.R (and <strong class="userinput"><code>LegUpTarget.R</code></strong> parented to it)</li><li style="list-style-type: disc">Leg.L (and <strong class="userinput"><code>LegTarget.L</code></strong> parented to it)</li><li style="list-style-type: disc">Leg.R (and <strong class="userinput"><code>LegTarget.R</code></strong> parented to it)</li><li style="list-style-type: disc">Foot.L (and <strong class="userinput"><code>FootTarget.L</code></strong> parented to it)</li><li style="list-style-type: disc">Foot.R (and <strong class="userinput"><code>FootTarget.R</code></strong> parented to it)</li><li style="list-style-type: disc">ArmUp.L (and <strong class="userinput"><code>ArmUpTarget.L</code></strong> parented to it)</li><li style="list-style-type: disc">ArmUp.R (and <strong class="userinput"><code>ArmUpTarget.R</code></strong> parented to it)</li><li style="list-style-type: disc">Arm.L (and <strong class="userinput"><code>ArmTarget.L</code></strong> parented to it)</li><li style="list-style-type: disc">Arm.R (and <strong class="userinput"><code>ArmTarget.R</code></strong> parented to it)</li><li style="list-style-type: disc">Hand.L (and <strong class="userinput"><code>HandTarget.L</code></strong> parented to it)</li><li style="list-style-type: disc">Hand.R (and <strong class="userinput"><code>HandTarget.R</code></strong> parented to it)</li></ul></div></li><li>Sometimes our <strong class="userinput"><code>ImportedRig</code></strong> has a different structure, for instance it may have more spine bones (three or more). In such case, we should choose the most suitable bone in the <strong class="userinput"><code>Copy Transform</code></strong> constraints or add two <strong class="userinput"><code>Copy Rotation</code></strong> constraints and interpolate the final rotation of two neighboring bones by setting the <strong class="userinput"><code>Influence</code></strong> slider:</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/403dac64-f876-44be-979a-e2388e787c06.png" /></div><p>Control rig with Copy Transform constraints</p><div class="orderedlist"><ol class="orderedlist arabic" start="17" type="1"><li>Now we need to set the IK for feet. Select the <strong class="userinput"><code>FinalRig</code></strong> and go to <strong class="userinput"><code>Edit Mode</code></strong>.</li><li>Copy both foot bones and change their names to <strong class="userinput"><code>footTarget.L</code></strong> and <strong class="userinput"><code>footTarget.R</code></strong>.</li><li>Remove their parents and unselect the <strong class="userinput"><code>Deform</code></strong> option (they shouldn't deform the mesh).</li></ol></div><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="20" type="1"><li>Go to <strong class="userinput"><code>Pose Mode</code></strong>.</li><li>Select the <strong class="userinput"><code>shin.L</code></strong> bone and add an <strong class="userinput"><code>Inverse Kinematics</code></strong> constraint. Set the <strong class="userinput"><code>Chain Length</code></strong> to 2 and choose the <strong class="userinput"><code>FinalRig</code></strong> as <strong class="userinput"><code>Target</code></strong>, and <strong class="userinput"><code>footTarget.L</code></strong> as the <strong class="userinput"><code>Bone</code></strong>.</li><li>Select the <strong class="userinput"><code>foot.L</code></strong><span>bone</span><a id="id325240954" class="indexterm"></a> and add a <strong class="userinput"><code>Copy Rotation</code></strong> constraint to it. Choose the <strong class="userinput"><code>FinalRig</code></strong> as the <strong class="userinput"><code>Target</code></strong>, and the <strong class="userinput"><code>footTarget.L</code></strong> as the <strong class="userinput"><code>Bone</code></strong>.</li><li>Repeat steps 21 <span>and</span><a id="id325240981" class="indexterm"></a> 22 for the right leg.</li><li>Select the <strong class="userinput"><code>hips</code></strong> bone and add the <strong class="userinput"><code>Copy Rotation</code></strong> and <strong class="userinput"><code>Copy Location</code></strong> constraints to it. In both constraints, set the <strong class="userinput"><code>Target</code></strong> to <strong class="userinput"><code>HipsTarget</code></strong> empty.</li><li>Select the <strong class="userinput"><code>Offset</code></strong> option in the <strong class="userinput"><code>Copy Location</code></strong> constraint and move the <strong class="userinput"><code>hips</code></strong> bone (in <strong class="userinput"><code>Pose Mode</code></strong>) to roughly match the position of the <strong class="userinput"><code>HipsTarget</code></strong> empty in the scene.</li><li>Select the <strong class="userinput"><code>footTarget.L</code></strong> bone. Add the <strong class="userinput"><code>Copy Location</code></strong> and <strong class="userinput"><code>Copy Rotation</code></strong> constraints to it. In both constraints, choose the <strong class="userinput"><code>FootTarget.L</code></strong> empty as the <strong class="userinput"><code>Target</code></strong>.</li><li>Select the <strong class="userinput"><code>Offset</code></strong> option in the <strong class="userinput"><code>Copy Location</code></strong> constraint and move the <strong class="userinput"><code>footTarget.L</code></strong> bone (in <strong class="userinput"><code>Pose Mode</code></strong>) to roughly match the position of the f<strong class="userinput"><code>ootTarget.L</code></strong> empty in the scene.</li><li>Repeat steps 26 and 27 for the right foot target.</li><li>Add a <strong class="userinput"><code>Copy Rotation</code></strong> constraint to every other bone (including those with the <strong class="userinput"><code>Inverse Kinematics</code></strong> constraint). Set the <strong class="userinput"><code>Target</code></strong> for each such constraint to a corresponding empty (for the <strong class="userinput"><code>shin.L</code></strong> bone, choose the <strong class="userinput"><code>LegTarget.L</code></strong> empty, and so on).</li><li>You should see the motion of the <strong class="userinput"><code>ImportRig</code></strong> being transferred to the <strong class="userinput"><code>FinalRig</code></strong>. Additionally, you can move the hips bone and the <strong class="userinput"><code>footTarget.L</code></strong> and <strong class="userinput"><code>footTarget.R</code></strong> bones to adjust the animation.</li><li>If you see any errors on the mesh, especially if the limbs of the character are rotated in a weird way, you can rotate the target empties to fix this.</li><li>You can also rotate the target empties to change the overall pose of the character easily.</li><li>To finish the retargeting process, save your file as a new one. Select all the bones in the <strong class="userinput"><code>FinalRig</code></strong> (in <strong class="userinput"><code>Pose Mode</code></strong>), press the space bar, type <strong class="userinput"><code>Bake Action</code></strong>, and press <span class="emphasis"><em>Enter</em></span>.</li><li>In the <strong class="userinput"><code>Bake Action</code></strong> window, choose <strong class="userinput"><code>Visual Keying</code></strong> and <strong class="userinput"><code>Clear Constraints</code></strong>. You can also provide a name for the newly created action. If you click on <strong class="userinput"><code>OK</code></strong>, all constraints will be removed and the final animation will be baked.</li><li>Remember to select the small <strong class="userinput"><code>F</code></strong> symbol near this action in the <strong class="userinput"><code>Action Editor</code></strong> (this will save the data even if the rig doesn't use it).</li></ol></div><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="36" type="1"><li>Remove all the empties and the <strong class="userinput"><code>ImportedRig</code></strong> (you may also need to remove its action manually). Save the file.</li><li>Import the file into Unity and set the rig to Humanoid. The animation should work as intended. You may also choose to export the file to FBX first. If you <span>experience</span><a id="id325241978" class="indexterm"></a> any problems, try with the 6.1 version of the FBX format as it may help:</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/40858a07-dfd4-4f05-ad95-fc6e80efff19.png" /></div><p>FinalRig on the left and ImportedRig and the empties (control rig) on the right</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec317"></a>How it works...</h3></div></div></div><p>Problems with importing motion capture data can be very frustrating. The most common errors are connected with an inappropriate <strong class="userinput"><code>T-POSE</code></strong> of the <strong class="userinput"><code>BVH</code></strong> rig. This T-Pose depends on the software the animation was recorded in and exported from. Additionally, BVH rigs can have arbitrary bone hierarchies, with more than two spine bones for instance. A proper Unity Humanoid rig hierarchy was covered in the <span class="emphasis"><em>Configuring Generic and Humanoid rigs</em></span> recipe in <span><a class="link" href="#" linkend="ch01">Chapter 1</a></span>, <span class="emphasis"><em>Working with animations</em></span>.</p><p>In Blender, the Rigify rig has a proper T-Pose. Thus, the best solution is to retarget the animation from the <strong class="userinput"><code>ImportRig</code></strong> to the <strong class="userinput"><code>FinalRig</code></strong> (the <strong class="userinput"><code>Rigify</code></strong> one). In theory, we could omit creating the control rig (the empties) but those give us more control. The <strong class="userinput"><code>(...)Target</code></strong> empties are not constrained to the <strong class="userinput"><code>ImportRig</code></strong> bones—they are only parented to the empties that are constrained. This way we can rotate or move the <strong class="userinput"><code>(...)Target</code></strong> empties to correct any rotation errors or adjust a pose.</p><p>We also use <strong class="userinput"><code>Inverse Kinematics</code></strong> for the feet in this setup. This, combined with the <strong class="userinput"><code>Offset</code></strong> option in the <strong class="userinput"><code>Copy Location</code></strong> constraints (set for the <strong class="userinput"><code>footTarget.L</code></strong>, <strong class="userinput"><code>footTarget.R</code></strong>, and <strong class="userinput"><code>hips</code></strong> bones), allows us to adjust the feet and hips positions. This way we can move the character to the center of the scene quite easily. We can even make it crouch while moving.</p><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec318"></a>See also</h3></div></div></div><p>If you are on a budget and want to use motion capture data, you can find a lot of free motions on the Carnegie Mellon University's website at <span><a class="ulink" href="http://mocap.cs.cmu.edu/" target="_blank">http://mocap.cs.cmu.edu/</a></span>. Another good option is to invest in the Perception Neuron solution (<span><a class="ulink" href="https://neuronmocap.com/" target="_blank">https://neuronmocap.com/</a></span>)—it is a project successfully founded on Kickstarter. Perception Neuron seems affordable for most indie studios or even individuals. It is a suit with a set of sensors (gyroscopes, magnetometers, and accelerometers) that the actor puts on. It works <span>similar</span><a id="id325242189" class="indexterm"></a> to standard motion capture solutions based on markers. I must say the quality of the recorded motions is mostly very good (it has some problems with rapid motions though). You also have to watch out for large metal objects, speakers, and other sources of magnetic fields in the room. But if you can't afford a motion capture studio session and want to use mocap for your project, it can be a good bet.</p></div></div>