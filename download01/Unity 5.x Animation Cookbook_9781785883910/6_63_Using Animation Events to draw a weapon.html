<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec65"></a>Using Animation Events to draw a weapon</h2></div></div><hr /></div><p>Another common case in combat mechanics is drawing and sheathing a weapon. In this recipe we will use <span>Animation Events</span><a id="id325241217" class="indexterm"></a> along with a Draw animation to make our character draw and sheath a sword.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec202"></a>Getting ready</h3></div></div></div><p>To follow this recipe, we need to have a <strong class="userinput"><code>Warrior</code></strong> character with two animations: <strong class="userinput"><code>Idle</code></strong> and <strong class="userinput"><code>Draw</code></strong>. The first one is a standard, looped <strong class="userinput"><code>Idle</code></strong> animation. The second one is an animation in which our character reaches for their weapon in a sheath attached to the character's belt. We are not using a sheath model here to make the recipe more simple and condensed. You can open the provided example project and go to the <code class="literal">Chapter 06 Handling combat\Recipe 06 Using animation events to draw a weapon</code> directory. There is a <strong class="userinput"><code>Warrior</code></strong> character in the <code class="literal">Example.unity</code> scene. When you press the space bar, it will draw or sheath a sword. You can find all the necessary animations in the <code class="literal">Rigs</code> directory.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec203"></a>How to do it...</h3></div></div></div><p>To make a character draw or sheath a weapon, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Import the <strong class="userinput"><code>Warrior</code></strong> character with the <strong class="userinput"><code>Idle</code></strong> and <strong class="userinput"><code>Draw</code></strong> animations into Unity.</li><li>Import a <strong class="userinput"><code>Sword</code></strong> prop to Unity.</li><li>Go to the <strong class="userinput"><code>Import Settings |</code></strong> <strong class="userinput"><code>Animation</code></strong> tab. Select the <strong class="userinput"><code>Draw</code></strong> animation and navigate to the <strong class="userinput"><code>Events</code></strong> section.</li><li>Add a <strong class="userinput"><code>Draw</code></strong> event in the frame where the character's hand reaches the sword in the sheath.</li><li>Create an <strong class="userinput"><code>Animator Controller</code></strong> with the <strong class="userinput"><code>Idle</code></strong> and <strong class="userinput"><code>Draw</code></strong> animations.</li><li>Create a <strong class="userinput"><code>Draw </code></strong><code class="literal">Trigger</code> parameter in the controller.</li><li>Create two transitions:
<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Idle</code></strong> | <strong class="userinput"><code>Draw</code></strong> with one condition:<strong class="userinput"><code>Draw </code></strong><code class="literal">Trigger</code> parameter. <strong class="userinput"><code>Has Exit Time</code></strong> should be set to <code class="literal">false</code> and <strong class="userinput"><code>Transition Duration</code></strong> set to around 0.2 seconds.</li><li style="list-style-type: disc"><strong class="userinput"><code>Draw</code></strong> | <strong class="userinput"><code>Idle</code></strong> with no conditions: <strong class="userinput"><code>Has Exit Time</code></strong> should be set to <code class="literal">true</code> and <strong class="userinput"><code>Transition Duration</code></strong> set to around 0.2 seconds.</li></ul></div></li><li>Place the <strong class="userinput"><code>Warrior</code></strong> character in the scene.</li><li>Assign the controller to the <strong class="userinput"><code>Warrior</code></strong> game object's <strong class="userinput"><code>Animator</code></strong> component.</li><li>Place the <strong class="userinput"><code>Sword</code></strong> prop in the scene. Move it near the character's hips and pose it as it needs to be when it lays in the sheath.</li><li>When you are happy with the <strong class="userinput"><code>Sword's</code></strong> position, create an empty child object in it. Name it <strong class="userinput"><code>SheathMarker</code></strong> and drag it onto the hip bone of the character to parent it to <strong class="userinput"><code>Warrior's</code></strong> hips. This way the <strong class="userinput"><code>SheathMarker</code></strong> will store our <strong class="userinput"><code>Sword's</code></strong> initial position and rotation relative to our character's hips. You should also parent the Sword to <strong class="userinput"><code>SheathMarker</code></strong>. See the following screenshot for reference:</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/4a31ece6-2571-4bf4-9a90-317124d89cc8.png" /></div><p>Sheath Marker (red) stores sword's desired position and rotation</p><div class="orderedlist"><ol class="orderedlist arabic" start="12" type="1"><li>Move the <strong class="userinput"><code>Sword</code></strong> to the <strong class="userinput"><code>Warrior</code></strong>'s hand. Pose the sword as desired. Create another empty child object in the <strong class="userinput"><code>Sword</code></strong> and name it <strong class="userinput"><code>HandMarker</code></strong>. Drag and drop the <strong class="userinput"><code>HandMarker</code></strong> game object onto the right-hand bone in the character's rig to parent it to the <strong class="userinput"><code>Warrior's</code></strong> hand. See the following screenshot for reference:</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/72c81c42-3a6c-4278-bf1a-474e249a9465.png" /></div><p>Hand Marker (orange) stores sword's desired position and rotation in the hand</p><div class="orderedlist"><ol class="orderedlist arabic" start="13" type="1"><li>Write a new script and call it <code class="literal">DrawWeapon.cs</code>. In this script's <code class="literal">Update()</code> function, we check if player pressed the space bar. If so, we first set the <strong class="userinput"><code>Draw </code></strong><code class="literal">Trigger</code> parameter in the controller to play the animation:</li></ol></div><pre class="programlisting">        if (Input.GetKeyDown(KeyCode.Space)) 
        { 
            anim.SetTrigger("Draw"); 
        } </pre><div class="orderedlist"><ol class="orderedlist arabic" start="14" type="1"><li>We also interpolate the <strong class="userinput"><code>Sword's</code></strong> position and rotation to its parent game object's position and rotation (<strong class="userinput"><code>Hand Marker</code></strong> or <strong class="userinput"><code>Sheath Marker</code></strong>):</li></ol></div><pre class="programlisting">        if (weapon.parent != null) 
        { 
            if ((weapon.position -     
        weapon.parent.position).sqrMagnitude &gt; 0.0001f) 
            { 
                weapon.position = 
                Vector3.Lerp(weapon.position, 
                weapon.parent.position, Time.deltaTime * 
                lerpSpeed); 
         
                weapon.rotation = 
                Quaternion.Lerp(weapon.rotation, 
                weapon.parent.rotation, Time.deltaTime * 
                lerpSpeed); 
            } 
        } </pre><div class="orderedlist"><ol class="orderedlist arabic" start="15" type="1"><li>In the preceding script, the <code class="literal">weapon</code> variable holds the reference to <strong class="userinput"><code>Sword's Transform</code></strong> component. The <code class="literal">public float lerpSpeed</code> variable is set in the <strong class="userinput"><code>Inspector</code></strong>.</li><li>This script has also a <code class="literal">public void</code><code class="literal">Draw()</code> function, which is called by an <strong class="userinput"><code>Animation Event</code></strong> set in the <strong class="userinput"><code>Draw</code></strong> animation. In this function, we check if the sword is already in hand with the <code class="literal">public bool weaponInHand</code> variable. We need to set this variable's initial value in the <strong class="userinput"><code>Inspector</code></strong>, depending on the initial <strong class="userinput"><code>Sword </code></strong>position (in hand or in sheath). The <code class="literal">Draw()</code> function only changes the <strong class="userinput"><code>Sword</code></strong> parent and sets the <code class="literal">weaponInHand</code> flag:</li></ol></div><pre class="programlisting">        if (weaponInHand) 
        { 
            weaponInHand = false; 
            weapon.parent = sheathMarker; 
        } 
        else 
        { 
            weaponInHand = true; 
            weapon.parent = handMarker; 
        } </pre><div class="orderedlist"><ol class="orderedlist arabic" start="17" type="1"><li>Attach the script to the character. Drag and drop the <strong class="userinput"><code>Sheath Marker</code></strong> game object to the <strong class="userinput"><code>Sheath Marker</code></strong> field in the script, the <strong class="userinput"><code>Sword</code></strong> game object to the <strong class="userinput"><code>Weapon</code></strong> field, and the <strong class="userinput"><code>Hand Marker</code></strong> to the <strong class="userinput"><code>Hand Marker</code></strong> field. Set the <strong class="userinput"><code>Weapon In Hand</code></strong> checkbox to match the <strong class="userinput"><code>Sword's</code></strong> initial position.</li><li>Play the game and press the space bar to see the effect.</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec204"></a>How it works...</h3></div></div></div><p>We use the <strong class="userinput"><code><span>Animation Event</span><a id="id325241433" class="indexterm"></a></code></strong> in the <strong class="userinput"><code>Draw</code></strong> animation to find the moment where our character reaches for the weapon attached to the character's belt. In this event, we change the parent of the weapon to attach it to the hand or to the belt (depending on whether our character is drawing or sheathing the weapon). We additionally use the <code class="literal">Lerp()</code> method to adjust or match the position and rotation of our weapon with appropriate slots in the character (the <strong class="userinput"><code>Hand Marker</code></strong> and the <strong class="userinput"><code>Sheath Marker</code></strong>). This way our <strong class="userinput"><code>Draw</code></strong> animation doesn't have to perfectly match with the desired positions of the weapon. It makes it easier to use the same animation for a wider range of different weapons.</p></div></div>