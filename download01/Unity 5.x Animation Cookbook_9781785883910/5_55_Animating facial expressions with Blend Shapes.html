<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec58"></a>Animating facial expressions with Blend Shapes</h2></div></div><hr /></div><p>If you want to animate a character talking or changing its <span>facial expression</span><a id="id325241268" class="indexterm"></a>, it is best to use <span>Blend Shapes</span><a id="id325241300" class="indexterm"></a>. This recipe covers creating facial expressions with Blend Shapes exported from a 3D package.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec179"></a>Getting ready</h3></div></div></div><p>We need several <strong class="userinput"><code><span>Blend Shapes</span><a id="id325241316" class="indexterm"></a></code></strong> that store our <span>facial expressions</span><a id="id325241324" class="indexterm"></a>. In this recipe, we will use <strong class="userinput"><code>Smile</code></strong>, <strong class="userinput"><code>Angry</code></strong>, <strong class="userinput"><code>BlinkLeft</code></strong>, <strong class="userinput"><code>BlinkRight</code></strong>, and <strong class="userinput"><code>BrowsDown</code></strong> shapes. Create them in your 3D package. If you are using Blender, <strong class="userinput"><code>Blend Shapes</code></strong> are called Shape Keys. In other softwares, they may be called Morph Targets.</p><p>You can also use the provided example Unity project and go to the <code class="literal">Chapter 05 Character actions and expressions\Recipe 08 Animating facial expressions with blend shapes</code> directory. You will find an <code class="literal">Example.scene</code> there. Open it, play the game, and adjust the sliders on the UI to see the effect. You can find the character with all the Blend Shapes in the <code class="literal">Rigs</code> directory.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec180"></a>How to do it...</h3></div></div></div><p>To use <strong class="userinput"><code>Blend Shapes</code></strong> for facial expressions, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Import your character to Unity. Place it on the scene.</li><li>Create an empty game object in the same place as our character. Call the object <strong class="userinput"><code>FaceAnims</code></strong>.</li><li>Make the character a child of the <strong class="userinput"><code>FaceAnims</code></strong> game object.</li><li>With the <strong class="userinput"><code>FaceAnims</code></strong> game object selected, open the <strong class="userinput"><code>Animation</code></strong> View (go to <strong class="userinput"><code>Window</code></strong> | <strong class="userinput"><code>Animation</code></strong>).</li><li>Create a new Animation Clip and call it <code class="literal">Angry</code>.</li><li>Click on the Add Property button and choose <strong class="userinput"><code>Character</code></strong> | <strong class="userinput"><code>Mesh</code></strong> | <strong class="userinput"><code>Skinned</code></strong><strong class="userinput"><code>Mesh Renderer</code></strong> | <strong class="userinput"><code>Blend Shape.Angry</code></strong>, where <strong class="userinput"><code>Character</code></strong> is the name of your character game object, <strong class="userinput"><code>Mesh</code></strong> is the name of your character game object containing the <strong class="userinput"><code>Skinned Mesh Renderer</code></strong> component, and <strong class="userinput"><code>Angry</code></strong> is the name of the Blend Shape exported from the 3D package.</li><li>Click on the plus icon next to the <strong class="userinput"><code>Blend Shape.Angry</code></strong> option to add the property.</li><li>Go to the <strong class="userinput"><code>Curves</code></strong> tab. Select both key frames and right-click on one of them. Choose the <strong class="userinput"><code>Edit Keys</code></strong> option and enter 100 in the <strong class="userinput"><code>Value</code></strong> field.</li><li>This way we've created an <strong class="userinput"><code>Angry</code></strong> animation with the <strong class="userinput"><code>Angry Blend Shape</code></strong> set to 100 (maximum value).</li><li>Repeat the steps 5 to 9 for <strong class="userinput"><code>Smile</code></strong>, <strong class="userinput"><code>BlinkLeft</code></strong>, <strong class="userinput"><code>BlinkRight</code></strong>, and <strong class="userinput"><code>BrowsDown</code></strong> Blend Shapes. Remember to call the animations according to the Blend Shapes names (it makes it easier to recognize animations).</li><li>An Animator Controller was automatically created for the <strong class="userinput"><code>FaceAnims</code></strong> game object. Open it.</li><li>Delete all the states in the controller and add a new <strong class="userinput"><code>Blend Tree</code></strong>.</li><li>Double-click  on the <strong class="userinput"><code>Blend Tree</code></strong> to enter its settings.</li><li>Set the <strong class="userinput"><code>Blend Tree</code></strong> type to <strong class="userinput"><code>Direct</code></strong>. It allows the blending of multiple animations together.</li><li>Create five <strong class="userinput"><code>Motion Fields</code></strong> in the <strong class="userinput"><code>Blend Tree</code></strong> and assign the <strong class="userinput"><code>Angry</code></strong>, <strong class="userinput"><code>Smile</code></strong>, <strong class="userinput"><code>BlinkLeft</code></strong>, <strong class="userinput"><code>BlinkRight</code></strong>, and <strong class="userinput"><code>BrowsDown</code></strong> animations to them.</li><li>Create five <code class="literal">float</code> parameters in the controller, one for each animation. Name them accordingly and assign them to the <strong class="userinput"><code>Motion Fields</code></strong> (<strong class="userinput"><code>Smile</code></strong> parameter to <strong class="userinput"><code>Smile</code></strong> animation, <strong class="userinput"><code>Angry</code></strong> parameter to <strong class="userinput"><code>Angry</code></strong> animation, and so on).</li><li>Write a new script and call it <code class="literal">BlendMultiple.cs</code>. Create five public float member variables in the script and name them according to the <strong class="userinput"><code>Blend Shape</code></strong> names (<code class="literal">public float Smile</code>, <code class="literal">public float Angry</code>, and so on).</li><li>In the <code class="literal">Update()</code> function, we set the values of the controller parameters to the values of the variables. This way when we change the variable's values, the parameters in the controller also change and our character plays facial expressions:</li></ol></div><pre class="programlisting">        anim.SetFloat("Angry", Angry); 
        anim.SetFloat("Smile", Smile); 
        anim.SetFloat("BlinkLeft", BlinkLeft); 
        anim.SetFloat("BlinkRight", BlinkRight); 
        anim.SetFloat("BrowsDown", BrowsDown); </pre><div class="orderedlist"><ol class="orderedlist arabic" start="19" type="1"><li>Attach the script to the <strong class="userinput"><code>FaceAnims</code></strong> game object. Play the game and change the scripts float variables in runtime to see the effect (you can use the <strong class="userinput"><code>Scene </code></strong>View).</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/240dd194-8d2c-4a14-af68-77043aa9df21.png" /></div><p>A mix of different Blend Shapes gives an interesting facial expression</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec181"></a>How it works...</h3></div></div></div><p>This recipe has a few key elements that make it work:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Blend Shapes</strong></span>: You need to export the <span>Blend Shapes</span><a id="id325509834" class="indexterm"></a> from your 3D package. Blend Shapes store different version of the same mesh. The mesh has to have the same number of vertices. When creating new Blend Shapes, you can only <span>move</span><a id="id325509843" class="indexterm"></a> the vertices around (you cannot add or delete vertices).</li><li style="list-style-type: disc"><span class="strong"><strong>FaceAnims game object</strong></span>: Our character is a child of a new game object, <strong class="userinput"><code>FaceAnims</code></strong>. This allows us to be able to animate facial expressions. As our character has its own Animator component and its own animations, we cannot modify it with the <strong class="userinput"><code>Animation</code></strong> View. Adding a parent game object solves the problem.</li><li style="list-style-type: disc"><span class="strong"><strong>Direct Blend Tree</strong></span>: We use a <strong class="userinput"><code>Blend Tree</code></strong> set to <strong class="userinput"><code>Direct</code></strong>. This allows us to blend multiple animations at once. This is suitable for Blend Shapes and facial expressions.</li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec182"></a>There's more...</h3></div></div></div><p>You don't have to create Animation Clips for Blend Shapes. Instead, you can manipulate them directly from code. Use the <code class="literal">SetBlendShapeWeight()</code> function on the <strong class="userinput"><code>Skinned Mesh Renderer</code></strong> component. You will need to know the index of the <strong class="userinput"><code>Blend Shape</code></strong> in the <strong class="userinput"><code>Blend Shapes</code></strong> array (you can check it in the Inspector, in the <strong class="userinput"><code>Skinned Mesh Renderer</code></strong> component of the character). We've prepared a small script that sets the weight. It is attached to the <strong class="userinput"><code>DirectBlendShapes</code></strong> game object. You can also find it in the <code class="literal">Scripts</code> directory of this recipe.</p><p>Creating animations for <strong class="userinput"><code>Blend Shapes</code></strong> gives more flexibility. You can also animate the Blend Shapes' weight with the <strong class="userinput"><code>Animation</code></strong> View. This way you can create dialog animations and believable animated facial expressions.</p></div></div>