<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec79"></a>Using waveform of a sound clip to animate objects in the scene</h2></div></div><hr /></div><p>In this recipe, we will use a <span>waveform</span><a id="id325241415" class="indexterm"></a> of a sound effect to create motion based on the average <span>volume</span><a id="id325509762" class="indexterm"></a> of the fragment of the waveform.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec247"></a>Getting ready</h3></div></div></div><p>To follow this recipe, we need a sound effect. You can use the provided example Unity project and go to the <code class="literal">Chapter 07 Special effects\Recipe 09 Using waveform of a sound clip to animate objects in the scene</code> directory. If you open the <code class="literal">Example.unity</code> scene there and play the game, you will be able to see a few cubes react to the playing audio clip.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec248"></a>How to do it...</h3></div></div></div><p>To use <span>sound waveforms</span><a id="id325509828" class="indexterm"></a> for <span>animation</span><a id="id325509836" class="indexterm"></a>, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Import the sound into Unity.</li><li>Create an empty game object and name it <code class="literal">AudioSource</code>.</li><li>Add an Audio Source component to it, and make the sound <strong class="userinput"><code>Loop</code></strong> and <strong class="userinput"><code>Play On Awake</code></strong>. Drag and drop your sound into the <strong class="userinput"><code>AudioClip</code></strong> field.</li><li>Create a <strong class="userinput"><code>Cube</code></strong> game object (go to <strong class="userinput"><code>Game Object</code></strong> | <strong class="userinput"><code>3D Object</code></strong> | <strong class="userinput"><code>Cube</code></strong>).</li><li>Create a new script and call it <code class="literal">ScaleWithWaveForm.cs</code>. In this script, we have one <code class="literal">public AudioSource audioSource</code> variable, one <code class="literal">public float lerpSpeed</code> variable, one<code class="literal">  float[] samples</code> array, and a <code class="literal">float currentSample</code> variable to store the average volume of the <code class="literal">samples</code>. In this script's <code class="literal">Start()</code> function, we set the size of the <code class="literal">samples</code> array to 1024 (it needs to be a power of 2). This is the number of samples we will read from the Audio Source. We also start a <code class="literal">IEnumerator SampleAudio()</code> coroutine:</li></ol></div><pre class="programlisting">        public AudioSource audioSource; 
        public float lerpSpeed = 100f; 
        float[] samples; 
        float currentSample; 
 
        void Start() 
        { 
            samples = new float[1024]; 
            StartCoroutine("SampleAudio"); 
        } </pre><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>This coroutine uses the <code class="literal">audioSource.GetOutputData()</code> function to get and store the output audio samples in the samples array. Then we sum all the squared samples and calculate an average volume (the <strong class="userinput"><code>RMS</code></strong>). Lastly, we use this value to scale the Cube game object. Additionally, we interpolate the scale changes in time to make it smoother. The <code class="literal">currentSample</code> value is multiplied by 10 to make the changes more visible (<strong class="userinput"><code>RMS</code></strong> ranges from 0 to 1):</li></ol></div><pre class="programlisting">        IEnumerator SampleAudio() 
        { 
            while (true) 
            { 
                audioSource.GetOutputData(samples, 0); 
                currentSample = 0f; 
                for (int i = 0; i &lt; samples.Length; i++) 
                { 
                    currentSample += (samples[i]* 
                    samples[i]); 
                } 
                currentSample = Mathf.Sqrt(currentSample / 
                samples.Length); 
         
                transform.localScale = 
                Vector3.Lerp(transform.localScale, 
                Vector3.one * currentSample*100f, 
                Time.deltaTime*4f); 
         
                yield return null; 
            } 
       } </pre><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>Assign the script to the <strong class="userinput"><code>Cube</code></strong> game object.</li><li>Drag and drop the <strong class="userinput"><code>AudioSource</code></strong> game object into the <strong class="userinput"><code>Audio Source</code></strong> field of the script.</li><li>Play the game to see the effect.</li></ol></div><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec249"></a>How it works...</h3></div></div></div><p>The key component of this <span>recipe</span><a id="id325526786" class="indexterm"></a> is the <code class="literal">AudioSource.GetOutputData(float[] samples, int channel)</code> function. It grabs a <span>number</span><a id="id325526797" class="indexterm"></a> of samples from the currently playing audio. The number of samples is specified by the length of the <code class="literal">float[] samples</code> array. This length has to be a power of 2. We get the samples every frame in the <code class="literal">IEnumerator SampleAudio()</code> coroutine. We average the values of squared samples to calculate an RMS of the audio (an average volume of a number of samples). The more samples we average, the smoother the changes of the RMS. For most sounds, 1024 is a good number. We use the calculated RMS to scale the <strong class="userinput"><code>Cube</code></strong> game object.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec250"></a>See also</h3></div></div></div><p>You can perform more complex signal analysis of the waveform to create more interesting effects. For instance, if you want to create an equalizer showing different frequencies of the sound, you need to use the fast Fourier transform. You can find a lot of interesting information about it in the Unity forums.</p></div></div>