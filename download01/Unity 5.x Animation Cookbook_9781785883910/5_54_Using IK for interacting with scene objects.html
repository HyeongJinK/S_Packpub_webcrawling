<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec57"></a>Using IK for interacting with scene objects</h2></div></div><hr /></div><p>Sometimes our characters need to interact with <span>objects</span><a id="id325241217" class="indexterm"></a> in the scene. Most likely we will need to have a solution for picking up items from the ground or other <span>objects</span><a id="id325241225" class="indexterm"></a>. This recipe shows a simple solution for that.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec175"></a>Getting ready</h3></div></div></div><p>In this recipe, we are using only two animations: <strong class="userinput"><code>Idle</code></strong> and <strong class="userinput"><code>Pickup</code></strong>. The second one makes the character pick something from the ground. You can go to the <code class="literal">Chapter 05 Character actions and expressions\Recipe 07 Using IK for interacting with scene objects</code> directory. You will find an <code class="literal">Example.scene</code> there. Open it, play the game, and press the space bar to see the character trying to pick up an object from the ground. You can move the object and play the game again. The character will still try to reach the object.</p><div class="mediaobject"><img src="/graphics/9781785883910/graphics/2011c596-93f8-4f74-8819-d76e2f248a31.png" /></div><p>Character trying to pick an object from the ground</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec176"></a>How to do it...</h3></div></div></div><p>To use <span>IK</span><a id="id325241552" class="indexterm"></a> to interac with <span>scene objects</span><a id="id325241560" class="indexterm"></a>, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Import the character to Unity. Make sure to have the <strong class="userinput"><code>Idle</code></strong> and <strong class="userinput"><code>Pickup</code></strong> animations and set the rig to <strong class="userinput"><code>Humanoid</code></strong>.</li><li>Create an Animator Controller and assign it to the character.</li><li>Make sure to check the <strong class="userinput"><code>IK Pass</code></strong> option in the layer properties of the controller.</li><li>Drag and drop the <strong class="userinput"><code>Idle</code></strong> and <strong class="userinput"><code>Pickup</code></strong> animations into the controller. Make sure <strong class="userinput"><code>Idle</code></strong> is the default state.</li><li>Create a <code class="literal">Trigger</code> parameter and call it <code class="literal">Pickup</code>. Also create a <code class="literal">float</code> parameter and call it <strong class="userinput"><code>PickupIK</code></strong>.</li><li>Create two transitions:
<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Idle</code></strong> | <strong class="userinput"><code>Pickup</code></strong> with one condition: <strong class="userinput"><code>Pickup </code></strong><code class="literal">Trigger</code> parameter. <strong class="userinput"><code>Exit Time</code></strong> should be set to false and <strong class="userinput"><code>Transition Duration</code></strong> set to around 0.1 seconds.</li><li style="list-style-type: disc"><strong class="userinput"><code>Pickup</code></strong> | <strong class="userinput"><code>Idle</code></strong> with no conditions. <strong class="userinput"><code>Has Exit Time</code></strong> should be set to true and <strong class="userinput"><code>Transition Duration</code></strong> set to around 0.1 seconds.</li></ul></div></li><li>Go to the character's <strong class="userinput"><code>Import</code></strong> settings in the <strong class="userinput"><code>Animations</code></strong> tab.</li><li>Create a new <strong class="userinput"><code>Animation Curve</code></strong> and name it <code class="literal">PickupIK</code> (the name has to match the <code class="literal">float </code><strong class="userinput"><code>PickupIK</code></strong> parameter name).</li><li>Create a smooth curve with the minimum value of 0 and the maximum of 1. The maximum value should match the moment when the character reaches for the object. See the following image for reference:</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/087bf3f4-788e-482c-9dd9-96f2c96083b2.png" /></div><p>PickupIK Animation Curve. The maximum value (1) matches the frame when character picks up the object</p><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>Apply the import settings.</li><li>Create a new script and call it <code class="literal">PickUpIK.cs</code>. In that script, we have a <code class="literal">void OnAnimatorIK(int layerIndex)</code> function. This function is called every frame in the <strong class="userinput"><code>IK Pass</code></strong> after all animations have been evaluated. In that function, we get the value of the <strong class="userinput"><code>PickupIK </code></strong><code class="literal">float</code> parameter from the controller (which equals the value of the <strong class="userinput"><code>Animation Curve</code></strong>). Then we set this value as the weight for the left-hand IK. We also set the left-hand IK position to match a <code class="literal">public Transform ikTarget</code> member variable in which we store the reference to the object we want to pick up:</li></ol></div><pre class="programlisting">        ikWeight = anim.GetFloat("PickupIK"); 
        anim.SetIKPosition(AvatarIKGoal.LeftHand, 
        ikTarget.position); 
        anim.SetIKPositionWeight(AvatarIKGoal.LeftHand, ikWeight) </pre><div class="orderedlist"><ol class="orderedlist arabic" start="12" type="1"><li>In the <code class="literal">Update()</code> function of the script, we check if the player pressed the space bar and played the <strong class="userinput"><code>Pickup</code></strong> animation.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="13" type="1"><li>Save the script and attach it to the character. Create a new game object that we want to pick up. Call it <strong class="userinput"><code>PickupObject</code></strong> and drag it to the <strong class="userinput"><code>Ik Target</code></strong> field in the script's <strong class="userinput"><code>Inspector</code></strong>.</li><li>Play the game and press the space bar to see the effect. You may move the <strong class="userinput"><code>PickupObject</code></strong> in the <strong class="userinput"><code>Scene</code></strong> View and press the space bar again. Our character will still try to reach it (it may fail due to the limited range of its arms).</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec177"></a>How it works...</h3></div></div></div><p>This recipe <span>works</span><a id="id325540348" class="indexterm"></a> for Humanoid characters only. It uses the Unity's built-in inverse <span>kinematics</span><a id="id325544898" class="indexterm"></a> solver. The key elements of this recipe are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Animation Curve</code></strong>: We use an Animation Curve to smoothly set the weight for the IK solver during the Pickup animation playback.</li><li style="list-style-type: disc"><strong class="userinput"><code>SetIKPosition()</code></strong>: This function sets the target position for a given body part. We are using a <code class="literal">public Transform ikTarget</code> variable in the script and pass it to the function. You can get the target in runtime.</li><li style="list-style-type: disc"><strong class="userinput"><code>SetIKPositionWeight()</code></strong>: This function sets the weight of the IK solver. A weight value of 1 means that IK is in full control of a given body part and a value of 0 means that the animation is in full control.</li><li style="list-style-type: disc"><strong class="userinput"><code>IK Pass</code></strong>: To be able to use inverse kinematics for Humanoid characters, we need to enable the <strong class="userinput"><code>IK Pass</code></strong> option in the controller's layer properties.</li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec178"></a>See also</h3></div></div></div><p>If you want to play with IK solutions a little more, definitely check out the Final IK package published by <span class="emphasis"><em>RootMotion</em></span> in the <code class="literal">Asset</code> store. It is a very robust full-body IK solution for Unity.</p></div></div>