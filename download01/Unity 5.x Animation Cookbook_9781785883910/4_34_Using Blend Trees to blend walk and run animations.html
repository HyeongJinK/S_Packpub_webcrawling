<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec38"></a>Using Blend Trees to blend walk and run animations</h2></div></div><hr /></div><p>In this first recipe, we will get familiar with <span class="strong"><strong><span>Blend Trees</span><a id="id325532301" class="indexterm"></a></strong></span> (a new type of states in the Animator Controller). <span>Blend Trees</span><a id="id325532310" class="indexterm"></a> allow to smoothly blend multiple animations together. A common example for using them is blending <span>walk and run</span><a id="id325532318" class="indexterm"></a> cycles.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec105"></a>Getting ready</h3></div></div></div><p>Before we start, you should have a character with at least three looped animations: idle, walk (in place), and run (also in place). You can download the provided example; open the project in Unity and go to the <code class="literal">Chapter 04 Character movement\Recipe 01 Using blend trees to blend walk and run animations</code> folder. You will find a scene called <code class="literal">Example.unity</code> there, with an animated humanoid character. If you play the game, you can click on the ground to move the character, and if you press <span class="emphasis"><em>Shift</em></span> while moving, the character will blend to run animation smoothly. In the <code class="literal">Rigs</code> directory, you can find the <code class="literal">Humanoid.fbx</code> asset with the required animations.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec106"></a>How to do it...</h3></div></div></div><p>To create a smooth blend between walk and run animations, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Import your animated character with <strong class="userinput"><code>Idle</code></strong>, <strong class="userinput"><code>Walk</code></strong>, and <strong class="userinput"><code>Run</code></strong> animations. <strong class="userinput"><code>Walk</code></strong> and <strong class="userinput"><code>Run</code></strong> animations should be done "in place".</li><li>Set the animations to <strong class="userinput"><code>Loop Time</code></strong> in the character asset's <strong class="userinput"><code>Inspector</code></strong> in the <strong class="userinput"><code>Animation</code></strong> tab. If your character's rig is set to <strong class="userinput"><code>Humanoid</code></strong>, you may also need to set all the <strong class="userinput"><code>Bake Into Pose</code></strong> options to true for each animation and all the <strong class="userinput"><code>Based Upon</code></strong> options to <strong class="userinput"><code>Original</code></strong>, as shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/0c04f946-eed9-4e75-93af-fecee61d1d8f.png" /></div><p>Settings of in place Idle, Walk and Run animations</p><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Create an Animator Controller for your character.</li><li>Drag and drop the <strong class="userinput"><code>Idle</code></strong> animation into the Animator Controller to make it the default state.</li><li>Add a <code class="literal">float</code><strong class="userinput"><code>Speed</code></strong> parameter in the Animator Controller.</li><li>Right-click on the empty space in the Animator Controller and choose <strong class="userinput"><code>Create State</code></strong> | <strong class="userinput"><code>New From Blend Tree</code></strong>. This will create an empty <strong class="userinput"><code>Blend Tree</code></strong>.</li><li>Click on the <strong class="userinput"><code>Blend Tree</code></strong> and change its name in the <strong class="userinput"><code>Inspector</code></strong> to something meaningful; we use <strong class="userinput"><code>WalkAndRunBlend</code></strong> in this example.</li><li>Double-click on the <strong class="userinput"><code>Blend Tree</code></strong>. It will open the <strong class="userinput"><code>Blend Tree</code></strong> settings.</li><li>Click on the plus button (marked with number <span class="strong"><strong>1</strong></span> in the following screenshot) and choose the <strong class="userinput"><code>Add Motion Field</code></strong> option twice. Two <strong class="userinput"><code>Motion</code></strong> fields will be added.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>Drag and drop your <strong class="userinput"><code>WalkInPlace</code></strong> animation in the first (upper) field and your <strong class="userinput"><code>RunInPlace</code></strong> animation in the second (lower) field. Fields are marked with number <span class="strong"><strong>2</strong></span>, as shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/02525c39-f997-4c35-a805-bfb1976c70b9.png" /></div><p>Blend Tree properties</p><div class="orderedlist"><ol class="orderedlist arabic" start="11" type="1"><li>Unselect the <strong class="userinput"><code>Automate Thresholds</code></strong> option (<span class="strong"><strong>3</strong></span> in the preceding screenshot). This will make the <strong class="userinput"><code>Threshold</code></strong> field available for each <strong class="userinput"><code>Motion</code></strong> field. These are the thresholds of the <strong class="userinput"><code>Parameter</code></strong> used by the <strong class="userinput"><code>Blend Tree</code></strong> (marked with <span class="strong"><strong>4</strong></span> in the preceding screenshot). If the <strong class="userinput"><code>Parameter</code></strong> is set to the exact value of a given threshold, the animation corresponding to that threshold is played. If the <strong class="userinput"><code>Parameter</code></strong> is set to a value between two thresholds, both animations are played with appropriate weights (and are blended together).</li><li>Set the <strong class="userinput"><code>Thresholds</code></strong> to <code class="literal">1</code> for the <strong class="userinput"><code>WalkInPlace</code></strong> motion and <code class="literal">4</code> for the <strong class="userinput"><code>RunInPlaceMotion</code></strong> (you may need to adjust these values later).</li><li>Click on the <strong class="userinput"><code>Play</code></strong> button in the <strong class="userinput"><code>Preview</code></strong> window, below the <strong class="userinput"><code>Blend Tree</code></strong> settings.</li><li>Find the <strong class="userinput"><code>Speed</code></strong> parameter slider on the <strong class="userinput"><code><span>Blend Tree</span><a id="id325532589" class="indexterm"></a></code></strong> node, and move it to see the animations blending smoothly, depending on the <strong class="userinput"><code>Speed</code></strong> parameter value.</li><li>Double-click on the empty space in the Animator Controller to get out of the <strong class="userinput"><code>Blend Tree</code></strong> settings.</li><li>Create two transitions:</li></ol></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Idle</code></strong> | <strong class="userinput"><code>WalkAndRunBlend</code></strong> with the condition set to <strong class="userinput"><code>Speed</code></strong> parameter greater than 0.5, <strong class="userinput"><code>Has Exit Time</code></strong> set to false, and <strong class="userinput"><code>Transition Duration</code></strong> set to 0.2 seconds.</li><li style="list-style-type: disc"><strong class="userinput"><code>WalkAndRunBlend</code></strong> | <strong class="userinput"><code>Idle</code></strong> with the condition set to <strong class="userinput"><code>Speed</code></strong> parameter less than 0.5, <strong class="userinput"><code>Has</code></strong><strong class="userinput"><code>Exit</code></strong><strong class="userinput"><code>Time</code></strong> set to false, and <strong class="userinput"><code>Transition</code></strong><strong class="userinput"><code>Duration</code></strong> set to 0.2 seconds.</li></ul></div><div class="orderedlist"><ol class="orderedlist arabic" start="17" type="1"><li>Write a script to move your character and set the <strong class="userinput"><code>Speed</code></strong> parameter value according to the movement speed of your character. We are using point and click movement in this example. You can find two scripts in the provided Unity project, <code class="literal">ClickToMove.cs</code> in the <code class="literal">Shared</code> scripts directory and <code class="literal">SetSpeedFromAgent.cs</code> in the <code class="literal">Scripts</code> directory of this recipe. The first one is used to set the destination for the Nav Mesh Agent component attached to the character.</li><li>In the <code class="literal">Update()</code> function of the <code class="literal">SetSpeedFromAgent.cs</code> script, we use the <code class="literal">desiredVelocity</code> of the <strong class="userinput"><code>NavMeshAgent</code></strong> to set the <strong class="userinput"><code>Speed</code></strong> parameter in our Animator Controller:</li></ol></div><pre class="programlisting">        anim.SetFloat("Speed", agent.desiredVelocity.magnitude,
        0.2f, Time.deltaTime);</pre><div class="orderedlist"><ol class="orderedlist arabic" start="19" type="1"><li>The <code class="literal">anim</code> variable stores the reference to the Animator component of the character and the <code class="literal">agent</code> variable stores the reference to the Nav Mesh Agent component.</li><li>We are also adjusting the <code class="literal">agent.speed</code> variable in the <code class="literal">Update()</code> function to set the maximum speed of the <strong class="userinput"><code>NavMeshAgent</code></strong>. This allows us to make the character run when player holds the <span class="emphasis"><em>Shift</em></span> button and walk when player releases the <span class="emphasis"><em>Shift</em></span> button:</li></ol></div><pre class="programlisting">        if (Input.GetKey(KeyCode.LeftShift) || 
        Input.GetKey(KeyCode.RightShift)) 

        { 

             agent.speed = 4f; 
        } 
        else 
        { 
             agent.speed = 1f; 
        }</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec107"></a>How it works...</h3></div></div></div><p><span>Blend Trees</span><a id="id325532846" class="indexterm"></a> blend multiple animations based on the chosen Animator Controller parameter value and <strong class="userinput"><code>Motion</code></strong> fields' thresholds. In the standard Blend Tree, always only two animations are blended at the same time: the animation with a lower <strong class="userinput"><code>Threshold</code></strong> and the animation with a higher <strong class="userinput"><code>Threshold</code></strong>. Each animation is blended with the weight corresponding to the distance between the actual parameter value and the <strong class="userinput"><code>Threshold</code></strong> of the animation. For instance, if your <strong class="userinput"><code>Walk</code></strong> animation <strong class="userinput"><code>Threshold</code></strong> is set to 1, your <strong class="userinput"><code>Run</code></strong> animation <strong class="userinput"><code>Threshold</code></strong> is set to 2, and your current <strong class="userinput"><code>Speed</code></strong> parameter value equals 1.5, both <strong class="userinput"><code>Walk</code></strong> and <strong class="userinput"><code>Run</code></strong> animations will be played with 50 percent weight, which will most likely result in your character jogging slowly.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note8"></a>Note</h3><p>When blending <strong class="userinput"><code>Walk</code></strong> and <strong class="userinput"><code>Run</code></strong> animations, make sure to have the contact poses in the same normalized time in both animations. For instance, if the <strong class="userinput"><code>Walk</code></strong> animation has contact poses in 0 percent, 50 percent, and 100 percent of the animation, the <strong class="userinput"><code>Run</code></strong> animation should also have contact poses in 0 percent, 50 percent, and 100 percent of the animation. That will assure proper and smooth blending between the animations.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec108"></a>There's more...</h3></div></div></div><p>There are a few other interesting options in the <strong class="userinput"><code>Blend Tree</code></strong> settings:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">You can set the <strong class="userinput"><code>Blend Type</code></strong> of a <strong class="userinput"><code><span>Blend Tree</span><a id="id325532932" class="indexterm"></a></code></strong> to the following:
<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>1D</code></strong>: A simple Blend Tree using one parameter to define the weight of a currently played animation.</li><li style="list-style-type: disc"><strong class="userinput"><code><span>2D Simple Directional</span><a id="id325532950" class="indexterm"></a></code></strong>: This option uses two parameters for blending the animations, such as the <span class="emphasis"><em>X</em></span> axis and <span class="emphasis"><em>Y</em></span> axis. It is best used for motions representing different movement directions, for instance, walk forward, walk left, walk right, and walk back. It shouldn't be used with multiple animations representing movement in the same direction (such as walk forward and run forward).</li><li style="list-style-type: disc"><strong class="userinput"><code><span>2D Freeform Directional</span><a id="id325532967" class="indexterm"></a></code></strong>: This option is similar to the previous one, but you can use multiple animations representing movement in the same direction (such as walk and run). You need to add a single animation representing the motion in the 0, 0 position (such as idle).</li><li style="list-style-type: disc"><strong class="userinput"><code><span>2D Freeform Cartesian</span><a id="id325532978" class="indexterm"></a></code></strong>: This option is similar to the preceding one, but is used when your animations don't represent movement in different directions. It can be used to blend multiple versions of the idle animation, for instance.</li><li style="list-style-type: disc"><strong class="userinput"><code><span>Direct</span><a id="id325532989" class="indexterm"></a></code></strong>: You can control the weight of each of the nodes (Motion fields) directly. This type is often used while blending facial expressions (see the <span class="emphasis"><em>Animating facial expressions with Blend Shapes</em></span> recipe in <span><a class="link" href="#" linkend="ch05">Chapter 5</a></span>, <span class="emphasis"><em>Character Actions and Expressions</em></span>).</li></ul></div></li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">You can set a few additional <strong class="userinput"><code>Motion</code></strong> field options:
<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code><span>Time Scale</span><a id="id325533024" class="indexterm"></a></code></strong>: You can alter the playback speed of each animation in the <strong class="userinput"><code>Blend Tree</code></strong> by changing the number in the <strong class="userinput"><code>Time Scale</code></strong> field: the one with a clock icon. It is set to 1 (100 percent) by default.</li><li style="list-style-type: disc"><strong class="userinput"><code><span>Mirror</span><a id="id325533041" class="indexterm"></a></code></strong>: You can mirror any of the animations in the <strong class="userinput"><code>Blend Tree</code></strong> by checking the <strong class="userinput"><code>Mirror</code></strong> option, the one with a mirrored humanoid icon.</li></ul></div></li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">You can also check the <strong class="userinput"><code>Automate Thresholds</code></strong> option, which will distribute the <strong class="userinput"><code>Motion</code></strong> fields' <strong class="userinput"><code>Thresholds</code></strong> evenly throughout the whole parameter's range. For instance, if your parameter's range is 0 to 9 and you have four animations, the first one will have a <strong class="userinput"><code>Threshold</code></strong> of 0, the second one 3, the third one 6, the fourth one 9. You can change the parameter range by clicking on the 0 and 1 numbers below the blending graph.</li><li style="list-style-type: disc">You can also use the <strong class="userinput"><code>Compute Thresholds</code></strong> option (<strong class="userinput"><code>Automate Thresholds</code></strong> have to be set to <strong class="userinput"><code>false</code></strong>). This option will compute the <strong class="userinput"><code>Thresholds</code></strong> based on the root motion information from your animations (speed magnitude, velocity in the <span class="emphasis"><em>X</em></span> axis, velocity in the <span class="emphasis"><em>Y</em></span> axis, velocity in the <span class="emphasis"><em>Z</em></span> axis, angular speed in radians, and angular speed in degrees). We will cover root motion in the next recipe.</li></ul></div></div></div>