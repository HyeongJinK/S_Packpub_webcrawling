<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec45"></a>Using triggers to grab an edge while jumping</h2></div></div><hr /></div><p>Grabbing an edge while jumping is a common feature, especially in platform games. It is easily done in Unity with a small amount of scripting. This recipe covers a simple edge grab functionality.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec132"></a>Getting ready</h3></div></div></div><p>You need three new <span>animations</span><a id="id325289106" class="indexterm"></a> for our character: <strong class="userinput"><code>EdgeGrab</code></strong>, <strong class="userinput"><code>EdgeGrabLoop</code></strong>, and <strong class="userinput"><code>EdgeGrabClimb</code></strong>. The first one is a transition from the <strong class="userinput"><code>InAir</code></strong> animation to the <strong class="userinput"><code>EdgeGrabLoop</code></strong> animation. It should have minimum movement in the root node if possible. The second one is a looped animation of hanging on the cliff's edge. The last one is an animation that uses root motion to climb the cliff's edge and ends with an <strong class="userinput"><code>Idle</code></strong> pose. See the following screenshot for reference:</p><div class="mediaobject"><img src="/graphics/9781785883910/graphics/177e3c2f-596a-4c21-a541-a91432082143.png" /></div><p>Frames of the EdgeGrabClimb animation using root motion to climb over the cliff's edge</p><p><strong class="userinput"><code>EdgeGrab</code></strong> and <strong class="userinput"><code>EdgeGrabLoop</code></strong> animations should have all <strong class="userinput"><code>Bake Into Pose</code></strong> options selected in <strong class="userinput"><code>Import Settings</code></strong>. <strong class="userinput"><code>EdgeGrabLoop</code></strong> should also have the <strong class="userinput"><code>Loop Time</code></strong> option selected. You can also use the provided example Unity project and go to the <code class="literal">Chapter 04 Character movement\Recipe 08 Using triggers to grab an edge while jumping</code> directory. You will find an <code class="literal">Example.unity</code> scene there. Open it, play the game, and press the space bar to jump towards the edge. After the character grabs it, press the up <span>arrow</span><a id="id325509757" class="indexterm"></a> to climb over the edge.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec133"></a>How to do it...</h3></div></div></div><p>To be able to grab a cliff's edge while jumping, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Import your character to Unity. Make sure your character can move and jump (follow the <span class="emphasis"><em>Making a character jump with 3-phase animation</em></span> recipe if needed). The character should use a <strong class="userinput"><code>Rigidbody</code></strong> component for moving and jumping. You can still use root motion to move and steer the character.</li><li>Place the character in your scene and make sure it has the <code class="literal">Player</code> tag set.</li><li>You need to have a cliff to be able to grab its edge. Import a suitable model or use a Cube from the <strong class="userinput"><code>Game Object</code></strong> | <strong class="userinput"><code>3D Object</code></strong> | <strong class="userinput"><code>Cube menu</code></strong>. The cliff game object should have a collider (<strong class="userinput"><code>Mesh Collider</code></strong> for example) because we use a Rigid Body character.</li><li>Add a trigger game object (an empty game object with a <strong class="userinput"><code>Box Collider</code></strong> component set to <strong class="userinput"><code>Is Trigger</code></strong>). Name it <code class="literal">GrabTrigger</code> for clarity. Place the trigger near the edge of the cliff. The trigger is marked with the number <span class="strong"><strong>1</strong></span>, as shown in the screenshot after step 5.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Add another empty game object and name it <strong class="userinput"><code>RootTarget</code></strong>. Place it in the position where your character's transform should be when it grabs the edge. It is marked with the number <span class="strong"><strong>2</strong></span>, as shown in the following screenshot. You can adjust the exact position later.</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/4d73d48d-41d4-439d-8ed7-5ef9670e2480.png" /></div><p>GrabTrigger and RootTarget game objects' placement</p><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Open the character's Animator Controller. Drag and drop your <strong class="userinput"><code>GrabEdge</code></strong>, <strong class="userinput"><code>GrabEdgeLoop</code></strong>, and <strong class="userinput"><code>GrabEdgeClimb</code></strong> animations into the controller.</li><li>Add a <code class="literal">Trigger</code><strong class="userinput"><code>GrabEdge</code></strong> parameter and a <code class="literal">Trigger</code><strong class="userinput"><code>PullUp</code></strong> parameter to the controller.</li><li>Create these transitions:
<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Jump</code></strong> | <strong class="userinput"><code>GrabEdge</code></strong> with one condition: <strong class="userinput"><code>GrabEdge</code></strong> trigger parameter. <strong class="userinput"><code>Has Exit Time</code></strong> should be set to false and <strong class="userinput"><code>Transition Duration</code></strong> set to around 0.2 seconds.</li><li style="list-style-type: disc"><strong class="userinput"><code>InAir</code></strong> | <strong class="userinput"><code>GrabEdge</code></strong> with one condition: <strong class="userinput"><code>GrabEdge</code></strong> trigger parameter. <strong class="userinput"><code>Has Exit Time</code></strong> should be set to false and <strong class="userinput"><code>Transition Duration</code></strong> set to around 0.2 seconds.</li><li style="list-style-type: disc"><strong class="userinput"><code>GrabEdge</code></strong> | <strong class="userinput"><code>GrabEdgeLoop</code></strong> with no conditions. <strong class="userinput"><code>Has Exit Time</code></strong> should be set to true and <strong class="userinput"><code>Transition Duration</code></strong> set to around 0.2 seconds.</li><li style="list-style-type: disc"><strong class="userinput"><code>GrabEdgeLoop</code></strong> | <strong class="userinput"><code>GrabEdgeClimbing</code></strong> with one condition: <strong class="userinput"><code>PullUp</code></strong> trigger parameter. <strong class="userinput"><code>Has Exit Time</code></strong> should be set to false and <strong class="userinput"><code>Transition Duration</code></strong> set to around 0.2 seconds.</li><li style="list-style-type: disc"><strong class="userinput"><code>GrabEdgeClimbing</code></strong> | <strong class="userinput"><code>Idle</code></strong> with no conditions: <strong class="userinput"><code>Has Exit Time</code></strong> should be set to true and <strong class="userinput"><code>Transition Duration</code></strong> set to around 0.2 seconds.</li></ul></div></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Close the Animator Controller and assign it to the character's Animator component.</li><li>Create a new script and call it <code class="literal">EdgeGrab.cs</code> (you can find the finished script in the <code class="literal">Scripts</code> directory of this recipe). The goal of this script is to play appropriate <span>animation</span><a id="id325531930" class="indexterm"></a> when we touch the edge of the cliff. We also need to disable collisions and physics and make sure our character will be in the right place while playing the animation (in the <strong class="userinput"><code>RootTarget</code></strong> game object's position).</li><li>First we need a <code class="literal">Grab()</code> function to handle the situation when player starts touching the edge (we will call this function from our <strong class="userinput"><code>GrabTrigger</code></strong> game object later):</li></ol></div><pre class="programlisting">        public void Grab (Transform target) { 
            grabTarget = target; 
 
            if (grabTarget != null) 
            { 
                anim.SetTrigger("GrabEdge"); 
                adjustPosition = true; 
                steeringScript.enabled = false; 
                jumpScript.enabled = false; 
                rb.isKinematic = true; 
                anim.applyRootMotion = true; 
            } 
        } </pre><div class="orderedlist"><ol class="orderedlist arabic" start="12" type="1"><li>This function has a <code class="literal">target</code> parameter which will hold the reference to the <strong class="userinput"><code>RootTarget</code></strong> game object. We assign this parameter to a class member variable <code class="literal">grabTarget</code> (we will use it later). We are starting to play the <strong class="userinput"><code>GrabEdge</code></strong> animation by setting the <strong class="userinput"><code>GrabEdge</code></strong><code class="literal">Trigger</code> in the controller. We are also setting a flag (class member) <code class="literal">adjustPosition</code> to <code class="literal">true</code>. This flag is used later to determine whether we should match our character's position with the <strong class="userinput"><code>RootTarget</code></strong> game object's position. Then we disable two scripts stored in <code class="literal">steeringScript</code> and <code class="literal">jumpScript</code> variables. We are doing it only because we don't want them to interfere with our edge grab action. We are also setting the <code class="literal">isKinematic</code> option on our <strong class="userinput"><code>Rigidbody</code></strong> component (the <code class="literal">rb</code> variable stores the reference to it) to disable collisions and gravity. Lastly, we enable root motion for our Animator Component (reference to which is stored in the <code class="literal">anim</code> variable). That makes the <strong class="userinput"><code>GrabEdgeClimb</code></strong> animation work.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="13" type="1"><li>Next we have to write the <code class="literal">GrabLerp()</code> function that handles the character's position and <strong class="userinput"><code>RootTarget</code></strong>'s position matching:</li></ol></div><pre class="programlisting">        void GrabLerp() 
        { 
             if (grabTarget == null || !adjustPosition) 
             { 
                 return; 
             } 
             if ((transform.position - 
             grabTarget.position).sqrMagnitude &gt; 0.001f) 
             { 
                transform.rotation = 
                Quaternion.Lerp(transform.rotation, 
                grabTarget.rotation, Time.deltaTime * 
                lerpSpeed); 
                transform.position = 
                Vector3.Lerp(transform.position, 
                grabTarget.position, Time.deltaTime * 
                lerpSpeed); 
             } 
             else 
             { 
                transform.position = grabTarget.position; 
                transform.rotation = grabTarget.rotation; 
             } 
        } 
                </pre><div class="orderedlist"><ol class="orderedlist arabic" start="14" type="1"><li>First we check if we have the <code class="literal">grabTarget</code> assigned and if we need to adjust the <span>position</span><a id="id325532263" class="indexterm"></a>. If not, we don't evaluate the function further. Then we check if our character's position is further away than an arbitrary error (1 centimeter in our example). We need to check this margin because we are not using a finite timer for the <code class="literal">Lerp()</code> function. If it's true, we interpolate the position using the <code class="literal">Time.deltaTime</code> (the time between two frames) multiplied by our <code class="literal">public float lerpSpeed</code> variable (set to <code class="literal">10f</code>). We also interpolate the rotation in a similar way to match the <strong class="userinput"><code>RootTarget</code></strong> game object's rotation. The <code class="literal">GrabLerp()</code> function is called every frame in <code class="literal">FixedUpdate()</code> function.</li><li>Next we need to write a <code class="literal">StopGrab()</code> function to re-enable the scripts we disabled in the <code class="literal">Grab()</code> function and turn off the <code class="literal">isKinematic</code> option on the <strong class="userinput"><code>Rigidbody</code></strong> component:</li></ol></div><pre class="programlisting">        public void StopGrab() 
        { 
             rb.isKinematic = false; 
             steeringScript.enabled = true; 
             jumpScript.enabled = true; 
        } 
                </pre><div class="orderedlist"><ol class="orderedlist arabic" start="16" type="1"><li>The last thing we need to do in this script is to handle player input. In the <code class="literal">Update()</code> function, we check if the character is playing the <strong class="userinput"><code>GrabEdgeLoop</code></strong> animation and if player pressed up arrow on the keyboard. If so, we set the <strong class="userinput"><code>PullUp</code></strong><code class="literal">Trigger</code> in the Animator Controller and clear the <code class="literal">grabTarget</code>:</li></ol></div><pre class="programlisting">        if (Input.GetKeyDown(KeyCode.UpArrow)) 
        { 
             if (anim.GetCurrentAnimatorStateInfo(0).IsName( 
              "Base Layer.GrabEdgeLoop")) 
             { 
                 grabTarget = null; 
                 anim.SetTrigger("PullUp"); 
             } 
        } 
                </pre><div class="orderedlist"><ol class="orderedlist arabic" start="17" type="1"><li>Assign the script to the character.</li><li>In the <strong class="userinput"><code>Import Settings</code></strong>, <strong class="userinput"><code>Animation</code></strong> tab, add an Animation Event to the <strong class="userinput"><code>GrabEdgeClimbing</code></strong> animation. To do so, navigate to the <strong class="userinput"><code>Events</code></strong> section (just above the animation <strong class="userinput"><code>Preview</code></strong>), scrub through the timeline of the animation (in the <strong class="userinput"><code>Preview</code></strong>), and click on the <strong class="userinput"><code>Add Event</code></strong> button (see the following screenshot). Double-click on the event and set its name to <code class="literal">StopGrab</code>: this has to be the same as the <code class="literal">public void StopGrab()</code> function we have in our script. Animation Events call public functions from scripts attached to the same game object that is playing the animation containing the Animation Event. Our <code class="literal">StopGrab</code> event will call the <code class="literal">StopGrab()</code> animation in our <code class="literal">EdgeGrab.cs</code> script at the end of the <strong class="userinput"><code>EdgeGrabClimbing</code></strong> animation.</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/cd318f20-28bc-43d3-8351-b6a56d7394dd.png" /></div><p>Animation Event added to the animation's timeline</p><div class="orderedlist"><ol class="orderedlist arabic" start="19" type="1"><li>Create another script and call it <code class="literal">EdgeTrigger.cs</code>. In this script, we have to write a void <code class="literal">OnTriggerEnter(Collider other)</code> function that is called when a Rigid Body enters the trigger collider. In that function, first we check if the object which enters the trigger has the <code class="literal">Player</code> tag to make sure it's our character. Then we create a <code class="literal">grab</code> variable and try to get the <strong class="userinput"><code>EdgeGrab</code></strong> component (our script on the character) from our player game object. If we find the component, we check if character is playing the <strong class="userinput"><code>Jump</code></strong> or <strong class="userinput"><code>InAir</code></strong><span>animation</span><a id="id325532509" class="indexterm"></a>. If so, we call the <code class="literal">Grab()</code> function on our grab object (our <strong class="userinput"><code>EdgeGrab</code></strong> script) and pass the <code class="literal">rootTarget</code> parameter (this is a public variable that stores the reference to our <strong class="userinput"><code>RootTarget</code></strong> game object placed in the scene). At the end of this function, we disable the trigger game object's collider to prevent our character from grabbing the trigger again:</li></ol></div><pre class="programlisting">        if (other.gameObject.CompareTag("Player")) 
        { 
             playerTransform = other.gameObject.transform; 
             Animator anim = 
             other.gameObject.GetComponent&lt;Animator&gt;(); 
             EdgeGrab grab = 
             other.gameObject.GetComponent&lt;EdgeGrab&gt;(); 
             if (grab == null ) 
             { 
                 return; 
             } 
             if (anim.GetCurrentAnimatorStateInfo(0).IsName(" 
                 Base Layer.InAir")|| 
                 anim.GetCurrentAnimatorStateInfo(0).IsName(" 
                 Base Layer.Jump")) 
             { 
                 grab.Grab(rootTarget); 
                 gameObject.GetComponent&lt;Collider&gt;().enabled 
                 = false; 
                 checkToEnable = true; 
             } 
       }</pre><div class="orderedlist"><ol class="orderedlist arabic" start="20" type="1"><li>We re-enable the trigger in the <code class="literal">Update()</code> function when our character is at a safe distance (set in the <code class="literal">public float reEnableDistance</code> variable) from the <strong class="userinput"><code>RootTarget</code></strong> game object:</li></ol></div><pre class="programlisting">        if (checkToEnable) 
        { 
            if (playerTransform == null) 
            { 
               gameObject.GetComponent&lt;Collider&gt;().enabled 
               = true; 
            } 
               else if((playerTransform.position - 
               rootTarget.position).magnitude &gt; reEnableDistance) 
           { 
               checkToEnable = false; 
               gameObject.GetComponent&lt;Collider&gt;().enabled 
               = true; 
           } 
        }</pre><div class="orderedlist"><ol class="orderedlist arabic" start="21" type="1"><li>Assign the <code class="literal">EdgeTrigger.cs</code> script to the <strong class="userinput"><code>GrabTrigger</code></strong> game object and assign the <strong class="userinput"><code>RootTarget</code></strong> game object to the Root Target field of the <strong class="userinput"><code>GrabTrigger</code></strong> game object's <strong class="userinput"><code>EdgeTrigger</code></strong> component in the Inspector.</li><li>Play the game and try to jump near the edge of the cliff to see the effect. You may need to adjust the <strong class="userinput"><code>GrabTrigger</code></strong> game object's and/or <strong class="userinput"><code>RootTarget</code></strong> game object's position to match the <strong class="userinput"><code>GrabEdge</code></strong> animation with the cliff's edge.</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec134"></a>How it works...</h3></div></div></div><p>This recipe has a few key <span>elements</span><a id="id325532633" class="indexterm"></a> that make it work:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Rigid Body</strong></span>: Our character needs to have a <strong class="userinput"><code>Rigidbody</code></strong> component to be able to enter the trigger. We set the <strong class="userinput"><code>Rigidbody</code></strong> to <strong class="userinput"><code>Is Kinematic</code></strong> when our character grabs the edge of the cliff. It allows us to control the position of the character only with animation. If we wouldn't turn the <strong class="userinput"><code>Rigidbody</code></strong> to <strong class="userinput"><code>Is Kinematic</code></strong>, we would have to deal with collisions with the cliff game object.</li><li style="list-style-type: disc"><span class="strong"><strong>Trigger</strong></span>: Our <strong class="userinput"><code>GrabTrigger</code></strong> game object <span class="emphasis"><em>catches</em></span> our character. When the character enters the trigger, we assume it grabs the edge of the cliff.</li><li style="list-style-type: disc"><span class="strong"><strong>Position and rotation matching</strong></span>: We use the <strong class="userinput"><code>RootTarget</code></strong> empty game object as the target for our character's transform when it grabs the edge. This concept lets us match the animation with the edge of the cliff. We use the <code class="literal">Vector3.Lerp()</code> and <code class="literal">Quaternion.Lerp()</code> functions to interpolate the position and rotation of our character in time and match it with the RootTarget's position and rotation.</li><li style="list-style-type: disc"><span class="strong"><strong>Root motion in GrabEdgeClimb animation</strong></span>: We use an animation with root motion to climb the edge of the cliff.</li></ul></div></div></div>