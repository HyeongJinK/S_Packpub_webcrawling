<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec60"></a>Using Sub-State Machines in Animator Controller</h2></div></div><hr /></div><p>This recipe shows how to use <span>Sub-State Machines</span><a id="id325535996" class="indexterm"></a>. This concept helps to organize the flow in <span>Animator Controller</span><a id="id325536005" class="indexterm"></a>.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec183"></a>Getting ready</h3></div></div></div><p>To start, you need to have a character with a few animations. In this example, we are using a character with <strong class="userinput"><code>NormalIdle</code></strong>, <strong class="userinput"><code>NormalMove</code></strong>, <strong class="userinput"><code>CombatIdle</code></strong>, and <strong class="userinput"><code>CombatMove</code></strong> animations. These animations will be then grouped in two <strong class="userinput"><code>Sub-State Machines</code></strong>: <strong class="userinput"><code>Combat</code></strong> and <strong class="userinput"><code>Normal</code></strong>.</p><p>You can also open the provided example Unity project and go to the <code class="literal">Chapter 06 Handling combat\Recipe 01 Using sub state machines in animator controller</code> directory. In the <code class="literal">Rigs</code> directory you, will find all the necessary animations. In the <code class="literal">Controllers</code> directory, you can find the finished controller with two Sub-State Machines. You can find the <strong class="userinput"><code>Humanoid</code></strong> character in the <code class="literal">Example.unity</code> scene. If you press the space bar, our character will switch from <strong class="userinput"><code>Normal</code></strong> to <strong class="userinput"><code>Combat </code></strong><strong class="userinput"><code>Sub-State Machine</code></strong>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec184"></a>How to do it...</h3></div></div></div><p>To create a <span>Sub-State Machine</span><a id="id325549040" class="indexterm"></a> in a controller, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Create and open a new Animator Controller.</li><li>Right-click on the empty space and choose <strong class="userinput"><code>Create Sub-State Machine</code></strong>. A new Sub-State Machine will be created. Name it <code class="literal">Normal</code>.</li><li>Create another Sub-State Machine and name it <code class="literal">Combat</code>.</li><li>Create one <code class="literal">bool</code> parameter: <strong class="userinput"><code>CombatState</code></strong>.</li><li>Create two transitions:
<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Combat</code></strong> | <strong class="userinput"><code>Normal</code></strong> with no conditions.</li><li style="list-style-type: disc"><strong class="userinput"><code>Normal</code></strong> | <strong class="userinput"><code>Combat</code></strong> with no conditions.</li></ul></div></li><li>Double-click on the <strong class="userinput"><code>Normal</code></strong> Sub-State Machine.</li><li>Create a <code class="literal">float </code><strong class="userinput"><code>Speed</code></strong> parameter.</li><li>Drag and drop the <strong class="userinput"><code>NormalIdle</code></strong> and <strong class="userinput"><code>NormalMove</code></strong> animations to the controller (make sure you are in the <strong class="userinput"><code>Normal</code></strong> Sub-State Machine).</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Create two transitions:
<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>NormalIdle</code></strong> | <strong class="userinput"><code>NormalMove</code></strong> with one condition: <strong class="userinput"><code>Speed</code></strong> parameter greater than 0.5. <strong class="userinput"><code>Has Exit Time</code></strong> should be set to <code class="literal">false</code> and <strong class="userinput"><code>Transition Duration</code></strong> should be set to around 0.2 seconds.</li><li style="list-style-type: disc"><strong class="userinput"><code>NormalMove</code></strong> | <strong class="userinput"><code>NormalIdle</code></strong> with one condition: <strong class="userinput"><code>Speed</code></strong> parameter less than 0.5. <strong class="userinput"><code>Has Exit Time</code></strong> should be set to <code class="literal">false</code> and <strong class="userinput"><code>Transition Duration</code></strong> should be set to around 0.2 seconds.</li></ul></div></li><li>Create two transitions—one from <strong class="userinput"><code>NormalIdle</code></strong> to <strong class="userinput"><code>Exit</code></strong> state and another one from <strong class="userinput"><code>NormalMove</code></strong> to <strong class="userinput"><code>Exit</code></strong> state—both with one condition: <strong class="userinput"><code>CombatState</code></strong> parameter set to <code class="literal">true</code>. <strong class="userinput"><code>Time Duration</code></strong> should be set to around 0.2 seconds and <strong class="userinput"><code>Has Exit Time</code></strong> should be set to <code class="literal">false</code>.</li><li>Double-click on the empty space in the controller to get out of the <strong class="userinput"><code>Normal</code></strong><strong class="userinput"><code><span>Sub-State Machine</span><a id="id325241307" class="indexterm"></a></code></strong>.</li><li>Double-click on the <strong class="userinput"><code>Combat</code></strong><span>Sub-State Machine</span><a id="id325241320" class="indexterm"></a> and repeat steps 9 and 10 with <strong class="userinput"><code>CombatIdle</code></strong> and <strong class="userinput"><code>CombatMove</code></strong> animations this time.</li><li>Close the <strong class="userinput"><code>Animator Controller</code></strong> and assign it to your character.</li><li>Write a script to be able to set the <strong class="userinput"><code>Speed</code></strong> value and the <strong class="userinput"><code>CombatState </code></strong><code class="literal">bool</code> parameter. Name it <code class="literal">SetCombatAndSpeed.cs</code>.</li><li>In this script's <code class="literal">Update()</code> function, we check if player pressed the space bar. If so, we invert the <strong class="userinput"><code>CombatSate</code></strong> parameter value. We also check if player pressed the up arrow. If so, we set the <strong class="userinput"><code>Speed</code></strong> parameter to make the character play movement animations:</li></ol></div><pre class="programlisting">        if (Input.GetKeyDown(KeyCode.Space)) 

        { 

            combat = !combat; 

            anim.SetBool("CombatState", combat); 

        } 
        if (Input.GetKey(KeyCode.UpArrow)) 
        { 
            anim.SetFloat("Speed", 1f); 
        } 
        else 
        { 
            anim.SetFloat("Speed", 0f); 
        } </pre><div class="orderedlist"><ol class="orderedlist arabic" start="16" type="1"><li>Assign the script to the character, launch the game, and press the space bar to see the character change Sub-State Machines.</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec185"></a>How it works...</h3></div></div></div><p>The concept of <span>Sub-State Machines</span><a id="id325241386" class="indexterm"></a> makes it easier to organize the controller. You can think of them as of nested controllers. You can have Sub-State Machines inside other Sub-State Machines. Clever organization of your controllers prevents spaghetti graphs.</p><p>To exit a Sub-State Machine you have to transition to the <strong class="userinput"><code>Exit</code></strong> state. You can have multiple such transitions the same way you can have multiple transitions between Sub-State Machines. Use transition conditions to determine where your graph should transition to.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec186"></a>There's more...</h3></div></div></div><p>You can also transition from Sub-State Machines to specific states in any other Sub-State Machine. To do so, make a transition to the state named <strong class="userinput"><code>(Up) Base Layer</code></strong> (the name can vary depending on the Sub-State Machine you are currently in and the names of your layers). If you do this transition, a menu will appear and let you choose the state you want to transition to; see the following screenshot for reference:</p><div class="mediaobject"><img src="/graphics/9781785883910/graphics/41f2c385-79ca-4a78-a4b9-04dd934750c0.png" /></div><p>Transition to a specific state in another Sub-State Machine</p></div></div>