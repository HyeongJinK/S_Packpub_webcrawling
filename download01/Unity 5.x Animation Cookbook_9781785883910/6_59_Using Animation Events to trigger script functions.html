<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec61"></a>Using Animation Events to trigger script functions</h2></div></div><hr /></div><p>We used <span>Animation Events</span><a id="id325241217" class="indexterm"></a> sporadically in earlier recipes because they are so handy, and it was simply difficult to until to this moment. Most present games use Animation Events very extensively, especially for handling combat. Creating believable melee encounters would be a lot harder without this handy tool.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec187"></a>Getting ready</h3></div></div></div><p>Before we start, we need to have a character with an attack animation. In the example files, we named the animation <strong class="userinput"><code>HumanAttack</code></strong>. We also need an enemy (we use a <strong class="userinput"><code>Spider</code></strong> character in this example) with <strong class="userinput"><code>Idle</code></strong> and <strong class="userinput"><code>Death</code></strong> animations. You can also download the provided example Unity project and go to the <code class="literal">Chapter 06 Handling combat\Recipe 02 Using animation events to trigger script functions</code> directory. You will find a scene called <code class="literal">Example.unity</code> there, with <strong class="userinput"><code>Humanoid</code></strong> and <strong class="userinput"><code>Spider</code></strong> characters. In the <code class="literal">Rigs</code> directory, you can find the <code class="literal">Humanoid.fbx</code> character with all required animations. When you play the game, the <strong class="userinput"><code>Humanoid</code></strong> character will attack the <strong class="userinput"><code>Spider</code></strong> several times and deal damage to it.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec188"></a>How to do it...</h3></div></div></div><p>To use Animation Events to trigger script functions, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Import your character with the <strong class="userinput"><code>HumanAttack</code></strong> animation to Unity.</li><li>Go to the <strong class="userinput"><code>Animation</code></strong> import settings tab in the <strong class="userinput"><code>Inspector</code></strong> window.</li><li>Select the <strong class="userinput"><code>HumanAttack</code></strong> animation.</li><li>Navigate down to the <strong class="userinput"><code>Events</code></strong> section and unfold it.</li><li>Use the <strong class="userinput"><code>Preview</code></strong> window to scrub through the animation to the moment of the hit in the attack.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Add an <strong class="userinput"><code><span>Animation Event</span><a id="id325248376" class="indexterm"></a></code></strong> by pressing the <strong class="userinput"><code>Add Event</code></strong> button, as shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/7ed10424-332d-499f-b37f-ff7d54ed05b5.png" /></div><p>Adding Animation Events</p><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>The <strong class="userinput"><code>Edit <span>Animation Event</span><a id="id325289115" class="indexterm"></a></code></strong> window will appear. Type <code class="literal">Attack</code> in the <strong class="userinput"><code>Function</code></strong> text field. To make the event work, we need to have a function with the same name in a script assigned to our character.</li><li>We will create a simple fight scene, so we need a script for the enemy. Create a new script and call it <code class="literal">Enemy.cs</code>. In this script, we have the <code class="literal">public float hitPoints</code> variable to store current health of our enemy. We also have two <code class="literal">public virtual void</code> functions: <code class="literal">Hit(float damage)</code> and <code class="literal">Die().</code> The <code class="literal">Hit(float damage)</code> function subtracts damage from our current <code class="literal">hitPoints</code> and calls the <code class="literal">Die()</code> function when <code class="literal">hitPoin ts</code> drop to 0. The <code class="literal">Die()</code> function plays the death animation by setting the <code class="literal">bool </code><strong class="userinput"><code>Dead</code></strong> parameter in the controller. These functions are <code class="literal">virtual</code> because we want to derive from this script in later recipes to add new functionality:</li></ol></div><pre class="programlisting">        public void Hit(float damage) 
        { 
            hitPoints -= damage; 
            if (hitPoints &lt;= 0) 
            { 
                Die(); 
            } 
        } 
        public void Die() 
        { 
            anim.SetBool("Dead", true); 
        } </pre><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Create one transition:</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>In it, create the <code class="literal">bool </code><strong class="userinput"><code>Dead</code></strong> parameter. Drag and drop the <strong class="userinput"><code>Idle</code></strong> and <strong class="userinput"><code>Death</code></strong> animations to the controller. Make <strong class="userinput"><code>Idle</code></strong> the default state.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="11" type="1"><li>Create a new <span>Animator</span><a id="id325509840" class="indexterm"></a> Controller for our <strong class="userinput"><code>Spider</code></strong> character.
<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Idle</code></strong> | <strong class="userinput"><code>Death</code></strong> with the condition: <strong class="userinput"><code>Dead</code></strong> parameter set to true, <strong class="userinput"><code>Has Exit Time</code></strong> set to <code class="literal">false</code>, and <strong class="userinput"><code>Transition Duration</code></strong> set to 0.2 seconds.</li><li style="list-style-type: disc">Place the <strong class="userinput"><code>Spider</code></strong> character in the scene. Add a <strong class="userinput"><code>Rigidbody</code></strong> component, a <strong class="userinput"><code>Sphere Collider</code></strong> component, and our <code class="literal">Enemy.cs</code> script component to it. Set the <strong class="userinput"><code>Rigidbody</code></strong> component to <strong class="userinput"><code>Is Kinematic</code></strong>.</li></ul></div></li><li>Assign the controller to <strong class="userinput"><code>Spider</code></strong>'s Animator component.</li><li>Create another Animator Controller for our <strong class="userinput"><code>Humanoid</code></strong> character.</li><li>Place a looped <strong class="userinput"><code>HumanAttack</code></strong> animation in that controller and assign it to the <strong class="userinput"><code>Humanoid</code></strong> character.</li><li>Place the <strong class="userinput"><code>Humanoid</code></strong> character near the <strong class="userinput"><code>Spider</code></strong> in the scene.</li><li>Create a new script and call it <code class="literal">MeleeAttack.cs</code>. In this script, we use our <code class="literal">public void Attack()</code> function. This is the function called from the animation event. We have a list of all enemies in range. We iterate through that list and call the <code class="literal">Hit()</code> function on every enemy from that list. We also have a <code class="literal">public</code><code class="literal">float damage</code> variable to store the character's damage value and send it in the <code class="literal">Hit()</code> function:</li></ol></div><pre class="programlisting">        public void Attack () { 

            for (int i = 0; i &lt; enemiesInRange.Count; i++) 

            { 
                enemiesInRange[i].Hit(damage); 
            }     
        } </pre><div class="orderedlist"><ol class="orderedlist arabic" start="17" type="1"><li>Assign the script to the <strong class="userinput"><code>Humanoid</code></strong> character.</li><li>We need one more script to get the targets in range. Create a new script and call it <code class="literal">TargetTrigger.cs</code>. In the <code class="literal">void OnTriggerEnter(Collider other)</code> function of this script, we check if the object entering the trigger has an <code class="literal">Enemy.cs</code> component. If so, we add it to the <code class="literal">enemiesInRange</code> in the <code class="literal">MeleeAttack.cs</code> component:</li></ol></div><pre class="programlisting">        Enemy e = other.gameObject.GetComponent&lt;Enemy&gt;(); 
        if (e != null) 
        { 
            if (!attackScript.enemiesInRange.Contains(e)) 
            { 
                attackScript.enemiesInRange.Add(e); 
            } 
        } </pre><div class="orderedlist"><ol class="orderedlist arabic" start="19" type="1"><li>In the <code class="literal">void OnTriggerExit(Collider other)</code> function, we remove the enemy from the <code class="literal">enemiesInRange</code> list:</li></ol></div><pre class="programlisting">        Enemy e = other.gameObject.GetComponent&lt;Enemy&gt;(); 
        if (e != null) 
        { 
            if (attackScript.enemiesInRange.Contains(e)) 
            { 
                attackScript.enemiesInRange.Remove(e); 
            } 
        } </pre><div class="orderedlist"><ol class="orderedlist arabic" start="20" type="1"><li>In the preceding script, <code class="literal">attackScript</code> is the reference to the <code class="literal">MeleeAttack.cs</code> script component.</li><li>Create an empty game object and name it <code class="literal">TargetTrigger</code>. Add a <strong class="userinput"><code>Box Collider</code></strong> component to it and set the collider to <strong class="userinput"><code>Is Trigger</code></strong>. Assign our <code class="literal">TargetTrigger.cs</code> script to it.</li><li>Make the <strong class="userinput"><code>TargetTrigger</code></strong> game object the child of our <strong class="userinput"><code>Humanoid</code></strong> character and shape the <strong class="userinput"><code>Box Collider</code></strong> for checking melee hit range. See the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/9f0b8ee3-949f-4fd2-908c-eff3d80068ed.png" /></div><p>Melee attack range trigger</p><div class="orderedlist"><ol class="orderedlist arabic" start="23" type="1"><li>Play the game to see the effect.</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec189"></a>How it works...</h3></div></div></div><p><span>Animation Events</span><a id="id325240742" class="indexterm"></a> call public functions from the scripts assigned to the game object playing the animation. To make it work, the <strong class="userinput"><code>Function</code></strong> field of the Animation Event needs to have the same name as the function we want to call from the script.</p><p>Events are extremely useful because they allow us to synchronize function calls with animations. The best moment to check if player hits the target is when we see a visual hit in the animation—a fist is in its extreme position in a punch, or a sword is in its extreme position in a swing. Without Animation Events, we would have to always manually delay function calls to achieve similar results.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec190"></a>There's more...</h3></div></div></div><p>Animation Events can also have an <code class="literal">int</code>, <code class="literal">float</code>, <code class="literal">string</code>, or an object type parameter. To use these parameters, we have to implement them in our functions called by the event. These parameters can be useful for playing special effects or sounds (you can find more information about it in the <span class="emphasis"><em>Using Animation Events to trigger sound and visual effects</em></span> recipe in <span><a class="link" href="#" linkend="ch07">Chapter 7</a></span>, <span class="emphasis"><em>Special Effects</em></span>.</p></div></div>