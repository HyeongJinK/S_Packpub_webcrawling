<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec23"></a>Animating an object's world position - creating a moving platform</h2></div></div><hr /></div><p>In this recipe, we will create a very common gameplay mechanism: a <span>moving platform</span><a id="id325289202" class="indexterm"></a>. We will use a Rigid body for our character and an animated, kinematic Rigid body for the platform.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec56"></a>Getting ready</h3></div></div></div><p>Before we start, you should have a scene with your character and a platform you want to animate. You can use the example project; go to the <code class="literal">Chapter 02 Working with the animation view\Recipe 03 Animating objects world position - creating a moving platform</code> directory. There is a scene called <code class="literal">Example.unity</code> there. If you open it, you will find a <span class="strong"><strong><strong class="userinput"><code>Sheep</code></strong></strong></span> character in the <span class="strong"><strong><strong class="userinput"><code>Hierarchy</code></strong></strong></span>. This is our character, using the <strong class="userinput"><code>Rigidbody</code></strong> component and a Simple Move script to move. There is also a <span class="strong"><strong><strong class="userinput"><code>Moving Platform</code></strong></strong></span> game object in the <strong class="userinput"><code>Hierarchy</code></strong>. This is the kinematic rigid body with a <code class="literal"><span>Platform</span></code> script attached to it. It also has an <span>Animator</span> component and an <span>Animator Controller</span> with just one animation in it. This animation makes the platform move.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec57"></a>How to do it...</h3></div></div></div><p>To create and assign an <span>animated moving platform</span><a id="id325544900" class="indexterm"></a>, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Select your <span>platform</span><a id="id325548989" class="indexterm"></a> game object in the <span class="strong"><strong><strong class="userinput"><code>Hierarchy</code></strong></strong></span>.</li><li>Open the <strong class="userinput"><code>Animation</code></strong> View.</li><li>Make sure the record button is pressed (in the upper-left corner of the <strong class="userinput"><code>Animation</code></strong> View).</li><li>Move the platform to the desired position in the first frame.</li><li>Adjust the timeline a few seconds forward and move your platform to new destination.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>To make the <span>animati</span><a id="id325550878" class="indexterm"></a>on loop, select the first key frame and press <span class="strong"><strong><span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>C</em></span></strong></span> (<span class="strong"><strong><span class="emphasis"><em>cmd </em></span>+ <span class="emphasis"><em>C</em></span></strong></span> on Mac). Then adjust the timeline forward from the second key frame, the same amount of seconds like the previous step. If the first key frame is on the 0 seconds mark and the second on the 10 seconds mark, set the <span>timeline</span><a id="id325550904" class="indexterm"></a> to 20 seconds mark. Press <span class="strong"><strong><span class="emphasis"><em>Ctrl </em></span>+ <span class="emphasis"><em>V</em></span></strong></span> to paste the copied key frame. In our example, the platform is going from one floating island to another and back. It also has some pauses on each end to make it easier for the player to jump on to it.</li><li>When you are happy with your animation, exit the <span class="strong"><strong><strong class="userinput"><code>Animation</code></strong></strong></span> View<span class="strong"><strong>.</strong></span></li><li>An Animator Controller will be created and an Animation Clip will be assigned to it automatically. Also, an Animator component will be added to the platform game object.</li><li>Find the Animator Controller on the platform game object and set the <strong class="userinput"><code>Update Mode</code></strong> property to <strong class="userinput"><code>Animate Physics</code></strong>. Set the <strong class="userinput"><code>Culling Mode</code></strong> to <strong class="userinput"><code>Always Animate</code></strong>.</li><li>Add a <strong class="userinput"><code>Rigidbody</code></strong> component to the platform and select the <strong class="userinput"><code>Kinematic</code></strong> checkbox.</li><li>Add a collider component (a <strong class="userinput"><code>Mesh Collider</code></strong> or a <strong class="userinput"><code>Box Collider</code></strong>) to your platform. If you are using a <strong class="userinput"><code>Mesh Collider</code></strong>, make sure to select the <strong class="userinput"><code>Convex</code></strong> checkbox.</li><li>Create a new script, and name the file <code class="literal">Platform.cs</code>.</li><li>Open the script and write the following code:</li></ol></div><pre class="programlisting">      using UnityEngine; 
      using System.Collections; 
 
      public class Platform : MonoBehaviour { 
 
       /*This function is called by Unity every time this object 
       starts to collide with any other game object with a Collider 
       component attached.The Collision collisionInfo object 
       parameter stores the information about the collision and the 
       object we are colliding with.*/ 
 
          void OnCollisionEnter(Collision collisionInfo) 
          { 
        /*We are checking if the object we are colliding with 
        has a RigidBody component and the RigidBody is not set 
        to kinematic. Optionally we can also check the tag of 
        the object we are colliding with here (to make it work 
        only for the player for instance).*/ 
         
              if (collisionInfo.rigidbody != null 
              &amp;&amp; !collisionInfo.rigidbody.isKinematic) 
              { 
         
            /*We are setting the parent of the object we are 
            colliding with to the platform game object (the 
            object out script is attached to).This will make 
            our character move with the platform instead of 
            slide from it.*/ 
         
                  collisionInfo.transform.parent = transform; 
 
              } 
           } 
 
    /*This function is called by Unity every time this object stop 
    colliding with any object with a Collider component attached. 
    The CollisionInfo collision info parameter stores the same 
    information as in the OnCollisionEnter function.*/ 
 
          void OnCollisionExit(Collision collisionInfo) 
          { 
 
        /*We are checking the same conditions as before*/ 
 
              if (collisionInfo.rigidbody != null 
              &amp;&amp; !collisionInfo.rigidbody.isKinematic) 
              { 
            /*We are setting the parent of the object we are                 colliding with to null. The object has no parent 
            at all and stops moving with the platform*/ 
             
                  collisionInfo.transform.parent = null; 
              } 
          } 
      } </pre><div class="orderedlist"><ol class="orderedlist arabic" start="14" type="1"><li>Attach the script to the platform game object and play the game to see the effect.</li><li>This moving platform will work with characters using <strong class="userinput"><code>Rigidbody</code></strong> components to move. You can import the <code class="literal">ThirdPersonCharacter</code> prefab from Unity's <code class="literal">Standard Assets</code>. You can also write your own simple character movement. To do so, see the <span class="emphasis"><em><span>There's more</span><span>section</span></em></span>.</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec58"></a>How it works...</h3></div></div></div><p>This is the most simple but working <span>moving platform</span><a id="id325532290" class="indexterm"></a> solution. It uses a few key elements:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Animation-driven movement</strong></span>: The platform is moved only by the <span>Animation Clip</span> created with the <span>Animation View</span>. This allows you to experiment with the movement easily.
</li><li style="list-style-type: disc"><span class="strong"><strong>Kinematic Rigid body</strong></span>: To animate a game object with a <strong class="userinput"><code>Rigidbody</code></strong> component attached, you need to set the <strong class="userinput"><code>Kinematic</code></strong> checkbox to true. It completely disables the physics of the Rigid Body. You can still animate the object with <strong class="userinput"><code>Kinematic</code></strong> set to false, but physics will still have an impact on the movement (the object will not be able to penetrate other objects, it will rotate on collisions, and so on).</li><li style="list-style-type: disc"><span class="strong"><strong>Animate Physics option</strong></span>: Set in the <strong class="userinput"><code><span>Update Mod</span><a id="id325532337" class="indexterm"></a>e</code></strong> parameter of the <strong class="userinput"><code>Rigidbody</code></strong> component. This option makes the Rigid body to be animated in the physics loop (you can think of it as the <code class="literal">FixedUpdate()</code> function equivalent). It prevents the Rigid Bodies colliding with this object to jitter and behave in strange ways.</li><li style="list-style-type: disc"><span class="strong"><strong>Animation in world space</strong></span>: Our platform is animated in world coordinates. This means that the animation sets the object's position regarding the scene's 0x, 0y, 0z point. It does not matter where the object is placed in the scene; after playing the animation, it will be placed in the positions stored in the animation's key frames. We will discuss local space animation in the <span class="emphasis"><em>Animating object's local position - creating automatic doors</em></span> recipe.</li><li style="list-style-type: disc"><span class="strong"><strong>Moving platform as a parent to the character</strong></span>: We are setting the platform as the parent to the in-game character, which collides with it. Rigid bodies parented to other <span class="strong"><strong>Transforms</strong></span> try to move with them in game. This is the easiest and rather bulletproof way of making our character move with/relative to the platform game object. And because the platform moves with the <strong class="userinput"><code>Update Mode</code></strong> set to <strong class="userinput"><code>Animate Physics</code></strong>, no jittering will occur. Instead of parenting the character to the platform, you could also experiment with creating a physical material with appropriate friction, or write your own custom solution that would add the platform's speed to the character's speed.</li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec59"></a>There's more...</h3></div></div></div><p>In the provided example, we created our own script for moving the character using a <strong class="userinput"><code>Rigidbody</code></strong> component. You can find the script in the <code class="literal">Shared scripts</code> directory. It is called <code class="literal">SimpleMove.cs</code>. To make your <span>character</span><a id="id325532395" class="indexterm"></a> move:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Add a collider component (we use a <strong class="userinput"><code>Sphere Collider</code></strong> in the example) and a <strong class="userinput"><code>Rigidbody</code></strong> component to it.</li><li>Create a zero friction <code class="literal">Physics Material</code> and assign it to the collider component.</li><li>Set the <strong class="userinput"><code>Rigidbody</code></strong> component <span class="strong"><strong><strong class="userinput"><code>Constraints</code></strong></strong></span> to <span class="strong"><strong><strong class="userinput"><code>Freeze Rotation</code></strong></strong></span> in the <span class="emphasis"><em>X</em></span>, <span class="emphasis"><em>Y</em></span>, and <span class="emphasis"><em>Z</em></span> axes.</li><li>Create an empty game object, position it around 0.2 units above the character's feet, and parent it to the character. Name it <code class="literal"><span>GroundCheck</span></code> for clarity.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Attach the script to the character's game object. Attach the <code class="literal">GroundCheck</code> game object to the <code class="literal">Ground Check Transform</code> field of the <code class="literal">Simple Move</code> script component.</li><li>If you want your character to have an animation, create an Animator Controller with <code class="literal">float Speed</code>, <code class="literal">bool Ground</code>, and <code class="literal">Trigger Jump</code> parameters. Prepare <span>idle</span>, <span>walk,</span> and <span>jump</span> animations. <span>Idle</span> and <span>walk</span> should be looped, <span>jump</span> should end in the air.</li><li>Create a transition <span>between</span><a id="id325532508" class="indexterm"></a> <span>idle</span> and <span>run</span> using the <code class="literal">Speed</code> parameter with the <code class="literal">Speed &gt; 0.1</code> condition.</li><li>Create a transition between <span>run</span> and <span>idle u</span>sing the <code class="literal">Speed</code> parameter with the <code class="literal">Speed &lt; 0.1 </code>condition.</li><li>Create transitions from <span>run</span> and <span>idle</span> to <span>jump</span> using the <code class="literal">Jump</code> trigger parameter.</li><li>Create transitions from <span>jump</span> to <span>run</span> and <span>idle</span> using the <code class="literal">Ground</code> and <code class="literal">Speed</code> parameters. Conditions should check if <code class="literal">Ground</code> is true and if <code class="literal">Speed &lt; 0.1</code> (transition to idle) or <code class="literal">Speed &gt; 0.1</code> (transition to run).</li><li>Attach the Animator Controller to your character.</li><li>Parent the game camera to your character or use the provided <code class="literal">CameraFollow.cs</code> script found in the <span>Shared scripts</span> directory. You can also use one of the camera scripts found in Unity's <span class="strong"><strong>Standard Assets</strong></span><strong class="userinput"><code>.</code></strong></li></ol></div></div></div>