<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec69"></a>Detecting the hit location on a character</h2></div></div><hr /></div><p>Another animation-related topic in combat is the <span>hit location</span><a id="id325241217" class="indexterm"></a> detection. This recipe shows how to easily detect hits to different body parts.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec217"></a>Getting ready</h3></div></div></div><p>We are going to use a simple character with just one looped <strong class="userinput"><code>Idle</code></strong> animation in this recipe. You can also use the provided example Unity project and go to the <code class="literal">Chapter 06 Handling combat\Recipe 10 Detecting the hit location on a character</code> directory. You will find an <code class="literal">Example.unity</code> scene there, with a <strong class="userinput"><code>Humanoid</code></strong> character. Play the game to see the effect.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec218"></a>How to do it...</h3></div></div></div><p>To be able to detect hits for different body parts, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Import your character with all the necessary animations to Unity. Place it on the scene.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Create a new <strong class="userinput"><code>Layer</code></strong> and <span>name</span><a id="id325241282" class="indexterm"></a> it <strong class="userinput"><code>BodyParts</code></strong>. To do so, go to the <strong class="userinput"><code>Layers</code></strong> menu and choose the <strong class="userinput"><code>Edit Layers</code></strong> option, as shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/8d965a82-8279-46b6-8cf1-7b66fd65ba46.png" /></div><p>Adding a new Layer</p><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Create a new script and name it <code class="literal">BodyPart.cs</code>. Create only one <code class="literal">public string bodyPartName</code> variable in this script. We will use it as a dummy script for our body parts. You will be able to implement custom effects of given body part hits in this script layer.</li><li>Create an empty game object and name it <code class="literal">Head</code>.</li><li>Assign the <code class="literal">BodyPart.cs</code> script to the <strong class="userinput"><code>Head</code></strong> game object. Type <code class="literal">Head</code> in the <strong class="userinput"><code>Body Part Name</code></strong> field of the <code class="literal">BodyPart.cs</code> component.</li><li>Assign a <strong class="userinput"><code>Capsule Collider</code></strong> component to the <strong class="userinput"><code>Head</code></strong> game object.</li><li>Set the <strong class="userinput"><code>Head Layer</code></strong> to <strong class="userinput"><code>BodyParts</code></strong>.</li><li>Add a <strong class="userinput"><code>Rigidbody</code></strong> component to the <strong class="userinput"><code>Head</code></strong> game object and set it to <strong class="userinput"><code>Is Kinematic</code></strong>.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Go to the <strong class="userinput"><code>Edit</code></strong> | <strong class="userinput"><code>Project Settings</code></strong> | <strong class="userinput"><code>Physics</code></strong> menu. Unselect the collisions between <strong class="userinput"><code>BodyParts &lt;-&gt; BodyParts</code></strong> Layers and <strong class="userinput"><code>BodyParts &lt;-&gt; Default</code></strong> Layers, as shown in the following screenshot :</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/a069b618-6ab9-408a-a43b-eea4b0c93744.png" /></div><p>Collision matrix for BodyParts layer</p><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>Find the head bone in the character rig's hierarchy. Drag and drop the <strong class="userinput"><code>Head</code></strong> game object onto the head bone to parent it.</li><li>Zero out the <strong class="userinput"><code>Head</code></strong> transform's rotation and position.</li><li>Adjust the <strong class="userinput"><code>Capsule Collider's</code></strong> settings to roughly encapsulate the character's head shape.</li><li>Copy the <strong class="userinput"><code>Head</code></strong> game object and name it <strong class="userinput"><code>Chest</code></strong>. Type <strong class="userinput"><code>Chest</code></strong> in the <strong class="userinput"><code>Body Part Name</code></strong> of the <code class="literal">BodyPart.cs</code> component.</li><li>Drag and drop the <strong class="userinput"><code>Chest</code></strong> game object onto the chest bone in the character rig's hierarchy.</li><li>Zero out the <strong class="userinput"><code>Chest's</code></strong> position and rotation.</li><li>Adjust the <strong class="userinput"><code>Chest's Capsule Collider</code></strong> properties to roughly match the shape of the character's chest.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="17" type="1"><li>Repeat the steps 13 to 16 for all the body parts. In this example, we've created <strong class="userinput"><code>Head</code></strong>, <strong class="userinput"><code>Chest</code></strong>, <strong class="userinput"><code>ArmL</code></strong> (and a copy of it for the forearm), <strong class="userinput"><code>ArmR</code></strong> (and a copy of it for the forearm), <strong class="userinput"><code>LegL</code></strong> (and a copy of it for the shin), <strong class="userinput"><code>LegR</code></strong> (and a copy of it for the shin), and <strong class="userinput"><code>Groin</code></strong>. See the following screenshot for reference:</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/6d3bd821-a5c6-4df8-82fc-f5f640e9144c.png" /></div><p>Body parts encapsulated by colliders</p><div class="orderedlist"><ol class="orderedlist arabic" start="18" type="1"><li>All the body parts will move along with the character. They do not collide with one another or with the <strong class="userinput"><code>Default</code></strong> layer. It prevents the character's physics from behaving in <span>strange</span><a id="id325526785" class="indexterm"></a> ways. You may also need to turn the collisions off for other layers in your game.</li><li>We are going to detect the body part hit with a simple script attached to the camera. Create a new script and name it <code class="literal">Shoot.cs</code>. In this script's <code class="literal">Update()</code> function, we constantly cast a ray from the camera's forward axis. We use the <code class="literal">Physics.Raycast()</code> implementation with the <strong class="userinput"><code>LayerMask</code></strong> parameter. This allows us to hit only those colliders that have the appropriate layer. If <span>we</span><a id="id325535992" class="indexterm"></a> hit such collider, we check if it has the <code class="literal">BodyPart.cs</code> component attached. If so, we set an on-screen UI text to the name of the body part we've hit:</li></ol></div><pre class="programlisting">        Transform cameraTransform = Camera.main.transform; 
 
        if (Physics.Raycast(cameraTransform.position, 
        cameraTransform.forward, out hit, maxDistance, 
        bodyPartsLayer)) 
        { 
            BodyPart p = 
            hit.collider.gameObject.GetComponent&lt;BodyPart&gt;(); 
            if (p != null) 
            { 
                bodyPartText.text = "Hit body part: " + 
               p.bodyPartName; 
            } 
            else 
            { 
                bodyPartText.text = "No body part was hit"; 
            } 
        } 
        else 
        { 
            bodyPartText.text = "No body part was hit"; 
        } </pre><div class="orderedlist"><ol class="orderedlist arabic" start="20" type="1"><li>Attach the script to the camera.</li><li>Create a <strong class="userinput"><code>UI Text</code></strong> in the scene and attach it to the <code class="literal">BodyPart.cs</code> component's <strong class="userinput"><code>Body Part Text</code></strong> field.</li><li>Set the <strong class="userinput"><code>Body Parts Layer</code></strong> layer mask in the <code class="literal">BodyPart.cs</code> component to <strong class="userinput"><code>BodyParts</code></strong>.</li><li>Attach any free look script to the camera; you can also use the <code class="literal">CameraLook.cs</code> script from the <code class="literal">Shared Scripts</code> folder.</li><li>Play the game to see the effect.</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec219"></a>How it works...</h3></div></div></div><p>We are using the Unity's <strong class="userinput"><code><span>Hierarch</span><a id="id325544905" class="indexterm"></a>y</code></strong> to attach colliders to the bones in the character's rig. This way we can check collisions with those body parts and react to them via scripts. To make this recipe simple, we only display the hit body part's name on the UI, but you can easily implement complex reactions to certain body part hits. For instance, you could implement additional damage for head shots or even a sophisticated wound system.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec220"></a>There's more...</h3></div></div></div><p>We've covered hit detection using the <code class="literal">Physics.Raycast()</code> method, which is good for targeting body parts or fast moving projectiles. But you can just as easily implement body part detection in melee combat. All you need to do is to implement the <code class="literal">void OnCollisionEnter(Collision collision)</code> method in either the <code class="literal">BodyPart.cs</code> script or a new script attached to the weapon (it needs to have a <strong class="userinput"><code>Collider</code></strong> and a <strong class="userinput"><code>Rigid Body</code></strong> component set to <strong class="userinput"><code>Is Kinematic</code></strong>). You would then have to check if the entering collision object has a proper script or tag attached to determine whether you hit a body part.</p></div></div>