<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec68"></a>Using Blend Trees to aim</h2></div></div><hr /></div><p>In this recipe, we will use a <span>more</span><a id="id325241278" class="indexterm"></a> sophisticated method of aiming. This method is based on using several aim animations combined into a Blend Tree.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec213"></a>Getting ready</h3></div></div></div><p>We are going to use the same assets as in the previous recipe, but instead of using the <code class="literal">CharacterLookAt.cs</code> script, we will use additional animations: <strong class="userinput"><code>AimForward</code></strong>, <strong class="userinput"><code>AimForwardUp</code></strong> (aim 45 degrees up), <strong class="userinput"><code>AimForwardDown</code></strong> (45 degrees down), <strong class="userinput"><code>AimLeft</code></strong> (45 degrees left), <strong class="userinput"><code>AimLeftUp</code></strong> (45 degrees left and 45 degrees up), <strong class="userinput"><code>Aim LeftDown</code></strong> (45 degrees left and 45 degrees down), <strong class="userinput"><code>AimRight</code></strong> (45 degrees right), <strong class="userinput"><code>AimRightDown</code></strong> (45 degrees right and 45 degrees down), <strong class="userinput"><code>AimRightUp</code></strong> (45 degrees right and 45 degrees up). See the following screenshot for reference:</p><div class="mediaobject"><img src="/graphics/9781785883910/graphics/46754d3a-cf2b-4c8e-80c2-b7f37162bf57.png" /></div><p>Nine directional aim animations</p><p>You can also use the provided example Unity project and go to the <code class="literal">Chapter 06 Handling combat\Recipe 09 Using blend trees to aim</code> directory. You will find an <code class="literal">Example.unity</code> scene there, with a <strong class="userinput"><code>Humanoid</code></strong> character. Play the game to see the effect. You can find all the necessary animations in the <code class="literal">Rigs</code> directory.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec214"></a>How to do it...</h3></div></div></div><p>To use the <strong class="userinput"><code>Blend Trees</code></strong> methods for aiming, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Import your character with all the necessary animations to Unity and place it on the <strong class="userinput"><code>Scene</code></strong>.</li><li>Follow the <span class="emphasis"><em>Using Avatar Masks and animator controller layers to walk and aim</em></span> recipe to make the character walk and aim.</li><li>Open the controller and go to the <strong class="userinput"><code>Aim Layer</code></strong>.</li><li>Delete the <strong class="userinput"><code>AimForward</code></strong> state and create a new <strong class="userinput"><code>Blend Tree</code></strong>.</li><li>Create two float parameters: <strong class="userinput"><code>AimVer</code></strong> and <strong class="userinput"><code>AimHor</code></strong>.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Set the <strong class="userinput"><code>Blend Type</code></strong> to <strong class="userinput"><code>Freeform Cartesian</code></strong>.</li><li>Set the first parameter of the <strong class="userinput"><code>Blend Tree</code></strong> to <strong class="userinput"><code>AimHor</code></strong> and the second one to <strong class="userinput"><code>AimVer</code></strong>.</li><li>Create nine <strong class="userinput"><code>Motion Fields</code></strong> in the <strong class="userinput"><code>Blend Tree</code></strong> and assign all the aim animations to them.</li><li>Set the <strong class="userinput"><code>Motion Fields</code></strong> as follows (also see the following screenshot for reference):
<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>AimLeftDown</code></strong><strong class="userinput"><code>Pos X</code></strong> set to -45, <strong class="userinput"><code>Pos Y</code></strong> set to -45</li><li style="list-style-type: disc"><strong class="userinput"><code>AimLeft</code></strong><strong class="userinput"><code>Pos X</code></strong> set to -45, <strong class="userinput"><code>Pos Y</code></strong> set to 0</li><li style="list-style-type: disc"><strong class="userinput"><code>AimLeftUp</code></strong><strong class="userinput"><code>Pos X</code></strong> set to -45, <strong class="userinput"><code>Pos Y</code></strong> set to 45</li><li style="list-style-type: disc"><strong class="userinput"><code>AimForwardDown</code></strong><strong class="userinput"><code>Pos X</code></strong> set to 0, <strong class="userinput"><code>Pos Y</code></strong> set to -45</li><li style="list-style-type: disc"><strong class="userinput"><code>AimForward</code></strong><strong class="userinput"><code>Pos X</code></strong> set to 0, <strong class="userinput"><code>Pos Y</code></strong> set to 0</li><li style="list-style-type: disc"><strong class="userinput"><code>AimForwardUp</code></strong><strong class="userinput"><code>Pos X</code></strong> set to 0, <strong class="userinput"><code>Pos Y</code></strong> set to 45</li><li style="list-style-type: disc"><strong class="userinput"><code>AimRightDown</code></strong><strong class="userinput"><code>Pos X</code></strong> set to 45, <strong class="userinput"><code>Pos Y</code></strong> set to -45</li><li style="list-style-type: disc"><strong class="userinput"><code>AimRight</code></strong><strong class="userinput"><code>Pos X</code></strong> set to 45, <strong class="userinput"><code>Pos Y</code></strong> set to 0</li><li style="list-style-type: disc"><strong class="userinput"><code>AimRightUp</code></strong><strong class="userinput"><code>Pos X</code></strong> set to 45, <strong class="userinput"><code>Pos Y</code></strong> set to 45</li></ul></div></li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/253313ba-09da-4b2a-8bab-32b9c31f6557.png" /></div><p>Aim Blend Tree settings</p><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>Create a new <strong class="userinput"><code>Sphere</code></strong> object and name it <strong class="userinput"><code>AimTarget</code></strong>.</li><li>Make <strong class="userinput"><code>AimTarget</code></strong> a child of the <strong class="userinput"><code>Main Camera</code></strong> game object. We are using the same <code class="literal">CameraLook.cs</code> script in this recipe. You can find the script in the <code class="literal">Shared Scripts</code> folder in the provided example Unity project.</li><li>Offset the <strong class="userinput"><code>AimTarget</code></strong> position in its local <span class="emphasis"><em>Z</em></span> axis by around 20 units.</li><li>Create a new script and call it <code class="literal">AimWithBlendTree.cs</code>. In the <code class="literal">Update()</code> function of this script, we first calculate the <code class="literal">aimVector</code>. This is a vector from a helper <code class="literal">aimNode</code> transform to the <code class="literal">target</code> transform. Then we use this vector to calculate a <code class="literal">horAimVector</code>, a horizontal vector for aiming. Then we use the <code class="literal">horAimVector</code> to calculate the <code class="literal">aimHor</code> angle. We use the <code class="literal">Vector3.Angle()</code> method to find the angle between the <code class="literal">horAimVector</code> and <code class="literal">transform.forward</code> axis and <code class="literal">Mathf.Sign()</code> with <code class="literal">Vector3.Dot()</code> to determine the sign of the angle. We calculate the <code class="literal">aimVer</code> angle in a similar way, but we use the <code class="literal">horAimVector</code> instead of the <code class="literal">transform.forward</code> axis. Lastly, we assign the <strong class="userinput"><code>AimVer</code></strong> and <strong class="userinput"><code>AimHor</code></strong> parameters in the controller:</li></ol></div><pre class="programlisting">        aimVector = target.position - aimNode.position; 
 
        horAimVector = aimVector; 
        horAimVector.y = 0f; 
 
        aimHor = Vector3.Angle(horAimVector, transform.forward) *         Mathf.Sign(Vector3.Dot(horAimVector, transform.right)); 
 
        aimVer = Vector3.Angle(horAimVector, aimVector) * 
        Mathf.Sign(Vector3.Dot(aimVector, Vector3.up)); 
 
        anim.SetFloat("AimHor", aimHor, aimSmooth, Time.deltaTime); 
        anim.SetFloat("AimVer", aimVer, aimSmooth, Time.deltaTime); </pre><div class="orderedlist"><ol class="orderedlist arabic" start="14" type="1"><li>Assign the script to the character. Drag and drop the <strong class="userinput"><code>AimTarget</code></strong> transform to the <strong class="userinput"><code>Target</code></strong> field of the script.</li><li>Create an empty game object and name it <strong class="userinput"><code>AimNode</code></strong>. Place it roughly where the chest of the character is and make it a child of the character's transform.</li><li>Assign the <strong class="userinput"><code>AimNode</code></strong> transform to the <strong class="userinput"><code>Aim Node</code></strong> field of the script. You can use the <strong class="userinput"><code>AimNode</code></strong> to adjust the <code class="literal">aimVector</code> calculation.</li><li>Play the game to see the effect.</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec215"></a>How it works...</h3></div></div></div><p>We are using a similar principle as used in the <span class="emphasis"><em>Using root motion to create flying characters</em></span> recipe in <span><a class="link" href="#" linkend="ch04">Chapter 4</a></span>, <span class="emphasis"><em>Character Movement</em></span>. Our script calculates the angles between our target and our character's forward axis. Then it assigns those angles as parameters in the controller. The <span>Blend Tree</span><a id="id325241542" class="indexterm"></a> uses those parameters to blend between nine directional aim animations.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec216"></a>There's more...</h3></div></div></div><p>You can further develop this recipe with additional animations to handle more extreme angles. You can even have animations targeting +180 and -180 degrees in horizontal angles. This would make your character aim in every possible direction.</p></div></div>