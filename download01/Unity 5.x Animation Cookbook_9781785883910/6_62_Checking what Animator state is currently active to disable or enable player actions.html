<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec64"></a>Checking what Animator state is currently active to disable or enable player actions</h2></div></div><hr /></div><p>There are situations when we need to block or allow certain actions depending on the currently played animation. This recipe describes how to easily check what animation is currently being played.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec198"></a>Getting ready</h3></div></div></div><p>We are going to use the same <strong class="userinput"><code>Spider</code></strong> character from the previous recipe. It has <strong class="userinput"><code>SpiderIdle</code></strong>, <strong class="userinput"><code>Dodge</code></strong>, <strong class="userinput"><code>HitReaction</code></strong>, and <strong class="userinput"><code>Death</code></strong> animations. You can open the provided example project and go to the <code class="literal">Chapter 06 Handling combat\Recipe 05 Checking what animator state is currently active to disable or enable player actions</code> directory. There is a <strong class="userinput"><code>Spider</code></strong> character in the <code class="literal">Example.unity</code> scene. When you press the <span class="emphasis"><em>H</em></span> key, it will start a healing action, only when in <strong class="userinput"><code>SpiderIdle</code></strong> state. You can find all the necessary animations in the <code class="literal">Chapter 06 Handling combat\Recipe 02 Using animation events to trigger script functions\Rigs</code> directory.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec199"></a>How to do it...</h3></div></div></div><p>To check which <span>Animator state</span><a id="id325509764" class="indexterm"></a> is currently active, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Import the character to Unity.</li><li>Create an Animator Controller for it or use an existing one.</li><li>If you want your character to react to hits, follow the <span class="emphasis"><em>Using transitions from Any State to play hit reactions</em></span> recipe.</li><li>In this recipe, we are going to use the healing action as an example. Create a new script and call it <code class="literal">Healing.cs</code>. In this script's <code class="literal">Update()</code> function, first we check if player pressed the <span class="emphasis"><em>H</em></span> key. Then we check if our character is playing in the proper <strong class="userinput"><code>Animator</code></strong> state and saved in the <code class="literal">public string</code><code class="literal">healingAllowedState</code> variable. We also check if a healing action is not active because we don't want to stack healing actions. If all these conditions are met, we start a healing coroutine:</li></ol></div><pre class="programlisting">        if (Input.GetKeyDown(KeyCode.H)) 
        { 
            if (anim.GetCurrentAnimatorStateInfo(0).IsName(         
        healingAllowedState)) 
            { 
                if (!isHealing) 
                { 
                    StartCoroutine("Heal"); 
                } 
            } 
        } </pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>The <code class="literal">IEnumarator Heal()</code> coroutine is responsible for increasing our Spider's <code class="literal">hitPoints</code> in time:</li></ol></div><pre class="programlisting">        isHealing = true; 
        Enemy enemyScript = GetComponent&lt;Enemy&gt;(); 
 
        while (enemyScript.hitPoints &lt; 
        (float)enemyScript.initialHitPoints) 
        { 
            enemyScript.hitPoints += healingSpeed * Time.deltaTime; 
            yield return null; 
        } 
 
        enemyScript.hitPoints = enemyScript.initialHitPoints; 
        isHealing = false; </pre><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Assign the script to the <strong class="userinput"><code>Spider</code></strong> character.</li><li>Play the game and press the <span class="emphasis"><em>H</em></span> key to start the healing action. Our character needs to be in the <strong class="userinput"><code>SpiderIdle</code></strong> state (the <code class="literal">public string healinAllowedState</code> is set to <code class="literal">Base Layer.SpiderIdle</code> in the <strong class="userinput"><code>Inspector</code></strong>).</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec200"></a>How it works...</h3></div></div></div><p>To check the <strong class="userinput"><code>Animator</code></strong> state our character is currently in, we first use the <code class="literal">GetCurrentAnimatorStateInfo(int layerIndex)</code> function to get the state the character's Animator is in. We need to call this function on the Animator component; thus, we need to have a variable storing a reference to it (<code class="literal">anim</code> in our example). Then we call the <code class="literal">IsName(string name)</code> function on the state we got from the <code class="literal">GetCurrentAnimatorStateInfo(int layerIndex)</code> function. The <code class="literal">IsName(string name)</code> function compares the Animator state name to the <code class="literal">name</code> we put as the parameter.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note14"></a>Note</h3><p>We need to specify the full name of the state. This name needs to be in this format: <code class="literal">&lt;Layer Name&gt;.&lt;State Name&gt;</code>. For instance, our <strong class="userinput"><code>SpiderIdle</code></strong> state is in the <strong class="userinput"><code>Base Layer</code></strong>, so we need to put <code class="literal">Base Layer.SpiderIdle</code> as the name parameter in the <code class="literal">IsName()</code> function.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec201"></a>There's more...</h3></div></div></div><p>Sometimes we need to check not only the current state of the <strong class="userinput"><code>Animator</code></strong> but also a specified moment in it. Let's assume we have a 2-second long jump attack animation. Our character starts the jump in the first second of the animation, and then it jumps and lands on the ground with a strike at the end of the animation. We may want to allow players to break the animation when the character is still on the ground (for instance, with a dodge animation). To do so, we may use <strong class="userinput"><code>Animation Curves</code></strong> to set an <strong class="userinput"><code>AllowBreak </code></strong><code class="literal">float</code> parameter (you can choose a different name) in the controller and check this parameter value while trying to perform actions or transition to other states. <strong class="userinput"><code>Animation Curves</code></strong> are described in the <span class="emphasis"><em>Using animations for better looking transitions</em></span> recipe in <span><a class="link" href="#" linkend="ch04">Chapter 4</a></span>, <span class="emphasis"><em>Character Movement</em></span>.</p></div></div>