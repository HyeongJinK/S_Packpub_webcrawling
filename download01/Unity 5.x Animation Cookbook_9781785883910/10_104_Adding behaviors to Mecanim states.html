<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec102"></a>Adding behaviors to Mecanim states</h2></div></div><hr /></div><p>In this last recipe, we will cover behaviors. These are scripts that can be attached to <span>Mecanim states</span><a id="id325241347" class="indexterm"></a>. You can use them to turn standard Animator Controllers into logic graphs such as AI trees, quests, and so on.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec319"></a>Getting ready</h3></div></div></div><p>We are going to create this recipe from scratch and we don't need any special assets. You can download the example project and go to the <code class="literal">Chapter 10 Miscellaneous\Recipe 05 Adding behaviors to Mecanim states</code> directory. Open the <code class="literal">Example.unity</code> scene there and play the game. If you play the game, you can press the space bar to change the states in the <strong class="userinput"><code>Animator Controller</code></strong> attached to the <strong class="userinput"><code>Controller</code></strong> game object. The cycle starts in the <strong class="userinput"><code>NoBehaviors</code></strong> state—this is simply an empty state with no additional behavior. If we press the space bar, we transition to <strong class="userinput"><code>Light1Random</code></strong>. This state changes the color of the <strong class="userinput"><code>Light1</code></strong> light in the scene. If we press the space bar again, the state will change to <strong class="userinput"><code>WaitAndSwitch</code></strong>. This state waits for a given time and switches to the next state: <strong class="userinput"><code>Light2Random</code></strong>. This one changes the color of the <strong class="userinput"><code>Light2</code></strong> light. If we press the space bar again, we will transition to the <strong class="userinput"><code>RotateObject</code></strong> state, which rotates an object visible in the scene. Pressing the space bar yet again transitions the controller to the <strong class="userinput"><code>Light1Random</code></strong> state again. See the following screenshot for reference:</p><p> </p><div class="mediaobject"><img src="/graphics/9781785883910/graphics/33e103eb-46fc-4d7f-8182-f28aa5eb4bca.png" /></div><p>Finished controller</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec320"></a>How to do it...</h3></div></div></div><p>To use behaviors with <span>Mecanim states</span><a id="id325242090" class="indexterm"></a>, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>First we need to prepare the example scene. Create a <strong class="userinput"><code>Cube</code></strong> in the scene.</li><li>Create two lights and name them <strong class="userinput"><code>Light1</code></strong> and <strong class="userinput"><code>Light2</code></strong>. Place them near the cube so you can see their effect.</li><li>Create an empty game object and name it <code class="literal">Controller</code>.</li><li>Create a new Animator Controller and name it <code class="literal">LogicController</code>.</li><li>Add an Animator component to the <strong class="userinput"><code>Controller</code></strong> game object and assign the <strong class="userinput"><code>LogicController</code></strong> to it.</li><li>Open the <strong class="userinput"><code>LogicController</code></strong>.</li><li>Create an empty state and name it <strong class="userinput"><code>NoBehaviors</code></strong>. Make it the default state.</li><li>Create a <code class="literal">Trigger</code> parameter and name it <strong class="userinput"><code>Switch</code></strong>.</li><li>Create four empty states and name them <strong class="userinput"><code>Light1Random</code></strong>, <strong class="userinput"><code>WaitAndSwitch</code></strong>, <strong class="userinput"><code>Light2Random</code></strong>, and <strong class="userinput"><code>RotateObject</code></strong>.</li></ol></div><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>Create the following listed transitions. All of them have the same condition: <code class="literal">Trigger </code><strong class="userinput"><code>Switch</code></strong> parameter and <strong class="userinput"><code>Has Exit Time</code></strong> set to false.
<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>NoBehaviors</code></strong> | <strong class="userinput"><code>Light1Random</code></strong></li><li style="list-style-type: disc"><strong class="userinput"><code>Light1Random</code></strong> | <strong class="userinput"><code>WaitAndSwitch</code></strong></li><li style="list-style-type: disc"><strong class="userinput"><code>WaitAndSwitch</code></strong> | <strong class="userinput"><code>Light2Random</code></strong></li><li style="list-style-type: disc"><strong class="userinput"><code>Light2Random</code></strong> | <strong class="userinput"><code>RotateObject</code></strong></li><li style="list-style-type: disc"><strong class="userinput"><code>RotateObject</code></strong> | <strong class="userinput"><code>Light1Random</code></strong></li></ul></div></li><li>Select the <strong class="userinput"><code>Light1Random</code></strong> state and click the <strong class="userinput"><code>Add Behaviour</code></strong> button in the <strong class="userinput"><code>Inspector</code></strong>, as shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/67878361-d061-4d83-9a34-3bb992c808f0.png" /></div><p>Adding a behavior to a Mecanim state</p><div class="orderedlist"><ol class="orderedlist arabic" start="12" type="1"><li>A list with all the <span>available</span><a id="id325526797" class="indexterm"></a> behaviors will appear. Type <strong class="userinput"><code>LightColorChange</code></strong> in the search field and press <span class="emphasis"><em><span class="strong"><strong>Enter</strong></span></em></span>. A <strong class="userinput"><code>Create and add</code></strong> button will appear. If you click on it, the <code class="literal">LightColorChange.cs</code> script will be created in the <code class="literal">Assets</code> folder.</li><li>Move the script to your script's destination folder.</li><li>Open the script. Add three global variables to the script: <code class="literal">public string lightGameObjectName</code>, <code class="literal">public Color color</code>, and <code class="literal">public bool randomColor</code>.</li></ol></div><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="15" type="1"><li>The script contains several commented out functions. Uncomment the <code class="literal">override public void OnStateEnter()</code> function. In it we first try to find the game object whose name we store in the <code class="literal">lightGameObjectName</code> variable. If we find it, we try to get its <strong class="userinput"><code>Light</code></strong> component and set the light color to a random value or to a specified value, depending on the <code class="literal">randomColor</code> flag:</li></ol></div><pre class="programlisting">      GameObject go = GameObject.Find(lightGameObjectName); 
      if (go != null) 
      { 
          Light light = go.GetComponent&lt;Light&gt;(); 
          if (light != null) 
          { 
              if (randomColor) 
              { 
                  light.color = Random.ColorHSV(); 
              } 
              else 
              { 
                  light.color = color; 
              } 
          } 
      } </pre><div class="orderedlist"><ol class="orderedlist arabic" start="16" type="1"><li>In the <strong class="userinput"><code>Animator Controller</code></strong>, select the <strong class="userinput"><code>Light1Random</code></strong> state. In its <strong class="userinput"><code>Inspector</code></strong>, set the <strong class="userinput"><code>Light Game Object Name</code></strong> to <strong class="userinput"><code>Light1</code></strong> and check the <strong class="userinput"><code>Random Color</code></strong> checkbox.</li><li>Select the <strong class="userinput"><code>WaitAndSwitch</code></strong> state and add a <code class="literal">WaitAndSwitch</code> behavior. The <code class="literal">WaitAndSwitch.cs</code> script will be created. This time add four global variables (with default values): <code class="literal">public string triggerName = "Switch"</code>, <code class="literal">public float waitTime = 5f</code>, <code class="literal">bool switched = false</code>, and <code class="literal">float startTime</code>. Uncomment the <code class="literal">override public void OnStateEnter()</code>function, check the time we've entered the state in, and store it in the <code class="literal">startTime</code> variable. We also set the <code class="literal">switched</code> flag to <code class="literal">false</code>:</li></ol></div><pre class="programlisting">      startTime = Time.time; 
      switched = false; </pre><div class="orderedlist"><ol class="orderedlist arabic" start="18" type="1"><li>Uncomment the <code class="literal">override public void OnStateUpdate()</code> function and check whether the <span>current</span><a id="id325550902" class="indexterm"></a> time is greater than our <code class="literal">startTime</code> plus <code class="literal">waitTime</code>. If so, we set the <code class="literal">Trigger</code> to transition between states. We also set the <code class="literal">switched</code> flag to <code class="literal">true</code> to prevent sending multiple <code class="literal">Triggers</code>:</li></ol></div><pre class="programlisting">      if (Time.time &gt;= startTime + waitTime &amp;&amp; !switched) 
      { 
          switched = true; 
          animator.SetTrigger(triggerName); 
      } </pre><div class="orderedlist"><ol class="orderedlist arabic" start="19" type="1"><li>Select the <strong class="userinput"><code>Light2Random</code></strong> state in the controller and add the <code class="literal">LightColorChange.cs</code> behavior to it. Set the <strong class="userinput"><code>Random Color</code></strong> checkbox to true and the <strong class="userinput"><code>Light Game Object Name</code></strong> to <strong class="userinput"><code>Light2</code></strong>.</li><li>Create a new C# script and call it <code class="literal">LogicController.cs</code>. This script has three global variables: <code class="literal">public string switchTriggerName = "Switch"</code>, <code class="literal">public Transform activeObject</code>, and <code class="literal">Animator anim</code>. The <code class="literal">anim</code> variable is set in the <code class="literal">Start()</code> function. In the <code class="literal">Update()</code> function of this script, we set the <code class="literal">Trigger</code> in the Animator Controller when the player presses the space bar. The <code class="literal">Trigger</code> name is stored in the <code class="literal">switchTriggerName</code> variable.</li><li>Assign the script to the <strong class="userinput"><code>Controller</code></strong> game object. Then drag and drop the <strong class="userinput"><code>Cube</code></strong> game object to the <strong class="userinput"><code>Active Object</code></strong> field of the script.</li><li>Select the <strong class="userinput"><code>RotateObject</code></strong> state and add a <code class="literal">RotateObject.cs</code> behavior to it (you need to create a new one). Move the created script to your destination folder.</li><li>Open the <code class="literal">RotateObject.cs</code> script. Add four global variables: <code class="literal">public float rotationSpeed = 45f</code>, <code class="literal">public Vector3 rotationAxis = Vector3.up</code>, <code class="literal">public Space rotationSpace = Space.World</code>, and <code class="literal">LogicController controller</code>. The first three are used to rotate the object and the last one is a reference to the <code class="literal">LogicController</code> script. Uncomment the <code class="literal">override public void OnStateEnter()</code>function and set the reference to the <code class="literal">LogicController</code> in it:</li></ol></div><pre class="programlisting">      controller = 
      animator.gameObject.GetComponent&lt;LogicController&gt;(); </pre><div class="orderedlist"><ol class="orderedlist arabic" start="24" type="1"><li>Uncomment the <code class="literal">override public void OnStateUpdate()</code> function and rotate the object that is stored in the <code class="literal">LogicController.activeObject</code> variable:</li></ol></div><pre class="programlisting">      if (controller == null) 
      { 
          return; 
      } 
      if (controller.activeObject == null) 
      { 
          return; 
      } 
      controller.activeObject.Rotate(rotationAxis * rotationSpeed *        Time.deltaTime, rotationSpace); </pre><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="25" type="1"><li>Make sure the Animator component of the <strong class="userinput"><code>Controller</code></strong> game object is set to <strong class="userinput"><code>Always Animate</code></strong>.</li><li>Play the game and press the space bar to see the effect. You will need to press the space bar several times to go through the whole cycle.</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec321"></a>How it works...</h3></div></div></div><p>State behaviors can be used to create logic graphs—these graphs use Animator Controller as a state machine. Animator Controller can work without any Animation Clips—empty states can have behaviors as well.</p><p>Mecanim state <span>behaviors</span><a id="id325241070" class="indexterm"></a> are scripts that derive from the <code class="literal">StateMachineBehavior</code> class instead of the <code class="literal">MonoBehavior</code> class. They have a number of functions we can override. The most useful ones are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">OnStateEnter()</code>: This function is called when the Animator Controller enters this state.</li><li style="list-style-type: disc"><code class="literal">OnStateUpdate()</code>: This function is called every frame when this state is active (is playing). It will be called after <code class="literal">OnStateEnter()</code> and before <code class="literal">OnStateExit()</code>.</li><li style="list-style-type: disc"><code class="literal">OnStateExit()</code>: This function is called when the Animator Controller exits this state.</li></ul></div><p>We can still manage the state transitions from a normal <code class="literal">MonoBehavior</code> script (in our example, it is the <code class="literal">LogicController.cs</code> script).</p><p>Animator Controllers are assets, so they cannot reference objects in the scene. We can work around this by either finding the game objects by name (or tag) or by creating another <code class="literal">MonoBehavior</code> script that can reference objects in the scene. Our <code class="literal">LogicController.cs</code> script has an example of this: the <code class="literal">public Transform activeObject</code> variable. We can get the <code class="literal">LogicController.cs</code> script component in the behavior (as long as the Animator component is on the same game object). This way we can get to its <code class="literal">activeObject</code> variable and do an action on this transform.</p></div></div>