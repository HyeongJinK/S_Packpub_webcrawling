<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec52"></a>Creating background characters and critters with animation-driven behavior</h2></div></div><hr /></div><p>In this recipe, we are <span>going</span><a id="id325241268" class="indexterm"></a> to <span>create</span><a id="id325289092" class="indexterm"></a><span>animated</span><a id="id325289099" class="indexterm"></a> characters that will serve as decorations in the game. Such characters' behavior is driven only by animations; thus, we can have quite a large number of them in the game.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec155"></a>Getting ready</h3></div></div></div><p>Before we start, we need to have a character with a few animations. In this example, we are using a bird. It has <strong class="userinput"><code>Idle</code></strong>, <strong class="userinput"><code>StartFlying</code></strong>, <strong class="userinput"><code>FlyingInCircles</code></strong>, and <strong class="userinput"><code>Land</code></strong> animations. The <strong class="userinput"><code>Idle</code></strong> animation is looped and played when our birds sits on the ground. The <strong class="userinput"><code>StartFlying</code></strong> animation is a transition between <strong class="userinput"><code>Idle</code></strong> and <strong class="userinput"><code>FlyingInCircles</code></strong>, which is a looped animation of the bird flying around. The last animation, the <strong class="userinput"><code>Land</code></strong> animation, is a transition between <strong class="userinput"><code>FlyingInCircles</code></strong> and <strong class="userinput"><code>Idle</code></strong>. We don't use root motion for those animations because we want the birds to always land in the same position (we don't want to check where the ground is, it's just a decoration).</p><p>You can also download the provided example Unity project and go to the <code class="literal">Chapter 05 Character actions and expressions\Recipe 02 Creating background characters and critters with animation driven behavior</code> directory. You will find a scene called <code class="literal">Example.scene</code> there, with some birds sitting around. If you press the space bar, the birds will start flying. If you press it again, they will land. In the <code class="literal">Rigs</code> directory, you can find the <code class="literal">Bird.fbx</code> character with all required animations.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec156"></a>How to do it...</h3></div></div></div><p>To <span>create</span><a id="id325509757" class="indexterm"></a> lightweight <span>background characters</span><a id="id325509766" class="indexterm"></a> with <span>animation-driven behaviors</span><a id="id325509813" class="indexterm"></a>, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Import your character (a bird with <strong class="userinput"><code>Idle</code></strong>, <strong class="userinput"><code>StartFlying</code></strong>, <strong class="userinput"><code>FlyingInCircles</code></strong>, and <strong class="userinput"><code>Land</code></strong> animations) to Unity.</li><li>Create a new Animator Controller.</li><li>Drag and drop the <strong class="userinput"><code>Idle</code></strong>, <strong class="userinput"><code>StartFlying</code></strong>, <strong class="userinput"><code>FlyingInCircles</code></strong>, and <strong class="userinput"><code>Land</code></strong> animations into the controller.</li><li>Create a <code class="literal">bool </code><strong class="userinput"><code>Fly</code></strong> parameter. We will use it later to make the birds start flying.</li><li>Create four transitions:
<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Idle</code></strong> | <strong class="userinput"><code>Start Flying</code></strong> with the conditions: <strong class="userinput"><code>Fly</code></strong> parameter should be set to true, <strong class="userinput"><code>Has Exit Time</code></strong> set to false, and <strong class="userinput"><code>Transition Duration</code></strong> set to 0.2 seconds.</li><li style="list-style-type: disc"><strong class="userinput"><code>StartFlying</code></strong> | <strong class="userinput"><code>FlyingInCircles </code></strong>with no conditions: <strong class="userinput"><code>Has Exit Time</code></strong> should be set to true and <strong class="userinput"><code>Transition Duration</code></strong> set to 0.2 seconds.</li><li style="list-style-type: disc"><strong class="userinput"><code>FlyingInCircles</code></strong> | <strong class="userinput"><code>Land </code></strong>with one condition: <strong class="userinput"><code>Fly</code></strong> parameter should be set to false, <strong class="userinput"><code>Has Exit Time</code></strong> set to true, and <strong class="userinput"><code>Transition Duration</code></strong> set to 0.2 seconds. We need to set <strong class="userinput"><code>Has Exit Time</code></strong> to true in this case because our <strong class="userinput"><code>Land</code></strong> animation starts from the last frame of the <strong class="userinput"><code>FlyingInCircles</code></strong> animation.</li><li style="list-style-type: disc"><strong class="userinput"><code>Land</code></strong> | <strong class="userinput"><code>Idle</code></strong> with no conditions: <strong class="userinput"><code>Has Exit Time</code></strong> set to true and <strong class="userinput"><code>Transition Duration</code></strong> set to 0.2 seconds.</li></ul></div></li><li>Place our character in the scene and assign the controller to its Animator component.</li><li>Add a <code class="literal">Bird</code> tag to the character. We will use the tag in the following script.</li><li>Create a new script and call it <code class="literal">FlockDecoration.cs</code>.</li><li>In this script, we first find all the game objects with the <code class="literal">Bird</code> tag and store them in the <code class="literal">GameObject[] birds</code> array. We do it in the <code class="literal">Start()</code> function. In the <code class="literal">Update()</code> function, when the player presses the space bar, we set the <code class="literal">bool </code><strong class="userinput"><code>Fly</code></strong> parameter in our controller to its inverted value (if it was true, we set it to false, and vice versa). We do it for every bird stored in the <code class="literal">birds</code> array:</li></ol></div><pre class="programlisting">        for (int i = 0; i &lt; birds.Length; i++) 

        { 

            Animator anim = birds[i].GetComponent&lt;Animator&gt;(); 
            anim.SetBool("Fly", !anim.GetBool("Fly")); 
        }  </pre><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>Assign the script to an empty game object in the scene. Play the game and press the space bar to see the effect. You can also duplicate the <strong class="userinput"><code>Bird</code></strong> game object several times.</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec157"></a>How it works...</h3></div></div></div><p>This recipe uses the Animator Controller to create states for the character. Our bird can sit on the ground and fly. We also have transition animations between those two looped states to make the bird start flying or land. With this simple setup, we can create birds that will react to the player. They can, for instance, start flying when player is near and land if player walks away. The purpose of this recipe is to show that we can create interesting behavior with just the animations alone (and one script to call the animations). Animated game objects that have no scripts and no rigid bodies attached are quite lightweight in Unity. That allows us to use them as interesting decorations.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec158"></a>There's more...</h3></div></div></div><p>In the <code class="literal">FlockDecoration.cs</code> script, we also try to desynchronize the animations of our birds. We do it in the <code class="literal">Start()</code> function for every bird by setting the <code class="literal">speed</code> variable in its <code class="literal">Animator</code> to a random number:</p><pre class="programlisting">        for (int i = 0; i &lt; birds.Length; i++) 
        { 
            Animator anim = birds[i].GetComponent&lt;Animator&gt;(); 
            anim.speed = Random.Range(0.8f, 1.3f); 
        } </pre><p>That makes the <span>birds</span><a id="id325241380" class="indexterm"></a> play <span>their</span><a id="id325241388" class="indexterm"></a><span>animations</span><a id="id325241396" class="indexterm"></a> with randomized playback speed. We could randomize it further by creating multiple versions of <strong class="userinput"><code>FlyInCircles</code></strong> and <strong class="userinput"><code>Idle</code></strong> animations. Then we would have to randomly choose currently played animation (see the next recipe for details).</p><p>In the <strong class="userinput"><code>Import </code></strong>settings of our FBX file, in the <strong class="userinput"><code>Rig</code></strong> tab, we also checked the <strong class="userinput"><code>Optimize Game Objects</code></strong> option. This makes our rig hierarchy (bones) invisible in the <strong class="userinput"><code>Hierarchy</code></strong> and reduces the number of game objects Unity has to handle.</p></div></div>