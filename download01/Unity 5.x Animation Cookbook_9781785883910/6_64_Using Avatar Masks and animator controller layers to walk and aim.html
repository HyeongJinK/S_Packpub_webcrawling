<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec66"></a>Using Avatar Masks and animator controller layers to walk and aim</h2></div></div><hr /></div><p>This recipe shows how to use <span>Avatar Masks</span><a id="id325241278" class="indexterm"></a> and Layers in the Animator Controller to play animations on certain body parts. In combat, it can be useful for playing aim animations on the upper body and movement animations on the lower body.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec205"></a>Getting ready</h3></div></div></div><p>In this recipe, we are using <strong class="userinput"><code>WalkForward</code></strong>, <strong class="userinput"><code>WalkLeft</code></strong>, <strong class="userinput"><code>WalkRight</code></strong>, and <strong class="userinput"><code>Idle</code></strong> animations, and a looped <strong class="userinput"><code>AimForward</code></strong> animation. The first four animations are covered in the <span class="emphasis"><em>Using root motion to steer a character</em></span> recipe in <span><a class="link" href="#" linkend="ch04">Chapter 4</a></span>, <span class="emphasis"><em>Character Movement</em></span>. The last one is a simple looped aim animation where our character aims a crossbow straight ahead. You can go to the <code class="literal">Chapter 07 Special effects\Recipe 07 Using sprite sheets to animate particles</code> directory. You will find an <code class="literal">Example.unity</code> scene there. Open it and play the game. You can move the character with the <span class="emphasis"><em>WSAD</em></span> keys and rotate the camera with the mouse. You can find the <strong class="userinput"><code>AimForward</code></strong> animation in the <code class="literal">Rigs</code> directory and all the other required animations in the <code class="literal">Chapter 04 Character movement\Recipe 03 Using root motion to steer a character</code> directory. We also need a <strong class="userinput"><code>Crossbow</code></strong> prop, which you can find in the <code class="literal">Props</code> folder.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec206"></a>How to do it...</h3></div></div></div><p>To use Avatar Masks and Layers, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Import the character and the <strong class="userinput"><code>Crossbow</code></strong> prop to Unity. Make sure to have all the required animations.</li><li>Create an Animator Controller and assign it to the character.</li><li>Follow the <span class="emphasis"><em>Using root motion to steer a character</em></span> recipe in <span><a class="link" href="#" linkend="ch04">Chapter 4</a></span>, <span class="emphasis"><em>Character Movement</em></span>, to make the character move.</li><li>Open the Animator Controller and find the <strong class="userinput"><code>Layers</code></strong> tab.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Click on the plus button near the <strong class="userinput"><code>Layers</code></strong> tab to create a new <strong class="userinput"><code>Layer</code></strong> and name it <strong class="userinput"><code>Aim</code></strong>. See the following screenshot for reference:</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/4a14ab86-8e3e-490b-ad65-7829b060af07.png" /></div><p>Layers tab</p><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Drag and drop the <strong class="userinput"><code>AimForward</code></strong> animation to it.</li><li>Click on the small gear icon in the <strong class="userinput"><code>Layer</code></strong>. The <strong class="userinput"><code>Layer Properties</code></strong> window will appear.</li><li>Find the <strong class="userinput"><code>Weight</code></strong> slider and drag it all the way up to <code class="literal">1</code>.</li><li>Right-click on <strong class="userinput"><code>Project View</code></strong> and choose <strong class="userinput"><code>Create</code></strong> |<strong class="userinput"><code>Avatar Mask</code></strong> to create a new <strong class="userinput"><code>Avatar Mask</code></strong>. Name it <strong class="userinput"><code>AimMask</code></strong>.</li><li>Click on it and unfold the <strong class="userinput"><code>Humanoid</code></strong> foldout.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="11" type="1"><li>Unselect the legs of the <span>character</span><a id="id325522928" class="indexterm"></a>. See the following screenshot for reference:</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/7991f21f-3b63-4736-88e0-5d66baf2cd31.png" /></div><p>Avatar Mask with only the upper body turned on</p><div class="orderedlist"><ol class="orderedlist arabic" start="12" type="1"><li>Go back to the <strong class="userinput"><code>Animator Controller</code></strong>, open the <strong class="userinput"><code>Layer Properties</code></strong> of the <strong class="userinput"><code>Aim Layer</code></strong>, and assign the <strong class="userinput"><code>AimMask</code></strong> to the <strong class="userinput"><code>Mask</code></strong> field. See the following screenshot for reference:</li></ol></div><div class="mediaobject"><img src="/graphics/9781785883910/graphics/4a83f48a-7ac7-44e3-80b2-bc7e34e2a456.png" /></div><p>Avatar Mask assigned to the Aim Layer</p><div class="orderedlist"><ol class="orderedlist arabic" start="13" type="1"><li>Assign the <code class="literal">RootMotionSteering.cs</code> script to the character to make the character walk. You can find it in the <span class="emphasis"><em>Using root motion to steer a character</em></span> recipe (<code class="literal">Chapter 04 Character movement\Recipe 03 Using root motion to steer a character\Scripts</code>).</li><li>Play the game to see the effect.</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec207"></a>How it works...</h3></div></div></div><p>This recipe has a few key elements that make it work:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Layers</strong></span>: Animator Controller Layers are useful for overriding animations. The <strong class="userinput"><code>Blending</code></strong> drop-down menu in the <strong class="userinput"><code>Layer Properties</code></strong> defines the type of animation blending. We can override the animations or use additive blending (this will be covered in the next chapter).</li><li style="list-style-type: disc"><span class="strong"><strong>Layer Weight</strong></span>: When blending <strong class="userinput"><code>Layers</code></strong>, Unity takes the <strong class="userinput"><code>Weight</code></strong> parameter into account. A weight of 1 means 100 percent override. You can set the Weight in runtime by using the <code class="literal">animator.SetLayerWeight(int index, float weight)</code> function (<code class="literal">animator</code> is a variable that holds the reference to the Animator component).</li><li style="list-style-type: disc"><span class="strong"><strong>Avatar Masks</strong></span>: We can create an Avatar Mask asset and specify the body parts on which we want to play an animation. Then we can use this <strong class="userinput"><code>Avatar Mask</code></strong> in our <strong class="userinput"><code>Layers</code></strong> to override only certain body parts' animations. This way we can play the <strong class="userinput"><code>AimForward</code></strong> animation on the upper body and not on the legs and root. This makes the character move while playing the <strong class="userinput"><code>AimForward</code></strong> animation.</li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec208"></a>There's more...</h3></div></div></div><p>You can also select the <span>Sync option</span><a id="id325536008" class="indexterm"></a> in the <strong class="userinput"><code>Layer Properties</code></strong>. It will inherit the structure of another, chosen layer, but you will be able to change all the animations. This option may be useful for implementing different types of animations for different character states (normal/wounded for example).</p><p>We are also using a <code class="literal">CameraLook.cs</code> script in this recipe. The script can be found in the <code class="literal">Shared Scripts</code> folder of the provided Unity project. This script works with basic camera rig. The rig is built from three game objects:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>CameraRig</code></strong>: This game object follows the Target transform specified in the <code class="literal">CameraLook.cs</code> script component. It also rotates in the global <span class="emphasis"><em>Y</em></span> axis responding to player's horizontal mouse input.</li><li style="list-style-type: disc"><strong class="userinput"><code>CameraPivot</code></strong>: This game object rotates in its local <span class="emphasis"><em>X</em></span> axis to tilt the camera up and down. It responds to the vertical mouse input.</li><li style="list-style-type: disc"><strong class="userinput"><code>Main Camera</code></strong>: This is the standard game camera. It is moved away from the <strong class="userinput"><code>CameraPivot</code></strong> game object in local <span class="emphasis"><em>Z</em></span> axis. This way we have a crane behavior for the camera. It orbits around the <strong class="userinput"><code>CameraPivot</code></strong> game object.</li></ul></div></div></div>