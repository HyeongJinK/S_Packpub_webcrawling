<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec84"></a>Building the Animation State Machine</h2></div></div><hr /></div><p>If you navigate to the <code class="literal">Animation</code> folder, you will not only find all your animations but also an Animator (in case you find more than one, delete them all but one). First of all, rename it <code class="literal">Panda_Animator</code>, and double-click to open it. You will end up in the <strong class="userinput"><code>Animator</code></strong> editor. You should have all the animations created in the previous sections as disconnected nodes. In case you don't have these animation nodes (if you had to delete the other animators), just drag the animations from the <strong class="userinput"><code>Project</code></strong> panel into the <strong class="userinput"><code>Animator</code></strong>. Feel free to rearrange them as you like; here is how I arranged them in order to not make transitions cross each other later on:</p><div class="mediaobject"><img src="/graphics/9781786460271/graphics/31d3a989-7838-4f86-9536-53558f449897.png" /></div><p>As you can see, there are all your animations already, but they are not connected by any transitions. Before we continue, think about how they should be connected, then continue to read here.</p><p>First of all, it's not fine that from the<strong class="userinput"><code>Entry</code></strong> node we go directly into the <strong class="userinput"><code>Walk</code></strong> node. In fact, we need to start with the <strong class="userinput"><code>Idle</code></strong> node. Hence, if <strong class="userinput"><code>Idle</code></strong> is not highlighted, then right-click on it and select <strong class="userinput"><code>Set as Layer Default State</code></strong>, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781786460271/graphics/93a45c0d-4026-4ac6-8293-95d15a197e07.png" /></div><p>As a result, the <strong class="userinput"><code>Idle</code></strong> animation should be highlighted, and an arrow should go from the<strong class="userinput"><code>Entry</code></strong> node to the <strong class="userinput"><code>Idle</code></strong> one:</p><div class="mediaobject"><img src="/graphics/9781786460271/graphics/d0b26565-1872-4ced-9305-dd2c020e6223.png" /></div><p>Next, from the <strong class="userinput"><code>Idle</code></strong> node, we can go both to the <strong class="userinput"><code>Jump_Start</code></strong> (because the character can jump when the player is not moving), or to the <strong class="userinput"><code>Walk</code></strong> node (because the character can start moving). As such, with the right-click and then <strong class="userinput"><code>Make Transition</code></strong>, create these two arrows. So far, you should have something similar to this:</p><div class="mediaobject"><img src="/graphics/9781786460271/graphics/d4c73370-14bf-4098-9da8-2459e0602691.png" /></div><p>Now, it's time to connect the other nodes. From the <strong class="userinput"><code>Walk</code></strong> node, we can go back to <strong class="userinput"><code>Idle</code></strong>, in case we stop moving, or jumping, and thus go to <strong class="userinput"><code>Jump_Start</code></strong>. Make these other two transitions, and you will end up with the following:</p><div class="mediaobject"><img src="/graphics/9781786460271/graphics/ddb6193b-a6e4-408e-9983-deb1102a1436.png" /></div><p>From the <strong class="userinput"><code>Jump_Start</code></strong> node, we cannot go back to <strong class="userinput"><code>Idle</code></strong> or <strong class="userinput"><code>Walk</code></strong> because we need to finish the Jump loop, so we need to go first to <strong class="userinput"><code><span class="strong"><strong>Jump_Air</strong></span></code></strong> and then from there to <strong class="userinput"><code>Jump_Landing</code></strong>. This is the result so far:</p><div class="mediaobject"><img src="/graphics/9781786460271/graphics/61698b65-b82b-48d7-afac-f25d90419bdb.png" /></div><p>Finally, from the <strong class="userinput"><code>Jump_Landing</code></strong>, we need to go back to <strong class="userinput"><code>Walk</code></strong> or <strong class="userinput"><code>Idle</code></strong> (depending on whether the character is moving or not), and thus create two arrows towards them. This is the final result:</p><div class="mediaobject"><img src="/graphics/9781786460271/graphics/48dc0eba-ef37-41cd-b062-c449add1f679.png" /></div><p>However, we haven't finished yet. In fact, we didn't establish any rule on how to fire the transitions. To do so, we need parameters. Go to the <strong class="userinput"><code>Parameter</code></strong> tab in the upper-left corner and create a couple of parameters. One parameter is of type <strong class="userinput"><code>Float</code></strong> and we will name it <code class="literal">Speed</code>; the other one is a <strong class="userinput"><code>Boolean</code></strong> and we will name it <code class="literal">Jump</code>. The idea is to have the <code class="literal">Speed</code> stored in the float parameter, to determine whether the character is moving or not, and in the <code class="literal">Jump</code> Boolean to determine whether the character is performing a jump or not.</p><p>Here is a screenshot of how the list of the parameters should appear:</p><div class="mediaobject"><img src="/graphics/9781786460271/graphics/78d5af0e-67cd-464e-9287-d76ec21678cc.png" /></div><p>Now, we need to set all the transitions properly. If you select an arrow, in the <strong class="userinput"><code>Inspector</code></strong> you will see all the properties, and at the bottom, you can set conditions on when the transition is fired.</p><p>Following is the screenshot highlighting where to insert a condition on a transition:</p><div class="mediaobject"><img src="/graphics/9781786460271/graphics/a89bb3b1-fa36-4a6b-acaa-2bfad4642cf6.png" /></div><p>To properly set all the conditions for our Animation State Machine, follow these instructions, transition by transition:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Idle - &gt; Walk</code></strong>: Triggers if the<strong class="userinput"><code>Speed</code></strong> parameter is greater or equal than <strong class="userinput"><code>0.01</code></strong>.</li><li style="list-style-type: disc"><strong class="userinput"><code>Walk - &gt; Idle</code></strong>: Triggers if the <strong class="userinput"><code>Speed</code></strong> parameter goes below <strong class="userinput"><code>0.01</code></strong>.</li><li style="list-style-type: disc"><strong class="userinput"><code>Idle - &gt; Jump_Start</code></strong>: Triggers if the <strong class="userinput"><code>Jump</code></strong> Boolean becomes true.</li><li style="list-style-type: disc"><strong class="userinput"><code>Walk - &gt; Jump_Start</code></strong>: Triggers if the <strong class="userinput"><code>Jump</code></strong> Boolean becomes true.</li><li style="list-style-type: disc"><strong class="userinput"><code>Jump_Start - &gt; Jump_Air</code></strong>: Triggers as soon as the <strong class="userinput"><code>Jump_Start</code></strong> animation has finished, thus set the <strong class="userinput"><code>Exit Time</code></strong> to <strong class="userinput"><code>1</code></strong> and <strong class="userinput"><code>Transition Duration</code></strong> to <strong class="userinput"><code>0</code></strong>, no further conditions.</li><li style="list-style-type: disc"><strong class="userinput"><code>Jump_Air - &gt; Jump_Landing</code></strong>: Triggers as soon as the <span class="strong"><strong>Jump</strong></span> Boolean becomes false.</li><li style="list-style-type: disc"><strong class="userinput"><code>Jump_Landing - &gt; Idle</code></strong>: Triggers as soon as the <strong class="userinput"><code>Jump_Landing</code></strong> animation is finished (so set <strong class="userinput"><code>Exit Time</code></strong> to <span class="strong"><strong>1</strong></span> and <strong class="userinput"><code>Transition Duration</code></strong> to <span class="strong"><strong>0</strong></span>, but on the condition that the <strong class="userinput"><code>Speed</code></strong> parameter is less than <span class="strong"><strong>0.01</strong></span>).</li><li style="list-style-type: disc"><strong class="userinput"><code>Jump_Landing</code></strong> - &gt; <strong class="userinput"><code>Walk</code></strong>: Triggers as soon as the <strong class="userinput"><code>Jump_Landing</code></strong> animation is finished (so set <strong class="userinput"><code>Exit Time</code></strong> to <strong class="userinput"><code>1</code></strong> and <strong class="userinput"><code>Transition Duration</code></strong> to <span class="strong"><strong>0</strong></span>, but on the condition that the <strong class="userinput"><code>Speed</code></strong> parameter is greater or equal than <strong class="userinput"><code>0.01</code></strong>)</li></ul></div><p>That was quite a lot of work, but we have finished with our state machine. The next step is to build a controller that is able to take care of this state machine, by setting the <strong class="userinput"><code>Speed</code></strong> and <strong class="userinput"><code>Jump</code></strong> parameters. But for now, take a rest and read the summary of this chapter, before we have fun in the next one.</p></div>