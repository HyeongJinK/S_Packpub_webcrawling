<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec38"></a>Creating the game user interface</h2></div></div><hr /></div><p>To begin with <a id="id271" class="indexterm"></a>the user interface for our game, we need a class that manages when and how to use UI elements, such as buttons and when to show the UI screen.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec39"></a>The GameInfo class</h3></div></div></div><p>In order for our other code classes to get a reference to the <code class="literal">GameInfo</code> class, we can create a <code class="literal">GameObject</code> in the scene that holds a GameInfo script component. To do this, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In <a id="id272" class="indexterm"></a>the <code class="literal">Assets/Scripts</code> folder, right-click <a id="id273" class="indexterm"></a>and select <span class="strong"><strong>Create</strong></span> and then click on <span class="strong"><strong>C# Script</strong></span>. Name this <code class="literal">GameInfo</code>.</p></li><li><p>Double-click on the <code class="literal">GameInfo</code> script and select the <code class="literal">Start</code> function as <code class="literal">Awake</code>. Save this file and go back to Unity.</p></li><li><p>Right-click on <span class="strong"><strong>Hierarchy</strong></span> and select <span class="strong"><strong>Create Empty</strong></span>. Name this new GameObject <code class="literal">GameInfo</code>.</p></li><li><p>With this selected, search for <span class="strong"><strong>Inspector</strong></span> and click on <span class="strong"><strong>Add</strong></span> <span class="strong"><strong>Component</strong></span>. Then, search for <span class="strong"><strong>GameInfo</strong></span> and select <span class="strong"><strong>GameInfo</strong></span>.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec40"></a>Importing UI images</h3></div></div></div><p>We now need to import some PNG files to represent elements of the UI. These PNG images will represent elements such as buttons. To do this, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Let's go <a id="id274" class="indexterm"></a>back to Unity, navigate to the <a id="id275" class="indexterm"></a>
<code class="literal">Assets</code> folder, right-click and select <span class="strong"><strong>Create</strong></span> and then select <span class="strong"><strong>Folder</strong></span>. Name this folder <code class="literal">UI</code>.</p></li><li><p>Right-click on the <code class="literal">UI</code> folder and select <span class="strong"><strong>Import New Assetâ€¦</strong></span>. Navigate to the book <code class="literal">Art</code> files and find the folder named <code class="literal">ChapterFive_UI</code>. Import the PNG files to the <code class="literal">UI</code> folder.</p></li><li><p>Select the UI art files. Then, in <span class="strong"><strong>Inspector</strong></span>, change the image settings as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Set <span class="strong"><strong>FilterMode</strong></span> to <span class="strong"><strong>Trilinear</strong></span>.</p></li><li><p>Set <span class="strong"><strong>MaxSize</strong></span> to <code class="literal">256</code>.</p></li><li><p>Set <span class="strong"><strong>Format</strong></span> to <span class="strong"><strong>Truecolor</strong></span>.</p></li><li><p>Then, click on <span class="strong"><strong>Apply</strong></span>.</p></li></ol></div></li></ol></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip30"></a>Tip</h3><p>You can select more than one file in the <code class="literal">Project</code> folder by left-clicking on one and holding down <span class="emphasis"><em>Shift</em></span> to select more than one range. For example, select the top file in the <a id="id276" class="indexterm"></a>folder and press <span class="emphasis"><em>Shift</em></span> + left-click on the bottom file. This will select all of these files between the top and bottom.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec07"></a>Creating the UI Canvas</h4></div></div></div><p>Right-click on the <span class="strong"><strong>Hierarchy</strong></span> tab. Then, click on <span class="strong"><strong>UI</strong></span> and select <span class="strong"><strong>Canvas</strong></span>. Name this new GameObject <code class="literal">GameUI</code>.</p><p>With the <a id="id277" class="indexterm"></a>
<span class="strong"><strong>GameUI</strong></span> GameObject selected, take a look at <span class="strong"><strong>Inspector</strong></span>, Then, in the <span class="strong"><strong>Canvas Scaler</strong></span> component, select <span class="strong"><strong>UI Scale Mode</strong></span> as <span class="strong"><strong>Scale With Screen Size</strong></span>. Also, select <span class="strong"><strong>Reference Resolution</strong></span> as <span class="strong"><strong>X1024 Y768</strong></span>. This will keep the UI in the same ratio, irrespective of the screen size of the device used, such as iPhone versus iPad.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec01"></a>The coin background</h5></div></div></div><p>Right-click <a id="id278" class="indexterm"></a>on the <span class="strong"><strong>GameUI</strong></span> GameObject. Then, click on <a id="id279" class="indexterm"></a>
<span class="strong"><strong>UI</strong></span> and select <span class="strong"><strong>Image</strong></span>. Name this image <code class="literal">CoinBackground</code>.</p><p>In the image component of the <span class="strong"><strong>CoinBackground</strong></span> GameObject, click on the small circle next to the object field named <span class="strong"><strong>Source Image</strong></span>. Search for <code class="literal">ButtonBackground</code> and select, <span class="strong"><strong>ButtonBackground</strong></span>.</p><p>With the <span class="strong"><strong>CoinBackground</strong></span> GameObject selected, as <span class="strong"><strong>Inspector</strong></span>, change the following settings:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Set <span class="strong"><strong>Pos X</strong></span> to <code class="literal">-87.4</code>.</p></li><li><p>Set <span class="strong"><strong>Pos Y</strong></span> to <code class="literal">-103.2</code>.</p></li><li><p>Set <span class="strong"><strong>Pos Z</strong></span> to <code class="literal">0</code>.</p></li><li><p>Set <span class="strong"><strong>Width</strong></span> to <code class="literal">164</code>.</p></li><li><p>Set <span class="strong"><strong>Height</strong></span> to <code class="literal">64</code>.</p></li></ol></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip31"></a>Tip</h3><p>If I do not list a change for any setting, leave it as default. This will be <code class="literal">true</code> for all the settings for the UI.</p></div><p>In the top-left corner of the <span class="strong"><strong>Inspector</strong></span> tab, there is a box with red lines for two of its sides. Click on it and <a id="id280" class="indexterm"></a>select the <span class="emphasis"><em>top right</em></span> box selection:</p><div class="mediaobject"><img src="/graphics/9781784399801/graphics/B04063_05_03.jpg" /></div><p>This will <span class="strong"><strong>anchor</strong></span> <a id="id281" class="indexterm"></a>the image to that side of the UI, making a better reference for it to draw if the screen size is to change. To make it simpler, no matter the screen size, the image will be rendered to the same location of the screen space.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip32"></a>Tip</h3><p><span class="strong"><strong>Anchor</strong></span> is the position on the UI screen that will hold this element of the UI. The element that is anchored to this anchor will follow it, irrespective of the screen size.</p></div><p>With the <span class="strong"><strong>CoinBackground</strong></span> GameObject selected, right-click on it and select <span class="strong"><strong>UI</strong></span>. Then, select <span class="strong"><strong>Text</strong></span> from the list and name it <code class="literal">CoinValue</code>.</p><p>Change the <a id="id282" class="indexterm"></a>
<span class="strong"><strong>CoinValue</strong></span> text settings as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Set <span class="strong"><strong>Pos X</strong></span> to <code class="literal">19.6</code>.</p></li><li><p>Set <span class="strong"><strong>Pos Y</strong></span> to <code class="literal">1.3</code>.</p></li><li><p>Set <span class="strong"><strong>Pos Z</strong></span> to <code class="literal">0</code>.</p></li><li><p>Set <span class="strong"><strong>Width</strong></span> to <code class="literal">103.6</code>.</p></li><li><p>Set <span class="strong"><strong>Height</strong></span> to <code class="literal">41.1</code>.</p></li><li><p>Set <span class="strong"><strong>Text</strong></span> to <code class="literal">0</code>.</p></li><li><p>Set <span class="strong"><strong>Font</strong></span> to <span class="strong"><strong>Arial</strong></span>.</p></li><li><p>Set <span class="strong"><strong>Font Style</strong></span> to <span class="strong"><strong>Bold</strong></span>.</p></li><li><p>Set <span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Size</strong></span> to <span class="strong"><strong>36</strong></span>.</p></li><li><p>Set <span class="strong"><strong>Alignment</strong></span> to <span class="strong"><strong>Right</strong></span>.</p></li></ol></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip33"></a>Tip</h3><p>The alignment is set by the small buttons next to it. Select the third button from the left-hand side to set it to <span class="strong"><strong>Right</strong></span>.</p></div><p>With the <span class="strong"><strong>CoinValue</strong></span> <a id="id283" class="indexterm"></a>GameObject selected, right-click on it and select <span class="strong"><strong>UI</strong></span>. Select <span class="strong"><strong>Image</strong></span> from the list. Name this image <code class="literal">CoinImage</code>.</p><p>Change the <span class="strong"><strong>CoinImage</strong></span> settings as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Set <span class="strong"><strong>Pos X</strong></span> to <code class="literal">-73.5</code>.</p></li><li><p>Set <span class="strong"><strong>Pos Y</strong></span> to <code class="literal">0</code>.</p></li><li><p>Set <span class="strong"><strong>Pos Z</strong></span> to <code class="literal">0</code>.</p></li><li><p>Set <span class="strong"><strong>Width</strong></span> to <code class="literal">100</code>.</p></li><li><p>Set <span class="strong"><strong>Height</strong></span> to <code class="literal">100</code>.</p></li><li><p>Set <span class="strong"><strong>Source Image</strong></span> to <code class="literal">Pickup_Coin_0</code>.</p></li></ol></div><p>You should now see something similar to the following image in the top-right corner of the <span class="strong"><strong>Game</strong></span> tab of the editor:</p><div class="mediaobject"><img src="/graphics/9781784399801/graphics/B04063_05_04.jpg" /></div><p>Before we set <a id="id284" class="indexterm"></a>up the code to adjust the value in the <span class="strong"><strong>CoinValue</strong></span> <a id="id285" class="indexterm"></a>text component, we will set up the <span class="strong"><strong>DistanceBackground</strong></span> field.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec02"></a>The distance background</h5></div></div></div><p><code class="literal">DistanceBackground</code> will reveal the distance the player has run for each attempt and will reset it to <a id="id286" class="indexterm"></a>
<span class="emphasis"><em>zero</em></span> if they restart.</p><p>With the <span class="strong"><strong>GameUI</strong></span> <a id="id287" class="indexterm"></a>GameObject selected, right-click on it and select <span class="strong"><strong>UI</strong></span>. In the list, select <span class="strong"><strong>Image</strong></span>. Name this image <code class="literal">DistanceBackground</code>.</p><p>With the <span class="strong"><strong>DistanceBackground</strong></span> GameObject selected, search for <code class="literal">Inventory</code> and change its settings as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Pos X</strong></span>: <code class="literal">-87.39999</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">-37</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">164</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">64</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Source</strong></span> <span class="strong"><strong>Image</strong></span>: <code class="literal">ButtonBackground</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>top right</strong></span></p></li></ul></div><p>Still, with the <span class="strong"><strong>DistanceBackground</strong></span> GameObject selected, right-click on it and select <span class="strong"><strong>UI</strong></span>. Select <span class="strong"><strong>Text</strong></span> from the list and name it <code class="literal">DistanceValue</code>.</p><p>Change the <span class="strong"><strong>DistanceValue</strong></span> <a id="id288" class="indexterm"></a>settings using <span class="strong"><strong>Inspector </strong></span>as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Pos X</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">-0.1</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">141</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">41.6</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>top right</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Text</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span>: Arial</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font Style</strong></span>: <span class="strong"><strong>Bold</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font Size</strong></span>: <span class="strong"><strong>36</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Alignment</strong></span>: <span class="strong"><strong>Right</strong></span></p></li></ul></div><p>You should now <a id="id289" class="indexterm"></a>see both the distance and the coin UI elements in the top-right corner of the <span class="strong"><strong>Game</strong></span> tab in the editor if you play the game.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec03"></a>The pause button</h5></div></div></div><p>Having a pause <a id="id290" class="indexterm"></a>button is a nice luxury for any game. Unity makes this functionality fairly simple.</p><p>Select the <span class="strong"><strong>GameUI</strong></span> GameObject and right-click on it. Navigate to <span class="strong"><strong>UI</strong></span> and select <span class="strong"><strong>Button</strong></span> from the list. Name <a id="id291" class="indexterm"></a>this button <code class="literal">PauseButton</code>. Select the child GameObject named <span class="strong"><strong>Text</strong></span> and delete it. We do not need text for <code class="literal">PauseButton</code>.</p><p>With the <span class="strong"><strong>PauseButton</strong></span> GameObject selected in <span class="strong"><strong>Inspector</strong></span>, change its settings as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Pos X</strong></span>: <code class="literal">34.5</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">-34</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">54</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">54</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>top left</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Source Image</strong></span>: <code class="literal">PauseButton</code></p></li></ul></div><p>For <span class="strong"><strong>PauseButton</strong></span> to work, we need to update our <code class="literal">GameInfo</code> C# class. In the <code class="literal">Assets/Scripts</code> folder, double-click on the <code class="literal">GameInfo</code> file and add the following function in it:</p><div class="informalexample"><pre class="programlisting">    // Toggle pause, on or off
    public void PauseGame( )
    {
      Time.timeScale = ( Time.timeScale == 1 ) ? 0 : 1;
    }</pre></div><p>This is a very simple function. We can set <code class="literal">Time.timeScale</code> to <span class="emphasis"><em>zero</em></span> or the <span class="emphasis"><em>one</em></span> based on whether the current time scale is equal to <span class="emphasis"><em>one</em></span>. If it is, we set it to <span class="emphasis"><em>zero</em></span>. If it is <span class="emphasis"><em>not</em></span>, set it to <span class="emphasis"><em>one</em></span>; we will set it to <span class="emphasis"><em>one</em></span>.</p><p>Save the <code class="literal">GameInfo</code> file and go back to Unity.</p><p>In order for the <code class="literal">PauseButton</code> to work, we need to create a button component and then set the <code class="literal">OnClick</code> function of the button component to call our <code class="literal">PauseGame</code> function<a id="id292" class="indexterm"></a><a id="id293" class="indexterm"></a>.</p><p>Right-click on <span class="strong"><strong>Hierarchy</strong></span> and select <span class="strong"><strong>Create Empty</strong></span>. Name this new GameObject <code class="literal">GameInfo</code>. Now, in <span class="strong"><strong>Inspector</strong></span>, click on <span class="strong"><strong>New Component</strong></span>. Then, search for <code class="literal">GameInfo</code> and select <span class="strong"><strong>GameInfo</strong></span>.</p><p>Select the <span class="strong"><strong>PauseButton</strong></span> GameObject in <span class="strong"><strong>Hierarchy</strong></span>. Then, in the <span class="strong"><strong>Button</strong></span> script component in <span class="strong"><strong>Inspector</strong></span>, click on the small plus symbol at the bottom of the <span class="strong"><strong>Button</strong></span> script component. Then, click and drag the <span class="strong"><strong>GameInfo</strong></span> GameObject onto the <span class="strong"><strong>On Click ()</strong></span> object field.</p><p>Now, click on the drop-down menu that says <span class="strong"><strong>No Function</strong></span> and navigate to the selection called <span class="strong"><strong>GameInfo</strong></span>. In the list for <span class="strong"><strong>GameInfo</strong></span>, select <span class="strong"><strong>PauseGame()</strong></span>:</p><div class="mediaobject"><img src="/graphics/9781784399801/graphics/B04063_05_05.jpg" /></div><p>If you play the game now, when you click on <span class="strong"><strong>PauseButton</strong></span>, the game will stop moving most things. <a id="id294" class="indexterm"></a>The <code class="literal">Obstacle</code> GameObjects will not stop rotating; we can fix this by alternating the <code class="literal">Update</code> function in the <code class="literal">Obstacle</code> class.</p><p>Open the <code class="literal">Assets/Scripts</code> folder and double-click on the <code class="literal">Obstacle</code> class. Change the <code class="literal">Update</code> function as follows:</p><div class="informalexample"><pre class="programlisting">  // Update is called once per frame
  void Update () 
  {
    if (Time.timeScale == 1)
    {
      Pivot.transform.Rotate(Vector3.forward, RotationSpeed);
    }
  }</pre></div><p>Now, <span class="strong"><strong>PauseButton</strong></span> will <a id="id295" class="indexterm"></a>freeze some aspects of the game, including the physics, the <code class="literal">FixedUpdate</code> function, and the <code class="literal">WaitForSecond</code> class. This means that as we are checking against <code class="literal">Time.timeScale</code>, before rotating the axe(s) around, it will only rotate if <code class="literal">Time.timeScale</code> is set to <span class="emphasis"><em>one</em></span>. For example, if <code class="literal">timeScale</code> is set to <span class="emphasis"><em>one</em></span>, which means that the game is running at normal speed, the axes(s) can rotate. Otherwise, if <code class="literal">timeScale</code> is <span class="emphasis"><em>zero</em></span>, the axe(s) will stay stationary.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec08"></a>Updating code to show coins and distance</h4></div></div></div><p>For the UI <a id="id296" class="indexterm"></a>to see these values, we need to have a couple of our code classes to tell it what to display.</p><p>In the <code class="literal">Assets/Scripts</code> file, open the <code class="literal">Character</code> file <span class="emphasis"><em>under</em></span> the line that uses the following code:</p><div class="informalexample"><pre class="programlisting">    [System.NonSerialized]
    public int CoinCount;</pre></div><p>Add:</p><div class="informalexample"><pre class="programlisting">    public Canvas GameUI;

    [System.NonSerialized]
    public int DistanceCount;

    [System.NonSerialized]
    public float CurrentTime;</pre></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">GameUI</code>: This will reference our <span class="strong"><strong>Game User Interface Canvas</strong></span> GameObject.</p></li><li style="list-style-type: disc"><p><code class="literal">DistanceCount</code>: This will represent the distance that the character has moved across the screen so that we can display it to the screen as well as submit any leaderboard records related to the distance traveled. It is not based on the actual movement, rather we will use time to add to it.</p></li><li style="list-style-type: disc"><p><code class="literal">CurrentTime</code>: This will be the value we use to add to <code class="literal">DistanceCount</code>.</p></li></ul></div><p>We also need to add another <code class="literal">using</code> tag for the UI to have a reference to the Text class at the top of the <code class="literal">Character</code> code file under the following code:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;</pre></div><p>Now, add the following code:</p><div class="informalexample"><pre class="programlisting">using UnityEngine.UI;</pre></div><p>In the same <code class="literal">Character</code> class, navigate to the <code class="literal">Update</code> function and <span class="emphasis"><em>under</em></span> the lines of the following code:</p><div class="informalexample"><pre class="programlisting">  // Update is called once per frame
  void Update () 
  {
    Vector3 lockXPosition = transform.position;
    lockXPosition.x = 2.25f;
    transform.position = lockXPosition;</pre></div><p>Add the following code:</p><div class="informalexample"><pre class="programlisting">    if (!isDead &amp;&amp; Time.timeScale == 1)
    {
      CurrentTime += Time.deltaTime + 0.025f;
      if (CurrentTime &gt;= 1.0f)
      {
        AddDistance(1);
        CurrentTime = 0.0f;
      }
    }</pre></div><p>This will make sure that the player is alive by making sure <code class="literal">bDead</code> is <span class="emphasis"><em>false</em></span> and also make sure that <code class="literal">timeScale</code> is set to <span class="emphasis"><em>one</em></span>, meaning the game is <span class="emphasis"><em>not</em></span> paused before we change the <code class="literal">CurrentTime</code> and <code class="literal">CurrentDistance</code> values.</p><p>If these values can be changed (the condition is <code class="literal">true</code>), we can add <code class="literal">time.DeltaTime + 0.025f</code> to the <code class="literal">CurrentTime</code> value. The <code class="literal">0.025f</code> parameter is a small addition to make the <code class="literal">CurrentDistance</code> <a id="id297" class="indexterm"></a>count faster than every <span class="emphasis"><em>one</em></span> second.</p><p>As soon as <code class="literal">CurrentTime</code> becomes greater than <span class="emphasis"><em>one</em></span>, we can call the <code class="literal">AddDistance</code> function and give it a value of <span class="emphasis"><em>one</em></span>. We can also reset <code class="literal">CurrentTime</code> back to <span class="emphasis"><em>zero</em></span> so that it can begin to count up to <span class="emphasis"><em>one</em></span> again.</p><p>Let's add the <code class="literal">AddDistance</code> function to the <code class="literal">Character</code> class. At the bottom of the class, under the <code class="literal">ReviveCharacter</code> function, add the following code:</p><div class="informalexample"><pre class="programlisting">    // Adds to the Distance count and updates the UI
    public void AddDistance(int Additional)
    {
      DistanceCount += Additional;
      if (GameUI != null)
      {
      Text distanceText = GameUI.transform.Find( "DistanceBackground/DistanceValue" ).GetComponent&lt;Text&gt;( );
      if (distanceText != null)
      {
        distanceText.text = DistanceCount.ToString( );
      }
    }
  }</pre></div><p>We start this function by adding the value that is passed in to <code class="literal">Additional</code>.</p><p>We then check to make sure that the reference to <span class="strong"><strong>GameUI</strong></span> is not null, making sure <span class="strong"><strong>GameUI</strong></span> has a reference before using it.</p><p>When we have a good reference to the <span class="strong"><strong>GameUI</strong></span>, we can create a <code class="literal">Text</code> local variable and assign it to the <span class="strong"><strong>DistanceValue</strong></span> GameObject text component. This is done by using the <span class="strong"><strong>GameUI</strong></span> reference and using its <code class="literal">transform.Find</code> function to go through the hierarchy of the <span class="strong"><strong>GameUI</strong></span> GameObject and look for the name of the GameObject passed into the <code class="literal">Find</code> function. In our case, <code class="literal">DistanceBackground</code> / <code class="literal">DistanceValue</code>, meaning it goes to <code class="literal">DistanceBackground</code> and then looks for <code class="literal">DistanceValue</code> in its children. When it gets there, we can use <a id="id298" class="indexterm"></a>
<code class="literal">GetComponent</code> to have the <code class="literal">Text</code> component from the <span class="strong"><strong>DistanceValue</strong></span> GameObject.</p><p>We then check whether the <code class="literal">Text</code> reference we got from <span class="strong"><strong>DistanceValue</strong></span> is valid. If it is valid, we can update the text of <code class="literal">distanceText</code> to the <code class="literal">DistanceCount</code> value. We can do this by using the <code class="literal">ToString</code> function to convert the <code class="literal">DistanceCount</code> integer value into a string so that we can assign it to the <code class="literal">distanceText.text</code> value.</p><p>To break this down, we will add the distance, check for a good reference to the <span class="strong"><strong>GameUI</strong></span>, get the <span class="strong"><strong>Text</strong></span> component from one of its children and then change it to the value of <span class="strong"><strong>DistanceCount</strong></span>, showing the player how far they have moved.</p><p>We also need to write a function called <code class="literal">AddCoins</code> for the coins. In the <code class="literal">Character</code> class, write the following function <span class="emphasis"><em>under</em></span> the <code class="literal">AddDistance</code> function:</p><div class="informalexample"><pre class="programlisting">    // Add to the coin count
    public void AddCoins(int Additional)
    {
      CoinCount += Additional;
      if (GameUI != null)
      {
        Text coinText = GameUI.transform.Find( "CoinBackground/CoinValue" ).GetComponent&lt;Text&gt;( );
        if (coinText != null)
        {
          coinText.text = CoinCount.ToString( );
        }
      }
    }</pre></div><p>This takes the exact same steps as the <code class="literal">AddDistance</code> function. We can add <code class="literal">CoinCount</code>, check for the valid <span class="strong"><strong>GameUI</strong></span> reference and then update its child <code class="literal">Text</code> component to change the text so that the player knows that the <code class="literal">CoinCount</code> has changed.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec04"></a>Updating the coin class</h5></div></div></div><p>The final step to having the <code class="literal">CoinCount</code> change when a coin is collected is to have the Coin class tell the <a id="id299" class="indexterm"></a>character that a coin has been picked up.</p><p>In the <code class="literal">Assets/Scripts</code> folder, open the <code class="literal">Coin</code> script file by double-clicking on it.</p><p>Navigate to the <a id="id300" class="indexterm"></a>
<code class="literal">OnTriggerEnter2D</code> function and change the following lines:</p><div class="informalexample"><pre class="programlisting">    gameChar.CoinCount += 1;
    ActivateCoin( false );</pre></div><p>To the following code:</p><div class="informalexample"><pre class="programlisting">    gameChar.AddCoins(1);
    ActivateCoin( false );</pre></div><p>As we are now adjusting the <span class="strong"><strong>GameUI</strong></span> to show the <code class="literal">CoinCount</code> on the screen, we made the <code class="literal">AddCoins</code> function in the <code class="literal">Character</code> class to do it, we no longer need to directly alter the <code class="literal">CoinCount</code> for the <code class="literal">Character</code> class in the <code class="literal">Coin</code>. We can instead select the value we want to change it using <code class="literal">AddCoins</code>.</p><p>This way, we can handle everything we need from the <code class="literal">Character</code> class instead of relying on <code class="literal">Coin</code> to directly alter the values in <code class="literal">Character</code>.</p><p>Save the <code class="literal">Coin</code> file and go back to Unity. If you play the game now, you should see the distance and coins adding up during the events that would add them up, running forward, or by collecting coins.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec05"></a>The restart button</h5></div></div></div><p>In order to complete <a id="id301" class="indexterm"></a>our game loop, we need to allow the player to restart playing. As of now, as soon as the player character dies, they cannot keep playing because they will lose all control of the game. The restart button will allow them to restart playing and collect those glorious coins.</p><p>The restart button needs to do a couple of things. The major one is resetting the character so that it can run, collect coins again, and die as well. The next thing is resetting the level pieces so that the player has the same experience as the first attempt.</p><p>We also don't want the restart button to show that the player is alive only when the character has died.</p><p>Right-click on the <span class="strong"><strong>GameUI</strong></span> GameObject and navigate to <span class="strong"><strong>UI</strong></span>, select <span class="strong"><strong>Button</strong></span> from the list, and name it <code class="literal">RestartButton</code>.</p><p>With the <span class="strong"><strong>RestartButton</strong></span> selected, in the <span class="strong"><strong>Inspector</strong></span> tab, change the settings as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Pos X</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">93</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">128</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">64</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>center bottom</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Source Image</strong></span>: <code class="literal">RestartButton</code></p></li></ul></div><p>Select the <span class="strong"><strong>Text</strong></span> child <a id="id302" class="indexterm"></a>GameObject of the <span class="strong"><strong>RestartButton</strong></span>, search for its <span class="strong"><strong>Inspector</strong></span>, and change its settings as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Text</strong></span>: <span class="strong"><strong>Restart</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span>: <span class="strong"><strong>Arial</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font Style</strong></span>: <span class="strong"><strong>Bold</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font Size</strong></span>: <span class="strong"><strong>32</strong></span></p></li></ul></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec09"></a>The fade object</h4></div></div></div><p>We need to create a GameObject that will hold a <code class="literal">GUITexture</code> component so that we can use it to turn the screen from completely black to completely transparent and vice versa, simulating a camera fade<a id="id303" class="indexterm"></a>.</p><p>In <span class="strong"><strong>Hierarchy</strong></span>, right-click and choose <span class="strong"><strong>Create Empty</strong></span>. Name this new GameObject <code class="literal">FadeObject</code>.</p><p>With the <span class="strong"><strong>FadeObject</strong></span> selected, search for the <span class="strong"><strong>Inspector</strong></span> window and click on <span class="strong"><strong>Add Component</strong></span>. Search for <code class="literal">GUITexture</code> and then select <span class="strong"><strong>GUITexture</strong></span>.</p><p>Change its settings as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Position X</strong></span>: <code class="literal">-5</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Position Y</strong></span>: <code class="literal">-5</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Position Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Texture</strong></span>: <span class="strong"><strong>BlackFade</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Color</strong></span>: <code class="literal">0</code>â€”red, <code class="literal">0</code>â€”blue, <code class="literal">0</code>â€”green, <code class="literal">255</code>â€”alpha</p></li></ul></div><p>We will move the <a id="id304" class="indexterm"></a>
<code class="literal">FadeObject</code> position in the world by <span class="emphasis"><em>negative five</em></span> for <span class="strong"><strong>X</strong></span> and <span class="strong"><strong>Y</strong></span> just so that the black square doesn't get in the way of our scene. We will position it to the correct location when the game starts.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec06"></a>The restart functionality</h5></div></div></div><p>We now need to <a id="id305" class="indexterm"></a>set up the <code class="literal">GameInfo</code> class to manage our <span class="strong"><strong>RestartButton</strong></span>, which includes a fading screen and communicates with the <code class="literal">LevelPieceManager</code> and <code class="literal">Character</code> class so that they know when to restart and what to do when they restart.</p><p>In the <code class="literal">Assets/Scripts</code> folder, double-click on the <code class="literal">GameInfo</code> script file. Add the following code at the top of the class:</p><div class="informalexample"><pre class="programlisting">    // Reference to our Character
    public Character GameCharacter;

    // Reference to our levelPieceManager
    public LevelPieceManager LevelManager;

    // Fade object
    public Transform FadeObject;

    // Reference to fade GUITexture
    private GUITexture FadeTexture;

    // Is game restarting
    private bool bRestartingGame;

    // Is fading active
    private bool bStartFading;

    // Level and Character need resetting
    private bool bLevelAndCharacterRestart;</pre></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">GameCharacter</code>: This will hold a reference to our <code class="literal">Character</code> class in the level.</p></li><li style="list-style-type: disc"><p><code class="literal">LevelManager</code>: This will hold a reference to the <code class="literal">LevelPieceManager</code> we have in our level.</p></li><li style="list-style-type: disc"><p><code class="literal">FadeObject</code>: This will hold the fade texture so that we can fade our game screen from clear to black and from black to clear.</p></li><li style="list-style-type: disc"><p><code class="literal">FadeTexture</code>: This is the <code class="literal">GUITexture</code> component of <code class="literal">FadeObject</code>, which is what we will be changing from black to clear.</p></li><li style="list-style-type: disc"><p><code class="literal">bRestartingGame</code>: This will be used to tell <code class="literal">GameInfo</code> whether the game will restart.</p></li><li style="list-style-type: disc"><p><code class="literal">bStartFading</code>: This will be used to tell <code class="literal">GameInfo</code> to start fading the screen.</p></li><li style="list-style-type: disc"><p><code class="literal">bLevelAndCharacterRestart</code>: This will be used to prevent the <code class="literal">LevelPieces</code> and the <code class="literal">Character</code> from continually being reset in the <code class="literal">Update</code> function as we transition from the completely black to the transparent fade. This is because we reset the <code class="literal">Character</code> and <code class="literal">LevelPieces</code> before the fade is completely done.</p></li></ul></div><p>Now save the <a id="id306" class="indexterm"></a>
<code class="literal">GameInfo</code> file and navigate back to Unity.</p><p>Select the <span class="strong"><strong>GameInfo</strong></span> GameObject in <span class="strong"><strong>Hierarchy</strong></span> and assign it to the object fields by left-clicking and dragging the corresponding GameObject onto the fields:</p><div class="mediaobject"><img src="/graphics/9781784399801/graphics/B04063_05_06.jpg" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h6 class="title"><a id="ch05lvl5sec01"></a>The Awake function</h6></div></div></div><p>Previously, we <a id="id307" class="indexterm"></a>changed the <code class="literal">Start</code> function to <code class="literal">Awake</code>. If you missed <a id="id308" class="indexterm"></a>this step, go ahead and change it now and enter the following code in the function:</p><div class="informalexample"><pre class="programlisting">    // When object starts
    void Awake( )
    {
      if ( FadeObject != null )
      {
        FadeObject.transform.position = new Vector3( 0.5f, 0.5f, 0.0f );
        FadeTexture = FadeObject.GetComponent&lt;GUITexture&gt;( );
        FadeTexture.pixelInset = new Rect (0.0f, 0.0f, Screen.width, Screen.height );

        RestartGame( );
      }
    }</pre></div><p>Let's start by making sure that we have a reference to <code class="literal">FadeObject</code>. When we do, we then set the location of <code class="literal">FadeObject</code> back to default because we have it offset in the editor so that it doesn't get in the way of us working in the scene.</p><p>We then assign the global <code class="literal">GUITexture</code> variable named <code class="literal">FadeTexture</code> to the component of the <code class="literal">FadeObject</code>. This way, we can keep it stored in the class without having to always get it in other functions.</p><p>When we have the reference <a id="id309" class="indexterm"></a>to the <code class="literal">GUITexture</code> variable as <code class="literal">FadeTexture</code>, we can change <a id="id310" class="indexterm"></a>its <code class="literal">pixelInset</code> to a new <code class="literal">Rect</code> struct that starts at <code class="literal">0X</code> and <code class="literal">0Y</code> in the screen space (which is in the top-left corner). We can also set the size of the <code class="literal">pixelInset</code> rect to that of the screen with <code class="literal">Screen.width</code> and <code class="literal">Screen.height</code> for its <code class="literal">X</code> and <code class="literal">Y</code> values for size.</p><p>This makes the black 2D box fit the size of the screen.</p><p>Lastly, we will call a function called <code class="literal">RestartGame</code>. We will write this function soon; it will call all the things we need to make sure that the game resets, which includes the screen fading to black and back to transparent and resetting the <code class="literal">Character</code> and <code class="literal">LevelPieces</code>.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec07"></a>The Update function</h5></div></div></div><p>The <code class="literal">Update</code> <a id="id311" class="indexterm"></a>function for our <code class="literal">GameInfo</code> class will handle the <code class="literal">FadeTexture</code> for fading in and out of black, when to respawn the <code class="literal">Character</code>, and <a id="id312" class="indexterm"></a>reset the <code class="literal">LevelPieces</code>.</p><p>Write the following code in the <code class="literal">Update</code> function:</p><div class="informalexample"><pre class="programlisting">    // Updates every frame
    void Update( )
    {â€©      if ( bRestartingGame )
      {
        if ( bStartFading )
        {
          FadeToBlack( );
          if ( FadeTexture.color.a &gt;= 0.95f )
          {
            bStartFading = false;
          }
        }
        else
        {
          FadeToNormal( );
          if ( FadeTexture.color.a &lt;= 0.5f )
          {
            if (bLevelAndCharacterRestart)
            {
              // Restart level and characters before fade is done.
              RestartLevelAndCharacter();
            }

            if (FadeTexture.color.a &lt;= 0.05f)
            {
              bRestartingGame = false;
              FadeTexture.enabled = false;
            }
          }
        }
      }
    }</pre></div><p>As the <code class="literal">Update</code> function is called in every frame, we need to manage it in a way that it doesn't do any extra work when we don't want it to. This is why we have a few bool values.</p><p>To start with, we <a id="id313" class="indexterm"></a>need to make sure that <code class="literal">GameInfo</code> has set <code class="literal">bRestartingGame</code> to <span class="emphasis"><em>true</em></span>. This value can only be changed when the RestartButton is shown <a id="id314" class="indexterm"></a>and only when the player has clicked on it.</p><p>Next, we need to check whether <code class="literal">bStartFading</code> is set to <span class="emphasis"><em>true</em></span>. When the <code class="literal">RestartButton</code> is pressed, we will set this along with <code class="literal">bRestartingGame</code> to <span class="emphasis"><em>true</em></span>. The first thing we need to do when <code class="literal">bStartFading</code> is set to <code class="literal">true</code> is call the <code class="literal">FadeToBlack</code> function. This function will be written to <span class="strong"><strong>lerp </strong></span>between the current alpha value of <code class="literal">FadeTexture</code> to a different value over the course of time. The thing with <code class="literal">Lerp</code> is that you have to call it every time you want to change it, which is why we will use the <code class="literal">Update</code> function. If we only call it once, it will only change the alpha value of <code class="literal">FadeTexture</code> once.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip34"></a>Tip</h3><p><span class="strong"><strong>Lerp</strong></span> comes from <span class="strong"><strong>Linear Interpolation</strong></span>. It is a way to get a value that is some percentage between two values. This is a great tool if you want to slowly move between these two values, or if you want to get a value that is between two values.</p></div><p>After each frame that <code class="literal">FadeToBlack</code> is called, we can change to see whether the alpha channel of <code class="literal">FadeTexture</code> is <span class="emphasis"><em>greater than</em></span> or <span class="emphasis"><em>equal to</em></span> <code class="literal">0.95f</code>. At this value, the alpha channel has gone opaque (or black) enough for us to start fading back out. We can start fading back to transparent (or clear) by setting <code class="literal">bStartFading</code> to <span class="emphasis"><em>false</em></span>.</p><p>Once <code class="literal">bStartFading</code> <a id="id315" class="indexterm"></a>is set to <span class="emphasis"><em>false</em></span>, we can start by calling <code class="literal">FadeToNormal</code>, which will also use the <code class="literal">Lerp</code> function, but in the opposite direction of <code class="literal">FadeToBlack</code>, making the alpha channel of <code class="literal">FadeTexture</code> become transparent.</p><p>Now, we can check whether the alpha channel is <span class="emphasis"><em>less than</em></span> or <span class="emphasis"><em>equal to</em></span> <code class="literal">0.5f</code>. We need to do this because at this time, the user can now begin to see the level, and we don't want the pause effect of the game to show through the fade. Once the alpha layer has reached this <code class="literal">0.5f</code>, we then check to make sure that <code class="literal">bLevelAndCharacterRestart</code> is set to <code class="literal">true</code>.</p><p>If <code class="literal">bLevelAndCharacterRestart</code> is set to <span class="emphasis"><em>true</em></span>, we can call the <code class="literal">RestartLevelAndCharacter</code> function. This function will do as it's named; it will restart the Level and Character back to default. It also sets the <code class="literal">bLevelAndCharacterRestart</code> bool to <span class="emphasis"><em>false</em></span>, so this function can only be called once per restart.</p><p>We then continue to check the alpha channel of <code class="literal">FadeTexture</code> until it is <span class="emphasis"><em>less than</em></span> or <span class="emphasis"><em>equal</em></span> to <code class="literal">0.05f</code>. When the alpha channel reaches this point, we know that the texture is transparent enough to set the <code class="literal">bRestartingGame</code> bool to <span class="emphasis"><em>false</em></span> and to disable <code class="literal">FadeTexture</code> with <code class="literal">FadeTexture.bEnabled</code> set to <span class="emphasis"><em>false</em></span>.</p><p>To break this function down in a more simple way, when we restart the game, we can set <code class="literal">bRestartingGame</code> to <span class="emphasis"><em>true</em></span>. While this is true, we can fade the screen to black and then back to transparent. During the middle point of the transparency, we can reset the character and level so that the gameplay continues on seamlessly. When the transparency is finished, we can stop the reset by setting <code class="literal">bRestartingGame</code> to <span class="emphasis"><em>false</em></span> and disabling the <code class="literal">FadeTexture</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec08"></a>The RestartGame function</h5></div></div></div><p>The <a id="id316" class="indexterm"></a>
<code class="literal">RestartGame</code> function is designed to start the sequence of code we just wrote for the <code class="literal">Update</code> function and make sure that it is called when it is supposed to be.</p><p>Write the following function <span class="emphasis"><em>under</em></span> our previously written <code class="literal">PauseGame</code> function:</p><div class="informalexample"><pre class="programlisting">    // Restarts the game
    public void RestartGame( )
    {
      if (Time.timeScale == 1)
      {
        FadeTexture.enabled = true;
        bLevelAndCharacterRestart = true;
        bRestartingGame = true;
        bStartFading = true;

        HideRestartButton(true);
      }
    }</pre></div><p>As we do not want to <a id="id317" class="indexterm"></a>restart the game if the game is paused, we can start by making sure <code class="literal">Time.timeScale</code> is set to <span class="emphasis"><em>one</em></span>, which means that the game is running at its normal speed. If we were to allow the game to restart with a time scale that is less than one, we might experience an odd behavior, such as character and level restarting.</p><p>If <code class="literal">timeScale</code> is set to <span class="emphasis"><em>one</em></span>, we can enable the <code class="literal">FadeTexture</code> because we will need it to begin fading in and then fading out the screen from black to transparent.</p><p>We then set a series of bool values that allows the <code class="literal">Update</code> function to run its code in the correct way we want it. <code class="literal">bLevelAndCharacterRestart</code> allows the level and character to restart. <code class="literal">bRestartingGame</code> allows the fading to start happening in the correct order. Finally, <code class="literal">bStartFading</code> allows the screen to start turning black.</p><p>Lastly, we will call <code class="literal">HideRestartButton</code>, which will hide the <code class="literal">RestartButton</code> from the scene because the player has already clicked on it and doesn't need to see it anymore.</p><p>This function is here so that the restart event can begin with the correct values.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec09"></a>The RestartLevelAndCharacter function</h5></div></div></div><p>The next <a id="id318" class="indexterm"></a>step is to write the code that will actually reset the level and character back to default so that the game can continue. If you remember, this gets called from the <code class="literal">Update</code> function if <code class="literal">bLevelAndCharacterReset</code> is set to <span class="emphasis"><em>true</em></span> and the alpha value for <code class="literal">FadeTexture</code> is <span class="emphasis"><em>less than</em></span> or <span class="emphasis"><em>equal to</em></span> <code class="literal">0.5f</code>.</p><p>Under the <code class="literal">RestartGame</code> function, write the following function:</p><div class="informalexample"><pre class="programlisting">    // Restart level and character
    private void RestartLevelAndCharacter( )
    {
      bLevelAndCharacterRestart = false;

      if ( GameCharacter != null )
      {
        GameCharacter.ReviveCharacter( );
      }

      if ( LevelManager != null )
      {
        LevelManager.ResetLevelPieces( );
      }
    }</pre></div><p>This function is <a id="id319" class="indexterm"></a>sort of a middle man to the <a id="id320" class="indexterm"></a>restart process for the character and level. The one thing this function manages for the <code class="literal">GameInfo</code> class is the first line of the function, which sets <code class="literal">bLevelAndCharacterRestart</code> to <span class="emphasis"><em>false</em></span>. When we set this to <span class="emphasis"><em>false</em></span>, we can tell the <code class="literal">Update</code> function that it can't call it again until we set it to <span class="emphasis"><em>true</em></span> in the <code class="literal">RestartGame</code> function, which is called from the <code class="literal">RestartButton</code>.</p><p>We then check to make sure that the reference for <code class="literal">GameCharacter</code> exists by verifying that it is <span class="emphasis"><em>not</em></span> null. If we have the reference, we can call <code class="literal">ReviveCharacter</code> from the <code class="literal">Character</code> class, which we wrote in <a class="link" href="#" linkend="ch03">Chapter 3</a>, <span class="emphasis"><em>Player Character, Obstacles, and Pickups</em></span>.</p><p>Finally, we check to make sure that the <code class="literal">LevelManager</code> reference exists by again verifying that it is <span class="emphasis"><em>not</em></span> null. If it isn't, we can call the <code class="literal">ResetLevelPieces</code> function. We will write this shortly. It will be a function that puts all the <code class="literal">LevelPieces</code> back to their initial locations and resets the <code class="literal">StartingLevelPiece</code> back to its initial location.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec10"></a>FadeToBlack and FadeToNormal functions</h5></div></div></div><p>We now <a id="id321" class="indexterm"></a>need to write the two functions <a id="id322" class="indexterm"></a>responsible for fading our <code class="literal">FadeTexture</code> from opaque to transparent and vice versa.</p><p>Under the <code class="literal">RestartLevelAndCharacter</code> function, write these two functions:</p><div class="informalexample"><pre class="programlisting">    // Fade screen to black
    private void FadeToBlack( )
    {
      if (FadeTexture != null)
      {
        FadeTexture.color = Color.Lerp( FadeTexture.color, Color.black, 2.0f * Time.deltaTime );
      }
    }

    // Fade screen back to clear
    private void FadeToNormal( )
    {
      if (FadeTexture != null)
      {
        FadeTexture.color = Color.Lerp( FadeTexture.color, Color.clear, 2.0f * Time.deltaTime );
      }
    }</pre></div><p>These two functions do the same thing, but in the reverse order of each other. We first check to make sure that the <code class="literal">FadeTexture</code> reference exists by verifying that it is <span class="emphasis"><em>not</em></span> null. If we have a valid <a id="id323" class="indexterm"></a>reference, we can say that the color value of <code class="literal">FadeTexture</code> is set to the return value from <code class="literal">Color.Lerp</code>.</p><p>Inside the <code class="literal">FadeToBlack</code> function, we use the <code class="literal">Lerp</code> function to change the <code class="literal">FadeTexture.color</code> value from its current color value to the <code class="literal">Color.black</code> value. This is done by taking the current value of <code class="literal">FadeTexture.color</code> and adding to it every frame by the return value of <code class="literal">Lerp</code>, which uses product of <code class="literal">2.0f</code> and <code class="literal">Time.deltaTime</code> to get a percentage between the current <code class="literal">FadeTexture.color</code> value and <code class="literal">Color.black</code> value.</p><p>For the <code class="literal">FadeToNormal</code> function, it does the same thing, but instead of fading to <code class="literal">Color.black</code>, it starts to fade to <code class="literal">Color.clear</code>, making the <code class="literal">FadeTexture</code> value more transparent.</p><p>Remember that both of these functions are called in every frame when the <code class="literal">bRestartingGame</code> is set to <span class="emphasis"><em>true</em></span>. Each time either of them is called, they change the alpha value a small amount, resulting in a couple of seconds before the screen will fade completely black and <a id="id324" class="indexterm"></a>then back to transparent, making a nice transition between pressing the <code class="literal">RestartButton</code> and actually having the game restart.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec11"></a>The HideRestartButton function</h5></div></div></div><p>The last <a id="id325" class="indexterm"></a>function we need to write for <code class="literal">GameInfo</code> is the <code class="literal">HideRestartButton</code> function. The reason we need this is because we want the button to be shown only when we want it to be shown, and we do not want the player to reset the game unless they have died.</p><p>Under the <code class="literal">FadeToNormal</code> function, write the following code:</p><div class="informalexample"><pre class="programlisting">    // Shows or hides the restart butt
    public void HideRestartButton(bool bHide)
    {
      if (GameUI != null)
      {
        GameUI.transform.Find( "RestartButton" ).gameObject.SetActive( !bHide );
      }
    }</pre></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip35"></a>Tip</h3><p>If you get an error telling you that <span class="strong"><strong>GameUI</strong></span> is not set to an instance of an object, make sure to take the <span class="strong"><strong>GameUI</strong></span> GameObject in the <span class="strong"><strong>Hierarchy</strong></span> tab and left-click and drag it into the object field of the <span class="strong"><strong>GameInfo</strong></span> GameObject, which is also in <span class="strong"><strong>Hierarchy</strong></span>.</p></div><p>Again, we need to make <a id="id326" class="indexterm"></a>sure that the reference of the <span class="strong"><strong>GameUI</strong></span> exists by making sure that it is <span class="emphasis"><em>not</em></span> null. Once we have this reference, we can use the <code class="literal">transform.Find</code> function to look for the GameObject named <span class="strong"><strong>RestartButton</strong></span>, which is a child of <span class="strong"><strong>GameUI</strong></span>. As <code class="literal">Find</code> returns a transform, we have its <code class="literal">gameObject</code> and then set this to the opposite of the function argument. We do this because if we were to take the value passed in and use it, it would make the function name look backwards.</p><p>For example, if we didn't use the opposite of what is passed and you passed <span class="emphasis"><em>true</em></span>, it would set the button to active or shown. As the function name is <code class="literal">HideRestartButton</code>, it makes more sense that if you pass <span class="emphasis"><em>true</em></span>, it hides it, and if you pass in <span class="emphasis"><em>false</em></span>, it shows it.</p><p>Now, save the <a id="id327" class="indexterm"></a>
<code class="literal">GameInfo</code> class.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec10"></a>The ResetLevelPieces function in LevelPieceManager</h4></div></div></div><p>In the <a id="id328" class="indexterm"></a>
<code class="literal">Assets/Scripts</code> folder, double-click on the <code class="literal">LevelPieceManager</code> file to open it. Under the <code class="literal">isActivePiece</code> function, at the bottom of the class, write the following function:</p><div class="informalexample"><pre class="programlisting">    // Resets all LevelPieces
    public void ResetLevelPieces()
    {
      for (int i = 0; i &lt; LevelPieces.Length; i++)
      {
        LevelPieces[ i ].transform.position = LevelPieces[ i ].GetInitialLocation();
        LevelPieces[ i ].ResetAllChildrenCoins();
      }

      StartingLevelPiece.transform.position = StartingLevelPiece.GetInitialLocation( );
      StartingLevelPiece.gameObject.SetActive( true );

      Start( );
    }</pre></div><p>This function starts by looping through <code class="literal">LevelPieces</code>. If you remember, <code class="literal">LevelPieces</code> were assigned by us from the editor and the number of them is dependent on how many you assigned.</p><p>In the <code class="literal">for</code> loop, we set the <code class="literal">transform.position</code> of each <code class="literal">LevelPiece</code> to the value of what is returned from the <code class="literal">GetInitialLocation</code> function. This means that the level pieces assigned will move to where we had set them in the scene before any of them were used.</p><p>We then do the same thing for the <code class="literal">StartingLevelPiece</code>. The only addition is to make sure that the <code class="literal">StartingLevelPiece gameObject</code> is active by setting <code class="literal">SetActive</code> to <span class="emphasis"><em>true</em></span>.</p><p>Lastly, we will call the <code class="literal">Start</code> function, which is designed to begin moving the <code class="literal">StartingLevelPiece</code> and by getting a secondary piece from the world and setting its location to the <code class="literal">EndLocation</code> of the <code class="literal">StartingLevelPiece</code>.</p><p>From here, the normal code takes over, and the <code class="literal">LevelPieces</code> are moved and set based on the code we had originally written to manage them. This function is just there to make sure that they all go back to default before starting over.</p><p>Now, save <a id="id329" class="indexterm"></a>the <code class="literal">LevelPieceManager</code> file.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec12"></a>Updating Character To Reset</h5></div></div></div><p>In the <a id="id330" class="indexterm"></a>
<code class="literal">Assets/Scripts</code> folder, double-click on the <code class="literal">Character</code> file to open it.</p><p>We need to add a few things to this class in order to make the reset functionality complete.</p><p>To begin with, add the following global variables at the top of the <code class="literal">Character</code> class:</p><div class="informalexample"><pre class="programlisting">    public GameInfo Game;

    [System.NonSerialized]
    public Vector3 RestartLocation;</pre></div><p>The <code class="literal">Game</code> reference allows you to tell <code class="literal">GameInfo</code> that the <code class="literal">RestartButton</code> needs to show when the character dies.</p><p><code class="literal">RestartLocation</code> will give us a location to restart the character when it dies.</p><p>In the <code class="literal">Start</code> function, add the following code:</p><div class="informalexample"><pre class="programlisting">  // Use this for initialization
  void Start ()
  {
    RestartLocation = gameObject.transform.position;
  }</pre></div><p>We now need to update a couple of functions so that we can use these new references. Go to the <code class="literal">KillCharacter</code> function and use the following code:</p><div class="informalexample"><pre class="programlisting">characterRigidBody.AddForce(new Vector2(Random.Range(-1, 1), 1) * 512);
isDead = true;
isFadeOut = true;</pre></div><p>Then, add the following code:</p><div class="informalexample"><pre class="programlisting">if (Game != null)
{
  Game.HideRestartButton(false);
}</pre></div><p>This will show the <code class="literal">RestartButton</code> on screen when the character is killed, allowing the player to restart the game.</p><p>We also need to update the <code class="literal">ReviveCharacter</code> function so that <code class="literal">DistanceCount</code> gets reset when <a id="id331" class="indexterm"></a>the character does, and the character uses the <code class="literal">RestartLocation</code> when it's revived.</p><p>First, change <code class="literal">    Vector3 resetLocation = new Vector3( 0.0f,0.0f,0.0f );</code> to <code class="literal">    Vector3 resetLocation = RestartLocation;</code>.</p><p>This will force the location of the character back to where it was assigned in <code class="literal">Start</code>.</p><p>Next, we want to reset <code class="literal">DistanceCount</code> when the character is revived.</p><p><span class="emphasis"><em>Under</em></span> the following code:</p><div class="informalexample"><pre class="programlisting">        if (gameCharacterSprite != null)
        {
          gameCharacterSprite.color = resetColorAlpha;
        }</pre></div><p>Add the following code:</p><div class="informalexample"><pre class="programlisting">        DistanceCount = 0;</pre></div><p>This will set <code class="literal">DistanceCount</code> back to zero; so, when the game restarts, so does the value of distance and in turn, the text shown on the UI will also be updated to show zero. The reason for this is that we don't want the distance to continue through to multiple attempts.</p><p>Save the <code class="literal">Character</code> file.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec13"></a>Connecting RestartGame to the RestartButton click</h5></div></div></div><p>To <a id="id332" class="indexterm"></a>complete the <code class="literal">RestartButton</code>, we need to make sure that its click event is set to the <code class="literal">RestartGame</code> function we wrote in <code class="literal">GameInfo</code>.</p><p>Go back to Unity, select the <span class="strong"><strong>RestartButton</strong></span> GameObject from the <span class="strong"><strong>GameUI</strong></span> children in <span class="strong"><strong>Hierarchy</strong></span>.</p><p>In <span class="strong"><strong>Inspector</strong></span>, search for the <code class="literal">Button</code> script component and click on the small plus symbol in the <span class="strong"><strong>On Click ()</strong></span> area.</p><p>Then, left-click and drag the <span class="strong"><strong>GameInfo</strong></span> GameObject onto the new object field of the <span class="strong"><strong>On Click ()</strong></span> area for the <span class="strong"><strong>RestartButton</strong></span>.</p><p>Click on the drop-down list next to the object field that is now holding the <span class="strong"><strong>GameInfo</strong></span> GameObject. Then, navigate to <span class="strong"><strong>GameInfo</strong></span> and select <span class="strong"><strong>RestartGame</strong></span>:</p><div class="mediaobject"><img src="/graphics/9781784399801/graphics/B04063_05_07.jpg" /></div><p>If you play the game now, you should see the screen fade from black and have the <span class="strong"><strong>Character</strong></span> <a id="id333" class="indexterm"></a>animation play running. The <code class="literal">LevelPieces</code> should now be moving and connecting together. The <span class="strong"><strong>GameUI</strong></span> elements should also be updating the distance traveled and the coins collected.</p><p>Also, if you die, the <span class="strong"><strong>RestartButton</strong></span> should show. When you click on the <span class="strong"><strong>RestartButton</strong></span>, it should hide, and the screen should fade to black and then back to transparent. During this transition, the character and level is reset.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip36"></a>Tip</h3><p>There has been a lot to do with the <span class="strong"><strong>GameInfo</strong></span> GameObject and getting the game loop completed. If you are lost or having issues with code, take a look at the project files that came with the book and use them as reference.</p></div></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec41"></a>PlayerPrefs game save object</h3></div></div></div><p>Saving <a id="id334" class="indexterm"></a>data using the <code class="literal">PlayerPrefs</code> <a id="id335" class="indexterm"></a>class is not very difficult. Basically, the <code class="literal">PlayerPrefs</code> class is designed to save the basic variable data so that it can be used between game sessions. In our case, we need to save <span class="emphasis"><em>two</em></span> things. The first is the <code class="literal">CoinCount</code> in <code class="literal">Character</code>. We also need to check whether the user has bought the remove ads feature of the game.</p><p>For this chapter, we will start by making sure that the coins are saved between game sessions.</p><p>Go to the <code class="literal">Assets/Scripts</code> folder and open the <code class="literal">Character</code> file.</p><p>In the <code class="literal">Start</code> function, add the following code <span class="emphasis"><em>under</em></span> where we assigned <code class="literal">RestartLocation</code>:</p><div class="informalexample"><pre class="programlisting">        CoinCount = PlayerPrefs.GetInt( "Coins" );
       AddCoins( 0 );</pre></div><p>This will set <code class="literal">CoinCount</code> to whatever has been saved. We can also use the <code class="literal">AddCoins</code> function and pass <span class="emphasis"><em>zero</em></span> so that the <span class="strong"><strong>GameUI</strong></span> updates the UI to show how many coins we have.</p><p>Next, we need to see where to save the coins. As we don't have to save the <code class="literal">PlayerPrefs</code> value every time a coin is picked up, we can use the point at which the player is killed to do so. This way, we aren't saving every coin and saving some overhead as well.</p><p>Find the <code class="literal">KillCharacter</code> function and <span class="emphasis"><em>under</em></span> the following code:</p><div class="informalexample"><pre class="programlisting">       if (Game != null)
      {
        Game.HideRestartButton(false);
      }</pre></div><p>Add the following code:</p><div class="informalexample"><pre class="programlisting">       PlayerPrefs.SetInt("Coins", CoinCount);
       PlayerPrefs.Save();</pre></div><p>Now, if you play the game, collect some coins, and stop playing, when you play again, it will show the coins <a id="id336" class="indexterm"></a>you collected in the previous session as how many you have.</p><p>If you are on a Windows machine, the save data is saved in the registry. To get there, click on the <span class="strong"><strong>Start</strong></span> button and enter <code class="literal">regedit</code>. This will show a program called <code class="literal">regedit.exe</code>. The save data is in <code class="literal">HKEY_CURRENT_USER/Software/[YourCompanyName]/[YourGameName]</code>.</p><p>For example, mine is in <code class="literal">HKEY_CURRENT_USER/Software/dotvawxgames/EndlessRushRunner</code>:</p><div class="mediaobject"><img src="/graphics/9781784399801/graphics/B04063_05_08.jpg" /></div><p>If you want to <a id="id337" class="indexterm"></a>set your company and game name, navigate to Unity, click on <span class="strong"><strong>Edit</strong></span> and then <span class="strong"><strong>Project Settings</strong></span>, and select <span class="strong"><strong>Player</strong></span> from the list. In <span class="strong"><strong>Inspector</strong></span>, the top two settings are <span class="strong"><strong>Company Name</strong></span> and <span class="strong"><strong>Product Name</strong></span>. Set these, and the save file will use them as the directory in the registry.</p><p>If you are on a Macintosh computer, the save data is stored in the <span class="strong"><strong>Library</strong></span> | <span class="strong"><strong>Preferences</strong></span> folder in a file named <code class="literal">unity.[company name].[product name].plist</code>.</p></div></div>