<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec40"></a>Building the main menu UI</h2></div></div><hr /></div><p>The main <a id="id338" class="indexterm"></a>menu UI will be its own Canvas GameObject. We will then handle the main menu and the game UI via the <code class="literal">GameInfo</code> class. We will also use the <code class="literal">GameInfo</code> class to manage button presses and the iOS integration.</p><p>In <span class="strong"><strong>Hierarchy</strong></span>, right-click and select <span class="strong"><strong>UI</strong></span> and then click on <span class="strong"><strong>Canvas</strong></span>. Name this new <span class="strong"><strong>Canvas</strong></span> GameObject <code class="literal">MenuUI</code>.</p><p>Let's start by adding <span class="emphasis"><em>five</em></span> buttons to achievements, playing, leaderboards, remove iAds, and restore purchase.</p><p>Right-click on the new <span class="strong"><strong>MenuUI</strong></span> GameObject, navigate to <span class="strong"><strong>UI</strong></span>, and left-click on <span class="strong"><strong>Button</strong></span>. Do this <span class="emphasis"><em>four</em></span> more times, so there are a total of <span class="emphasis"><em>five</em></span> buttons that are children of the Menu UI GameObject.</p><p>Name the buttons and text children as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">PlayButton</code>, <code class="literal">PlayText</code></p></li><li style="list-style-type: disc"><p><code class="literal">LeaderboardButton</code>, <code class="literal">LeaderboardText</code></p></li><li style="list-style-type: disc"><p><code class="literal">AchievementButton</code>, <code class="literal">AchievementText</code></p></li><li style="list-style-type: disc"><p><code class="literal">RemoveAdsButton</code>, <code class="literal">RemoveAdsText</code></p></li><li style="list-style-type: disc"><p><code class="literal">RestorePurchaseButton</code>, <code class="literal">RestorePurchaseText</code></p></li></ul></div><div class="mediaobject"><img src="/graphics/9781784399801/graphics/B04063_06_01.jpg" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec42"></a>Adding button images</h3></div></div></div><p>Next, we need to <a id="id339" class="indexterm"></a>import the art that will be used for the main menu UI. In the <code class="literal">Assets/UI</code> folder, right-click and select<span class="strong"><strong> Import New Asset…</strong></span>. Navigate to the <code class="literal">Art</code> folder for this book and search for the chapter labeled <code class="literal">ChapterSix_MenuUI</code>. Import all the images into this folder.</p><p>Select all the new images in the <code class="literal">Assets/UI</code> folder and change their settings as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Filter Mode</strong></span>: <span class="strong"><strong>Trilinear</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Max Size</strong></span>: <code class="literal">256</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Format</strong></span>: <span class="strong"><strong>Truecolor</strong></span></p></li></ul></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec11"></a>PlayButton</h4></div></div></div><p>Select <span class="strong"><strong>PlayButton</strong></span> in <a id="id340" class="indexterm"></a>
<span class="strong"><strong>Hierarchy</strong></span> and search for <span class="strong"><strong>Inspector</strong></span>. Change <a id="id341" class="indexterm"></a>its settings as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>bottom center</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos X</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">115</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">128</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">128</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Source Image</strong></span>: <code class="literal">MenuButton</code></p></li></ul></div><p>Now, select <span class="strong"><strong>PlayButtonText</strong></span>. In the <span class="strong"><strong>Inspector </strong></span>window, change its settings as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Text</strong></span>: <span class="strong"><strong>Play</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span>: <span class="strong"><strong>Arial</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <a id="id342" class="indexterm"></a>
<span class="strong"><strong>Style</strong></span>: <span class="strong"><strong>Bold</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <a id="id343" class="indexterm"></a>
<span class="strong"><strong>Size</strong></span>: <span class="strong"><strong>36</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Alignment</strong></span>: <span class="strong"><strong>Center</strong></span></p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec12"></a>LeaderboardButton</h4></div></div></div><p>Select <a id="id344" class="indexterm"></a>
<span class="strong"><strong>LeaderboardButton</strong></span> in the <span class="strong"><strong>Hierarchy</strong></span> tab and search <a id="id345" class="indexterm"></a>for <span class="strong"><strong>Inspector</strong></span>. Change its settings as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>bottom center</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos X</strong></span>: <code class="literal">135</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">115</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">128</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">128</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Source Image</strong></span>: <code class="literal">MenuButton</code></p></li></ul></div><p>Select <span class="strong"><strong>LeaderboardText</strong></span>. In the <span class="strong"><strong>Inspector</strong></span> window, change its settings to:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Text</strong></span>: <span class="strong"><strong>Leaderboards</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span>: <span class="strong"><strong>Arial</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Style</strong></span>: <span class="strong"><strong>Bold</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Size</strong></span>: <span class="strong"><strong>17</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Alignment</strong></span>: <span class="strong"><strong>Center</strong></span></p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec13"></a>AchievementButton</h4></div></div></div><p>Select <a id="id346" class="indexterm"></a>
<span class="strong"><strong>AchievementButton</strong></span>. In <span class="strong"><strong>Hierarchy</strong></span>, search for <a id="id347" class="indexterm"></a>
<span class="strong"><strong>Inspector</strong></span>. Change its settings as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>bottom center</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos X</strong></span>: <code class="literal">-135</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">115</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">128</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">128</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Source Image</strong></span>: <code class="literal">MenuButton</code></p></li></ul></div><p>Now, select <a id="id348" class="indexterm"></a>
<span class="strong"><strong>AchievementText</strong></span> and then in <span class="strong"><strong>Inspector</strong></span>, change <a id="id349" class="indexterm"></a>its settings to:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Text</strong></span>: <span class="strong"><strong>Achievements</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span>: <span class="strong"><strong>Arial</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Style</strong></span>: <span class="strong"><strong>Bold</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Size</strong></span>: <span class="strong"><strong>17</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Alignment</strong></span>: <span class="strong"><strong>Center</strong></span></p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec14"></a>RemoveAdsButton</h4></div></div></div><p>Select <a id="id350" class="indexterm"></a>
<span class="strong"><strong>RemoveAdsButton</strong></span> in the <span class="strong"><strong>Hierarchy</strong></span> tab and navigate <a id="id351" class="indexterm"></a>to <span class="strong"><strong>Inspector</strong></span>. Change its settings as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>bottom center</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos X</strong></span>: <code class="literal">-64</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">55</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">96</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">42</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Source Image</strong></span>: <code class="literal">RestartButton</code></p></li></ul></div><p>Now, select <span class="strong"><strong>RemoveAdsText</strong></span> and then in the <span class="strong"><strong>Inspector </strong></span>window, change its settings as shown here:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Text</strong></span>: <span class="strong"><strong>Remove iAds</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span>: <span class="strong"><strong>Arial</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Style</strong></span>: <span class="strong"><strong>Bold</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Size</strong></span>: <span class="strong"><strong>12</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Alignment</strong></span>: <span class="strong"><strong>Center</strong></span></p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec15"></a>RestorePurchaseButton</h4></div></div></div><p>Let's select <a id="id352" class="indexterm"></a>
<span class="strong"><strong>RestorePurchaseButton</strong></span> in the <span class="strong"><strong>Hierarchy</strong></span> <a id="id353" class="indexterm"></a>tab and search for <span class="strong"><strong>Inspector</strong></span>. Change its settings as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>bottom center</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos X</strong></span>: <code class="literal">64</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">55</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">96</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">42</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Source Image</strong></span>: <code class="literal">RestartButton</code></p></li></ul></div><p>Now, select <a id="id354" class="indexterm"></a>
<span class="strong"><strong>RestorePurchaseText</strong></span> and then in the <a id="id355" class="indexterm"></a>
<span class="strong"><strong>Inspector</strong></span> window, change its settings as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Text</strong></span>: <span class="strong"><strong>Restore Purchase</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span>: <span class="strong"><strong>Arial</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Style</strong></span>: <span class="strong"><strong>Bold</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Size</strong></span>: <span class="strong"><strong>14</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Alignment</strong></span>: <span class="strong"><strong>Center</strong></span></p></li></ul></div><p>You should now have a button layout that looks similar to the following image:</p><div class="mediaobject"><img src="/graphics/9781784399801/graphics/B04063_06_02.jpg" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec16"></a>The Purchase Remove iAds panel</h4></div></div></div><p>We <a id="id356" class="indexterm"></a>need to create a few panels that will show when the <a id="id357" class="indexterm"></a>player clicks on <span class="strong"><strong>RemoveAdsButton</strong></span> and what selection they choose from here. The selection to purchase remove iAds with <span class="emphasis"><em>ten thousand</em></span> coins will check whether the player has that many. If they don't, we will display an error panel that tells how many coins they have and that the purchase has failed. We also need a panel to show when the player has successfully purchased the remove iAds purchase.</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Select the <span class="strong"><strong>MenuUI</strong></span> GameObject from the <span class="strong"><strong>Hierarchy</strong></span> tab and then right-click on it. Navigate to <span class="strong"><strong>UI</strong></span> and select <span class="strong"><strong>Panel</strong></span>. Name this <code class="literal">RemoveAdsBackgroundScreen</code>.</p></li><li style="list-style-type: disc"><p>With <span class="strong"><strong>RemoveAdsBackgroundScreen</strong></span> selected, in the <span class="strong"><strong>Hierarchy</strong></span> tab, right-click on it and select <span class="strong"><strong>UI</strong></span> and then <span class="strong"><strong>Image</strong></span>. Name this image <code class="literal">RemoveAdsScreen</code>.</p></li><li style="list-style-type: disc"><p>Still, with <span class="strong"><strong>RemoveAdsBackgroundScreen</strong></span> selected, right-click on it, navigate to <span class="strong"><strong>UI</strong></span>, and select <span class="strong"><strong>Text</strong></span>. Name this text <code class="literal">RemoveAdsTextOption</code>.</p></li><li style="list-style-type: disc"><p>Finally, again with <span class="strong"><strong>RemoveAdsBackgroundScreen</strong></span> selected, right-click on it, navigate to <span class="strong"><strong>UI</strong></span>, and select <span class="strong"><strong>Button</strong></span>. Name this button <code class="literal">ForCoin</code>. Do this twice more. Name the next button <code class="literal">ForCash</code> and the last button <code class="literal">CloseRemoveAds</code>.</p></li><li style="list-style-type: disc"><p>Name the child <span class="strong"><strong>Text</strong></span> GameObject for <span class="strong"><strong>ForCoin</strong></span> as <code class="literal">ForCoinText</code>.</p></li><li style="list-style-type: disc"><p>Name the <a id="id358" class="indexterm"></a>child <span class="strong"><strong>Text</strong></span> GameObject <a id="id359" class="indexterm"></a>for <span class="strong"><strong>ForCash</strong></span> as <code class="literal">ForCashText</code>.</p></li><li style="list-style-type: disc"><p>Delete the child <span class="strong"><strong>Text</strong></span> GameObject for <code class="literal">CloseRemoveAds</code>.</p></li></ul></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch06lvl4sec14"></a>RemoveAdsBackgroundScreen</h5></div></div></div><p>Select <a id="id360" class="indexterm"></a>
<span class="strong"><strong>RemoveAdsBackgroundScreen</strong></span> in the <span class="strong"><strong>Hierarchy</strong></span> tab and navigate to the <span class="strong"><strong>Inspector</strong></span> window. Change its settings as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>Center</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos X</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">265</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">180</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Source Image</strong></span>: <code class="literal">Background</code></p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch06lvl4sec15"></a>RemoveAdsScreen</h5></div></div></div><p>Select <a id="id361" class="indexterm"></a>
<span class="strong"><strong>RemoveAdsScreen</strong></span> in <span class="strong"><strong>Hierarchy</strong></span> and search <a id="id362" class="indexterm"></a>for <span class="strong"><strong>Inspector</strong></span>. Change its settings as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>Center</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos X</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">256</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">171</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Source Image</strong></span>: None</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Color</strong></span>: <code class="literal">32</code>—red, <code class="literal">32</code>—green, <code class="literal">32</code>—blue, <code class="literal">255</code>—alpha</p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch06lvl4sec16"></a>RemoveAdsTextOption</h5></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>top center</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos X</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">-40</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos </strong></span><a id="id363" class="indexterm"></a>
<span class="strong"><strong>Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">155</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">64</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Text</strong></span>: <span class="strong"><strong>Purchase </strong></span><a id="id364" class="indexterm"></a>
<span class="strong"><strong>Remove iAds</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span>: <span class="strong"><strong>Arial</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Style</strong></span>: <span class="strong"><strong>Bold</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Size</strong></span>: <span class="strong"><strong>24</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Alignment</strong></span>: <span class="strong"><strong>Center</strong></span></p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch06lvl4sec17"></a>ForCoin</h5></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>bottom left</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos </strong></span><a id="id365" class="indexterm"></a>
<span class="strong"><strong>X</strong></span>: <code class="literal">68.5</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">68.5</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">128</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">128</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Source Image</strong></span>: <code class="literal">Pickup_Coin_0</code></p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch06lvl4sec18"></a>ForCoinText</h5></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>stretch</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos </strong></span><a id="id366" class="indexterm"></a>
<span class="strong"><strong>X</strong></span>: <code class="literal">6.1</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">101.5</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Right</strong></span>: <code class="literal">-6.1</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Bottom</strong></span>: <code class="literal">7.5</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Text</strong></span>: <span class="strong"><strong>10,000 Coins</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span>: <span class="strong"><strong>Arial</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Style</strong></span>: <span class="strong"><strong>Bold</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Size</strong></span>: <span class="strong"><strong>14</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Alignment</strong></span>: <span class="strong"><strong>Center</strong></span></p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch06lvl4sec19"></a>ForCash</h5></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>bottom left</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos </strong></span><a id="id367" class="indexterm"></a>
<span class="strong"><strong>X</strong></span>: <code class="literal">-68.5</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">68.5</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">76</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">76</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Source Image</strong></span>: <code class="literal">CentSign</code></p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch06lvl4sec20"></a>ForCoinText</h5></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>stretch</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos </strong></span><a id="id368" class="indexterm"></a>
<span class="strong"><strong>X</strong></span>: <code class="literal">6.1</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">101.5</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Right</strong></span>: <code class="literal">-6.1</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Bottom</strong></span>: <code class="literal">7.5</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Text</strong></span>: <span class="strong"><strong>99 Cents</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span>: <span class="strong"><strong>Arial</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Style</strong></span>: <span class="strong"><strong>Bold</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Size</strong></span>: <span class="strong"><strong>14</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Alignment</strong></span>: <code class="literal">Center</code></p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch06lvl4sec21"></a>CloseRemoveAds</h5></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>top left</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos </strong></span><a id="id369" class="indexterm"></a>
<span class="strong"><strong>X</strong></span>: <code class="literal">10</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">-10</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">32</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">32</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Source Image</strong></span>: <code class="literal">CloseButton</code></p></li></ul></div><p>Your <span class="strong"><strong>RemoveAdsBackgroundScreen</strong></span> should now look similar to the following image:</p><div class="mediaobject"><img src="/graphics/9781784399801/graphics/B04063_06_03.jpg" /></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec17"></a>The Purchase Succeeded panel</h4></div></div></div><p>The next <a id="id370" class="indexterm"></a>window we need is the panel that shows when the purchase succeeded.</p><p>To make your <a id="id371" class="indexterm"></a>work easy, select <span class="strong"><strong>RemoveAdsBackgroundScreen</strong></span> and then in the <span class="strong"><strong>Inspector</strong></span> window, click on the checkbox next to its name in order to disable the GameObject. This will hide it from the scene, so when we create the next panel, they won't overlap.</p><div class="mediaobject"><img src="/graphics/9781784399801/graphics/B04063_06_04.jpg" /></div><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>First, right-click on the <span class="strong"><strong>MenuUI</strong></span> GameObject, navigate to <span class="strong"><strong>UI</strong></span>, and left-click on <span class="strong"><strong>Panel</strong></span>. Name this Panel <code class="literal">PurchaseSucceededBackgroundScreen</code>.</p></li><li><p>Then, right-click on <span class="strong"><strong>PurchaseSucceededBackgroundScreen</strong></span>, navigate to <span class="strong"><strong>UI</strong></span>, and left-click on <span class="strong"><strong>Image</strong></span>. Name this image <code class="literal">PurchaseSucceededScreen</code>.</p></li><li><p>Now, right-click on <span class="strong"><strong>PurchaseSucceededBackgroundScreen</strong></span>, navigate to <span class="strong"><strong>UI</strong></span>, and left-click on <span class="strong"><strong>Text</strong></span>. Name this text <code class="literal">PurchaseSucceededText</code>.</p></li><li><p>Right-click on <span class="strong"><strong>PurchaseSucceededBackgroundScreen</strong></span>, navigate to <span class="strong"><strong>UI</strong></span>, and left-click on <span class="strong"><strong>Button</strong></span>. Name this button <code class="literal">PurchaseSucceededAccept</code>. Name its <span class="strong"><strong>Text</strong></span> child as <code class="literal">PurchaseSucceededAcceptText</code>.</p></li><li><p>Finally, let's <a id="id372" class="indexterm"></a>right-click on <span class="strong"><strong>PurchaseSucceededBackgroundScreen</strong></span>, navigate to <span class="strong"><strong>UI</strong></span>, and left-click on <span class="strong"><strong>Button</strong></span>. Name <a id="id373" class="indexterm"></a>this button <code class="literal">PurchaseSucceededClose</code> and delete its <span class="strong"><strong>Text</strong></span> child.</p></li></ol></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch06lvl4sec22"></a>PurchaseSucceededBackgroundScreen</h5></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>center</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos </strong></span><a id="id374" class="indexterm"></a>
<span class="strong"><strong>X</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">265</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">180</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Source Image</strong></span>: <code class="literal">Background</code></p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch06lvl4sec23"></a>PurchaseSucceededScreen</h5></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>center</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos </strong></span><a id="id375" class="indexterm"></a>
<span class="strong"><strong>X</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">256</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">171</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Source</strong></span> <span class="strong"><strong>Image</strong></span>: None</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Color</strong></span>: <code class="literal">19</code>—red, <code class="literal">19</code>—G, <code class="literal">19</code>—blue, <code class="literal">255</code>—alpha</p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch06lvl4sec24"></a>PurchaseSucceededText</h5></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>center</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos </strong></span><a id="id376" class="indexterm"></a>
<span class="strong"><strong>X</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">254</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">30</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Text</strong></span>: <span class="strong"><strong>Purchase Succeeded!</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span>: <span class="strong"><strong>Arial</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <a id="id377" class="indexterm"></a>
<span class="strong"><strong>Style</strong></span>: <span class="strong"><strong>Bold</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Size</strong></span>: <span class="strong"><strong>24</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Alignment</strong></span>: <span class="strong"><strong>Center</strong></span></p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch06lvl4sec25"></a>PurchaseSucceededAccept</h5></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>center</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos </strong></span><a id="id378" class="indexterm"></a>
<span class="strong"><strong>X</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">-50</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">64</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">64</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Source</strong></span> <span class="strong"><strong>Image</strong></span>: <code class="literal">MenuButton</code></p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch06lvl4sec26"></a>PurchaseSucceededAcceptText</h5></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>stretch</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos </strong></span><a id="id379" class="indexterm"></a>
<span class="strong"><strong>X</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Text</strong></span>: <span class="strong"><strong>Ok</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span>: <span class="strong"><strong>Arial</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Style</strong></span>: <span class="strong"><strong>Bold</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Size</strong></span>: <span class="strong"><strong>24</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Alignment</strong></span>: <span class="strong"><strong>Center</strong></span></p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch06lvl4sec27"></a>PurchaseSucceededClose</h5></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Pos </strong></span><a id="id380" class="indexterm"></a>
<span class="strong"><strong>X</strong></span>: <code class="literal">10</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">-10</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">32</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">32</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Source Image</strong></span>: <code class="literal">CloseButton</code></p></li></ul></div><p>Your <a id="id381" class="indexterm"></a>
<span class="strong"><strong>PurchaseSucceeededBackgroundScreen</strong></span> should now look similar to the following image:</p><div class="mediaobject"><img src="/graphics/9781784399801/graphics/B04063_06_05.jpg" /></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec18"></a>The Purchase Failed panel</h4></div></div></div><p>We need the <a id="id382" class="indexterm"></a>exact same window for our failed window. There are <span class="emphasis"><em>two</em></span> ways we could handle this. The first and more involved way is to use the succeeded <a id="id383" class="indexterm"></a>window and change the text, so when something fails, we say it failed. The other way is to duplicate the same window and rename everything that says "Succeeded" to "Failed". For the sake of ease, go ahead and left-click on <span class="strong"><strong>PurchaseSucceededBackgroundScreen</strong></span> in <span class="strong"><strong>Hierarchy </strong></span>to select it.</p><p>Then, click on <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>D</em></span>. This will duplicate the GameObject. In this duplicated GameObject, rename everything from <span class="strong"><strong>Succeeded</strong></span> to <code class="literal">Failed</code>, including the text component of <span class="strong"><strong>PurchaseFailedText</strong></span>.</p><p>You should now have <span class="emphasis"><em>two</em></span> separate <span class="strong"><strong>Panel</strong></span> GameObjects in your <span class="strong"><strong>Hierarchy</strong></span>, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781784399801/graphics/B04063_06_06.jpg" /></div><p>We now need to <a id="id384" class="indexterm"></a>write the code for the buttons of the <span class="strong"><strong>PurchaseSucceeded</strong></span> panel and the <span class="strong"><strong>PurhcaseFailed</strong></span> panel.</p><p>In the <code class="literal">Assets/Scripts</code> folder, double-click on the <code class="literal">GameInfo</code> class to open it.</p><p>At the top of the <a id="id385" class="indexterm"></a>
<code class="literal">GameInfo</code> class, add the following variables:</p><div class="informalexample"><pre class="programlisting">    // Reference to the RemoveAds screen
    private Transform RemoveAdsBackgroundScreen;

    // Reference to the Purchase screen
    private Transform PurchaseSucceededScreen;

    // Reference to the Purchase failed screen
    private Transform PurchaseFailedScreen;</pre></div><p>Then, in the <code class="literal">Start</code> function, add the following code:</p><div class="informalexample"><pre class="programlisting">    // Called after Awake but before Update
    void Start( )
    {
      if ( MainMenuUI != null )
      {
        RemoveAdsBackgroundScreen = MainMenuUI.transform.Find( "RemoveAdsBackgroundScreen" );
        PurchaseSucceededScreen
        = MainMenuUI.transform.Find( "PurchaseSucceededBackgroundScreen" );
        PurchaseFailedScreen = MainMenuUI.transform.Find( "PurchaseFailedBackgroundScreen" );
      }
    }</pre></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip38"></a>Tip</h3><p>If the <code class="literal">Start</code> function doesn't exist in the class because it was removed earlier, write it under the <code class="literal">Awake</code> function.</p></div><p>Under <code class="literal">HideRestartButton</code>, write the following functions:</p><div class="informalexample"><pre class="programlisting">      // Show or hide Purchase Window
      public void ShowPurchaseScreen( bool bShow )
      {
        if (RemoveAdsBackgroundScreen != null)
        {
          RemoveAdsBackgroundScreen.gameObject.SetActive( bShow );
        }
      }

      // Show or hide Success Window
      public void ShowSuccessScreen( bool bShow )
      {
        if (PurchaseSucceededScreen != null)
        {
          PurchaseSucceededScreen.gameObject.SetActive( bShow );
        }
      }

      // Show or hide Fail Window
      public void ShowFailScreen( bool bShow )
      {
        if (PurchaseFailedScreen != null)
        {
          PurchaseFailedScreen.gameObject.SetActive( bShow );
        }
      }</pre></div><p>All three of these <a id="id386" class="indexterm"></a>functions will handle their connected screen in the same way. If the <code class="literal">bShow</code> bool value is set to <code class="literal">true</code>, it will show the associated GameObject. If <code class="literal">bShow</code> is set to <code class="literal">false</code>, it will hide it. This is done using the <code class="literal">SetActive</code> function.</p><p>Now, save the <code class="literal">GameInfo</code> class.</p><p>We now need to make sure that the buttons in the <span class="strong"><strong>MenuUI</strong></span> are using the correct function calls.</p><p>Let's go back to Unity and select the <span class="strong"><strong>CloseRemoveAds</strong></span> GameObject in the <span class="strong"><strong>MenuUI</strong></span> | <span class="strong"><strong>RemoveAdsBackgroundScreen</strong></span> GameObject. In <span class="strong"><strong>Inspector</strong></span>, search for the <code class="literal">Button</code> component and click on the small plus symbol to add an element to the <span class="strong"><strong>On Click ()</strong></span> list. Left-click and drag the <span class="strong"><strong>GameInfo</strong></span> GameObject onto the object field and then select the drop-down menu located at the right. Navigate to <span class="strong"><strong>GameInfo</strong></span> and then select the <code class="literal">ShowPurchaseScreen</code> function. Leave the small checkbox under the drop-down list <span class="emphasis"><em>unchecked</em></span>.</p><p>Select the <span class="strong"><strong>PurchaseSucceededAccept</strong></span> GameObject in the <span class="strong"><strong>MenuUI</strong></span> | <span class="strong"><strong>PurchaseSucceededBackgroundScreen</strong></span> GameObject. Again, navigate to the <span class="strong"><strong>Inspector</strong></span> window. In the <span class="strong"><strong>Button</strong></span> component, click on the small <span class="strong"><strong>plus</strong></span> symbol to add an element to the <span class="strong"><strong>On Click ()</strong></span> list. Then, left-click and drag the <span class="strong"><strong>GameInfo</strong></span> GameObject onto the object field. From the drop-down list, select <span class="strong"><strong>GameInfo</strong></span> and then the <span class="strong"><strong>ShowSuccessScreen</strong></span> function. Again, leave the small checkbox <span class="emphasis"><em>unchecked</em></span>.</p><p>Do this again for the <span class="strong"><strong>PurchaseSucceededClose</strong></span> GameObject, also a child of the <span class="strong"><strong>PurchaseSucceededBackgroundScreen</strong></span> GameObject, which is in the <span class="strong"><strong>MenuUI</strong></span> GameObject. Use the same <span class="strong"><strong>ShowSuccessScreen</strong></span> function and leave the small checkbox <span class="emphasis"><em>unchecked</em></span>.</p><p>Follow the same steps <a id="id387" class="indexterm"></a>for <span class="strong"><strong>PurchaseFailedBackgroundScreen</strong></span>, but instead of selecting <span class="strong"><strong>ShowSuccessScreen</strong></span>, select <span class="strong"><strong>ShowFailedScreen</strong></span>. Also, do <a id="id388" class="indexterm"></a>this for the <span class="strong"><strong>PurchaseFailedClose</strong></span> button.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec19"></a>Connecting the MainMenuUI reference to GameInfo</h4></div></div></div><p>At the <a id="id389" class="indexterm"></a>top of the <code class="literal">GameInfo</code> class, add the following variable:</p><div class="informalexample"><pre class="programlisting">    // MainMenu UI reference
    public Canvas MainMenuUI;</pre></div><p>Next, select the <span class="strong"><strong>GameInfo</strong></span> GameObject in <span class="strong"><strong>Hierarchy</strong></span> by left-clicking on it. Then, left-click and drag <span class="strong"><strong>MenuUI</strong></span> onto the <span class="strong"><strong>Main Menu UI</strong></span> object slot of the <span class="strong"><strong>GameInfo</strong></span> GameObject in <span class="strong"><strong>Inspector</strong></span>.</p><p>Then, select the <span class="strong"><strong>GameUI</strong></span> GameObject in <span class="strong"><strong>Hierarchy</strong></span>. If it is not already hidden, click on the checkbox at the top of the <span class="strong"><strong>Inspector</strong></span> window near the GameUI name to hide it.</p><p>Now, select the children GameObjects in <span class="strong"><strong>MenuUI</strong></span> named <span class="strong"><strong>RemoveAdsBackgroundScreen</strong></span>, <span class="strong"><strong>PurchaseSucceededBackgroundScreen</strong></span>, and <span class="strong"><strong>PurchaseFailedBackgroundScreen</strong></span>. Then, use the checkbox at the top of the <span class="strong"><strong>Inspector</strong></span> window near their names and hide them.</p><p>The menu should now only show the <span class="strong"><strong>Achievements</strong></span>, <span class="strong"><strong>Play</strong></span>, <span class="strong"><strong>Leaderboards</strong></span>, <span class="strong"><strong>Remove</strong></span> <span class="strong"><strong>iAds</strong></span>, and <span class="strong"><strong>Restore</strong></span> <span class="strong"><strong>Purchase</strong></span> buttons.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec43"></a>The menu code</h3></div></div></div><p>My goal is to <a id="id390" class="indexterm"></a>have the code compile at every section of this book. As of now, many of the alterations in this section will feel disorganized. It was a judgment call on my end to <span class="emphasis"><em>not</em></span> have you do work on something that will break everything until a later chapter, which is why in this chapter, we will go back to some C# classes in order to expand or change the existing code within them. Although it is not uncommon for this sort of thing to happen while creating a video game, I know that it can be a bit irritating when you learn to have some back and forth.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec20"></a>The GameInfo menu code</h4></div></div></div><p>For the main <a id="id391" class="indexterm"></a>menu to have movement without any <a id="id392" class="indexterm"></a>game play, we need to set a few things so that the level pieces are used only when they are needed. In the <code class="literal">Assets/Scripts</code> folder, open the <code class="literal">GameInfo</code> class by double-clicking on it.</p><p>At the top of the <code class="literal">GameInfo</code> class, add the following global variables:</p><div class="informalexample"><pre class="programlisting">    // If game is running or at menu idle
    [System.NonSerialized]
    public bool bGameRunning;
    // GameUI reference
    public Canvas GameUI;</pre></div><p>Next, we need a function to call when <span class="strong"><strong>Start</strong></span> button is pressed by the player. This button will transition <span class="strong"><strong>MainMenuUI</strong></span> over to <span class="strong"><strong>GameUI</strong></span> as well as change the way the <span class="strong"><strong>LevelPieces</strong></span> are being connected. At the <span class="emphasis"><em>bottom</em></span> of the <code class="literal">GameInfo</code> class, add the following function:</p><div class="informalexample"><pre class="programlisting">    // Game state button was pressed
    public void GameStateButtonPressed( bool bRunning )
    {
      bGameRunning = bRunning;

      if (MainMenuUI != null)
      {
        MainMenuUI.gameObject.SetActive(!bRunning);
      }

      if (GameUI != null)
      {
        GameUI.gameObject.SetActive(bRunning);
      }

      RestartGame( );
    }</pre></div><p>This function will be used by <code class="literal">PlayButton</code> and a button that we will create to return to the main menu. As our game state is either <span class="emphasis"><em>true</em></span> or <span class="emphasis"><em>false</em></span>, we can use the single function and enter what type of game state we are looking for. For <code class="literal">PlayButton</code>, we want the game state to be set to <span class="emphasis"><em>true</em></span>. For the menu button, we will set it to <span class="emphasis"><em>false</em></span>.</p><p>In the last chapter, we saw how the <code class="literal">RestartGame</code> function began the cycle of fading the screen to black and then back to transparent. At the midpoint of going back to transparent, we <a id="id393" class="indexterm"></a>can restart the character and the <code class="literal">LevelPieces</code>. As <a id="id394" class="indexterm"></a>of the new flow of getting into the gameplay, we also need to update the <code class="literal">RestartLevelAndCharacter</code> function so that it sends the correct information to <code class="literal">LevelManager</code>. Change the <code class="literal">RestartLevelAndCharacter</code> function as follows:</p><div class="informalexample"><pre class="programlisting">    // Restart level and character
    private void RestartLevelAndCharacter( )
    {
      bLevelAndCharacterRestart = false;

      if ( GameCharacter != null )
      {
        GameCharacter.ReviveCharacter( );
      }

      if ( LevelManager != null )
      {
        LevelManager.ResetLevelPieces( bGameRunning );
      }
    }</pre></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec21"></a>The LevelPieceManager menu code</h4></div></div></div><p>We will <a id="id395" class="indexterm"></a>now pass the <code class="literal">bGameRunning</code> bool value to the <code class="literal">RestartLevelPieces</code> function of the LevelManager. To accommodate the new bool value, navigate to the <code class="literal">Assets/Scripts</code> folder and double-click on the <code class="literal">LevelPieceManager</code> C# file to open it.</p><p>Before we change the <code class="literal">RestartLevelPieces</code> function, we need to add a couple of global variables to the class. At the top of the <code class="literal">LevelPieceManager</code> class, add the following code:</p><div class="informalexample"><pre class="programlisting">    [System.NonSerialized]
    // If the game is being played or at main menu
    public bool bGameRunning;

    // MainMenu level piece
    public LevelPiece IdleLevelPiece;</pre></div><p>From the <code class="literal">LevelPieceManager</code> perspective, <code class="literal">bGameRunning</code> will handle the current state of the game. <code class="literal">IdleLevelPiece</code> will be the secondary <code class="literal">LevelPiece</code> that we will use during the menu portion of the game (where the character runs forever).</p><p>We need to change the <code class="literal">Start</code> function as well because it was handling <code class="literal">ActiveLevelPieces</code> too directly for what our game needs now. Change the <code class="literal">Start</code> function as follows:</p><div class="informalexample"><pre class="programlisting">  // Use this for initialization
  void Start( ) 
  {
    ActiveLevelPieces = new LevelPiece[2];
    ResetLevelPieces( bGameRunning );
  }</pre></div><p>This now only creates the <code class="literal">ActiveLevelPieces</code> array and then uses the <code class="literal">RestartLevelPieces</code> function to begin running the game in the correct state. As bool values default to <span class="emphasis"><em>false</em></span>, we know that when we call this using <code class="literal">Start</code>, the game will start in the idle mode.</p><p>Change the <a id="id396" class="indexterm"></a>
<code class="literal">RestartLevelPieces</code> function in the <code class="literal">LevelPieceManager</code> class, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">    // Resets all LevelPieces
    public void ResetLevelPieces( bool bRunning )
    {
      bGameRunning = bRunning;

      StartingLevelPiece.transform.position = StartingLevelPiece.GetInitialLocation();
      StartingLevelPiece.gameObject.SetActive(true);
      IdleLevelPiece.gameObject.SetActive( !bGameRunning );

      for (int i = 0; i &lt; LevelPieces.Length; i++)
      {
        LevelPieces[i].transform.position = LevelPieces[i].GetInitialLocation();
        LevelPieces[i].ResetAllChildrenCoins();
      }

      if (bGameRunning)
      {
        SetGamePieces();
      }
      else
      {
        SetIdlePieces();
      }
    }</pre></div><p>You'll see here that this class also has a <code class="literal">bGameRunning</code> bool value. This is because <code class="literal">LevelPieceManager</code> is in sync with <code class="literal">GameInfo</code>. We can also reset <code class="literal">StartingLevelPiece</code> and make sure that it can be seen because this piece is used in both the menu and game states. We can then set <code class="literal">IdleLevelPiece</code> so that it is only active if the <code class="literal">bGameRunning</code> bool is set to <code class="literal">false</code>. We do not want to use it when the game is running.</p><p>No matter what the game state is, we need to reset the <code class="literal">LevelPieces</code> before running <code class="literal">SetIdlePieces</code> or <code class="literal">SetGamePieces</code>. This way, the <code class="literal">LevelPieces</code> are out of the view of the player until they are needed, which is handled in the <code class="literal">Update</code> function. We accomplish this with the <code class="literal">for</code> loop that sets the <code class="literal">LevelPieces</code> to their <code class="literal">GetInitialLocation</code> and also resets all of their children, coins, and obstacles so that they can be used again by the player.</p><p>This function also has two more function calls: <code class="literal">SetGamePieces</code> and <code class="literal">SetIdlePieces</code>. These two functions are designed to make the <code class="literal">ActiveLevelPieces</code> fit to whichever game state we are in: idle or game.</p><p>In the <code class="literal">Assets/Scripts</code> folder, double-click on the <code class="literal">LevelPiece</code> code file to open it. At the top of the class, add the following global variable:</p><div class="informalexample"><pre class="programlisting">    // End location of Level Piece
    public Transform EndLocation;</pre></div><p>This will give us a direct reference to the <code class="literal">EndLocation Transform</code> so that we don't have to find it every time we use it.<a id="id397" class="indexterm"></a></p><p>Save this file and go back to Unity. Select each of the <code class="literal">LevelPieces</code>, take the GameObject with the name of <span class="strong"><strong>EndLocation</strong></span> in <span class="strong"><strong>Hierarchy</strong></span>, and left-click and drag it onto the new <span class="strong"><strong>EndLocation</strong></span> object field of the <code class="literal">LevelPiece</code>. Do this for <span class="emphasis"><em>all</em></span> the <code class="literal">LevelPiece</code> GameObjects in the scene.</p><div class="mediaobject"><img src="/graphics/9781784399801/graphics/B04063_06_08.jpg" /></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip39"></a>Tip</h3><p>Remember to put <span class="strong"><strong>EndLocation</strong></span>, a child for <span class="emphasis"><em>each</em></span> of the <span class="strong"><strong>LevelPiece</strong></span> GameObjects, and <span class="emphasis"><em>not</em></span> put the same <span class="strong"><strong>EndLocation</strong></span> for all of them.</p></div><p>Back in the <code class="literal">LevelPieceManager</code>, <span class="emphasis"><em>under</em></span> the <code class="literal">Start</code> function, write the follow functions:</p><div class="informalexample"><pre class="programlisting">    // Set ActiveLevelPieces to Idle
    void SetIdlePieces( )
    {
      ActiveLevelPieces[ 0 ] = StartingLevelPiece;
      ActiveLevelPieces[ 1 ] = IdleLevelPiece;
      ActiveLevelPieces[ 1 ].transform.position = StartingLevelPiece.EndLocation.position;
    }

    // Set ActiveLevelPieces to Game
    void SetGamePieces( )
    {
      ActiveLevelPieces[0] = StartingLevelPiece;
      ActiveLevelPieces[1] = GetRandomLevelPiece();
      ActiveLevelPieces[1].transform.position = StartingLevelPiece.EndLocation.position;
    }</pre></div><p><code class="literal">SetIdlePieces</code> takes <code class="literal">StartingLevelPiece</code> and <code class="literal">IdleLevelPiece</code> and assigns them to the <span class="emphasis"><em>zero</em></span> and <span class="emphasis"><em>one</em></span> elements of <code class="literal">ActiveLevelPieces</code>. It also takes <code class="literal">IdleLevelPiece</code> and moves it to the <code class="literal">EndLocation</code> of the first element of <code class="literal">ActiveLevelPieces</code>, which is more easily referred to as <code class="literal">StartingLevelPiece</code>.</p><p><code class="literal">SetGamePieces</code> does <a id="id398" class="indexterm"></a>the same thing as we had the <code class="literal">Start</code> function doing earlier. It assigns the <span class="emphasis"><em>first</em></span> element of <code class="literal">ActiveLevelPieces</code> to <code class="literal">StartingLevelPiece</code> and then uses <code class="literal">GetRandomLevelPiece</code> to assign the next element. It then assigns the return <code class="literal">LevelPiece</code> from the <code class="literal">GetRandomLevelPiece</code> position to the <code class="literal">EndLocation</code> of <code class="literal">StartingLevelPiece</code>.</p><p>These two functions behave very similarly. The only difference is what's being assigned.</p><p>We now need to change the <code class="literal">Update</code> function to change between moving the game <code class="literal">LevelPieces</code> and the idle <code class="literal">LevelPieces</code>. Change the current <code class="literal">Update</code> function as follows:</p><div class="informalexample"><pre class="programlisting">  // Update is called once per frame
  void Update ( )
  {
    for (int i = 0; i &lt; ActiveLevelPieces.Length; i++)
    {
      Vector3 newLocation = ActiveLevelPieces[i].transform.position;
      newLocation.x -= LevelPiecesMoveRate * Time.deltaTime;

      ActiveLevelPieces[i].transform.position = newLocation;

      if (ActiveLevelPieces[i].transform.position.x &lt; transform.position.x)
      {
        if (bGameRunning)
        {
          if (ActiveLevelPieces[i] == StartingLevelPiece)
          {
            ActiveLevelPieces[i].gameObject.SetActive(false);
          }

          ActiveLevelPieces[i].transform.position = ActiveLevelPieces[i].GetInitialLocation();

          ActiveLevelPieces[i] = GetRandomLevelPiece();
          ActiveLevelPieces[i].transform.position = FindOtherLevelPiece(ActiveLevelPieces[i]).EndLocation.position;
          ActiveLevelPieces[i].ResetAllChildrenCoins();
        }
        else
        {
          LevelPiece nextLevelPiece = ( i == 0 ) ? ActiveLevelPieces[ 1 ] : ActiveLevelPieces[ 0 ];

          ActiveLevelPieces[ i ].transform.position = nextLevelPiece.EndLocation.position;
        }
      }
    }
  }</pre></div><p>You'll see that this time, we are using the <code class="literal">bGameRunning</code> bool to decide how to transition between the <code class="literal">ActiveLevelPieces</code>. Luckily, the menu only uses <span class="emphasis"><em>two</em></span>, so if <code class="literal">bGameRunning</code> is set <a id="id399" class="indexterm"></a>to <span class="emphasis"><em>false</em></span>, we can assign <code class="literal">nextLevelPiece</code> with the opposite of what element <code class="literal">i</code> represents. As we know that there are only <span class="emphasis"><em>two</em></span> <code class="literal">ActiveLevelPieces</code>, if the game is not running, we can use the value of <code class="literal">i</code> to get the other <code class="literal">ActiveLevelPieces</code> element, using the ternary operator to check whether I is equal to zero. If it is, we will assign <code class="literal">nextLevelPiece</code> to the <span class="emphasis"><em>second</em></span> element of the <code class="literal">ActiveLevelPieces</code> array. If it isn't, we will assign <code class="literal">nextLevelPiece</code> to the <span class="emphasis"><em>first</em></span> element of the <code class="literal">ActiveLevelPieces</code> array.</p><p>Whichever piece gets chosen as <code class="literal">nextLevelPiece</code>, we set the current <code class="literal">i</code> value of the <code class="literal">ActiveLevelPiece</code> array position to the end of it. This takes the <code class="literal">ActiveLevelPiece</code> that has gone out of viewpoint of the player and moves it back so that it can be used again.</p><p>The code used if <code class="literal">bGameRunning</code> is set to <span class="emphasis"><em>true</em></span> is the same as we had before; if a piece gets out of view of the player, we can choose another with <code class="literal">GetRandomLevelPiece</code>, reset it to default, and attach it <a id="id400" class="indexterm"></a>at the end of the moving <code class="literal">ActiveLevelPieces</code> so that it can be used again.</p><p>Now, save the <code class="literal">LevelPieceManager</code> class.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec22"></a>The character menu code</h4></div></div></div><p>The last step to <a id="id401" class="indexterm"></a>getting the idle menu code working is adding it to the character so that it is aware when it should be counting up distance and when to accept input.</p><p>In the <code class="literal">Assets/Scripts</code> folder, open the <code class="literal">Character</code> C# file by double-clicking on it. At the top of the class, add the following global variable:</p><div class="informalexample"><pre class="programlisting">    public LevelPieceManager LevelManager;</pre></div><p>As there is a delay fading the <code class="literal">GameInfo</code> class, we will use the <code class="literal">bGameRunning</code> bool <code class="literal">LevelPieceManager</code> as the more accurate one before the <code class="literal">LevelPieceManager</code> becomes aware that the game is running. This way, the distance calculations and the input will be more in line with when the player starts to see the game scene.</p><p>We now need to use the <code class="literal">LevelManager.bGameRunning</code> bool value in a couple of places. Navigate to the <code class="literal">AddDistance</code> function and change <code class="literal">if (GameUI != null)</code> to <code class="literal">if (GameUI != null &amp;&amp; LevelManager.bGameRunning)</code>.</p><p>This will prevent any distance calculations before the game is set to running. Next, navigate to the <code class="literal">RecieveInput</code> function and change <code class="literal">if (characterRigidBody != null &amp;&amp; characterAnimator != null)</code> to <code class="literal">if (characterRigidBody != null &amp;&amp; characterAnimator != null &amp;&amp; LevelManager.bGameRunning)</code>.</p><p>This again prevents any player input from manipulating the character unless the game is running.</p><p>Now, save the <code class="literal">Character</code> class.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec23"></a>Completing changes in Unity</h4></div></div></div><p>For the <a id="id402" class="indexterm"></a>changes to be complete, we need to add the new references and GameObjects to the scene.</p><p>Open the <code class="literal">Assets/Prefabs</code> folder and left-click and drag the <code class="literal">StartingLevelPiece</code> prefab onto the scene. Move it away from the view of the camera; I put mine near the other <code class="literal">LevelPieces</code>. In <span class="strong"><strong>Hierarchy</strong></span>, rename it as <code class="literal">IdleLevelPiece</code>.</p><p>Select the <span class="strong"><strong>LevelPieceManager</strong></span> GameObject in <span class="strong"><strong>Hierarchy</strong></span> and then left-click and drag the new <span class="strong"><strong>IdleLevelPiece</strong></span> GameObject from <span class="strong"><strong>Hierarchy</strong></span> onto the <span class="strong"><strong>Idle Level Piece</strong></span> object slot of <span class="strong"><strong>LevelPieceManager</strong></span> in the <span class="strong"><strong>Inspector </strong></span>window.</p><p>Select the <span class="strong"><strong>Character</strong></span> GameObject from <span class="strong"><strong>Hierarchy</strong></span> by left-clicking on it. Then, left-click and drag the <span class="strong"><strong>LevelPieceManager</strong></span> onto the <span class="strong"><strong>Level Manager</strong></span> object slot of <span class="strong"><strong>Character</strong></span> in the <span class="strong"><strong>Inspector</strong></span> window.</p><p>Select the <span class="strong"><strong>PlayButton</strong></span> GameObject under the <span class="strong"><strong>MenuUI</strong></span> GameObject. In the <span class="strong"><strong>Button</strong></span> component, in the <span class="strong"><strong>Inspector</strong></span> window, click on the small plus sign to add a new <span class="strong"><strong>On Click ()</strong></span> list element. Left-click and drag the <span class="strong"><strong>GameInfo</strong></span> GameObject from <span class="strong"><strong>Hierarchy</strong></span> and move it into the object <a id="id403" class="indexterm"></a>slot of the <span class="strong"><strong>On Click </strong></span>list element. Left-click the drop-down menu for the <span class="strong"><strong>On Click ()</strong></span> list and select <span class="strong"><strong>GameInfo</strong></span> and then select <span class="strong"><strong>GameStateButtonPressed</strong></span>. Also, for <span class="strong"><strong>PlayButton</strong></span>, we need to tick the small box that appears under the <span class="strong"><strong>On Click ()</strong></span> drop-down menu because we want <span class="strong"><strong>PlayButton</strong></span> to enter <span class="emphasis"><em>true</em></span> for the game state to change to <span class="emphasis"><em>true</em></span> so that the <span class="strong"><strong>LevelPieceManager</strong></span> and <span class="strong"><strong>GameInfo</strong></span> will know that the game is running.</p><p>You should now be able to play the game and see the character run forever on the menu, but when you press play, <span class="strong"><strong>MenuUI</strong></span> will disappear and <span class="strong"><strong>GameUI</strong></span> will show. The screen will also fade to black and back to transparent, and the game will start normally with the <code class="literal">LevelPieces</code> being put together and reset as the game continues. If the character dies, the restart button will be shown.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec44"></a>Adding the BackToMenu button in GameUI</h3></div></div></div><p>The next <a id="id404" class="indexterm"></a>step is to allow the player to go back to the menu from the game when they want to. In <span class="strong"><strong>Hierarchy</strong></span>, select <span class="strong"><strong>MenuUI</strong></span> and use the checkbox next to its name in Inspector to hide it from the scene. Then, do the same for <span class="strong"><strong>GameUI</strong></span>, but instead of hiding it, it shows it in the scene.</p><p>With the <span class="strong"><strong>GameUI</strong></span> GameObject still selected in <span class="strong"><strong>Hierarchy</strong></span>, right-click on it and navigate to <span class="strong"><strong>UI</strong></span> and then select <span class="strong"><strong>Button</strong></span>. Name this button <code class="literal">BackToMenuButton</code>. Name its child <span class="strong"><strong>Text</strong></span> GameObject <code class="literal">BackToMenuText</code>.</p><p>Now, change the <span class="strong"><strong>BackToMenuButton</strong></span> settings in <span class="strong"><strong>Inspector</strong></span> as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>bottom center</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos X</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Y</strong></span>: <code class="literal">158.5</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Pos Z</strong></span>: <code class="literal">0</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Width</strong></span>: <code class="literal">128</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Height</strong></span>: <code class="literal">64</code></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Source Image</strong></span>: <code class="literal">RestartButton</code></p></li></ul></div><p>Now, change the <a id="id405" class="indexterm"></a>
<span class="strong"><strong>BackToMenuText</strong></span> settings in the <span class="strong"><strong>Inspector </strong></span>as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Anchor</strong></span>: <span class="strong"><strong>stretch</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Text</strong></span>: <span class="strong"><strong>Menu</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span>: <span class="strong"><strong>Arial</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Style</strong></span>: <span class="strong"><strong>Bold</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Font</strong></span> <span class="strong"><strong>Size</strong></span>: <span class="strong"><strong>32</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Alignment</strong></span>: <span class="strong"><strong>Center</strong></span></p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Color</strong></span>: <code class="literal">255</code>—red, <code class="literal">255</code>—green, <code class="literal">255</code>—blue, <code class="literal">255</code>—alpha</p></li></ul></div><p>You should now have another button before the <span class="strong"><strong>Restart</strong></span> button with the <span class="strong"><strong>Menu</strong></span> text, as shown in the following image:</p><div class="mediaobject"><img src="/graphics/9781784399801/graphics/B04063_06_07.jpg" /></div><p>We now need to update the <code class="literal">HideRestartButton</code> function in the <code class="literal">GameInfo</code> class so that it also hides or shows the <span class="strong"><strong>Menu</strong></span> button with it. In the <code class="literal">Assets/Scripts</code> folder, open the <code class="literal">GameInfo</code> C# class by double-clicking on it.</p><p>Find <code class="literal">HideRestartButton</code> and change it, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">    // Shows or hides the restart butt
    public void HideRestartButton(bool bHide)
    {
      if (GameUI != null)
      {
        GameUI.transform.Find( "RestartButton" ).gameObject.SetActive( !bHide );
        GameUI.transform.Find( "BackToMenuButton" ).gameObject.SetActive( !bHide );
      }
    }</pre></div><p>Save the <code class="literal">GameInfo</code> class and go back to Unity.</p><p>As we wrote the <a id="id406" class="indexterm"></a>
<code class="literal">GameStateButtonPressed</code> function earlier, we can also use it for the <code class="literal">BackToMenu</code> button.</p><p>Select <span class="strong"><strong>BackToMenuButton</strong></span> in <span class="strong"><strong>Hierarchy</strong></span> under the <span class="strong"><strong>GameUI</strong></span> GameObject. In <span class="strong"><strong>Inspector</strong></span>, click on the small plus symbol to add an element to the <span class="strong"><strong>On Click ()</strong></span> list.</p><p>Then, left-click and drag the <span class="strong"><strong>GameInfo</strong></span> GameObject from <span class="strong"><strong>Hierarchy</strong></span> onto the <span class="strong"><strong>On Click ()</strong></span> object field for <span class="strong"><strong>BackToMenuButton</strong></span>. In the drop-down list, navigate to <span class="strong"><strong>GameInfo</strong></span> and select <span class="strong"><strong>GameStateButtonPressed</strong></span>. Leave the checkbox that appears <span class="emphasis"><em>unchecked</em></span>. We don't want this checked because we want to enter <span class="emphasis"><em>false</em></span> so that the <code class="literal">bGameRunning</code> value changes to <span class="emphasis"><em>false</em></span>. This will call the <code class="literal">SetIdlePieces</code> function and begin running the <code class="literal">ActiveLevelPieces</code> for the menu in <code class="literal">LevelPieceManager</code>.</p><p>Make sure that you <span class="emphasis"><em>hide</em></span> the <span class="strong"><strong>GameUI</strong></span> GameObject using the <span class="strong"><strong>Inspector</strong></span> checkbox next to its name and <span class="emphasis"><em>unhide</em></span> the <span class="strong"><strong>MenuUI</strong></span> GameObject using the same checkbox before you run the game. If you do not do this, the first shown menu when the game starts will be of the GameUI, instead of the MenuUI.</p><p>You should now be able to click on <span class="strong"><strong>Play</strong></span> button to start playing, <span class="strong"><strong>Restart</strong></span> button to restart a game, and <span class="strong"><strong>BackToMenu</strong></span> button to go back to the main menu.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec45"></a>Code for leaderboard and achievement buttons</h3></div></div></div><p>In <a id="id407" class="indexterm"></a>the <code class="literal">Assets/Scripts</code> folder, double-click on the <code class="literal">GameInfo</code> <a id="id408" class="indexterm"></a>class to open it. Under the <code class="literal">GameStateButtonPressed</code> function, add these two functions:</p><div class="informalexample"><pre class="programlisting">    // Opens the leaderboards window
    public void ShowLeaderboards()
    {
      GameCenterManager.ShowLeaderboard( "G_Distance" );
    }

    // Opens the achievements window
    public void ShowAchievements()
    {
      GameCenterManager.ShowAchievements( );
    }</pre></div><p>Both of these functions are very simple. As <code class="literal">GameCenterManager</code> will manage most of the <code class="literal">GameCenter</code> features, it includes the <code class="literal">ShowLeaderboards</code> and <code class="literal">ShowAchievements</code> functions that will open their related windows.</p><p>Save the <code class="literal">GameInfo</code> class and go back to Unity.</p><p>Left-click on the <span class="strong"><strong>Leaderboard</strong></span> button in <span class="strong"><strong>Hierarchy</strong></span> under the <span class="strong"><strong>MenuUI</strong></span> GameObject to select it. Search for <span class="strong"><strong>Inspector</strong></span>. Now, in the <span class="strong"><strong>Button</strong></span> component, click on the small plus symbol to add the <span class="strong"><strong>On Click ()</strong></span> elements. Left-click and drag the <span class="strong"><strong>GameInfo</strong></span> GameObject onto the object field of the <span class="strong"><strong>On Click ()</strong></span> elements. Click on the drop-down menu that appears at the right-hand side, navigate to <span class="strong"><strong>GameInfo</strong></span>, and select <span class="strong"><strong>Show Leaderboard</strong></span>.</p><p>Left-click on <a id="id409" class="indexterm"></a>
<span class="strong"><strong>Achievement</strong></span> Button in <span class="strong"><strong>Hierarchy</strong></span> under the <span class="strong"><strong>MenuUI</strong></span> <a id="id410" class="indexterm"></a>GameObject to select it. Search for <span class="strong"><strong>Inspector</strong></span>. Then, in the <span class="strong"><strong>Button</strong></span> component, click on the small plus symbol to add the <span class="strong"><strong>On Click ()</strong></span> elements. Left-click and drag the <span class="strong"><strong>GameInfo</strong></span> GameObject onto the object field for the <span class="strong"><strong>On Click ()</strong></span> elements. Click on the drop-down menu that appears at the right-hand side, navigate to <span class="strong"><strong>GameInfo</strong></span>, and select <span class="strong"><strong>Show Achievements</strong></span>.</p><p>This will allow the <span class="strong"><strong>Leaderboard</strong></span> button and the <span class="strong"><strong>Achievement</strong></span> button to open the windows so that the player can see the current state of each.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec46"></a>Code for achievements</h3></div></div></div><p>At this point, the <a id="id411" class="indexterm"></a>final steps we need to take is to use the IOS Native plugin to call achievements, leaderboards, and store purchases.</p><p>If you don't remember, the three achievements we set up are:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">10Rounds</code></p></li><li style="list-style-type: disc"><p><code class="literal">100Pickups</code></p></li><li style="list-style-type: disc"><p><code class="literal">100Yards</code></p></li></ul></div><p>This means that we need to begin storing how many rounds the player has played with our <code class="literal">PlayerPrefs</code> class. As we already know how many coins the player has, we don't need to save this, but we do need to have a condition so that we can award the achievement as soon as they collect 100 coins. Finally, we need to check how far the player has run every time we call the <code class="literal">AddDistance</code> function in the <code class="literal">Character</code> class to check whether they have reached 100 yards. If they have, we then can award the achievement.</p><p>In the <code class="literal">Assets/Scripts</code> folder, double-click on the <code class="literal">GameInfo</code> C# file to open it. At the top of the class, add the following <code class="literal">enum</code> list:</p><div class="informalexample"><pre class="programlisting">    public enum RunnerAchievements
    {
      RA_Rounds,
      RA_Pickups,
      RA_Yards,
    };</pre></div><p>We will use this enum list to know which achievement to set the progress for or unlock.</p><p>Next, we need to <a id="id412" class="indexterm"></a>set up <code class="literal">GameCenter</code> so that it is running and available. Add the <code class="literal">Awake</code> function so that it looks similar to the following code:</p><div class="informalexample"><pre class="programlisting">    // When object starts
    void Awake( )
    {
      if ( FadeObject != null )
      {
        FadeObject.transform.position = new Vector3( 0.5f, 0.5f, 0.0f );
        FadeTexture = FadeObject.GetComponent&lt;GUITexture&gt;( );
        FadeTexture.pixelInset = new Rect (0.0f, 0.0f, Screen.width, Screen.height );

        RestartGame( );
      }

      // Register all achievements
      GameCenterManager.RegisterAchievement( "G_100Yards" );
      GameCenterManager.RegisterAchievement( "G_100Pickups" );
      GameCenterManager.RegisterAchievement( "G_10Rounds" );

      // Delegates for Achievements
      GameCenterManager.Dispatcher.addEventListener( GameCenterManager.GAME_CENTER_ACHIEVEMENT_PROGRESS, OnAchievementProgress );
      GameCenterManager.Dispatcher.addEventListener( GameCenterManager.GAME_CENTER_ACHIEVEMENTS_RESET, OnAchievementsReset );

      // OnAchievementLoaded Delegate
      GameCenterManager.OnAchievementsLoaded += OnAchievementLoaded;

      // Init GameCenter
      GameCenterManager.init( );

      // DEBUGGING ONLY -- REMOVE FOR FINAL BUILD
      //     Reset Achievements
      GameCenterManager.ResetAchievements( );
    }</pre></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip40"></a>Tip</h3><p><code class="literal">GameCenterManager</code> is a part of the IOS Native plugin and is designed to help use call native code for the <code class="literal">GameCenter</code> features.</p></div><p>The new code starts by using <code class="literal">RegisterAchievement</code>, which takes in a string value. We do this so that we have access to these achievements, although they do not have any reported progress.</p><p>Next, we will do something that we haven't done yet. We will use the <code class="literal">addEventListener</code> function to add a delegate function. A <span class="strong"><strong>delegate</strong></span> is a way to call a function when something else happens. In our case, we will use it when we get the progress back from an achievement and when we reset achievements.</p><p>We then use the <code class="literal">OnAchievementLoaded</code> delegate and assign it to <code class="literal">GameCenterManager.OnAchievementLoaded</code>. Delegates look a bit strange because they are assigned with the <code class="literal">+=</code> operator. What this will do is tell <code class="literal">GameCenterManager</code> that when its <code class="literal">OnAchievementLoaded</code> event is called to call the <code class="literal">OnAchievement</code> loaded function in our <code class="literal">GameInfo</code> class. This is the handle part of delegates; you don't have to check whether something has happened, but only assign what to do when it does happen.</p><p>After this, we can use the <code class="literal">Init</code> function for <code class="literal">GameCenterManager</code>. The <code class="literal">Init</code> function starts <code class="literal">GameCenterManager</code> so that the player gets logged in to <code class="literal">GameCenter</code>, or if they haven't logged in before, the <code class="literal">GameCenter</code> login screen will show for them.</p><p>Lastly, we will call <a id="id413" class="indexterm"></a>the <code class="literal">ResetAchievements</code> function. This is purely for testing purposes. This means that every time you load the game, the achievements will be reset. This is <span class="emphasis"><em>not</em></span> ideal for the end user and should only be used for us, so we can test that everything is working. If we didn't reset the achievements, we could only unlock them once. This would become an issue if we wanted to check whether they can be unlocked.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec24"></a>Game center events</h4></div></div></div><p>In order to know <a id="id414" class="indexterm"></a>what is going on with the achievements, we need some functions that get called when specific aspects of the achievement system gets used. At the <span class="emphasis"><em>bottom</em></span> of the <code class="literal">GameInfo</code> class, add the following function:</p><div class="informalexample"><pre class="programlisting">    // When achievements are loaded
    private void OnAchievementLoaded(ISN_Result Result)
    {
      if (Result.IsSucceeded)
      {
        foreach (AchievementTemplate template in GameCenterManager.Achievements)
        {
          print( template.id + ": " + template.progress );
        }
      }
    }</pre></div><p>This function will let us know when an achievement has been loaded. Right now, it only prints out what the achievement ID is and its progress. If you were making a more complex game with a custom UI, you could use this to enter the information of the achievement that is being loaded.</p><p>Beneath the <a id="id415" class="indexterm"></a>
<code class="literal">OnAchievementLoaded</code> function, add the following code:</p><div class="informalexample"><pre class="programlisting">    // When achievements are reset
    private void OnAchievementsReset()
    {
      // Achievements are reset
    }</pre></div><p>Again, this is just another function that will be called when the achievements are reset. It doesn't do anything yet, but I wanted to add it for you if you would like to use it.</p><p>Next, add the following code under <code class="literal">OnAchievementReset</code>:</p><div class="informalexample"><pre class="programlisting">    // When achievements send progress
    private void OnAchievementProgress(CEvent Event)
    {
      ISN_AchievementProgressResult result = Event.data as ISN_AchievementProgressResult;

      if (result.IsSucceeded)
      {
        AchievementTemplate template = result.info;
        print( template.id + ": " + template.progress.ToString( ) );
      }
    }</pre></div><p>Once again, this function is only here if you want to use it. This will give you the achievement progress about the event data. It is doing nothing here but printing out the progress and ID that is being sent when its progress has changed. The <code class="literal">CEvent</code> class as the function argument comes from the IOS Native plugin.</p><p>Finally, add the last of the event functions:</p><div class="informalexample"><pre class="programlisting">    // Player is logged into GameCenter
    void OnAuthFinished(ISN_Result res)
    {
      if (res.IsSucceeded)
      {
        IOSNativePopUpManager.showMessage("Player Authored ", "ID: " + GameCenterManager.Player.PlayerId + "\n" + "Alias: " + GameCenterManager.Player.Alias);
      }
      else
      {
        IOSNativePopUpManager.showMessage("Game Center ", "Player auth failed");
      }
    }</pre></div><p>If <code class="literal">ISN_Result</code> is successful, this function will let the player know that they have logged in to <code class="literal">GameCenter</code> by <a id="id416" class="indexterm"></a>displaying a message to them that they have (while in the game). If it is not, it will tell the player that the <code class="literal">GameCenter</code> authentication has failed.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch06lvl4sec28"></a>SubmitAchievementProgress</h5></div></div></div><p>Next, we <a id="id417" class="indexterm"></a>need to add the functions that we will use to set our achievements for our game. Add the following function under <code class="literal">OnAchievementProgress</code>:</p><div class="informalexample"><pre class="programlisting">    // Set achievement for RunnerGame
    public void SubmitAchievementProgress(RunnerAchievements Achievement, float AchievementValue )
    {
      string lastAchievement = "";
      switch (Achievement)
      {
        case RunnerAchievements.RA_Pickups:
          lastAchievement = "G_100Pickups";
            break;
        case RunnerAchievements.RA_Rounds:
          lastAchievement = "G_10Rounds";
            break;
        case RunnerAchievements.RA_Yards:
          lastAchievement = "G_100Yards";
            break;
      }

      GameCenterManager.SubmitAchievement(GameCenterManager.GetAchievementProgress(lastAchievement) + AchievementValue, lastAchievement);
    }</pre></div><p>As the <code class="literal">SubmitAchievement</code> function takes a string, we need to take the enum value we have for our achievements and use it to create a string of the string ID of the achievements we set up in iTunes Connect.</p><p>We can use a switch statement to see what enum value was passed into the function and then based on that, assign <code class="literal">LastAchievement</code> to the value of the string ID we set in iTunes Connect.</p><p>Based on the <a id="id418" class="indexterm"></a>value of <code class="literal">LastAchievement</code>, we can use the <code class="literal">SubmitAchievement</code> function to submit the current progress value of the achievement <span class="emphasis"><em>plus</em></span> the new value being passed. This will update the current progress of the achievement. If it reaches the value we set in iTunes Connect for when it unlocks, <code class="literal">GameCenter</code> will send the user a broadcast banner that they have unlocked it.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch06lvl4sec29"></a>SubmitAchievementAsWhole</h5></div></div></div><p>Because of the way <a id="id419" class="indexterm"></a>we unlock the distance achievement, we need a way to reset it back to <span class="emphasis"><em>zero</em></span> if the player failed to reach the 100 distance marker. As a result, we don't want the achievement to continue to count upwards each attempt until the distance of 100 has been traveled and instead will only unlock if the player reaches the distance of 100 in a single attempt.</p><p>Under the <code class="literal">SubmitAchievementProgress</code> function, add the following code:</p><div class="informalexample"><pre class="programlisting">    // Instead of adding to an achievement progress value, set it as a whole
    public void SubmitAchievementAsWhole(RunnerAchievements Achievement, float AchievementWholeValue)
    {
      string lastAchievement = "";
      switch (Achievement)
      {
        case RunnerAchievements.RA_Pickups:
          lastAchievement = "G_100Pickups";
            break;
        case RunnerAchievements.RA_Rounds:
          lastAchievement = "G_10Rounds";
            break;
        case RunnerAchievements.RA_Yards:
          lastAchievement = "G_100Yards";
            break;
      }

      GameCenterManager.SubmitAchievement(AchievementWholeValue, lastAchievement);
    }</pre></div><p>This function is very similar to the <code class="literal">SubmitAchievementProgress</code> function, but instead of adding the existing progress of the achievement, we set a whole value to it or a complete value. If there is ever a point when you wanted to submit an achievement for a single action or all at <a id="id420" class="indexterm"></a>once, this is a way to handle it. For the current game, it will be used to either reset the <code class="literal">G_100Yards</code> achievement to <span class="emphasis"><em>zero</em></span> or complete.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec25"></a>SubmitLeaderboardScore</h4></div></div></div><p>Next, we need a <a id="id421" class="indexterm"></a>function to submit a leaderboard score. In the <code class="literal">GameInfo</code> class, under the <code class="literal">SubmitAchievementAsWhole</code> function, add the following code:</p><div class="informalexample"><pre class="programlisting">    // Submits a leaderboard score
    public void SubmitLeaderboardScore(int DistanceScore)
    {
      GameCenterManager.ReportScore( DistanceScore, "G_Distance" );
    }</pre></div><p>This will submit an integer score to the leaderboard with the ID of <code class="literal">G_Distance</code>, which is our only leaderboard.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec26"></a>The character achievement code</h4></div></div></div><p>We now need to <a id="id422" class="indexterm"></a>use the <code class="literal">Character</code> class to both keep track of the data we need, such as <code class="literal">AttemptCount</code>, and call the <code class="literal">GameInfo</code> achievement functions in order to update them.</p><p>At the top of the <code class="literal">Character</code> class, add the following code:</p><div class="informalexample"><pre class="programlisting">    [System.NonSerialized]
    public int AttemptCount;</pre></div><p>This will be used to keep a tally on how many times the player has played the game.</p><p>Next, we need to save <code class="literal">AttemptCount</code> with the <code class="literal">PlayerPrefs</code> class. Change the <code class="literal">Start</code> function so that it looks similar to the following code:</p><div class="informalexample"><pre class="programlisting">  // Use this for initialization
  void Start ()
  {
    RestartLocation = gameObject.transform.position;

    AttemptCount = PlayerPrefs.GetInt( "Attempts" );
    CoinCount = PlayerPrefs.GetInt( "Coins" );
    AddCoins( 0 );
  }</pre></div><p>We set the <code class="literal">AttemptCount</code> to be set each time the character is loaded so that it is equal to what has been saved in <code class="literal">PlayerPrefs</code>. This way, when we send it to the <code class="literal">SubmitAchievement</code> function, it will get updated from the correct <code class="literal">AttemptCount</code> value.</p><p>The last thing we need to do is to add the portion of code that will send the achievement data when the player is being revived.</p><p>Change the <code class="literal">KillCharacter</code> function as follows:</p><div class="informalexample"><pre class="programlisting">    // Kills the character
    public void KillCharacter()
    {
      Rigidbody2D characterRigidBody;

      if (!isDead)
      {
        characterRigidBody = gameObject.GetComponent&lt;Rigidbody2D&gt;();
        if (characterRigidBody != null)
        {
          characterRigidBody.AddForce(new Vector2(Random.Range(-1, 1), 1) * 512);
          isDead = true;
          isFadeOut = true;

          if (Game != null)
          {
            Game.HideRestartButton(false);
          }

          PlayerPrefs.SetInt("Coins", CoinCount);
          PlayerPrefs.Save();

          // Save attempts
          AttemptCount += 1;
          PlayerPrefs.SetInt("Attempts", AttemptCount);
          PlayerPrefs.Save();

          if (Game != null)
          {
            Game.SubmitAchievementProgress(GameInfo.RunnerAchievements.RA_Rounds, AttemptCount);

Game.SubmitAchievementAsWhole(GameInfo.RunnerAchievements.RA_Pickups, CoinCount);

            // If DistanceCount is less than 100 AND achievement hasn't been unlocked, reset it 
            if (GameCenterManager.GetAchievementProgress("G_100Yards") &lt; 100.0f &amp;&amp; DistanceCount &lt; 100)
            {
              Game.SubmitAchievementAsWhole(GameInfo.RunnerAchievements.RA_Yards, 0.0f);
            }
            // If DistanceCount is more than 100, set achievement as complete
            else
            {
              Game.SubmitAchievementProgress(GameInfo.RunnerAchievements.RA_Yards, DistanceCount);
            }
            Game.SubmitLeaderboardScore( DistanceCount );
          }
        }
      }
    }</pre></div><p>This moves on to what we already had at <code class="literal">AttemptCount += 1</code>. From here, we set <code class="literal">AttempCount</code> to <code class="literal">PlayerPrefs</code> using the <code class="literal">SetInt</code> function and then use the <code class="literal">Save</code> function to save this value.</p><p>We then check to make sure that the reference to <code class="literal">Game</code> exists before we submit the achievement progress using the <code class="literal">SubmitAchievementProgress</code> function. We do this for <code class="literal">AttemptCount</code>. We then use <code class="literal">SubmitAchievementAsWhole</code> for <code class="literal">CoinCount</code> because this progress will be a whole value from what is saved using <code class="literal">PlayerPrefs</code>.</p><p>Before we set the distance achievement, we want to make sure that the progress of the distance achievement is less than <span class="emphasis"><em>one hundred</em></span> and that the player had reached a <code class="literal">DistanceCount</code> of <a id="id423" class="indexterm"></a>
<span class="emphasis"><em>one hundred</em></span>. If they didn't or if the achievement hasn't been unlocked, we reset its progress to <span class="emphasis"><em>zero</em></span>. This way, if the player starts again, they won't be able to continue only from where they failed.</p><p>If the player did reach the <span class="emphasis"><em>one hundred</em></span> distance, we can use the <code class="literal">SubmitAchievementAsWhole</code> function to set the progress to the value of <code class="literal">DistanceCount</code>, which will be at least <span class="emphasis"><em>one hundred</em></span>, meaning they unlocked the achievement.</p><p>We can also call <code class="literal">SubmitLeaderboardScore</code> that passes through <code class="literal">DistanceCount</code>, so the leaderboard will reflect how far the player has gone as a record.</p><p>This is it for the achievement code. Make sure to save the <code class="literal">Character</code> and <code class="literal">GameInfo</code> classes.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec47"></a>Displaying iAds</h3></div></div></div><p>As we want to <a id="id424" class="indexterm"></a>display ads only to those who have not purchased to remove them, we need another value to save the <code class="literal">PlayerPrefs</code> class. In the <code class="literal">Assets/Scripts</code> folder, open the <code class="literal">GameInfo</code> class by double-clicking on it.</p><p>At the bottom of the list of global variables, add the following code:</p><div class="informalexample"><pre class="programlisting">    // If HideiAds has been unlocked
    private int HideiAds;

    // Reference to iAd banner
    private iAdBanner AdBanner;</pre></div><p>As the <code class="literal">PlayerPrefs</code> class doesn't store bool values, we have to store it as an int. We will use the default of <span class="emphasis"><em>zero</em></span> to know that the player is going to see ads. Then, if they buy to remove them, we will save the <code class="literal">HideiAds</code> value to <span class="emphasis"><em>one</em></span>.</p><p>We also need to keep the reference to the created <code class="literal">AdBanner</code> so that we can hide and show it, depending on the <code class="literal">bGameRunning </code>value. If the <code class="literal">bGameRunning</code> value is set to <code class="literal">true</code>, we will hide the iAds so that it doesn't get in the way of <span class="strong"><strong>GameUI</strong></span>.</p><p>At the bottom of the <a id="id425" class="indexterm"></a>
<code class="literal">GameInfo</code> class, write the following function:</p><div class="informalexample"><pre class="programlisting">    // Creates instance of iAd if doesn't exist
    // Show or hide it depending on bShow
    public void ShowIAds(bool bShow)
    {
      HideiAds = PlayerPrefs.GetInt( "ShowiAds" );
      if (HideiAds == 0)
      {
        if (AdBanner == null)
        {
          if (bShow)
          {
            AdBanner = iAdBannerController.instance.CreateAdBanner(TextAnchor.UpperCenter);
            AdBanner.Show();
            AdBanner.AdViewFinishedAction += BannerLoaded;
          }
        }
        else
        {
          if (bShow)
          {
            AdBanner.ShowOnLoad = true;
            AdBanner.Show();
          }
          else
          {
            AdBanner.ShowOnLoad = false;
            AdBanner.Hide();
          }
        }
      }
    }</pre></div><p>We start this function by assigning the value of <code class="literal">HideiAds</code> to the <code class="literal">PlayerPrefs</code> saved valued of it. If it's set to <span class="emphasis"><em>zero</em></span>, when check whether the <code class="literal">AdBanner</code> reference is null. We know that if it's <span class="emphasis"><em>null</em></span>, we need to create it, which is what the code does if the banner is null and the bool value being passed is set to <span class="emphasis"><em>true</em></span>. Once it's created, we show it using the <code class="literal">Show</code> function. We also set a delegate so that we know when it's loaded. This is useful, so we can check whether the game is running when the banner has loaded. If the game is running, we can use the <code class="literal">BannerLoaded</code> function to hide it.</p><p>If <code class="literal">AdBanner</code> exists, we then check whether the bool value is set to <code class="literal">true</code> or <code class="literal">false</code>. If it's set to <code class="literal">true</code>, we show the banner. If i<a id="id426" class="indexterm"></a>t' set to <code class="literal">false</code>, we hide it.</p><p>Add the following function <span class="emphasis"><em>before</em></span> the <code class="literal">ShowIAds</code> function:</p><div class="informalexample"><pre class="programlisting">    // Banner has loaded
    public void BannerLoaded()
    {
      if (bGameRunning)
      {
        AdBanner.Hide( );
      }
    }</pre></div><p>This is a very simple function that will be called when <code class="literal">AdBanner</code> has been loaded. If the game is running, we hide it so that it doesn't get in the way of the gameplay.</p><p>We now need to add the <code class="literal">GameStateButtonPressed</code> function so that it shows or hides the banner based on the value of <code class="literal">bGameRunning</code>. Change the <code class="literal">GameStateButtonPressed</code> function as follows:</p><div class="informalexample"><pre class="programlisting">    // Game state button was pressed
    public void GameStateButtonPressed( bool bRunning )
    {
      bGameRunning = bRunning;

      if (MainMenuUI != null)
      {
        MainMenuUI.gameObject.SetActive(!bRunning);
      }

      if (GameUI != null)
      {
        GameUI.gameObject.SetActive(bRunning);
      }

      ShowIAds( !bGameRunning );

      RestartGame( );
    }</pre></div><p>The addition here is the <code class="literal">ShowIAds</code> function, which passes the opposite value of <code class="literal">bGameRunning</code>. More simply, it only shows the banner if <code class="literal">bGameRunning</code> is set to <code class="literal">false</code>.</p><p>Now, at the bottom of the <code class="literal">Awake</code> function, add the following code:</p><div class="informalexample"><pre class="programlisting">ShowIAds( true );</pre></div><p>This will try to show the <a id="id427" class="indexterm"></a>
<code class="literal">AdBanner</code> object as soon as the <code class="literal">GameInfo</code> class starts running. It will fail if the <code class="literal">HideiAds</code> value is not set to <span class="emphasis"><em>zero</em></span>.</p><p>Save the <code class="literal">GameInfo</code> class.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec27"></a>Purchasing remove iAds</h4></div></div></div><p>The first thing <a id="id428" class="indexterm"></a>we need to do is finish setting up the iTunes Connect in-app purchases settings. Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Navigate to <a class="ulink" href="https://itunesconnect.apple.com" target="_blank">https://itunesconnect.apple.com</a>.</p></li><li><p>Sign in using your developer account.</p></li><li><p>Then, go to <span class="strong"><strong>My Apps</strong></span>.</p></li><li><p>Select your app, the one we created in <a class="link" href="#" linkend="ch01">Chapter 1</a>, <span class="emphasis"><em>Requirements and Preparation Work</em></span>.</p></li><li><p>Now, click on <span class="strong"><strong>In-App Purchases.</strong></span></p></li><li><p>It should have a red circle that says <span class="strong"><strong>Waiting for Screenshot</strong></span>.</p></li><li><p>Click on <span class="strong"><strong>Edit</strong></span> next to <span class="strong"><strong>In-App Purchase Details</strong></span>.</p></li><li><p>Make sure that <span class="strong"><strong>No</strong></span> is selected for <span class="strong"><strong>Hosting Content With Apple</strong></span>.</p></li><li><p>You do <span class="emphasis"><em>not</em></span> need to include <span class="strong"><strong>Review Notes</strong></span>.</p></li><li><p>Now, select <span class="strong"><strong>File</strong></span>.</p></li><li><p>Navigate to the book <code class="literal">Art</code> files and search for the <code class="literal">ChapterSix_InApp</code> folder.</p></li><li><p>Select <code class="literal">RemoveIAds.png</code>. (This will only work if you plan on using the UI we created. If you create your own game or your own UI art, you will need to include a screenshot for this.)</p></li><li><p>Go back to<span class="strong"><strong> My Apps</strong></span> and select your game again.</p></li><li><p>Scroll down to the <span class="strong"><strong>In-App Purchases</strong></span> section and click on the plus symbol to add a purchase.</p></li><li><p>Select our <span class="strong"><strong>G_RemoveAds</strong></span> purchase.</p></li><li><p>Then, click on <span class="strong"><strong>Save</strong></span> in the top-right corner.</p></li><li><p>Now, scroll to the top of the web page and click on the <span class="strong"><strong>My Apps</strong></span> drop-down list and then select <span class="strong"><strong>Users</strong></span> <span class="strong"><strong>and</strong></span> <span class="strong"><strong>Roles</strong></span>.</p></li><li><p>Then, click on <span class="strong"><strong>Sandbox Testers</strong></span> on the <span class="strong"><strong>Users and Roles</strong></span> page.</p></li><li><p>Now, click on the small plus sign next to <span class="strong"><strong>Testers</strong></span> to add one.</p></li><li><p>Enter the relevant information on this page. The e-mail has to be something other than what you normally use. This is a bit of an annoyance, but this is how the testing needs to be set up (as of writing this book).</p></li><li><p>When on <a id="id429" class="indexterm"></a>your iOS device, make sure to sign out of your normal account and use this testing account for testing purposes.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec28"></a>New RemoveiAds Purchase for coins</h4></div></div></div><p>In order for <a id="id430" class="indexterm"></a>us to remove iAds for the cost of coins, we need to create another in-app purchase. Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In <span class="strong"><strong>iTunes Connect</strong></span>, navigate to <span class="strong"><strong>My Apps</strong></span> and click on your game.</p></li><li><p>Now, click on the <span class="strong"><strong>In-App Purchases</strong></span> section at the top of the page.</p></li><li><p>Then, click on <span class="strong"><strong>Add New</strong></span> on the <span class="strong"><strong>In-App Purchases</strong></span> page.</p></li><li><p>Select <span class="strong"><strong>Non-Consumable</strong></span>.</p></li><li><p>Then, select <span class="strong"><strong>Reference Nam</strong></span>e as <span class="strong"><strong>Remove_Ads_Coins</strong></span>.</p></li><li><p>Similarly, select <span class="strong"><strong>Product ID</strong></span> as <span class="strong"><strong>G_RemoveAdsCoins</strong></span>.</p></li><li><p>Then, select <span class="strong"><strong>Cleared For Sale</strong></span> as <span class="strong"><strong>No</strong></span>.</p></li><li><p>Now, select <span class="strong"><strong>Price Tier</strong></span> as <span class="strong"><strong>Free</strong></span>.</p></li><li><p>Then, select <span class="strong"><strong>Screenshot For Review</strong></span> as <code class="literal">ChapterSix_InApp</code>, <code class="literal">Remove IAds.png</code>, or what's suitable for you.</p></li><li><p>Select <span class="strong"><strong>Add Language</strong></span> as <span class="strong"><strong>English</strong></span> or whatever suits you.</p></li><li><p>Select <span class="strong"><strong>Hosting Content With Apple</strong></span> as <span class="strong"><strong>No</strong></span>.</p></li><li><p>Also, select<span class="strong"><strong> Review Notes</strong></span> as <span class="strong"><strong>None</strong></span>.</p></li><li><p>Finally, click on <span class="strong"><strong>Done</strong></span> to save this.</p></li></ol></div><p>We want this to be free because we will check to see how many coins the player has before purchasing. We also want the player to keep the purchase if they did use coins to buy it.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec29"></a>The In App Purchase code</h4></div></div></div><p>Go back to <a id="id431" class="indexterm"></a>Unity. In the <code class="literal">Assets/Scripts</code> folder, double-click on the <code class="literal">GameInfo</code> class to open it. In the <code class="literal">Awake</code> function, before the <code class="literal">GameCenterManager</code> code, but under the <code class="literal">FadeObject</code> code, add the following code:</p><div class="informalexample"><pre class="programlisting">// RemoveAds as Product
IOSInAppPurchaseManager.instance.addProductId( "G_RemoveAds" );
IOSInAppPurchaseManager.instance.addProductId( "G_RemoveAdsCoins" );

// Add listening for Delegates
IOSInAppPurchaseManager.instance.addEventListener( IOSInAppPurchaseManager.RESTORE_TRANSACTION_FAILED, OnRestoreTransactionFailed );
IOSInAppPurchaseManager.instance.addEventListener( IOSInAppPurchaseManager.VERIFICATION_RESPONSE, OnVerificationResponse );

// Assign delegates 
IOSInAppPurchaseManager.instance.OnStoreKitInitComplete += OnStoreKitComplete;
IOSInAppPurchaseManager.instance.OnTransactionComplete += OnTransactionComplete;

// Load the store.
IOSInAppPurchaseManager.instance.loadStore( );</pre></div><p>This is similar to what we did with the <code class="literal">GameCenterManager</code> setup. The only difference this time is that it's specific for <code class="literal">IOSInAppPurchaseManager</code>.</p><p>We start by adding a product ID, using <code class="literal">addProductID</code>, which takes the name of our purchase: <code class="literal">G_RemoveAds</code>.</p><p>We will then set up a couple of event listeners. This will be used for delegate calls when events related to <code class="literal">InAppPurchase</code> are called.</p><p>Let's assign a couple of more delegates to <code class="literal">OnStoreKitInitComplete</code> and <code class="literal">OnTransactionComplete</code>.</p><p>Finally, we will load the store using the <code class="literal">loadStore</code> function, which prepares the store to be used.</p><p>Next, we need to add the function calls that are used for the delegates. At the <span class="emphasis"><em>bottom</em></span> of the <code class="literal">GameInfo</code> class, under the <code class="literal">ShowIAds</code> function, start by adding this function:</p><div class="informalexample"><pre class="programlisting">    // Transaction Complete
    private static void OnTransactionComplete(IOSStoreKitResponse Response)
    {
      GameInfo game = FindObjectOfType&lt;GameInfo&gt;();
      switch (Response.state)
      {
        case InAppPurchaseState.Purchased:
        case InAppPurchaseState.Restored:
          game.ShowSuccessScreen( true );
          game.HaveUnlockedIAds( Response.productIdentifier == "G_RemoveAdsCoins", Response.state == InAppPurchaseState.Restored );
            break;
        case InAppPurchaseState.Deferred:
          break;
        case InAppPurchaseState.Failed:
          game.ShowFailScreen( true );
            break;
      }
    }</pre></div><p>This is called when a transaction has been completed, including if the transaction fails for any reason. We start using this by getting a reference to the <code class="literal">GameInfo</code> class by using the <code class="literal">FindObjectOfType</code> function. We do this because this function is a <span class="strong"><strong>static</strong></span> function, meaning it is usable even if there is no reference to the class instance. Due of this, the static function sort of lives in its own portion of code and doesn't know of the reference of the <code class="literal">GameInfo</code>, although it exists within it, which is why we need a reference to it.</p><p>From there, we use a switch statement and check the <code class="literal">Response.state</code>. If the state is <code class="literal">Purchased</code> or <code class="literal">Restored</code>, we show the success screen with <code class="literal">ShowSuccessScreen</code> and then call a function in <code class="literal">GameInfo</code> called <code class="literal">HaveUnlockIAds</code> and pass <code class="literal">productIdentifier</code> as <span class="emphasis"><em>equal</em></span> to <code class="literal">G_RemoveAdsCoins</code>. This means that if the product ID of the purchase is from coins, we know that because the bool value passed <code class="literal">HaveUnlockedIAds</code>, it will be set to <span class="emphasis"><em>true</em></span>. This is the same for if the response state is <span class="emphasis"><em>equal</em></span> to <code class="literal">Restored</code>.</p><p>The next three functions are delegates used by the store manager, but for our game, we do not need them. Just in case you do, use the following code:</p><div class="informalexample"><pre class="programlisting">    // Verification response
    private static void OnVerificationResponse(CEvent e)
    {
      // Verified response on purchase
    }

    // Transaction failed
    private static void OnRestoreTransactionFailed()
    {
      // Transaction failed
    }

    // StoreKit Init
    private static void OnStoreKitComplete(ISN_Result result)
    {
      // Store was completed Init
      if (result.IsSucceeded)
      {
        // succeeded
      }
      else
      {
        // failed
      }
    }</pre></div><p><code class="literal">OnVerificationResponse</code> is used when a store purchased has been verified.</p><p><code class="literal">OnRestoreTransactionFailed</code> is used when a restore transaction has failed; we will use our <code class="literal">OnTransactionComplete</code> function to handle restore purchases.</p><p><code class="literal">OnStoreKitComplete</code> is used when the store has been initialized.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec30"></a>The Purchase RemoveIAds functions</h4></div></div></div><p>Under <a id="id432" class="indexterm"></a>
<code class="literal">OnStoreKitComplete</code>, add the following function:</p><div class="informalexample"><pre class="programlisting">    // Purchase was successful, remove coins, and hide ad banner
    public void HaveUnlockedIAds(bool bForCoins, bool bRestored)
    {
      if (bForCoins &amp;&amp; !bRestored)
      {
        GameCharacter.AddCoins(-10000);
      }

      PlayerPrefs.SetInt("ShowiAds", 1);
      if (AdBanner != null)
      {
        AdBanner.Hide();
        AdBanner = null;
      }
    }</pre></div><p>This is the function we will call from <code class="literal">OnTransactionComplete</code> if the purchase succeeded or the restore purchase succeeded.</p><p>Let's start by checking whether the <code class="literal">bForCoins</code> argument is set to <span class="emphasis"><em>true</em></span> and <code class="literal">bRestored</code> is set to <span class="emphasis"><em>false</em></span> because we don't want to dock the player if the purchase is being restored. If it is, we subtract the <span class="emphasis"><em>ten thousand</em></span> coin cost from the character using <code class="literal">AddCoins</code>. If we pass a negative value into it, it will subtract the amount.</p><p>Next, we will set the <code class="literal">ShowIAds</code> int value, which we save with <code class="literal">PlayerPrefs</code> to <span class="emphasis"><em>one</em></span>. This way, <code class="literal">AdBanner</code> won't show anymore. Then, we need to check whether the <code class="literal">AdBanner</code> exists by checking it <span class="emphasis"><em>against</em></span> null. If it does, we hide it using the Hide function and then set the <code class="literal">AdBanner</code> reference to null.</p><p>Lastly, we need a function that gets called from <span class="strong"><strong>MenuUI</strong></span> when the player taps a button to buy something. Add the following code under the <code class="literal">HaveUnlockedIAds</code> function:</p><div class="informalexample"><pre class="programlisting">    // Tries to purchase RemoveiAds
    public void UnlockRemoveAds(bool bForCoins)
    {
      if (bForCoins)
      {
        if ( GameCharacter.CoinCount &gt;= 10000)
        {
          IOSInAppPurchaseManager.instance.buyProduct("G_RemoveAdsCoins");
          ShowPurchaseScreen(false);
        }
      }
      else
      {
        IOSInAppPurchaseManager.instance.buyProduct("G_RemoveAds");
        ShowPurchaseScreen(false);
      }
    }</pre></div><p>If the purchase is for coins, we then check whether the character has <span class="emphasis"><em>ten thousand</em></span> or more coins. If <a id="id433" class="indexterm"></a>they do, we can use <code class="literal">IOSInAppPurchaseManager</code> to buy the product with <code class="literal">buyProduct</code>. We also pass the product ID for the remove ads with coins. We then close the purchase screen so that it doesn't stay open during the purchase process. If the player is trying to pay with coins, but doesn't have enough coins, the window will simply stay open and nothing will happen.</p><p>If the purchase is <span class="emphasis"><em>not</em></span> for coins, we will again use <code class="literal">IOSInAppPurchaseManager</code> to buy a product, but we can pass the product that costs <span class="emphasis"><em>ninety nine</em></span> cents. Again, close the purchase screen.</p><p>Now, save the <code class="literal">GameInfo</code> class and go back to Unity.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec31"></a>Purchasing buttons</h4></div></div></div><p>If <code class="literal">RemoveAdsBackgroundScreen</code> is hidden, select it in <span class="strong"><strong>Hierarchy</strong></span> and use the <span class="strong"><strong>Inspector</strong></span> window to <a id="id434" class="indexterm"></a>unhide it by clicking on the small checkbox next to its name.</p><p>Select the button called <span class="strong"><strong>For Coins</strong></span> and search for <span class="strong"><strong>Inspector</strong></span>. In the <span class="strong"><strong>Button</strong></span> component, click on the small plus symbol to add an element to the <span class="strong"><strong>On Click ()</strong></span> list. Then, left-click and drag the <span class="strong"><strong>GameInfo</strong></span> GameObject onto the object field of the <span class="strong"><strong>On Click ()</strong></span> list. Click on the drop-down menu, navigate to <span class="strong"><strong>GameInfo</strong></span>, and select <span class="strong"><strong>UnlockRemoveAds.</strong></span> Then, <span class="emphasis"><em>check</em></span> the small checkbox under the drop-down list because this purchase is for coins.</p><p>Next, select the button called <span class="strong"><strong>For Cash</strong></span> and repeat the preceding steps. This time, do <span class="emphasis"><em>not</em></span> click on the small checkbox under the <span class="strong"><strong>On Click ()</strong></span> drop-down list because this purchase is for money.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec32"></a>Restoring purchases</h4></div></div></div><p>Open the <a id="id435" class="indexterm"></a>
<code class="literal">Assets/Scripts</code> folder and double-click on the <code class="literal">GameInfo</code> class to open it. At the <span class="emphasis"><em>bottom</em></span> of the class, add the following function:</p><div class="informalexample"><pre class="programlisting">    // Attempts to restore purchases
    public void RestorePurchases()
    {
      IOSInAppPurchaseManager.instance.restorePurchases( );
    }</pre></div><p>This will attempt to restore purchases and then call <code class="literal">OnTransactionComplete</code> so that we can handle how to use it.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip41"></a>Tip</h3><p>Apple requires you to have an extra button in the game to restore purchases. You cannot simply do this on purchase; they will not allow the game on the iTunes store if you do not have this extra <span class="strong"><strong>Restore Purchases</strong></span> button.</p></div><p>Now, save the <code class="literal">GameInfo</code> class and go back to Unity.</p><p>Select the <span class="strong"><strong>RestorePurchase</strong></span> button in <span class="strong"><strong>MenuUI</strong></span> and search for Inspector. In the Button component, click on the small plus symbol to add the <span class="strong"><strong>On Click ()</strong></span> list. Left-click and drag the <span class="strong"><strong>GameInfo</strong></span> GameObject onto the <span class="strong"><strong>On Click ()</strong></span> object field and then click on the drop-down list. Now, select <span class="strong"><strong>GameInfo</strong></span> and then <span class="strong"><strong>RestorePurchase</strong></span>.</p><p>Then, save the Unity scene.</p></div></div></div>