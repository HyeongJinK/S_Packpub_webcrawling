<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec36"></a>Writing Kongregate API code</h2></div></div><hr /></div><p>There are two scripts that we are going to have to make in order to get our <span class="strong"><strong>Wins</strong></span> scoring parameter saved and appearing in the leaderboards. The first one will set up Kongregate, make sure that the game is indeed on the Kongregate page, and inform the game about the API connection status.</p><p>The second script is <a id="id179" class="indexterm"></a>going to be about incrementing a score for the player who wins based on the goal the puck hits.</p><p>Without any further delay, the following is the code for the handshake script, which is called <code class="literal">KongregateAPI</code>:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

// You have to add System in order to access the Convert class
using System;

public class KongregateAPI : MonoBehaviour 
{
  // We are going to check this variable to confirm that
  // Kongregate connection is established
  public static bool isKongregate = false;
  
  // Player ID
  public static int userId;
  
  // Player account name. This can be used for greeting the player,
  // for example
  public static string userName;
  
  // Game ID
  public static string gameAuthToken;
  
  void Start()
  {
    // Establishing connection with Kongregate
    // Make sure that the game object this script is attached to
    // is in the first scene that gets loaded,
    // and that the name of the object it is attached to is KongregateAPI
    Application.ExternalEval(
    "if(typeof(kongregateUnitySupport) != 'undefined'){" + " kongregateUnitySupport.initAPI('" + gameObject.name +"','OnKongregateAPILoaded');" + "};" );
  }
  
  // This method gets called if the game is on Kongregate
  void OnKongregateAPILoaded(string userInfoString)
  {
    Debug.Log("Kongregate connection established.");
    
    isKongregate = true;
    
    // Kongregate returns a string of chars that we divide and save into variables
    string[] parms = userInfoString.Split("|"[0]);
    userId = Convert.ToInt32(parms[0]);
    userName = parms[1];
    gameAuthToken = parms[2];
  }
}</pre></div><p>This code is<a id="id180" class="indexterm"></a> fairly straightforward and does not require much explanation on top of the comments already given within the script. Only two things should be noted: <code class="literal">Application.ExternalEval</code> is what makes your Unity game communicate with the JavaScript of the page it is on. Unity sends a message in the form of a string of text to the page, which is picked up by Kongregate and interpreted as code. The contents of this string are using the Kongregate API, the full version of which  can be consulted here: <a class="ulink" href="http://www.kongregate.com/developer_center/docs/en/using-the-api-with-unity3d" target="_blank">http://www.kongregate.com/developer_center/docs/en/using-the-api-with-unity3d</a>. <code class="literal">ExternalEval</code> is a very common method for accessing external APIs.</p><p>It is imperative that the game object your script is attached to (as well as the script itself) is called <span class="strong"><strong>KongregateAPI</strong></span>. Create an empty game object in the <span class="strong"><strong>demo_lobby</strong></span> scene and attach the script to it, then save the scene.</p><p>Once the JavaScript code on the page is executed, Kongregate sends a callback message back to Unity. This message always takes the form of the <code class="literal">OnKongregateAPILoaded(string userInfoString)</code> method. This, too, is part of the API. We then separate the string that it gives us using the <code class="literal">|</code> symbol and save parts of it into variables.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip28"></a>Tip</h3><p>There is really no point in making the Kongregate API script into a Playmaker action, unless you don't want to use any components other that Playmaker in your game, in which case I will leave it up to you to do it: the process is similar to that which we used in <a class="link" href="#" linkend="ch05">Chapter 5</a>, <span class="emphasis"><em>Scripting and Custom Actions</em></span>.</p></div><p>Unless you have changed something in the winning condition, the game does not currently distinguish between player 1 and 2 winning, and simply restarts the game no matter what happens. However, due to the fact that we have a multiplayer mode and want to save each player's wins, this does not work for us anymore. We are going to need to make the goal trigger into prefabs and spawn them the way we already spawn the goals and the mallets; then, when the puck hits one of them, detect if it belongs to us, and, if it does not, send the win to Kongregate.</p><p>To begin with, let us prepare a <a id="id181" class="indexterm"></a>Playmaker action that sends wins to Kongregate.</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

namespace HutongGames.PlayMaker.Actions
{
  [ActionCategory(ActionCategory.Level)]
  [Tooltip("Increment the Wins variable on Kongregate.")]
  public class KongregateSendAction : FsmStateAction 
  {
    public override void OnEnter()
    {
      if (KongregateAPI.isKongregate)
      Application.ExternalCall("kongregate.stats.submit", "Wins", 1);
    }
  }
}</pre></div><p>Here <code class="literal">Application.ExternalCall</code> is used. It calls an external function in the page as opposed to <code class="literal">ExternalEval</code>, which evaluates a code snippet that may or may not contain function calls.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip29"></a>Tip</h3><p><code class="literal">ExternalCall</code> and <code class="literal">ExternalEval</code> both only work in Unity Webplayer.</p></div><p>Follow these steps in order to increment the<a id="id182" class="indexterm"></a> <span class="strong"><strong>Wins</strong></span> statistic on <a id="id183" class="indexterm"></a>Kongregate:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open the <span class="strong"><strong>demo_room</strong></span> scene.</p></li><li><p>Create a prefab called <code class="literal">GoalTrigger</code>, then drag the <span class="strong"><strong>GoalTriggerLeft</strong></span> game object to it from <span class="strong"><strong>Hierarchy</strong></span>.</p></li><li><p>Delete both <span class="strong"><strong>GoalTriggerLeft</strong></span> and <span class="strong"><strong>GoalTriggerRight</strong></span> game objects from the scene; we are going to spawn them on startup.</p></li><li><p>Select the <span class="strong"><strong>Game</strong></span> game object and, in its <span class="strong"><strong>Game Manager</strong></span> FSM, add a <span class="strong"><strong>GameObject</strong></span> variable called <span class="strong"><strong>goalTriggerRef</strong></span>.</p></li><li><p>Navigate to this FSM's instantiate player state. Add a new <span class="strong"><strong>Photon Network Instantiate</strong></span> action to this state. Set the <span class="strong"><strong>Game Object</strong></span> property to <span class="strong"><strong>GoalTrigger</strong></span>, <span class="strong"><strong>Position</strong></span> to <code class="literal">(-9</code>, <code class="literal">0.42</code>, <code class="literal">0</code>), <span class="strong"><strong>Rotation</strong></span> to (<code class="literal">0</code>, <code class="literal">90</code>, <code class="literal">0</code>), and <span class="strong"><strong>Store Object</strong></span> to <span class="strong"><strong>goalTriggerRef</strong></span>.</p></li><li><p>Open the <span class="strong"><strong>Create Puck</strong></span> state and add a <span class="strong"><strong>Set Position</strong></span> action to it. In this action, set the <span class="strong"><strong>Game Object</strong></span> property to <span class="strong"><strong>Specify Game Object</strong></span>, then set it to the <span class="strong"><strong>goalTriggerRef</strong></span> variable. Set <span class="strong"><strong>Vector</strong></span>, <span class="strong"><strong>Y</strong></span>, and <span class="strong"><strong>Z</strong></span> to <span class="strong"><strong>None</strong></span> and <span class="strong"><strong>X</strong></span> to <code class="literal">9</code>.</p></li><li><p>Now that we have set up the instantiation of our goal triggers, we need to send our scores to Kongregate. Select the <code class="literal">GoalTrigger</code> prefab in the Project panel and add a <span class="strong"><strong>Photon View</strong></span> component to it, then drag its <span class="strong"><strong>Transform</strong></span> component into the <span class="strong"><strong>Observe</strong></span> slot of <span class="strong"><strong>Photon View</strong></span>.</p></li><li><p>Add a <span class="strong"><strong>PlayMaker Photon GameObject Proxy</strong></span> component to the prefab.</p></li><li><p>In the <span class="strong"><strong>playMaker</strong></span> panel, make the FSM look as shown in the following figure, adding all the missing states, events, and transitions.</p><div class="mediaobject"><img src="/graphics/9781849698108/graphics/8108OT_07_02.jpg" /></div></li><li><p>Add a <a id="id184" class="indexterm"></a>
<span class="strong"><strong>Photon View Get Is Mine</strong></span> action to the <span class="strong"><strong>is mine?</strong></span> state. Set <a id="id185" class="indexterm"></a>
<span class="strong"><strong>Is Mine Event</strong></span> to <span class="strong"><strong>YES</strong></span> and <span class="strong"><strong>Is Not Mine Event</strong></span> to <span class="strong"><strong>NO</strong></span>, provided that you have created the <span class="strong"><strong>YES</strong></span> and <span class="strong"><strong>NO</strong></span> events in the <span class="strong"><strong>Events</strong></span> tab before. If you haven't, go ahead and do it now.</p></li><li><p>Add <span class="strong"><strong>Kongregate Send Action</strong></span> to the <span class="strong"><strong>KongregateSend</strong></span> state. This is the action that we created earlier.</p></li><li><p>Save the scene.</p></li></ol></div><p>Now, if you build the game, upload it to Kongregate, play, and win, a score will be added. You should see a <span class="strong"><strong>HIGH SCORE</strong></span> tab appear on the right on your game's page.</p><p>If it does not, don't worry, sometimes it can take some time for the first score to be submitted. If you feel like there is a problem, you can see exactly what commands Kongregate exchanges with your game by opening the JavaScript console of your internet browser while on the game's page.</p><p>Once you are sure that the game is working well and the <span class="strong"><strong>Wins</strong></span> statistic is being submitted properly, you can either try adding some more stats or just publish the game by pressing the appropriate link near the top of the page. Then you can test it by either sending the public link to your friends or by opening it twice yourself and joining the same server.</p></div>