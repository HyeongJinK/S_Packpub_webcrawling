<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec18"></a>Finite state machines, states, and actions</h2></div></div><hr /></div><p>We have talked about game objects and components. Now it is time to have a look at Playmaker FSMs, states, and actions in them.</p><p>An FSM<a id="id80" class="indexterm"></a> in Playmaker is a graph that consists of states and transitions between them, attached to a game object. It allows for a way of visual programming using different states of the graph and events that trigger transitions to other states.</p><p>If you select the <code class="literal">Wall</code> prefab and open the <span class="strong"><strong>playMaker</strong></span> panel, you will see that its FSM has two states: the default <span class="strong"><strong>Start</strong></span> state where everything begins and another one called <span class="strong"><strong>State 1</strong></span> by default, with an arrow connecting the former to the latter. The arrow is a transition. You cannot remove the Start state or the one it is connected to, because if you could you would not need the FSM attached to the object. However, you can create new states and define transitions to them.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip12"></a>Tip</h3><p>You can navigate the FSM view almost exactly the same way you would do the <span class="strong"><strong>Scene</strong></span> view. Use the middle mouse button to drag the view. Use the left mouse button to move the states around. This does not change anything in the logic of the state machine, but lets you organize everything the way that makes sense to you, as well as look at the parts of the graph that you are most interested in at the moment if the whole state machine is too big to be shown at once.</p></div><p>A state<a id="id81" class="indexterm"></a> in FSM is empty by default and does not do anything, a lot like an empty game object without any components attached to it. In order to make a state do something, you need to attach actions to it.</p><p>As we have seen in <a class="link" href="#" linkend="ch02">Chapter 2</a>, <span class="emphasis"><em>Unity's and Playmaker's</em></span> <span class="emphasis"><em>User Interface</em></span>, you can add an FSM to an object by selecting the latter, right-clicking in the FSM view of the <span class="strong"><strong>playMaker</strong></span> panel, and then selecting <span class="strong"><strong>Add FSM</strong></span> from the contextual menu. You can remove an object from the Playmaker control by right-clicking the header of the Playmaker FSM (<span class="strong"><strong>Script</strong></span>) component in <span class="strong"><strong>Inspector</strong></span> and selecting <span class="strong"><strong>Remove Component</strong></span> from the contextual menu. This will remove the FSM and erase all of the changes you made to it, including added states and transitions. An object has an FSM attached to it if there is a red Playmaker hieroglyph icon (<span class="inlinemediaobject"><img src="/graphics/9781849698108/graphics/8108OT_03_07.jpg" /></span>) next to its name in the <span class="strong"><strong>Hierarchy</strong></span> panel.</p><p>As an example for this book, we will be making a version of the classic air hockey game. In order to begin, we will need to add a puck and a mallet. In this chapter, you will make the mallet move based on the mouse position and push the puck as you would expect it to do in real life.</p><p>Right now in your scene there are four walls, a background quad, a camera, and a directional light (created in <a class="link" href="#" linkend="ch02">Chapter 2</a>, <span class="emphasis"><em>Unity's and Playmaker's User Interface</em></span>). Now it is time to make things interactive. Let us start with a mallet.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new cylinder primitive by selecting <span class="strong"><strong>GameObject</strong></span> | <span class="strong"><strong>Create Other</strong></span> | <span class="strong"><strong>Cylinder</strong></span> in the main menu.</p></li><li><p>Rename this game object to <code class="literal">Mallet</code> and make a dark green (RGB color set to <code class="literal">10</code>, <code class="literal">155</code>, <code class="literal">10</code> in the <span class="strong"><strong>Color</strong></span> window) material called <span class="strong"><strong>MalletMaterial</strong></span> for it, then assign the material to it, as you did for the <code class="literal">Wall</code> prefab before.</p></li><li><p>Set the scale of <span class="strong"><strong>Mallet</strong></span> to (<code class="literal">1.35</code>, <code class="literal">1.35</code>, <code class="literal">1.35</code>) and its position to (<code class="literal">-6.5</code>, <code class="literal">1.45</code>, <code class="literal">0</code>).</p></li><li><p>Now we are going to make the<a id="id82" class="indexterm"></a> mallet move. First of all, we need to add a component called <span class="strong"><strong>Character Controller</strong></span> to it. This component is in charge of character physics. Select <span class="strong"><strong>Mallet</strong></span>, then click on the <span class="strong"><strong>Add Component</strong></span> button near the bottom of the <span class="strong"><strong>Inspector</strong></span> panel. Type <code class="literal">Character Controller</code> in the search bar, and then double-click on the <span class="strong"><strong>Character Controller</strong></span> item in the list (as shown in the following screenshot). When Unity asks you if you want to replace the existing <span class="strong"><strong>CapsuleCollider</strong></span> component, click on <span class="strong"><strong>Replace</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781849698108/graphics/8108OT_03_08.jpg" /></div></li><li><p>In the <span class="strong"><strong>Character Controller</strong></span> <a id="id83" class="indexterm"></a>component, set the <span class="strong"><strong>Skin Width</strong></span> property to <code class="literal">0</code> (it will be set to the minimum possible value, which is <code class="literal">0.0001</code>). We are doing this to make sure that our mallet's collisions look precise.</p></li><li><p>Add an FSM to Mallet by selecting it, right-clicking in the FSM view of the <span class="strong"><strong>playMaker</strong></span> panel, and selecting <span class="strong"><strong>Add FSM</strong></span> from the contextual menu.</p></li><li><p>Select <span class="strong"><strong>State 1</strong></span>, then in the <span class="strong"><strong>State</strong></span> tab on the right of the <span class="strong"><strong>playMaker</strong></span> panel enter <code class="literal">Move</code> in the first text field from the top. It is responsible for the name of the currently selected state. When you enter the new name, you should see the state change in the FSM view as well.</p></li><li><p>Keeping the <span class="strong"><strong>Move</strong></span> state selected, open the <span class="strong"><strong>Actions</strong></span> panel (it should be attached to the same area of the <span class="strong"><strong>Editor</strong></span> window as the <span class="strong"><strong>Inspector</strong></span> panel; alternatively, click on the <span class="strong"><strong>Action Browser</strong></span> button on the bottom-right of the <span class="strong"><strong>State</strong></span> tab) and find the <span class="strong"><strong>Mouse Pick</strong></span> action under the <span class="strong"><strong>Input</strong></span> category. Click on it, then click on the <span class="strong"><strong>Add Action To State</strong></span> button in the bottom-right corner of the panel. You should notice that the <span class="strong"><strong>Mouse Pick</strong></span> action appeared in the <span class="strong"><strong>State</strong></span> tab of the <span class="strong"><strong>playMaker</strong></span> panel.</p><p>This action gets the cursor position in 3D space when you hover an object. Under the hood it draws an invisible ray (this action is called <a id="id84" class="indexterm"></a>
<span class="strong"><strong>raycast</strong></span>) from the mouse position on the camera's near clipping plane (you can see it as one of the white gizmo rectangles in the <span class="strong"><strong>Scene</strong></span> view when you select <span class="strong"><strong>Main Camera</strong></span>). If there is something in the way of the ray, a ray hit gets detected, and Unity finds out where exactly it happened. In our case, we will use the background quad to get the position of the mouse cursor, and then make the mallet follow it.</p></li><li><p>In order to pick a correct <a id="id85" class="indexterm"></a>ray-hit position, we need to make sure that nothing else gets in the way of the ray. To do this, we will tell the ray to interact only with the background quad. Select the <span class="strong"><strong>Quad</strong></span> game object and rename it <code class="literal">Background</code> for clarity. Then find the <span class="strong"><strong>Layer</strong></span> drop-down menu in the top-right corner of the <span class="strong"><strong>Inspector</strong></span> panel, click on the drop-down button that says <span class="strong"><strong>Default</strong></span> by default, and press <span class="strong"><strong>Add Layerâ€¦</strong></span> in it. The appearance of <span class="strong"><strong>Inspector</strong></span> should now change to reveal a list of tags and layers as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849698108/graphics/8108OT_03_09.jpg" /></div><p>This menu is called <span class="strong"><strong>TagManager</strong></span>. Click on the right of <span class="strong"><strong>User Layer 8</strong></span> and enter <code class="literal">Background</code> in the edit field that appears, then press <span class="emphasis"><em>Return</em></span> on your keyboard. Select the <span class="strong"><strong>Background</strong></span> object again and set its layer to <span class="strong"><strong>Background</strong></span> by choosing the appropriate element from the drop-down <span class="strong"><strong>Layer</strong></span> list you used to access the <span class="strong"><strong>TagManager</strong></span> before.</p></li><li><p>Select <a id="id86" class="indexterm"></a>
<span class="strong"><strong>Mallet</strong></span> again. In the <span class="strong"><strong>Mouse Pick</strong></span> action of the <span class="strong"><strong>Move</strong></span> state, set the <span class="strong"><strong>Layer Mask</strong></span> parameter to <code class="literal">1</code>. This determines how many layers you will set to interact with the raycast. <span class="strong"><strong>Element 0</strong></span> should appear below. In the drop-down list to its right, select the <span class="strong"><strong>Background</strong></span> layer you created before.</p></li><li><p>From now on, the raycast in the <span class="strong"><strong>Mouse Pick</strong></span> action will ignore all objects that are not in the <span class="strong"><strong>Background</strong></span> layer. Now we need to store the ray-hit position in a variable. Go to the <span class="strong"><strong>Variable</strong></span> tab of the <span class="strong"><strong>playMaker</strong></span> panel and enter <code class="literal">mousePos</code> in the <span class="strong"><strong>New Variable</strong></span> field on the bottom. Click on the <span class="strong"><strong>Add</strong></span> button. Set the <span class="strong"><strong>Variable Type</strong></span> to <span class="strong"><strong>Vector3</strong></span>. A <span class="strong"><strong>Vector 3</strong></span> variable contains three numbers: <span class="strong"><strong>X</strong></span>, <span class="strong"><strong>Y</strong></span>, and <span class="strong"><strong>Z</strong></span>.</p></li><li><p>Go back to the <span class="strong"><strong>State</strong></span> tab and set the <span class="strong"><strong>Store Point</strong></span> property of the <span class="strong"><strong>Mouse Pick</strong></span> action to <span class="strong"><strong>mousePos</strong></span>. This will save the position of the ray hit in the <span class="strong"><strong>Vector3</strong></span> type variable that you just created. Finally, check the <span class="strong"><strong>Every Frame</strong></span> property checkbox on the bottom of the <span class="strong"><strong>Mouse Pick</strong></span> action to make sure that the mouse position is updated continuously as opposed to just once in the beginning of the game.</p></li><li><p>Add the action called <span class="strong"><strong>Controller Simple Move</strong></span> located under the <span class="strong"><strong>Character</strong></span> category of the <span class="strong"><strong>Actions</strong></span> panel to your <span class="strong"><strong>Move</strong></span> state. It should appear just below the <span class="strong"><strong>Mouse Pick</strong></span> action. If it appears above it, you can move it down by clicking and dragging it by its header.</p><p>It is important to note that the order of actions in the state matters: the actions mentioned earlier will be executed before the ones that are mentioned later, so if you want to use a variable set in the <span class="strong"><strong>Mouse Pick</strong></span> action, you must make sure that <span class="strong"><strong>Mouse Pick</strong></span> is above whatever action is going to use it (in our case it is <span class="strong"><strong>Controller Simple Move</strong></span>).</p></li><li><p>Set the <span class="strong"><strong>Move Vector</strong></span> property of the <span class="strong"><strong>Controller Simple Move</strong></span> action to <span class="strong"><strong>mousePos</strong></span>. Leave the rest of the properties at their default values.</p></li></ol></div></div>