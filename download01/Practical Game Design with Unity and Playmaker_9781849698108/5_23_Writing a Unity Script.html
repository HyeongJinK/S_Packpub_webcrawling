<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec26"></a>Writing a Unity Script</h2></div></div><hr /></div><p>Explaining how <a id="id113" class="indexterm"></a>programming works in general is beyond the scope of this book, so I am going to assume that you already know what variables, functions, classes, and operators are. If, however, you do not know these things, it should not take you too long to pick up the basics using either Code Academy<a id="id114" class="indexterm"></a> (<a class="ulink" href="http://www.codecademy.com/tracks/javascript" target="_blank">http://www.codecademy.com/tracks/javascript</a>) or <a id="id115" class="indexterm"></a>Unity's own starting level tutorials (<a class="ulink" href="http://unity3d.com/learn/tutorials/modules/beginner/scripting" target="_blank">http://unity3d.com/learn/tutorials/modules/beginner/scripting</a>).</p><p>We are going to start with <span class="strong"><strong>JavaScript</strong></span> (<span class="strong"><strong>JS</strong></span>)<a id="id116" class="indexterm"></a> in this section, because it is much simpler to use and does not require any understanding of object-oriented programming beyond the component-based approach to development that we already discussed in <a class="link" href="#" linkend="ch03">Chapter 3</a>, <span class="emphasis"><em>Components and State Machines</em></span>. Besides, you will end up writing significantly less code.</p><p>Both JS and C# use the same Unity classes and functions, and the difference in syntax is not very significant at all. However, for more complex things it is generally a good idea to use C# (for one thing, it is currently impossible to write a Playmaker action in JavaScript). We will start with a JS script and then translate it into C#, explaining the differences. You can later choose whichever language works better for you.</p><p>We are going to create a<a id="id117" class="indexterm"></a> script that replaces all the Playmaker actions in the <span class="strong"><strong>Push Puck</strong></span> state of both mallets' FSMs. When you see that you have to make a chain of five or more actions, it is generally easier to combine them in a single custom action, especially if you are planning to use this compound action on multiple objects.</p><p>Let us start by creating a new script. First of all, create a new folder named <code class="literal">Scripts</code> using the <span class="strong"><strong>Project</strong></span> panel. Then, right-click on the newly created folder and navigate to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Javascript</strong></span>. Name the file <code class="literal">PushPuck</code>. Double-click on the file. The standard Unity programming environment, MonoDevelop, should open. Select everything there is in that script and replace it with the following code:</p><div class="informalexample"><pre class="programlisting">// Automatically added, compiler =directive 
// that makes JavaScript more explicit
#pragma strict

// Global variables available from Inspector
var pushMag : float = 20f;

var collisionTag : String = String.Empty;

// Function that will detect the collision with 
// controller and apply force in point of the collision
function OnControllerColliderHit (hit : ControllerColliderHit) 
{
  if (hit.gameObject.tag == collisionTag)
  {
    // Get the position of the object we collided with
    var hitObjectPos : Vector3 = hit.transform.position;

    // Get the position of the collision
    var hitPointPos : Vector3 = hit.point;

    // Calculate the direction of the force, 
    // multiply it by magnitude
    var pushForce : Vector3 = Vector3.Normalize(hitObjectPos - hitPointPos) * pushMag;

    // Finally, apply force in position
    hit.rigidbody.AddForceAtPosition(pushForce, hitPointPos);

    // Print a message in Console saying that 
    //the collision did happen and force was indeed applied
    Debug.Log("Detected hit with " + collisionTag + ", applying force of " + pushForce + " in " + hitPointPos + ".");
  }
}
@script RequireComponent(CharacterController)</pre></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip18"></a>Tip</h3><p>You can download the example code files for all Packt Publishing books you have purchased from your account at <a class="ulink" href="http://www.packtpub.com" target="_blank">http://www.packtpub.com</a>. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.packtpub.com/support" target="_blank">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p></div><p>Press <span class="emphasis"><em>command</em></span> + <span class="emphasis"><em>S</em></span> (<span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>S</em></span> in Windows) in MonoDevelop to save the changes to the script.</p><p>Let us examine<a id="id118" class="indexterm"></a> this code line-by-line. The first line is <code class="literal">#pragma strict</code>. This is a preprocessor directive. If you have some previous programming experience, you have probably seen something similar before. It does not participate in script logic; what it does is make JavaScript more explicit by imposing more strict error handling in the compiler. What it means for you is that you have to explicitly define the types of your variables, which is something you would not normally do in standard JavaScript.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip19"></a>Tip</h3><p>Another common preprocessor directive for JS is <code class="literal">#pragma downcast</code>, which lets you get rid of warnings of implicit downcast if you do not care about them.</p></div><p>After that there are two lines of variable declaration: <code class="literal">pushMag</code> and <code class="literal">collisionTag</code> are declared as <code class="literal">float</code> and <code class="literal">String</code>. Once you attach this script to an object, these variables will be displayed in the Inspector, because they are both public and serialized. Since a script in Unity is treated as a component, variables appear as parameters in the Inspector once you attach the script to a game object.</p><p>If you want to declare a variable that does not appear in the Inspector, but want other scripts to still have access to it, you should put <code class="literal">[System.NonSerialized]</code> before it. If you want to both hide it and close all access to it, you just need to put <code class="literal">private</code> before the <code class="literal">var</code> keyword. Finally, if you want to expose a private variable in Inspector, you should put <code class="literal">[System.SerializableAttribute]</code> before its declaration.</p><p>Next goes the function declaration: <code class="literal">function</code> <code class="literal">OnControllerColliderHit</code> <code class="literal">(hit : ControllerColliderHit)</code>. <code class="literal">OnControllerColliderHit</code> is one of the standard Unity functions that are responsible for detecting collisions. Other such functions are <code class="literal">OnCollisionEnter</code>, <code class="literal">OnCollisionStay</code>, <code class="literal">OnCollisionExit</code>, <code class="literal">OnTriggerEnter</code>, <code class="literal">OnTriggerStay</code>, and <code class="literal">OnTriggerExit</code>.</p><p>The <code class="literal">OnControllerColliderHit</code> function<a id="id119" class="indexterm"></a> gets called automatically if the object that the script is attached to has a Character Controller component and that Character Controller collides with a collider. The <code class="literal">hit</code> variable of type <code class="literal">ControllerColliderHit</code> gets assigned and can be used inside the function. By typing <code class="literal">hit</code> and a dot, one can access all kinds of information about the collision.</p><p>For instance, inside the function there is an <code class="literal">if</code> condition: <code class="literal">if (hit.gameObject.tag == collisionTag)</code>. We access the <code class="literal">gameObject</code> that our Character Controller has collided with, using the dot operator, and then we use it again to access that tag in <code class="literal">gameObject</code>. Then we compare that tag with the <code class="literal">collisionTag</code> string variable that is assigned in the Inspector. If the tag matches the string we specified, the code inside the curly brackets is executed.</p><p>In this <a id="id120" class="indexterm"></a>script, we reproduced the exact sequence of actions in the <span class="strong"><strong>Push Puck</strong></span> state of the mallets' FSMs. You can consult it for reference. First, we get the position of the puck and store it in a <code class="literal">Vector3</code> variable called <code class="literal">hitObjectPos</code>. Then we get the point of the hit and store it in another <code class="literal">Vector3</code> variable called <code class="literal">hitPointPos</code>. We then calculate the force of the push in one step instead of three that we used in Playmaker. Finally, the force is applied to the puck's rigidbody.</p><p>After that there is a line with <code class="literal">Debug.Log</code> that prints information about every hit in the Console. You can comment this line out by typing <code class="literal">//</code> in front of it. Keep it uncommented for now to make sure that the script works.</p><p>The very last line of the script is <code class="literal">@script RequireComponent (CharacterController)</code>. It is there to make sure that there is a Character Controller component attached to the game object that this script is attached to. If you attach this script to a game object that does not have a Character Controller, it will be attached automatically. If you try to remove the Character Controller without removing <code class="literal">PushPuck</code> first, Unity will display a warning dialog window and not allow you to do it.</p><p>Now it is time to see if our newly created script works. Go back to Unity and open the <span class="strong"><strong>Console</strong></span> panel. If there are no red errors, this means that the script was compiled correctly and is ready to be used. If there is some kind of error in a script, double-clicking on it in the Console will open the script in MonoDevelop and direct you to the line where the error has occurred.</p><p>If everything is okay, select <span class="strong"><strong>MalletLeft</strong></span>, open the <span class="strong"><strong>playMaker</strong></span> panel and in the <span class="strong"><strong>Move</strong></span> state disable the <span class="strong"><strong>Collision</strong></span> <span class="strong"><strong>Event</strong></span> action by unchecking the box next to its name. If you start the game now, colliding with the puck will not push it. Now it is time to use our brand-new <code class="literal">PushPuck</code> script. Drag and drop the <code class="literal">PushPuck</code> file from the <span class="strong"><strong>Project</strong></span> panel to the <span class="strong"><strong>Inspector</strong></span> panel while having <span class="strong"><strong>MalletLeft</strong></span> selected. It will attach to it as a component. Set its parameters as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849698108/graphics/8108OT_05_01.jpg" /></div><p>Open the <span class="strong"><strong>Console</strong></span> panel and launch the game. Note how messages appear in the Console every time you hit the puck with your mallet. If you stop the game and double-click on one of the <code class="literal">Debug.Logs</code>, MonoDevelop will open and point you to the <code class="literal">Debug.Log</code> line of the <code class="literal">PushPuck</code> script. Now<a id="id121" class="indexterm"></a> that you know the script works, you can comment that line out in order to prevent it from spamming the console.</p><p>Also, now you can apply it to the AI opponent as well. Remember to deactivate the <span class="strong"><strong>Collision Event</strong></span> action first.</p></div>