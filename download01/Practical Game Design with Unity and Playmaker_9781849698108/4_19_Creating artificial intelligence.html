<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec23"></a>Creating artificial intelligence</h2></div></div><hr /></div><p>Having an <span class="strong"><strong>artificial intelligence</strong></span> (<span class="strong"><strong>AI</strong></span>)<a id="id104" class="indexterm"></a> in the game, even a really simple one, will definitely make it more challenging and fun, so let us get to it with no further delay.</p><p>Here is how our AI <a id="id105" class="indexterm"></a>is going to work: it is going to constantly try and move to the point on the right side of the puck, pushing it to the left upon collision. We will keep the same collision logic that we use for the player's mallet in order to keep the game fair. In order to make sure that the AI does not get stuck in a wall while pushing directly to the left, we will make adjustments to the direction based on the current position of the mallet. This way, the AI will appear to aim at the player's goal slot.</p><p>Follow the given steps to implement the AI:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Duplicate the <span class="strong"><strong>Mallet</strong></span> game object by selecting it in <span class="strong"><strong>Hierarchy</strong></span> and pressing <span class="emphasis"><em>command</em></span> + <span class="emphasis"><em>D</em></span> (<span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>D</em></span> in Windows).</p></li><li><p>Move the copy to the right side of the table and put it next to the red goal.</p></li><li><p>Name the original mallet on the left <code class="literal">MalletLeft</code>, and the copy on the right <code class="literal">MalletRight</code>.</p></li><li><p>Make a new red material for <span class="strong"><strong>MalletRight</strong></span> and assign it to it.</p></li><li><p>Put both mallets on a new layer called <span class="strong"><strong>Player</strong></span> using the <span class="strong"><strong>TagManager</strong></span> menu accessible from <span class="strong"><strong>Inspector</strong></span>.</p></li><li><p>In the main menu, go to <span class="strong"><strong>Edit</strong></span> | <span class="strong"><strong>Project Settings</strong></span> | <span class="strong"><strong>Physics</strong></span>. You will see a matrix of checkboxes with names of layers written horizontally and vertically next to each row and column in the <span class="strong"><strong>Inspector</strong></span> panel.</p></li><li><p>Find the intersection between <span class="strong"><strong>Player</strong></span> horizontally and <span class="strong"><strong>Player</strong></span> vertically and uncheck that box. Make sure that the rest of the boxes stay checked. This matrix determines which layers can interact with each other and with themselves, so if you accidentally uncheck something else, such as <span class="strong"><strong>Default</strong></span>/<span class="strong"><strong>Player</strong></span> or <span class="strong"><strong>Default</strong></span>/<span class="strong"><strong>Default</strong></span>, the puck may no longer collide with the goal triggers and the mallets may stop colliding with the walls.</p></li><li><p>Select the <span class="strong"><strong>MalletRight</strong></span> game object. In <span class="strong"><strong>Inspector</strong></span>, remove the <span class="strong"><strong>Character Controller</strong></span> component and add <span class="strong"><strong>Capsule Collider</strong></span>. Add a <span class="strong"><strong>Rigidbody</strong></span> component. Set <span class="strong"><strong>Freeze Rotation</strong></span> on the <span class="strong"><strong>Rigidbody</strong></span> component to X, Y and Z. If you don't, the red mallet will fall when you press play. <span class="strong"><strong>Rigidbody</strong></span> is the component responsible for physics interactions.</p></li><li><p>In the FSM view of the <span class="strong"><strong>playMaker</strong></span> panel, select the <span class="strong"><strong>Move</strong></span> state. It is here that we are going to set up the AI.</p></li><li><p>Remove all the <a id="id106" class="indexterm"></a>actions except <span class="strong"><strong>Collision Event</strong></span>. You can select multiple actions at the same time by <span class="emphasis"><em>Shift</em></span>-clicking their headers. Open the <span class="strong"><strong>Actions</strong></span> panel and add the following actions to the state, keeping in mind that the order of the actions matters, and moving <span class="strong"><strong>Collision Event</strong></span> to the very bottom: <span class="strong"><strong>Get Property</strong></span>, <span class="strong"><strong>Get Property</strong></span>, <span class="strong"><strong>Get Property</strong></span>, <span class="strong"><strong>Float Multiply</strong></span>, <span class="strong"><strong>Float Add</strong></span>, <span class="strong"><strong>Float Add</strong></span>, <span class="strong"><strong>Set Vector3 XYZ</strong></span>, and <span class="strong"><strong>Move Towards</strong></span>. The following screenshot shows the exact order of the actions that you should have in the <span class="strong"><strong>Move</strong></span> state of the FSM of <span class="strong"><strong>MalletRight</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781849698108/graphics/8108OT_04_08.jpg" /></div></li><li><p>In the <span class="strong"><strong>Events</strong></span> tab, add a new event, calling it <code class="literal">Return</code>.</p></li><li><p>Open the <span class="strong"><strong>Variables</strong></span> tab and add/remove variables until you have the variables shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849698108/graphics/8108OT_04_09.jpg" /></div></li><li><p>These are <a id="id107" class="indexterm"></a>the variables used for collision calculations that were left from before, and some new ones used for the simple AI behavior that we discussed earlier.</p></li><li><p>Go back to the <span class="strong"><strong>State</strong></span> tab and open the first <span class="strong"><strong>Get Property</strong></span> action. Drag and drop the <span class="strong"><strong>Puck</strong></span> game object into <span class="strong"><strong>Target Object</strong></span>, and set <span class="strong"><strong>Property</strong></span> to <span class="strong"><strong>transform</strong></span> | <span class="strong"><strong>position</strong></span> | <span class="strong"><strong>x</strong></span> and <span class="strong"><strong>Store Float</strong></span> to <span class="strong"><strong>puckX</strong></span>. Check <span class="strong"><strong>Every Frame</strong></span>. In fact, check <span class="strong"><strong>Every Frame</strong></span> every time you see this checkbox in this state.</p></li><li><p>Do the same for the second <span class="strong"><strong>Get Property</strong></span> tab, but choose <span class="strong"><strong>z</strong></span> instead of <span class="strong"><strong>x</strong></span> and <span class="strong"><strong>puckZ</strong></span> instead of <span class="strong"><strong>puckX</strong></span>. These actions are used to retrieve the position of the puck on the two axes that matter to us.</p></li><li><p>Open the third <span class="strong"><strong>Get Property</strong></span> action and drag <span class="strong"><strong>MalletRight</strong></span> into its <span class="strong"><strong>Target Object</strong></span> property; store its Z position in the offset variable.</p></li><li><p>In the <span class="strong"><strong>Float Multiply</strong></span> action, set <span class="strong"><strong>Float Variable</strong></span> to <span class="strong"><strong>offset</strong></span> and <span class="strong"><strong>Multiply By</strong></span> to <code class="literal">0.2</code>. This is where we define how hard the AI should try to aim the player's goal. If it tries too hard, it will miss. If it tries not hard enough, it will miss as well.</p></li><li><p>In the first <span class="strong"><strong>Float Add</strong></span> action, set <span class="strong"><strong>Float Variable</strong></span> to <span class="strong"><strong>puckX</strong></span> and the <span class="strong"><strong>Add</strong></span> property to <span class="strong"><strong>offset</strong></span>. You need to click on the option button on the right to do that. This is where the offset is actually applied.</p></li><li><p>In the second <span class="strong"><strong>Float Add</strong></span> action, set <span class="strong"><strong>Float Variable</strong></span> to <span class="strong"><strong>puckZ</strong></span>, and <span class="strong"><strong>Add</strong></span> to <code class="literal">0.9</code>. This value can be changed as you want later. It defines the distance between the actual center of the puck and the point to which the AI is going to move. It is very important that the AI aim somewhat to the right, because otherwise it will never be able to hit the player's goal.</p></li><li><p>In <span class="strong"><strong>Set Vector3 XYZ</strong></span>, set <span class="strong"><strong>Vector3 Variable</strong></span> to <span class="strong"><strong>targetPos</strong></span>, <span class="strong"><strong>X</strong></span> to <span class="strong"><strong>puckX,</strong></span> and <span class="strong"><strong>Z</strong></span> to <span class="strong"><strong>puckZ</strong></span>. Make sure that <span class="strong"><strong>Y</strong></span> is set to <span class="strong"><strong>None</strong></span>. This is where we define the actual position where the AI is going to try and go in the current frame.</p></li><li><p><span class="strong"><strong>Move Towards</strong></span> is the action that applies movement to the AI. Set <span class="strong"><strong>Target Position</strong></span> to <span class="strong"><strong>targetPos</strong></span>, <span class="strong"><strong>Max Speed</strong></span> to <code class="literal">5</code>, <span class="strong"><strong>Finish Distance</strong></span> to <code class="literal">0.15,</code> and <span class="strong"><strong>Finish Event</strong></span> to <span class="strong"><strong>Return</strong></span>.</p></li><li><p>Finally, open <a id="id108" class="indexterm"></a>
<span class="strong"><strong>Collision Event</strong></span> and change its <span class="strong"><strong>Collision</strong></span> property to <span class="strong"><strong>On Collision Stay</strong></span>; leaving everything else intact.</p></li><li><p>Now you might have an error in the <span class="strong"><strong>Move Towards</strong></span> action. That would be because there is no transition from the <span class="strong"><strong>Return</strong></span> event. Right-click the <span class="strong"><strong>Move</strong></span> state in the FSM view and add a transition from the <span class="strong"><strong>Return</strong></span> event to <span class="strong"><strong>Move</strong></span>. Yes, this is a state that loops on itself. The following figure shows the layout that you should see in the FSM view of <span class="strong"><strong>MalletRight</strong></span> now.</p><div class="mediaobject"><img src="/graphics/9781849698108/graphics/8108OT_04_10.jpg" /></div></li></ol></div><p>If you click on the play button right now, the AI should be completely functional and, in fact, quite strong. Now, there are ways of improving it that will be discussed in the <span class="emphasis"><em>Exercises</em></span> section of this chapter, but it should be enough to have a good bit of fun with the game debugging in Playmaker.</p><p>Now that you have a player controller, a win/lose condition, and a functional AI in the game, it begins to get quite big, and if you want to add anything to it or if something goes wrong, you will be hard-pressed to know what exactly is going on in your actions in real time. This is what debugging is for: it is a diagnosis tool that lets you get additional information about your game or its specific systems that you can later use in order to fix something.</p><p>Let us look at an example. Select <span class="strong"><strong>MalletLeft</strong></span> and open its <span class="strong"><strong>Move</strong></span> state in the FSM view of the <span class="strong"><strong>playMaker</strong></span> panel. If you look at the bottom of the <span class="strong"><strong>State</strong></span> tab, you will see two checkboxes there: <span class="strong"><strong>Debug</strong></span> and <span class="strong"><strong>Hide Unused</strong></span>. The first one shows you the values of all your properties at all time, while the second one hides the unused ones. Check both of them and, keeping <span class="strong"><strong>MalletLeft</strong></span> selected, press the play button.</p><p>As you move the <a id="id109" class="indexterm"></a>mallet around, observe the numbers that change under all the properties of the actions. When you implement a new gameplay feature, you will want to know in what range values change, and if they do at all.</p><p>You can also use the <span class="strong"><strong>Console</strong></span> panel for debugging some things. Uncheck both <span class="strong"><strong>Debug</strong></span> and <span class="strong"><strong>Hide Unused</strong></span>, and then open the <span class="strong"><strong>Push Puck</strong></span> state of the same FSM. Add a <span class="strong"><strong>Debug Log</strong></span> action (under the <span class="strong"><strong>Debug</strong></span> category) to the very top of it. Set <span class="strong"><strong>Log Level</strong></span> to <span class="strong"><strong>Warning</strong></span> and write <code class="literal">Hit!</code> in the text field.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip15"></a>Tip</h3><p>You should know that there are three types of debug logs: <span class="emphasis"><em>Info</em></span>, <span class="emphasis"><em>Warning</em></span>, and <span class="emphasis"><em>Error</em></span>, each with a specific function. Warning is there to attract your attention to an issue, Info is a simple message that provides information about something, while Error lets you know that there is a problem. These are merely conventions, but you will see some Unity internal Info, Warnings, and Errors that follow them.</p></div><p>Now open the <span class="strong"><strong>Console</strong></span> panel. We have talked about it briefly before, but let us have a detailed look at various buttons in it now (from left to right).</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Clear</strong></span> is quite self-explanatory; it clears the log, removing all the messages from it, apart from compilation errors that were not fixed</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Collapse</strong></span> is a toggle button that makes similar debug messages appear in the same line or separately</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Clear on Play</strong></span> is a toggle button that forces the <span class="strong"><strong>Console</strong></span> to clear the log when you press play.</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Error Pause</strong></span> automatically pauses the game when there is an error to give you a better look at it.</p></li></ul></div><p>Finally, the three toggle buttons on the right are filters for <span class="strong"><strong>Console</strong></span> that let you focus on different types of debug messages: Info, Warning, and Error.</p><p>If you press play now and hit the puck with your mallet, a message with a yellow triangle should appear in Console saying something like <span class="strong"><strong>MalletLeft : FSM : Push Puck : DebugLog : Hit!</strong></span> You might also have several of them. Stop the game and see what happens when you switch <span class="strong"><strong>Collapse</strong></span> on and off and toggle the Warning filter.</p><p>If you press play now and hit the puck with your mallet, a message with a yellow triangle should appear in <span class="strong"><strong>Console</strong></span> saying something like <span class="strong"><strong>MalletLeft : FSM : Push Puck : DebugLog : Hit!</strong></span> You might also have several of them. Stop the game and see what happens when you switch <span class="strong"><strong>Collapse</strong></span> on and off and toggle the Warning filter. You might also have several of them, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849698108/graphics/8108OT_04_11.jpg" /></div><p>You can also debug variable values in the same way. Open <span class="strong"><strong>playMaker</strong></span>, remove the <span class="strong"><strong>Debug Log</strong></span> action, and put a <span class="strong"><strong>Debug Vector3</strong></span> action right after <span class="strong"><strong>Get Controller Hit Info</strong></span>, setting the <span class="strong"><strong>Log Level</strong></span> to <span class="strong"><strong>Error</strong></span> and <span class="strong"><strong>Vector3 Variable</strong></span> to <span class="strong"><strong>hitPos</strong></span>. Then open <span class="strong"><strong>Console</strong></span> and test the game again, pushing the puck with your mallet. You should see red error messages appear in <span class="strong"><strong>Console</strong></span> now. If you have <span class="strong"><strong>Error Pause</strong></span> toggled, the game will pause and the <span class="strong"><strong>Console</strong></span> panel will be revealed to show you the errors.</p><p>You can achieve a <a id="id110" class="indexterm"></a>similar effect by using something called breakpoints. Get rid of the <span class="strong"><strong>Debug Vector3</strong></span> action in the <span class="strong"><strong>Push Puck</strong></span> state of the FSM of <span class="strong"><strong>MalletLeft</strong></span>, then right-click on the <span class="strong"><strong>Push Puck</strong></span> state in the FSM view and select <span class="strong"><strong>Toggle Breakpoint</strong></span> from the contextual menu. A red line will appear next to the state's name in the FSM view.</p><p>Now, if you press play and touch the puck with your mallet, the game will stop the same way it did when you used an <span class="strong"><strong>Error Debug</strong></span> log and the <span class="strong"><strong>Error Pause</strong></span> toggle in <span class="strong"><strong>Console</strong></span>, except this time the pause will be triggered by Playmaker. A red circle with the name of the breakpoint's state will appear in the FSM view. The following screenshot shows what it is supposed to look like:</p><div class="mediaobject"><img src="/graphics/9781849698108/graphics/8108OT_04_12.jpg" /></div><p>Note that the transition arrow from the <span class="strong"><strong>Push</strong></span> event to the <span class="strong"><strong>Push Puck</strong></span> state became yellow. This means that the breakpoint was triggered after this particular transition and not something else.</p><p>You can <a id="id111" class="indexterm"></a>unpause the game when it was paused because of a breakpoint, but it will be paused all over again if this or another breakpoint gets triggered. You can remove the breakpoint by right-clicking the state with a breakpoint and selecting <span class="strong"><strong>Toggle Breakpoint</strong></span> from the contextual menu.</p><p>Another useful debugging tool is step-by-step execution. When the game is paused (including when it was paused because of breakpoints or <span class="strong"><strong>Error Pause</strong></span>), you can press the next step (<span class="inlinemediaobject"><img src="/graphics/9781849698108/graphics/8108OT_04_13.jpg" /></span>) button in the toolbar or on the bottom of the <span class="strong"><strong>playMaker</strong></span> panel. This will execute the next frame of the game. As you already know, some actions are executed in every frame so, using the <span class="strong"><strong>Debug</strong></span> checkbox on the bottom of the <span class="strong"><strong>State</strong></span> tab in the <span class="strong"><strong>playMaker</strong></span> panel, you can see the exact values of each parameter of each action in any particular frame. You can press the next step button as you want to observe changes. When you are done debugging, just unpause or stop the game.</p><p>The final debug tool that we are going to talk about is the Playmaker <span class="strong"><strong>FSM Log</strong></span> panel that lets you see everything that happens to your objects that are under Playmaker control. You can open it by pressing the <span class="strong"><strong>Debug</strong></span> button on the bottom of the <span class="strong"><strong>playMaker</strong></span> panel next to the play/pause/next step buttons, then select <span class="strong"><strong>Open Log Window</strong></span> from the drop-down menu. The following screenshot shows the <span class="strong"><strong>FSM Log</strong></span> panel in action:</p><div class="mediaobject"><img src="/graphics/9781849698108/graphics/8108OT_04_14.jpg" /></div><p>It might <a id="id112" class="indexterm"></a>be a good idea to keep this log handy, so you could attach it as the second panel to the same area of the screen as <span class="strong"><strong>Hierarchy</strong></span> or <span class="strong"><strong>Project</strong></span>.</p></div>