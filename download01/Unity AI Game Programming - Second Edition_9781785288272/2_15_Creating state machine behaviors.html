<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec20"></a>Creating state machine behaviors</h2></div></div><hr /></div><p>Now that <a id="id39" class="indexterm"></a>we're familiar with the concept of a state machine, let's get our hands dirty and start implementing our very own.</p><p>As of Unity 5.0.0f4, state machines are still part of the animation system, but worry not, they are flexible, and no animations are actually required to implement them. Don't be alarmed or confused if you see code referencing the <code class="literal">Animator</code> component or the <code class="literal">AnimationController</code> asset as it's merely a quirk of the current implementation. It's fathomable that Unity will address this in a later version, but the concepts will likely not change.</p><p>Let's fire up Unity, create a new project, and get to it.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec10"></a>Creating the AnimationController asset</h3></div></div></div><p>The <a id="id40" class="indexterm"></a>
<code class="literal">AnimationController</code> asset is a type of asset within Unity that handles states and transitions. It is, in essence, an FSM, but it also does much more. We'll focus on the FSM <a id="id41" class="indexterm"></a>portion of its functionality. An animator controller can be created from the <span class="strong"><strong>Assets</strong></span> menu, as shown in the following image:</p><div class="mediaobject"><img src="/graphics/9781785288272/graphics/4204_02_02.jpg" /></div><p>Once you create the animator controller, it will pop up in your project assets folder, ready to be named. We'll name it <code class="literal">TankFsm</code>. When you select the animator controller, unlike most other asset types, the hierarchy is blank. That is because animation controllers use their own window. You can simply click on <span class="strong"><strong>Open</strong></span> in the hierarchy to open up the <a id="id42" class="indexterm"></a>
<span class="strong"><strong>Animator</strong></span> window, or open it in the <span class="strong"><strong>Window</strong></span> menu, as you can see in the <a id="id43" class="indexterm"></a>following screenshot:</p><div class="mediaobject"><img src="/graphics/9781785288272/graphics/4204_02_03.jpg" /></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip02"></a>Tip</h3><p>Be sure to select <span class="strong"><strong>Animator</strong></span> and not <span class="strong"><strong>Animation</strong></span> as these are two different windows and features entirely.</p></div><p>Let's familiarize ourselves with this window before moving forward.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec11"></a>Layers and Parameters</h3></div></div></div><p>Layers, as the <a id="id44" class="indexterm"></a>name implies, allow us to stack different state machine levels on top of each other. This panel allows us to organize the layers easily and have a visual representation. We will not be doing much in this panel for now as it primarily relates to <a id="id45" class="indexterm"></a>animation, but it's good to be familiar with it. Refer to the following screenshot of the window to find your way around the layers:</p><div class="mediaobject"><img src="/graphics/9781785288272/graphics/4204_02_04.jpg" /></div><p>Here is a summary of the items shown in the previous screenshot:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="strong"><strong>Add layer</strong></span>: This <a id="id46" class="indexterm"></a>button creates a new layer at the bottom of the list.</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Layer list</strong></span>: These <a id="id47" class="indexterm"></a>are the layers currently inside the animator controller. You can click to select a layer and drag-and-drop layers to rearrange them.</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Layer settings</strong></span>: These are <a id="id48" class="indexterm"></a>animation-specific settings for the layer.</p></li></ul></div><p>Second, we have the <a id="id49" class="indexterm"></a>
<span class="strong"><strong>Parameters</strong></span> panel, which is far more relevant to our use of the animator controller. Parameters are variables that determine when to transition between states, and we can access them via scripts to drive our states. There are four types of parameters: <code class="literal">float</code>, <code class="literal">int</code>, <code class="literal">bool</code>, and <code class="literal">trigger</code>. You should already be familiar with the first three as they are primitive types in C#, but <code class="literal">trigger</code> is specific to the animator controller, not to be confused with physics triggers, which do not apply here. Triggers are just a means to trigger a transition between states explicitly.</p><p>The following screenshot shows the elements in the <span class="strong"><strong>Parameters</strong></span> panel:</p><div class="mediaobject"><img src="/graphics/9781785288272/graphics/4204_02_05.jpg" /></div><p>Here is a summary of the items depicted in the previous screenshot:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="strong"><strong>Search</strong></span>: We <a id="id50" class="indexterm"></a>can quickly search through our parameters here. Simply type in the name and the list will populate with the search results.</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Add parameter</strong></span>: This <a id="id51" class="indexterm"></a>button lets you add new parameters. When you click on it, you must select the parameter type.</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Parameter list</strong></span>: This is the <a id="id52" class="indexterm"></a>list of parameters you've created. You can assign and view their values here. You can also reorder the parameters to your liking by dragging-and-dropping them in the correct order. This is merely for organization and does not affect functionality at all.</p></li></ul></div><p>Lastly, there is an eyeball icon, which you can click to hide the <span class="strong"><strong>Layers</strong></span> and <span class="strong"><strong>Parameters</strong></span> panels altogether. When the panels are closed, you can still create new layers by clicking on the <span class="strong"><strong>Layers</strong></span> dropdown and selecting <span class="strong"><strong>Create New Layer</strong></span>:</p><div class="mediaobject"><img src="/graphics/9781785288272/graphics/4204_02_06.jpg" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec12"></a>The animation controller inspector</h3></div></div></div><p>The <a id="id53" class="indexterm"></a>animation controller inspector is slightly different from the regular inspector found throughout Unity. While the regular inspector allows you to add components to the game objects, the animation controller inspector has a button labeled <span class="strong"><strong>Add Behaviour</strong></span>, which allows you to add a <code class="literal">StateMachineBehaviour</code> to it. This is the main distinction between the two types of inspectors, but apart from this, it will display the serialized information for any selected state, substate, transition, or blend tree, just as the regular inspector displays the data for the selected game object and its components.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec13"></a>Bringing behaviors into the picture</h3></div></div></div><p>State <a id="id54" class="indexterm"></a>machine behaviors are a unique new concept in Unity 5. While states existed, conceptually, in the original implementation of Mecanim, transitions were handled behind the scenes, and you did not have much control over what happened upon entering, transitioning, or exiting a state. Unity 5 addressed this issue by introducing behaviors; they provide a built-in functionality to handle typical FSM logic.</p><p>Behaviors are sly and tricky. Though their name might lead you to believe they are related to <code class="literal">MonoBehaviour</code>, do not fall for it; if anything, these two are distant cousins at best. In fact, behaviors derive from <code class="literal">ScriptableObject</code>, not <code class="literal">MonoBehaviour</code>, so they exist only as assets, which cannot be placed in a scene or added as a component to a GameObject.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec14"></a>Creating our very first state</h3></div></div></div><p>OK, so that's <a id="id55" class="indexterm"></a>not entirely true since Unity creates a few default states for us in our animator controller: <span class="strong"><strong>New State</strong></span>, <span class="strong"><strong>Any State</strong></span>, <span class="strong"><strong>Entry</strong></span>, and <span class="strong"><strong>Exit</strong></span>, but let's just agree that those don't count for now, OK?</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>You can select states in this window by clicking on them, and you can move them by dragging-and-dropping them anywhere in the canvas.</p></li><li style="list-style-type: disc"><p>Select the state named <span class="strong"><strong>New State</strong></span> and delete it by either right-clicking and then clicking on <span class="strong"><strong>Delete</strong></span> or simply hitting the <span class="emphasis"><em>Delete</em></span> key on your keyboard.</p></li><li style="list-style-type: disc"><p>If you select the <span class="strong"><strong>Any State</strong></span>, you'll notice that you do not have the option to delete it. The same is true for the <span class="strong"><strong>Entry</strong></span> state. These are required states in an animator controller and have unique uses, which we'll cover up ahead.</p><div class="mediaobject"><img src="/graphics/9781785288272/graphics/4204_02_07.jpg" /></div></li></ul></div><p>To create our (true) first <a id="id56" class="indexterm"></a>state, right-click anywhere on the canvas and then select <span class="strong"><strong>Create State</strong></span>, which opens up a few options from which we'll select <span class="strong"><strong>Empty</strong></span>. The other two options, <span class="strong"><strong>From Selected Clip</strong></span> and <span class="strong"><strong>From New Blend Tree</strong></span>, are not immediately applicable to our project, so we'll skip these. Now we've officially created our first state.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec15"></a>Transitioning between states</h3></div></div></div><p>You'll notice that <a id="id57" class="indexterm"></a>upon creating our state, an arrow is created connecting the <span class="strong"><strong>Entry</strong></span> state to it, and that its node is orange. Unity will automatically set default states to look orange to differentiate them from other states. When you only have one state, it is automatically selected as the default state, and as such, it is automatically connected to the entry state. You can manually select which state is the default state by right-clicking on it and then clicking on <span class="strong"><strong>Set as Layer Default State</strong></span>. It will then become orange, and the entry state will automatically connect itself to it. The connecting arrow is a <span class="strong"><strong>transition connector</strong></span>. Transition connectors allow us some control over how and when the transition occurs, but the connector from the entry state to the default state is unique in that it does not provide us any options since this transition happens automatically.</p><p>You can manually assign transitions between states by right-clicking on a state node and then selecting <span class="strong"><strong>Make Transition</strong></span>. This will create a transition arrow from the state you selected to your mouse cursor. To select the destination of the transition, simply click on the destination node and that's it. Note that you cannot redirect the transitions though. We can only hope that the kind folks behind Unity add that functionality at a later point, but for now, you must remove a transition by selecting it and deleting it and then assigning an all-new transition manually.</p></div></div>