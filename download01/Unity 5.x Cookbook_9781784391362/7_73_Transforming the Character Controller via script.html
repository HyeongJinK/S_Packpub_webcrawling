<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec74"></a>Transforming the Character Controller via script</h2></div></div><hr /></div><p>Applying <span class="strong"><strong>Root Motion</strong></span> to your character might be a very practical and accurate way to animate it. However, every now and then, you might need to manually control one or two aspects of the <a id="id786" class="indexterm"></a>character movement. Perhaps you only have an in-place animation to work with, or maybe you want the character's movement to be affected by<a id="id787" class="indexterm"></a> other variables. In these cases, you will need to override the root motion via script.</p><p>To illustrate this issue, this recipe makes use of an animation clip for jumping, which originally moves the character only in the Y-axis. In order to make her move forward or backwards while jumping, we will learn how to access the character's velocity to inform the jump's direction via the script.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_38.jpg" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec209"></a>Getting ready</h3></div></div></div><p>For this recipe, we have prepared a Unity Package named <code class="literal">Jumping</code>, containing a basic scene that features an animated character. The package can be found inside the <code class="literal">1362_07_05</code> folder, along with the animation clip called <code class="literal">Swat@rifle_jump</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec210"></a>How to do it...</h3></div></div></div><p>To apply the Root Motion via script, please follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new project and import the <code class="literal">Jumping</code> Unity Package. Then, from the <span class="strong"><strong>Project</strong></span> view, open the <span class="strong"><strong>mecanimPlayground</strong></span> level.</p></li><li><p>Import the <code class="literal">Swat@rifle_jump.fbx</code> file to the project.</p></li><li><p>We need to configure our animation clip. From the <span class="strong"><strong>Project </strong></span>view, select the <span class="strong"><strong>Swat@rifle_jump</strong></span> file.</p></li><li><p>Activate the <span class="strong"><strong>Rig</strong></span> section. Change <span class="strong"><strong>Animation Type</strong></span> to <span class="strong"><strong>Humanoid</strong></span>, and <span class="strong"><strong>Avatar Definition</strong></span> to <span class="strong"><strong>Create From this Model</strong></span>. Confirm this by clicking on <span class="strong"><strong>Apply</strong></span>.</p></li><li><p>Now, activate the <span class="strong"><strong>Animations</strong></span> section. Select the <span class="strong"><strong>rifle_jump </strong></span>clip (from the <span class="strong"><strong>Clips</strong></span> list), click<a id="id788" class="indexterm"></a> on the <span class="strong"><strong>Clamp Range</strong></span> button to adjust the timeline, and check the <span class="strong"><strong>Loop Time </strong></span>and <span class="strong"><strong>Loop Pose</strong></span> options. Under <span class="strong"><strong>Root Transform Rotation</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and select <span class="strong"><strong>Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <span class="strong"><strong>Root Transform Position (Y)</strong></span>, leave <span class="strong"><strong>Bake into Pose </strong></span>unchecked, and select <span class="strong"><strong>Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <span class="strong"><strong>Root Transform Position (XZ)</strong></span>, leave <span class="strong"><strong>Bake Into Pose</strong></span> unchecked. Click on<span class="strong"><strong> Apply</strong></span> to confirm the changes.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_32.jpg" /></div></li><li><p>From the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>MsLaser</strong></span> character. Then, from the <span class="strong"><strong>Animator</strong></span> component in the <span class="strong"><strong>Inspector</strong></span> view, open the <span class="strong"><strong>MainCharacter</strong></span> controller.</p></li><li><p>From the top-left corner of the <span class="strong"><strong>Animator</strong></span> view, activate the <span class="strong"><strong>Parameters</strong></span> section, and use the <span class="strong"><strong>+</strong></span> sign to create a new <span class="strong"><strong>Parameters (Boolean) </strong></span>named <code class="literal">Jump</code>.</p></li><li><p>Right-click on the <a id="id789" class="indexterm"></a>gridded area and, from the context menu, select <span class="strong"><strong>Create State</strong></span> | <span class="strong"><strong>Empty</strong></span>. Change its name, from the <span class="strong"><strong>Inspector</strong></span> view, to <code class="literal">Jump</code>.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_33.jpg" /></div></li><li><p>Select the <span class="strong"><strong>Jump</strong></span> state. Then, from the <span class="strong"><strong>Inspector</strong></span> view, populate it with the <span class="strong"><strong>rifle_jump</strong></span> Motion clip.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_34.jpg" /></div></li><li><p>Find and right-click on the <span class="strong"><strong>Any State</strong></span>. Then, selecting the <span class="strong"><strong>Make Transition</strong></span> option, create a transition from <span class="strong"><strong>Any State</strong></span> to <span class="strong"><strong>Jump</strong></span>. Select the transition, uncheck <span class="strong"><strong>Has Exit Time</strong></span>, and use the <span class="strong"><strong>Jump</strong></span> variable as a condition (<span class="strong"><strong>true</strong></span>).</p></li><li><p>Now, create a transition from <span class="strong"><strong>Jump</strong></span> to <span class="strong"><strong>Move</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_35.jpg" /></div></li><li><p>Configure the<a id="id790" class="indexterm"></a> transitions between <span class="strong"><strong>Jump</strong></span> and <span class="strong"><strong>Move</strong></span>, leaving <span class="strong"><strong>Has Exit Time</strong></span> checked, and use the <span class="strong"><strong>Jump</strong></span> variable as a condition (<span class="strong"><strong>false</strong></span>).</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_36.jpg" /></div></li><li><p>From the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>MsLaser</strong></span> character. Then, from the <span class="strong"><strong>Inspector</strong></span> view, open the script from the <span class="strong"><strong>BasicController</strong></span> component.</p></li><li><p>Right before the <code class="literal">Start()</code> function, add the following code:</p><div class="informalexample"><pre class="programlisting">public float jumpHeight = 3f;
private float verticalSpeed = 0f;
private float xVelocity = 0f;
private float zVelocity = 0f;</pre></div></li><li><p>Inside the <code class="literal">Update()</code> function, find the line containing the following code:</p><div class="informalexample"><pre class="programlisting">if(controller.isGrounded){</pre></div><p>And add the following lines immediatly after it:</p><div class="informalexample"><pre class="programlisting">if (Input.GetKey (KeyCode.Space)) {
  anim.SetBool ("Jump", true);
  verticalSpeed = jumpHeight;
}</pre></div></li><li><p>Finally, add a<a id="id791" class="indexterm"></a> new function, following immediately before the final <code class="literal">}</code> of the code:</p><div class="informalexample"><pre class="programlisting">  void OnAnimatorMove(){
    Vector3 deltaPosition = anim.deltaPosition;
    if (controller.isGrounded) {
      xVelocity = controller.velocity.x;
      zVelocity = controller.velocity.z;
    } else {
      deltaPosition.x = xVelocity * Time.deltaTime;
      deltaPosition.z = zVelocity * Time.deltaTime;
      anim.SetBool ("Jump", false);
    }
    deltaPosition.y = verticalSpeed * Time.deltaTime;
    controller.Move (deltaPosition);
    verticalSpeed += Physics.gravity.y * Time.deltaTime;
    if ((controller.collisionFlags &amp; CollisionFlags.Below) != 0) {
      verticalSpeed = 0;
    }
  }</pre></div></li><li><p>Save your script and play the scene. You will be able to jump around using the <span class="emphasis"><em>Space</em></span> key. Observe how the character's velocity affects the direction of the jump.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec211"></a>How it works...</h3></div></div></div><p>Observe that once this function is added to the script, the <span class="strong"><strong>Apply Root Motion</strong></span> field, in the <span class="strong"><strong>Animator</strong></span> component, changes from a checked box to <span class="strong"><strong>Handled by Script</strong></span>. The reason is that in order to override the animation clip's original movement, we have placed, inside Unity's <code class="literal">OnAnimatorMove()</code> function, a series of commands to move our character controller while jumping. The line of code: <code class="literal">controller.Move (deltaPosition);</code> basically replaces the jump's direction from the original animation with the <code class="literal">deltaPosition</code> 3D Vector, which is made of the character's velocity at the instant before the jump (<span class="emphasis"><em>x</em></span> and <span class="emphasis"><em>z</em></span>-axis) and the calculation between the <code class="literal">jumpHeight</code> variable and gravity<a id="id792" class="indexterm"></a> force overtime (<span class="emphasis"><em>y</em></span>-axis).</p></div></div>