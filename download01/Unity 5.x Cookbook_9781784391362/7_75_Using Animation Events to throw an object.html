<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec76"></a>Using Animation Events to throw an object</h2></div></div><hr /></div><p>Now that <a id="id802" class="indexterm"></a>your animated character is ready, you might want to coordinate some of her actions with her animation states. In this recipe, we will exemplify this by making the character throw an object whenever the appropriate animation clip reaches the right time. To do so, we will make<a id="id803" class="indexterm"></a> use of <span class="strong"><strong>Animation Events</strong></span>, which basically trigger a function from the animation clip's timeline. This feature, recently introduced to the <span class="strong"><strong>Mecanim</strong></span> system, should<a id="id804" class="indexterm"></a> feel familiar to those experienced with the<a id="id805" class="indexterm"></a> <span class="strong"><strong>Add Event</strong></span> feature of <a id="id806" class="indexterm"></a>the classic <span class="strong"><strong>Animation </strong></span>panel.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_42.jpg" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec216"></a>Getting ready</h3></div></div></div><p>For this recipe, we<a id="id807" class="indexterm"></a> have prepared a Unity Package named <code class="literal">Throwing</code>, containing a basic scene that features an animated character and a prefab named <span class="strong"><strong>EasterEgg</strong></span>. The package can be found inside the <code class="literal">1362_07_07</code> folder.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec217"></a>How to do it...</h3></div></div></div><p>To make an animated character throw an Easter egg (!), follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new project and import the <code class="literal">Throwing</code> Unity Package. Then, from the <span class="strong"><strong>Project</strong></span> view, open the <span class="strong"><strong>mecanimPlayground</strong></span> level.</p></li><li><p>Play the level and press <span class="emphasis"><em>F</em></span> on your keyboard. The character will move as if she is throwing something with her right hand.</p></li><li><p> From the <span class="strong"><strong>Project</strong></span> view, create a new <span class="strong"><strong>C# Script</strong></span> named <code class="literal">ThrowObject.cs.</code>
</p></li><li><p>Open the script and add the following code:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class ThrowObject : MonoBehaviour {
  public GameObject prop;
  private GameObject proj;
  public Vector3 posOffset;
  public Vector3 force;
  public Transform hand;
  public float compensationYAngle = 0f;
    
  public void Prepare () {

    proj = Instantiate(prop, hand.position, hand.rotation) as GameObject;
    if(proj.GetComponent&lt;Rigidbody&gt;())
      Destroy(proj.GetComponent&lt;Rigidbody&gt;());
    proj.GetComponent&lt;SphereCollider&gt;().enabled = false;
    proj.name = "projectile";
    proj.transform.parent = hand;
    proj.transform.localPosition = posOffset;
    proj.transform.localEulerAngles = Vector3.zero;
  }

  public void Throw () {

    Vector3 dir = transform.rotation.eulerAngles;
    dir.y += compensationYAngle;
    proj.transform.rotation = Quaternion.Euler(dir);
    proj.transform.parent = null;
    proj.GetComponent&lt;SphereCollider&gt;().enabled = true;
    Rigidbody rig = proj.AddComponent&lt;Rigidbody&gt;();
    Collider projCollider = proj.GetComponent&lt;Collider&gt; ();
    Collider col = GetComponent&lt;Collider&gt; ();
    Physics.IgnoreCollision(projCollider, col);
    rig.AddRelativeForce(force);
  }
}</pre></div></li><li><p>Save and close the script.</p></li><li><p>Attach the <a id="id808" class="indexterm"></a><span class="strong"><strong>ThrowObject.cs</strong></span> script to the character's GameObject named <span class="strong"><strong>MsLaser</strong></span>.</p></li><li><p>Select the <span class="strong"><strong>MsLaser</strong></span> object. From the <span class="strong"><strong>Inspector</strong></span> view, check out its <span class="strong"><strong>Throw Object</strong></span> component. Then, populate the <span class="strong"><strong>Prop</strong></span> field with a prefab named <span class="strong"><strong>EasterEgg</strong></span>. Populate <span class="strong"><strong>Hand</strong></span> with <span class="strong"><strong>mixamorig:RightHand</strong></span>. Also, change <span class="strong"><strong>Pos Offset</strong></span> to <span class="strong"><strong>X</strong></span>: <code class="literal">0</code>; <span class="strong"><strong>Y</strong></span>: <code class="literal">0.07</code>; <span class="strong"><strong>Z</strong></span>: <code class="literal">0.04</code>. Finally, change <span class="strong"><strong>Force</strong></span> to <span class="strong"><strong>X</strong></span>: <code class="literal">0</code>; <span class="strong"><strong>Y</strong></span>: <code class="literal">200</code>; <span class="strong"><strong>Z</strong></span>: <code class="literal">500</code>.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_43.jpg" /></div></li><li><p>From the <span class="strong"><strong>Project</strong></span> view, select the <span class="strong"><strong>Swat@toss_grenade</strong></span> file. Then, from the <span class="strong"><strong>Inspector</strong></span><a id="id809" class="indexterm"></a> view, access the <span class="strong"><strong>Animation</strong></span> section and scroll down to the <span class="strong"><strong>Events</strong></span> section.</p></li><li><p>Expand the <span class="strong"><strong>Events</strong></span> section. Drag the playhead to approximately <span class="strong"><strong>0:17 (017.9%)</strong></span> of the animation timeline. Then, click on the button with the <span class="emphasis"><em>marker +</em></span> icon to add an<a id="id810" class="indexterm"></a> <span class="strong"><strong>Animation Event</strong></span>. From the <span class="strong"><strong>Edit Animation Event</strong></span> window, set <span class="strong"><strong>Function</strong></span> as <code class="literal">Prepare</code>. Close the window.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_44.jpg" /></div></li><li><p>Add a new animation event at approximately <span class="strong"><strong>1:24 (057.1%)</strong></span> of the animation timeline. This time, from the <span class="strong"><strong>Edit Animation Event</strong></span> window, set <span class="strong"><strong>Function</strong></span> as <code class="literal">Throw</code>. Close the window.</p></li><li><p>Click on the <span class="strong"><strong>Apply</strong></span> button to save the changes.</p></li><li><p>Play your scene. Your character will now be able to throw an Easter egg when you press the <span class="emphasis"><em>F </em></span>key.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec218"></a>How it works...</h3></div></div></div><p>Once the <span class="strong"><strong>toss_grenade</strong></span> animation reaches the <a id="id811" class="indexterm"></a>moments that we have set our <span class="strong"><strong>Events</strong></span> to, the <code class="literal">Prepare() </code>and<code class="literal"> throw()</code> functions are called. The former instantiates a prefab, now named <span class="strong"><strong>projectile</strong></span>, into the character's hand (<span class="strong"><strong>Projectile Offset</strong></span> values are used to fine-tune its position), also <a id="id812" class="indexterm"></a>making it respect the character's hierarchy. Also, it disables the prefab's collider and destroys its <code class="literal">Rigidbody</code> component, provided it has one. The latter function enables the projectile's collider, and adds a <code class="literal">Rigidbody</code> component to it, making it independent from the character's hand. Finally, it adds a relative force to the projectile's <code class="literal">Rigidbody</code> component, so it will behave as if thrown by the character. The <span class="strong"><strong>Compensation YAngle</strong></span> can be used to adjust the direction of the grenade, if necessary.</p></div></div>