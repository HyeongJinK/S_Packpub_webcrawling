<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec86"></a>Controlling the object group movement through flocking</h2></div></div><hr /></div><p>A realistic, natural-looking, flocking behavior (for example birds or antelopes or bats) can be created through<a id="id911" class="indexterm"></a> creating collections of objects with the following four simple rules:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="strong"><strong>Separation</strong></span>: Avoiding getting too close to neighbors</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Avoid Obstacle</strong></span>: Turning away from an obstacle immediately ahead</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Alignment</strong></span>: Moving in the general direction the flock is heading</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Cohesion</strong></span>: Moving towards the location in the middle of the flock</p></li></ul></div><p>Each member of the flock acts independently, but needs to know about the current heading and location of the members of its flock. This recipe shows you how to create a scene with two flocks of cubes: one flock of green cubes and, one flock of yellow cubes. To keep things simple, we'll not worry about separation in our recipe.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_08_15.jpg" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec250"></a>Getting ready</h3></div></div></div><p>This recipe builds upon the player-controlled cube Unity project that you created in the first recipe. So, make a copy of this project, open it, and then follow the steps for this<a id="id912" class="indexterm"></a> recipe.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec251"></a>How to do it...</h3></div></div></div><p>To make a group of objects flock together, please follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a Material in the <span class="strong"><strong>Project</strong></span> panel, and name it as <code class="literal">m_green</code> with the Main Color tinted green.</p></li><li><p>Create a Material in the <span class="strong"><strong>Project</strong></span> panel, and name it as <code class="literal">m_yellow</code> with Main Color tinted yellow.</p></li><li><p>Create a 3D Cube GameObject named <code class="literal">Cube-drone</code> at (0,0,0). Drag the <code class="literal">m_yellow</code> Material into this object.</p></li><li><p>Add a <span class="strong"><strong>Navigation</strong></span> | <span class="strong"><strong>NavMeshAgent</strong></span> component to <code class="literal">Cube-drone</code>. Set the <span class="strong"><strong>Stopping Distance</strong></span> property of the <span class="strong"><strong>NavMeshAgent</strong></span> component to <code class="literal">2</code>.</p></li><li><p>Add a <span class="strong"><strong>Physics RigidBody</strong></span> component to <code class="literal">Cube-drone</code> with the following properties:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="strong"><strong>Mass</strong></span> is <code class="literal">1</code>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Drag</strong></span> is <code class="literal">0</code>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Angular Drag</strong></span> is <code class="literal">0.05</code>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Use Gravity</strong></span> and <span class="strong"><strong>Is Kinematic</strong></span> are both unchecked</p></li><li style="list-style-type: disc"><p>Under <span class="strong"><strong>Constrains Freeze Position</strong></span> for the <span class="strong"><strong>Y</strong></span>-axis is checked</p></li></ul></div></li><li><p>You will see the following Inspector values for your cube's rigid body component:</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_08_16.jpg" /></div></li><li><p>Create the following C# script class called <code class="literal">Drone</code>, and add an instance as a component<a id="id913" class="indexterm"></a> to the <code class="literal">Cube-drone</code> GameObject:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class Drone : MonoBehaviour {
  private NavMeshAgent navMeshAgent;

  void Start() {
    navMeshAgent = GetComponent&lt;NavMeshAgent&gt;();
  }

  public void SetTargetPosition(Vector3 swarmCenterAverage, Vector3 swarmMovementAverage) {
    Vector3 destination = swarmCenterAverage + swarmMovementAverage;
    navMeshAgent.SetDestination(destination);
  }
}</pre></div></li><li><p>Create a new empty Prefab named <code class="literal">dronePrefabYellow</code>, and from the <span class="strong"><strong>Hierarchy</strong></span> panel, drag your <code class="literal">Cube-boid</code> GameObject into this Prefab.</p></li><li><p>Now, drag the <code class="literal">m_green</code> Material into the <code class="literal">Cube-boid</code> GameObject.</p></li><li><p>Create a new empty Prefab named <code class="literal">dronePrefabGreen</code>, and from the <span class="strong"><strong>Hierarchy</strong></span> panel, drag your <code class="literal">Cube-drone</code> GameObject into this Prefab.</p></li><li><p>Delete the <code class="literal">Cube-drone</code> GameObject from the <span class="strong"><strong>Scene</strong></span> panel.</p></li><li><p>Add the<a id="id914" class="indexterm"></a> following C# script <code class="literal">Swarm</code> class to the <span class="strong"><strong>Main Camera</strong></span>:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;
using System.Collections.Generic;

public class Swarm : MonoBehaviour {
  public int droneCount = 20;
  public GameObject dronePrefab;

  private List&lt;Drone&gt; drones = new List&lt;Drone&gt;();

  void Awake() {
    for (int i = 0; i &lt; droneCount; i++)
      AddDrone();
  }

  void FixedUpdate() {
    Vector3 swarmCenter = SwarmCenterAverage();
    Vector3 swarmMovement = SwarmMovementAverage();

    foreach(Drone drone in drones)
      drone.SetTargetPosition(swarmCenter, swarmMovement);
  }

  private void AddDrone() {
    GameObject newDroneGO = (GameObject)Instantiate(dronePrefab);
    Drone newDrone = newDroneGO.GetComponent&lt;Drone&gt;();
    drones.Add(newDrone);
  }

  private Vector3 SwarmCenterAverage() {
    // cohesion (swarm center point)
    Vector3 locationTotal = Vector3.zero;

    foreach(Drone drone in drones)
      locationTotal += drone.transform.position;

    return (locationTotal / drones.Count);
  }

  private Vector3 SwarmMovementAverage() {
    // alignment (swarm direction average)
    Vector3 velocityTotal = Vector3.zero;

    foreach(Drone drone in drones)
      velocityTotal += drone.rigidbody.velocity;

    return (velocityTotal / drones.Count);	
  }
}</pre></div></li><li><p>With <span class="strong"><strong>Main Camera</strong></span> selected in the <span class="strong"><strong>Hierarchy</strong></span> panel, drag <code class="literal">prefab_boid_yellow</code>, from the <span class="strong"><strong>Project</strong></span> panel, over the public variable of <span class="strong"><strong>Drone</strong></span> Prefab.</p></li><li><p>With <span class="strong"><strong>Main Camera</strong></span> selected in the <span class="strong"><strong>Hierarchy</strong></span> panel, add a second instance of the script class called <code class="literal">Swarm</code> to this GameObject, and then drag <code class="literal">prefab_boid_green</code>, from the <span class="strong"><strong>Project</strong></span> panel, over the public variable of <span class="strong"><strong>Drone</strong></span> Prefab.</p></li><li><p>Create a new Cube named <code class="literal">wall-left</code> with the following properties:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Position = (-15, 0.5, 0)</p></li><li style="list-style-type: disc"><p>Scale = (1, 1, 20)</p></li></ul></div></li><li><p>Duplicate<a id="id915" class="indexterm"></a> the <code class="literal">wall-left</code> object by naming the new object as <code class="literal">wall-right</code>, and change the position of <code class="literal">wall-right</code> to (15, 0.5, 0).</p></li><li><p>Create a new Cube named as <code class="literal">wall-top</code> with the following properties:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Position = (0, 0.5, 10)</p></li><li style="list-style-type: disc"><p>Scale = (31, 1, 1)</p></li></ul></div></li><li><p>Duplicate the <code class="literal">wall-top</code> object by naming the new object as <code class="literal">wall-bottom</code>, and change the position of <code class="literal">wall-bottom</code> to (0, 0.5, -10).</p></li><li><p>Create a new Sphere named as <code class="literal">Sphere-obstacle</code> with the following properties:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Position = (5, 0, 3)</p></li><li style="list-style-type: disc"><p>Scale = (10, 3, 3)</p></li></ul></div></li><li><p>In the <span class="strong"><strong>Hierarchy</strong></span> panel, select the <code class="literal">Sphere-obstacle</code> GameObject. Then in the <span class="strong"><strong>Navigation</strong></span> panel, check the <span class="strong"><strong>Navigation Static</strong></span> checkbox. Then, click on the <span class="strong"><strong>Bake</strong></span> button at the bottom of the <span class="strong"><strong>Navigation</strong></span> panel.</p></li><li><p>Finally, make the player's red cube larger by setting its scale to (3,3,3).</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec252"></a>How it works...</h3></div></div></div><p>The <code class="literal">Swarm</code> class contains three variables:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<code class="literal">droneCount</code>: It is an integer<a id="id916" class="indexterm"></a> referencing the number of the <code class="literal">Swarm</code> class members created</p></li><li style="list-style-type: disc"><p>
<code class="literal">dronePrefab</code>: It references<a id="id917" class="indexterm"></a> to the Prefab to be cloned to create swarm members</p></li><li style="list-style-type: disc"><p>
<code class="literal">Drone</code>: A list of objects that<a id="id918" class="indexterm"></a> reference <code class="literal">drones</code>, a list of all the scripted <code class="literal">Drone</code> components inside all the <code class="literal">Swarm</code> objects that have been created</p></li></ul></div><p>Upon creation, as the scene starts, the <code class="literal">Swarm</code> script class <code class="literal">Awake()</code> method loops to create <code class="literal">droneCount</code> swarm members by repeatedly calling the <code class="literal">AddDrone()</code> method. This method instantiates a new <code class="literal">GameObject</code> from the prefab, and then sets the <code class="literal">newDrone</code> variable to be a<a id="id919" class="indexterm"></a> reference to the Drone-scripted object, inside the new <code class="literal">Swarm</code> class member. In each frame, the <code class="literal">FixedUpdate()</code> method loops through the list of <code class="literal">Drone</code> objects by calling their <code class="literal">SetTargetPosition(…)</code> method, and passing in the <code class="literal">Swarm</code> center location and the average of all the swarm member velocities.</p><p>The rest of this <code class="literal">Swarm</code> class is made up of two methods: one (<code class="literal">SwarmCenterAverage</code>) returns a Vector3 object, representing the average position of all the <code class="literal">Drone</code> objects, and the other (<code class="literal">SwarmMovementAverage</code>) returns a <code class="literal">Vector3</code> object, representing the average velocity (movement force) of all the <code class="literal">Drone</code> objects as described in the following list.</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<code class="literal">SwarmMovementAverage()</code>:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>What is the general direction that the swarm is moving in?</p></li><li style="list-style-type: disc"><p>This is known <a id="id920" class="indexterm"></a>as <span class="strong"><strong>alignment</strong></span>—a swarm member attempting to move in the same direction as the swarm average</p></li></ul></div></li><li style="list-style-type: disc"><p>
<code class="literal">SwarmCenterAverage()</code>:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>What is the center position of the swarm?</p></li><li style="list-style-type: disc"><p>This is known as<a id="id921" class="indexterm"></a> <span class="strong"><strong>cohesion</strong></span>—a swarm member attempting to move towards the center of the swarm</p></li></ul></div></li></ul></div><p>The core work is undertaken by the <code class="literal">Drone</code> class. Each drone's <code class="literal">Start(…)</code> method finds and caches a reference to its NavMeshAgent component.</p><p>Each drone's <code class="literal">UpdateVelocity(…)</code> method takes as input two Vector3 arguments: <code class="literal">swarmCenterAverage</code> and <code class="literal">swarmMovementAverage</code>. This method then calculates the desired new velocity for this Drone (by simply adding the two vectors), and then uses the result (a Vector3 location) to update the NavMeshAgent's target location.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec253"></a>There's more...</h3></div></div></div><p>There are some details that you don't want to miss.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch08lvl3sec64"></a>Learn more about flocking Artificial Intelligence</h4></div></div></div><p>Most of the flocking models in modern computing owe much to the work of Craig Reynolds in the 1980s. Learn<a id="id922" class="indexterm"></a> more about Craig and his boids program at <a class="ulink" href="http://en.wikipedia.org/wiki/Craig_Reynolds_(computer_graphics)" target="_blank">http://en.wikipedia.org/wiki/Craig_Reynolds_(computer_graphics)</a>.</p></div></div></div>