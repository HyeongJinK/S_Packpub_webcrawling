<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec73"></a>Organizing States into Sub-state Machines</h2></div></div><hr /></div><p>Whenever the Animator area gets too cluttered, you can always think of organizing your Animation<a id="id772" class="indexterm"></a> States into Sub-State Machines. In this recipe, we will use this technique to organize animation states for turning the character. Also, since<a id="id773" class="indexterm"></a> the provided animation clips do not include Root Motion, we will use the opportunity to illustrate how to overcome the lack of Root Motion via script, using it to turn the character 45 degrees to the left and right.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_37.jpg" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec206"></a>Getting ready</h3></div></div></div><p>For this recipe, we have prepared a Unity Package named <code class="literal">Turning</code>, containing a basic scene that features an animated character. The package can be found inside the <code class="literal">1362_07_04</code> folder, along with animation clips called <code class="literal">Swat@turn_right_45_degrees.fbx</code> and <code class="literal">Swat@turn_left.fbx</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec207"></a>How to do it...</h3></div></div></div><p>To apply Root<a id="id774" class="indexterm"></a> Motion via script, please follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new project and import the <code class="literal">Turning</code> Unity Package. Then, from the <span class="strong"><strong>Project</strong></span> view, open the <span class="strong"><strong>mecanimPlayground</strong></span> level.</p></li><li><p>Import the <code class="literal">Swat@turn_right_45_degrees.fbx</code> and <code class="literal">Swat@turn_left.fbx</code> files in the project.</p></li><li><p>We need to configure our animation clips. Select the <span class="strong"><strong>Swat@turn_left</strong></span> file from the <span class="strong"><strong>Project</strong></span> view.</p></li><li><p>Activate the <a id="id775" class="indexterm"></a><span class="strong"><strong>Rig</strong></span> section. Change <span class="strong"><strong>Animation Type</strong></span> to <span class="strong"><strong>Humanoid</strong></span>, and <span class="strong"><strong>Avatar Definition</strong></span> to <span class="strong"><strong>Create From this Model</strong></span>. Confirm by clicking on <span class="strong"><strong>Apply</strong></span>.</p></li><li><p>Now, activate the <span class="strong"><strong>Animations</strong></span> section. Select the <span class="strong"><strong>turn_left</strong></span> clip (from the <span class="strong"><strong>Clips</strong></span> list), click on the <span class="strong"><strong>Clamp Range</strong></span> button to adjust the timeline, and check the <span class="strong"><strong>Loop Time</strong></span> option. Under <span class="strong"><strong>Root Transform Rotation</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and navigate to <span class="strong"><strong>Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <span class="strong"><strong>Root Transform Position (Y)</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and select <span class="strong"><strong>Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <span class="strong"><strong>Root Transform Position (XZ)</strong></span>, leave <span class="strong"><strong>Bake Into Pose</strong></span> unchecked. Click on <span class="strong"><strong>Apply</strong></span> to confirm the changes.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_26.jpg" /></div></li><li><p>Repeat steps 4 and 5 for <span class="strong"><strong>Swat@turning_right_45_degrees</strong></span>.</p></li><li><p>From the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>MsLaser</strong></span> character. Then, from the <span class="strong"><strong>Animator</strong></span> <a id="id776" class="indexterm"></a>component in the <span class="strong"><strong>Inspector</strong></span> view, open the <span class="strong"><strong>MainCharacter</strong></span> controller.</p></li><li><p>From the top-left corner <a id="id777" class="indexterm"></a>of the <span class="strong"><strong>Animator</strong></span> view, activate the <span class="strong"><strong>Parameters</strong></span> section and use the <span class="strong"><strong>+</strong></span> sign to create the two new <span class="strong"><strong>Parameters (Boolean) </strong></span>named <code class="literal">TurnLeft</code> and <code class="literal">TurnRight</code>.</p></li><li><p>Right-click on the gridded area. From the context menu, select <span class="strong"><strong>Create Sub-State Machine</strong></span>. From the <span class="strong"><strong>Inspector</strong></span> view, rename it <code class="literal">Turn</code>.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_27.jpg" /></div></li><li><p>Double-click on the <span class="strong"><strong>Turn</strong></span> sub-state machine. Right-click on the gridded area, select <span class="strong"><strong>Create State</strong></span> | <span class="strong"><strong>Empty</strong></span>, and add a new state. Rename it to <code class="literal">Turn Left</code>. Then, add <a id="id778" class="indexterm"></a>another state named <code class="literal">Turn Right</code>.</p></li><li><p>From the <span class="strong"><strong>Inspector</strong></span> <a id="id779" class="indexterm"></a>view, populate <code class="literal">Turn Left</code> with the <span class="strong"><strong>turn_left</strong></span> motion clip. Then, populate <code class="literal">Turn Right </code>with <span class="strong"><strong>turning_right_45_degrees</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_28.jpg" /></div></li><li><p>Get out of the <span class="strong"><strong>Turn</strong></span> sub-state machine back into the <span class="strong"><strong>Base Layer</strong></span>. By right-clicking on each state and selecting the option <span class="strong"><strong>Make Transition</strong></span>, create transitions between <span class="strong"><strong>Move </strong></span>and <span class="strong"><strong>Turn Left</strong></span>, and <span class="strong"><strong>Move </strong></span>and <span class="strong"><strong>Turn Right</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_29.jpg" /></div></li><li><p>Enter the <span class="strong"><strong>Turn</strong></span> sub-state machine. Then, create transitions from <span class="strong"><strong>Turn Left</strong></span> and <span class="strong"><strong>Turn Right</strong></span> into the <span class="strong"><strong>Move</strong></span> state.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_30.jpg" /></div></li><li><p>Select the arrow<a id="id780" class="indexterm"></a> that goes form <span class="strong"><strong>Turn Right</strong></span> to <span class="strong"><strong>(Up) Base Layer</strong></span>. It will turn blue. From the <span class="strong"><strong>Inspector</strong></span> view, uncheck the <span class="strong"><strong>Has Exit Time</strong></span> option. Then, access the <span class="strong"><strong>Conditions</strong></span> list, click<a id="id781" class="indexterm"></a> the <span class="strong"><strong>+</strong></span> sign to add a new condition, and set it as <span class="strong"><strong>TurnRight</strong></span> and <span class="strong"><strong>false</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_31.jpg" /></div></li><li><p>Select the arrow that goes from <span class="strong"><strong>(Up) Base Layer</strong></span> to <span class="strong"><strong>Turn Right</strong></span>. From the <span class="strong"><strong>Inspector</strong></span> view, uncheck the <span class="strong"><strong>Has Exit Time</strong></span> option. Then, access the <span class="strong"><strong>Conditions</strong></span> list, click the <span class="strong"><strong>+</strong></span> sign to add a new condition, and set it as <span class="strong"><strong>TurnRight</strong></span> and <span class="strong"><strong>true</strong></span>.</p></li><li><p>Repeat steps 14 and 15 with the arrows that go between <span class="strong"><strong>(Up) Base Layer</strong></span> and <span class="strong"><strong>Turn Left</strong></span>, using <span class="strong"><strong>TurnLeft</strong></span> as a condition, this time.</p></li><li><p>From the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>MsLaser</strong></span> character. Then, from the <span class="strong"><strong>Inspector</strong></span> view, open the script from the <span class="strong"><strong>BasicController</strong></span> component.</p></li><li><p>Immediately<a id="id782" class="indexterm"></a> after the <code class="literal">if(controller.isGrounded){</code> line, add:</p><div class="informalexample"><pre class="programlisting">if(Input.GetKey(KeyCode.Q)){
  anim.SetBool("TurnLeft", true);
  transform.Rotate(Vector3.up * (Time.deltaTime * -45.0f), Space.World);
}  else {
  anim.SetBool("TurnLeft", false);
}
if(Input.GetKey(KeyCode.E)){
  anim.SetBool("TurnRight", true);
  transform.Rotate(Vector3.up * (Time.deltaTime * 45.0f), Space.World);
} else {
  anim.SetBool("TurnRight", false);
}</pre></div></li><li><p>Save your script. Then, select the <span class="strong"><strong>MsLaser</strong></span> character and, from the <span class="strong"><strong>Inspector</strong></span> view, access the<a id="id783" class="indexterm"></a> <span class="strong"><strong>Basic Controller</strong></span> component. Leave the <span class="strong"><strong>Move Diagonally</strong></span> and <span class="strong"><strong>Mouse Rotate</strong></span> options unchecked. Also, leave the <span class="strong"><strong>Keyboard Rotate</strong></span> option checked. Finally, play the scene. You <a id="id784" class="indexterm"></a>will be able to turn left and right by using the <span class="emphasis"><em>Q</em></span> and <span class="emphasis"><em>E</em></span> keys, respectively.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec208"></a>How it works...</h3></div></div></div><p>As it should be clear from the recipe, the sub-state machines work in a similar way to groups or folders, allowing you to encapsulate a series of state machines into a single entity for easier reference. States from the sub-state machines can be transitioned from external states, in our case, the<a id="id785" class="indexterm"></a> <span class="strong"><strong>Move</strong></span> state, or even from different sub-state machines.</p><p>Regarding the character's rotation, we have overcome the lack of root motion by using the <code class="literal">transform.Rotate(Vector3.up * (Time.deltaTime * -45.0f), Space.World);</code> command to make the character actually turn around when the <span class="emphasis"><em>Q</em></span> and <span class="emphasis"><em>E</em></span> keys are being held down. This command was used in conjunction with <code class="literal">animator.SetBool("TurnLeft", true);</code>, which triggers the right animation clip.</p></div></div>