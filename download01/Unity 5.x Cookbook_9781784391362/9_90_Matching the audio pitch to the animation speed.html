<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec89"></a>Matching the audio pitch to the animation speed</h2></div></div><hr /></div><p>Many artifacts<a id="id933" class="indexterm"></a> sound higher in pitch when accelerated and <a id="id934" class="indexterm"></a>lower when slowed down. Car engines, fan coolers, Vinyl—a record player… the list goes on. If you want to simulate this kind of sound effect in an animated object that can have its speed changed dynamically, follow this recipe.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec255"></a>Getting ready</h3></div></div></div><p>For this recipe, you'll need an animated 3D object and an audio clip. Please use the files <code class="literal">animatedRocket.fbx</code> and <code class="literal">engineSound.wav</code>, available in the <code class="literal">1362_09_01</code> folder of the code bundle.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec256"></a>How to do it...</h3></div></div></div><p>To change the pitch of an audio clip according to the speed of an animated object, please follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Import the <code class="literal">animatedRocket.fbx</code> file into your <span class="strong"><strong>Project</strong></span>.</p></li><li><p>Select the <code class="literal">animatedRocket</code> file in the <span class="strong"><strong>Project</strong></span> view. Then, from the <span class="strong"><strong>Inspector</strong></span> view, check its <span class="strong"><strong>Import Settings</strong></span>. Select <span class="strong"><strong>Animations</strong></span>, then select the clip <span class="strong"><strong>Take 001</strong></span>, and make sure to check the <span class="strong"><strong>Loop Time</strong></span> option. Click on the <span class="strong"><strong>Apply</strong></span> button, shown as follows, to save the changes:</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362_09_02.jpg" /></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip11"></a>Tip</h3><p>The reason why we didn't need to check <span class="strong"><strong>Loop Pose</strong></span> option is because our animation already loops in a seamless fashion. If it didn't, we could have checked that option to automatically create a seamless transition from the last to the first frame<a id="id935" class="indexterm"></a> of the animation.</p></div></li><li><p>Add the <a id="id936" class="indexterm"></a><span class="strong"><strong>animatedRocket</strong></span> GameObject to the scene by dragging it from the <span class="strong"><strong>Project</strong></span> view into the <span class="strong"><strong>Hierarchy</strong></span> view.</p></li><li><p>Import the <code class="literal">engineSound.wav</code> audio clip.</p></li><li><p>Select the<span class="strong"><strong> animatedRocket</strong></span> GameObject. Then, drag <span class="strong"><strong>engineSound</strong></span> from the <span class="strong"><strong>Project</strong></span> view into the <span class="strong"><strong>Inspector</strong></span> view, adding it as an <span class="strong"><strong>Audio Source</strong></span> for that object.</p></li><li><p>In the <span class="strong"><strong>Audio Source</strong></span> component of <span class="strong"><strong>animatedRocket</strong></span>, check the box for the <span class="strong"><strong>Loop</strong></span> option, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362_09_03.jpg" /></div></li><li><p>We need to create a <a id="id937" class="indexterm"></a><span class="strong"><strong>Controller</strong></span> for our object. In the <span class="strong"><strong>Project</strong></span> view, click <span class="strong"><strong>Create</strong></span> <a id="id938" class="indexterm"></a>and select <span class="strong"><strong>Animator Controller</strong></span>. Name it as <code class="literal">rocketlController</code>.</p></li><li><p>Double-click <a id="id939" class="indexterm"></a>on <span class="strong"><strong>rocketController</strong></span> object to open the <span class="strong"><strong>Animator</strong></span> window, as shown. Then, right-click on the gridded area and select the <span class="strong"><strong>Create State</strong></span> | <span class="strong"><strong>Empty</strong></span> option, from the contextual menu:</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362_09_04.jpg" /></div></li><li><p>Name the new state <code class="literal">spin</code> and set <span class="strong"><strong>Take 001</strong></span> as its motion in the <span class="strong"><strong>Motion</strong></span> field:</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362_09_05.jpg" /></div></li><li><p>From the <span class="strong"><strong>Hierarchy</strong></span> view, select <span class="strong"><strong>animatedRocket</strong></span>. Then, in the <span class="strong"><strong>Animator</strong></span> component (in the <span class="strong"><strong>Inspector</strong></span> view), set <span class="strong"><strong>rocketController</strong></span> as its <span class="strong"><strong>Controller</strong></span> and make sure<a id="id940" class="indexterm"></a> that the <span class="strong"><strong>Apply Root Motion</strong></span> option is unchecked as shown:</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362_09_06.jpg" /></div></li><li><p>In the <span class="strong"><strong>Project</strong></span> view, create a new <span class="strong"><strong>C# Script</strong></span> and rename it to <code class="literal">ChangePitch</code>.</p></li><li><p>Open the <a id="id941" class="indexterm"></a>script in your editor and replace everything with the following code:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;

public class ChangePitch : MonoBehaviour{
  public float accel = 0.05f;
  public float minSpeed = 0.0f;
  public float maxSpeed = 2.0f;
  public float animationSoundRatio = 1.0f;
  private float speed = 0.0f;
  private Animator animator;
  private AudioSource audioSource;

  void Start(){
    animator = GetComponent&lt;Animator&gt;();
    audioSource = GetComponent&lt;AudioSource&gt;();
    speed = animator.speed;
    AccelRocket (0f);
  }

  void Update(){
    if (Input.GetKey (KeyCode.Alpha1))
      AccelRocket(accel);

    if (Input.GetKey (KeyCode.Alpha2))
      AccelRocket(-accel);
  }

  public void AccelRocket(float accel){
    speed += accel;
    speed = Mathf.Clamp(speed,minSpeed,maxSpeed);
    animator.speed = speed = Mathf.Clamp (speed, 0, maxSpeed);
    float soundPitch = animator.speed * animationSoundRatio;
    audioSource.pitch = soundPitch;
  }
}</pre></div></li><li><p>Save your <a id="id942" class="indexterm"></a>script and add it as a component to <span class="strong"><strong>animatedRocket</strong></span> GameObject.</p></li><li><p>Play the scene and change the animation speed by pressing key <span class="emphasis"><em>1</em></span> (accelerate) and <span class="emphasis"><em>2</em></span> (decelerate) on your alphanumeric keyboard. The audio pitch will change accordingly.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec257"></a>How it works...</h3></div></div></div><p>At the <code class="literal">Start()</code> method, besides storing the <span class="strong"><strong>Animator</strong></span> and <span class="strong"><strong>AudioSource</strong></span> components in variables, we'll <a id="id943" class="indexterm"></a>get the initial <code class="literal">speed</code> from the <span class="strong"><strong>Animator</strong></span>, and we'll call the <code class="literal">AccelRocket()</code> function by passing <code class="literal">0</code> as an argument, only for that function to calculate the resulting pitch for the <span class="strong"><strong>Audio Source</strong></span>. During <code class="literal">Update()</code> function, the lines of the <code class="literal">if(Input.GetKey (KeyCode.Alpha1))</code> and <code class="literal">if(Input.GetKey (KeyCode.Alpha2))</code> code detect whenever the <span class="emphasis"><em>1</em></span> or <span class="emphasis"><em>2</em></span> keys are being pressed on the alphanumeric keyboard to call the <code class="literal">AccelRocket()</code> function, passing a <code class="literal">accel</code> float variable as an argument. The <code class="literal">AccelRocket()</code> function, in its turn, increments <code class="literal">speed</code> with the received argument (the <code class="literal">accel</code> float variable). However, it uses the <code class="literal">Mathf.Clamp()</code>command to limit the new speed value between the minimum and maximum speed as set by the user. Then, it changes the <span class="strong"><strong>Animator</strong></span> speed and <span class="strong"><strong>Audio Source</strong></span> pitch according to the new <code class="literal">speed</code> absolute value. The value is clamped a second time to avoid negative numbers. Should you reverse the animation, check out a solution in the completed project included with the code files. Also, please note that setting the animation speed and therefore, the sound pitch to <code class="literal">0</code> will cause the sound to stop, making<a id="id944" class="indexterm"></a> it clear that stopping the object's animation also prevents the engine sound from playing.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec258"></a>There's more...</h3></div></div></div><p>Here is some information <a id="id945" class="indexterm"></a>on how to fine-tune and customize this recipe.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch09lvl3sec65"></a>Changing the Animation/Sound Ratio</h4></div></div></div><p>If you want the <a id="id946" class="indexterm"></a>audio clip pitch to be more or less affected by the animation speed, change the value of the <span class="strong"><strong>Animation/Sound Ratio</strong></span> parameter.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch09lvl3sec66"></a>Accessing the function from other scripts</h4></div></div></div><p>The <code class="literal">AccelRocket()</code> function was<a id="id947" class="indexterm"></a> made public <a id="id948" class="indexterm"></a>so that it can be accessed from other scripts. As an example, we have included the <code class="literal">ExtChangePitch.cs</code> script in <code class="literal">1362_09_01</code> folder. Try attaching this script to the <span class="strong"><strong>Main Camera</strong></span> object and use it to control the speed by clicking on the left and right mouse buttons.</p></div></div></div>