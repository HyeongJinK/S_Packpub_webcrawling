<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec72"></a>Mixing animations with Layers and Masks</h2></div></div><hr /></div><p>Mixing animations is a great way of adding complexity to your animated characters without requiring a vast number of animated clips. Using <span class="strong"><strong>Layers</strong></span> and <span class="strong"><strong>Masks</strong></span>, we can combine different animations by playing specific clips for the specific body parts of the character. In this<a id="id752" class="indexterm"></a> recipe, we will apply this technique to our animated character, triggering animation clips for firing a rifle, and throwing a<a id="id753" class="indexterm"></a> grenade with the character's upper body. We will do this while keeping the lower body moving or idle, according to the player's input.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec202"></a>Getting ready</h3></div></div></div><p>For this recipe, we have prepared a Unity Package named <code class="literal">Mixing</code>, containing a basic scene that features an animated character. The package can be found inside the <code class="literal">1362_07_03</code> folder, along with the animation clips called <code class="literal">Swat@firing_rifle.fbx</code> and <code class="literal">Swat@toss_grenade.fbx</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec203"></a>How to do it...</h3></div></div></div><p>To mix animations using layers and masks, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new project and import the <code class="literal">Mixing</code> Unity Package. Then, from the <span class="strong"><strong>Project view</strong></span>, open the <span class="strong"><strong>mecanimPlayground</strong></span> level.</p></li><li><p>Import the <code class="literal">Swat@firing_rifle.fbx</code> and <code class="literal">Swat@toss_grenade.fbx</code> files to the project.</p></li><li><p>We need to configure the animation clips. From the <span class="strong"><strong>Project view</strong></span>, select the <span class="strong"><strong>Swat@firing_rifle</strong></span> animation clip.</p></li><li><p>Activate the <span class="strong"><strong>Rig</strong></span> section. Change <span class="strong"><strong>Animation Type</strong></span> to <span class="strong"><strong>Humanoid</strong></span>, and <span class="strong"><strong>Avatar Definition</strong></span> to <span class="strong"><strong>Create From this Model</strong></span>. Confirm this by clicking on <span class="strong"><strong>Apply</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_09.jpg" /></div></li><li><p>Now, activate the <span class="strong"><strong>Animations</strong></span> section. Select the <span class="strong"><strong>firing_rifle</strong></span> clip (from the <span class="strong"><strong>Clips</strong></span> list), click <a id="id754" class="indexterm"></a>on the <span class="strong"><strong>Clamp Range</strong></span> button to adjust the timeline, and check the <span class="strong"><strong>Loop Time </strong></span>and <span class="strong"><strong>Loop Pose</strong></span> <a id="id755" class="indexterm"></a>options. Under <span class="strong"><strong>Root Transform Rotation</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and select <span class="strong"><strong>Baked Upon</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <span class="strong"><strong>Root Transform Position (Y)</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and select <span class="strong"><strong>Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <span class="strong"><strong>Root Transform Position (XZ)</strong></span>, leave <span class="strong"><strong>Bake Into Pose</strong></span> unchecked. Click on<span class="strong"><strong> Apply</strong></span> to confirm the changes.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_19.jpg" /></div></li><li><p>Select the <a id="id756" class="indexterm"></a><span class="strong"><strong>Swat@toss_grenade</strong></span><a id="id757" class="indexterm"></a> animation clip. Activate the <span class="strong"><strong>Rig</strong></span> section. Then, change <span class="strong"><strong>Animation Type</strong></span> to <span class="strong"><strong>Humanoid</strong></span>, and <span class="strong"><strong>Avatar Definition</strong></span> to <span class="strong"><strong>Create From this Model</strong></span>. Confirm it by clicking on <span class="strong"><strong>Apply</strong></span>.</p></li><li><p>Now, activate the <span class="strong"><strong>Animations</strong></span> section. Select the <span class="strong"><strong>toss_grenade</strong></span> clip (from the <span class="strong"><strong>Clips</strong></span> list), click on the button <span class="strong"><strong>Clamp Range</strong></span> to adjust the timeline, and leave the <span class="strong"><strong>Loop Time </strong></span>and <span class="strong"><strong>Loop Pose</strong></span> options unchecked. Under <span class="strong"><strong>Root Transform Rotation</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and select <span class="strong"><strong>Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <span class="strong"><strong>Root Transform Position (Y)</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and select <span class="strong"><strong>Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Original)</strong></span>. Under <span class="strong"><strong>Root Transform Position (XZ)</strong></span>, leave <span class="strong"><strong>Bake Into Pose</strong></span> unchecked. Click on <span class="strong"><strong>Apply</strong></span> to confirm the changes.</p></li><li><p>Let's create a<a id="id758" class="indexterm"></a> Mask. From the <span class="strong"><strong>Project</strong></span> view, click on the <span class="strong"><strong>Create</strong></span> button and add an <span class="strong"><strong>Avatar Mask</strong></span> to the project. Name it <a id="id759" class="indexterm"></a>as <span class="strong"><strong>BodyMask</strong></span>.</p></li><li><p>Select the <span class="strong"><strong>BodyMask</strong></span> tab and, in the <span class="strong"><strong>Inspector</strong></span> view, expand the <span class="strong"><strong>Humanoid</strong></span> section to unselect the character's legs, base, and <span class="strong"><strong>IK</strong></span> spots, turning their outline red.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_20.jpg" /></div></li><li><p>From the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>MsLaser</strong></span> character. Then, from the <span class="strong"><strong>Animator</strong></span> component in the <span class="strong"><strong>Inspector</strong></span> view, double-click on the <span class="strong"><strong>MainCharacter</strong></span> controller to open it.</p></li><li><p>In the <span class="strong"><strong>Animator</strong></span> view, create a new layer by clicking on the <span class="strong"><strong>+</strong></span> sign at the top-left <span class="strong"><strong>Layers </strong></span>tab, above the <span class="strong"><strong>Base Layer</strong></span>.</p></li><li><p>Name the new <a id="id760" class="indexterm"></a>layer as <span class="strong"><strong>UpperBody</strong></span> and click on the gear icon for the settings. Then, change its <span class="strong"><strong>Weight</strong></span> to <code class="literal">1</code>, and <a id="id761" class="indexterm"></a>select the <span class="strong"><strong>BodyMask</strong></span> in the <span class="strong"><strong>Mask</strong></span> slot. Also, change Blending to <span class="strong"><strong>Additive</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_21.jpg" /></div></li><li><p>Now, in the <span class="strong"><strong>Animator</strong></span> view, with the <span class="strong"><strong>UpperBody</strong></span> layer selected, create three new empty states (by right-clicking on the gridded area and navigating to, from the menu, <span class="strong"><strong>Create State</strong></span> | <span class="strong"><strong>Empty</strong></span>). Name the default (orange) state <span class="strong"><strong>null</strong></span>, and the other two as <span class="strong"><strong>Fire</strong></span> and <span class="strong"><strong>Grenade</strong></span>.</p></li><li><p>Now, access the <span class="strong"><strong>Parameters</strong></span> tab and add two new parameters of the Boolean type: <code class="literal">Fire</code> and <code class="literal">Grenade</code>.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_22.jpg" /></div></li><li><p>Select the <span class="strong"><strong>Fire</strong></span> state and, in the <span class="strong"><strong>Inspector</strong></span> view, add the <span class="strong"><strong>firing_rifle</strong></span> animation clip to the <span class="strong"><strong>Motion</strong></span> field.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_23.jpg" /></div></li><li><p>Now, select the <span class="strong"><strong>Grenade</strong></span> state and, in the <span class="strong"><strong>Inspector</strong></span> view, add the <span class="strong"><strong>toss_grenade</strong></span><a id="id762" class="indexterm"></a> animation clip to the <span class="strong"><strong>Motion</strong></span> field.</p></li><li><p>Right-click on the<a id="id763" class="indexterm"></a> <span class="strong"><strong>null</strong></span> state box and, from the menu, select <span class="strong"><strong>Make Transition</strong></span>. Then, drag the white arrow onto the <span class="strong"><strong>Fire</strong></span> box.</p></li><li><p>Select the arrow (it will turn blue). From the <span class="strong"><strong>Inspector</strong></span> view, uncheck the <span class="strong"><strong>Has Exit Time</strong></span> option. Then, access the <span class="strong"><strong>Conditions</strong></span> list, click on the <span class="strong"><strong>+</strong></span> sign to add a new condition, and set it as <span class="strong"><strong>Fire</strong></span> and <span class="strong"><strong>true</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_24.jpg" /></div></li><li><p>Now, make a transition from <span class="strong"><strong>null</strong></span> to <span class="strong"><strong>Grenade</strong></span>. Select the arrow (it will turn blue). From the <span class="strong"><strong>Inspector</strong></span> view, uncheck the <span class="strong"><strong>Has Exit Time</strong></span> option. Then, access the <a id="id764" class="indexterm"></a><span class="strong"><strong>Conditions</strong></span> list, click on the <span class="strong"><strong>+</strong></span> sign to add a new condition, and set it as <span class="strong"><strong>Grenade</strong></span> and <span class="strong"><strong>true</strong></span>.</p></li><li><p>Now, create<a id="id765" class="indexterm"></a> transitions from <span class="strong"><strong>Fire</strong></span> to <span class="strong"><strong>null</strong></span>, and from <span class="strong"><strong>Grenade</strong></span> to <span class="strong"><strong>null</strong></span>. Then, select the arrow that goes from <span class="strong"><strong>Fire</strong></span> to <span class="strong"><strong>null</strong></span> and, in the <span class="strong"><strong>Conditions</strong></span> box, select the <span class="strong"><strong>Fire</strong></span> and <span class="strong"><strong>false</strong></span> options. Leave the <span class="strong"><strong>Has Exit Time </strong></span>option checked.</p></li><li><p>Finally, select the arrow that goes from <span class="strong"><strong>Grenade</strong></span> to <span class="strong"><strong>null</strong></span>. In the Conditions box, select the options <code class="literal">Grenade</code>, <code class="literal">false</code>. Leave the <span class="strong"><strong>Has Exit Time </strong></span>option checked.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_25.jpg" /></div></li><li><p>From the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>MsLaser</strong></span> character. Locate, in the <span class="strong"><strong>Inspector</strong></span> view, the <span class="strong"><strong>Basic Controller </strong></span>component and open its script.</p></li><li><p>Immediately<a id="id766" class="indexterm"></a> before the end of the<a id="id767" class="indexterm"></a> <code class="literal">Update()</code> function, add the following code:</p><div class="informalexample"><pre class="programlisting">  if(Input.GetKeyDown(KeyCode.F)){
    anim.SetBool("Grenade", true);
  } else {
    anim.SetBool("Grenade", false);
  }
  if(Input.GetButtonDown("Fire1")){
    anim.SetBool("Fire", true);
  }
  if(Input.GetButtonUp("Fire1")){
    anim.SetBool("Fire", false);
  }</pre></div></li><li><p>Save the script and play your scene. You will be able to trigger the <span class="strong"><strong>firing_rifle</strong></span> and <span class="strong"><strong>toss_grenade</strong></span> animations by clicking on the <span class="strong"><strong>fire</strong></span> button and pressing the <span class="emphasis"><em>F</em></span> key. Observe how the character's legs still respond to the <span class="strong"><strong>Move</strong></span> animation state.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec204"></a>How it works...</h3></div></div></div><p>Once the Avatar mask is created, it can be used as a way of filtering the body parts that would actually play<a id="id768" class="indexterm"></a> the animation states of a particular layer. In our case, we have constrained our <span class="strong"><strong>fire_rifle</strong></span> and <span class="strong"><strong>toss_grenade</strong></span> animation<a id="id769" class="indexterm"></a> clips to the upper body of our character, leaving the lower body free to play the movement-related animation clips, such as walking, running, and strafing.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec205"></a>There's more...</h3></div></div></div><p>You might have noticed that the <span class="strong"><strong>UpperBody</strong></span> layer has a parameter named <span class="strong"><strong>Blending</strong></span>, which we have set to <span class="strong"><strong>Additive</strong></span>. This means that animation states in this layer will be added to the ones from the lower layers. If changed to <span class="strong"><strong>Override</strong></span>, the animation from this would override animation states from the lower layers when played. In our case, <span class="strong"><strong>Additive</strong></span> helped in keeping the aim stable when firing while running.</p><p>For more information on<a id="id770" class="indexterm"></a> <span class="strong"><strong>Animation Layers</strong></span> and <span class="strong"><strong>Avatar Body Masks</strong></span>, check out<a id="id771" class="indexterm"></a> Unity's documentation at <a class="ulink" href="http://docs.unity3d.com/Manual/AnimationLayers.html" target="_blank">http://docs.unity3d.com/Manual/AnimationLayers.html</a> and <a class="ulink" href="http://docs.unity3d.com/Manual/class-AvatarMask.html" target="_blank">http://docs.unity3d.com/Manual/class-AvatarMask.html</a>.</p></div></div>