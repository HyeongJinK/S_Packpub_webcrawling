<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch11lvl1sec120"></a>Identifying performance bottlenecks with the Unity performance Profiler</h2></div></div><hr /></div><p>
<span class="strong"><strong>Optimization principal 4</strong></span>: Use performance data to drive design and coding decisions.</p><p>As well as following<a id="id1263" class="indexterm"></a> general asset and code design principals, which we know ought to lead to improved performance, we should be aware that each game is different and that, in reality, the only way to know which design decisions affect performance the most is to collect and analyze runtime performance<a id="id1264" class="indexterm"></a> data. While a raw <span class="strong"><strong>Frames Per Second</strong></span> (<span class="strong"><strong>FPS</strong></span>) measurement is useful, to choose between different decisions having detailed information about the processing requirements for rendering and code execution for each frame is invaluable.</p><p>The Unity 5 <span class="strong"><strong>Profiler</strong></span> offers a detailed breakdown of code and rendering processing requirements, as well as processing required by GPU, audio, and both 2D and 3D physics. Perhaps the most useful, it allows programmers to explicitly record data for named code segments. We will name our profile <code class="literal">MATT_SomeCalculations</code> and record and examine frame-by-frame processing requirements for our calculations.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_11_29.jpg" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec380"></a>How to do it...</h3></div></div></div><p>To record processing requirements<a id="id1265" class="indexterm"></a> using the Unity <span class="strong"><strong>Profiler</strong></span>, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Start a new 2D project.</p></li><li><p>Open the <span class="strong"><strong>Profiler</strong></span> window from the <span class="strong"><strong>Window</strong></span> menu and ensure that the <span class="strong"><strong>Record</strong></span> option is selected, and that the <span class="strong"><strong>Scripts</strong></span> performance data is being collected, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_11_30.jpg" /></div></li><li><p>Add the following C# script class <code class="literal">ProfileCalculations</code> to the <span class="strong"><strong>Main Camera</strong></span>:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class ProfileCalculations : MonoBehaviour {
  public int outerLoopIterations = 20;
  public int innerLoopMaxIterations = 100;

  void Update(){
    Profiler.BeginSample("MATT_calculations");

    for(int i = 0; i &lt; outerLoopIterations; i++){
      int innerLoopIterations = Random.Range(2,innerLoopMaxIterations);
      for(int j = 0; j &lt; innerLoopIterations; j++){
        float n = Random.Range(-1000f, 1000f);
      }
    }

    Profiler.EndSample();
  }
}</pre></div></li><li><p>Run the game for 20 to 30 seconds.</p></li><li><p>Stop the game running. You should now see in the <span class="strong"><strong>Profiler</strong></span> panel details of the breakdown <a id="id1266" class="indexterm"></a>of processing required for the selected frame—each of the jagged lines in the top<a id="id1267" class="indexterm"></a> right of the <span class="strong"><strong>Profiler</strong></span> panel represents the collected data for a frame.</p></li><li><p>View data for different frames by dragging the white line to a different horizontal position—the current frame and the total number of frames are shown at the top right in the form <span class="strong"><strong>Frame: frame / totalFrames</strong></span>.</p></li><li><p>Since we have named a code profile sample, prefixed with <span class="strong"><strong>MATT</strong></span>, we can limit the display of data to only samples containing that word. In the search text box (next to the little magnifying glass,) type <code class="literal">MATT</code>, and you should now see just a single<a id="id1268" class="indexterm"></a> row of profile data for our sample <span class="strong"><strong>MATT_calculations</strong></span>. We can see that for frame 83, our code took up 1.2 percent of the processing for that frame.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_11_31.jpg" /></div></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec381"></a>How it works...</h3></div></div></div><p>The <code class="literal">ProfileCalculations</code> script ensures that we make Unity do something for each frame; it does lots of calculations with an inner and outer loop, just like in the previous FPS recipe.</p><p>The two important statements are those that mark the beginning and ending of a named code sample to be recorded and presented in the <span class="strong"><strong>Profiler</strong></span>. The <code class="literal">Profiler.BeginSample("MATT_calculations")</code> statement starts our named profile and it is ended with the<a id="id1269" class="indexterm"></a> <code class="literal">EndSample()</code> statement.</p><p>Using an eye-catching prefix allows us to easily isolate our named code profile for analysis, using the search text box in the <span class="strong"><strong>Profiler</strong></span> panel.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec382"></a>See also</h3></div></div></div><p>Refer to the following recipes in this chapter for more information:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="emphasis"><em>Evaluating performance by measuring max and min frame rates (FPS)</em></span>
</p></li><li style="list-style-type: disc"><p>
<span class="emphasis"><em>Identifying performance bottlenecks with Do-It-Yourself performance profiling</em></span>
</p></li></ul></div></div></div>