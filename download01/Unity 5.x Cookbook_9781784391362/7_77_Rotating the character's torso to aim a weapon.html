<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec78"></a>Rotating the character's torso to aim a weapon</h2></div></div><hr /></div><p>When playing a<a id="id828" class="indexterm"></a> third-person character, you might want her to aim her weapon at some target that is not directly in front of her, without making her change her direction. In these <a id="id829" class="indexterm"></a>cases, you will need to apply what is called a <span class="emphasis"><em>procedural animation</em></span>, which does not rely on premade animation clips, but rather on the processing of other data, such as player input, to animate the character. In this recipe, we will use this technique to rotate the character's spine by moving the mouse, allowing for adjustments in the character's aim. We will also use this opportunity to cast a ray from the character's weapon and display a crosshair over the nearest object on target. Please note that this approach will work with the cameras standing behind the third-person controlled characters.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec223"></a>Getting ready</h3></div></div></div><p>For this recipe, we have prepared a Unity Package named <code class="literal">AimPointer</code>, containing a basic scene that features a character armed with a laser pointer. The package, which also includes the <code class="literal">crossAim</code> sprite that is to be used as a crosshair for aiming, can be found inside the <code class="literal">1362_07_09</code> folder.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec224"></a>How to do it...</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new<a id="id830" class="indexterm"></a> project and import the <code class="literal">AimPointer</code> Unity Package. Then, from the <span class="strong"><strong>Project</strong></span> view, open the <span class="strong"><strong>mecanimPlayground</strong></span> level. You will see an animated character named <span class="strong"><strong>MsLaser</strong></span> holding the <span class="strong"><strong>pointerPrefab</strong></span> object.</p></li><li><p>From the <span class="strong"><strong>Project</strong></span> view, create a new <span class="strong"><strong>C# Script</strong></span> named <code class="literal">MouseAim.cs</code>.</p></li><li><p>Open the script and<a id="id831" class="indexterm"></a> add the following code:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class MouseAim : MonoBehaviour {
  
  public Transform spine;
  private float xAxis = 0f;
  private float yAxis = 0f;
  public Vector2 xLimit = new Vector2(-30f,30f);
  public Vector2 yLimit= new Vector2(-30f,30f);
  public Transform weapon;
  public GameObject crosshair;
  private Vector2 aimLoc;

  public void LateUpdate(){

    yAxis += Input.GetAxis ("Mouse X");
    yAxis = Mathf.Clamp (yAxis, yLimit.x, yLimit.y);
    xAxis -= Input.GetAxis ("Mouse Y");
    xAxis = Mathf.Clamp (xAxis, xLimit.x, xLimit.y);
    Vector3 corr = new Vector3(xAxis,yAxis, spine.localEulerAngles.z);
    spine.localEulerAngles = corr;
    RaycastHit hit;
    Vector3 fwd = weapon.TransformDirection(Vector3.forward);
    if (Physics.Raycast (weapon.position, fwd, out hit)) {
      print (hit.transform.gameObject.name);
      aimLoc =  Camera.main.WorldToScreenPoint(hit.point);
      crosshair.SetActive(true);
      crosshair.transform.position = aimLoc;
    } else {
     crosshair.SetActive(false);
    }
    Debug.DrawRay (weapon.position, fwd, Color.red);
  }
}</pre></div></li><li><p>Save and close the script.</p></li><li><p>From the <span class="strong"><strong>Hierarchy</strong></span> view, create a new <span class="strong"><strong>UI</strong></span> | <span class="strong"><strong>Image</strong></span> GameObject. Then, from the <span class="strong"><strong>Inspector</strong></span> <a id="id832" class="indexterm"></a>view, change its name to <code class="literal">crosshair</code>. Also, in <span class="strong"><strong>Rect</strong></span><a id="id833" class="indexterm"></a><span class="strong"><strong> Transform</strong></span>, set its <span class="strong"><strong>Width</strong></span> and <span class="strong"><strong>Height</strong></span> to <code class="literal">16</code> and populate <span class="strong"><strong>Source Image</strong></span> field with the <span class="strong"><strong>crossAim</strong></span> sprite.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_46.jpg" /></div></li><li><p>Attach<a id="id834" class="indexterm"></a> the <span class="strong"><strong>MouseAim.cs</strong></span> <a id="id835" class="indexterm"></a>script to the <span class="strong"><strong>MsLaser</strong></span> GameObject.</p></li><li><p>Select the <span class="strong"><strong>MsLaser</strong></span> GameObject and from the <span class="strong"><strong>Inspector</strong></span> view's <span class="strong"><strong>Mouse Aim</strong></span> component, populate the <span class="strong"><strong>Spine</strong></span> field with <span class="strong"><strong>mixamorig:Spine</strong></span>; the <span class="strong"><strong>Weapon</strong></span> field with <span class="strong"><strong>pointerPrefab</strong></span>; and the <span class="strong"><strong>Crosshair</strong></span> field with the <span class="strong"><strong>crosshair</strong></span> UI GameObject.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_47.jpg" /></div></li><li><p>Play the scene. You<a id="id836" class="indexterm"></a> will now be able to rotate the character's torso by moving the mouse. Even<a id="id837" class="indexterm"></a> better, the crosshair GUI texture will be displayed at the top of the object that is being aimed at by the pointer.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_48.jpg" /></div></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec225"></a>How it works...</h3></div></div></div><p>You might have noticed that all the code for rotating the character's spine is inside the <code class="literal">LateUpdate</code> function, as opposed to the more common <code class="literal">Update</code> function. The reason for this is to make sure that all the transform manipulation will be executed after the original animation clip is played, overriding it.</p><p>Regarding the spine rotation, our script adds the horizontal and vertical speed of the mouse to the <code class="literal">xAxis</code> and <code class="literal">yAxis</code> float variables. These variables are then constrained within the specified limits, avoiding distortions to the character's model. Finally, the <code class="literal">spine</code> object transform rotation for <span class="emphasis"><em>x</em></span> and <span class="emphasis"><em>y</em></span> axes are set to <code class="literal">xAxis</code> and <code class="literal">yAxis</code> respectively. The <span class="emphasis"><em>z</em></span>-axis<a id="id838" class="indexterm"></a> is preserved from the original animation clip.</p><p>Additionally, our<a id="id839" class="indexterm"></a> script uses a <code class="literal">Raycast</code> command to detect if there is any object's collider within the weapon's aim, in which case a crosshair will be drawn on the screen.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec226"></a>There's more...</h3></div></div></div><p>Since this recipe's script was tailored for cameras standing behind the third-person controlled characters, we have included a more generic solution to the problemâ€”in fact, a similar approach to the one presented in <span class="emphasis"><em>Unity 4.x Cookbook</em></span>, <span class="emphasis"><em>Packt Publishing</em></span>. An alternate script named <code class="literal">MouseAimLokkAt</code>, which can be found inside the <code class="literal">1362_07_09</code> folder, starts by converting our bi-dimensional mouse cursor screen's coordinates to the three-dimensional world space coordinates (stored in a <code class="literal">point</code> variable). Then, it rotates the character's torso towards the <span class="emphasis"><em>point</em></span> location, using the <code class="literal">LookAt()</code> command to do so. Additionally, it makes sure that the spine does not extrapolate <code class="literal">minY</code> and <code class="literal">maxY</code> angles, otherwise causing distortions to the character model. Also, we have included a <code class="literal">Compensation YAngle</code> variable that makes it possible for us to fine-tune the character's alignment with the mouse cursor. Another addition is the option to freeze the X-axis rotation, in case you just want the character to rotate the torso laterally, but not look up or down. Again, this script uses a <code class="literal">Raycast</code> command to detect objects in front of the weapon's aim, drawing a crosshair on the screen when they are present.</p></div></div>