<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec75"></a>Adding rigid props to animated characters</h2></div></div><hr /></div><p>In case you<a id="id793" class="indexterm"></a> haven't included a sufficient number of props to your character when modeling and animating it, you might want to give her the <a id="id794" class="indexterm"></a>chance of collecting new ones at runtime. In this recipe, we will learn how to instantiate a GameObject and assign it to a character, respecting the animation hierarchy.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec212"></a>Getting ready</h3></div></div></div><p>For this recipe, we have prepared a Unity Package named <code class="literal">Props</code>, containing a basic scene that features an animated character and a prefab named <span class="strong"><strong>badge</strong></span>. The package can be found inside the <code class="literal">1362_07_06</code> folder.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec213"></a>How to do it...</h3></div></div></div><p>To add a rigid prop at runtime to an animated character, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new project and import the <code class="literal">Props</code> Unity Package. Then, from the <span class="strong"><strong>Project</strong></span> view, open the <span class="strong"><strong>mecanimPlayground</strong></span> level.</p></li><li><p>From the <span class="strong"><strong>Project</strong></span> view, add the <span class="strong"><strong>badge</strong></span> prop to the scene by dragging it onto the <span class="strong"><strong>Hierarchy</strong></span> view. Then, make it a child of the <span class="strong"><strong>mixamorig:Spine2</strong></span> transform (use the <span class="strong"><strong>Hierarchy</strong></span> tree to navigate to <span class="strong"><strong>MsLaser</strong></span> | <span class="strong"><strong>mixamorig:Hips</strong></span> | <span class="strong"><strong>mixamorig:Spine</strong></span> | <span class="strong"><strong>mixamorig:Spine1</strong></span> | <span class="strong"><strong>mixamorig:Spine2</strong></span>). Then, make the <span class="strong"><strong>badge</strong></span> object visible above the character's chest by changing its <span class="strong"><strong>Transform Position</strong></span> to <span class="strong"><strong>X</strong></span>: <code class="literal">-0.08</code>, <span class="strong"><strong>Y</strong></span>: <code class="literal">0,</code> <span class="strong"><strong>Z</strong></span>: <code class="literal">0.15</code>; and <span class="strong"><strong>Rotation</strong></span> to <span class="strong"><strong>X</strong></span>: <code class="literal">0.29</code>, <span class="strong"><strong>Y</strong></span>: <code class="literal">0.14</code>, <span class="strong"><strong>Z</strong></span>:<code class="literal">-13.29</code>.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_39.jpg" /></div></li><li><p>Make a note of the <span class="strong"><strong>Position</strong></span> and <span class="strong"><strong>Rotation</strong></span> values, and delete the <span class="strong"><strong>badge</strong></span> object from the scene.</p></li><li><p>Add a new <span class="strong"><strong>Cube</strong></span> to the scene (drop-down <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>3D Object</strong></span> | <span class="strong"><strong>Cube</strong></span>), rename it as <span class="strong"><strong>PropTrigger</strong></span>, and change its Position to <span class="strong"><strong>X</strong></span>: <code class="literal">0</code>, <span class="strong"><strong>Y</strong></span>: <code class="literal">0.5</code>, <span class="strong"><strong>Z</strong></span>: <code class="literal">2</code>.</p></li><li><p>From the <span class="strong"><strong>Inspector</strong></span> view's <span class="strong"><strong>Box Collider</strong></span> component, check the <span class="strong"><strong>Is Trigger</strong></span> option.</p></li><li><p>From the<a id="id795" class="indexterm"></a> <span class="strong"><strong>Project</strong></span> view, create a new <span class="strong"><strong>C# Script</strong></span> named <code class="literal">AddProp.cs</code>.</p></li><li><p>Open the<a id="id796" class="indexterm"></a> script and add the following code:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class AddProp : MonoBehaviour {
  public GameObject prop;
  public Transform targetBone;
  public Vector3 positionOffset;
  public Vector3 rotationOffset;
  public bool  destroyTrigger = true;
  
  void  OnTriggerEnter ( Collider collision  ){
    
    if (targetBone.IsChildOf(collision.transform)){
      bool  checkProp = false;
      foreach(Transform child in targetBone){
        if (child.name == prop.name)
          checkProp = true;
      }
      
      if(!checkProp){
        GameObject newprop;
        newprop = Instantiate(prop, targetBone.position, targetBone.rotation) as GameObject;
        newprop.name = prop.name;
        newprop.transform.parent = targetBone;
        newprop.transform.localPosition += positionOffset;
        newprop.transform.localEulerAngles += rotationOffset;
        if(destroyTrigger)
          Destroy(gameObject);
      }
    }
  }
}</pre></div></li><li><p>Save and close the script.</p></li><li><p>Attach the <span class="strong"><strong>AddProp.cs</strong></span> script to the <span class="strong"><strong>PropTrigger</strong></span> GameObject.</p></li><li><p>Select the <span class="strong"><strong>PropTrigger</strong></span> textbox and check out its <span class="strong"><strong>Add Prop</strong></span> component. First, populate<a id="id797" class="indexterm"></a> the <span class="strong"><strong>Prop</strong></span> field with the <span class="strong"><strong>badge</strong></span> prefab. Then, populate <span class="strong"><strong>Target Bone</strong></span> with the <span class="strong"><strong>mixamorig:Spine2</strong></span> transform. Finally, assign the <span class="strong"><strong>Position</strong></span> and <span class="strong"><strong>Rotation</strong></span> values<a id="id798" class="indexterm"></a> that we have previously made a note of to the <span class="strong"><strong>Position Offset</strong></span> and <span class="strong"><strong>Rotation Offset</strong></span> fields, respectively (<span class="strong"><strong>Position Offset</strong></span>: <span class="strong"><strong>X</strong></span>: <code class="literal">-0.08</code>, <span class="strong"><strong>Y</strong></span>: <code class="literal">0,</code> <span class="strong"><strong>Z</strong></span>: <code class="literal">0.15</code>; <span class="strong"><strong>Rotation Offset</strong></span>: <span class="strong"><strong>X</strong></span>: <code class="literal">0.29</code>, <span class="strong"><strong>Y</strong></span>: <code class="literal">0.14</code>, <span class="strong"><strong>Z</strong></span>:<code class="literal">-13.29</code>).</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_40.jpg" /></div></li><li><p>Play the scene. Using the 'WASD' keyboard control scheme, direct the character to the<a id="id799" class="indexterm"></a> <span class="strong"><strong>PropTrigger </strong></span>textbox. Colliding with it will add a badge to the character.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_41.jpg" /></div></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec214"></a>How it works...</h3></div></div></div><p>Once it's been triggered by the character, the script attached to <span class="strong"><strong>PropTrigger</strong></span> instantiates the assigned prefab, making it a child of the bones that they have been "placed into". The <span class="strong"><strong>Position Offset</strong></span> and <span class="strong"><strong>Rotation Offset</strong></span> can be used to fine-tune the exact position of the prop (relative to its<a id="id800" class="indexterm"></a> parent transform). As the props become parented by the bones of the animated character, they will follow and respect its hierarchy and animation. Note that the script checks for the preexisting props of the same name<a id="id801" class="indexterm"></a> before actually instantiating a new one.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec215"></a>There's more...</h3></div></div></div><p>You can make a similar script to remove the props. In this case, the <code class="literal">OnTriggerEnter</code> function will contain only the following code:</p><div class="informalexample"><pre class="programlisting">if (targetBone.IsChildOf(collision.transform)){
   foreach(Transform child in targetBone){
      if (child.name == prop.name)
        Destroy (child.gameObject);
    }
}</pre></div></div></div>