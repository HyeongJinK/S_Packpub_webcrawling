<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec104"></a>Loading game data from a text file map</h2></div></div><hr /></div><p>Rather than, for <a id="id1100" class="indexterm"></a>every level of a game, having to create and place every GameObject on the screen by hand, a better approach can be to create the text files of rows, and columns of characters, where each character corresponds to the type of GameObject that is to be created in the corresponding location. In this recipe, we'll use a text file and set of prefab sprites to display a graphical version of a text-data file for a screen from the classic game called <a id="id1101" class="indexterm"></a><span class="strong"><strong>NetHack</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_10_11.jpg" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec319"></a>Getting ready</h3></div></div></div><p>In the <code class="literal">1362_10_08</code> folder, we have provided the following two files for this recipe:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<code class="literal">level1.txt</code> (a text file, representing a level)</p></li><li style="list-style-type: disc"><p>
<code class="literal">absurd128.png</code> (a 128 x 128 sprite sheet for Nethack).</p></li></ul></div><p>The level data came from the <a id="id1102" class="indexterm"></a>Nethack Wikipedia page, and the sprite sheet came from SourceForge:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<a class="ulink" href="http://en.wikipedia.org/wiki/NetHack" target="_blank">http://en.wikipedia.org/wiki/NetHack</a>
</p></li><li style="list-style-type: disc"><p>
<a class="ulink" href="http://sourceforge.net/projects/noegnud/files/tilesets_nethack-3.4.1/absurd%20128x128/" target="_blank">http://sourceforge.net/projects/noegnud/files/tilesets_nethack-3.4.1/absurd%20128x128/</a>
</p></li></ul></div><p>Note that we <a id="id1103" class="indexterm"></a>also included a Unity package with all the prefabs set up, since this can be a laborious task.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec320"></a>How to do it...</h3></div></div></div><p>To load game data from a text file map, do the following:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Import the text file called <code class="literal">level1.txt</code>, and the image file called <code class="literal">absurd128.png</code>.</p></li><li><p>Select <code class="literal">absurd128.png</code> in the Inspector, and set <span class="strong"><strong>Texture Type</strong></span> to <span class="strong"><strong>Sprite (2D/uGUI)</strong></span>, and <span class="strong"><strong>Sprite Mode</strong></span> to <span class="strong"><strong>Multiple</strong></span>.</p></li><li><p>Edit this sprite in the <span class="strong"><strong>Sprite Editor</strong></span>, choosing <span class="strong"><strong>Type</strong></span> as <span class="strong"><strong>Grid</strong></span> and <span class="strong"><strong>Pixel Size</strong></span> as <code class="literal">128</code> x <code class="literal">128</code>, and apply these settings.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_10_12.jpg" /></div></li><li><p>In the <span class="strong"><strong>Project</strong></span> panel, click on the right-facing white triangle to <span class="emphasis"><em>explode</em></span> the icon, to show all the sprites in this sprite sheet individually.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_10_13.jpg" /></div></li><li><p>Drag the Sprite called <code class="literal">absurd128_175</code> onto the scene.</p></li><li><p>Create a<a id="id1104" class="indexterm"></a> new <span class="strong"><strong>Prefab</strong></span> named <code class="literal">corpse_175</code> in the <span class="strong"><strong>Project</strong></span> panel, and drag onto this blank prefab Sprite <code class="literal">absurd128_175</code> from the scene. Now, delete the sprite instance from the scene. You have now created a prefab containing the Sprite <code class="literal">175</code>.</p></li><li><p>Repeat this process for the following sprites (that is, create prefabs for each one):</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>
<code class="literal">floor_848</code>
</p></li><li><p>
<code class="literal">corridor_849</code>
</p></li><li><p>
<code class="literal">horiz_1034</code>
</p></li><li><p>
<code class="literal">vert_1025</code>
</p></li><li><p>
<code class="literal">door_844</code>
</p></li><li><p>
<code class="literal">potion_675</code>
</p></li></ol></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<code class="literal">chest_586</code>
</p></li><li style="list-style-type: disc"><p>
<code class="literal">alter_583</code>
</p></li><li style="list-style-type: disc"><p>
<code class="literal">stairs_up_994</code>
</p></li><li style="list-style-type: disc"><p>
<code class="literal">stairs_down_993</code>
</p></li><li style="list-style-type: disc"><p>
<code class="literal">wizard_287</code>
</p></li></ul></div></li><li><p>Select the <span class="strong"><strong>Main Camera</strong></span> in the Inspector, and ensure that it is set to an <span class="strong"><strong>Orthographic</strong></span> camera, sized <span class="strong"><strong>20</strong></span>, with <span class="strong"><strong>Clear Flags</strong></span> as <span class="strong"><strong>Solid Color</strong></span> and <span class="strong"><strong>Background</strong></span> as <span class="strong"><strong>Black</strong></span>.</p></li><li><p>Attach the following C# code to the Main Camera as the script class called <code class="literal">LoadMapFromTextfile</code>:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

using System.Collections.Generic;

public class LoadMapFromTextfile : MonoBehaviour
{
  public TextAsset levelDataTextFile;

  public GameObject floor_848;
  public GameObject corridor_849;
  public GameObject horiz_1034;
  public GameObject vert_1025;
  public GameObject corpse_175;
  public GameObject door_844;
  public GameObject potion_675;
  public GameObject chest_586;
  public GameObject alter_583;
  public GameObject stairs_up_994;
  public GameObject stairs_down_993;
  public GameObject wizard_287;	

  public Dictionary&lt;char, GameObject&gt; dictionary = new Dictionary&lt;char, GameObject&gt;();

  void Awake(){
    char newlineChar = '\n';

    dictionary['.'] = floor_848;
    dictionary['#'] = corridor_849;
    dictionary['('] = chest_586;
    dictionary['!'] = potion_675;
    dictionary['_'] = alter_583;
    dictionary['&gt;'] = stairs_down_993;
    dictionary['&lt;'] = stairs_up_994;
    dictionary['-'] = horiz_1034;
    dictionary['|'] = vert_1025;
    dictionary['+'] = door_844;
    dictionary['%'] = corpse_175;
    dictionary['@'] = wizard_287;

    string[] stringArray = levelDataTextFile.text.Split(newlineChar);
    BuildMaze( stringArray );
  }

  private void BuildMaze(string[] stringArray){
    int numRows = stringArray.Length;

    float yOffset = (numRows / 2);

    for(int row=0; row &lt; numRows; row++){
      string currentRowString = stringArray[row];
      float y = -1 * (row - yOffset);
      CreateRow(currentRowString, y);
    }
  }

  private void CreateRow(string currentRowString, float y) {
    int numChars = currentRowString.Length;
    float xOffset = (numChars/2);

    for(int charPos = 0; charPos &lt; numChars; charPos++){
      float x = (charPos - xOffset);
      char prefabCharacter = currentRowString[charPos];

      if (dictionary.ContainsKey(prefabCharacter)){
        CreatePrefabInstance( dictionary[prefabCharacter], x, y);
      }
    }
  }

  private void CreatePrefabInstance(GameObject objectPrefab, float x, float y){
    float z = 0;
    Vector3 position = new Vector3(x, y, z);
    Quaternion noRotation = Quaternion.identity;
    Instantiate (objectPrefab, position, noRotation);
  }
}</pre></div></li><li><p>With the<a id="id1105" class="indexterm"></a> <span class="strong"><strong>Main Camera</strong></span> selected, drag the appropriate prefabs onto the prefabs slots in the <span class="strong"><strong>Inspector</strong></span>, for the <code class="literal">LoadMapFromTextfile</code> Script component.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_10_14.jpg" /></div></li><li><p>When you run the scene, you will see that a sprite-based Nethack map will appear, using your prefabs.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec321"></a>How it works...</h3></div></div></div><p>The Sprite sheet was automatically sliced up into hundreds of 128 x 128 pixel Sprite squares. We <a id="id1106" class="indexterm"></a>created the prefab objects from some of these sprites, so that the copies can be created at runtime when needed.</p><p>The text file called <code class="literal">level1.txt</code> contains the lines of text characters. Each non-space character represents where a sprite prefab should be instantiated (<code class="literal">column = X</code>, <code class="literal">row = Y</code>). A C# dictionary variable named <code class="literal">dictionary</code> is declared and initialized in the <code class="literal">Start()</code> method to associate specific prefab GameObjects with some particular characters in the text file.</p><p>The <code class="literal">Awake()</code> method splits<a id="id1107" class="indexterm"></a> the string into an array using the newline character as a separator. So now, we have <code class="literal">stringArray</code> with an entry for each row of the text data. The <code class="literal">BuildMase(…)</code> method is called with the <code class="literal">stringArray</code>.</p><p>The <code class="literal">BuildMaze(…)</code> method interrogates<a id="id1108" class="indexterm"></a> the array to find its length (the number of rows of data for this level), and sets <code class="literal">yOffSet</code> to half this value. This is done to allow the placing of the prefabs half above <code class="literal">Y = 0</code> and half below, so <code class="literal">(0,0,0)</code> is the center of the level map. A <code class="literal">for</code>-loop is used to read each row's string from the array. It passes it to the <a id="id1109" class="indexterm"></a>
<code class="literal">CreateRow(…)</code> method along with the Y-value corresponding to the current row.</p><p>The <code class="literal">CreateRow(…)</code> method extracts the length of the string, and sets <code class="literal">xOffSet</code> to half this value. This is done to allow the placing of the prefabs half to the left of <code class="literal">X = 0</code> and half to the right, so <code class="literal">(0,0,0)</code> is the center of the level map. A <code class="literal">for</code>-loop is used to read each character from the current row's string, and (if there is an entry in our dictionary for that character) then the<a id="id1110" class="indexterm"></a> <code class="literal">CreatePrefabIInstance (…)</code> method is called, passing the prefab reference<a id="id1111" class="indexterm"></a> in the dictionary for that character, and the <span class="emphasis"><em>x</em></span> and <span class="emphasis"><em>y</em></span> value.</p><p>The <code class="literal">CreatePrefabInstance(…)</code> method instantiates the given prefab at a position of (<span class="emphasis"><em>x</em></span>, <span class="emphasis"><em>y</em></span>, <span class="emphasis"><em>z</em></span>) where <span class="emphasis"><em>z</em></span> is always zero, and there is no rotation (<code class="literal">Quarternion.identity</code>).</p></div></div>