<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec103"></a>Setting up a leaderboard using PHP/MySQL</h2></div></div><hr /></div><p>Games are more fun when there is a leaderboard of high scores that the players have achieved. Even <a id="id1090" class="indexterm"></a>single player games can communicate<a id="id1091" class="indexterm"></a> to a shared web-based leaderboard. This recipe includes both, the client side (Unity) code, as well as the web-server side (PHP) scripts to set and get the player scores from a MySQL database.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_10_10.jpg" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec314"></a>Getting ready</h3></div></div></div><p>This recipe assumes that you either have your own web hosting, or are running a local web server and a database server, such as XAMPP or MAMP. Your web server needs to support PHP, and you also need to be able to create the MySQL databases.</p><p>All the SQL, PHP, and C# scripts for this recipe can be found in the <code class="literal">1362_10_07</code> folder.</p><p>Since the scene contains several UI elements and the code of the recipe is the communication with the PHP scripts and SQL database, in <code class="literal">1362_10_07</code> folder, we have provided a <code class="literal">Unity</code> package called <code class="literal">PHPMySQLeaderboard</code>, containing a scene with everything set up for the Unity project.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note53"></a>Note</h3><p>If you are hosting your leaderboard on a public website, you will change the names of the database, database user and password for reasons of security. You should also implement some form of secret game code, as described in the <span class="emphasis"><em>There's more…</em></span> section.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec315"></a>How to do it...</h3></div></div></div><p>To set up a<a id="id1092" class="indexterm"></a> leaderboard using PHP and MySQL, do<a id="id1093" class="indexterm"></a> the following:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>On your server, create a new MySQL database named <code class="literal">cookbook_highscores</code>.</p></li><li><p>On your server, create a new database user (username=<code class="literal">cookbook</code>, password=<code class="literal">cookbook</code>) with full rights to the database that you just created.</p></li><li><p>On your server, execute the following SQL to create the database table called <code class="literal">score_list</code>:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE `score_list` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `player` varchar(25) NOT NULL,
  `score` int(11) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=1;</pre></div></li><li><p>Copy the provided PHP script files to your web server:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>
<code class="literal">index.php</code>
</p></li><li><p>
<code class="literal">scoreFunctions.php</code>
</p></li><li><p>
<code class="literal">htmlMenu.php</code>
</p></li></ol></div></li><li><p>Create a new 2D Unity project and extract the Unity package called <code class="literal">PHPMySQLeaderboard</code>.</p></li><li><p>Run the provided scene, and click on the buttons to make Unity communicate with the PHP scripts that have access to the high score database.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec316"></a>How it works...</h3></div></div></div><p>The player's scores are stored in a MySQL database. Access to the database is facilitated through the PHP scripts provided. In our example, all the PHP scripts were placed in the web server root folder for a local Apache webserver. So, the scripts are accessed via <code class="literal">http://localhost:8888/</code>. However, since URL is a public string variable, this can be set before running to the location of your server and site code.</p><p>All the access is through the PHP file called <code class="literal">index.php</code>. There are five actions implemented, and each is indicated by adding the action name at the end of the URL (this is the <code class="literal">GET HTTP</code> method, which is sometimes used for web forms. Take a look at the address bar of your browser next time you search Google for example). The actions and their parameters (if any) are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<code class="literal">action = html</code>: This action asks for HTML text listing all player scores to be returned. This action<a id="id1094" class="indexterm"></a> takes no parameters. It returns: HTML text.</p></li><li style="list-style-type: disc"><p>
<code class="literal">action = xml</code>: This <a id="id1095" class="indexterm"></a>action asks for XML text listing all player scores to be returned. This action takes no parameters. It returns: XML text.</p></li><li style="list-style-type: disc"><p>
<code class="literal">action = reset</code>: This action<a id="id1096" class="indexterm"></a> asks for a set of default player name and score values to replace the current contents of the database table. This action takes no argument. It returns: the string <code class="literal">reset</code>.</p></li><li style="list-style-type: disc"><p>
<code class="literal">action = get</code>: This action asks for the integer score of the named player that is to be found. It takes parameters in the form <code class="literal">player = matt</code>. It returns: the score integer.</p></li><li style="list-style-type: disc"><p>
<code class="literal">action = set</code>: This action asks for the provide score of the named player to be stored in the database (but only if this new score is greater than the currently stored score). It takes parameters in the form <code class="literal">player = matt, score = 101</code>. It returns: the score integer (if the database update was successful), otherwise a negative value (to indicate that no update took place).</p></li></ul></div><p>There are five buttons in the Unity scene (corresponding to the five actions) which set up the corresponding action and the parameters to be added to the URL, for the next call to the web server, via the <code class="literal">LoadWWW()</code> method. The <code class="literal">OnClick</code> actions have been set up for each button to call the corresponding methods of the <code class="literal">WebLeaderBoard</code> C# script of the Main Camera.</p><p>There are also three UI Text objects. The first displays the most recent URL string sent to the server. The second displays the integer value that was extracted from the response message that was received from the server (or a message as "not an integer" if some other data was received). The third UI Text object is inside a panel, and has been made large enough to display a full, multi-line, text string, received from the server (which is stored inside the <code class="literal">textFileContents</code> variable).</p><p>The three UI Text objects have been assigned to the public variables of the <code class="literal">WebLeaderBoard</code> C# script for the Main Camera. When the scene first starts, the <code class="literal">Start()</code> method calls the <code class="literal">UpdateUI()</code> method to update the three text UI elements. When any of the buttons are clicked, the corresponding method of the <code class="literal">WebLeaderBoard</code> method is called, which builds the URL string with parameters, and then calls the <code class="literal">LoadWWW()</code> method. This method sends the request to the URL, and waits (by virtue of being a coroutine) until a response is received. It then stores the content, received in the <code class="literal">textFileContents</code> variable, and calls the <code class="literal">UpdateUI()</code> method.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec317"></a>There's more...</h3></div></div></div><p>The following sections will fine-tune and customize this recipe for you:</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch10lvl3sec81"></a>Extracting the full leaderboard data as XML for display within Unity</h4></div></div></div><p>The XML text that <a id="id1097" class="indexterm"></a>can be retrieved from the PHP web server provides a useful method for allowing a Unity game to retrieve the full set of the leaderboard data from the database. Then, the leaderboard can be displayed to the user in the Unity game (perhaps, in some nice 3D fashion, or through a game-consistent GUI). </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch10lvl3sec82"></a>Using the secret game codes to secure your leaderboard scripts</h4></div></div></div><p>The Unity<a id="id1098" class="indexterm"></a> and PHP code that is presented illustrates a simple, unsecured web-based leaderboard. To prevent players hacking into the board with false scores, it is usual to encode some form of secret game code (or key) into the communications. Only update requests that include the correct code will actually cause a change to the database.</p><p>The Unity code will combine the secret key (in this example, the string called <code class="literal">harrypotter</code>) with something related to the communication—for example, the same MySQL/PHP leader board may have different database records for different games that are identified with a game ID:</p><div class="informalexample"><pre class="programlisting">// Unity Csharp code
string key = "harrypotter"
string gameId = 21;
string gameCode = Utility.Md5Sum(key + gameId);</pre></div><p>The server-side PHP code will receive both the encrypted game code, and also the piece of game data that is used to create that encrypted code (in this example, the game ID and MD5 hashing function, which is available in both, Unity and in PHP). The secret key (<code class="literal">harrypotter</code>) is used with the game ID to create an encrypted code that can be compared with the code received from the Unity game (or whatever user agent or browser is attempting to communicate with the leaderboard server scripts). The database actions will only be executed if the game code created on the server matches that send along with the request for a database action.</p><div class="informalexample"><pre class="programlisting">// PHP – security code
$key = "harrypotter"
$game_id =  $_GET['game_id'];
$provided_game_code =  $_GET['game_code'];
$server_game_code = md5($key.$game_id);

if( $server_game_code == $provided_game_code ) {
  // codes match - do processing here
}</pre></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec318"></a>See also</h3></div></div></div><p>Refer to the<a id="id1099" class="indexterm"></a> following recipe for more Information:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="emphasis"><em>Preventing your game from running on unknown servers</em></span> in <a class="link" href="#" linkend="ch11">Chapter 11</a>, <span class="emphasis"><em>Improving Games With Extra Features and Optimization</em></span>
</p></li></ul></div></div></div>