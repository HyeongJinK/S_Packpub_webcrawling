<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec71"></a>Moving your character with root motion and Blend Trees</h2></div></div><hr /></div><p>The Mecanim animation <a id="id713" class="indexterm"></a>system is capable of applying Root Motion to characters. In other words, it <span class="emphasis"><em>actually</em></span> moves the character according to the animation clip, as opposed to arbitrarily translating the character model while playing an in-place animation cycle. This <a id="id714" class="indexterm"></a>makes most of the Mixamo <a id="id715" class="indexterm"></a>animation clips perfect for use with Mecanim.</p><p>Another feature of the animation system is <span class="strong"><strong>Blend Trees</strong></span>, which can blend animation clips smoothly and easily. In this recipe, we will take advantage of these features to make our character walk/run<a id="id716" class="indexterm"></a> forward and backwards, and also strafe right and left at different speeds.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec198"></a>Getting ready</h3></div></div></div><p>For this recipe, we have prepared a Unity package named <code class="literal">Character_02</code>, containing a character and featuring a basic Animator Controller. The package can be found inside the <code class="literal">1362_07_02</code> folder, along with the <code class="literal">.fbx</code> files for the necessary animation clips.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec199"></a>How to do it...</h3></div></div></div><p>To apply the Root Motion to your character using <span class="strong"><strong>Blend Trees</strong></span>, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Import <code class="literal">Character_02.unityPackage</code> into a new project. Also, import <code class="literal">Swat@rifle_run, Swat@run_backwards, Swat@strafe, Swat@strafe_2, Swat@strafe_left, Swat@strafe_right, Swat@walking</code>,<code class="literal"> and Swat@walking_backwards .fbx</code> files.</p></li><li><p>We need to configure our animation clips. From the <span class="strong"><strong>Project view</strong></span>, select <span class="strong"><strong>Swat@rifle_run</strong></span>.</p></li><li><p>Activate the <span class="strong"><strong>Rig</strong></span> section. Change <span class="strong"><strong>Animation Type</strong></span> to <span class="strong"><strong>Humanoid</strong></span> and <span class="strong"><strong>Avatar Definition</strong></span> to <span class="strong"><strong>Create From this Model</strong></span>. Confirm by clicking on <span class="strong"><strong>Apply</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_09.jpg" /></div></li><li><p>Now, activate the <span class="strong"><strong>Animations</strong></span> section (to the right of <span class="strong"><strong>Rig</strong></span>). Select the <span class="strong"><strong>rifle_run</strong></span> clip (from the <span class="strong"><strong>Clips</strong></span> list). The <span class="strong"><strong>Preview area</strong></span> (at the bottom of the <span class="strong"><strong>Inspector</strong></span> view) will display the message as <span class="strong"><strong>No model is available for preview. Please drag a model into this Preview area</strong></span>. Drag <span class="strong"><strong>MsLaser@T-Pose </strong></span>onto the <span class="strong"><strong>Preview</strong></span> area to correct this.</p></li><li><p>With <span class="strong"><strong>rifle_run</strong></span> selected<a id="id717" class="indexterm"></a> from the <span class="strong"><strong>Clips</strong></span> list, select the <span class="strong"><strong>rifle_run</strong></span> clip (from the <span class="strong"><strong>Clips</strong></span> list) and check the <span class="strong"><strong>Loop Time</strong></span> and <span class="strong"><strong>Loop Pose</strong></span> options. Also, click on the <span class="strong"><strong>Clamp Range</strong></span><a id="id718" class="indexterm"></a> button to adjust the timeline to the actual time of the animation clip.</p></li><li><p>Then, under<a id="id719" class="indexterm"></a> <span class="strong"><strong>Root Transform Rotation</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and select<span class="strong"><strong> Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <a id="id720" class="indexterm"></a><span class="strong"><strong>Root Transform Position (Y)</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and select<span class="strong"><strong> Baked Upon</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <span class="strong"><strong>Root Transform Position (XZ)</strong></span>, leave <span class="strong"><strong>Bake Into Pose </strong></span>unchecked, and select<span class="strong"><strong> Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Center of Mass</strong></span>. Finally, click on <span class="strong"><strong>Apply</strong></span> to confirm the changes.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_10.jpg" /></div></li><li><p>Repeat steps 3 to 6 for each one of the following animation clips: <span class="strong"><strong>Swat@run_backwards</strong></span>, <span class="strong"><strong>Swat@strafe</strong></span>, <span class="strong"><strong>Swat@strafe_2</strong></span>, <span class="strong"><strong>Swat@strafe_left</strong></span>, <span class="strong"><strong>Swat@strafe_right</strong></span>, <span class="strong"><strong>Swat@walking</strong></span>, and <span class="strong"><strong>Swat@walking_backwards</strong></span>.</p></li><li><p>From the <span class="strong"><strong>Project view</strong></span>, select the <span class="strong"><strong>MsLaser</strong></span> prefab and drag it onto the <span class="strong"><strong>Hierarchy</strong></span> view, placing it on the scene.</p></li><li><p>From the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>MsLaser</strong></span> GameObject and attach a <span class="strong"><strong>Character Controller</strong></span> component to it (<span class="strong"><strong>menu Component</strong></span> | <span class="strong"><strong>Physics</strong></span> | <span class="strong"><strong>Character Controller</strong></span>). Then, set its <span class="strong"><strong>Skin Width</strong></span> as <code class="literal">0.0001</code>, and its <span class="strong"><strong>Center</strong></span> as <span class="strong"><strong>X</strong></span>: <span class="strong"><strong>0</strong></span>, <span class="strong"><strong>Y</strong></span>: <span class="strong"><strong>0.9</strong></span>, <span class="strong"><strong>Z</strong></span>: <span class="strong"><strong>0</strong></span>; also change its <span class="strong"><strong>Radius</strong></span> to <span class="strong"><strong>0.34</strong></span> and its <span class="strong"><strong>Height</strong></span> to <span class="strong"><strong>1.79</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_11.jpg" /></div></li><li><p>In the <span class="strong"><strong>Project </strong></span><a id="id721" class="indexterm"></a><span class="strong"><strong>view</strong></span>, open the <span class="strong"><strong>MainCharacter</strong></span> controller.</p></li><li><p>In the top-left <a id="id722" class="indexterm"></a>corner of the <span class="strong"><strong>Animator</strong></span> view, activate the <span class="strong"><strong>Parameters</strong></span> section and use the <span class="strong"><strong>+</strong></span> sign to create three new <span class="strong"><strong>Parameters (Float) </strong></span>named <code class="literal">xSpeed</code>, <code class="literal">zSpeed</code>, and <a id="id723" class="indexterm"></a>
<code class="literal">Speed</code>.</p></li><li><p>We do have an <span class="strong"><strong>Idle</strong></span> <a id="id724" class="indexterm"></a>state for our character, but we need the new ones. Right-click on the gridded area and, from the context menu, navigate to <span class="strong"><strong>Create State</strong></span> | <span class="strong"><strong>From New Blend Tree</strong></span>. Change its name, from the <span class="strong"><strong>Inspector</strong></span> view, to <code class="literal">Move</code>.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_12.jpg" /></div></li><li><p>Double-click on the <span class="strong"><strong>Move</strong></span> state. You will see the empty blend tree that you have created. Select it and, in the <span class="strong"><strong>Inspector</strong></span> view, rename it to <code class="literal">Move</code>. Then, change its <span class="strong"><strong>Blend Type</strong></span> to <span class="strong"><strong>2D Freeform Directional</strong></span>, also setting <span class="strong"><strong>xSpeed</strong></span> and <span class="strong"><strong>zSpeed</strong></span> in the <span class="strong"><strong>Parameters</strong></span> tab. Finally, using the <span class="strong"><strong>+</strong></span> sign from the bottom<a id="id725" class="indexterm"></a> of the <span class="strong"><strong>Motion</strong></span> list, add nine new <span class="strong"><strong>Motion Fields</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_13.jpg" /></div></li><li><p>Now, populate<a id="id726" class="indexterm"></a> the <span class="strong"><strong>Motion</strong></span> list with the following motion <a id="id727" class="indexterm"></a>clips and respective <span class="strong"><strong>Pos X</strong></span> and <span class="strong"><strong>Pos Y</strong></span> values: <span class="strong"><strong>run_backwards</strong></span>, <code class="literal">0</code>, <code class="literal">-1</code>; <span class="strong"><strong>walking_backwards</strong></span>, <code class="literal">0</code>,<code class="literal">-0.5</code>; <span class="strong"><strong>rifle_aiming_idle</strong></span>, <code class="literal">0</code>, <code class="literal">0</code>; <span class="strong"><strong>walking</strong></span>, <code class="literal">0</code>, <code class="literal">0.5</code>; <span class="strong"><strong>rifle_run</strong></span>, <code class="literal">0</code>, <code class="literal">1</code>; <span class="strong"><strong>strafe</strong></span>, <code class="literal">-1</code>,<code class="literal"> 0</code>; <span class="strong"><strong>strafe_left</strong></span>, -<code class="literal">0.5</code>, <code class="literal">0</code>; <span class="strong"><strong>strafe_right</strong></span>, <code class="literal">0.5</code>, <code class="literal">0</code>; <span class="strong"><strong>strafe_2</strong></span>, <code class="literal">1</code>, <code class="literal">0</code>. You can populate the <span class="strong"><strong>Motion</strong></span> list by selecting it from the list or, if there are more than one clip with the same name, you can <a id="id728" class="indexterm"></a>drag it from the <span class="strong"><strong>Project view</strong></span> onto the slot (by expanding the appropriate model icon).</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_14.jpg" /></div></li><li><p>Double-click on<a id="id729" class="indexterm"></a> the gridded area to go from the <span class="strong"><strong>Move</strong></span> blend tree back to the <span class="strong"><strong>Base Layer</strong></span>.</p></li><li><p>Since we <a id="id730" class="indexterm"></a>have the <code class="literal">rifle_aiming_idle</code> Motion clip within our <span class="strong"><strong>Move</strong></span> blend tree, we can get rid of the original <span class="strong"><strong>Idle</strong></span> state. Right-click on the <span class="strong"><strong>Idle</strong></span> state box and, from the menu, select <span class="strong"><strong>Delete</strong></span>. The <a id="id731" class="indexterm"></a><span class="strong"><strong>Move</strong></span> blend state will become<a id="id732" class="indexterm"></a> the new default state, turning orange.</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_15.jpg" /></div></li><li><p>Now, we must create the script that will actually transform the player's input into those variables that are created to control the animation.</p></li><li><p>From<a id="id733" class="indexterm"></a> the <span class="strong"><strong>Project view</strong></span>, create a new <span class="strong"><strong>C# Script</strong></span> and name it as <code class="literal">BasicController</code>.</p></li><li><p>Open your<a id="id734" class="indexterm"></a> script <a id="id735" class="indexterm"></a>and replace everything with<a id="id736" class="indexterm"></a> the following code:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class BasicController: MonoBehaviour {
  private Animator anim;
  private CharacterController controller;
  public float transitionTime = .25f;
  private float speedLimit = 1.0f;
  public bool moveDiagonally = true;
  public bool mouseRotate = true;
  public bool keyboardRotate = false;

  void Start () {
    controller = GetComponent&lt;CharacterController&gt;();
    anim = GetComponent&lt;Animator&gt;();
  }
  
  void Update () {
    if(controller.isGrounded){
      if (Input.GetKey (KeyCode.RightShift) ||Input.GetKey (KeyCode.LeftShift))
        speedLimit = 0.5f;
      else
        speedLimit = 1.0f;
    
      float h = Input.GetAxis("Horizontal");
      float v = Input.GetAxis("Vertical");
      float xSpeed = h * speedLimit;
      float zSpeed = v * speedLimit;
      float speed = Mathf.Sqrt(h*h+v*v);

      if(v!=0 &amp;&amp; !moveDiagonally)
        xSpeed = 0;

      if(v!=0 &amp;&amp; keyboardRotate)
        this.transform.Rotate(Vector3.up * h, Space.World);

      if(mouseRotate)
        this.transform.Rotate(Vector3.up * (Input.GetAxis("Mouse X")) * Mathf.Sign(v), Space.World);

      anim.SetFloat("zSpeed", zSpeed, transitionTime, Time.deltaTime);
      anim.SetFloat("xSpeed", xSpeed, transitionTime, Time.deltaTime);
      anim.SetFloat("Speed", speed, transitionTime, Time.deltaTime);
    }
  }
}</pre></div></li><li><p>Save your <a id="id737" class="indexterm"></a>script and attach it to the <span class="strong"><strong>MsLaser</strong></span> GameObject in the <span class="strong"><strong>Hierarchy</strong></span> view. Then, add <span class="strong"><strong>Plane</strong></span> (menu option <span class="strong"><strong>GameObject</strong></span> | <span class="strong"><strong>3D Object</strong></span> | <span class="strong"><strong>Plane</strong></span>) and place it beneath the character.</p></li><li><p>Play your<a id="id738" class="indexterm"></a> scene and test the game. You will be able to control your character with the arrow keys (or <span class="emphasis"><em>WASD</em></span> keys). Keeping<a id="id739" class="indexterm"></a> the <span class="emphasis"><em>Shift</em></span> key pressed will slow it down.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec200"></a>How it works...</h3></div></div></div><p>Whenever the<a id="id740" class="indexterm"></a> <code class="literal">BasicController</code> script detects any directional keys in use, it sets the <code class="literal">Speed</code> variable of the <span class="strong"><strong>Animator</strong></span> state to a value higher than 0, changing the <span class="strong"><strong>Animator</strong></span> state from <span class="strong"><strong>Idle</strong></span> to <span class="strong"><strong>Move</strong></span>. The <span class="strong"><strong>Move</strong></span> state, in its turn, blends the motion clips that it was populated with, according to the input values for <code class="literal">xSpeed</code> (obtained from<a id="id741" class="indexterm"></a> <span class="strong"><strong>Horizontal Axis </strong></span>input, typically <span class="emphasis"><em>A</em></span> and <span class="emphasis"><em>D</em></span> keys) and <code class="literal">zSpeed</code> (obtained from<a id="id742" class="indexterm"></a> <span class="strong"><strong>Vertical Axis</strong></span> input, typically <span class="emphasis"><em>W</em></span> and <span class="emphasis"><em>S</em></span> keys). Since Mecanim is capable of applying root motion to the characters, our character will actually move in the resulting direction.</p><p>For instance, if <span class="emphasis"><em>W</em></span> and <span class="emphasis"><em>D</em></span> keys are pressed, <code class="literal">xSpeed</code> and <code class="literal">zSpeed</code> values will rise to 1.0. From the <span class="strong"><strong>Inspector</strong></span> view, it is possible to see that such combination will result in a blend between the motion clips called <span class="strong"><strong>rifle_run</strong></span> and <span class="strong"><strong>strafe_2</strong></span>, making the character run diagonally (front + right).</p><div class="mediaobject"><img src="/graphics/9781784391362/graphics/1362OT_07_18.jpg" /></div><p>Our <span class="strong"><strong>BasicController</strong></span><a id="id743" class="indexterm"></a> includes three checkboxes for more options: <span class="strong"><strong>Move Diagonally</strong></span>—set as <span class="strong"><strong>true</strong></span>, by default, which allows for blends between forward/backward and left/right clips; <span class="strong"><strong>Mouse Rotate</strong></span>—set as <span class="strong"><strong>true</strong></span>, by default, which allows<a id="id744" class="indexterm"></a> for rotating the character with the mouse, changing their direction while moving; <span class="strong"><strong>Keyboard Rotate</strong></span>—set as <span class="strong"><strong>false</strong></span>, by default, which<a id="id745" class="indexterm"></a> allows for rotating the character through<a id="id746" class="indexterm"></a> simultaneous use of left/right and forward/backwards directional keys.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec201"></a>There's more...</h3></div></div></div><p>Our blend tree used the <span class="strong"><strong>2D Freeform Directional Blend Type</strong></span>. However, if we had only four animation clips (forward, backwards, left, and right), <span class="strong"><strong>2D Simple Directional</strong></span> would have been a better option. Learn more on the following links:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Learn more about Blend<a id="id747" class="indexterm"></a> Trees and 2D blending from Unity's Documentation at: <a class="ulink" href="http://docs.unity3d.com/Manual/BlendTree-2DBlending.html" target="_blank">http://docs.unity3d.com/Manual/BlendTree-2DBlending.html</a>.</p></li><li style="list-style-type: disc"><p>Also, if you want to learn more about Mecanim Animation System, there are some links that you<a id="id748" class="indexterm"></a> might want to check out, such as Unity's documentation at: <a class="ulink" href="http://docs.unity3d.com/Manual/AnimationOverview.html" target="_blank">http://docs.unity3d.com/Manual/AnimationOverview.html</a>.</p></li><li style="list-style-type: disc"><p>Mecanim <a id="id749" class="indexterm"></a>Example Scenes are available at Unity <a id="id750" class="indexterm"></a>Asset Store at: <a class="ulink" href="https://www.assetstore.unity3d.com/en/#!/content/5328" target="_blank">https://www.assetstore.unity3d.com/en/#!/content/5328</a>.</p></li><li style="list-style-type: disc"><p>Mecanim <a id="id751" class="indexterm"></a>Video Tutorial are available at: <a class="ulink" href="http://unity3d.com/pt/learn/tutorials/topics/animation" target="_blank">http://unity3d.com/pt/learn/tutorials/topics/animation</a>.</p></li></ul></div></div></div>