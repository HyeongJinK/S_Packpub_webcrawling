<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec48"></a>Adding save points</h2></div></div><hr /></div><p>We want <a id="id904" class="indexterm"></a>to allow the player to save his/her game progression and continue playing the game in some other days. Some games allow the player to save the game anytime, but some require the player to reach the save point in order to do so. For the first option, you'll need to save a lot more data, especially if the game is action-heavy and not turn-based; otherwise, problems may occur. This is because an action-heavy genre, such as action RPG and FPS, has so many events happening at the same time that if you don't save the current states of all the AIs, events, movements, physics, and so on, the game will not be correctly restored when the player tries to load back the saved game next time.</p><p>With the save point, problems like this can be avoided because the game designer will make sure that the save point is being placed at a place where player is certainly safe and no important game event is going on in that area at that time; therefore, less data is needed to be saved.</p><p>Here, I made a save point prefab using several cubes and parented the cube to an empty object. Then, I applied a sphere collider to it and ticked the <span class="strong"><strong>is trigger</strong></span> option.</p><div class="mediaobject"><img src="/graphics/9781785282140/graphics/B04610_07_05.jpg" /></div><p>After <a id="id905" class="indexterm"></a>this, I also created a dialog user interface for player to confirm whether to save the game, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781785282140/graphics/B04610_07_06.jpg" /></div><p>Then, we will create two C# scripts, one called <code class="literal">SavePoint.cs</code> and another called <code class="literal">SaveManager.cs</code>. Basically, the <code class="literal">SavePoint</code> script will trigger the <span class="strong"><strong>save</strong></span> dialog, whereas the <code class="literal">SaveManager</code> script will handle the game saving mechanism.</p><p>
<code class="literal">SavePoint.cs</code> is very simple; it will detect if an enemy has collided with the player and ask the <code class="literal">saveManager</code> object to <a id="id906" class="indexterm"></a>show the <span class="strong"><strong>save</strong></span> dialog user interface if it does. Here's the script for <code class="literal">SavePoint.cs</code>:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class SavePoint : MonoBehaviour 
{
  public SaveManager saveManager;

  void OnTriggerEnter (Collider col)
  {
    if (col.tag == "Player")
    {
      saveManager.ShowSaveDialogUI ();
    }
  }
}</pre></div><p>
<code class="literal">SaveManager.cs</code>, however, is much more complicated. The script is divided into two parts: the first part consists of functions related to the <span class="strong"><strong>save</strong></span> dialog user interface and the second part is where the game saving code is written. Here is the first part of the script, which consists of two functions: <code class="literal">ShowSaveDialogUI()</code> and <code class="literal">HideSaveDialogUI()</code>, which are both self-explanatory by their names:</p><div class="informalexample"><pre class="programlisting">public GameObject saveDialogUI;

void Start ()
{
  HideSaveDialogUI ();
}

public void ShowSaveDialogUI ()
{
  saveDialogUI.SetActive (true);

  // Stop time and unhide cursor
  Time.timeScale = 0;
  Cursor.lockState = CursorLockMode.None;
  Cursor.visible = true;
}

public void HideSaveDialogUI ()
{
  saveDialogUI.SetActive (false);

  // Continue time and hide cursor
  Time.timeScale = 1;
  Cursor.lockState = CursorLockMode.Locked;
  Cursor.visible = false;
}</pre></div><p>After this, we will dive into the <code class="literal">SaveGame()</code> function, which handles the game saving mechanism. <code class="literal">PlayerPrefs</code> is a class in the Unity API that handles data saving. You can save a <a id="id907" class="indexterm"></a>value by using <code class="literal">SaveFloat()</code>, <code class="literal">SaveInt()</code>, or <code class="literal">SaveString()</code>, and then you can load it back by calling <code class="literal">GetFloat()</code>, <code class="literal">GetInt()</code>, or <code class="literal">GetString()</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note24"></a>Note</h3><p>For more<a id="id908" class="indexterm"></a> information regarding <code class="literal">PlayerPrefs</code>, do check out the Scripting API documentation at <a class="ulink" href="http://docs.unity3d.com/ScriptReference/PlayerPrefs.html" target="_blank">http://docs.unity3d.com/ScriptReference/PlayerPrefs.html</a>.</p></div><p>First thing we need to do is clear all the previously saved data using <code class="literal">PlayerPrefs.DeleteAll()</code> so that we don't overlap some of the old data that no longer exists in the current state. For example, the player has saved the game in level A, but has continued to level B and is trying to save the data in the second level. This will cause the data of level B to be overlapped with the data of level A and may cause a lot of trouble when loading back the game. To make sure that no such problem occurs in our game, delete everything before saving the new data.</p><p>After this, we will save the current level name so that we know which level to load when we click on <span class="strong"><strong>Continue Game</strong></span> from the main menu. Then, we will proceed with saving the player's data. There are few things that we need to save hereâ€”the position and rotation of the player character and its attributes, including level, health point, mana point, and so on. After this, we also need to save the player camera's position and rotation so that when the game is loaded, the camera view is at the correct location.</p><p>Then, we will save the enemies' data. For this one, we will need to find all the enemies in the scene with the <code class="literal">Monster</code> tag by calling <code class="literal">GameObject.FindGameObjectsWithTag("Monster")</code> and loop through all the resulting game objects to save data of each enemy. To distinguish between each enemy, we will save its instance ID set by Unity, which is guaranteed to be unique, by calling <code class="literal">gameObject.GetInstanceID()</code>. When the saved game is loaded back, we will match the instance ID of all the enemies with the saved data to correctly restore the states of the enemies. We are not only saving the position, rotation, and health point of the enemies, but also an <span class="emphasis"><em>alive</em></span> state, which determines whether the enemy has been defeated or not. If it's already defeated, it will be deleted when the saved game is being loaded.</p><p>Last but not least, we will save the data of all the items in the scene. The same method is being used for the items, that is, find all the items in the scene with the <code class="literal">Item</code> tag, loop through the resulting game objects, and save its <span class="emphasis"><em>exist</em></span> state. If the item has already been taken by <a id="id909" class="indexterm"></a>the player, it will no longer exist, and thus the <span class="emphasis"><em>exist</em></span> state will not be saved. Items that have no <span class="emphasis"><em>exist</em></span> state will be removed when the saved game is being loaded.</p><p>The full code of <code class="literal">SaveGame()</code> function is shown here:</p><div class="informalexample"><pre class="programlisting">public void SaveGame ()
{
  // Clear everything
  PlayerPrefs.DeleteAll ();

  // Save game level data
  PlayerPrefs.SetString ("level_name", Application.loadedLevelName);

  // Save player data
  GameObject player = GameObject.FindWithTag ("Player");

  PlayerPrefs.SetFloat ("player_posX", player.transform.position.x);
  PlayerPrefs.SetFloat ("player_posY", player.transform.position.y);
  PlayerPrefs.SetFloat ("player_posZ", player.transform.position.z);

  PlayerPrefs.SetFloat ("player_rotX", player.transform.rotation.x);
  PlayerPrefs.SetFloat ("player_rotY", player.transform.rotation.y);
  PlayerPrefs.SetFloat ("player_rotZ", player.transform.rotation.z);

  PlayerStat playerStat = player.GetComponent&lt;PlayerStat&gt;();

  PlayerPrefs.SetFloat ("player_level", playerStat.level);
  PlayerPrefs.SetFloat ("player_healthPoint", playerStat.healthPoint);
  PlayerPrefs.SetFloat ("player_manaPoint", playerStat.manaPoint);
  PlayerPrefs.SetFloat ("player_attackDamage", playerStat.attackDamage);
  PlayerPrefs.SetFloat ("player_specialAttackDamage", playerStat.specialAttackDamage);
  PlayerPrefs.SetFloat ("player_defense", playerStat.defense);

  // Save player camera data
  GameObject gameCamera = GameObject.FindWithTag ("Camera");

  PlayerPrefs.SetFloat ("camera_posX", gameCamera.transform.position.x);
  PlayerPrefs.SetFloat ("camera_posY", gameCamera.transform.position.y);
  PlayerPrefs.SetFloat ("camera_posZ", gameCamera.transform.position.z);

  PlayerPrefs.SetFloat ("camera_rotX", gameCamera.transform.rotation.x);
  PlayerPrefs.SetFloat ("camera_rotY", gameCamera.transform.rotation.y);
  PlayerPrefs.SetFloat ("camera_rotZ", gameCamera.transform.rotation.z);

  // Save monsters data
  GameObject[] allMonsters = GameObject.FindGameObjectsWithTag ("Monster");
  foreach (GameObject monster in allMonsters)
  {
    PlayerPrefs.SetInt("monster" + monster.GetInstanceID() + "_alive", 1);

    PlayerPrefs.SetFloat ("monster" + monster.GetInstanceID() + "_posX", monster.transform.position.x);
    PlayerPrefs.SetFloat ("monster" + monster.GetInstanceID() + "_posY", monster.transform.position.y);
    PlayerPrefs.SetFloat ("monster" + monster.GetInstanceID() + "_posZ", monster.transform.position.z);

    PlayerPrefs.SetFloat ("monster" + monster.GetInstanceID() + "_rotX", monster.transform.rotation.x);
    PlayerPrefs.SetFloat ("monster" + monster.GetInstanceID() + "_rotX", monster.transform.rotation.y);
    PlayerPrefs.SetFloat ("monster" + monster.GetInstanceID() + "_rotX", monster.transform.rotation.z);

    EnemyAI enemyStat = monster.GetComponent&lt;EnemyAI&gt;();

    PlayerPrefs.SetFloat ("monster" + monster.GetInstanceID() + "_healthPoint", enemyStat.healthPoint);
  }

  // Save item data
  GameObject[] allItems = GameObject.FindGameObjectsWithTag ("Item");
  foreach (GameObject item in allItems)
  {
    PlayerPrefs.SetInt("item" + item.GetInstanceID() + "_exist", 1);
  }

  HideSaveDialogUI ();
}</pre></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip17"></a>Tip</h3><p>Unity's <code class="literal">PlayerPrefs</code> class saves all the data unencrypted. If data security is critical for your game project, you can search for encrypted <code class="literal">PlayerPrefs</code> in the Unity Asset Store.</p></div><p>Next, we<a id="id910" class="indexterm"></a> will write the <code class="literal">LoadGame()</code> function used to restore the saved data. It's basically very similar to the preceding <code class="literal">SaveGame()</code> function; the only difference is that instead of <code class="literal">SetFloat()</code> and <code class="literal">SetInt()</code>, we use <code class="literal">GetFloat</code> and <code class="literal">GetInt()</code> to retrieve data from the disk. Here's the code for the <code class="literal">LoadGame()</code> function:</p><div class="informalexample"><pre class="programlisting">public void LoadGame ()
{
  // Load player data
  GameObject player = GameObject.FindWithTag ("Player");

  Vector3 playerPos = new Vector3 ();
  playerPos.x = PlayerPrefs.GetFloat ("player_posX", 0);
  playerPos.y = PlayerPrefs.GetFloat ("player_posY", 0);
  playerPos.z = PlayerPrefs.GetFloat ("player_posZ", 0);
  player.transform.position = playerPos;

  Quaternion playerRot = new Quaternion ();
  playerRot.x = PlayerPrefs.GetFloat ("player_rotX", 0);
  playerRot.y = PlayerPrefs.GetFloat ("player_rotY", 0);
  playerRot.z = PlayerPrefs.GetFloat ("player_rotZ", 0);
  player.transform.rotation = playerRot;

  PlayerStat playerStat = player.GetComponent&lt;PlayerStat&gt;();

  playerStat.level = PlayerPrefs.GetInt ("player_level", 0);
  playerStat.healthPoint = PlayerPrefs.GetFloat ("player_healthPoint", 0);
  playerStat.manaPoint = PlayerPrefs.GetFloat ("player_manaPoint", 0);
  playerStat.attackDamage = PlayerPrefs.GetFloat ("player_attackDamage", 0);
  playerStat.specialAttackDamage = PlayerPrefs.GetFloat ("player_specialAttackDamage", 0);
  playerStat.defense = PlayerPrefs.GetFloat ("player_defense", 0);

  // Load player camera data
  GameObject gameCamera = GameObject.FindWithTag ("Camera");

  Vector3 cameraPos = new Vector3 ();
  cameraPos.x = PlayerPrefs.GetFloat ("camera_posX", 0);
  cameraPos.y = PlayerPrefs.GetFloat ("camera_posY", 0);
  cameraPos.z = PlayerPrefs.GetFloat ("camera_posZ", 0);
  gameCamera.transform.position = cameraPos;

  Quaternion cameraRot = new Quaternion ();
  cameraRot.x = PlayerPrefs.GetFloat ("camera_rotX", 0);
  cameraRot.y = PlayerPrefs.GetFloat ("camera_rotY", 0);
  cameraRot.z = PlayerPrefs.GetFloat ("camera_rotZ", 0);
  gameCamera.transform.rotation = cameraRot;

  // Load monsters data
  GameObject[] allMonsters = GameObject.FindGameObjectsWithTag ("Monster");
  foreach (GameObject monster in allMonsters)
  {
    // Check if monster already defeated previously
    if (PlayerPrefs.GetInt("monster" + monster.GetInstanceID() + "_alive", 0) == 0)
    {
      // Monster died
      Destroy(monster);
    }
    else
    {
      Vector3 monsterPos = new Vector3 ();
      monsterPos.x = PlayerPrefs.GetFloat ("monster" + monster.GetInstanceID() + "_posX", 0);
      monsterPos.y = PlayerPrefs.GetFloat ("monster" + monster.GetInstanceID() + "_posY", 0);
      monsterPos.z = PlayerPrefs.GetFloat ("monster" + monster.GetInstanceID() + "_posZ", 0);
      monster.transform.position = monsterPos;

      Quaternion monsterRot = new Quaternion ();
      monsterRot.x = PlayerPrefs.GetFloat ("monster" + monster.GetInstanceID() + "_rotX", 0);
      monsterRot.y = PlayerPrefs.GetFloat ("monster" + monster.GetInstanceID() + "_rotX", 0);
      monsterRot.z = PlayerPrefs.GetFloat ("monster" + monster.GetInstanceID() + "_rotX", 0);
      monster.transform.rotation = monsterRot;

      EnemyAI enemyStat = monster.GetComponent&lt;EnemyAI&gt;();

      enemyStat.healthPoint = PlayerPrefs.GetFloat ("monster" + monster.GetInstanceID() + "_healthPoint", 0);
    }
  }

  // Load item data
  GameObject[] allItems = GameObject.FindGameObjectsWithTag ("Item");
  foreach (GameObject item in allItems)
  {
    if (PlayerPrefs.GetInt("item" + item.GetInstanceID() + "_exist", 0) == 0)
    {
      Destroy (item);
    }
  }
}</pre></div><p>With<a id="id911" class="indexterm"></a> the preceding code, we get the following output:</p><div class="mediaobject"><img src="/graphics/9781785282140/graphics/B04610_07_07.jpg" /></div></div>