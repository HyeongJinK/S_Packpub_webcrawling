<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec77"></a>Adding multiplayer networking</h2></div></div><hr /></div><p>To make the<a id="id582" class="indexterm"></a> scene run as multiplayer we need, at a minimum, a Network Manager component, and we need to identify any objects that will get spawned using the Network Identity component.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec103"></a>Network Manager and HUD</h3></div></div></div><p>First, we'll add the <a id="id583" class="indexterm"></a>Network Manager component, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Navigate to <span class="strong"><strong>GameObject</strong></span> | <span class="strong"><strong>Create Empty</strong></span> and rename it <code class="literal">NetworkController</code>.</p></li><li><p>Navigate to <span class="strong"><strong>Add Component</strong></span> | <span class="strong"><strong>Network</strong></span> | <span class="strong"><strong>Network Manager</strong></span>.</p></li><li><p>Navigate to <span class="strong"><strong>Add Component</strong></span> | <span class="strong"><strong>Network</strong></span> | <span class="strong"><strong>Network Manager HUD</strong></span>.</p></li></ol></div><p>We also added a <span class="strong"><strong>Network Controller HUD</strong></span> menu, a crude default menu that Unity offers to select the runtime networking options (you can see it in the images that follow). It's for development. In a <a id="id584" class="indexterm"></a>real project, you'll probably replace the default HUD with something more appropriate.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec104"></a>Network Identity and Transform</h3></div></div></div><p>Next, add a <a id="id585" class="indexterm"></a>Network Identity to the <code class="literal">Avatar</code> prefab. We will also add a <a id="id586" class="indexterm"></a>Network Transform, which instructs the networking system to synchronize the player's <span class="strong"><strong>Transform</strong></span> values to the avatar instances on each client, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In <span class="strong"><strong>Project Assets</strong></span>, select the <code class="literal">Avatar</code> prefab.</p></li><li><p>Navigate to <span class="strong"><strong>Add Component</strong></span> | <span class="strong"><strong>Network</strong></span> | <span class="strong"><strong>Network Identity</strong></span>.</p></li><li><p>Check off the <span class="strong"><strong>Local Player Authority</strong></span> checkbox.</p></li><li><p>Navigate to <span class="strong"><strong>Add Component</strong></span> | <span class="strong"><strong>Network</strong></span> | <span class="strong"><strong>Network Transform</strong></span>.</p></li><li><p>Ensure that <span class="strong"><strong>Transform Sync Mode</strong></span> is set to <span class="strong"><strong>Sync Transform</strong></span> and <span class="strong"><strong>Rotation Axis</strong></span> is set to <span class="strong"><strong>XYZ (full 3D)</strong></span>.</p></li><li><p>Now, tell the Network Manager that our <code class="literal">Avatar</code> prefab represents players.</p></li><li><p>In <span class="strong"><strong>Hierarchy</strong></span>, select <code class="literal">NetworkController</code>.</p></li><li><p>In <span class="strong"><strong>Inspector</strong></span>, unfold the <span class="strong"><strong>Network Manager Spawn Info</strong></span> parameters so that you can see the <span class="strong"><strong>Player Prefab</strong></span> slot.</p></li><li><p>In <span class="strong"><strong>Project Assets</strong></span>, find the <code class="literal">Avatar</code> prefab and drag it onto the <span class="strong"><strong>Player Prefab</strong></span> slot.</p></li><li><p>Save the scene.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec105"></a>Running as a host</h3></div></div></div><p>Click on the <span class="emphasis"><em>Play</em></span> mode. As shown<a id="id587" class="indexterm"></a> in the following screenshot, the screen comes up with the HUD start menu, which lets you select whether you wish to run and connect this game:</p><div class="mediaobject"><img src="/graphics/9781783988556/graphics/B04781_10_04.jpg" /></div><p>Choose <span class="strong"><strong>LAN Host</strong></span>. This will initiate a server (default port <code class="literal">7777</code> on <code class="literal">localhost</code>) and spawn an <code class="literal">Avatar</code>. The avatar is positioned at a default location, (<code class="literal">0, 0, 0</code>). Also, it's not connected to the camera. So, it is more like a third-person view.</p><p>The next thing<a id="id588" class="indexterm"></a> to do is run a second instance of the game and see two spawned avatars in the scene. However, we wouldn't want them to overlap as both are positioned at the origin, So first, define a couple of spawn positions.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec106"></a>Adding spawn positions</h3></div></div></div><p>To add a <a id="id589" class="indexterm"></a>spawn position, you just need a game object with a Network Start Position component:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Navigate to <span class="strong"><strong>GameObject</strong></span> | <span class="strong"><strong>Create Empty</strong></span>, rename it <code class="literal">Spawn1</code>, and set its <span class="strong"><strong>Position</strong></span> to (<code class="literal">0, 1.4, 1</code>).</p></li><li><p>Navigate to <span class="strong"><strong>Add Component</strong></span> | <span class="strong"><strong>Network</strong></span> | <span class="strong"><strong>Network Start Position</strong></span>.</p></li><li><p>Navigate to <span class="strong"><strong>GameObject</strong></span> | <span class="strong"><strong>Create Empty</strong></span>, rename it <code class="literal">Spawn2</code>, and set its <span class="strong"><strong>Position</strong></span> to (<code class="literal">0, 1.4, -1</code>).</p></li><li><p>Navigate to <span class="strong"><strong>Add Component</strong></span> | <span class="strong"><strong>Network</strong></span> | <span class="strong"><strong>Network Start Position</strong></span>.</p></li><li><p>In <span class="strong"><strong>Hierarchy</strong></span>, select <code class="literal">NetworkController</code>. In <span class="strong"><strong>Inspector &gt; Network Manager &gt; Spawn Info, Player Spawn Method</strong></span>, select <span class="strong"><strong>Round Robin</strong></span>.</p></li></ol></div><p>We now have two different spawn locations. The Network Manager will choose one or the other when a new player joins the game.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec107"></a>Running two instances of the game</h3></div></div></div><p>A <a id="id590" class="indexterm"></a>reasonable way to run two copies of the game on the same machine is to build and run one instance as a separate executable and the other instance from the Unity editor (the <span class="emphasis"><em>Play</em></span> mode). Build the executable as usual:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Navigate to <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Build Settings...</strong></span>.</p></li><li><p>In the <span class="strong"><strong>Build Settings</strong></span> dialog box, ensure that the <span class="strong"><strong>Platform</strong></span> is set to <span class="strong"><strong>PC, Mac &amp; Linux Standalone </strong></span>and the <span class="strong"><strong>Target Platform</strong></span> is set to your current development OS.</p></li><li><p>Click on <span class="strong"><strong>Player Settings...</strong></span> and in the <span class="strong"><strong>Inspector</strong></span>, under <span class="strong"><strong>Resolution and Presentation</strong></span>, check off the <span class="strong"><strong>Run In Background</strong></span> checkbox.</p></li><li><p>Ensure that the current scene is the only one checked off in <span class="strong"><strong>Scenes In Build</strong></span>. If it's not present, click on <span class="strong"><strong>Add Current</strong></span>.</p></li><li><p>Select <span class="strong"><strong>Build and Run</strong></span>, give it a name, and then launch the game by double-clicking after it's been built.</p></li></ol></div><p>Enabling the <span class="strong"><strong>Run In Background</strong></span> will permit the user input controls (keyboard and mouse) in each window when running the executables.</p><p>In the Unity editor, click on the <span class="emphasis"><em>Play</em></span> mode and select <span class="strong"><strong>LAN Host</strong></span>, like we did previously. Double-click on the executable app and check off the <span class="strong"><strong>Windowed</strong></span> checkbox so that it's not fullscreen. Then, in the executable window, select <span class="strong"><strong>LAN Client</strong></span>. In each game, you should now see two instances of the avatar, one for each player, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783988556/graphics/B04781_10_05.jpg" /></div><p>If you want <a id="id591" class="indexterm"></a>to run an instance of the game on a separate machine, enter the IP address of the host machine into the <span class="strong"><strong>Client</strong></span> input field (for instance, <code class="literal">10.0.1.14</code> on my LAN) instead of <code class="literal">localhost</code>.</p><p>A few keyboard shortcuts can also come in handy. On the HUD, use <span class="strong"><strong>H</strong></span> for select Host, <span class="strong"><strong>C</strong></span> to select Client, and use <span class="emphasis"><em>Alt</em></span> + <span class="emphasis"><em>Tab</em></span> (or <span class="emphasis"><em>Command</em></span> + <span class="emphasis"><em>Tab</em></span> on Mac) to switch between windows without using the mouse.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec108"></a>Associating avatar with the first-person character</h3></div></div></div><p>It's not<a id="id592" class="indexterm"></a> very interesting if the avatars don't move. That's the last piece of the puzzle.</p><p>You might think that we should have parented the avatar object under the first-person controller, <code class="literal">FPSController</code>, renamed and saved it as a Prefab, and then told the Network Manager to use that for spawns. But then, you'd end up with multiple FPSControllers in the scene, each with active cameras and controller scripts listening to user input. Not good.</p><p>We must have only one active <code class="literal">FPSController</code>, one camera, one instance of the input controller, and so on. Other players' avatars get spawned but are not controlled here. In other words, when the local player (and only the local player) gets spawned, that avatar should become a child of the camera. To achieve this, we will write a script:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In <span class="strong"><strong>Project Assets</strong></span>, select <code class="literal">Avatar</code>, navigate to <span class="strong"><strong>Add Component</strong></span> | <span class="strong"><strong>New Script</strong></span>, name it <code class="literal">AvatarMultiplayer.cs</code>, and open it in MonoDevelop.</p></li><li><p>Edit the <code class="literal">AvatarMultiplayer.cs</code> script, as follows:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using UnityEngine.Networking;

public class AvatarMultiplayer : NetworkBehaviour {

  public override void OnStartLocalPlayer () {
    GameObject camera = GameObject.FindWithTag ("MainCamera");
    transform.parent = camera.transform;
    transform.localPosition = Vector3.zero;
  }
}</pre></div></li></ol></div><p>The <a id="id593" class="indexterm"></a>first thing you'll notice is that we need to include the <code class="literal">UnityEngine.Networking</code> library to access the networking API. Then, the class <code class="literal">AvatarMultiplayer</code> is a type of <code class="literal">NetworkBehaviour</code>, which internally is derived from MonoBehavior.</p><p>
<code class="literal">NetworkBehaviour</code> provides a lot of new callback functions. We are going to use <code class="literal">OnStartLocalPlayer</code>, which gets called whenever the local player object is spawned. However, it is not called when the remote player objects are spawned. Its declaration requires the <code class="literal">override</code> keyword.</p><p>
<code class="literal">OnStartLocalPlayer</code> is exactly what we want because only when a local player is spawned do we want to parent it to the camera. We got the current <code class="literal">MainCamera</code> object (<code class="literal">GameObject.FindWithTag ("MainCamera")</code>) and made it the avatar's parent (<code class="literal">transform.parent = camera.transform</code>). We also reset the avatar's transform so that it's centered at the camera's position.</p><p>Run two instances of the gameâ€”<span class="strong"><strong>Build</strong></span> and <span class="strong"><strong>Run</strong></span> to execute one, and <span class="emphasis"><em>Play</em></span> mode for the other. Now when you control the player in one window, it moves the avatar in the other. Wow! You can even launch more executables and have a party! </p></div></div>