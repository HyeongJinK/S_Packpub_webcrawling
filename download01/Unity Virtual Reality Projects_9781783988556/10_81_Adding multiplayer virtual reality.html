<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec78"></a>Adding multiplayer virtual reality</h2></div></div><hr /></div><p>So far, we've <a id="id594" class="indexterm"></a>learned about implementing multiplayer networking in Unity, but not specifically for VR. Now, we're ready for this. The way I've set things up, we do not need to change anything in our scene for it to work in VR.</p><p>Our avatar is just a head for a reason. In VR, the camera transform is controlled by the head pose from the <a id="id595" class="indexterm"></a>
<span class="strong"><strong>HMD</strong></span> (<span class="strong"><strong>Head-mounted Display</strong></span>) sensors. When the avatar is parented by the camera, it'll move in sync. While wearing the HMD, when you move your head and look around, the corresponding avatar in all the clients will move accordingly.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec109"></a>The Oculus Rift players</h3></div></div></div><p>The <a id="id596" class="indexterm"></a>scene presently has an instance <a id="id597" class="indexterm"></a>of the standard <code class="literal">FPSController</code>, which includes a <code class="literal">Camera</code> component. We can use Unity 5's built-in VR support.</p><p>Navigate to <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Build Settings...</strong></span>. In the <span class="strong"><strong>Build Settings</strong></span> dialog box, select <span class="strong"><strong>Player Settings...</strong></span>. Then, under <span class="strong"><strong>Other Settings</strong></span>, check off the <span class="strong"><strong>Virtual Reality Supported</strong></span> checkbox.</p><p>The built-in Network Manager HUD is implemented in screen space. So, it will not appear if you play the scene now. One solution is to write your own HUD in world space to connect the game to the network. Another solution is to start in non-VR mode and then switch on the headset after connecting to the network. We will take the latter approach here, which will require two small scripts:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>With <code class="literal">NetworkController</code> selected in <span class="strong"><strong>Hierarchy</strong></span>, navigate to <span class="strong"><strong>Add Component</strong></span> | <span class="strong"><strong>New Script</strong></span>, name it <code class="literal">NetworkStart</code>, and open it in MonoDevelop.</p></li><li><p>Edit the <code class="literal">NetworkStart.cs</code> script, as follows:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using UnityEngine.VR;

public class NetworkStart : MonoBehaviour {

  void Awake() {
    VRSettings.enabled = false;
  }
}</pre></div></li></ol></div><p>Note that we're using the <code class="literal">UnityEngine.VR</code> library. When the game first initializes, <code class="literal">Awake()</code> is called, where we disable VR. Now, it will start in non-VR mode. The user can see the screen space UI and choose their runtime network options. Then, we enable VR when the player is spawned.</p><p>Next, open the <code class="literal">AvatarMultiplayer.cs</code> script and modify it, as follows:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using UnityEngine.Networking;
<span class="strong"><strong>using UnityEngine.VR;</strong></span>

public class AvatarMultiplayer : NetworkBehaviour {

  public override void OnStartLocalPlayer () {

<span class="strong"><strong>    VRSettings.enabled = true;</strong></span>

    GameObject camera = GameObject.FindWithTag ("MainCamera");
    transform.parent = camera.transform;
    transform.localPosition = Vector3.zero;
  }
}</pre></div><p>Save the scene.</p><p>Run two<a id="id598" class="indexterm"></a> instances of the gameâ€”<span class="strong"><strong>Build</strong></span> and <span class="strong"><strong>Run</strong></span> to execute one, and <span class="emphasis"><em>Play</em></span> mode for the other. Wow, it's a VR party! When your headset moves, the avatar head moves in each of the clients.</p><p>During testing, if you're like me and only have one Oculus Rift (!), you may want to run VR in only one instance. Naturally, providing a <span class="strong"><strong>Start</strong></span> menu with the option to choose a device is one way to go. For the purpose of this example, let's say you can only run VR on the Host instance; other clients are not VR. Modify the <code class="literal">AvatarMultiplayer.cs</code> script, as follows:</p><div class="informalexample"><pre class="programlisting">  public override void OnStartLocalPlayer () {

<span class="strong"><strong>    if (isServer) {</strong></span>
      VRSettings.enabled = true;
<span class="strong"><strong>    }</strong></span>
  ...</pre></div><p>We check whether the current instance is running as a server (Host is both a client and a server) using <code class="literal">isServer</code>. With this <span class="emphasis"><em>hack</em></span>, Host instances can use the Rift, non-Host clients will not.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec110"></a>The Google Cardboard players</h3></div></div></div><p>For <a id="id599" class="indexterm"></a>Cardboard, we can use Cardboard's own main camera prefab, <code class="literal">CardboardMain</code>, instead of the <code class="literal">FPSController</code>. We'll <a id="id600" class="indexterm"></a>attempt to add this without affecting anything that is already working so that the same project can build and run on multiple platforms without extra modification.</p><p>Add the Cardboard main camera and disable the <code class="literal">FPSController</code> that is already in the scene, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>If you do not have the Google Cardboard SDK package loaded, navigate to <span class="strong"><strong>Assets</strong></span> | <span class="strong"><strong>Import Package</strong></span> | <span class="strong"><strong>Custom Package...</strong></span>, find your downloaded copy of <code class="literal">CardboardSDKForUnity.package</code>, click on <span class="strong"><strong>Open</strong></span> and select <span class="strong"><strong>Import</strong></span>.</p></li><li><p>Find the <code class="literal">CardboardMain</code> in <code class="literal">Project Assets / Cardboard / Prefabs / CardboardMain</code> and drag it into the scene.</p></li><li><p>Copy the <span class="strong"><strong>Transform</strong></span> values from <code class="literal">FPSController</code> or reset its <span class="strong"><strong>Transform</strong></span> using the <span class="strong"><strong>Transform</strong></span> component's <span class="emphasis"><em>gear</em></span> icon | <span class="strong"><strong>Reset</strong></span> and set <span class="strong"><strong>Position</strong></span> to (<code class="literal">5, 1.4, 3</code>) and <span class="strong"><strong>Rotation</strong></span> to (<code class="literal">0, 225, 0</code>).</p></li><li><p>Select the <code class="literal">FPSController</code> in <span class="strong"><strong>Hierarchy</strong></span> and disable it by unchecking the <span class="strong"><strong>Enable</strong></span> checkbox.</p></li></ol></div><p>Open<a id="id601" class="indexterm"></a> the<a id="id602" class="indexterm"></a> script file that we created before, <code class="literal">NetworkStart.cs</code>, in MonoDevelop and edit it, as follows:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using UnityEngine.Networking;
using UnityEngine.VR;

public class NetworkStart : MonoBehaviour {
<span class="strong"><strong>  public GameObject oculusMain;</strong></span>
<span class="strong"><strong>  public GameObject cardboardMain;</strong></span>
<span class="strong"><strong>  public string hostIP = "10.0.1.14";</strong></span>

  void Awake() {
    VRSettings.enabled = false;

<span class="strong"><strong>#if (UNITY_ANDROID || UNITY_IPHONE)</strong></span>
<span class="strong"><strong>    oculusMain.SetActive (false);</strong></span>
<span class="strong"><strong>    cardboardMain.SetActive (true); </strong></span>

<span class="strong"><strong>    NetworkManager net = GetComponent&lt;NetworkManager&gt; ();</strong></span>
<span class="strong"><strong>    net.networkAddress = hostIP;</strong></span>
<span class="strong"><strong>    net.StartClient ();</strong></span>
<span class="strong"><strong>#else</strong></span>
<span class="strong"><strong>    oculusMain.SetActive (true);</strong></span>
<span class="strong"><strong>    cardboardMain.SetActive (false); </strong></span>
<span class="strong"><strong>#endif</strong></span>
  }
}</pre></div><p>The script declares the <code class="literal">public GameObject</code> variables for <code class="literal">oculusMain</code> and <code class="literal">cardboardMain</code>, which we'll set in the Editor.</p><p>I don't know about you, but the Network Manager HUD menu is too small on my phone to interact with, especially to enter a custom IP address. So, I've added a built-in IP address into the script instead. My development machine running as host is at <code class="literal">10.0.1.14</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note30"></a>Note</h3><p>This is for the simplicity and development of this example. In a real project, you will provide UI in the game or use the Unity cloud services.</p></div><p>You can <a id="id603" class="indexterm"></a>now build for Android<a id="id604" class="indexterm"></a> and install the app on your phone. (Instructions for Cardboard on iOS are similar). As explained in <a class="link" href="#" linkend="ch03">Chapter 3</a>, <span class="emphasis"><em>VR Build and Run</em></span>, ensure that your system is set up for Android development. Then, switch your project build platform to Android, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Navigate to <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Build Settings...</strong></span>. In the <span class="strong"><strong>Build Settings</strong></span> dialog box <span class="strong"><strong>Platform</strong></span> area, select <span class="strong"><strong>Android</strong></span> and select <span class="strong"><strong>Switch Platform</strong></span>.</p></li><li><p>Select <span class="strong"><strong>Player Settings...</strong></span>. In the <span class="strong"><strong>Inspector</strong></span> panel, ensure that you've set <span class="strong"><strong>Default Orientation: Landscape Left</strong></span> and set <span class="strong"><strong>Bundle Identifier</strong></span> in <span class="strong"><strong>Other Settings</strong></span>.</p></li><li><p>Save the scene and project. Build an <code class="literal">.apk</code> file for Android.</p></li><li><p>Switch platforms and build executables for Windows and/or Mac.</p></li><li><p>Fire up the apps on each platform! Party!</p></li></ol></div><p>The following image is a screenshot of the scene from my Android phone. I have three player games running multiplayerâ€”a Windows build running as Host and using an Oculus Rift, a Mac build running as a client on the Mac, and an Android build running as a client with Cardboard: </p><p>
<span class="emphasis"><em>Three separate builds of the same project running multiplayer on separate platforms with different VR devices!</em></span>
</p><div class="mediaobject"><img src="/graphics/9781783988556/graphics/B04781_10_06.jpg" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec111"></a>Next steps</h3></div></div></div><p>This was an introduction to Unity networking with VR. A whole book can be dedicated to this topic. Some areas for further exploration include the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Building a custom world space HUD start menu for network connections and device options.</p></li><li style="list-style-type: disc"><p>Connecting clients via the Unity Multiplayer cloud service.</p></li><li style="list-style-type: disc"><p>Letting users customize their avatar, such as enabling them to choose their own color.</p></li><li style="list-style-type: disc"><p>Showing usernames in an <span class="strong"><strong>Info Bubble</strong></span> above their heads.</p></li><li style="list-style-type: disc"><p>Providing a full-bodied avatar with animation.</p></li><li style="list-style-type: disc"><p>Optimizing data rates for smoother movement.</p></li><li style="list-style-type: disc"><p>Adding chat and/or audio voice communications. For<a id="id605" class="indexterm"></a> example, take a look at<a id="id606" class="indexterm"></a> Mumble (<a class="ulink" href="http://www.mumble.com/" target="_blank">http://www.mumble.com/</a>) and TeamSpeak (<a class="ulink" href="http://www.teamspeak.com/" target="_blank">http://www.teamspeak.com/</a>).</p></li><li style="list-style-type: disc"><p>Spawning nonplayer objects, such as a bouncy ball and playing a game of headshot volleyball! (See <a class="ulink" href="http://docs.unity3d.com/Manual/UNetSpawning.html" target="_blank">http://docs.unity3d.com/Manual/UNetSpawning.html</a> and <a class="link" href="#" linkend="ch07">Chapter 7</a>, <span class="emphasis"><em>Physics and the Environment</em></span> under the <span class="emphasis"><em>Headshots</em></span> section).</p></li></ul></div></div></div>