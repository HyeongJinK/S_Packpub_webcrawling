<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec40"></a>Creating game managers</h2></div></div><hr /></div><a id="id853" class="indexterm"></a><p>There are many ways to create a game manager, and it really depends on the game and type of structure that the developer has in mind. In this example, we will create two game managers—world manager that will contain all the information about scenes, missions and will handle the saving system, and audio manager that will control ambient music. Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new script, and call it <code class="literal">WorldManager</code>.</p></li><li><p>Declare a new <code class="literal">static</code> <code class="literal">private</code> variable of a <code class="literal">WorldManager</code> type<a id="id854" class="indexterm"></a>, and call it <code class="literal">instance</code>.</p></li><li><p>Declare a new <code class="literal">static public</code> function called <code class="literal">GetInstance()</code>.</p></li></ol></div><p>The <code class="literal">WorldManager</code> script<a id="id855" class="indexterm"></a><a id="id856" class="indexterm"></a> should be as follows:</p><div class="informalexample"><pre class="programlisting">static private var instance : WorldManager = null;
static public function GetInstance(){
if(!instance){
instance = FindObjectOfType(WorldManager);
if(!instance){
Debug.LogError("WorldManager does not exist");
}
return instance;
}
}</pre></div><p>Here, we check if the instance of world manager has been assigned to the <code class="literal">instance</code> variable. If not, we will look for an object of a <code class="literal">WorldManager</code> type in the scene and return the instance (<code class="literal">FindObjectOfType</code>
<a id="id857" class="indexterm"></a> finds and returns first active loaded object of a specified type). If we don't succeed in that, we will have to report a debug error that world manager doesn't exist in the scene and needs to be created there. The <code class="literal">instance</code> variable is <code class="literal">static</code>; you will find more information about the <code class="literal">static</code> variables in the appendix. At this point, it is enough to say that the <code class="literal">static</code> variables<a id="id858" class="indexterm"></a> exist throughout the entire lifetime of the project and can be accessed from any script (think of them as the advanced <code class="literal">public</code> variables, but don't use them unless you absolutely have to).</p><p><code class="literal">instance</code>
<a id="id859" class="indexterm"></a><a id="id860" class="indexterm"></a> is equal to <code class="literal">null</code>, because we need to create this instance dynamically through code. We will use this function to retrieve the instance of the world manager or find one if it wasn't assigned.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec81"></a>Level streaming</h3></div></div></div><a id="id861" class="indexterm"></a><a id="id862" class="indexterm"></a><p>In this example, we will look into a level-loading feature inside Unity. In the <code class="literal">Scenes</code> folder, we have five levels as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>FrontEnd</strong></span>: This will serve as a starting screen for our game</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Level 1, Level 2, and Level 3</strong></span>: These are the three levels that will be loading as our character goes through the game</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>EndGameScene</strong></span>: This will be shown if a player dies or fails to complete the objective</p></li></ul></div><a id="id863" class="indexterm"></a><p>The following screenshot shows the five levels mentioned in the preceding section:</p><div class="mediaobject"><img src="/graphics/9781849692304/graphics/2304EXP_06_01.jpg" /></div><p>To make Unity recognize these scenes as levels from our game, we need to manually assign them in the project properties. Perform the following steps:<a id="id864" class="indexterm"></a><a id="id865" class="indexterm"></a></p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Go to <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Build</strong></span> <span class="strong"><strong>Settings...</strong></span>, and have the <span class="strong"><strong>FrontEnd</strong></span> scene<a id="id866" class="indexterm"></a> loaded. Click on the <span class="strong"><strong>Add</strong></span> <span class="strong"><strong>Current</strong></span> button<a id="id867" class="indexterm"></a>. Current scene will be included in the game build and will be assigned an index number that we will be using to reference the scene in the code.</p><div class="mediaobject"><img src="/graphics/9781849692304/graphics/2304EXP_06_02.jpg" /></div></li><li><p>Load up each level one by one and include them in the build. Make sure that each level has an index that is the same as its number; this will make referencing easier for us. <span class="strong"><strong>EndGameScene</strong></span> should go last.</p></li><li><p>In the <code class="literal">WorldManager</code> script<a id="id868" class="indexterm"></a><a id="id869" class="indexterm"></a>, declare the <code class="literal">Awake</code> function<a id="id870" class="indexterm"></a><a id="id871" class="indexterm"></a>:</p><div class="informalexample"><pre class="programlisting">function Awake(){
DontDestroyOnLoad (transform.gameObject);
}</pre></div></li></ol></div><p>Having used scenes before, you would probably notice that as soon as you load a new scene, all objects from the old one disappear. To prevent objects from disappearing, we can tell Unity to avoid destroying the specified object.<a id="id872" class="indexterm"></a><a id="id873" class="indexterm"></a></p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note15"></a>Note</h3><p><code class="literal">DontDestroyOnLoad</code>
<a id="id874" class="indexterm"></a><a id="id875" class="indexterm"></a> is the function that tells Unity that a particular object needs to remain constant throughout the game and should not be destroyed when we change the scene.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec82"></a>Mission creation</h3></div></div></div><a id="id876" class="indexterm"></a><a id="id877" class="indexterm"></a><p>Let's say we want the player to hit the button in the <span class="strong"><strong>Level</strong></span> <span class="strong"><strong>1</strong></span> with a bio gun primary fire to open the door that will load the new level.</p><p>We will create a script for two types of buttons. The first one will be activated by the projectile and will open the door, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849692304/graphics/2304EXP_06_03.jpg" /></div><p>The other button will be activated with a player stepping on it and will be used to open a second door, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849692304/graphics/2304EXP_06_04.jpg" /></div><p>To create a multipurpose script, we will need variables that identify a type of specific button, and flags that will determine if buttons can be activated or if they are currently active. We determine whether a button is activated or not with the <code class="literal">OnCollisionEnter</code> function<a id="id878" class="indexterm"></a><a id="id879" class="indexterm"></a> and will move the button down afterwards. Perform the following steps:<a id="id880" class="indexterm"></a><a id="id881" class="indexterm"></a></p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Declare the <code class="literal">ButtonType</code>
<a id="id882" class="indexterm"></a> and <code class="literal">Activation</code> variable<a id="id883" class="indexterm"></a>s of a <code class="literal">integer</code> type, and the <code class="literal">bActivated</code> and <code class="literal">canBeActivated</code> variables of a <code class="literal">boolean</code> type.</p></li><li><p>Declare the <code class="literal">OnCollisionEnter</code> function<a id="id884" class="indexterm"></a>.</p></li><li><p>The first thing that we need to check is whether the button can be activated. If it can't be, then we will return from the function. The next step is to check the type of the button and the tag of the collided object.</p></li><li><p>In the first case, we need to set <code class="literal">bActivated</code> to <code class="literal">true</code> and <code class="literal">canBeActivated</code> to <code class="literal">false</code>, and increment the <code class="literal">Activation</code> variable.</p></li><li><p>In the second case, we also need to toggle the <code class="literal">bActivated</code>
<a id="id885" class="indexterm"></a> and <code class="literal">canBeActivated</code>
<a id="id886" class="indexterm"></a> <code class="literal">boolean</code> variable<a id="id887" class="indexterm"></a>s.</p></li><li><p>In our example, we will be opening doors whenever the buttons are activated. Let's declare the required variables.</p></li><li><p>In the <code class="literal">Awake</code> function<a id="id888" class="indexterm"></a><a id="id889" class="indexterm"></a>, we need to store the original location of the moved doors and buttons into the variables.</p></li><li><p>In the <code class="literal">Update</code> function<a id="id890" class="indexterm"></a><a id="id891" class="indexterm"></a>, we will handle opening the doors based on their type.</p></li><li><p>In the <code class="literal">Button</code> script<a id="id892" class="indexterm"></a><a id="id893" class="indexterm"></a>, add the following code snippet:<a id="id894" class="indexterm"></a><a id="id895" class="indexterm"></a></p><div class="informalexample"><pre class="programlisting">public var Door1 : GameObject;
public var Door2 : GameObject;
public var ButtonType : int;
static var Activation: int;
public var bActivated: boolean;
private var canBeActivated: boolean;
private var DoorOneStartPosition: Vector3;
private var DoorTwoStartPosition: Vector3;
private var ThisStartPosition: Vector3;
function OnCollisionEnter(other : Collision){
if (!canBeActivated)
return;
if (ButtonType == 1 &amp;&amp; other.gameObject.tag == "projectile"){
bActivated = true;
canBeActivated = false;
}
else if (ButtonType == 2 &amp;&amp; other.gameObject.tag == "Player"){
bActivated = true;
Activation ++;
canBeActivated = false;
}
}
function Awake(){
    ThisStartPosition = this.transform.position;
    if(Door1)
        DoorOneStartPosition = Door1.transform.position;
    if(Door2)
        DoorTwoStartPosition = Door2.transform.position;
}
function Update(){
if(bActivated == true){
    if (ButtonType == 1){
        this.transform.position = Vector3.Lerp(this.transform.position, ThisStartPosition + Vector3(0.5, 0, 0), Time.deltaTime);
        Door1.transform.position = Vector3.Lerp(DoorLeft.transform.position, DoorLeftStartPosition + Vector3(0,7,0), Time.deltaTime);
    }
    else if (ButtonType == 2){
        transform.position = Vector3.Lerp(this.transform.position, ThisStartPosition + Vector3(0, -0.5, 0), Time.deltaTime);
                if (Activated == 2)
                    Door2.transform.position = Vector3.Lerp(Door.transform.position, DoorStartPosition + Vector3(0, 7, 0), Time.deltaTime);
                            }
    }
}</pre></div></li></ol></div><p><code class="literal">Activation</code> will be used to calculate the number of buttons activated by a player. <code class="literal">bActivated</code> will be used for the projectile activated button, and as we are not referencing any other buttons, this variable can remain <code class="literal">public</code>. <code class="literal">canBeActivated</code> will help us to disable the button when it gets activated.</p><a id="id896" class="indexterm"></a><a id="id897" class="indexterm"></a><p>The <code class="literal">Vector3.Lerp</code> function<a id="id898" class="indexterm"></a><a id="id899" class="indexterm"></a> will be moving the door until it reaches the offset destination and is saved to use in the <code class="literal">Update</code> function. That is it for now; we will return to that function later after talking about level loading.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec83"></a>Managing levels</h3></div></div></div><a id="id900" class="indexterm"></a><a id="id901" class="indexterm"></a><p>Now that the basic functionality of the buttons is written, we need to make them load levels for us. There are multiple ways to load scenes; one of them is to destroy the current scene and load a new one. This can be done with the <code class="literal">Application.LoadLevel</code>(<code class="literal">levelindex</code> <code class="literal">:</code> <code class="literal">int</code>) function.<a id="id902" class="indexterm"></a><a id="id903" class="indexterm"></a> (For this function to work, our scene needs to be included into level array in the <span class="strong"><strong>Build</strong></span> <span class="strong"><strong>Settings</strong></span> window. <code class="literal">levelindex</code> is used to reference it) But, what if we don't wish to destroy the current level, and need to load a new scene on top of the existing one? For this to work, we can use the <code class="literal">Application.LoadLevelAdditive</code>(<code class="literal">levelindex</code> <code class="literal">:</code> <code class="literal">int</code>) function<a id="id904" class="indexterm"></a><a id="id905" class="indexterm"></a>, which will load a new level without destroying the current one. This option is very useful when we are working with a limited amount of memory and want only the required pieces of levels to exist, by loading new parts and destroying the old ones.</p><p>In our case, buttons don't need to destroy previous levels, but only load new ones when the time is right.</p><a id="id906" class="indexterm"></a><p>In the <code class="literal">OnCollisonEnter</code> function, if our <code class="literal">ButtonType</code> is <code class="literal">1</code>, we will load the second level on top of the current one:</p><div class="informalexample"><pre class="programlisting">Application.LoadLevelAdditive(2);</pre></div><p>The same thing needs to be done to the <code class="literal">Update</code> function under the <code class="literal">ButtonType</code> <code class="literal">0</code>:</p><div class="informalexample"><pre class="programlisting">else if (ButtonType == 2){
Application.LoadLevelAdditive(3);</pre></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec84"></a>Save/load system</h3></div></div></div><a id="id907" class="indexterm"></a><a id="id908" class="indexterm"></a><p>In the previous chapter, we have already covered writing data in the text file and retrieving it back with Windows libraries. Now, we will do the same with checkpoints, plus learn how to dynamically create directories and files if they don't exist.</p><p>There is some information, which we will be saving in the save file that we need to set up, before going into save/load functions.</p><p>The following are the variables that we need to declare in the <code class="literal">WorldManager</code> script, which will be used in the saving system:</p><div class="informalexample"><pre class="programlisting">private var PlayerHealth : int;
private var AmmoPrime : int;
private var AmmoAlt : int;
private var Money : int;
static private var currentLevel : int;
static public var levelState : String;
static private var Missions : int[] = [0, 0, 0];
static public var CurrentSpawnPointIndex : int = 1;</pre></div><p>Private player information (<code class="literal">PlayerHealth</code>, <code class="literal">AmmoPrime</code>, <code class="literal">AmmoAlt</code>, <code class="literal">Money</code>) will be retrieved from the <code class="literal">CH_PlayerStats</code> script<a id="id909" class="indexterm"></a> and set back with the <code class="literal">SetStats</code> function<a id="id910" class="indexterm"></a>. We will use them to set the player's statistics to where they were when the player was last saved. <code class="literal">currentLevel</code> is a <code class="literal">static</code> variable<a id="id911" class="indexterm"></a><a id="id912" class="indexterm"></a> that will keep track of the level needed to be loaded. <code class="literal">levelState</code> will tell us about the state of the game. We will use that to check whether the game is in play mode, or whether the player has failed and we need to load the dying scene. <code class="literal">Missions</code>
<a id="id913" class="indexterm"></a> is an array of integers that will keep track of mission progress. <code class="literal">CurrentSpawnPointIndex</code>
<a id="id914" class="indexterm"></a> is self-explanatory; we will use it to spawn the player at the right spawnpoint.</p><p>To save the player statistics, we need to reference the script that is attached to our player. We will use the <code class="literal">FindWithTag</code> function<a id="id915" class="indexterm"></a><a id="id916" class="indexterm"></a>, which will help us to find the object with a <code class="literal">Player</code> tag<a id="id917" class="indexterm"></a> out of all the objects in the scene:</p><div class="informalexample"><pre class="programlisting">public function SetStats( PlayerHealth : int ,AmmoPrime : int, AmmoAlt : int, Money : int){
var PlayerStats : CH_PlayerStats = GameObject.FindWithTag("Player").GetComponent("CH_PlayerStats");</pre></div><p>We will need to create a <code class="literal">static</code> function<a id="id918" class="indexterm"></a><a id="id919" class="indexterm"></a> to save the game from any script. Declare a new <code class="literal">static</code> function called <code class="literal">SaveGame</code>:</p><div class="informalexample"><pre class="programlisting">static public function SaveGame( ){}</pre></div><a id="id920" class="indexterm"></a><a id="id921" class="indexterm"></a><p>The rest of this function will write information into the text file:</p><div class="informalexample"><pre class="programlisting">var file = new StreamWriter( Application.dataPath + "/Saves/SavedGame.txt");
file.WriteLine( currentLevel );
file.WriteLine( CurrentSpawnPointIndex );
if (GameObject.FindWithTag("Player")){
var PlayerStats : CH_PlayerStats = GameObject.FindWithTag("Player").GetComponent("CH_PlayerStats");
file.WriteLine( PlayerStats.GetHealth() );
file.WriteLine( PlayerStats.GetAmmo(0) );
file.WriteLine( PlayerStats.GetAmmo(1) );
file.WriteLine( PlayerStats.GetMoney() );
}
file.WriteLine( Missions[0] );
file.WriteLine( Missions[1] );
file.WriteLine( Missions[2] );
file.Flush();
file.Close();</pre></div><p>Declare a new function called <code class="literal">Initialize()</code>:</p><div class="informalexample"><pre class="programlisting">public function Initialize(){}</pre></div><a id="id922" class="indexterm"></a><p>We will start <code class="literal">Initialize</code> with setting level state. Create a new function called <code class="literal">SetLevelState</code>
<a id="id923" class="indexterm"></a>; it needs to be <code class="literal">static</code> and will take <code class="literal">String</code> as an argument, which will be assigned to the current state of the game:</p><div class="informalexample"><pre class="programlisting">static function SetLevelState(newState : String){
levelState = newState;}</pre></div><p>Later, we will need the set and get functions for the <code class="literal">Missions</code> array and the <code class="literal">CurrentSpawnPointIndex</code> variable<a id="id924" class="indexterm"></a><a id="id925" class="indexterm"></a>, so we might as well set and declare them now. In the case of the <code class="literal">Missions</code> array, it's the only one that needs both the set and get functions and an extra variable to take an index of the array:</p><div class="informalexample"><pre class="programlisting">static public function MissionStatusCheck ( missionIndex : int ){
    return Missions[missionIndex];}
static public function SetMissionStatus ( missionIndex : int, status : int ){
Missions[missionIndex] = status;}
static public function SetCheckPoint( newCheckPoint : int ){
    CurrentSpawnPointIndex = newCheckPoint;}</pre></div><a id="id926" class="indexterm"></a><a id="id927" class="indexterm"></a><p>Back to the <code class="literal">Initialize</code> function<a id="id928" class="indexterm"></a><a id="id929" class="indexterm"></a>, we need to check whether the directory exists, and if not, create it, just like we did in the <code class="literal">SaveGame</code> function<a id="id930" class="indexterm"></a><a id="id931" class="indexterm"></a>. However, in this function, we also need to check if the save file exists:</p><div class="informalexample"><pre class="programlisting">if(!Directory.Exists("Assets/Saves/") ){Directory.CreateDirectory("Assets/Saves/");}  
if (File.Exists(Application.dataPath + "/Saves/SavedGame.txt")){}
If file indeed exists we need to read all data from it and assign to our variables.
var file = new StreamReader( Application.dataPath + "/Saves/SavedGame.txt" );
currentLevel = parseInt( file.ReadLine() );
CurrentSpawnPointIndex = parseInt ( file.ReadLine() );
PlayerHealth = parseInt ( file.ReadLine() );
AmmoPrime = parseInt ( file.ReadLine() );
AmmoAlt = parseInt ( file.ReadLine() );
Money = parseInt ( file.ReadLine() );
Missions[0] = parseInt ( file.ReadLine() );
Missions[1] = parseInt ( file.ReadLine() );
Missions[2] = parseInt ( file.ReadLine() );
file.Close();
}</pre></div><p>On the other hand, if the file is not yet created, we need to set the default values to <a id="id932" class="indexterm"></a>variables and create a file in the directory; this means that we are starting a new game:</p><div class="informalexample"><pre class="programlisting">else{
currentLevel = 1;
CurrentSpawnPointIndex = 1;
PlayerHealth = 100;
AmmoPrime = 20;
AmmoAlt = 20;
Money = 0;
Missions[0] = 0;
Missions[1] = 0;
Missions[2] = 0;
var file = new StreamWriter( Application.dataPath + "/Saves/SavedGame.txt");
file.WriteLine(currentLevel);
file.WriteLine(CurrentSpawnPointIndex);
file.WriteLine(PlayerHealth);
file.WriteLine(AmmoPrime);
file.WriteLine(AmmoAlt);
file.WriteLine(Money);
file.WriteLine(Missions[0]);
file.WriteLine(Missions[1]);
file.WriteLine(Missions[2]);
file.Close();
}</pre></div><a id="id933" class="indexterm"></a><a id="id934" class="indexterm"></a><p>Now that we have all the needed variables assigned to their value, we can use them to check which scenes need to be loaded. For this, we will create a new function called <code class="literal">LoadingLevels()</code>
<a id="id935" class="indexterm"></a>:</p><div class="informalexample"><pre class="programlisting">function LoadingLevels(){
if(!Missions[0]){	
Application.LoadLevel(currentLevel);
}
else if(!Missions[1]){
Application.LoadLevel(currentLevel);
Application.LoadLevelAdditive(currentLevel + 1);
}
else if(!Missions[2]){
Application.LoadLevel(currentLevel);
Application.LoadLevelAdditive(currentLevel - 1);
}
}</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note16"></a>Note</h3><p><code class="literal">Directory</code> is a part of the <code class="literal">System</code> <code class="literal">IO</code> library.</p></div><a id="id936" class="indexterm"></a><p>The completed <code class="literal">WorldManager</code> script is as follows:</p><div class="informalexample"><pre class="programlisting">static public function SaveGame( ){
var file = new StreamWriter( Application.dataPath + "/Saves/SavedGame.txt");
file.WriteLine( currentLevel );
file.WriteLine( CurrentSpawnPointIndex );
if (GameObject.FindWithTag("Player")){
var PlayerStats : CH_PlayerStats = GameObject.FindWithTag("Player").GetComponent("CH_PlayerStats");
file.WriteLine( PlayerStats.GetHealth() );
file.WriteLine( PlayerStats.GetAmmo(0) );
file.WriteLine( PlayerStats.GetAmmo(1) );
file.WriteLine( PlayerStats.GetMoney() );
}
file.WriteLine( Missions[0] );
file.WriteLine( Missions[1] );
file.WriteLine( Missions[2] );
file.Flush();
file.Close();
}
public function Initialize(){
if( !Directory.Exists( "Assets/Saves/" ) ){Directory.CreateDirectory( "Assets/Saves/"  );}  
if (File.Exists(Application.dataPath + "/Saves/SavedGame.txt")){
var file = new StreamReader( Application.dataPath + "/Saves/SavedGame.txt" );
currentLevel = parseInt( file.ReadLine() );
CurrentSpawnPointIndex = parseInt ( file.ReadLine() );
PlayerHealth = parseInt ( file.ReadLine() );
AmmoPrime = parseInt ( file.ReadLine() );
AmmoAlt = parseInt ( file.ReadLine() );
Money = parseInt ( file.ReadLine() );
Missions[0] = parseInt ( file.ReadLine() );
Missions[1] = parseInt ( file.ReadLine() );
Missions[2] = parseInt ( file.ReadLine() );
file.Close();
}
else{
File.Create(Application.dataPath + "/Saves/SavedGame.txt");
currentLevel = 1;
CurrentSpawnPointIndex = 1;
PlayerHealth = 100;
AmmoPrime = 20;
AmmoAlt = 20;
Money = 0;
Missions[0] = 0;
Missions[1] = 0;
Missions[2] = 0;
var file = new StreamWriter( Application.dataPath + "/Saves/SavedGame.txt");
file.WriteLine(currentLevel);
file.WriteLine(CurrentSpawnPointIndex);
file.WriteLine(PlayerHealth);
file.WriteLine(AmmoPrime);
file.WriteLine(AmmoAlt);
file.WriteLine(Money);
file.WriteLine(Missions[0]);
file.WriteLine(Missions[1]);
file.WriteLine(Missions[2]);
file.Close();
}
}
static function SetLevelState(newState : String){
levelState = newState;
}
static public function MissionStatusCheck (missionIndex : int){
    return Missions[missionIndex];
}
static public function SetMissionStatus( missionIndex : int, status : int){
    Missions[missionIndex] = status;
}
static public function SetCheckPoint( newCheckPoint : int ){
    CurrentSpawnPointIndex = newCheckPoint;
}
function LoadingLevels(){
if(!Missions[0]){    
Application.LoadLevel(currentLevel);
}
else if(!Missions[1]){
Application.LoadLevel(currentLevel);
Application.LoadLevelAdditive(currentLevel + 1);
}
else if(!Missions[2]){
Application.LoadLevel(currentLevel);
Application.LoadLevelAdditive(currentLevel - 1);
}
}</pre></div><p><code class="literal">Initialize</code> does not need to be <code class="literal">static</code> as it will be called only from within the script. <code class="literal">Initialize</code> will be used to initialize the game, by reading from the saved file and <a id="id937" class="indexterm"></a><a id="id938" class="indexterm"></a><a id="id939" class="indexterm"></a>making all the arrangements to start the gameplay.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec85"></a>Loading with checkpoints</h3></div></div></div><a id="id940" class="indexterm"></a><a id="id941" class="indexterm"></a><p>One way to keep track of our game status is by checking the completed missions and loading levels according to it. But, let's return to the <code class="literal">Initialize</code> function<a id="id942" class="indexterm"></a> and call <code class="literal">LoadingLevels</code> from it.</p><div class="informalexample"><pre class="programlisting">...
LoadingLevels();</pre></div><p>After the level is loaded, we need to spawn the actual player in the specified checkpoint. Declare a new function called <code class="literal">SpawnPlayer</code>
<a id="id943" class="indexterm"></a>, which will take <code class="literal">SpawnIndex</code> as an argument:</p><div class="informalexample"><pre class="programlisting">static function SpawnPlayer(spawnIndex : int){}</pre></div><p>Based on the sent variable, we need to find <code class="literal">SpawnPoint</code> in the level:</p><div class="informalexample"><pre class="programlisting">var SpawnPlace : GameObject = GameObject.FindWithTag("spawnPoint" + CurrentSpawnPointIndex) ;</pre></div><p>We also need to specify the prefab of the player that will be spawned. To be used in the <code class="literal">static</code> function, we need to declare the <code class="literal">static</code> variable<a id="id944" class="indexterm"></a>. However, <code class="literal">static</code> variables cannot be set in the <span class="strong"><strong>Inspector</strong></span> view, therefore we need to create a pair of variables—one <code class="literal">public</code> and one <code class="literal">static</code>:</p><div class="informalexample"><pre class="programlisting">static public var PlayerPrefab : GameObject;
public var PlayerPrefab2 : GameObject;</pre></div><a id="id945" class="indexterm"></a><p>In the <code class="literal">Awake</code> function, we need to assign the <code class="literal">public</code> variable to the <code class="literal">static</code> variable:</p><div class="informalexample"><pre class="programlisting">PlayerPrefab = PlayerPrefab2;</pre></div><p>Now that we have that, two series of checks need to be done—we need to check if the <code class="literal">SpawnPlace</code> that we issued really exists and if <code class="literal">PlayerPrefab</code> is set, then all that's  left to do is to instantiate the player:</p><div class="informalexample"><pre class="programlisting">if(SpawnPlace){
    if(PlayerPrefab){
    Instantiate (PlayerPrefab, SpawnPlace.transform.position, Quaternion.identity);}
    else
    Debug.LogError("Player Prefab is not set");}
else
Debug.Log("Spawnpoint wasn't found");}</pre></div><p>Right after the player is spawned, we need to adjust his statistics with a <code class="literal">SetStats</code> function by referencing the <code class="literal">CH_PlayerStats</code> script and calling modifying functions there:<a id="id946" class="indexterm"></a></p><div class="informalexample"><pre class="programlisting">public function SetStats( PlayerHealth : int ,AmmoPrime : int, AmmoAlt : int, Money : int){ 
var PlayerStats : CH_PlayerStats = GameObject.FindWithTag("Player").GetComponent("CH_PlayerStats");
PlayerStats.AddHealth(PlayerHealth, 0);
PlayerStats.AddAmmo(1,AmmoPrime, 0);
PlayerStats.AddAmmo(2,AmmoPrime, 0);
PlayerStats.AddMoney(Money, 0);}</pre></div><p>Now, we have all we need to finish the <code class="literal">Initialize</code> function. The first thing that we need to check is if the level with which we are trying to create our player has finished loading and that the <code class="literal">SpawnPoint</code> exists. Thankfully, we can check level progress with the <code class="literal">GetStreamProgressForLevel</code> function.<a id="id947" class="indexterm"></a> This whole check needs to be done inside the <code class="literal">while</code> loop to be able to constantly check if the level has finished loading. If that doesn't work, we will simply go through the <code class="literal">while</code> loop again, but that will be too expensive to call each frame. To make sure that it doesn't, we will use the <code class="literal">yield</code> command and call the <code class="literal">WaitForSeconds</code> function<a id="id948" class="indexterm"></a> with one second delay.</p><div class="informalexample"><pre class="programlisting">while(1){
var SpawnPlace : GameObject = GameObject.FindWithTag("spawnPoint" + CurrentSpawnPointIndex);
if(Application.GetStreamProgressForLevel(currentLevel) == 1 &amp;&amp; SpawnPlace != null){
SpawnPlayer(CurrentSpawnPointIndex);
SetStats(PlayerHealth, AmmoPrime, AmmoAlt, Money);
break;}
else{
yield WaitForSeconds(1);}</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note17"></a>Note</h3><p><code class="literal">yield</code>
<a id="id949" class="indexterm"></a> is a coroutine; a function that can suspend its execution until requirements specified in <code class="literal">YieldInstructions</code> have been met.</p></div><a id="id950" class="indexterm"></a><p>One other function that we need to create is called <code class="literal">SetMissionStatus</code>
<a id="id951" class="indexterm"></a>, which will help us to set a new value to the <code class="literal">Mission</code> array:</p><div class="informalexample"><pre class="programlisting">static public function SetMissionStatus( missionIndex : int, status : int){
    Missions[missionIndex] = status;
}</pre></div><p>The first thing that we should have done is to set the level state to <code class="literal">Playing</code>. At the beginning of the <code class="literal">Initialize</code> function<a id="id952" class="indexterm"></a>, add the following line of code:</p><div class="informalexample"><pre class="programlisting">SetLevelState( "Playing");</pre></div><p>To finalize the <code class="literal">WorldManager</code> script<a id="id953" class="indexterm"></a>, we will create menu buttons with GUI. By checking the current level and state, we will show appropriate menu options.</p><p>Continuing with the <code class="literal">WorldManager</code> script, we will add the following code snippet:</p><div class="informalexample"><pre class="programlisting">function OnGUI(){
if (Application.loadedLevel == 0 ){
if(GUI.Button(Rect(Screen.width - Screen.width/2, Screen.height - Screen.height/2, 180, 20), "New Game/ Continue")){
Initialize();
}
}
else if (levelState == "Dead"){
if(GUI.Button(Rect(Screen.width - Screen.width/2, Screen.height - Screen.height/2, 180, 20), "Load last checkpoint")){
Initialize();
}
if(GUI.Button(Rect(Screen.width - Screen.width/2, Screen.height - Screen.height/2 + 30, 180, 20), "Go To Main Menu")){
Application.LoadLevel(0);
}
}
}</pre></div><p>The following screenshot shows what our simple frontend should look like:</p><div class="mediaobject"><img src="/graphics/9781849692304/graphics/2304EXP_06_05.jpg" /></div><p>Now that we have finished with the <code class="literal">WorldManager</code> script, we need to add a few lines to the <code class="literal">Button</code> script. The first addition will be inside the <code class="literal">OnCollisionEnter</code> function<a id="id954" class="indexterm"></a>. When the projectile activates <code class="literal">ButtonType</code> <code class="literal">1</code> (inside the <code class="literal">else</code> <code class="literal">if</code> statement<a id="id955" class="indexterm"></a>), we need to set the mission to complete, set a new level, set a new checkpoint, save the game, and load the new level.</p><a id="id956" class="indexterm"></a><p>In the <code class="literal">Button</code> script, add the following code snippet:</p><div class="informalexample"><pre class="programlisting">...
WorldManager.SetMissionStatus(0, 1);
WorldManager.SetCurrentLevel(2);
WorldManager.SetCheckPoint(2);
WorldManager.SaveGame();
Application.LoadLevelAdditive(2);
...</pre></div><p>As we have made <code class="literal">WorldManager</code> a <code class="literal">static</code> class, we don't need to bother referencing it.</p><p>Now, we need to do the same thing, but only with the <code class="literal">Update</code> function<a id="id957" class="indexterm"></a>. Inside the <code class="literal">else</code> <code class="literal">if</code> statement when we are comparing <code class="literal">ButtonType</code> to <code class="literal">0</code>, we need to check if we haven't completed the first mission and activated both the buttons in the <code class="literal">Button</code> script:</p><div class="informalexample"><pre class="programlisting">if(!WorldManager.MissionStatusCheck(1) &amp;&amp; Activated == 2){
WorldManager.SetMissionStatus(1, 1);
WorldManager.SetCurrentLevel(3);
WorldManager.SetCheckPoint(3);
WorldManager.SaveGame();
Application.LoadLevelAdditive(3);</pre></div></div></div>