<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch01lvl1sec12"></a>Dynamic objects</h2></div></div><hr /></div><a id="id111" class="indexterm"></a><p>Now that you can interact with objects that don't move, why don't we interact with something more dynamic? Dynamic interactive objects are the ones that are, well, moving. They usually involve adding their velocity to the character. For example, this could be done when we want our character to travel through the moving train level. The train's velocity is being added to the Character Controller to keep the character's position with that of the train's position. Once the player moves the joystick, moving the character, the additional velocity from the input value is added to the current velocity of the Character Controller creating a clean, smooth walk/run/jump while on the moving train. We will cover this transfer of velocity of one object to another.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec10"></a>Moving boxes</h3></div></div></div><a id="id112" class="indexterm"></a><a id="id113" class="indexterm"></a><p>Now let's teach our construction worker (character) to move boxes. Select the <span class="strong"><strong>Box</strong></span> prefab from the <span class="strong"><strong>Chapter 1 prefabs</strong></span> folder in the <span class="strong"><strong>Project</strong></span> view and drag it to the scene. Having an instance of <span class="strong"><strong>Box</strong></span> selected, go to <span class="strong"><strong>Component</strong></span> | <span class="strong"><strong>Physics</strong></span> | <span class="strong"><strong>Rigidbody</strong></span><a id="id114" class="indexterm"></a> to make the box follow the laws of physics.</p><div class="mediaobject"><img src="/graphics/9781849692304/graphics/2304EXP_01_12.jpg" /></div><p>At the beginning of the chapter, we talked about Character Controller and its problems with Rigidbodies. For example, if we press <span class="strong"><strong>Play</strong></span> and try to push the box with our character, we'll see that no matter what we do, there is no way our character can make this box <a id="id115" class="indexterm"></a>move, not even an inch. That happens because the default <span class="strong"><strong>3rd</strong></span> <span class="strong"><strong>Person</strong></span> <span class="strong"><strong>Character</strong></span> <span class="strong"><strong>Controller</strong></span> doesn't know what to do when interacting with objects. Neither will the Character Controller component help us because it's not programmed to affect physics objects.</p><div class="mediaobject"><img src="/graphics/9781849692304/graphics/2304EXP_01_13.jpg" /></div><p>To solve our problem, we will have to modify the original script and add additional functionality to be able to interact with dynamic objects:<a id="id116" class="indexterm"></a></p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><a id="id117" class="indexterm"></a><p>Select the character and open the attached <span class="strong"><strong>ThirdPersonController</strong></span> script<a id="id118" class="indexterm"></a>. Scroll down and find the <span class="strong"><strong>OnControllerColliderHit</strong></span> function<a id="id119" class="indexterm"></a>.</p></li><li><p>Declare the local variable—<code class="literal">pushForce</code> of a <code class="literal">float</code> type that will control the force that will be applied to the box when we push it. To make it more interesting, let's assign it a current speed that the character is moving at. For that, we will use the default function—<code class="literal">GetSpeed</code> that will return the speed of our character. (This way we can push the object even further if we run into it.)</p></li><li><p>Declare the <code class="literal">body</code> variable of <code class="literal">Rigidbody</code> type that will contain information of <span class="strong"><strong>Rigidbody</strong></span> from the object we collided with.</p></li><li><p>Just to make sure that this script works only with objects that have <span class="strong"><strong>Rigidbody</strong></span> attached, we'll add the following check:</p><p>If the object that we collided with doesn't have <span class="strong"><strong>Rigidbody</strong></span> or is checked as kinematic, then stop here and get out from the function.</p></li><li><p>Check if the distance from the center of the capsule collider to the place we are touching is less than -0.3 (simply if the object is below us and we don't want to push it).</p></li><li><p>Declare a <code class="literal">dirVector</code> variable<a id="id120" class="indexterm"></a> of a <code class="literal">Vector3</code> type that will be used to prevent the box from moving up or down when we're pushing it. <code class="literal">dirVector</code> should store the current location of the box on the <span class="strong"><strong>X</strong></span> and <span class="strong"><strong>Z</strong></span> axes.</p></li><li><p>Apply force to the box's <span class="strong"><strong>Rigidbody</strong></span> by modifying its velocity and multiplying its force by a vector.</p></li><li><p>In this case, we want the box to slide on the surface rather than spin over. To make that possible, select <span class="strong"><strong>Box</strong></span> object and in the <span class="strong"><strong>Rigidbody</strong></span> component, <a id="id121" class="indexterm"></a>under <span class="strong"><strong>Constraints</strong></span> check, select all boxes for <span class="strong"><strong>Freeze</strong></span> <span class="strong"><strong>Rotation</strong></span>.<a id="id122" class="indexterm"></a></p></li></ol></div><p>The following code snippet shows how the <code class="literal">OnControllerColliderHit</code> function should look at this point:</p><div class="informalexample"><pre class="programlisting">function OnControllerColliderHit ( hit : ControllerColliderHit ){
if ( hit.gameObject.name == "Button" ){
        hit.gameObject.GetComponent("Button").MoveButton();
    }
var pushForce : float = GetSpeed();
var body : Rigidbody = hit.collider.attachedRigidbody;
if (body == null || body.isKinematic)
return;
if (hit.moveDirection.y &lt; -0.3)
return;
var dirVector : Vector3 = Vector3(hit.moveDirection.x, 0,
                                  hit.moveDirection.z);
body.velocity = dirVector * pushForce;
}</pre></div><p>Done. If we test the game now, we will see that when our character runs over the box, it is being pushed in the direction of the impact.</p><div class="mediaobject"><img src="/graphics/9781849692304/graphics/2304EXP_01_14.jpg" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec11"></a>Triggered object</h3></div></div></div><a id="id123" class="indexterm"></a><a id="id124" class="indexterm"></a><p>Next in line are triggered objects. These objects are classified by needing an outside interaction to make them active and usable. In games as well as in real life, this device that can activate them is usually found to be a switch, a lever, or a button. Unique triggers can be used as well, for example, when a player enters an area and triggers a cinematic sequence.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec12"></a>Moving platform</h3></div></div></div><a id="id125" class="indexterm"></a><p>In this section, we will learn how to create button-triggered platforms and teach our character to move along with them. Let's get started. Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create new script and call it <span class="strong"><strong>platform</strong></span> (this name will be used to reference it in the future).</p></li><li><p>Attach it to the <span class="strong"><strong>platform</strong></span> prefab that can be found in a scene.</p><div class="mediaobject"><img src="/graphics/9781849692304/graphics/2304EXP_01_15.jpg" /></div></li><li><a id="id126" class="indexterm"></a><p>Declare two <code class="literal">public</code> variables of <code class="literal">GameObject</code> type. Call them PointA and PointB. We will use position information of these objects to navigate movement of our platform.</p></li><li><p>Declare another variable of a <code class="literal">Vector3</code> type, <code class="literal">private</code> this time, and call it <code class="literal">Target</code>. This variable will tell the platform where to move at this moment in time.</p></li><li><p>Create <code class="literal">Awake</code> function<a id="id127" class="indexterm"></a> and assign position of PointA to the <code class="literal">Target</code> vector.</p></li><li><p>We need a function that will be changing targets for platform when it reached its destination to reverse direction. Create a <code class="literal">Toggle</code> function that will check current target and change it to opposite.</p></li><li><p>Then next thing we need is to control the platform to stop it from moving. Declare a <code class="literal">public</code> variable—<code class="literal">AllowMove</code> of a <code class="literal">Boolean</code> type and set its default value to <code class="literal">false</code> (we don't want to start moving the platform at the game start).</p></li><li><p>Write the <code class="literal">Activated</code> function<a id="id128" class="indexterm"></a><a id="id129" class="indexterm"></a> that will activate the platform to move if it's <a id="id130" class="indexterm"></a>not moving.</p></li><li><p>Finally, we need an <code class="literal">Update</code> function that will handle the platform moving <a id="id131" class="indexterm"></a>and stop movement if the platform reached the goal.</p></li></ol></div><p>The completed <span class="strong"><strong>platform</strong></span> script<a id="id132" class="indexterm"></a> is as follows:</p><div class="informalexample"><pre class="programlisting">public var AllowMove : boolean = false;
public var PointA : GameObject;
public var PointB : GameObject;
private var Target : Vector3;
function Awake(){
    Target = PointA.transform.position;
}
function Update(){
    if (AllowMove == true){
    this.transform.position = Vector3.MoveTowards(this.transform.position, Target, Time.deltaTime);
    }
    if (this.transform.position == Target){
        AllowMove = false;
        Toggle();
    }
}
function Toggle(){
    if (Target == PointA.transform.position)
    Target = PointB.transform.position;
    else
    Target = PointA.transform.position;
}
function Activated(){
        if(AllowMove == false )
            AllowMove = true;
}</pre></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec13"></a>Moving the character with the platform</h3></div></div></div><a id="id133" class="indexterm"></a><a id="id134" class="indexterm"></a><p>Now, we are done with the <span class="strong"><strong>platform</strong></span> script and have a tough platform to move upon our command. However, if we jump at the platform when it moves, we will see that it simply moves away while we are standing still. Our new objective is to make the character move with the platform while standing on it. Let's create a new script and call it <span class="strong"><strong>moveAlong</strong></span><a id="id135" class="indexterm"></a>. Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>We will need one variable of <code class="literal">Vector3</code> type to guide in which direction to move the player.</p></li><li><p>Last, but not least, we will declare an <code class="literal">OnTriggerStay</code> function that will be triggered when a player is standing on it. We will also check the <code class="literal">AllowMove</code> variable that will tell us if the platform is moving or not.</p></li><li><p>Inside the <code class="literal">if</code> statement, we will get the destination of the platform and apply movement to the player.</p></li></ol></div><p>The following is an example of the complete <span class="strong"><strong>moveAlong</strong></span> script:</p><div class="informalexample"><pre class="programlisting">public var MoveTo:Vector3;
function OnTriggerStay ( other : Collider ) {
if( other.gameObject.tag == "Player" &amp;&amp; transform.root.GetComponent("platform").AllowMove ){
MoveTo = transform.root.GetComponent("platform").Target;
MoveTo.y = other.gameObject.transform.position.y;
MoveTo.z = other.gameObject.transform.position.z;	
other.gameObject.transform.position = Vector3.MoveTowards( other.gameObject.transform.position, MoveTo, Time.deltaTime );
}
}</pre></div><p>Attach this script to the child of our <span class="strong"><strong>platform</strong></span>, which is called <span class="strong"><strong>trigger</strong></span> and we are done. Now we have a fully functional moving platform that will carry our character with it:</p><div class="mediaobject"><img src="/graphics/9781849692304/graphics/2304EXP_01_16.jpg" /></div></div></div>