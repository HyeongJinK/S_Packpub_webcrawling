<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec28"></a>Drag-and-drop inventory</h2></div></div><hr /></div><a id="id503" class="indexterm"></a><p>Drag-and-drop inventory is a usual thing for <span class="strong"><strong>role</strong></span> <span class="strong"><strong>playing</strong></span> <span class="strong"><strong>games</strong></span> (<span class="strong"><strong>RPGs</strong></span>)<a id="id504" class="indexterm"></a>. In this section, we will look under the hood of the technology behind it. GUI is not the best technology for drag-and-drop functionality in Unity; it's hard to work with, and it slows down the performance. On the other hand, it is a great opportunity to showcase problems and limitations of GUI.<a id="id505" class="indexterm"></a></p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec38"></a>Basics</h3></div></div></div><p>Perform the following steps:<a id="id506" class="indexterm"></a></p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new script called <code class="literal">CH_Inventory</code> and assign it to the character.</p></li><li><p>Declare a <code class="literal">boolean</code> variable that will be controlling GUI rendering; call it <code class="literal">inventoryOpened</code>.</p></li><li><p>Declare variables that will be used to store textures, which will be used in the GUI manipulation as follows:</p><div class="informalexample"><pre class="programlisting">var inventoryOpened : boolean = false;
public var EmptySlotTexture : Texture;
public var ChestIcon : Texture;
public var LeftArmIcon : Texture;
public var RightWeaponIcon : Texture;
public var HeadIcon : Texture;
public var ShoulderIcon : Texture;
public var BootsIcon : Texture;
public var MedKitIcon : Texture;
public var AmmoIcon : Texture;</pre></div></li><li><p>Declare a new function called <code class="literal">OnGUI()</code>.</p></li><li><p>Declare a new variable of the <code class="literal">Rect</code> type that will be used to reference and control the position of the window.</p></li><li><p>In the <code class="literal">OnGUI()</code> function<a id="id507" class="indexterm"></a>, we will assign a value to it and create a <code class="literal">GUI.Window</code> at the same time.</p></li><li><p>Declare a <code class="literal">DoMyWindow()</code> function<a id="id508" class="indexterm"></a> that will be called by our window.</p></li><li><p>Create a <span class="strong"><strong>GUI</strong></span> button that is located at the top-right corner of the window and occupies 32 by 32 pixels.</p></li><li><p>Set the <code class="literal">inventoryOpened</code> variable<a id="id509" class="indexterm"></a> to <code class="literal">false</code> inside that <code class="literal">if</code> statement to close the window.</p></li></ol></div><p>In the <code class="literal">CH_Inventory</code> script<a id="id510" class="indexterm"></a>, add the following code snippet:</p><div class="informalexample"><pre class="programlisting">var windowRect : Rect = Rect (20, 20, 200, 300);
function OnGUI () { 
windowRect = GUI.Window (0, windowRect, DoMyWindow, "Inventory");
}
function DoMyWindow (windowID : int) {
if (GUI.Button(Rect(windowRect.width - 32, 0, 32, 32), "Close")){
inventoryOpened = false;
}
}</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note12"></a>Note</h3><p><code class="literal">OnGUI</code>
<a id="id511" class="indexterm"></a> is a function where all GUIs should be called from (you cannot make GUI calls from anywhere else); this function is being executed every frame. It creates and checks GUI status every frame that allows creating instant response to all GUI changes.</p></div><p>The first thing that we are creating in our example is a window that will be used as the base for our inventory. The first argument in the window constructor is a personal ID of the window; it will be used to reference this specific window by window controlling functions. The second is a rectangular box that we declared at the top. The third is a function called by a window every time it's being rendered; we will use this function to create other GUIs that will be grouped by it. The last argument is a string that we are passing to the window to make it display that string's name.<a id="id512" class="indexterm"></a></p><p>Now that we have a window, we are creating a button to close it.</p><p>As we are calling this GUI from the window function, it will be grouped inside the window, and all coordinates that we set are based on window position. We used the width of the window and subtracted the width of the button from it to allow our button to be located in the top-right corner. When it's rendered, the word <span class="strong"><strong>Close</strong></span> will be displayed on the button.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec39"></a>Inventory slots and draggable objects</h3></div></div></div><p>Now, we will jump slightly ahead and create inventory slots<a id="id513" class="indexterm"></a> and draggable objects<a id="id514" class="indexterm"></a> that will be the basis of future code. We will start by creating our new classes for inventory slots and draggable objects.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note13"></a>Note</h3><p><span class="strong"><strong>Classes</strong></span><a id="id515" class="indexterm"></a> are structures of variables and functions that were put together for convenience. We will go through classes in depth in the appendix.</p></div><a id="id516" class="indexterm"></a><a id="id517" class="indexterm"></a><p>We will check if the current location of the mouse is within the slot location. Remember that mouse position is different from GUI location, therefore, we need to subtract current location from overall screen height, so that they could be pointing at the same position. To make this happen, we will create classes for inventory slots and draggable objects, and establish communication between them. Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Declare new classes called <code class="literal">InventorySlot</code> and <code class="literal">DraggableObject</code>.</p></li><li><p>To make our classes displayable in the <span class="strong"><strong>Inspector</strong></span> view, we will need to add <code class="literal">@System.Serializable</code>
<a id="id518" class="indexterm"></a> before them.</p></li><li><p>In both classes, we will declare variables to identify a type of the object, or slot and icon that is assigned to it.</p></li><li><p>In the <code class="literal">InventorySlot</code> class<a id="id519" class="indexterm"></a>, add extra variables, such as <code class="literal">location</code> of a <code class="literal">Vector2</code> type, <code class="literal">empty</code>, <code class="literal">Focused</code>, <code class="literal">ConstType</code> of a <code class="literal">boolean</code> type, and <code class="literal">Type</code> of a <code class="literal">String</code> type.</p></li><li><p>Declare a new function called <code class="literal">CheckFocus()</code>
<a id="id520" class="indexterm"></a> inside the <code class="literal">InventorySlot</code> class<a id="id521" class="indexterm"></a>. The following is the code for the <code class="literal">InventorySlot</code> and <code class="literal">DraggableObject</code> class<a id="id522" class="indexterm"></a>es:</p><div class="informalexample"><pre class="programlisting">@System.Serializable
class InventorySlot{
var icon : Texture;
var Type : String;
var location : Vector2;
var empty : boolean = true;
var Focused : boolean;
var ConstType : boolean = false;
function CheckFocus(){
    if (Input.mousePosition.y &gt; (Screen.height - location.y -32) &amp;&amp; Input.mousePosition.y &lt; (Screen.height - location.y) &amp;&amp; Input.mousePosition.x &gt; location.x &amp;&amp; Input.mousePosition.x &lt; (location.x + 32))
{Focused = true;}
    else
{Focused = false;}
    } 
}
@System.Serializable
class DraggableObject{
var icon : Texture;
var Type : String;
}</pre></div></li></ol></div><a id="id523" class="indexterm"></a><a id="id524" class="indexterm"></a><p>This will allow us to easily communicate among them.<a id="id525" class="indexterm"></a><a id="id526" class="indexterm"></a></p><p><code class="literal">location</code>
<a id="id527" class="indexterm"></a> is self-explanatory; it will help us to identify a location of the slot on the screen. <code class="literal">empty</code> will tell us if this slot is occupied or not; <code class="literal">Focused</code> will be used to check if the mouse is currently over that slot; and <code class="literal">ConstType</code>
<a id="id528" class="indexterm"></a> will determine if this slot is a generic inventory slot or is reserved for a specific type.</p><p>The <code class="literal">CheckFocus()</code> function<a id="id529" class="indexterm"></a> will be used to check if the mouse is currently hovering over this slot and modify the <code class="literal">Focused</code> variable<a id="id530" class="indexterm"></a> accordingly.</p><p>That is it for the <code class="literal">InventorySlot</code> class<a id="id531" class="indexterm"></a>, so let's return to the <code class="literal">DraggableObject</code> class.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Declare the <code class="literal">LastSlot</code>
<a id="id532" class="indexterm"></a> and <code class="literal">HoveringSlot</code> variable<a id="id533" class="indexterm"></a>s of a <code class="literal">InventorySlot</code> type inside the <code class="literal">DraggableObject</code> class.</p></li><li><p>Declare a <code class="literal">new</code> <code class="literal">Array</code> variable called <code class="literal">InventorySet</code> that will contain the <code class="literal">InventorySlot</code> objects.</p></li><li><p>We will need a couple more slots that will be used to store weapons and armor for our character, and we also need to initialize our draggable object.</p></li><li><p>We will need a <code class="literal">boolean</code> variable that will be identifying if we are dragging something or not.</p></li><li><p>Declare the <code class="literal">Awake</code> function where we will set the values for slots, as well as create a fixed size for our slot array.</p></li></ol></div><a id="id534" class="indexterm"></a><a id="id535" class="indexterm"></a><p>The following code snippet goes inside the <code class="literal">CH_Inventory</code> script<a id="id536" class="indexterm"></a>:<a id="id537" class="indexterm"></a></p><div class="informalexample"><pre class="programlisting">...
var DraggedObject : DraggableObject;
var draggablesection : Rect = Rect (10, 10, 30, 30);
var ChestSlotLoc : Rect =Rect(5,130,32,32); 
var ChestSlot : InventorySlot;
var RightWeaponSlotLoc : Rect =Rect(5,85,32,32); 
var RightWeaponSlot : InventorySlot; 
var LeftArmSlotLoc : Rect =Rect(160,85,32,32);
var LeftArmSlot : InventorySlot;
var HeadSlotLoc : Rect =Rect(5,40,32,32);
var HeadSlot : InventorySlot;
var ShoulderSlotLoc : Rect =Rect(160,40,32,32);
var ShoulderSlot : InventorySlot;
var BootsSlotLoc : Rect =Rect(160,130,32,32);
var BootsSlot : InventorySlot;
var InventorySet : InventorySlot[];
var dragging : boolean = false;
@System.Serializable
class DraggableObject{
var Type : String;
var LastSlot : InventorySlot;
var HoveringSlot : InventorySlot;
var icon : Texture;
}
function Awake(){
InventorySet = new Array(40);
ChestSlot.icon = ChestIcon;
ChestSlot.Type = "Chest";
ChestSlot.ConstType = true;
RightWeaponSlot.icon = RightWeaponIcon;
RightWeaponSlot.Type = "RightWeapon";
RightWeaponSlot.ConstType = true;
LeftArmSlot.icon = LeftArmIcon;
LeftArmSlot.Type = "LeftArm";
LeftArmSlot.ConstType = true;
HeadSlot.icon = HeadIcon;
HeadSlot.Type = "Head";
HeadSlot.ConstType = true;
BootsSlot.icon = BootsIcon;
BootsSlot.Type = "Boots";
BootsSlot.ConstType = true;
ShoulderSlot.icon = ShoulderIcon;
ShoulderSlot.Type = "Shoulder";
ShoulderSlot.ConstType = true;
}</pre></div><p><code class="literal">LastSlot</code>
<a id="id538" class="indexterm"></a> and <code class="literal">HoveringSlot</code>
<a id="id539" class="indexterm"></a> will be used to determine the slot that we are currently hovering over, when dragging an object; and which slot we acquired the object from so that it can be returned if we close the window or click in the empty space.</p><a id="id540" class="indexterm"></a><a id="id541" class="indexterm"></a><a id="id542" class="indexterm"></a><p>We will continue with creating draggable slots and implementing our slot array into the window:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Declare a new variable called <code class="literal">coord</code> of a <code class="literal">Vector2</code> type. It will be used to control the draggable object location on the screen:</p><div class="informalexample"><pre class="programlisting">var coord :Vector2 = Vector2.zero;</pre></div></li><li><p>In the <code class="literal">OnGUI</code> function, assign mouse position to the <code class="literal">coord</code> variable and subtract it's <code class="literal">y</code> value from the screen height. Inside the <code class="literal">OnGUI</code> function, add the following code lines:</p><div class="informalexample"><pre class="programlisting">coord = Input.mousePosition;
coord.y = Screen.height - coord.y;</pre></div></li><li><p>If the dragging is on, we need to modify the draggable object location based on mouse information; we also need to create the draggable object and use the modified location as its coordinates:</p><div class="informalexample"><pre class="programlisting">if (dragging){
draggablesection = Rect(coord.x-15, coord.y-15, 30, 30);
GUI.Box (draggablesection,GUIContent (DraggedObject.icon));
}</pre></div></li></ol></div><p>We are using 15 pixels offset to locate the draggable object in the center of the selection, instead of dragging its corner.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec40"></a>Working with GUI windows</h3></div></div></div><a id="id543" class="indexterm"></a><p>As our window is going to be draggable, we need to make sure that we keep up-to-date information about our weapon and armor slots. However, as slots are located inside the window, and all their location is based on window coordinates, we need to adjust our coordinates based on that. Thankfully, there is a function that does it for us—<code class="literal">GUIUtility.GUIToScreenPoint()</code>. It takes the position of the GUI within the group and returns its position relative to the screen. Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Declare a new function called <code class="literal">DoMyWindow()</code>
<a id="id544" class="indexterm"></a>; it will handle all window manipulations.</p></li><li><p>Now, it is about time for us to check if these slots are being hovered by mouse.</p></li><li><p>There are two cases where we need to check if those slots are hovered—if we are currently dragging an object and hovering over the slot, or if we are trying to drag out an item from that slot.</p></li><li><p>In the first case, we will assign the current slot to the draggable object—<code class="literal">HoveringSlot</code>. In the second case, we will toggle dragging and make our current slot empty.</p></li><li><p>We will then do the same thing for the armor slot.</p></li><li><p>The next thing we need to do is to get those buttons on the screen.</p></li></ol></div><a id="id545" class="indexterm"></a><p>The completed function in the <code class="literal">CH_Inventory</code> script should be as follows:</p><div class="informalexample"><pre class="programlisting">...
function DoMyWindow(windowID : int){
if (GUI.Button(Rect(windowRect.width - 32, 0, 32, 32), "Close"))
inventoryOpened = false;
ChestSlot.location = GUIUtility.GUIToScreenPoint(Vector2(ChestSlotLoc.x, ChestSlotLoc.y));
RightWeaponSlot.location = GUIUtility.GUIToScreenPoint(Vector2(RightWeaponSlotLoc.x, RightWeaponSlotLoc.y));
LeftArmSlot.location = GUIUtility.GUIToScreenPoint(Vector2(LeftArmSlotLoc.x, LeftArmSlotLoc.y));
HeadSlot.location = GUIUtility.GUIToScreenPoint(Vector2(HeadSlotLoc.x, HeadSlotLoc.y));
BootsSlot.location = GUIUtility.GUIToScreenPoint(Vector2(BootsSlotLoc.x, BootsSlotLoc.y));
ShoulderSlot.location = GUIUtility.GUIToScreenPoint(Vector2(ShoulderSlotLoc.x, ShoulderSlotLoc.y));
ChestSlot.CheckFocus();
RightWeaponSlot.CheckFocus();
LeftArmSlot.CheckFocus();
HeadSlot.CheckFocus();
BootsSlot.CheckFocus();
ShoulderSlot.CheckFocus();
if (ChestSlot.Focused){
    if (dragging){DraggedObject.HoveringSlot = ChestSlot;}
    else if (Event.current.type == EventType.MouseDrag &amp;&amp; ChestSlot.empty == false){
if (!dragging){
            DraggedObject.icon = ChestSlot.icon;
            DraggedObject.Type = ChestSlot.Type;
            DraggedObject.LastSlot = ChestSlot;
            ChestSlot.empty = true;
            ChestSlot.icon = ChestIcon;
                    }
        dragging = true;
    }
}
if (RightWeaponSlot.Focused){
if (dragging){DraggedObject.HoveringSlot = RightWeaponSlot;}
else if (Event.current.type == EventType.MouseDrag &amp;&amp; RightWeaponSlot.empty == false){
if (!dragging){
            DraggedObject.icon = RightWeaponSlot.icon;
            DraggedObject.Type = RightWeaponSlot.Type;
            DraggedObject.LastSlot = RightWeaponSlot;
            RightWeaponSlot.empty = true;
            RightWeaponSlot.icon = RightWeaponIcon;
                }
        dragging = true;
    }
}
if(LeftArmSlot.Focused){
if (dragging){DraggedObject.HoveringSlot = LeftArmSlot;}
else if (Event.current.type == EventType.MouseDrag&amp;&amp; LeftArmSlot.empty == false){
if (!dragging){
            DraggedObject.icon = LeftArmSlot.icon;
            DraggedObject.Type = LeftArmSlot.Type;
            DraggedObject.LastSlot = LeftArmSlot;
            LeftArmSlot.empty = true;
            LeftArmSlot.icon = LeftArmIcon;
                }
        dragging = true;
    }
}
if (HeadSlot.Focused){
if (dragging){DraggedObject.HoveringSlot = HeadSlot;}
else if (Event.current.type == EventType.MouseDrag &amp;&amp; HeadSlot.empty == false){
if (!dragging){
            DraggedObject.icon = HeadSlot.icon;
            DraggedObject.Type = HeadSlot.Type;
            DraggedObject.LastSlot = HeadSlot;
            HeadSlot.empty = true;
            HeadSlot.icon = HeadIcon;
                    }
        dragging = true;
    }
}
if (ShoulderSlot.Focused){
if (dragging){DraggedObject.HoveringSlot = ShoulderSlot;}
else if (Event.current.type == EventType.MouseDrag &amp;&amp; ShoulderSlot.empty == false){
if (!dragging){
            DraggedObject.icon = ShoulderSlot.icon;
            DraggedObject.Type = ShoulderSlot.Type;
            DraggedObject.LastSlot = ShoulderSlot;
            ShoulderSlot.empty = true;
            ShoulderSlot.icon = ShoulderIcon;
            }
        dragging = true;
    }
}
if (BootsSlot.Focused){
if (dragging){DraggedObject.HoveringSlot = BootsSlot;}
else if (Event.current.type == EventType.MouseDrag &amp;&amp; BootsSlot.empty == false){
if (!dragging){
            DraggedObject.icon = BootsSlot.icon;
            DraggedObject.Type = BootsSlot.Type;
            DraggedObject.LastSlot = BootsSlot;
            BootsSlot.empty = true;
            BootsSlot.icon = BootsIcon;
                }
        dragging = true;
    }
}
if(GUI.RepeatButton(ChestSlotLoc,ChestSlot.icon)&amp;&amp;!dragging){}
if(GUI.RepeatButton(RightWeaponSlotLoc,RightWeaponSlot.icon) &amp;&amp;!dragging){}
if(GUI.RepeatButton (LeftArmSlotLoc,LeftArmSlot.icon) &amp;&amp; !dragging){}
if(GUI.RepeatButton (HeadSlotLoc,HeadSlot.icon)&amp;&amp;!dragging){}
if(GUI.RepeatButton (ShoulderSlotLoc,ShoulderSlot.icon)&amp;&amp; !dragging){}
if(GUI.RepeatButton(BootsSlotLoc,BootsSlot.icon)&amp;&amp;!dragging){}</pre></div><p>As you may observe, there are a lot of <code class="literal">if</code> statements.</p><a id="id546" class="indexterm"></a><p>Lastly, we will add a <code class="literal">GUI.Label</code> to display the amount of money that the player has:</p><div class="informalexample"><pre class="programlisting">GUI.Label(Rect(60, 150, 100, 20), "Money: " + Stats.GetMoney());</pre></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec41"></a>Inventory slots</h3></div></div></div><a id="id547" class="indexterm"></a><p>Having done that, we will have two constant slots that are being controlled and supervised. Now, we just need to do the same thing to our inventory slots that will serve as item holders and get them with scrolling bars. Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>We will start with rendering the scrolling bar.</p></li><li><p>At the variable section of the script, declare a new variable called <code class="literal">counter</code> of an <code class="literal">int</code> type, assign it to <code class="literal">0</code> below the last line and declare <code class="literal">scrollPosition</code> of a <code class="literal">Vector2</code> type.</p></li><li><p>Now, we will need to run two <code class="literal">for</code> loops to create rows and columns for our inventory slots.</p><p>The rest of the functionality will be written inside the second <code class="literal">for</code> loop:</p></li><li><p>Now, we need to find the location of each inventory slot and store it inside the previously created <code class="literal">InventorySet</code> array<a id="id548" class="indexterm"></a>. First, we will check if <code class="literal">InventorySlot</code> with a specific index number exists.</p></li><li><p>If <code class="literal">InventorySlot</code> really exists, our next step will be storing its location in the inside <code class="literal">location</code> variable of the specific <code class="literal">InventorySlot</code>. Remember that these slots are located based on window location.</p></li><li><p>If the slot is empty, we will need to assign an icon for it.</p></li><li><a id="id549" class="indexterm"></a><p>And it is about time to check if this slot is being focused by a mouse.</p></li><li><p>Check if the mouse is over this slot and the user is trying to drag the object out of the slot.</p></li><li><p>In the <code class="literal">CH_Inventory</code> script, continue the <code class="literal">DoMyWindow()</code> function as follows:</p><div class="informalexample"><pre class="programlisting">scrollPosition = GUI.BeginScrollView (Rect (0,200,200,100), scrollPosition, Rect (0, 0, 300, 120));
counter = 0;
for (var i : int = 0; i &lt; 10; i ++){
    for(var j: int = 0; j &lt; 4; j++){
        if (InventorySet[counter] != null){
        InventorySet[counter].location = GUIUtility.GUIToScreenPoint(Vector2(30 * i, 30 * j));
            if (InventorySet[counter].empty)
            {InventorySet[counter].icon = EmptySlotTexture;}
        InventorySet[counter].CheckFocus();
        if(InventorySet[counter].Focused == true &amp;&amp; Event.current.type == EventType.MouseDrag &amp;&amp; InventorySet[counter].empty == false){
        if (!dragging){
        DraggedObject.icon = InventorySet[counter].icon;
        DraggedObject.Type = InventorySet[counter].Type;
        DraggedObject.LastSlot = InventorySet[counter];
        InventorySet[counter].empty = true;
        InventorySet[counter].icon = EmptySlotTexture;
        }
        dragging = true;
        DraggedObject.HoveringSlot = InventorySet[counter];
}</pre></div></li></ol></div><p>If the mouse pointer was already dragging something, we would change the hovering object of the dragging object to the current slot. Otherwise, we assign all necessary information to the draggable object and make the slot empty.</p><p>The <code class="literal">i</code> and <code class="literal">j</code> variables will help us to align all slots so they will be located next to each other.</p><p>Another very interesting feature that we can add here is double-clicking. When a user double-clicks a weapon, it will check if a weapon slot is free and will automatically assign a weapon to that slot; or if the user double-clicks on <span class="strong"><strong>MedKit</strong></span> from the inventory, it <a id="id550" class="indexterm"></a>will increase the character's health. Perform the following steps to make it happen:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>We need a couple more variables—<code class="literal">LastClick</code> of a <code class="literal">InventorySlot</code> type that will determine the last clicked slot and <code class="literal">ClickCount</code> of a <code class="literal">int</code> type that will count how many times we clicked on it.</p></li><li><p>To be done with variables, we need to create a reference to the <code class="literal">CH_Controller</code> and <code class="literal">CH_PlayerStats</code> scripts of our character to allow us to modify values in both of them.</p></li><li><p>Declare a <code class="literal">Start</code> function and reference the attached scripts.</p></li><li><p>If that was the first click we made on the slot, it will assign this slot to <code class="literal">LastClick</code> and increase <code class="literal">ClickCount</code>.</p></li><li><p>Otherwise, we will compare the <code class="literal">LastClick</code> location<a id="id551" class="indexterm"></a> and current slot location, and if they are the same, assign an object to a slot it belongs to, or increase our health with <span class="strong"><strong>MedKit</strong></span>.</p></li><li><p>Before we move out of this <code class="literal">else</code> statement, we need to reset <code class="literal">ClickCount</code>.</p></li><li><p>In the end of the <code class="literal">for</code> loop at the bottom, we need to display the actual slot and increment the counter.</p></li><li><p>Scroll view won't close on its own and we need to call the <code class="literal">GUI.EndScrollView</code> function<a id="id552" class="indexterm"></a> to do that.</p></li><li><p>To finish this function, we need to close our scrolling and make the window that we are using as a base for our inventory <code class="literal">draggable</code>. This can be achieved with a <code class="literal">GUI.DragWindow</code> function<a id="id553" class="indexterm"></a> inside the window function. We will also make sure that we can drag a window only if our mouse is holding it by the top.</p></li></ol></div><p>The following code snippet goes into the variable section of the <code class="literal">CH_Inventory</code> script:</p><div class="informalexample"><pre class="programlisting">...
var LastClick : InventorySlot;
var ClickCount : int = 0;
var Stats : CH_PlayerStats;
var Controller : CH_Controller;
function Start(){
Controller = this.gameObject.GetComponent("CH_Controller");
Stats = this.gameObject.GetComponent("CH_PlayerStats");
}
...</pre></div><p>The following code snippet is added after the last <code class="literal">if</code> statement of the <code class="literal">for</code> loop<a id="id554" class="indexterm"></a> at the bottom:</p><div class="informalexample"><pre class="programlisting">...
else if (InventorySet[counter].Focused &amp;&amp; Event.current.type == EventType.MouseDown){
if (ClickCount == 0){
LastClick = InventorySet[counter];
if (!dragging)
ClickCount++;
}
else{
    if(LastClick.location == InventorySet[counter].location &amp;&amp; ClickCount == 1){
switch (InventorySet[counter].Type){
case "RightWeapon":
    if(RightWeaponSlot.empty){
        RightWeaponSlot.empty = false;
        RightWeaponSlot.icon = InventorySet[counter].icon;
        InventorySet[counter].empty = true;
        InventorySet[counter].icon = EmptySlotTexture;
        }
        break;
case "LeftArm":
    if(LeftArmSlot.empty){
        LeftArmSlot.empty = false;
        LeftArmSlot.icon = InventorySet[counter].icon;
        InventorySet[counter].empty = true;
        InventorySet[counter].icon = EmptySlotTexture;
        }
        break;
case "Head":
    if(HeadSlot.empty){
        HeadSlot.empty = false;
        HeadSlot.icon = InventorySet[counter].icon;
        InventorySet[counter].empty = true;
        InventorySet[counter].icon = EmptySlotTexture;
        }
        break;
case "Shoulder":
if(ShoulderSlot.empty){
        ShoulderSlot.empty = false;
        ShoulderSlot.icon = InventorySet[counter].icon;
        InventorySet[counter].empty = true;
        InventorySet[counter].icon = EmptySlotTexture;
        }
        break;
case "Boots":
if(BootsSlot.empty){
        BootsSlot.empty = false;
        BootsSlot.icon = InventorySet[counter].icon;
        InventorySet[counter].empty = true;
        InventorySet[counter].icon = EmptySlotTexture;
        }
        break;
case "Chest":
if(ChestSlot.empty){         ChestSlot.empty = false;
        ChestSlot.icon = InventorySet[counter].icon;
        InventorySet[counter].empty = true;
        InventorySet[counter].icon = EmptySlotTexture;
        }
        break;
case "MedKit":
        Stats.AddHealth(20,1);
        InventorySet[counter].empty = true;
        InventorySet[counter].icon = EmptySlotTexture;
        break;
        }
    }
ClickCount = 0;
}            
}
else if (InventorySet[counter].Focused &amp;&amp; dragging){
DraggedObject.HoveringSlot = InventorySet[counter];
    }
}
if (InventorySet[0] == null)
GUI.Box(Rect (30 * i, 30 * j, 30, 30), GUIContent(EmptySlotTexture));
else
GUI.Box(Rect (30 * i, 30 * j, 30, 30), GUIContent(InventorySet[counter].icon));
counter ++;
    }
}
GUI.EndScrollView ();
GUI.DragWindow ();</pre></div><p>Again, we need to make sure that the array is initialized before we start referencing it; that's why we need those extra <code class="literal">if</code> statements.</p><p>We have finished with the inventory function in the previous section, but not with the script.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec42"></a>Patching the inventory</h3></div></div></div><a id="id555" class="indexterm"></a><a id="id556" class="indexterm"></a><p>Now, we will focus on dropping down objects while dragging them and checking if they have landed in the right slot, or whether they have missed it and need to be returned. Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Return to the <code class="literal">OnGUI</code> function and after the first <code class="literal">if</code> statement, create a new one. But, this time check if we are dragging and releasing the button.</p></li><li><p>We need to explore two cases here if we are focused on our last hovering slot and it is empty, or anything else.</p></li><li><p>In the first <code class="literal">if</code> statement, we need to check if the hovering slot type is the same as the dragged object's, or if it is of a constant type, such as armor or weapon.</p></li><li><p>If that is the case, we will insert that object into the slot and clean the dragging object also, if the object that we dragged was a weapon and we inserted it into the weapon slot, we will equip that weapon.</p></li><li><p>To do this, we will create the <code class="literal">finishingDrag</code> function that will assign properties of the dragged object to the hovering object; or we will return the dragged object to the last slot if dragging isn't successful and we missed positioning the dragged object to the correct slot.</p></li><li><p>If that is not the case, then we simply return this object to where it used to belong.</p></li><li><p>We will have to copy that last <code class="literal">else</code> statement content to the <code class="literal">else</code> statement outside and set <code class="literal">dragging</code> to <code class="literal">false</code>:</p></li></ol></div><p>This is how the <code class="literal">OnGUI</code> function should look at this point:</p><div class="informalexample"><pre class="programlisting">...
if(dragging &amp;&amp; Event.current.type == EventType.MouseUp){
if (DraggedObject.HoveringSlot.Focused &amp;&amp; DraggedObject.HoveringSlot.empty){
if (DraggedObject.HoveringSlot.Type == DraggedObject.Type || DraggedObject.HoveringSlot.ConstType == false){
                switch (DraggedObject.HoveringSlot.Type){
                    case "RightWeapon":
                        Controller.EquipWeapon();
                        break;
                    case "Chest":
                        break;
                    case "Ammo":
                        break;
                    default:
                        break;
                }
            finishingDrag(true);
            }
            else{finishingDrag(false);}
        }
        else{finishingDrag(false);}
dragging = false;
}
function finishingDrag(successful : boolean){
switch (successful){
case true:
    DraggedObject.HoveringSlot.icon = DraggedObject.icon;
    DraggedObject.HoveringSlot.Type = DraggedObject.Type;
    DraggedObject.HoveringSlot.empty = false;
    break;
default:
    DraggedObject.LastSlot.icon = DraggedObject.icon;
    DraggedObject.LastSlot.Type = DraggedObject.Type;
    DraggedObject.LastSlot.empty = false;	
}
    DraggedObject.LastSlot = null;
}<a id="id557" class="indexterm"></a><a id="id558" class="indexterm"></a>
</pre></div></div></div>