<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec24"></a>Creating layer character for the fighting game</h2></div></div><hr /></div><p>In the previous section, we discussed the animation systems of Unity; legacy, and Mecanim. In this section, we will not only discuss, but also practically create, the animation controller for our player character of the fighting game. We will use the free character provided by Unity contained in the <strong class="userinput"><code>Raw Mocap Data</code></strong> asset project.</p><p>First of all, we need a humanoid character in the <strong class="userinput"><code>Scene</code></strong> view. Drag the <strong class="userinput"><code>DefaultAvatar.fbx</code></strong> prefab from the <strong class="userinput"><code>Raw Mocap Data</code></strong> directory in the <strong class="userinput"><code>Project </code></strong>panel to the <strong class="userinput"><code>Hierarchy</code></strong> panel, and it will show a T-Posed character with a black suit on it as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783550777/graphics/image_03_032.png" /></div><p>Figure 3.31 The T-Posed character in the Scene View</p><p>Now, select the <strong class="userinput"><code>DefaultAvatar</code></strong> in the <strong class="userinput"><code>Hierarchy </code></strong>panel, and look at its <strong class="userinput"><code>Inspector</code></strong> settings. There will be a new component added below the <strong class="userinput"><code>Transform</code></strong> component called the <strong class="userinput"><code>Animator</code></strong> component, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783550777/graphics/image_03_033.png" /></div><p>Figure 3.32 Animator component of the character model</p><p>You can observe that an information note is given in the component stating that the controller is not initialized. When any humanoid character is placed for the first time in the scene, Unity creates a default runtime animation controller and assigns it to the character. We can also change or modify its controller anytime with our customized controllers as well. There are multiple properties in the Animator component as shown in the preceding figure. Let's discuss some minor details of these properties before moving further ahead:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><span class="strong"><strong>The Controller</strong></span> property is used to set the animation controller of the Animator component. This is the most important property, and through this controller the whole character's animations are managed and handled in Unity.</li><li><span class="strong"><strong>The Avatar</strong></span> property tells Unity3D about the rigging and avatar configuration to use for the character. This is the same avatar configuration which we set in the previous section of the humanoid character. We can also use some other character's avatar for some other character's animator. That's why Mecanim animation is so powerful and allows developers to retarget their avatar's definitions on other characters without any more efforts.</li></ol></div><p>Now, with the avatar property already set with our configured avatar; let's create our first animation controller. Right-click on the <strong class="userinput"><code>Assets</code></strong> folder, and select <strong class="userinput"><code>Create |</code></strong><strong class="userinput"><code>Animation</code></strong><strong class="userinput"><code>Controller</code></strong> and name it <strong class="userinput"><code>PlayerAnimController,</code></strong> as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783550777/graphics/image_03_034.png" /></div><p>Figure 3.33 Creating an animation controller for the player</p><p>You will notice that a different file will be added in the <strong class="userinput"><code>Project</code></strong> panel in the <strong class="userinput"><code>Assets</code></strong> directory. Double-click on it, and you will be presented with an <strong class="userinput"><code>Animator </code></strong>window showing a state-machine-like user interface, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783550777/graphics/image_03_035.png" /></div><p>Figure 3.34 The Animator panel in Unity3D</p><p>As you can see in this panel, there are three already added states called as <strong class="userinput"><code>Any State, Entry, </code></strong>and<strong class="userinput"><code> Exit </code></strong>respectively. The primary objective of this panel is to organize all the animation clips, here called <span class="strong"><strong>States</strong></span>, and connect these with each other using sequential, parallel, or more complex relationships using a flowchart-like approach. In order to create a simple state-machine, we need at least one animation state in the <strong class="userinput"><code>Animator</code></strong> panel. We already have lots of animations in the project assets imported; we have to just choose a few of those animations for our simple animation controller.</p><p>Now, create a new directory in <strong class="userinput"><code>Assets</code></strong> with the name of <strong class="userinput"><code>Player Animations</code></strong>. I have selected four animation clips from our <strong class="userinput"><code>Raw Mocap Data</code></strong> folder and placed those in our new folder:</p><div class="mediaobject"><img src="/graphics/9781783550777/graphics/image_03_036.png" /></div><p>Figure 3.35 Animation states in the Player Animations directory</p><p>Once your animation clips are all set in a single directory, let's explore these animations in a little more depth. Click on the <strong class="userinput"><code>Idle_Neutral_2</code></strong> animation clip in the <strong class="userinput"><code>Project</code></strong> panel, and select the <strong class="userinput"><code>Rig</code></strong> tab in the <strong class="userinput"><code>Inspector</code></strong>. You will notice that the <strong class="userinput"><code>Animation Type</code></strong> is set to <strong class="userinput"><code>Humanoid</code></strong> and the <strong class="userinput"><code>Avatar</code></strong> definition is set to get copied from another avatar. You must be wondering where the other avatar is. You can select this other avatar in the <strong class="userinput"><code>Source</code></strong> property and click <strong class="userinput"><code>Apply</code></strong> to save the changes. The Source property is set to our configured avatar definition called <strong class="userinput"><code>DefaultAvatarAvatar</code></strong> for our character model. Through this property, you can select any other avatar's definition and retarget the same animation clip on multiple characters very easily. These properties are shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783550777/graphics/image_03_037.png" /></div><p>Figure 3.36 Rig tab of an animation clip</p><p>The <strong class="userinput"><code>Rig</code></strong> tab settings are almost identical for all the animation clips we have got in our project. Now, select the <strong class="userinput"><code>Animations</code></strong> tab to customize the animation according to our own project requirements. The partial <strong class="userinput"><code>Animations </code></strong>tab is shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783550777/graphics/image_03_038.png" /></div><p>Figure 3.37 Partial Animations tab</p><p>If you don't want to import any animation, just toggle off the <strong class="userinput"><code>Import Animation</code></strong> check and Unity will ignore the animation from that clip. The rest of the settings are not important at this moment and we will discuss them later in the book. For now, the most important setting is the <strong class="userinput"><code>Clips</code></strong> property. This is where the whole animation timeline is created. You can observe the <strong class="userinput"><code>Start</code></strong> and <strong class="userinput"><code>End</code></strong> values for the frames of the animation. You can click on the <strong class="userinput"><code>plus (+)</code></strong> sign to add a new sub-animation by defining the start and end frames and Unity will crop that part of the animation in a separate clip. You can experiment with this panel on your own and see what happens on what properties. Also, you can observe a small preview window which allows you to play and stop the customized animation.</p><p>Currently, we have only one clip in the <strong class="userinput"><code>Clips</code></strong> list and that is selected by default. Below the <strong class="userinput"><code>Clips</code></strong> property, Unity is showing you more details of this particular clip, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783550777/graphics/image_03_039.png" /></div><p>Figure 3.38 More properties of any selected sub-animation clip</p><p>You can observe a lot of options here. We won't discuss all of these in much detail, but we will get an overview of this panel here. There are various sections such as <strong class="userinput"><code>Loop Time</code></strong>, <strong class="userinput"><code>Root Transform Rotation</code></strong> , and so on. These sections define that specific part of the animation. For example, <strong class="userinput"><code>Loop Time</code></strong> defines whether the animation as a whole is a loop animation or not. Before every section, there is a color circle with red, yellow, or green fill. This circle tells us about the loop match state of the animation. Red means it's not a loop, yellow means it's somewhat a loop but is not perfectly synced, and green means that it is a perfect loop. These properties allow developers to define the animations in a very detailed way to manage the <code class="literal">Y</code>Â axis position of the character when animating and so on. You can alter the <strong class="userinput"><code>Start</code></strong> and <strong class="userinput"><code>End</code></strong> values to see where exactly the animation is a perfect loop with all of the green circles and customize it accordingly.</p><p>Finally, after discussing many details and properties about animation clips, let's move on to create our simple animation controller. Double-click on the <strong class="userinput"><code>PlayerAnimController</code></strong> file from <strong class="userinput"><code>Assets</code></strong> directory. It will show the <strong class="userinput"><code>Animator</code></strong> view with three states as we discussed earlier. Now, follow these steps to create a walk cycle animation state-machine:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Drag the <strong class="userinput"><code>Idle_Neutral_2</code></strong> animation clip from the <strong class="userinput"><code>Player Animations</code></strong> directory to the <strong class="userinput"><code>Animator</code></strong> view. You will see a new orange rectangle added with the animation clip name. This rectangle shows this animation clip state. This is shown in the following figure:</li></ol></div><div class="mediaobject"><img src="/graphics/9781783550777/graphics/image_03_040.png" /></div><p>Figure 3.39 New animation added in the Animator view</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note39"></a>Note</h3><p>Any animation can be set as the default animation by right-clicking on it and selecting <strong class="userinput"><code>Set as Default Layer State</code></strong> from the menu. Unity will change its color to orange. There can be only one default state in any single layer.</p></div><p>Now, if you play the game, you will see that character in the scene is not animating. Although we have set its default animation state to the idle animation, still the character is not moving. It is because we have only created Animation Controller, but still we have to link the controller with our character:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">To link our character with the newly created animation controller, select the character from the <strong class="userinput"><code>Hierarchy</code></strong> panel. Now, drag our <strong class="userinput"><code>PlayerAnimController</code></strong> from <strong class="userinput"><code>Assets</code></strong> to the <strong class="userinput"><code>Controller</code></strong> property of the <strong class="userinput"><code>Animator</code></strong> component in the <strong class="userinput"><code>Inspector,</code></strong> as shown in the following figure:</li></ul></div><div class="mediaobject"><img src="/graphics/9781783550777/graphics/image_03_041.png" /></div><p>Figure 3.40 Linking character with animation controller</p><p>Now, play the game and you will see that character is following the idle animation. But, once the animation is finished, it will stop there. We want to loop the animation infinitely in our case.</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">To set the animation loop, select the <strong class="userinput"><code>Idle_Neutral_2</code></strong> from the <strong class="userinput"><code>Player Animations</code></strong> directory, and go to the <strong class="userinput"><code>Animations</code></strong> tab in the <strong class="userinput"><code>Inspector</code></strong> settings. Below <strong class="userinput"><code>Clips</code></strong>, we have to first set the animation as a perfect loop and make all the circles green. So, set the value of <strong class="userinput"><code>Start</code></strong> to 265, and it will turn into green. Also, toggle the <strong class="userinput"><code>Loop Time</code></strong> check to on and click <strong class="userinput"><code>Apply</code></strong>. Now, play the game and your character will be continuously repeating the animation once it ends. Also, you won't be able to observe the end of the animation, because a perfect loop is created in the animation. This is shown in the following figure:</li></ul></div><div class="mediaobject"><img src="/graphics/9781783550777/graphics/image_03_042.png" /></div><p>Figure 3.41 Setting animation to loop</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Now let's add another animation state of walk into it. As we did earlier, drag <strong class="userinput"><code>WalkFWD</code></strong> from <strong class="userinput"><code>Assets</code></strong> to the <strong class="userinput"><code>Animator</code></strong> view. It will create another rectangle state, this time with a gray color. This animation state is added in the controller, but it is not linked with the animator. To link this state with our default <strong class="userinput"><code>Idle</code></strong> state, right click on the <strong class="userinput"><code>Idle_Neutral_2</code></strong> state, and select <strong class="userinput"><code>Make Transition</code></strong>. It will allow you to create a white line from the Idle state to another state. Now, click on the <strong class="userinput"><code>WalkFWD</code></strong> state and a line will be drawn between Idle and the <strong class="userinput"><code>WalkFWD</code></strong> state with an arrow towards the <strong class="userinput"><code>WalkFWD</code></strong> state. This is shown in the following figure:</li></ul></div><div class="mediaobject"><img src="/graphics/9781783550777/graphics/image_03_043.png" /></div><p>Figure 3.42 Creating transition between two states</p><p>Now, play the game and you will observe that once the idle animation is finished, it will start the <strong class="userinput"><code>WalkFWD</code></strong> animation. After the walk animation, it will be stopped. We can also create another transition from <strong class="userinput"><code>WalkFWD</code></strong> to the <strong class="userinput"><code>Idle_Nuetral_2</code></strong> state and this will make the character continuously animate. Once the idle animation is finished, it will start walking, and once the walking is finished it will go back to the idle animation and this will be running continuously resulting in a looped animation.</p><p>Now, it's time to add some control in the animator. In the <strong class="userinput"><code>Animator</code></strong> panel, on the left side, there are two tabs: <strong class="userinput"><code>Layers</code></strong> and <strong class="userinput"><code>Parameters</code></strong>. Click on the <strong class="userinput"><code>Parameters</code></strong> tab, and click the on <strong class="userinput"><code>Plus (+)</code></strong> button to add a new parameter. It will show you a dropdown of which type of parameter we want to add. Select <strong class="userinput"><code>Bool</code></strong> from it and name it to <strong class="userinput"><code>ShouldWalk</code></strong>. This is shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783550777/graphics/image_03_044.png" /></div><p>Figure 3.43 Adding a new parameter in Animator</p><p>Now, you will see a new parameter is added in the <strong class="userinput"><code>Parameters</code></strong> list. The parameters allow developers to control the animation and states flow based on their values. At this moment, the walk animation is automatically started after completion of the idle animation. Now, we will integrate this <strong class="userinput"><code>ShouldWalk</code></strong> parameter with the animator so that the walking animation will start if the <strong class="userinput"><code>ShouldWalk</code></strong> parameter is true; otherwise, it will go back to the idle state:</p><p>To do this, click on the transition arrow of Idle to Walk and check the <strong class="userinput"><code>Inspector </code></strong>panel. You will see various settings there. At the end, you will see a small view of <strong class="userinput"><code>Conditions</code></strong>. Click on the <strong class="userinput"><code>Plus(+)</code></strong> icon from there, and set <strong class="userinput"><code>ShouldWalk</code></strong> to true. This is shown in the following figure:</p><div class="mediaobject"><img src="/graphics/9781783550777/graphics/image_03_045.png" /></div><p>Figure 3.44 Adding a condition on transition</p><p>Similarly, now repeat the same process for other reverse transitions as well but this time set the <strong class="userinput"><code>ShouldWalk</code></strong> value to false. Now play the game, and you will observe that the character is not going to the walk animation and it is continuously repeating the same idle animation over and over again. It will play the walk animation if the <strong class="userinput"><code>ShouldWalk</code></strong> parameter is set to <code class="literal">true</code>. This can be done from the code very easily.</p></div>