<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch26lvl1sec235"></a>Avoid retrieving string properties from GameObjects</h2></div></div><hr /></div><p>Ordinarily, retrieving a string property from an object is the same as retrieving any other reference type property in C#; it is acquired with no additional memory cost. However, for whatever arcane reason hidden within the Unity source code, retrieving string properties from GameObjects duplicates the string in memory and results in a heap allocation. This draws the attention of the Garbage Collector, which, if we are not careful, can cause <a id="id1310" class="indexterm"></a>CPU spikes that will affect performance during runtime.</p><p>The two properties of <a id="id1311" class="indexterm"></a>GameObject affected by this strange behavior are <code class="literal">tag</code> and <code class="literal">name</code>. Retrieving either of these properties for any reason will cause unnecessary heap allocations. Therefore, it is unwise to use either property during gameplay, and you should only use them in <span class="emphasis"><em>performance-inconsequential</em></span> areas such as Editor Scripts. However, the Tag system is commonly used for runtime identification purposes, which can make this a significant problem for some teams.</p><p>For example, the following code would cause an additional heap memory allocation during every iteration of the loop:</p><div class="informalexample"><pre class="programlisting">for (int i = 0; i &lt; listOfObjects.Count; ++i) {
  if (listOfObjects[i].tag == "Player") {
    // do something with this object
  }
}</pre></div><p>It is often better practice to identify objects by their Components, class types, and identifying values that do not involve strings, but sometimes we're forced into a corner. Maybe we didn't know any better when we started, we inherited someone else's codebase, or we're using it as a workaround for something. Let's assume that, for whatever reason, we're stuck with the Tag system, and we want to avoid these heap allocations.</p><p>Fortunately, the <code class="literal">tag</code> property<a id="id1312" class="indexterm"></a> is most often used in comparison situations, and GameObject provides an alternative way to compare <code class="literal">tag</code> properties, which does <a id="id1313" class="indexterm"></a>not cause a heap allocationâ€”the <code class="literal">CompareTag()</code> method.</p><p>Let's perform a simple test to prove how this simple change can make all the difference in the world:</p><div class="informalexample"><pre class="programlisting">void Update() {
  int numTests = 10000000;
  if (Input.GetKeyDown(KeyCode.Alpha1)) {
    for(int i = 0; i &lt; numTests; ++i) {
      if (gameObject.tag == "Player") {
        // do stuff
      }
    }
  }

  if (Input.GetKeyDown(KeyCode.Alpha2)) {
    for(int i = 0; i &lt; numTests; ++i) {
      if (gameObject.CompareTag ("Player")) {
        // do stuff
      }
    }
  }
}</pre></div><p>We can execute these tests by pressing the <span class="emphasis"><em>1</em></span> and <span class="emphasis"><em>2</em></span> keys to trigger the respective <code class="literal">for</code> loop. Here are the results:</p><div class="mediaobject"><img src="/graphics/9781787127272/graphics/4939_02_08.jpg" /></div><p>Looking at the<a id="id1314" class="indexterm"></a> Breakdown view for each spike, we can see two completely<a id="id1315" class="indexterm"></a> different situations:</p><div class="mediaobject"><img src="/graphics/9781787127272/graphics/4939_02_09.jpg" /></div><p>Retrieving the <code class="literal">tag</code> property 10 million times results in about 363 MB of memory being allocated just for strings alone. This takes 2435 milliseconds to process, where 488 milliseconds are spent on garbage collection. Meanwhile, using <code class="literal">CompareTag()</code> 10 million times costs 1788 milliseconds to process, and causes no heap memory allocations, and hence no Garbage Collection. This should make it abundantly clear that we must avoid using the <code class="literal">name</code> and <code class="literal">tag</code> properties. So, if Tag comparison becomes necessary, then we should make use of <code class="literal">CompareTag()</code>.</p><p>Note that passing in a string literal like <code class="literal">"Player"</code> does not result in a runtime heap allocation, since the application technically allocates this value during initialization and merely references it at runtime. However, if we dynamically generate the comparison string, then we will run into the same heap memory allocation problems, because we're essentially creating a<a id="id1316" class="indexterm"></a>  new string object each time.</p><p>You will learn more<a id="id1317" class="indexterm"></a> nuances about the Garbage Collector and string usage in <a class="link" href="#" linkend="ch31">Chapter 7</a>, <span class="emphasis"><em>Masterful Memory Management</em></span>.</p></div>