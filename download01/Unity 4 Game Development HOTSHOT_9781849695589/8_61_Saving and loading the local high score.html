<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec65"></a>Saving and loading the local high score</h2></div></div><hr /></div><p>In this section, we will be creating the <code class="literal">LocalHiscore</code> script, which we <a id="id1231" class="indexterm"></a>will use to save and load the users' data. We will <a id="id1232" class="indexterm"></a>use <code class="literal">PlayerPrefs</code>, <code class="literal">BinaryFormatter</code>, and <code class="literal">MemoryStream</code> to save and load the user data. Then, we will add the ability to save and load the local high score to our <code class="literal">UIHiscore</code> script.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec142"></a>Engage thrusters</h3></div></div></div><p>Now we can start<a id="id1233" class="indexterm"></a> creating the <code class="literal">LocalHiscore</code> script using the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Navigate to <span class="strong"><strong>Chapter8</strong></span> | <span class="strong"><strong>Scripts</strong></span> | <span class="strong"><strong>C#/Hiscore</strong></span> (for C# users) or <span class="strong"><strong>Chapter8</strong></span> | <span class="strong"><strong>Scripts</strong></span> | <span class="strong"><strong>Javascript</strong></span> | <span class="strong"><strong>Hiscore</strong></span> (for Unity JavaScript users), right-click and navigate to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>C# Script</strong></span> (for C# users) or <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Javascript</strong></span>, and name it <code class="literal">LocalHiscore</code>.</p></li><li><p>First, we will create a random name for the default user and the <code class="literal">SaveUserData()</code> function to save the user data. Let's double-click on the <code class="literal">LocalHiscore</code> script that we just created and use the following code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>// Unity JavaScript user: </strong></span>

#pragma strict
import System;
import System.Runtime.Serialization.Formatters.Binary;
import System.IO;
import System.Collections.Generic;

class LocalHiscore extends Hiscore {
  private var RANDOM_NAMES : String[] = ["Antony", "John", "Will", "Kate", "Jill"];

  override function SaveUserData ( user : UserData ) {
    _users.Add(user);
    var binary : BinaryFormatter = new BinaryFormatter();
    var memory : MemoryStream = new MemoryStream();
    binary.Serialize(memory, _users);
    PlayerPrefs.SetString(_hashKey+"Highscore",Convert.ToBase64String(memory.GetBuffer()));
  }
}


<span class="strong"><strong>// C# user:</strong></span>

using UnityEngine;
using System;
using System.Runtime.Serialization.Formatters.Binary;
using System.IO;
using System.Collections;
using System.Collections.Generic;

public class LocalHiscore : Hiscore {
  private string[] RANDOM_NAMES = new string[] {"Antony", "John", "Will", "Kate", "Jill"};

  public override void SaveUserData ( UserData user ) {
    _users.Add(user);
    BinaryFormatter binary = new BinaryFormatter();
    MemoryStream memory = new MemoryStream();
    binary.Serialize(memory, _users);
    PlayerPrefs.SetString(_hashKey+"Highscore",Convert.ToBase64String(memory.GetBuffer()));
  }
}</pre></div><p>We created the save function by first adding the new user to the list, and then we created <code class="literal">BinaryFormatter</code> to serialize all users data to <code class="literal">MemoryStream</code>. Finally, we <a id="id1234" class="indexterm"></a>saved the users data by<a id="id1235" class="indexterm"></a> converting it to a string and saving it in <code class="literal">PlayerPrefs</code>.</p></li><li><p>Next, add two more functions—<code class="literal">Initialize()</code> and <code class="literal">LoadUserData()</code>—to set and load the user data. Let's add both the methods as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>// Unity JavaScript user: </strong></span>

…  
override function Initialize ( maxUser : int ) {
  super.Initialize(maxUser);
  LoadUserData();
}

override function LoadUserData () {
  super.LoadUserData();
  var data : String PlayerPrefs.GetString(_hashKey+"Highscore");

  if (data != "") {
    var binary : BinaryFormatter = new BinaryFormatter();
    var memory : MemoryStream = new MemoryStream(Convert.FromBase64String(data));
    _users = binary.Deserialize(memory) as List.&lt;UserData&gt;;
  } else {
    for (var i : int = 0 ; i &lt; RANDOM_NAMES.Length; ++i) {
      var user : UserData = new UserData();
      user.name = RANDOM_NAMES[i];
      user.score = Mathf.FloorToInt(UnityEngine.Random.value * 1000);
      _users.Add(user);
    }
  }
  this.SortByScore();
}
…


<span class="strong"><strong>// C# user:</strong></span>

…
public override void Initialize ( int maxUser ) {
  base.Initialize(maxUser);
  LoadUserData();
}
public override void LoadUserData () {
  base.LoadUserData();
  string data = PlayerPrefs.GetString(_hashKey+"Highscore");
  if (data != "") {
    BinaryFormatter binary = new BinaryFormatter();
    MemoryStream memory = new MemoryStream(Convert.FromBase64String(data));
    _users = binary.Deserialize(memory) as List&lt;UserData&gt;;
  } else {
    for (int i = 0 ; i &lt; RANDOM_NAMES.Length; ++i) {
      UserData user = new UserData();
      user.name = RANDOM_NAMES[i];
      user.score = Mathf.FloorToInt(UnityEngine.Random.value * 1000);
      _users.Add(user);
    }
  }
  this.SortByScore();
}</pre></div><p>We just created the function to load the string data using <code class="literal">PlayerPrefs.GetString (key,"")</code> from the key. We also checked that it was not an empty string. Then, we deserialized the data by first converting it from string to the byte array using <code class="literal">MemoryStream</code>, and then we used <code class="literal">BinaryFormatter</code> to deserialize the data to <code class="literal">List&lt;UserData&gt;</code>.</p></li><li><p>Next, we will go to the <code class="literal">UIHiscore</code> script to <a id="id1236" class="indexterm"></a>add the script to initialize the local hi-score table, as shown in the following<a id="id1237" class="indexterm"></a> highlighted code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>// Unity JavaScript user: </strong></span>
…
private var _user : UserData;
<span class="strong"><strong>private var _localHiscore : LocalHiscore;</strong></span>
<span class="strong"><strong>private var _scrollLocal : Vector2 = Vector2.zero;</strong></span>
…
<span class="strong"><strong>function Awake () {</strong></span>
<span class="strong"><strong>  _localHiscore = GetComponent.&lt;LocalHiscore&gt;();</strong></span>
<span class="strong"><strong>  if (_localHiscore == null) {</strong></span>
<span class="strong"><strong>    _localHiscore = gameObject.AddComponent.&lt;LocalHiscore&gt;();</strong></span>
<span class="strong"><strong>  }</strong></span>
<span class="strong"><strong>}</strong></span>
function Start () {
  …
<span class="strong"><strong>  _localHiscore.Initialize(maxUser);</strong></span>
}


<span class="strong"><strong>// C# user:</strong></span>
…
UserData _user;
<span class="strong"><strong>LocalHiscore _localHiscore;</strong></span>
<span class="strong"><strong>Vector2 _scrollLocal = Vector2.zero;</strong></span>
…
<span class="strong"><strong>void Awake () {</strong></span>
<span class="strong"><strong>  _localHiscore = GetComponent&lt;LocalHiscore&gt;();</strong></span>
<span class="strong"><strong>  if (_localHiscore == null) {</strong></span>
<span class="strong"><strong>    _localHiscore = gameObject.AddComponent&lt;LocalHiscore&gt;();</strong></span>
<span class="strong"><strong>  }</strong></span>
<span class="strong"><strong>}</strong></span>
void Start () {
   …
<span class="strong"><strong>   _localHiscore.Initialize(maxUser);</strong></span>
}</pre></div></li><li><p>Next, we will go to the <code class="literal">Gameover()</code> function to add the load and save data<a id="id1238" class="indexterm"></a> functions when the user clicks the button, as<a id="id1239" class="indexterm"></a> shown in the following highlighted code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>// Unity JavaScript user: </strong></span>
…
private function Gameover ()
{
  …
  if (_clickSubmit == false) {
    …
    if (GUI.Button(_buttonRect1, "SUBMIT")) {
       …
       _user.score = HitPoint.CURRENT_SCORE;
       <span class="strong"><strong>_localHiscore.SaveUserData(_user);</strong></span>
    }
  }
  if (GUI.Button(_buttonRect2, "LOCAL HI-SCORE")) {
  // Load
<span class="strong"><strong>    _localHiscore.LoadUserData();</strong></span>
<span class="strong"><strong>    </strong></span>_page = PAGE.LOCALSCORE;
  }
…
}


<span class="strong"><strong>// C# user:</strong></span>
…
void Gameover ()
{
   …
  if (_clickSubmit == false) {
    …
    if (GUI.Button(_buttonRect1, "SUBMIT")) {
       …
       _user.score = HitPoint.CURRENT_SCORE;
       <span class="strong"><strong>_localHiscore.SaveUserData(_user);</strong></span>
    }
  }
  if (GUI.Button(_buttonRect2, "LOCAL HI-SCORE")) {
  // Load
<span class="strong"><strong>    _localHiscore.LoadUserData();</strong></span>
<span class="strong"><strong>    </strong></span>_page = PAGE.LOCALSCORE;
  }
…
}</pre></div></li><li><p>Finally, we will go to the <code class="literal">LocalHiscore()</code> function to add the code to show the<a id="id1240" class="indexterm"></a> high-score table data, as shown in the<a id="id1241" class="indexterm"></a> following highlighted code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>// Unity JavaScript user: </strong></span>
…
private function LocalHiscore ()
{
  CreateBackgroundBox("LOCAL HI-SCORE");
<span class="strong"><strong>  if (_localHiscore.userLength &gt; 0) {</strong></span>
<span class="strong"><strong>    _scrollLocal = GUI.BeginScrollView (new Rect ((Screen.width - 320)*0.5f, (Screen.height*0.1f) + 80, 320, 180), _scrollLocal, new Rect (0, 0, 300, 30*_localHiscore.userLength));</strong></span>
<span class="strong"><strong>    for (var i : int = 0; i &lt; _localHiscore.userLength; i++) {</strong></span>
<span class="strong"><strong>      GUILayout.BeginHorizontal(GUILayout.Width(300));</strong></span>
<span class="strong"><strong>      GUILayout.Label((i+1).ToString() + ". " + _localHiscore.GetUserDataAt(i).name, GUI.skin.GetStyle("Name"));</strong></span>
<span class="strong"><strong>      GUILayout.Label(_localHiscore.GetUserDataAt(i).score.AddCommas(), GUI.skin.GetStyle("Score"));</strong></span>
<span class="strong"><strong>      GUILayout.EndHorizontal();</strong></span>
<span class="strong"><strong>    }</strong></span>
<span class="strong"><strong>    GUI.EndScrollView();</strong></span>
<span class="strong"><strong>  }</strong></span>
…
}


<span class="strong"><strong>// C# user:</strong></span>
…
void LocalHiscore ()
{
  CreateBackgroundBox("LOCAL HI-SCORE");
<span class="strong"><strong>  if (_localHiscore.userLength &gt; 0) {</strong></span>
<span class="strong"><strong>    _scrollLocal = GUI.BeginScrollView (new Rect ((Screen.width - 320)*0.5f, (Screen.height*0.1f) + 80, 320, 180), _scrollLocal, new Rect (0, 0, 300, 30*_localHiscore.userLength));</strong></span>
<span class="strong"><strong>    for (int i = 0; i &lt; _localHiscore.userLength; i++) {</strong></span>
<span class="strong"><strong>      GUILayout.BeginHorizontal(GUILayout.Width(300));</strong></span>
<span class="strong"><strong>      GUILayout.Label((i+1).ToString() + ". " + _localHiscore.GetUserDataAt(i).name, GUI.skin.GetStyle("Name"));</strong></span>
<span class="strong"><strong>      GUILayout.Label(_localHiscore.GetUserDataAt(i).score.AddCommas(), GUI.skin.GetStyle("Score"));</strong></span>
<span class="strong"><strong>      GUILayout.EndHorizontal();</strong></span>
<span class="strong"><strong>    }</strong></span>
<span class="strong"><strong>    GUI.EndScrollView();</strong></span>
<span class="strong"><strong>  }</strong></span>
   … 
}</pre></div><p>We just created<a id="id1242" class="indexterm"></a> the scroll view for our local high-score table. Now, we have finished this step, we<a id="id1243" class="indexterm"></a> can click on the <span class="strong"><strong>Play</strong></span> button to see the result. Have a look at the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849695589/graphics/5589OT_08_06.jpg" /></div></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec143"></a>Objective complete – mini debriefing</h3></div></div></div><p>In this step, we basically created <code class="literal">LocalHiscore</code> to save and load the user's local high-score data and displayed it on the <span class="strong"><strong>LOCAL HI-SCORE</strong></span> page. The <code class="literal">LocalHiscore</code> class is derived from the <code class="literal">Hiscore</code> class, which we already created. In this class, we added the <code class="literal">Initialize()</code>, <code class="literal">LoadUserData()</code>, and <code class="literal">SaveUserData()</code> methods, which is overridden from the <code class="literal">Hiscore</code> base class. Using the <code class="literal">virtual</code> and <code class="literal">override</code> keywords, we will be able to share the method and variables from the <code class="literal">Hiscore</code> class.</p><p>In the <code class="literal">SaveUserData()</code> function, we first <a id="id1244" class="indexterm"></a>passed the user data that we'd like to save. Then, we added the user data to the list of <code class="literal">UserData</code>, which is <code class="literal">_users.Add(user);</code>. Next, we created <code class="literal">BinaryFormatter</code> and <code class="literal">MemoryStream</code> to serialize the list of <code class="literal">UserData</code> to the series of bits to the memory buffer using <code class="literal">binary.Serialize(memory, _users);</code>. Next, we used <code class="literal">PlayerPrefs</code> to save the data by first converting the string using <code class="literal">Convert.ToBase64String(memory.GetBuffer());</code>. Then, we used <code class="literal">PlayerPrefs.SetString()</code> to set the data by passing the key, which is <code class="literal">_hashkey + "Highscore"</code>, and the converting string data.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note87"></a>Note</h3><p>We need to convert our data to a string first. This is because <code class="literal">PlayerPrefs</code> can only save <code class="literal">string</code>, <code class="literal">int</code>, or <code class="literal">float</code> and not the bytes array. We can check the following link for more details: <a class="ulink" href="http://docs.unity3d.com/Documentation/ScriptReference/PlayerPrefs.html" target="_blank">http://docs.unity3d.com/Documentation/ScriptReference/PlayerPrefs.html</a>.</p></div><p>Next, we created <code class="literal">Initialize()</code> and <code class="literal">LoadUserData()</code> to set up and load the default user data if there is no local user data. In the first line, we called <code class="literal">base.Initialize()</code> (for C# users) and <code class="literal">super.Initialize()</code> (for Unity JavaScript users). This basically calls the <code class="literal">Initialize()</code> method from the base class, which is the <code class="literal">Hiscore</code> class to set the maximum users that should be shown on the high-score table.</p><p>In the <code class="literal">LoadUserData()</code> method, we first checked whether the local user data exists or not using <code class="literal">string data = PlayerPrefs.GetString(_hashkey+"Highscore", "");</code>. Then, we checked to see whether the return string isn't equal to an empty string. We converted it back to the memory buffer and deserialized it to the list of <code class="literal">UserData</code>. On the other hand, if the data was an empty string, we added the random user to the list of <code class="literal">UserData</code>. Then, we sorted the list based on the score of each user.</p><p>Finally, we added the <a id="id1245" class="indexterm"></a>script to the <code class="literal">UIHiscore</code> class to save, load, and show the local high score from the list of <code class="literal">UserData</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec144"></a>Classified intel</h3></div></div></div><p>In Unity C#, we used <code class="literal">[System.Serializable]</code> to<a id="id1246" class="indexterm"></a> enable the ability to serialize this object. <span class="strong"><strong>Serialization</strong></span> is the<a id="id1247" class="indexterm"></a> process of translating the data structure or object state in the format that can easily be stored (for example, a file/memory buffer, or transmitted data across a network connection link) and reconstructed later in the same or another computer environment.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note88"></a>Note</h3><p>More explanation about serialization can be found from the following links: </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<a class="ulink" href="http://stackoverflow.com/questions/3042665/what-is-the-meaning-of-serialization-concept-in-programming-languages" target="_blank">http://stackoverflow.com/questions/3042665/what-is-the-meaning-of-serialization-concept-in-programming-languages</a> </p></li><li style="list-style-type: disc"><p>
<a class="ulink" href="http://en.wikipedia.org/wiki/Serialization" target="_blank">http://en.wikipedia.org/wiki/Serialization</a>
</p></li></ul></div></div><p>Whether you add <code class="literal">@script System.Serializable</code> in the class or not, we will be able to serialize them.</p><p>The serialization technique can be stored as a file and saved on your local machine too. This is a very efficient way to save the game data, such as a player's hit point, player's location, and enemies' hit point. To store the data to the file, we can add something similar to the following code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>// Unity JavaScript user: </strong></span>

function SaveData () {
  var binary : BinaryFormatter = new BinaryFormatter();
  var file : FileStream = new FileStream(Application.persistentDataPath+"/highscores.dat", FileMode.Append);
  binary.Serialize(file, _users);
}
function LoadData () {
  try {  
    var binary : BinaryFormatter = new BinaryFormatter();
    var file : FileStream = new FileStream(Application.persistentDataPath+"/highscoresJS.dat", FileMode.Open);
    _users = binary.Deserialize(file) as List.&lt;UserData&gt;; 
  }  catch (error)  {
    Debug.Log("File not found");
  }
}


<span class="strong"><strong>// C# user:</strong></span>

public void SaveData () {
  BinaryFormatter binary = new BinaryFormatter();
  FileStream file = new FileStream(Application.persistentDataPath+"/highscores.dat", FileMode.Append);
  binary.Serialize(file, _users);
}
public void LoadData () {
  try {  
    BinaryFormatter binary = new BinaryFormatter();
    FileStream file = new FileStream(Application.persistentDataPath+"/highscores.dat", FileMode.Open);
    _users = binary.Deserialize(file) as List&lt;UserData&gt;; 
  } catch (System.IO.FileNotFoundException) {
    Debug.Log("File not found");
  }
}</pre></div><p>Next, we will talk about <code class="literal">PlayerPrefs</code>, which is basically used to save and load the data using the key string to identify each piece of data. The values that we can set or get are <code class="literal">string</code>, <code class="literal">float</code>, and <code class="literal">int</code>. We will <a id="id1248" class="indexterm"></a>use <code class="literal">PlayerPrefs.SetString(Key,Value)</code>, <code class="literal">PlayerPrefs.SetFloat(Key,Value)</code>, and <code class="literal">PlayerPrefs.SetInt(Key,Value)</code> to store the data. These methods will set each value based on the key string and save them to the local machine when the user quits the application. However, we might want to write the data after setting the value. In this case, we will use the <code class="literal">PlayerPrefs.Save()</code> function to write the data at the time we call this method.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip40"></a>Tip</h3><p>It's not recommend that you call <code class="literal">PlayerPrefs.Save()</code> during the actual gameplay, because it will<a id="id1249" class="indexterm"></a> write the data to the disk and cause small hiccups. More details can be found at <a class="ulink" href="http://docs.unity3d.com/Documentation/ScriptReference/PlayerPrefs.Save.html" target="_blank">http://docs.unity3d.com/Documentation/ScriptReference/PlayerPrefs.Save.html</a>.</p></div><p>We use <code class="literal">PlayerPrefs.GetString(Key,DefaultValue="")</code>, <code class="literal">PlayerPrefs.GetFloat(Key,DefaultValue=0.0f)</code>, and <code class="literal">PlayerPrefs.GetInt(Key,DefaultValue=0)</code> to load the data. These methods will get the data value from the given key string. If the key cannot be found, it will return the default value depending on the individual function. We can also use <code class="literal">PlayerPrefs.HasKey(Key)</code> to check if the key exists or not. At last, if we want to remove the key data, we can use <code class="literal">PlayerPrefs.Delete(Key)</code> to remove the specific key. Also, if we want to remove all the keys, we can use <code class="literal">PlayerPrefs.DeleteAll()</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note89"></a>Note</h3><p>For more details on<a id="id1250" class="indexterm"></a> <code class="literal">PlayerPrefs</code>, visit <a class="ulink" href="http://docs.unity3d.com/Documentation/ScriptReference/PlayerPrefs.html" target="_blank">http://docs.unity3d.com/Documentation/ScriptReference/PlayerPrefs.html</a>.</p></div></div></div>