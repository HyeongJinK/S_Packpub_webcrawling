<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch01lvl1sec16"></a>Controlling the character with the PlayerController_2D class</h2></div></div><hr /></div><p>In this <a id="id121" class="indexterm"></a>section, we will create a new <a id="id122" class="indexterm"></a>script to control the<a id="id123" class="indexterm"></a> movement of our character and a sprite animation for each action of our character. We will use MonoDevelop<a id="id124" class="indexterm"></a> as our scripting editor, which comes with Unity. MonoDevelop is mainly designed for the C# and .NET environments, so if you are comfortable with <a id="id125" class="indexterm"></a>C#, you will probably love it. However, if you use<a id="id126" class="indexterm"></a> <span class="strong"><strong>Unity JavaScript</strong></span>, it also has many tools to help us write the script faster and debug better, such as finding as well as replacing words in the whole project by pressing <span class="emphasis"><em>command</em></span> + <span class="emphasis"><em>Shift</em></span> + <span class="emphasis"><em>F</em></span> in Mac or <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>Shift</em></span> + <span class="emphasis"><em>F</em></span> in Windows and autocomplete (or Intellisense), to name a few. Moving from Unity JavaScript to C# or C# to Unity JavaScript is also a comparatively smooth transition.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note06"></a>Note</h3><p>In this version of this book, we will show examples for both Unity JavaScript and C#. You can check out the major difference between Unity JavaScript and C# in the <a class="link" href="#" linkend="appC">Appendix C</a>, <span class="emphasis"><em>Major differences Between C# and Unity JavaScript</em></span>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec27"></a>Prepare for lift off</h3></div></div></div><p>Now, we are just about to<a id="id127" class="indexterm"></a> start coding, but first let's<a id="id128" class="indexterm"></a> make sure that we have <a id="id129" class="indexterm"></a>everything ready:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Next, we want to make sure that Unity uses MonoDevelop as our main Scripting editor (<span class="strong"><strong>Unity</strong></span> | <span class="strong"><strong>Preferences</strong></span> in Mac or <span class="strong"><strong>Edit</strong></span> | <span class="strong"><strong>Preferences</strong></span> in Windows).</p></li><li><p>We will see a <span class="strong"><strong>Unity Preferences</strong></span> window. In the <span class="strong"><strong>External Tools</strong></span> tab, go to the <span class="strong"><strong>External Script Editor</strong></span> and make sure that the <span class="strong"><strong>MonoDevelop</strong></span> option is selected. Click on <span class="strong"><strong>Browse…</strong></span>, go to <span class="strong"><strong>Applications</strong></span> | <span class="strong"><strong>Unity</strong></span> | <span class="strong"><strong>MonoDevelop.app</strong></span> in Mac or <span class="strong"><strong>{unity install path}</strong></span> |<span class="strong"><strong> Unity</strong></span> | <span class="strong"><strong>MonoDevelop</strong></span> | <span class="strong"><strong>MonoDevelop.exe</strong></span> in Windows, and we are done:</p><div class="mediaobject"><img src="/graphics/9781849695589/graphics/5589_01_35.jpg" /></div></li></ol></div><p>If we develop a game for Android, we can also set the <span class="strong"><strong>Android SDK Location</strong></span> path here as shown in the previous screenshot.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec28"></a>Engage thrusters</h3></div></div></div><p>Now, we are ready to <a id="id130" class="indexterm"></a>create the <code class="literal">PlayerController_2D</code> script. Let's<a id="id131" class="indexterm"></a> get started:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>First, go to <span class="strong"><strong>Assets</strong></span> | <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Javascript</strong></span> (for Unity JavaScript developers) or <span class="strong"><strong>Assets</strong></span> | <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>C# Script</strong></span> (for C# developers) and name our script as <code class="literal">PlayerController_2D</code>.</p></li><li><p>Double-click on the script; it will open the <span class="strong"><strong>MonoDevelop</strong></span> window.</p></li><li><p>Now, we will see three windows in the <span class="strong"><strong>MonoDevelop</strong></span> screen: </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>On the top-left is <span class="strong"><strong>Solution</strong></span>; we can see our project folder here, but it will only show the folder that contains a script</p></li><li style="list-style-type: disc"><p>On the bottom-left, we will see a <span class="strong"><strong>Document Outline</strong></span>; this window will show all the functions, classes, and parameters in the file</p></li><li style="list-style-type: disc"><p>The last window on the right will be used to type our code</p></li></ul></div></li><li><p>Let's get our hands dirty with some code—first start with defining the following functions to initialize the variables: the <code class="literal">Awake()</code> and <code class="literal">Start()</code> function.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip07"></a>Tip</h3><p>
<code class="literal">Awake ()</code>
</p><p>
<code class="literal">Awake</code> <code class="literal">()</code> is<a id="id132" class="indexterm"></a> called when the script instance is being loaded. It used to initialize any variable or game state before calling the <code class="literal">Start()</code> function. In the <code class="literal">Awake()</code> function, we usually put any <code class="literal">GetComponent()</code> or <code class="literal">Find()</code> object function, which will make it easier to set up all the parameters during <code class="literal">Start()</code>.</p></div></li><li><p>We need to remove the<a id="id133" class="indexterm"></a> autogenerated code and replace it with the following code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>// Unity JavaScript user:</strong></span>

#pragma strict
@script RequireComponent(AudioSource)
@script RequireComponent(BoxCollider2D)
@script RequireComponent(Rigidbody2D)
// Distance from the character position to the ground
private final var RAYCAST_DISTANCE : float = 0.58f;
// This number should be between 0.35 to 0.49
private final var CHARACTER_EDGE_OFFSET : float = 0.40f;	
var doorOpenSound : AudioClip;
var getKeySound : AudioClip;
var jumpSound : AudioClip;
var moveForce : float = 80f;
var jumpForce : float = 350f;
var maxSpeed : float = 3f;
var layerMask : LayerMask;
private var _animator : Animator;
private var _boxCollider2D : BoxCollider2D;
private var _isFacingRight : boolean = true;
private var _isJump : boolean = false;
private var _isFall : boolean = false;
private var _isGrounded : boolean = false;
private var _gameEnd : boolean = false;
private var _height : float;
private var _lastY : float;
private var _horizontalInput : float;
function Awake() {
  _animator = GetComponent.&lt;Animator&gt;();
  _boxCollider2D = GetComponent.&lt;BoxCollider2D&gt;();
  _height = _boxCollider2D.size.y;
}
function Start () {
  _isFacingRight = true;
  _isJump = false;
  _isFall = false;
  _isGrounded = false;
  _gameEnd = false;
  _lastY = transform.position.y;
  Camera.main.transform.position = new Vector3(transform.position.x, transform.position.y, Camera.main.transform.position.z);
}</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note07"></a>Note</h3><p>
<code class="literal">#pragma strict</code>
</p><p>In Unity <a id="id134" class="indexterm"></a>JavaScript, we can use <code class="literal">#pragma strict</code> to <a id="id135" class="indexterm"></a>tell Unity to disable dynamic typing (<code class="literal">var name = 5</code>) and force us to use static typing (<code class="literal">var name : int = 5</code>). This will<a id="id136" class="indexterm"></a> make it easy <a id="id137" class="indexterm"></a>for us to debug. For example, if we forgot to use static typing, you will see an error message from the Unity console window. Using strict typing also makes the code run faster as the complier doesn't have to go and do the type lookups.</p></div><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>// C# user:</strong></span>

using UnityEngine;
using System.Collections;
[RequireComponent(typeof(AudioSource))]
[RequireComponent(typeof(BoxCollider2D))]
[RequireComponent(typeof(Rigidbody2D))]
public class PlayerController_2D : MonoBehaviour
{
  // Distance from the character position to the ground
  const float RAYCAST_DISTANCE = 0.58f;
  // This number should be between 0.35 to 0.49
  const float CHARACTER_EDGE_OFFSET = 0.40f;
  
  public AudioClip doorOpenSound;
  public AudioClip getKeySound;
  public AudioClip jumpSound;
  public float moveForce = 80f;
  public float jumpForce = 350f;
  public float maxSpeed = 3f;
  public LayerMask layerMask; 
  Animator _animator;
  BoxCollider2D _boxCollider2D;
  bool _isFacingRight = true;
  bool _isJump = false;
  bool _isFall = false;
  bool _isGrounded = false;
  bool _gameEnd = false;
  float _height;
  float _lastY;
  float _horizontalInput;
  void Awake() {
    _animator = GetComponent&lt;Animator&gt;();
    _boxCollider2D = GetComponent&lt;BoxCollider2D&gt;();
    _height = _boxCollider2D.size.y;
  }
  void Start () {
    _isFacingRight = true;
    _isJump = false;
    _isFall = false;
    _isGrounded = false;
    _gameEnd = false;
    _lastY = transform.position.y;
    Camera.main.transform.position = new Vector3(transform.position.x, transform.position.y, Camera.main.transform.position.z);
  } 
}</pre></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip08"></a>Tip</h3><p>
<span class="strong"><strong>Downloading the example code</strong></span>
</p><p>You can<a id="id138" class="indexterm"></a> download the<a id="id139" class="indexterm"></a> example code files for all Packt books you have purchased from your account at <a class="ulink" href="http://www.packtpub.com" target="_blank">http://www.packtpub.com</a>. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.packtpub.com/support" target="_blank">http://www.packtpub.com/support</a> and<a id="id140" class="indexterm"></a> register to have the files e-mailed directly to you.</p></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note08"></a>Note</h3><p>
<code class="literal">@script RequireComponent(Component)</code> and <code class="literal">[RequireComponent(typeof(Component))]</code>
</p><p>We add <code class="literal">RequireComponent</code> to <a id="id141" class="indexterm"></a>force the script to automatically add the required component as a dependency when adding this class to the game object. For<a id="id142" class="indexterm"></a> more details, visit <a class="ulink" href="http://docs.unity3d.com/Documentation/ScriptReference/RequireComponent.html" target="_blank">http://docs.unity3d.com/Documentation/ScriptReference/RequireComponent.html</a>.</p></div></li><li><p>Next, we will add the <code class="literal">Flip()</code> function after the <code class="literal">Start()</code> function to make our character sprite show the correct graphics when moving left or right. The code for Unity JavaScript and C# users are as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>// Unity JavaScript user:</strong></span>

private function Flip () {
  _isFacingRight = !_isFacingRight;
  var scale : Vector3 = transform.localScale;
  scale.x *= -1;
  transform.localScale = scale;
}


<span class="strong"><strong>// C# user:</strong></span> (Put the code inside the class)

void Flip () {
  _isFacingRight = !_isFacingRight;
  Vector3 scale = transform.localScale;
  scale.x *= -1;
  transform.localScale = scale;
}</pre></div></li><li><p>Next, we <a id="id143" class="indexterm"></a>will add <a id="id144" class="indexterm"></a>another function, which will use <code class="literal">Physics2D.Raycast</code> to <a id="id145" class="indexterm"></a>check whether the player is on the ground or not. Let's create the <code class="literal">Grounded()</code> function as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>// Unity JavaScript user:</strong></span>

private function Grounded () {
  var distance : float = _height*RAYCAST_DISTANCE;
  var hitDirectionV3 : Vector3 = transform.TransformDirection(-Vector3.up);
  var hitDirection : Vector2 = new Vector2(hitDirectionV3.x,hitDirectionV3.y);	
  var rightOrigin : Vector2 = new Vector2(transform.position.x + (_boxCollider2D.size.x*CHARACTER_EDGE_OFFSET), transform.position.y);
  var leftOrigin : Vector2 = new Vector2(transform.position.x - (_boxCollider2D.size.x*CHARACTER_EDGE_OFFSET), transform.position.y);
  var origin : Vector2 = new Vector2(transform.position.x, transform.position.y);
  if (Physics2D.Raycast (origin, hitDirection, distance, layerMask.value)) {
    _isGrounded = true;
  } else if (Physics2D.Raycast (rightOrigin, hitDirection, distance, layerMask.value)) {
    _isGrounded = true;
  } else if (Physics2D.Raycast (leftOrigin, hitDirection, distance, layerMask.value)) {
    _isGrounded = true;
  } else {
    if (_isGrounded) {
      if (Mathf.Floor(transform.position.y) == _lastY) {
        _isGrounded = true;
      } else {
        _isGrounded = false;
      }
    }
  }
  _lastY = Mathf.Floor(transform.position.y);
}


<span class="strong"><strong>// C# user:</strong></span> (Put the code inside the class)

void Grounded () {
  float distance = _height*RAYCAST_DISTANCE;
  Vector3 hitDirectionV3 = transform.TransformDirection (-Vector3.up);
  Vector2 hitDirection = new Vector2(hitDirectionV3.x,hitDirectionV3.y);
  Vector2 rightOrigin = new Vector2(transform.position.x + (_boxCollider2D.size.x*CHARACTER_EDGE_OFFSET), transform.position.y);
  Vector2 leftOrigin = new Vector2(transform.position.x - (_boxCollider2D.size.x*CHARACTER_EDGE_OFFSET), transform.position.y);
  Vector2 origin = new Vector2(transform.position.x, transform.position.y);
  if (Physics2D.Raycast (origin, hitDirection, distance, layerMask.value)) {
    _isGrounded = true;
  } else if (Physics2D.Raycast (rightOrigin, hitDirection, distance, layerMask.value)) {
    _isGrounded = true;
  } else if (Physics2D.Raycast (leftOrigin, hitDirection, distance, layerMask.value)) {
    _isGrounded = true;
  } else {
    if (_isGrounded) {
      if (Mathf.Floor(transform.position.y) == _lastY) {
        _isGrounded = true;
      } else {
        _isGrounded = false;
      }
    }
  } 
  _lastY = Mathf.Floor(transform.position.y);
}</pre></div></li><li><p>Next, we will<a id="id146" class="indexterm"></a> include<a id="id147" class="indexterm"></a> the script <a id="id148" class="indexterm"></a>in the <code class="literal">Update()</code> function and <code class="literal">LateUpdate()</code> function that get called after the <code class="literal">Update()</code> function. These functions will be used to check the input from the user and update the camera to follow our character movement. The code for these functions are as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>// Unity JavaScript user:</strong></span>

function Update() {
  if (!_gameEnd) {
    _horizontalInput = Input.GetAxis("Horizontal");
    if ((!_isFacingRight &amp;&amp; (_horizontalInput &gt; 0)) || 
      (_isFacingRight &amp;&amp; (_horizontalInput &lt; 0))) {
      Flip();
    }
    Grounded();
    if(Input.GetButtonDown("Jump") &amp;&amp; _isGrounded) {
      _isJump = true;
    }
  }
}
function LateUpdate() {
  if (!_gameEnd) {
    Camera.main.transform.position = new Vector3(transform.position.x, transform.position.y, Camera.main.transform.position.z);
  }
}


<span class="strong"><strong>// C# user:</strong></span> (Put the code inside the class)

void Update() {
  if (!_gameEnd) {
    _horizontalInput = Input.GetAxis("Horizontal");
    if ((!_isFacingRight &amp;&amp; (_horizontalInput &gt; 0)) || 
      (_isFacingRight &amp;&amp; (_horizontalInput &lt; 0))) {
      Flip();
    }
    Grounded();
    if(Input.GetButtonDown("Jump") &amp;&amp; _isGrounded) {
      _isJump = true;
    }
  }
}
void LateUpdate() {
  if (!_gameEnd) {
    Camera.main.transform.position = new Vector3(transform.position.x, transform.position.y, Camera.main.transform.position.z);
  }
}</pre></div></li><li><p>Then, we<a id="id149" class="indexterm"></a> create <a id="id150" class="indexterm"></a>a <code class="literal">FixedUpdate()</code> function, which will handle the animation state changing (<span class="strong"><strong>Idle</strong></span>, <span class="strong"><strong>Walk</strong></span>, <span class="strong"><strong>Jump</strong></span>, or <span class="strong"><strong>Fall</strong></span>) and add force to move our character horizontally and <a id="id151" class="indexterm"></a>vertically. Let's add this function as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>// Unity JavaScript user:</strong></span>

function FixedUpdate () {
  if (!_gameEnd) {
    _animator.SetFloat("Speed", Mathf.Abs(_horizontalInput));
    var xSpeed : float = Mathf.Abs(_horizontalInput * rigidbody2D.velocity.x);
    if (xSpeed &lt; maxSpeed) {
      rigidbody2D.AddForce(Vector2.right * _horizontalInput * moveForce);
    }
    if (Mathf.Abs(rigidbody2D.velocity.x) &gt; maxSpeed) {
      var newVelocity : Vector2 = rigidbody2D.velocity;
      newVelocity.x = Mathf.Sign(newVelocity.x) * maxSpeed;
      rigidbody2D.velocity = newVelocity;
    }
    if(_isJump) {
      _animator.SetTrigger("Jump");
      audio.volume = 0.3f;
      audio.PlayOneShot(jumpSound);	
      rigidbody2D.AddForce(new Vector2(0f, jumpForce));   
      _isJump = false;
    }
    if (!_isGrounded) {
      if ((rigidbody2D.velocity.y &lt;= 0f) &amp;&amp; !_isFall) {
        _animator.SetTrigger("Fall");
        _isFall = true;
      }
    }
    if (_isGrounded) {
      if (_isFall) {
        _animator.SetTrigger("Ground");
        _isFall = false;
      } else {
        var animationStateInfo : AnimatorStateInfo = _animator.GetCurrentAnimatorStateInfo(0);
        if ((rigidbody2D.velocity.y &lt; 0f) &amp;&amp; (animationStateInfo.IsName("Base Layer.Jump"))) {
          _animator.SetTrigger("Fall");
          _isFall = true;
        }
      }
    }
  }
}


<span class="strong"><strong>// C# user:</strong></span> (Put the code inside the class)

void FixedUpdate () {
  if (!_gameEnd) {
    #region Setting player horizontal movement
    _animator.SetFloat("Speed", Mathf.Abs(_horizontalInput));
    float xSpeed = Mathf.Abs(_horizontalInput * rigidbody2D.velocity.x);
    if (xSpeed &lt; maxSpeed) {
      rigidbody2D.AddForce(Vector2.right * _horizontalInput * moveForce);
    }
    if (Mathf.Abs(rigidbody2D.velocity.x) &gt; maxSpeed) {
      Vector2 newVelocity = rigidbody2D.velocity;
      newVelocity.x = Mathf.Sign(newVelocity.x) * maxSpeed;
      rigidbody2D.velocity = newVelocity;
    }
    #endregion
    #region If the player should jump
    if(_isJump) {
      _animator.SetTrigger("Jump");
      audio.volume = 0.3f;
      audio.PlayOneShot(jumpSound);	
      rigidbody2D.AddForce(new Vector2(0f, jumpForce));	
      _isJump = false;
    }
    #endregion
    #region If the player should fall
    if (!_isGrounded) {
      if ((rigidbody2D.velocity.y &lt;= 0f) &amp;&amp; !_isFall) {
        _animator.SetTrigger("Fall");
        _isFall = true;
      }
    }
    #endregion
    #region If the player is grounded
    if (_isGrounded) {
      if (_isFall) {
        _animator.SetTrigger("Ground");
        _isFall = false;
      } else {
        AnimatorStateInfo animationStateInfo = _animator.GetCurrentAnimatorStateInfo(0);
        if ((rigidbody2D.velocity.y &lt; 0f) &amp;&amp; (animationStateInfo.IsName("Base Layer.Jump"))) {
          _animator.SetTrigger("Fall");
          _isFall = true;
        }
      }
    }
    #endregion
  }
}</pre></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip09"></a>Tip</h3><p>
<code class="literal">#region YourComment - #endregion</code>
</p><p>In C#, we can put any script between <code class="literal">#region Your Code Discription</code> and <code class="literal">#endregion</code> to specify a block of code that we can expand or collapse by clicking on the plus and minus sign in MonoDevelop.</p></div><p>We can see how to <a id="id152" class="indexterm"></a>use <code class="literal">#region ….. #endregion</code> in the <a id="id153" class="indexterm"></a>following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849695589/graphics/5589_01_36.jpg" /></div><p>Lastly, we will add the <code class="literal">OnDrawGizmos()</code> function<a id="id154" class="indexterm"></a> in this class. It is a very nice function that allows us to debug the <a id="id155" class="indexterm"></a>game, the result of which we won't see in the real game. Let's<a id="id156" class="indexterm"></a> add the<a id="id157" class="indexterm"></a> following block of code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>// Unity JavaScript user:</strong></span>

function OnDrawGizmos() {
  _boxCollider2D = GetComponent.&lt;BoxCollider2D&gt;();
  _height = _boxCollider2D.size.y;
  var distance : float = (_height * RAYCAST_DISTANCE);
  var rightOrigin : Vector3 = new Vector3(transform.position.x + (_boxCollider2D.size.x*CHARACTER_EDGE_OFFSET), transform.position.y, transform.position.z);
  var leftOrigin : Vector3 = new Vector3(transform.position.x - (_boxCollider2D.size.x*CHARACTER_EDGE_OFFSET), transform.position.y, transform.position.z);
  Gizmos.color = Color.red;
  Gizmos.DrawRay(transform.position, transform.TransformDirection (-Vector3.up) * distance);
  Gizmos.DrawRay(rightOrigin, transform.TransformDirection (-Vector3.up) * distance);
  Gizmos.DrawRay(leftOrigin, transform.TransformDirection (-Vector3.up) * distance);
}


<span class="strong"><strong>// C# user:</strong></span> (Put the code inside the class)
void OnDrawGizmos() {
  _boxCollider2D = GetComponent&lt;BoxCollider2D&gt;();
  _height = _boxCollider2D.size.y;
  float distance = (_height * RAYCAST_DISTANCE);
  Vector3 rightOrigin = new Vector3(transform.position.x + (_boxCollider2D.size.x*CHARACTER_EDGE_OFFSET), transform.position.y, transform.position.z);
  Vector3 leftOrigin = new Vector3(transform.position.x - (_boxCollider2D.size.x*CHARACTER_EDGE_OFFSET), transform.position.y, transform.position.z);
  Gizmos.color = Color.red;
  Gizmos.DrawRay(transform.position, transform.TransformDirection (-Vector3.up) * distance);
  Gizmos.DrawRay(rightOrigin, transform.TransformDirection (-Vector3.up) * distance);
  Gizmos.DrawRay(leftOrigin, transform.TransformDirection (-Vector3.up) * distance);
}</pre></div></li><li><p>Now, save it and go back to Unity; drag-and-drop the <span class="strong"><strong>PlayerController_2D</strong></span> script to <span class="strong"><strong>Player</strong></span>, click on <span class="strong"><strong>Player</strong></span>, and go to the <span class="strong"><strong>Inspector</strong></span> window. Click on <span class="strong"><strong>Idle Sprite</strong></span> and <span class="strong"><strong>Walk Sprite</strong></span> to expand it and then set the following:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col align="left" /><col align="left" /></colgroup><thead><tr><th style="border-bottom: 0.5pt solid ; " colspan="2" align="left" valign="bottom">
<p>
<span class="strong"><strong>Player Controller_2D (Script)</strong></span>
</p>
</th></tr></thead><tbody><tr><td style="" align="left" valign="top">
<p>
<span class="strong"><strong>Door Open Sound</strong></span>
</p>
</td><td style="" align="left" valign="top">
<p>
<code class="literal">doorOpen</code>
</p>
</td></tr><tr><td style="" align="left" valign="top">
<p>
<span class="strong"><strong>Get Key Sound</strong></span>
</p>
</td><td style="" align="left" valign="top">
<p>
<code class="literal">getkey</code>
</p>
</td></tr><tr><td style="" align="left" valign="top">
<p>
<span class="strong"><strong>Jump Sound</strong></span>
</p>
</td><td style="" align="left" valign="top">
<p>
<code class="literal">jump</code>
</p>
</td></tr><tr><td style="" align="left" valign="top">
<p>
<span class="strong"><strong>Layer Mask</strong></span>
</p>
</td><td style="" align="left" valign="top">
<p>
<span class="strong"><strong>Ground</strong></span>
</p>
</td></tr></tbody></table></div></li></ol></div><p>Yes! We are <a id="id158" class="indexterm"></a>done. Let's click on the <span class="strong"><strong>Play</strong></span> <a id="id159" class="indexterm"></a>button to play the game. We will <a id="id160" class="indexterm"></a>see our player moving his hand back and forth. Next, press the <span class="emphasis"><em>A</em></span> or left arrow / <span class="emphasis"><em>D</em></span> or right arrow<span class="emphasis"><em> </em></span>to move the player to the left or to the right; now we see that he is walking. We can also press the Space bar to make our character jump. Isn't that cool?</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec29"></a>Objective complete – mini debriefing</h3></div></div></div><p>We just created a script that controls the movement of our character and his animation. First, we created the parameters to use in our script. We also used the <code class="literal">const</code> keyword in C# and the <code class="literal">final</code> keyword in Unity JavaScript to create the constant variables.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note09"></a>Note</h3><p>The <code class="literal">const</code> and <code class="literal">final</code> keywords</p><p>We used the<a id="id161" class="indexterm"></a> <code class="literal">const</code> keyword in C# to specify that the value of the field or local variable is constant, which means it can't be modified from anywhere else.</p><p>However, there is no <code class="literal">const</code> keyword in Unity JavaScript, so we use the <code class="literal">final</code> keyword instead; there is a slight difference between the <code class="literal">final</code> and <code class="literal">const</code> keywords. The <code class="literal">const</code> keyword can only applied to a field whose value is to be known at compile time, such as <code class="literal">const</code> <code class="literal">float</code>. So, this means that we can't use the <code class="literal">const</code> keyword with <code class="literal">Vector3</code>, <code class="literal">Rect</code>, <code class="literal">Point</code>, and all the struct that are included in Unity. On the other hand, we will use <code class="literal">readonly</code> instead. However, the <code class="literal">final</code> keyword<a id="id162" class="indexterm"></a> can be used in the both cases. </p><p>For more details, visit <a class="ulink" href="http://tutorials.csharp-online.net/CSharp_FAQ%3A_What_are_the_differences_between_CSharp_and_Java_constant_declarations" target="_blank">http://tutorials.csharp-online.net/CSharp_FAQ%3A_What_are_the_differences_between_CSharp_and_Java_constant_declarations</a>.</p></div><p>Then, we get <code class="literal">_animator</code>, <code class="literal">_boxCollider2D</code>, and <code class="literal">_height</code> in the <code class="literal">Awake()</code> function to check the animation state while it is moving. Then, we set all the variables to their default value. Next, we created the <code class="literal">Flip()</code> function, which will set _<code class="literal">isFacingRight</code> to <code class="literal">true</code> or <code class="literal">false</code> depending on the character movement. This function also sets the local <code class="literal">x</code> scale to <code class="literal">1</code> if the character is facing right and <code class="literal">-1</code> if it's facing left.</p><p>The next function that we <a id="id163" class="indexterm"></a>created is the <code class="literal">Grounded()</code> function<a id="id164" class="indexterm"></a> that uses <code class="literal">Physics2D.Raycast</code> to check whether our character is on the ground or not.</p><p>In the <code class="literal">Update()</code> function, we <a id="id165" class="indexterm"></a>get the character's horizontal movement by using <code class="literal">Input.GetAxis("Horizontal")</code>. Then, we check for the movement direction and call the <code class="literal">Flip()</code> function. After that, we call the <code class="literal">Grounded()</code> function to check whether the character is on the ground or not. If not, we can make the character jump by using <code class="literal">Input.GetButtonDown("Jump")</code>. Next, we update our camera position by using <code class="literal">Camera.main</code> to get access to the <span class="strong"><strong>Main Camera</strong></span> object and set its position relative to <span class="strong"><strong>Player</strong></span>.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip10"></a>Tip</h3><p>
<code class="literal">Camera.main</code> lets us access a <span class="strong"><strong>Camera</strong></span> object that has the <span class="strong"><strong>MainCamera</strong></span> tag from anywhere we want.</p></div><p>In the <code class="literal">FixedUpdate()</code> function, we change the animation state from <span class="strong"><strong>Idle</strong></span> to <span class="strong"><strong>Walk</strong></span> by using <code class="literal">_animator.SetFloat("Speed", Mathf.Abs(_horizontalInput));</code>. Next, we get the <code class="literal">x</code> speed and check that the speed is lower than the maximum speed. Then, we add the force to <span class="strong"><strong>Rigidbody2D</strong></span> by using <code class="literal">rigidbody2D.AddForce(Vector2.right * _horizontalInput * moveForce);</code>. We also make sure that the velocity doesn't reach the maximum limit after adding the force by assigning <code class="literal">newVelocity</code> to <code class="literal">rigidbody2D.velocity</code>.</p><p>Next, we trigger the jump animation state by using <code class="literal">_animator.SetTrigger("Jump");</code>. We also add the force to make our character jump using <code class="literal">rigidbody2D.AddForce(new Vector2(Of,jumpForce);</code>. Then, we trigger the fall animation state by using <code class="literal">_animator.SetTrigger("Fall");</code>. We also trigger the ground animation state by using <code class="literal">_animator.SetTrigger("Ground");</code> if our character is falling.</p><p>Then, we check for the current animation state by getting <code class="literal">animatorStateInfo</code> using <code class="literal">_animator.GetCurrentAnimatorStateInfo(0);</code>. Then, if the current state is the jump state and <code class="literal">y</code> velocity lower than <code class="literal">0</code>, we will change the animation state to the fall state using <code class="literal">if ((rigidbody2D.velocity.y &lt; 0) &amp;&amp; (animationStateInfo.IsName("BaseLayer.Jump"))</code>.</p><p>At last, we use <a id="id166" class="indexterm"></a>the <code class="literal">OnDrawGizmos()</code> function to see<a id="id167" class="indexterm"></a> the visual of the <a id="id168" class="indexterm"></a>ray that was drawn in the <code class="literal">Grounded()</code> function using <code class="literal">Physics2D.Raycast</code>. We can also use this function to debug the game without removing any code when releasing the game. Because all the code in the <code class="literal">OnDrawGizmos()</code> function won't be shown in the real game, it's a convenient way to debug our game. As we can see from the following figure, the red arrows represent where the raycast is, which will only show in the scene view:</p><div class="mediaobject"><img src="/graphics/9781849695589/graphics/5589_01_37.jpg" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec30"></a>Classified intel</h3></div></div></div><p>In Unity, we can set a custom Input Manager by going to <span class="strong"><strong>Edit</strong></span> | <span class="strong"><strong>Project Settings</strong></span> | <span class="strong"><strong>Input</strong></span>. In <span class="strong"><strong>Inspector</strong></span>, click on <span class="strong"><strong>Axes</strong></span> and you will see that the value of <span class="strong"><strong>Size</strong></span> is <code class="literal">15</code>, which is the array length of all the inputs. If we want more than 15 inputs, we can put the number here (the default is <code class="literal">15</code>). Next, we will see all 15 names from <span class="strong"><strong>Horizontal</strong></span> to <span class="strong"><strong>Jump</strong></span> as a default setting. Each one will have its own parameters, which we can set up as follows:</p><div class="mediaobject"><img src="/graphics/9781849695589/graphics/5589_01_38.jpg" /></div><p>For more information of each parameter, go to the following link: <a class="ulink" href="http://docs.unity3d.com/Manual/class-InputManager.html" target="_blank">http://docs.unity3d.com/Manual/class-InputManager.html</a>.</p><p>The <span class="strong"><strong>Negative </strong></span><a id="id169" class="indexterm"></a>
<span class="strong"><strong>Button</strong></span> and <span class="strong"><strong>Positive Button</strong></span> here <a id="id170" class="indexterm"></a>will send the negative and<a id="id171" class="indexterm"></a> positive value, which in most cases is used to control directions such as, left, right, up, and down. There is a <span class="strong"><strong>Dead</strong></span> parameter, which will set any number that is lower than this parameter to <code class="literal">0</code>, which is very useful when we use a joystick. </p><p>Also, setting <span class="strong"><strong>Type</strong></span> to <span class="strong"><strong>Key or Mouse Button</strong></span> and enabling the <span class="strong"><strong>Snap</strong></span> parameter will reset axis values to zero after it receives opposite inputs.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl3sec02"></a>Physics2D.Raycast</h4></div></div></div><p>If we take a look at the <code class="literal">Grounded()</code> function<a id="id172" class="indexterm"></a> and check out the following highlighted code, we will see that we have cast the ray a bit longer than the sprite collider:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>if (Physics2D.Raycast (origin, hitDirection, distance, layerMask.value)) {</strong></span>
  _isGrounded = true;
<span class="strong"><strong>} else if (Physics2D.Raycast (rightOrigin, hitDirection, distance, layerMask.value)) {</strong></span>
  _isGrounded = true;
<span class="strong"><strong>} else if (Physics2D.Raycast (leftOrigin, hitDirection, distance, layerMask.value)) {</strong></span>
  _isGrounded = true;
}</pre></div><p>From the highlighted code, we draw <a id="id173" class="indexterm"></a>
<code class="literal">Raycast</code> from the middle of our character downward by <code class="literal">0.58</code> units. Why don't we set it to <code class="literal">0.5</code>? We set it this way to make our character stay on the edge of the floor surface. If we set it to <code class="literal">0.5</code>, we will see that the character will not hit the ground. This is because of the way <span class="strong"><strong>Box Collider 2D</strong></span> and <span class="strong"><strong>Polygon Collider 2D</strong></span> detect other collider objects in Unity, as we can see in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849695589/graphics/5589_01_39.jpg" /></div><p>One last thing for <code class="literal">Gizmos</code>: if we want to see our gizmos in the game scene, we can click on the <span class="strong"><strong>Gizmos</strong></span> tab on the top-right corner of the game scene:</p><div class="mediaobject"><img src="/graphics/9781849695589/graphics/5589_01_40.jpg" /></div></div></div></div>