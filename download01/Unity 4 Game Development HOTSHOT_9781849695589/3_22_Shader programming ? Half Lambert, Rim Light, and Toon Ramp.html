<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec31"></a>Shader programming – Half Lambert, Rim Light, and Toon Ramp</h2></div></div><hr /></div><p>In this last step, we will add the last three properties, <code class="literal">_RimColor</code>, <code class="literal">_RimPower</code>, and <code class="literal">_Ramp</code> to get the toon shader result. The <code class="literal">_RimColor</code> and <code class="literal">_RimPower</code> properties basically control the back<a id="id520" class="indexterm"></a> lighting <a id="id521" class="indexterm"></a>effect of our character. The <code class="literal">_Ramp</code> properties will be the ramp<a id="id522" class="indexterm"></a> textures that are used to calculate the lighting<a id="id523" class="indexterm"></a> effect<a id="id524" class="indexterm"></a> based on the angle between <a id="id525" class="indexterm"></a>the light direction and surface normal of the object. We will also get the Half Lambert lighting effect to make a smooth lighting effect.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec64"></a>Engage thrusters</h3></div></div></div><p>This is the last section, after which you will be able to see the result of your custom shader:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Go to <span class="strong"><strong>MonoDevelop</strong></span>, open the <code class="literal">MyShader</code> file, go to the <code class="literal">Properties</code> section, and add the highlighted script as follows:</p><div class="informalexample"><pre class="programlisting">Properties {  
  _BumpMap ("Bumpmap", 2D) = "bump" {}
<span class="strong"><strong>  _RimColor ("Rim Color", Color) = (0.07, 0.2, 0.42, 1.0)</strong></span>
<span class="strong"><strong>  _RimPower ("Rim Power", Range(0.01,8)) = 7</strong></span>
<span class="strong"><strong>  _Ramp ("Ramp Texture", 2D) = "gray" {}</strong></span>
}</pre></div></li><li><p>Go to the <code class="literal">SubShader</code> section and add the highlighted code as follows:</p><div class="informalexample"><pre class="programlisting">SubShader { 
  Tags { "RenderType"="Opaque" } 
  LOD 400 
  CGPROGRAM 
<span class="strong"><strong>  #pragma surface surf RampSpecular exclude_path:prepass</strong></span>

  fixed4 _AmbientColor;
  fixed4 _SpecularColor;
  half _Shininess;
    
  sampler2D _MainTex; 
  sampler2D _BumpMap;

<span class="strong"><strong>  fixed4 _RimColor;</strong></span>
<span class="strong"><strong>  half _RimPower;</strong></span>
<span class="strong"><strong>  sampler2D _Ramp;</strong></span>

  struct Input { 
    float2 uv_MainTex;
    float2 uv_BumpMap;
<span class="strong"><strong>    fixed3 viewDir;</strong></span>
  };
  
}</pre></div><p>We can see that we put <code class="literal">exclude_path:prepass</code> after the <code class="literal">#pragma</code> line. This means that this lighting model will only work on the forward lighting (no deferred lighting). This is because we don't have the angle between the light direction and normal to calculate in the prepass, which is needed for the deferred lighting.</p></li><li><p>Add <a id="id526" class="indexterm"></a>the<a id="id527" class="indexterm"></a> following <a id="id528" class="indexterm"></a>highlighted <a id="id529" class="indexterm"></a>code inside<a id="id530" class="indexterm"></a> the <code class="literal">surf()</code> function to create the Rim Light<a id="id531" class="indexterm"></a> effect<a id="id532" class="indexterm"></a> using <code class="literal">Emission</code>:</p><div class="informalexample"><pre class="programlisting">void surf (Input IN, inout SurfaceOutput o) {   
  o.Normal = UnpackNormal (tex2D (_BumpMap, IN.uv_BumpMap));
<span class="strong"><strong>  fixed rim = 1.0 - saturate(dot (normalize(IN.viewDir), o.Normal)); </strong></span>
<span class="strong"><strong>  o.Emission = (_RimColor.rgb * pow (rim, _RimPower)); </strong></span>
}</pre></div></li><li><p>Finally, go to the custom lighting function <code class="literal">LightingRampSpecular()</code>. In this, we will calculate the diffuse color by using the <span class="strong"><strong>Half Lambert</strong></span> or <span class="strong"><strong>Warp Lambert</strong></span> method to get the lighting warp around our model. Then, we get the ramp texture from the property and multiply it with the light color and our main color texture. Let's modify and add the following code:</p><div class="informalexample"><pre class="programlisting">inline fixed4 LightingRampSpecular (SurfaceOutput s, fixed3 lightDir, fixed3 viewDir, fixed atten) {
  //Ambient
  fixed3 ambient = s.Albedo * _AmbientColor.rgb;
<span class="strong"><strong>  //Ramp – Diffuse (Half Lambert)</strong></span>
  fixed NdotL = saturate(dot (s.Normal, lightDir));
<span class="strong"><strong>  fixed halfLambert = NdotL * 0.5 + 0.5;</strong></span>
<span class="strong"><strong>  fixed3 ramp = tex2D(_Ramp, float2(halfLambert, halfLambert)).rgb;</strong></span>
<span class="strong"><strong>  fixed3 diffuse = s.Albedo * _LightColor0.rgb * ramp;</strong></span>
  //Specular
  
}</pre></div></li><li><p>Finally, we go back to Unity and apply the ramp texture to our model. Let's click on the <code class="literal">Heroine</code> model in the <span class="strong"><strong>Hierarchy</strong></span> view to bring up its <span class="strong"><strong>Inspector</strong></span> view. In the <span class="strong"><strong>Inspector</strong></span> view, we will go to the material <a id="id533" class="indexterm"></a>component in the <a id="id534" class="indexterm"></a>new<a id="id535" class="indexterm"></a> property, <span class="strong"><strong>Ramp Texture</strong></span>, and set the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="strong"><strong>Ramp Texture</strong></span>: Drag-and-drop <span class="strong"><strong>Ramp</strong></span> in the <span class="strong"><strong>Textures</strong></span> folder from<a id="id536" class="indexterm"></a> the <span class="strong"><strong>Project</strong></span> view<a id="id537" class="indexterm"></a> to this thumbnail</p></li></ul></div><p>After <a id="id538" class="indexterm"></a>doing this, we will see the <span class="strong"><strong>Inspector</strong></span> view as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849695589/graphics/5589OT_03_23.jpg" /></div></li><li><p>Now, we can click on <span class="strong"><strong>Play</strong></span> to see the result, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849695589/graphics/5589OT_03_24.jpg" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note41"></a>Note</h3><p>We can also move or rotate our camera to see our character with the shader in a different angle.</p></div></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec65"></a>Objective complete – mini debriefing</h3></div></div></div><p>In this<a id="id539" class="indexterm"></a> section, first we added three properties, <code class="literal">_RimColor</code>, <code class="literal">_RimPower</code>, and <code class="literal">_Ramp</code>, in the <code class="literal">Properties</code> section, which are used to<a id="id540" class="indexterm"></a> calculate <a id="id541" class="indexterm"></a>the Rim Light as well as the Toon Ramp shader styles.</p><p>Then, we<a id="id542" class="indexterm"></a> placed <code class="literal">exclude_path:prepass</code> after <code class="literal">#pragma surface surf RampSpecular</code>. This means that we set our shader to compile without the deferred <a id="id543" class="indexterm"></a>rendering. Why would we want to do this? As our Toon Ramp<a id="id544" class="indexterm"></a> shader needs the angle data between the light direction and surface normals to calculate the lighting that can't be calculated in the deferred rendering, we excluded it.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note42"></a>Note</h3><p>In Unity, we can choose three types of rendering paths: Vertex Lit, Forward, and Deferred <a id="id545" class="indexterm"></a>Lighting. Vertex Lit is basically the lowest lighting quality and doesn't support any real-time shadows. Forward is shader-based, which<a id="id546" class="indexterm"></a> is the default setting in Unity and only supports real-time shadows from one-directional light. Deferred Lighting is the rendering path <a id="id547" class="indexterm"></a>with the most lighting and shadow quality, which is available only in Unity Pro with no support for mobile devices. We can get more<a id="id548" class="indexterm"></a> information about the rendering path from <a class="ulink" href="http://docs.unity3d.com/Documentation/Manual/RenderingPaths.html" target="_blank">http://docs.unity3d.com/Documentation/Manual/RenderingPaths.html</a>.</p></div><p>Next, we added <code class="literal">half3 viewDir;</code> in <code class="literal">struct Input {}</code>, which allows us to get the user view direction vector. This parameter will be used to calculate the specular reflection on our model. </p><p>Inside<a id="id549" class="indexterm"></a> the <code class="literal">surf()</code> function, we calculated the<a id="id550" class="indexterm"></a> rim <a id="id551" class="indexterm"></a>power <a id="id552" class="indexterm"></a>or the brightness of our backlight, which is <code class="literal">fixed rim = 1.0 - saturate(dot (normalize(IN.viewDir), o.Normal));</code>, by using the saturation of the dot product of the view direction normalize and surface normals. In the <a id="id553" class="indexterm"></a>next line, <code class="literal">o.Emission = (_RimColor.rgb * pow (rim, _ RimPower));</code>, we multiplied the Rim Light color with the power of the rim power that<a id="id554" class="indexterm"></a> we got. Then, we assigned the result to <code class="literal">o.Emission</code> to show the rim light effect on our object. </p><p>In the <code class="literal">LightingRampSpecular()</code> function, we changed the calculation of the lighting by using the Half Lambert model, which makes our object brighter with the light that warps around the object by dividing it by half and adding <code class="literal">0.5</code>:</p><div class="informalexample"><pre class="programlisting">fixed diff = NdotL * 0.5 + 0.5;</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note43"></a>Note</h3><p>Half Lambert lighting<a id="id555" class="indexterm"></a> is a technique first developed in the original <span class="emphasis"><em>Half-Life</em></span>. It is designed to prevent the rear of an object from losing its shape and looking too flat. Half Lambert is a completely non-physical technique and gives a purely perceived visual enhancement and is an example of a forgiving lighting model.</p><p>This reference is taken from <a class="ulink" href="http://developer.valvesoftware.com/wiki/Half_Lambert" target="_blank">http://developer.valvesoftware.com/wiki/Half_Lambert</a>.</p></div><p>We can see the difference between each lighting model in the following diagram:</p><div class="mediaobject"><img src="/graphics/9781849695589/graphics/5589OT_03_25.jpg" /></div><p>Next, we used <code class="literal">halfLambert</code> to calculate the ramp texture, <code class="literal">_Ramp</code>, to get the color result using the <code class="literal">tex2D()</code> function, as follows:</p><div class="informalexample"><pre class="programlisting">fixed3 ramp = tex2D (_Ramp, float2(halfLambert, halfLambert)).rgb;</pre></div><p>Then, we multiplied this value with the diffuse color and light color, as follows:</p><div class="informalexample"><pre class="programlisting">fixed3 rampDiffuse = s.Albedo * _LightColor0.rgb * ramp;</pre></div><p>We <a id="id556" class="indexterm"></a>will get <a id="id557" class="indexterm"></a>a<a id="id558" class="indexterm"></a> result that<a id="id559" class="indexterm"></a> is<a id="id560" class="indexterm"></a> different from <a id="id561" class="indexterm"></a>the previous section, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849695589/graphics/5589OT_03_26.jpg" /></div></div></div>