<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec30"></a>Integrating the Palette with the Level Creator tool</h2></div></div><hr /></div><p>In this section, we <a id="id179" class="indexterm"></a>will create an event that<a id="id180" class="indexterm"></a> will be triggered every time you select a piece in the Palette and captured by the Level inspector. This feature will be used in the next chapter.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec40"></a>Creating an event</h3></div></div></div><p>An event in C# is a<a id="id181" class="indexterm"></a> way for a class to provide notifications when something happens to an object.</p><p>In this case, we will add an event when the user selects one of the pieces from the Palette. To achieve this, we we will add the following lines of code to the <code class="literal">PalleteWindow.cs</code> script:</p><div class="informalexample"><pre class="programlisting">public delegate void itemSelectedDelegate (PaletteItem item,Texture2D preview);
public static event itemSelectedDelegate ItemSelectedEvent;</pre></div><p>The <code class="literal">delegate</code> type defines the signature for the method that handles the event. In this case, <code class="literal">itemSelectedDelegate</code> receives a PaletteItem and a Texture2D with the preview.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip10"></a>Tip</h3><p>As a good practice, it is always recommended to check if the even is, or is not, null.</p></div><p>Now, it is time to invoke the event. We will do this inside the <code class="literal">GetSelectedItem</code> method:</p><div class="informalexample"><pre class="programlisting">private void GetSelectedItem (int index) {
  if (index != -1) {
    PaletteItem selectedItem = 
            _categorizedItems [_categorySelected] [index];
    Debug.Log ("Selected Item is: " + 
      selectedItem.itemName);

<span class="strong"><strong>    if (ItemSelectedEvent != null) {</strong></span>
<span class="strong"><strong>      ItemSelectedEvent (selectedItem, _previews [selectedItem]);</strong></span>
<span class="strong"><strong>    }</strong></span>
  }
}</pre></div><p>We are done<a id="id182" class="indexterm"></a> here. Now, we need to subscribe to this event in the Level inspector class.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec41"></a>Subscribing to an event</h3></div></div></div><p>Now, we will subscribe to the event we created. This is done with the <code class="literal">+=</code> and <code class="literal">-=</code> operators, which <a id="id183" class="indexterm"></a>are used to subscribe and unsubscribe respectively.</p><p>Before adding the events, we will create the variables and methods that we need to make this work. The plan is to display the selected piece in the inspector. We will add a variable to save the selected piece instance in the <code class="literal">LevelInspector.cs</code> script:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using UnityEditor;

namespace RunAndJump.LevelCreator {
    [CustomEditor(typeof(Level))]
    public class LevelInspector : Editor {

    private PaletteItem _itemSelected;
    private Texture2D _itemPreview;
    private LevelPiece _pieceSelected;

    // Rest of the code...
  }
}</pre></div><p>We will create the method that we want to subscribe to the event called <code class="literal">UpdateCurrentPieceInstance</code>:</p><div class="informalexample"><pre class="programlisting">private void UpdateCurrentPieceInstance(PaletteItem item, Texture2D preview) {
    _itemSelected = item;
    _itemPreview = preview;
    _pieceSelected = (LevelPiece) item.GetComponent&lt;LevelPiece&gt;();
    Repaint();
}</pre></div><p>When the event is triggered, the piece selected will be passed as a parameter and saved in <code class="literal">_pieceSelected</code>. As we want to see a few changes in the inspector when this happens, we also use the method <code class="literal">Repaint</code> to force the inspector to repaint.</p><p>To subscribe and unsubscribe from this event, we will use the <code class="literal">OnEnable</code> and <code class="literal">OnDisable</code> methods respectively:</p><div class="informalexample"><pre class="programlisting">private void OnEnable () {
    _myTarget = (Level)target;
    InitLevel ();
    ResetResizeValues ();
    SubscribeEvents();
}

private void OnDisable () {
    UnsubscribeEvents();
}
private void SubscribeEvents() {
    PaletteWindow.ItemSelectedEvent += new PaletteWindow.itemSelectedDelegate(UpdateCurrentPieceInstance);
}

private void UnsubscribeEvents() {
    PaletteWindow.ItemSelectedEvent -= new PaletteWindow.itemSelectedDelegate( UpdateCurrentPieceInstance);
}</pre></div><p>With this, we <a id="id184" class="indexterm"></a>have all the necessary logic implemented. The last thing to conclude is to see something in the inspector. For this, create a new method called <code class="literal">DrawPieceSelectedGUI</code>:</p><div class="informalexample"><pre class="programlisting">private void DrawPieceSelectedGUI() {
    EditorGUILayout.LabelField("Piece Selected", EditorStyles.boldLabel);
    if(_pieceSelected == null) {
        EditorGUILayout.HelpBox("No piece selected!", MessageType.Info);
    } else {
        EditorGUILayout.BeginVertical("box");
        EditorGUILayout.LabelField(new GUIContent(_itemPreview), GUILayout.Height(40));
        EditorGUILayout.LabelField(_itemSelected.itemName);
        EditorGUILayout.EndVertical();
    }
}</pre></div><p>Now, add <code class="literal">DrawPieceSelectedGUI</code> to the <code class="literal">OnInspectorGUI</code> method:</p><div class="informalexample"><pre class="programlisting">public override void OnInspectorGUI () {
  // DrawDefaultInspector();
    DrawLevelDataGUI ();
    DrawLevelSizeGUI ();
<span class="strong"><strong>    DrawPieceSelectedGUI();</strong></span>

    if (GUI.changed) {
      EditorUtility.SetDirty (_myTarget);
    }
  }</pre></div><p>We are<a id="id185" class="indexterm"></a> ready to do the final test. After saving and waiting for Unity to compile, create a new level and display the Palette window using the Level Creator menu:</p><div class="mediaobject"><img src="/graphics/9781785281853/graphics/B04640_04_14.jpg" /></div><p>Now, you will see something like this:</p><div class="mediaobject"><img src="/graphics/9781785281853/graphics/B04640_04_15.jpg" /></div><p>If you pay attention to the inspector, there is a new label that says <span class="strong"><strong>No piece selected!</strong></span>, as you can <a id="id186" class="indexterm"></a>see in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781785281853/graphics/B04640_04_16.jpg" /></div><p>Select the category <span class="strong"><strong>Misc</strong></span>, and then click on the <span class="strong"><strong>Sign</strong></span> piece; the Inspector will be listened the event, and now Piece Selected section shows the piece selected:</p><div class="mediaobject"><img src="/graphics/9781785281853/graphics/B04640_04_17.jpg" /></div><p>With this working, we are ready to implement, in the next chapter, the functionality of adding pieces to the scene to <a id="id187" class="indexterm"></a>start creating levels for <span class="emphasis"><em>Run &amp; Jump</em></span>. Good work!</p></div></div>