<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec35"></a>Detecting Scene View events</h2></div></div><hr /></div><p>Most <a id="id207" class="indexterm"></a>of the interaction with Level Creator is going to be performed through the mouse. In this section, will learn how to capture events in the Scene View.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec46"></a>Getting the mouse position</h3></div></div></div><p>The <code class="literal">Event</code> class, part of the <code class="literal">UnityEngine</code> namespace, allows you to handle user inputs such as <a id="id208" class="indexterm"></a>key presses or mouse actions.</p><p>Let's update the method <code class="literal">EventHandler</code> inside the <code class="literal">LevelInspector</code> class:</p><div class="informalexample"><pre class="programlisting">private void EventHandler() {
    HandleUtility.AddDefaultControl(
    GUIUtility.GetControlID(FocusType.Passive));
    
<span class="strong"><strong>    Vector3 mousePosition = Event.current.mousePosition;</strong></span>
<span class="strong"><strong>    Debug.LogFormat("MousePos: {0}", mousePosition);</strong></span>
}</pre></div><p>The variable <code class="literal">Event.current</code> has the information about the current event that's being processed in the Scene View.</p><p>From <code class="literal">current</code>, we are accessing the variable <code class="literal">mousePosition</code> to determine in which X and Y positions, relative to the Scene View coordinate system, the cursor of the mouse is found.</p><p>Save the changes and wait for Unity to compile. Now create a new level scene, select the game object, and then move the mouse over the Scene View. In the console, you will see the logs with the mouse position:</p><p> </p><div class="mediaobject"><img src="/graphics/9781785281853/graphics/B04640_05_10.jpg" /></div><p>
</p><p>We need to associate the current mouse position with a cell in the grid; this means we transform the<a id="id209" class="indexterm"></a> mouse position to world coordinates and then to grid coordinates. To achieve this, we will use the method <code class="literal">WorldToGridCoordinates</code> from the Level class we implemented in <a class="link" href="#" linkend="ch02">Chapter 2</a>, <span class="emphasis"><em>Using Gizmos in the Scene View</em></span>. Let's update the method <code class="literal">EventHandler</code> again:</p><div class="informalexample"><pre class="programlisting">private void EventHandler() {
    HandleUtility.AddDefaultControl(
    GUIUtility.GetControlID(FocusType.Passive));
    
<span class="strong"><strong>    Camera camera = SceneView.currentDrawingSceneView.camera;</strong></span>

    Vector3 mousePosition = Event.current.mousePosition;

<span class="strong"><strong>   //Debug.LogFormat("MousePos: {0}", mousePosition);</strong></span>
<span class="strong"><strong>    Vector3 worldPos = camera.ScreenToWorldPoint(mousePosition);</strong></span>
<span class="strong"><strong>    Vector3 gridPos = _myTarget.WorldToGridCoordinates(worldPos);</strong></span>
<span class="strong"><strong>    int col = (int) gridPos.x;</strong></span>
<span class="strong"><strong>    int row = (int) gridPos.y;</strong></span>
<span class="strong"><strong>    </strong></span>
<span class="strong"><strong>    Debug.LogFormat("GridPos {0},{1}", col, row);</strong></span>
}</pre></div><p>The <code class="literal">SceneView</code> class is the one that defines the behavior of a Scene View window in Unity. From this class, we used the property <code class="literal">currentDrawingSceneView</code> to access the current Scene View instance and then to the camera that is rendering the scene (this is not the same camera you use to render in the video game).</p><p>With the camera reference, we can use the methods <code class="literal">ScreenToWorldPoint</code> and <code class="literal">WorldToGridCoordinates</code> to get column and row grid coordinates. Save the changes and wait for Unity to compile. Now create a level, select the game object, and then move the mouse over the bottom right cell in the grid:</p><div class="mediaobject"><img src="/graphics/9781785281853/graphics/B04640_05_11.jpg" /></div><p>The coordinates of the bottom-left cell are different from the expected (0,0), this happens because the <a id="id210" class="indexterm"></a>method <code class="literal">ScreenToWorldPoint</code> assumes the bottom-left of the screen is <span class="emphasis"><em>(0,0)</em></span> but the Scene View has the origin in the top-left corner.</p><p>To solve this, we need to invert the Y-axis of the mouse position. Let's fix the method <code class="literal">EventHandler</code> making an adjust in the variable <code class="literal">mousePosition</code>, after the line:</p><div class="informalexample"><pre class="programlisting">Vector3 mousePosition = Event.current.mousePosition;</pre></div><p>Add the following line:</p><div class="informalexample"><pre class="programlisting">mousePosition = new Vector2(mousePosition.x, camera.pixelHeight - mousePosition.y);</pre></div><p>Try again; the grid coordinates work perfectly and now we are ready to deal with mouse events.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec47"></a>Capturing mouse events</h3></div></div></div><p>The next step is to capture the mouse events and trigger actions based on the current Level Creator<a id="id211" class="indexterm"></a> mode selected. Let's take a look at the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The View mode is already resolved and Unity takes care of that behavior (remember that this is the equivalent to selecting the View Transform Tool)</p></li><li style="list-style-type: disc"><p>The Paint and Erase modes will behave similarly to dragging a pen or an eraser over a canvas respectively, so in this case we want to capture the <code class="literal">OnClick()</code> and <code class="literal">OnDrag()</code> events</p></li><li style="list-style-type: disc"><p>The Edit mode requires selecting a piece to work, so in this case we want to capture just the <code class="literal">OnClick()</code> event</p></li></ul></div><p>First we will create three methods to handle the modes inside the <code class="literal">LevelInspector</code> class:</p><div class="informalexample"><pre class="programlisting">private void Paint(int col, int row) {
    Debug.LogFormat("Painting {0},{1}", col, row);
}
private void Erase(int col, int row) {
    Debug.LogFormat("Erasing {0},{1}", col, row);
}
private void Edit(int col, int row) {
    Debug.LogFormat("Editing {0},{1}", col, row);
}</pre></div><p>For each mode <a id="id212" class="indexterm"></a>we will require the grid coordinates as a parameter, and for now, we are going to print a log when any of them is used. Then we will update the <code class="literal">EventHandler</code> class to support the mouse events each mode requires, adding the following block of code at the end of this method:</p><div class="informalexample"><pre class="programlisting">    switch(_currentMode) {
    case Mode.Paint:
      if(Event.current.type == EventType.MouseDown ||
         Event.current.type == EventType.MouseDrag) {
        Paint(col, row);
      }
      break;
    case Mode.Edit:
      if(Event.current.type == EventType.MouseDown) {
        Edit(col, row);     
        }
        break;
      case Mode.Erase:
        if(Event.current.type == EventType.MouseDown || 
           Event.current.type == EventType.MouseDrag) {
          Erase(col, row);
        }
        break;
      case Mode.View:
      default:
        break;
      }</pre></div><p>From <code class="literal">Event.current</code>, we are using the property type to find which kind of event was triggered in the Scene View.</p><p>For each mode, we are comparing the variable <code class="literal">current</code> with the <code class="literal">MouseDown</code> or <code class="literal">MouseDrag</code> event types. For more types of events, you can check the <code class="literal">EventType</code> enum.</p><p>Save the <a id="id213" class="indexterm"></a>changes and wait for Unity to compile. Now create a level, select the game object, and then with the <span class="strong"><strong>Paint</strong></span> mode selected, click and drag the mouse over the Scene View. Let's take a look at the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781785281853/graphics/B04640_05_12.jpg" /></div><p>You will see the log of the <code class="literal">Paint</code> method any time you click or drag the mouse. The same happens with the <span class="strong"><strong>Erase</strong></span> mode, and in the case of the <span class="strong"><strong>Edit</strong></span> mode, this just happens when you click.</p><p>At this point, we have most of the interactions ready. It's time to work in the features that will make Level Creator capable of creating content. In the next section, we will implement the Level Creator modes.</p></div></div>