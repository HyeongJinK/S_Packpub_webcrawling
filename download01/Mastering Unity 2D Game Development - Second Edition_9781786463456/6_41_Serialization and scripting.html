<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec42"></a>Serialization and scripting</h2></div></div><hr /></div><p>To finish with our theory for this chapter, we need to cover serialization in Unity. Now, Unity already serializes just about everything from the editor to your scene automatically (with a few exceptions) when it saves and loads the scene.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note62"></a>Note</h3><p>There are a few fringe cases where Unity will not serialize some data. These cases have to do with the current limitations of the Mono 2 framework that Unity uses under the hood. A full explanation of what doesn't work can be found in the following article; note that it is very technical and includes a link to the error report in Unity where it is recorded: <a class="ulink" href="http://www.codingjargames.com/blog/2012/11/30/advanced-unity-serialization/" target="_blank">http://www.codingjargames.com/blog/2012/11/30/advanced-unity-serialization/</a>
</p></div><p>However, what if we want to actually use this serialization to our advantage within our game to save and load levels. We need bits of raw game data (or as we will continue with this later, saving conversations for our NPCs). To accomplish this, the best way is to use a Unity-inherited object named <code class="literal">ScriptableObject</code>.</p><p>The <code class="literal">ScriptableObject</code> entity allows you to save the data within the class that uses it for an <code class="literal">.asset</code> file in your project.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec75"></a>Saving and managing asset data</h3></div></div></div><p>To achieve this, we simply need to create a script (named <code class="literal">ScriptingObjects</code>) with some properties we want to serialize; then, we change its class inheritance from <code class="literal">MonoBehaviour</code> to <code class="literal">ScriptableObject</code> as follows:</p><pre class="programlisting">using UnityEngine; &#13;
public class ScriptingObjects : ScriptableObject { &#13;
  public Vector2[] MyPositions; &#13;
} &#13;
</pre><p>Great! So we have some serializable data. However, to use it in the editor, we need to create an option in the editor to create and save these assets for us. Create a new folder called<code class="literal"> Editor</code> under <code class="literal">Assets\Scripts</code>.</p><p>Create a new script named <code class="literal">PositionManager</code> in the <code class="literal">Assets\Scripts\Editor</code> folder, and replace its contents with the following code:</p><pre class="programlisting">using UnityEngine; &#13;
using UnityEditor; &#13;
 &#13;
public class PositionManager : MonoBehaviour &#13;
{ &#13;
  //Define a menu option in the editor to create the new asset &#13;
  [MenuItem("Assets/Create/PositionManager")] &#13;
  public static void CreateAsset() &#13;
  { &#13;
    //Create a new instance of our scriptable object &#13;
    ScriptingObjects positionManager = &#13;
      ScriptableObject.CreateInstance&lt;ScriptingObjects&gt;(); &#13;
 &#13;
    //Create a .asset file for our new object and save it &#13;
    AssetDatabase.CreateAsset(positionManager, &#13;
      "Assets/newPositionManager.asset"); &#13;
    AssetDatabase.SaveAssets(); &#13;
 &#13;
    //Now switch the inspector to our new object &#13;
    EditorUtility.FocusProjectWindow(); &#13;
    Selection.activeObject = positionManager; &#13;
  } &#13;
} &#13;
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note63"></a>Note</h3><p>Any script that uses the <code class="literal">UnityEditor</code> namespace has to be placed in a special <code class="literal">Editor</code> folder. This ensures that it is only packaged with the editor solution and not used in the deployed game. Game projects are not deployed with the editor.</p></div><p>There is a lot to explain about the preceding code, but it is all commented very well. In short, the code works as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>We define a menu option from where we will call our creation code</p></li><li style="list-style-type: disc"><p>We set up a new object that we want to serialize and create the file where it is to be stored</p></li><li style="list-style-type: disc"><p>We change the view of the editor to focus the inspector on the new object</p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note64"></a>Note</h3><p>If you create custom classes to be used in serialization, you must tag those classes with the <code class="literal">[System.Serializable]</code> attribute. Otherwise, Unity will not know that they are for serialization. We will cover more on this later in the implemented example.</p></div><p>If you return to Unity now and right-click on the <code class="literal">Asset</code> folder (or click on the <span class="strong"><strong>Create</strong></span> menu option in the <span class="strong"><strong>Project</strong></span> view), you will see the new menu option you just created, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_008.jpg" /></div><p>
</p><p>After clicking on it, you will see your new asset in the <span class="strong"><strong>Project</strong></span> view (in the location you saved it to, in this case, the root of the <code class="literal">Asset</code> folder) and the <span class="strong"><strong>Inspector</strong></span> view for your item, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_009.jpg" /></div><p>
</p><p>If we rename our new serialized object, give it some values, and save the scene or project, we will see the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_010.jpg" /></div><p>
</p><p>We go from the preceding screenshot to the following code stored in the <code class="literal">.asset</code> file (when opened from the <code class="literal">.asset</code> file generated in Unity from <span class="strong"><strong>File Explorer</strong></span>):</p><pre class="programlisting">%YAML 1.1 &#13;
%TAG !u! tag:unity3d.com,2011: &#13;
--- !u!114 &amp;11400000 &#13;
MonoBehaviour: &#13;
  m_ObjectHideFlags: 0 &#13;
  m_PrefabParentObject: {fileID: 0} &#13;
  m_PrefabInternal: {fileID: 0} &#13;
  m_GameObject: {fileID: 0} &#13;
  m_Enabled: 1 &#13;
  m_EditorHideFlags: 0 &#13;
  m_Script: {fileID: 11500000, guid: fa9c23f7a21df484a96802b68617f3b6, type: 3} &#13;
  m_Name: MyPositions1 &#13;
  m_EditorClassIdentifier:  &#13;
  MyPositions: &#13;
  - {x: 10, y: 10} &#13;
  - {x: 20, y: 20} &#13;
  - {x: 30, y: 30} &#13;
  - {x: 30, y: 30} &#13;
  - {x: 40, y: 40} &#13;
</pre><p>There is a fair amount of Unity information in the preceding code, but what is important is our serialized data at the bottom. So, if we wish, we can edit this file outside of the editor and it will be reimported next time you open Unity.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec76"></a>Using the serialized files in the editor</h3></div></div></div><p>Using the files in the editor is a very simple task. Simply create a property in any script using the type of your serialized asset and then assign a project asset in the editor.</p><p>For example, edit the <code class="literal">MessagingManager</code> script and add the following property:</p><pre class="programlisting">public ScriptingObjects MyWaypoints; &#13;
</pre><p>Then, the script will be exposed in the <span class="strong"><strong>Inspector</strong></span> pane and you can assign it normally, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_011.jpg" /></div><p>
</p><p>You will also be able to access the contents of the serialized object from that script as well.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note65"></a>Note</h3><p>You cannot edit the contents of the serialized file in the assigned property by default. This is only achievable using a custom property inspector. However, it is still editable in the editor by opening the <code class="literal">Asset</code> folder.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec77"></a>Accessing the .asset files in the code</h3></div></div></div><p>Now, if you don't want to assign the asset through the editor, there is a way to just load the <code class="literal">.asset</code> file directly from the project.</p><p>Firstly, to do this, you will need to store your <code class="literal">.asset</code> files in a special folder named <code class="literal">Resources</code> in your <code class="literal">Asset</code> folder. You can read them there directly using Unity's own resource functions once.</p><p>As an example, open the <code class="literal">PositionManager</code> script and add the following function:</p><pre class="programlisting">public static PositionManager ReadPositionsFromAsset(string Name) &#13;
{ &#13;
  string path = "/"; &#13;
 &#13;
  object o = Resources.Load(path + Name); &#13;
  PositionManager retrievedPositions = (PositionManager)o; &#13;
  return retrievedPositions; &#13;
} &#13;
</pre><p>This function, which is available from anywhere as it is static, will perform the following tasks:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Using the <code class="literal">Name</code> parameter, it will read the <code class="literal">.asset</code> file from the root of the <code class="literal">Resources</code> folder</p></li><li style="list-style-type: disc"><p>It will convert the retrieved file to the correct object type</p></li><li style="list-style-type: disc"><p>It will return the deserialized object to the calling function</p></li></ul></div><p>Now you can call up the data contained within your <code class="literal">.asset</code> file anywhere in your game project.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip66"></a>Tip</h3><p>The same kind of pattern can also be used to download the <code class="literal">.asset</code> files from the Web for your project to add DLC or expand the levels of your game. A word to the wise, though; if you do go down this route, be sure to compress and encrypt your assets that are meant for downloading to protect your IP.</p><p>Also, if you have any dependent files, such as images, be sure to download them separately.</p><p>However, to use the downloaded files as assets in your scene, you will require them to be packaged as asset bundles.</p></div></div></div>