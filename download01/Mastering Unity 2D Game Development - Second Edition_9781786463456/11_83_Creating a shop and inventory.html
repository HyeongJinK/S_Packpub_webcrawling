<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch11lvl1sec79"></a>Creating a shop and inventory</h2></div></div><hr /></div><p>As with other areas in this book, we will just keep things simple when implementing the sample project. You can always extend or replace it later if you wish.</p><p>We will also look at two slightly different approaches: using a scene for the shop and a layer system for the inventory.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec133"></a>Gathering shop assets</h3></div></div></div><p>The shop will contain various healing items for the player to purchase. To create the shop, we'll just create a new scene to keep things simple as we expect to enter a shop and leave it when we are done.</p><p>I altered the assets I used to make the HUD for the battle system to create a new menu that will be used for the shop. I also added a talk bubble, which we will use for the shopkeep to speak to us and show us what we are buying. We'll layout the individual buttons and slots within Unity. The following screenshot shows the buttons, bubbles, and other things that we are going to use:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_007.jpg" /></div><p>
</p><p>For items to show in the shop, I turned back to Kenney on OpenGamAart.Org (who made the awesome Hexagon Pack we used for the map) and got the <span class="strong"><strong>Generic Items</strong></span> set at <a class="ulink" href="http://opengameart.org/content/generic-items" target="_blank">http://opengameart.org/content/generic-items</a>. Instead of using the provided sprite sheet, I combined the <code class="literal">.png</code> files of the healing items I planned on using into one sprite sheet to make it easier to sort. I also used Photoshop to add a slight drop shadow to each item so that the items will be easier to see when implemented.</p><p>The following screenshot shows the sprite sheet containing the healing items:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_008.jpg" /></div><p>
</p><p>This gives us a nice array of healing items. We will only use a few of these for the shop, but the others would be great to use in the hospital.</p><p>We're also going to use the sprite sheet for the <code class="literal">Shopkeep</code> that we imported in <a class="link" href="#" linkend="ch06">Chapter 6</a>, <span class="emphasis"><em>NPCs and Interactions</em></span>, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_009.jpg" /></div><p>
</p><p>Go ahead and import <code class="literal">Inventory.png</code> into the <code class="literal">Assets/Sprites/UI</code> folder and <code class="literal">healing_items.png</code> into the <code class="literal">Assets/Sprites/Props</code> folder. Change their <span class="strong"><strong>Sprite Mode</strong></span> to <span class="strong"><strong>Multiple</strong></span> and automatically slice them. If you did not bring the <code class="literal">Shopkeep.png</code> image into the project in <a class="link" href="#" linkend="ch06">Chapter 6</a>, <span class="emphasis"><em>NPCs and Interactions</em></span>, import it now with a <span class="strong"><strong>Sprite Mode</strong></span> of <span class="strong"><strong>Multiple</strong></span> and automatically slice it.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec134"></a>Building the shop scene</h3></div></div></div><p>In <a class="link" href="#" linkend="ch02">Chapter 2</a>, <span class="emphasis"><em>Building your Project and Character</em></span>, we made a scene named <code class="literal">Shop</code>; open it to view the blank scene.</p><p>We will build out the entire shop scene using the UI system. You should be sufficiently versed in setting up images and panels by now to create the following in your scene:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_010.jpg" /></div><p>
</p><p>We're now going to change the background color using the camera setting because right now it is the generic blue, as shown in the following screenshot, and leaving it as it is just shows that we put no thought into the scene's design:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_011.jpg" /></div><p>
</p><p>We'll make the background color black by selecting the <span class="strong"><strong>Main Camera</strong></span> in the <span class="strong"><strong>Hierarchy</strong></span> and changing the <span class="strong"><strong>Background</strong></span> color to black, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_012.jpg" /></div><p>
</p><p>We need to add some text, a back button, and aÂ buy button. Add the text and buttons, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_013.jpg" /></div><p>
</p><p>We're just going to add a few slots for the inventory items. However, we will use a panel to contain all of the inventory items. This will allow us to easily add more of them and even add a scroll-bar if necessary.</p><p>Right-click on the <code class="literal">Inventory</code>Panel in the <span class="strong"><strong>Hierarchy</strong></span> and select <span class="strong"><strong>UI</strong></span> | <span class="strong"><strong>Panel</strong></span>. Rename this panel <code class="literal">Items</code>. Position it so that it takes up the area between the buttons and the <code class="literal">Inventory</code> text, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_014.jpg" /></div><p>
</p><p>Add a UI Image as a child of the <code class="literal">Items</code> panel and name it <code class="literal">Slot</code>. Give it the properties shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_015.jpg" /></div><p>
</p><p>Now add a UI Image as a child of <code class="literal">Slot</code> and name it <span class="strong"><strong>Item Image</strong></span>. Give it the properties shown in the following screenshot, making sure that <span class="strong"><strong>Preserve Aspect</strong></span> is selected:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_016.jpg" /></div><p>
</p><p>Lastly, add a UI Text object as a child of <code class="literal">Slot</code> and give it the properties shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_017.jpg" /></div><p>
</p><p>Duplicate <code class="literal">Slot</code> three times by selecting it in the Hierarchy and hitting <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>D</em></span>, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_018.jpg" /></div><p>
</p><p>All four of these slots will now appear right on top of each other. To make them line up appropriately, we will add a <span class="strong"><strong>Vertical Layout Group</strong></span> component to the <code class="literal">Items</code> Panel. To do so, select the <code class="literal">Items</code> panel from the <span class="strong"><strong>Hierarchy</strong></span> and select <span class="strong"><strong>Add Component</strong></span>. Next select <span class="strong"><strong>Layout</strong></span> | <span class="strong"><strong>Vertical Layout Group</strong></span> and deselect <span class="strong"><strong>Child Force Expand Height</strong></span> from the <span class="strong"><strong>Vertical Layout Group</strong></span> component.</p><p>Doing this will actually mess up the alignment of the image and text objects that are children of each of the <code class="literal">Slots</code>. This is because the <span class="strong"><strong>Vertical Alignment Group</strong></span> has made the slots taller and their child images are stretching appropriately. The reason why the slots don't look taller is we selected <span class="strong"><strong>Preserve Aspect Ratio</strong></span> on the slot's image, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_019.jpg" /></div><p>
</p><p>To fix this, we will simply change the height of the <code class="literal">Items</code> panel. The result is shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_020.jpg" /></div><p>
</p><p>Now, if we wanted to add more inventory items, all we would have to do is duplicate the <span class="strong"><strong>Slot</strong></span> again and change the height of the <span class="strong"><strong>Items</strong></span> panel, and everything would automatically align.</p><p>The last thing we are going to do to set up our scene is add some elements to the Shopkeep's dialog bubble. In an ode to <span class="strong"><strong>Resident Evil 4</strong></span>, he will ask <span class="emphasis"><em>What are you buying?</em></span> when no item is selected. Then, when an item is selected, the image of the selected item will appear in his dialog bubble.</p><p>To achieve this, add an image as a child of the <code class="literal">Talk Bubble</code> and name it <code class="literal">Item Choice Image</code>
<span class="strong"><strong>;</strong></span> make sure <span class="strong"><strong>Preserve Aspect</strong></span> is selected, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_021.jpg" /></div><p>
</p><p>Now, add the following text as a child of <code class="literal">Talk Bubble</code>. The text should appear below the Image in the <span class="strong"><strong>Hierarchy</strong></span> and in front of the Image in the Scene, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_022.jpg" /></div><p>
</p><p>When you have put all the GameObjects into the scene, you should have something like the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_023.jpg" /></div><p>
</p><p>We will add all of the inventory items, their names, and the Shopkeep's reference to them through code.</p><p>With the layout in place, we need something for the screen to use. So, let's add some items.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec135"></a>Creating inventory items</h3></div></div></div><p>As with the conversation items we created in <a class="link" href="#" linkend="ch06">Chapter 6</a>, <span class="emphasis"><em>NPCs and Interactions</em></span>, we want to be able to simply manage items that can be used or bought in our game.</p><p>First, we need a scriptable object to describe our inventory items. So, create a new script in <code class="literal">Assets\Scripts\Classes</code> named <code class="literal">InventoryItem</code> and populate it with the following structure:</p><pre class="programlisting">using UnityEngine; &#13;
using System.Collections; &#13;
 &#13;
public class InventoryItem : ScriptableObject &#13;
{ &#13;
  public Sprite itemImage; &#13;
  public string itemName; &#13;
  public int cost; &#13;
  public int strength; &#13;
} &#13;
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note121"></a>Note</h3><p>Note that we haven't implemented all of the properties we described earlier, just a subset as an example. You can add more if you wish.</p></div><p>Now that we have our scriptable object, we need an editor script to create our inventory items. So, create another script named <code class="literal">InventoryItemAssetCreator</code> in the <code class="literal">Assets\Scripts\Editor</code> folder and populate it with the following structure (note that we are again using our generic utility class to make this very easy to implement):</p><pre class="programlisting">using UnityEngine; &#13;
using UnityEditor; &#13;
 &#13;
public class InventoryItemAssetCreator : MonoBehaviour { &#13;
 &#13;
  [MenuItem("Assets/Create/Inventory Item")] &#13;
  public static void CreateAsset() &#13;
  { &#13;
    CustomAssetUtility.CreateAsset&lt;InventoryItem&gt;(); &#13;
  } &#13;
} &#13;
</pre><p>With this in place, we can now create some inventory items. Create a new folder named <code class="literal">Inventory Items</code> in the <code class="literal">Assets\Resources folder</code>, navigate to that folder, and create a new <code class="literal">InventoryItem</code> class from the <span class="strong"><strong>Create</strong></span> menu (right-click on <span class="strong"><strong>Create</strong></span> or use the <code class="literal">Project</code> folder window's <span class="strong"><strong>Create</strong></span> menu option).</p><p>With the <code class="literal">New InventoryItem.asset</code> created, we can configure our first item. Rename the asset to <code class="literal">RedCapsule</code> and then configure its properties, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_024.jpg" /></div><p>
</p><p>You can configure the properties using the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Set the <span class="strong"><strong>Sprite</strong></span> property to the red capsule image from the <code class="literal">healing_items</code> Sprite Sheet (<span class="strong"><strong>healing_items_0</strong></span>).</p></li><li><p>Give it a name through the <span class="strong"><strong>Item Name</strong></span> field.</p></li><li><p>Set <span class="strong"><strong>Cost</strong></span> to 0 to denote it's a free item (since we don't have a monetary system yet).</p></li><li><p>Set <span class="strong"><strong>Strength</strong></span> to <code class="literal">10</code> so that it will heal 10 HP points.</p></li></ol></div><p>Create three more <code class="literal">InventoryItems</code> in the same manner. I created <code class="literal">BlueCapsule</code>, <code class="literal">Bandaid</code>, and <code class="literal">MedPack</code>, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_025.jpg" /></div><p>
</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec136"></a>Managing the shop</h3></div></div></div><p>Now that we have our shop interface and some stock we can put in it, it's time to bring them together.</p><p>First, we need to set up a shop manager who looks after the day-to-day running of the shop, and then we will add shelves to the shop to manage where we can put the stock.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note122"></a>Note</h3><p>We will create two scripts, <code class="literal">ShopSlot</code> and <code class="literal">ShopManager</code>, in this section. The <code class="literal">ShopSlot</code> and <code class="literal">ShopManager</code> scripts will depend on each other, so we need to create them together. Until both are complete, you will most likely see errors; just keep this in mind as we progress.</p><p>The situation always applies when you are creating codependent classes.</p></div><p>First, we need the shop manager itself. To keep things neat, create a new folder named <code class="literal">Shop</code> in the project's <code class="literal">Assets\Scripts</code> folder and then create a new script named <code class="literal">ShopManager</code> in the <code class="literal">Shop</code> folder. This just ensures that any script related to shopping is stored here if you want to expand it later. The manager is only used in this one scene, so we don't need to make it a singleton.</p><p>To start off, we will just add some parameters so that we can control the shop we are creating and set it up as follows:</p><pre class="programlisting">using UnityEngine; &#13;
using UnityEngine.UI; &#13;
 &#13;
public class ShopManager : MonoBehaviour { &#13;
 &#13;
  public Image PurchaseItemDisplay; &#13;
  public ShopSlot[] ItemSlots; &#13;
  public InventoryItem[] ShopItems; &#13;
  private static ShopSlot SelectedShopSlot; &#13;
 &#13;
  private int nextSlotIndex = 0; &#13;
  public Text shopKeepertext; &#13;
} &#13;
</pre><p>When the player enters the shop's screen, we want to be able to display the current selection of wares. So, when <code class="literal">ShopManager</code> starts, we need to configure those items as follows:</p><pre class="programlisting">void Start () { &#13;
  if (ItemSlots.Length &gt; 0 &amp;&amp; ShopItems.Length &gt; 0) &#13;
  { &#13;
    for (int i = 0; i &lt; ShopItems.Length; i++) &#13;
    { &#13;
      if (nextSlotIndex &gt; ItemSlots.Length) break; &#13;
      ItemSlots[nextSlotIndex].AddShopItem(ShopItems[i]); &#13;
      ItemSlots[nextSlotIndex].Manager = this; &#13;
      nextSlotIndex++; &#13;
    } &#13;
  } &#13;
} &#13;
</pre><p>The preceding code just loops through all the available slots in the shop and picks out items from its inventory to place in them, ensuring we only stock as many items as the shop can handle.</p><p>You will notice that the last function actually has an error. This is because we did not add the actions/behaviors for the <code class="literal">ShopSlot</code> script. We will fix that shortly.</p><p>Next, we need some helper functions to represent the actions/behaviors that the shop is capable of performing; first, we add the ability to select an item for purchase using the following function:</p><pre class="programlisting">public void SetShopSelectedItem(ShopSlot slot) &#13;
{ &#13;
  SelectedShopSlot = slot; &#13;
  PurchaseItemDisplay.sprite = slot.Item.itemImage; &#13;
  shopKeeperText.text=" "; &#13;
} &#13;
</pre><p>Finally, we add the ability to purchase the currently selected shop item using the following function:</p><pre class="programlisting">public static void PurchaseSelectedItem() &#13;
{ &#13;
  SelectedShopSlot.PurchaseItem(); &#13;
} &#13;
</pre><p>Each of the preceding functions is self-contained and controls each step necessary to perform each action. They do so by enabling or disabling screen elements, such as <code class="literal">PurchasingSection</code>, to perform actions on dependent objects such as shop slots.</p><p>You will note that this last function is also set as <code class="literal">static</code>. This is to enable it to be accessed from anywhere in the code without referencing it or performing <code class="literal">GetComponent</code> for the <code class="literal">ShopManager</code> script.</p><p>As stated in the previous sections, it might seem as of you could make everything static and avoid using <code class="literal">GetComponent</code> altogether. However, using statics has certain overheads and can lead to messy and hard-to-diagnose code; this technique should not be overly used. If in doubt, don't use it unless necessary.</p><p>With <code class="literal">ShopManager</code> set up, we can now create the missing definition for <code class="literal">ShopSlot</code>. This will define slots in the shop that remember what is being stored on the shelf. Create a new script in the <code class="literal">Assets\Scripts\Shop</code> folder and name it <code class="literal">ShopSlot</code>, replacing its contents with the following code:</p><pre class="programlisting">using UnityEngine; &#13;
using UnityEngine.UI; &#13;
 &#13;
public class ShopSlot : MonoBehaviour { &#13;
 &#13;
  public InventoryItem Item; &#13;
  public ShopManager Manager; &#13;
  Image image; &#13;
  Text name; &#13;
 &#13;
} &#13;
</pre><p>Now, to add other functions for the shop slots that will be used by the manager, add the following functions to the <code class="literal">ShopSlot</code> script:</p><pre class="programlisting">public void AddShopItem(InventoryItem item) &#13;
{ &#13;
   image = transform.GetChild(0).GetComponent&lt;Image&gt;(); &#13;
 &#13;
   image.sprite = item.itemImage; &#13;
   Item = item;  &#13;
 &#13;
   name=transform.GetChild(1).GetComponent&lt;Text&gt;(); &#13;
   name.text=item.itemName;  &#13;
} &#13;
 &#13;
public void PurchaseItem() &#13;
{ &#13;
  //We'll do some stuff here later to add it to our inventory  &#13;
} &#13;
</pre><p>The first function enables the ability to add an inventory item to the current slot and display it, and the second function controls how an item is purchased. Again, each function is distinct and is just related to the task that it is to perform. Wherever possible, you should follow this pattern, as it will make maintaining or extending your game much easier later.</p><p>Finally, we need to add one last piece of code in order to enable the player to click on items in the shop slots; so, add the following function to the <code class="literal">ShopSlots</code> script:</p><pre class="programlisting">public void ItemSelected() &#13;
{ &#13;
  if (Item != null) &#13;
  { &#13;
    Manager.SetShopSelectedItem(this); &#13;
  } &#13;
} &#13;
</pre><p>Now that we can stock our shop and purchase items from it, we just need the ability for users to buy items when selected, so add the following function to the <code class="literal">ShopManager</code> script:</p><pre class="programlisting"> public void ConfirmPurchase(){ &#13;
    PurchaseSelectedItem(); &#13;
   shopKeeperText.text="Thanks!"; &#13;
 }  &#13;
</pre><p>The preceding code simply calls the static <code class="literal">Purchasing</code> function we created in the <code class="literal">ShopManager</code> script earlier to buy an item. We will tie these last two functions to our buttons and inventory items shortly.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec137"></a>Updating the player inventory definition</h3></div></div></div><p>Now that we have a definition for <code class="literal">InventoryItem</code>, we can update the <code class="literal">Player</code> class so that the player can carry the correct item. So, open the <code class="literal">Player</code> class under <code class="literal">Assets\Scripts\Classes</code> and update the script to use the new <code class="literal">InventoryItem</code> class instead of a string as follows:</p><pre class="programlisting">using System.Collections.Generic; &#13;
public class Player : Entity &#13;
{ &#13;
  public List&lt;InventoryItem&gt; Inventory = new List&lt;InventoryItem&gt;(); &#13;
  public string[] Skills; &#13;
  public int Money; &#13;
} &#13;
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec138"></a>Stocking the shop</h3></div></div></div><p>With all our scripts in place, let's return to the shop scene, start applying them, and, finally, get some stock displayed on the shelves.</p><p>So first, let's attach the following scripts:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Attach the <code class="literal">ShopManager</code> script to the <code class="literal">Inventory</code> GameObject</p></li><li style="list-style-type: disc"><p>Attach the <code class="literal">ShopSlot</code> script to each <span class="strong"><strong>Slot</strong></span> in the shop</p></li></ul></div><p>Now, our shop is ready to receive its owner and some inventory items to stock. So, select the <code class="literal">Inventory</code> GameObject; once you do this, you should see the following configuration options in the <span class="strong"><strong>Inspector</strong></span> pane:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_026.jpg" /></div><p>
</p><p>I've preconfigured <span class="strong"><strong>Shop Manager </strong></span>as an example. So, let's walk through the steps that are available:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Drag the <code class="literal">Item Choice Image</code> to the <span class="strong"><strong>Purchase Item Display</strong></span> slot.</p></li><li><p>Next, set the <span class="strong"><strong>Item Slots</strong></span> pane's <span class="strong"><strong>Size</strong></span> to <code class="literal">4</code> and attached each of the available <code class="literal">Slots</code> in the shop by dragging them from the <span class="strong"><strong>Hierarchy</strong></span> into the <span class="strong"><strong>Inspector</strong></span> pane. You can also achieve this by using the circle icon to the right of each element and finding the <code class="literal">Slot</code> in the scene. Note that you cannot drag slots into this list if you do not have the <code class="literal">ShopSlot</code> script attached to them.</p></li><li><p>Finally, set the <span class="strong"><strong>Shop Items</strong></span> pane's <span class="strong"><strong>Size</strong></span> to <code class="literal">4</code> and dragged the four <code class="literal">Inventory Items</code> we created earlier in the <code class="literal">Assets\Resources\InventoryItems</code> folder into each element of the <span class="strong"><strong>Shop Items</strong></span> array. The order in which you drag them into the array is the order in which they will appear on the screen.</p></li></ol></div><p>If you now run the scene at this point, you should see the following:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_027.jpg" /></div><p>
</p><p>Now we need to get the buttons working appropriately and allow the player to select the items.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec139"></a>Linking up the buttons</h3></div></div></div><p>We created all of the slots as images, but we want them to perform as buttons. So, we can easily add a button script to each of the slots. Select all four of the slots and add <span class="strong"><strong>Commponent</strong></span> | <span class="strong"><strong>UI</strong></span> | <span class="strong"><strong>Button</strong></span>.</p><p>We want each of these slots to perform the <code class="literal">ItemSelected()</code> function that is in the <code class="literal">ShopSlot</code> script attached to each of them. For each slot's <code class="literal">Button</code> script, set up the <code class="literal">On Click()</code> event, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_028.jpg" /></div><p>
</p><p>Make sure you drag the correct <code class="literal">Slot</code> to each.</p><p>Now, when you select an item, it should appear in the ShopKeep's dialog bubble, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_029.jpg" /></div><p>
</p><p>The last button we need to link up is the <code class="literal">Buy Button</code>. We want it to perform the <code class="literal">ConfirmPurchase()</code> function within the <code class="literal">ShopManager</code> script. So, add the function to the button's <code class="literal">On Click()</code> functionality, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_030.jpg" /></div><p>
</p><p>Now when you click the <code class="literal">Buy Button</code> after selecting an item, the Shopkeep will say <span class="emphasis"><em>Thanks!</em></span> over the item to affirm that it has been purchased. Soon, we'll allow this to also add the item to our inventory.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec140"></a>Turning off the Buy Button</h3></div></div></div><p>Currently, there is one big problem with our shop. If you select the <code class="literal">Buy Button</code> before you select an object, an error message will appear. It doesn't break the game, but it isn't a good idea to let error messages (even if your game continues to run) show up. The best way to deal with this is to disable the <code class="literal">Buy Button</code> until after an item has been selected because, after all, it doesn't really make sense for this button to be there if the player hasn't selected anything.</p><p>To accomplish this, we will add a <span class="strong"><strong>Canvas Group</strong></span> to our <code class="literal">Buy Button</code> by selecting <span class="strong"><strong>Add Component</strong></span> | <span class="strong"><strong>Layout</strong></span> | <span class="strong"><strong>Canvas Group</strong></span> from the <span class="strong"><strong>Inspector</strong></span>.</p><p>Change the <span class="strong"><strong>Canvas Group</strong></span> values as follows:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_031.jpg" /></div><p>
</p><p>The <code class="literal">Buy Button</code> will now no longer be visible in the scene. Add the following variable to the <code class="literal">ShopSlot</code> script:</p><pre class="programlisting">public CanvasGroup buyButton;  &#13;
</pre><p>And update the <code class="literal">ItemSelected()</code> function as follows:</p><pre class="programlisting">public void ItemSelected() &#13;
    { &#13;
        if (Item != null) &#13;
        { &#13;
            Manager.SetShopSelectedItem(this); &#13;
 &#13;
            if(buyButton.alpha==0){ &#13;
                buyButton.alpha=1; &#13;
                buyButton.interactable=true; &#13;
                buyButton.blocksRaycasts=true; &#13;
            } &#13;
        } &#13;
    }  &#13;
</pre><p>Now drag the <code class="literal">Buy Button</code> into the <span class="strong"><strong>Buy Button</strong></span> variable for each of the <code class="literal">ShopSlot</code> scripts attached to the <span class="strong"><strong>Slot</strong></span>, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_032.jpg" /></div><p>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note123"></a>Note</h3><p>You can do this for all four slots at once by selecting all of the <code class="literal">Slots</code> in the <span class="strong"><strong>Hierarchy</strong></span> while holding <span class="emphasis"><em>Ctrl</em></span>.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec141"></a>Entering the shop</h3></div></div></div><p>We can buy items from the shop but we can't actually enter the <code class="literal">Shop</code> scene or leave the <code class="literal">Shop</code> scene. As we did in <a class="link" href="#" linkend="ch07">Chapter 7</a>, <span class="emphasis"><em>The World Map</em></span>, we just need to add trigger colliders in the <code class="literal">Town</code> where the user can enter the <code class="literal">Shop</code>. To do this, return to the <code class="literal">Town</code> scene.</p><p>Add a new empty GameObject named <code class="literal">Shop</code> as a child of the <span class="strong"><strong>WorldBounds </strong></span>GameObject (because it takes us out of the scene) and add a <span class="strong"><strong>Box Collider 2D</strong></span> component (set as a trigger), as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_033.jpg" /></div><p>
</p><p>The collider just needs to be shaped or scaled enough so that our 2D character will collide with it when she passes in front of the shop.</p><p>Attach the <code class="literal">NavigationPrompt</code> script to the <code class="literal">Shop</code>.</p><p>Trying to enter the shop isn't going to get us very far if the game doesn't know it exists, so add the <code class="literal">Shop</code> scene to the project's <span class="strong"><strong>Build Settings</strong></span>.</p><p>Also, update the <code class="literal">NavigationManager</code> script to include a new <code class="literal">Route</code> asset for the shop as follows:</p><pre class="programlisting">public static Dictionary&lt;string, Route&gt; RouteInformation = new &#13;
  Dictionary&lt;string, Route&gt;() { &#13;
     { "Overworld", new Route{RouteDescription="The big bad world", &#13;
         CanTravel=true}}, &#13;
        { "Construction", new Route{RouteDescription="The construction area", &#13;
            CanTravel=false}}, &#13;
        { "Town", new Route{RouteDescription="The main town", CanTravel=true}}, &#13;
        { "Campsite", new Route{RouteDescription="The campsite", &#13;
            CanTravel=false}}, &#13;
        { "Shop", new Route{RouteDescription="The town shop", CanTravel=true}}, &#13;
    };  &#13;
</pre><p>Finally, to ensure that we navigate to the new <code class="literal">Shop</code> scene, we need to add a new tag named <code class="literal">Shop</code> and assign it to the new <code class="literal">Shop</code> GameObject, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_034.jpg" /></div><p>
</p><p>After you add the <span class="strong"><strong>Shop</strong></span> tag, be sure to assign it to the shop.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec142"></a>Leaving the shop</h3></div></div></div><p>The hero can purchase items from the shop (she doesn't get to keep them just yet), but she is stuck in the shop, the doors and windows are barred, and the owner has a very stern face.</p><p>To allow the hero to leave, we just need to call the <code class="literal">NavigationManager</code> script. Instead of making a whole new script for this, I will just add it to the <code class="literal">ShopMananger</code> script.</p><p>Add the following function at the end of the <code class="literal">ShopManager</code> script:</p><pre class="programlisting">public void LeaveTheShop(){ &#13;
   NavigationManager.NavigateTo("Town"); &#13;
}  &#13;
</pre><p>Now just have the preceding function called from the <span class="strong"><strong>Back</strong></span> button when clicked, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_035.jpg" /></div><p>
</p><p>The hero should now be sent to the middle of town. Let's fix it so that she returns through the front door instead of returning to the middle of town.</p><p>Using the same method we used in <a class="link" href="#" linkend="ch08">Chapter 8</a>, <span class="emphasis"><em>Encountering Enemies and Running Away</em></span>, to get character to spawn in the correct location, we need to update the <code class="literal">StartingPosition</code> on the <code class="literal">NavigationPrompt</code> script that is attached to the <code class="literal">Shop</code>, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_036.jpg" /></div><p>
</p><p>Now the player will spawn in front of the shop when leaving it.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec143"></a>Managing your inventory</h3></div></div></div><p>Now let's put an inventory window in our scene so that the player can view what he/she has purchased.</p><p>In the <code class="literal">Town</code> scene, create a new UI Canvas and name it <code class="literal">PopUpWindows</code>. Add a panel named <code class="literal">InventoryPanel</code> as a child of the new canvas with a width and height of <code class="literal">300</code> and give it theÂ  <code class="literal">Inventory_1</code> background image. Give it a text <code class="literal">Title</code> and add a <code class="literal">Close</code> button, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_037.jpg" /></div><p>
</p><p>Add another panel as a child of <code class="literal">InventoryPanel</code> and name it <code class="literal">InventoryList</code>. Adjust its size so that it only takes up the bottom portion of <code class="literal">InventoryPanel</code>, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_038.jpg" /></div><p>
</p><p>Now we'll give it the ability to pop up and close in the scene by adding a new button to access it. Add a new button to the <code class="literal">PopUp</code> Canvas and call it <code class="literal">ShowInventory</code>. Place it at the bottom corner of the canvas, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_039.jpg" /></div><p>
</p><p>Now add a Canvas Group to the <code class="literal">InventoryPanel</code>. Set the <span class="strong"><strong>Alpha</strong></span> to 0 and deselect <span class="strong"><strong>Interactable</strong></span> and <span class="strong"><strong>Blocks Raycasts</strong></span>.</p><p>In <a class="link" href="#" linkend="ch09">Chapter 9</a>, <span class="emphasis"><em>Getting Ready to Fight</em></span>, we created a <code class="literal">PopUpMenu</code> script. Attach this to the <code class="literal">InventoryPanel</code> and assign <code class="literal">InventoryPanel</code> to the <span class="strong"><strong>PopUp</strong></span> slot.</p><p>Set up the <code class="literal">On Click()</code> events for the <code class="literal">ShowInventory</code> and <code class="literal">Close</code> buttons to run the <code class="literal">EnableTheMenu</code> and <code class="literal">DisableTheMenu</code> functions from the <code class="literal">PopUpMenu</code> script, respectively.</p><p>Now the inventory menu should open and close appropriately.</p><p>We are going to let the inventory populate within the panel area based on what the player purchases. We also want this to automatically display in a grid. So, add the <span class="strong"><strong>Grid Layout Group</strong></span> component to the <code class="literal">InventoryList</code> panel by selecting <span class="strong"><strong>Add Component</strong></span> | <span class="strong"><strong>Layout</strong></span> | <span class="strong"><strong>Grid Layout Group</strong></span> from the Inspector, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_040.jpg" /></div><p>
</p><p>Return the <span class="strong"><strong>Alpha</strong></span> of the <code class="literal">InventoryPanel</code> to <code class="literal">1</code> so that you can see what you are doing, for now.</p><p>Add a button as a child of <code class="literal">InventoryList</code> and delete its text component. Name this button <code class="literal">InventoryItemPrefab</code>. Set its anchor and pivot to the top left corner, as show in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_041.jpg" /></div><p>
</p><p>Save this button as a prefab and delete it from the scene.</p><p>Create a new C# script in the <code class="literal">Assets/Scripts</code> folder, name it <code class="literal">PlayerIventoryDisplay</code>, and populate it with the following code:</p><pre class="programlisting">using UnityEngine; &#13;
using UnityEngine.UI; &#13;
 &#13;
public class PlayerInventoryDisplay : MonoBehaviour{ &#13;
 &#13;
public Button invPrefab; &#13;
 &#13;
    void Start() { &#13;
 &#13;
        foreach (var item in GameState.currentPlayer.Inventory) &#13;
        { &#13;
            Button inventoryChild = (Button) &#13;
              Instantiate(invPrefab,Vector3.zero, Quaternion.identity); &#13;
            inventoryChild.transform.parent=transform; &#13;
            inventoryChild.GetComponent&lt;Image&gt;().sprite=item.itemImage; &#13;
        } &#13;
    } &#13;
}  &#13;
</pre><p>The preceding code loops through all the items in the player's inventory (if there are any) and displays them as buttons.</p><p>Attach the preceding code to the <code class="literal">InventoryList</code> panel and add <code class="literal">InventoryItemPrefab</code> to the <span class="strong"><strong>Inv Prefab</strong></span> slot.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec144"></a>Adding objects to the player's inventory</h3></div></div></div><p>Right now, if the player character is holding inventory items, they display in the inventory. But, she doesn't actually have the ability to hold any items.</p><p>Open up the <code class="literal">Player</code> script under the <code class="literal">Assets\Scripts\Classes</code> folder and add the following additional function:</p><pre class="programlisting">public void AddinventoryItem(InventoryItem item){ &#13;
    Inventory.Add(item); &#13;
}  &#13;
</pre><p>Now the player character will have a list of all objects that she is holding.</p><p>Now that we have our helper function to control a player's <span class="strong"><strong>Inventory</strong></span> property, we just need to update the <code class="literal">ShopSlot</code> script we created earlier to use the following new function:</p><pre class="programlisting">public void PurchaseItem() &#13;
{ &#13;
  GameState.CurrentPlayer.AddinventoryItem(Item); &#13;
} &#13;
</pre><p>Now try playing the game and entering the shop. Buy some stuff, return to the town menu, and view all of your fancy items, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_11_042.jpg" /></div><p>
</p><p>Now you have the basic inventory set up and each item is a button. You can easily have these buttons add health to the player and remove them from the list when used. The nice thing about using the <span class="strong"><strong>Grid Layout Group</strong></span> is that the items will automatically lay out appropriately.</p><p>There is one issue with the current layout, if you exceed the number of items that can be held in the specified space, they will overflow the menu. You can fix this by adding a scroll bar and also by having repeated inventory items group together.</p><p>Remember, in <a class="link" href="#" linkend="ch09">Chapter 9</a>, <span class="emphasis"><em>Getting Ready to Fight</em></span>, we had a button for items in our HUD. Save the <code class="literal">PopUp</code> canvas as a prefab and bring it in to the <code class="literal">Battle</code> scene. Then link the <code class="literal">InventoryPanel</code> to the <code class="literal">Item</code> button in the HUD the same way you did in the <code class="literal">Town</code> scene. When you bring the <code class="literal">Popup</code> canvas prefab in to the <code class="literal">Battle</code> scene, be sure to delete the <code class="literal">ShowInventory</code> button, as it conflicts with the button already available in the HUD.</p></div></div>