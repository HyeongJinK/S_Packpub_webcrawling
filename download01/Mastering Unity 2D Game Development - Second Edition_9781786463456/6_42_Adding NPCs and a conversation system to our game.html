<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec43"></a>Adding NPCs and a conversation system to our game</h2></div></div><hr /></div><p>Right, after all of that <span class="emphasis"><em>brain input</em></span>, let's start applying it to our game. In this chapter, we are aiming to add an NPC to our scene that will interact with the player.</p><p>Before moving forward, we should also do with a little tidying up of our <code class="literal">Scripts</code> folder, since we are generating a lot more content now. To do this, perform the following steps:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Under <code class="literal">Assets\Scripts</code>, create three new folders: <code class="literal">Classes</code>, <code class="literal">Messaging</code>, and<code class="literal"> Navigation</code>.</p></li><li style="list-style-type: disc"><p>Copy the <code class="literal">Entity</code> and <code class="literal">Player</code> scripts to the new <code class="literal">Classes</code> folder or create them if you haven't already.</p></li><li style="list-style-type: disc"><p>You may delete all of the files created in this chapter (or place them in an <code class="literal">Examples</code> folder) except <code class="literal">MessagingManager.cs</code>, <code class="literal">MessagingClientBroadcast.cs</code>, and <code class="literal">MessagingClientReceiver.cs</code> as we will use those shortly.</p></li><li style="list-style-type: disc"><p>If you created the <code class="literal">Messaging</code> scripts, move the <code class="literal">Messaging</code> to the <code class="literal">Messaging</code> folder, and likewise, the <code class="literal">Navigation</code> scripts to the <code class="literal">Navigation</code> folder.</p></li></ul></div><p>In <a class="link" href="#" linkend="ch04">Chapter 4</a>, <span class="emphasis"><em>The Town View</em></span>, we added the street, sidewalk, and sky to the scene. Included in theÂ  <code class="literal">buildingsAndRoads.png</code> sprite sheet were some buildings as well. If you have not already done so, import the hospital, the shop, and the town hall in to the scene. When you do so, make sure you set their Sorting Layer to Background so that they will display properly.</p><p>You can place the hospital and shop wherever you want; just makes sure you place their entrances between your <span class="strong"><strong>LeftBorder</strong></span> and <span class="strong"><strong>RightBorder</strong></span>. I scaled the hospital down a bit to place it in my scene. In <a class="link" href="#" linkend="ch11">Chapter 11</a>, <span class="emphasis"><em>Shopping for Items</em></span>, we will allow the character to enter the shop so that she can go shopping for inventory items. Place the town hall toward the <span class="strong"><strong>LeftBorder</strong></span> so that the Mayor, when standing in front of the building, can act as a gatekeeper for that <span class="strong"><strong>exit</strong></span>.</p><p>The following screenshot demonstrates the way I laid out my town's buildings:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_012.jpg" /></div><p>
</p><p>The sprite sheets for three NPCs are included with the book files: <code class="literal">Doctor.png</code>,<code class="literal"> Mayor.png</code>, and<code class="literal"> Shopkeep.png</code>:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_013.jpg" /></div><p>
</p><p>You can import all three of these sprite sheets into the project, set their sprite mode to <span class="strong"><strong>Multiple</strong></span>, and <span class="strong"><strong>Automatically Slice</strong></span> each with the pivot set to Bottom now, but we will only use the Mayor character in this chapter. We will use the Shopkeep NPC in <a class="link" href="#" linkend="ch11">Chapter 11</a>,<span class="emphasis"><em> Shopping for Items</em></span>, when we start discussing inventory.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note67"></a>Note</h3><p>By now, you should be a pro at slicing sprite sheets, but if not, refer to the steps presented in <a class="link" href="#" linkend="ch02">Chapter 2</a>, <span class="emphasis"><em>Building Your Project and Character</em></span>, that we used to import the player character.</p></div><p>Also, since the player and the Mayor will be conversing, import the <code class="literal">MayorFace.png</code> images and <code class="literal">PlayerFace.png</code> as single sprite images:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_014.jpg" /></div><p>
</p><p>We need to add some personality to our NPCs as well as our hero. In <a class="link" href="#" linkend="ch02">Chapter 2</a>, <span class="emphasis"><em>Building Your Character and Project</em></span>, we outlined some classes to describe and manage the entities in the game, so let's bring them in now.</p><p>Add the Mayor to the left-hand side of the scene, next to the LeftBorder and in front of the town hall door. We are placing him here because in the next section, he is going to stop our hero from going further in this direction, as it is just too dangerous for such an impetuous youth.</p><p>To do this (using the lessons you have learned already), perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>If you haven't done so already, import the<code class="literal"> Mayor.png</code> character sprite sheet and use <span class="strong"><strong>Sprite Editor</strong></span> to slice it up.</p></li><li><p>Drag the sprite labeled <code class="literal">Mayor_1</code> (the one of the Major facing forward) in to the scene in front of the town hall.</p></li><li><p>Rename the new GameObject created <code class="literal">Mayor</code>.</p></li><li><p>In the <span class="strong"><strong>Sprite Renderer</strong></span> component, set the Sorting Layer to <span class="strong"><strong>Middleground</strong></span>.</p></li><li><p>Finally, add a <span class="strong"><strong>Box Collider 2D</strong></span> component with the settings shown in the following screenshot. This is so that the collider is of the same width as that of the Mayor but with a larger height so that the player will collide with it whenever she walks in front of him. Also, set the <span class="strong"><strong>Is Trigger</strong></span> property to true/checked.</p></li></ol></div><p>The final result will look something like the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_015.jpg" /></div><p>
</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec78"></a>Let the player walk around the NPC</h3></div></div></div><p>Currently, when the player walks behind the Mayor, she appears behind him, but when she walks in front of him, she also appears behind him!</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_016.jpg" /></div><p>
</p><p>Set the Mayer's <span class="strong"><strong>Order in Layer</strong></span> under the <span class="strong"><strong>Sprite Renderer</strong></span> component to <code class="literal">-1</code>. This will make the player (whose sorting order is set to 0) always appear to be in front of the Mayor:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_017.jpg" /></div><p>
</p><p>But this still doesn't work! Now, when she walks behind the Mayor, she still appears in front of him!, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_018.jpg" /></div><p>
</p><p>To fix this, we will have to use (you guessed it!) code.</p><p>Create a new C# script in your <code class="literal">Assets/Scripts</code> folder, and call it <code class="literal">Sorting.cs</code>:</p><pre class="programlisting"> using UnityEngine;&#13;
 using System.Collections;&#13;
 public class Sorting : MonoBehaviour {&#13;
     public Transform player;&#13;
     // Update is called once per frame&#13;
     void Update () {&#13;
         if(transform.position.y&gt;=player.transform.position.y){&#13;
             Debug.Log("behind player");&#13;
             GetComponent&lt;SpriteRenderer&gt;().sortingOrder = &#13;
                (player.GetComponent&lt;SpriteRenderer&gt;().sortingOrder)-1;&#13;
         }&#13;
         if(transform.position.y&lt;player.transform.position.y){&#13;
             Debug.Log("in front of player");&#13;
             GetComponent&lt;SpriteRenderer&gt;().sortingOrder = &#13;
                (player.GetComponent&lt;SpriteRenderer&gt;().sortingOrder)+1;&#13;
         }&#13;
     }&#13;
 } &#13;
</pre><p>The preceding code will continually check the position of the player versus the position of the object on which this code is attached. It will then move the object in front of or behind the Player through the sorting order.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip68"></a>Tip</h3><p>For this code to work properly your player and Mayor must both have their pivot points (determined when you sliced their sprite sheets) set to bottom. So, if the code does not work correctly for you, check their pivot points.</p></div><p>Attach the script to the Mayor and then drag the Player to the <code class="literal">Player</code> slot, as shown in the following image:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_019.jpg" /></div><p>
</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip69"></a>Tip</h3><p>In the preceding screenshot, I reset the Mayor's <span class="strong"><strong>Order in Layer</strong></span> to 0, but it really does not matter what it is set to, as the <code class="literal">Sorting.cs</code> script will override the value.</p><p>You can use this Sorting.cs script on other objects you want the player to walk around. But, be warned, if you have objects in the scene in the Middleground layer that only appear appropriately with specific sorting orders, the script will remove those sorting orders.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec79"></a>Stopping the player from walking through the NPC</h3></div></div></div><p>So, the player can walk circles around the Mayor (no pun intended), but she can also walk straight through him. To stop this, we are going to use a <code class="literal">Box Collider 2D </code>componet.</p><p>Currently, we have a <code class="literal">Box Collider 2D</code> component attached to the Mayor, but it has <span class="strong"><strong>Is Trigger </strong></span>set to true. The box collider will be used to trigger a dialog box, but it does not actually stop her from passing through it.</p><p>The thing that makes this difficult, is we cannot actually use one Box Collider 2D to stop her from passing through the character, if we want her to still be able to walk around him. To demonstrate what I mean, add a standard box collider to the Mayor that encompasses his whole sprite:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_020.jpg" /></div><p>
</p><p>This is going to cause the player to stop before she even really appears to get close to him and it is going to stop all of the fancy stuff we did in the previous section with sorting order from even being apparent.</p><p>So, to fix this, we are actually going to add two new <code class="literal">Box Collider 2D </code>components to the Mayor and we are going to turn them on and off depending on where the player is in relation to the Mayor, similar to the way we handled the sorting order.</p><p>Add the two Box Collider 2D Components with the following properties:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_021.jpg" /></div><p>
</p><p>I hid the town hall and the sidewalk in the previous screenshot so that you could more easily see the colliders in the image.</p><p>Now, we are going to update our <code class="literal">Sorting.cs</code> script so that it turns these <code class="literal">Box Collider 2D</code> components on and off based on the player's position.</p><p>Adjust your <code class="literal">Sorting.cs</code> script so that it reads as follows:</p><pre class="programlisting">if(transform.position.y&gt;=player.transform.position.y){&#13;
     Debug.Log("behind player");&#13;
     GetComponent&lt;SpriteRenderer&gt;().sortingOrder = &#13;
        (player.GetComponent&lt;SpriteRenderer&gt;().sortingOrder)-1;&#13;
     GetComponents&lt;BoxCollider2D&gt;()[1].enabled=false;&#13;
     GetComponents&lt;BoxCollider2D&gt;()[2].enabled=true;&#13;
}&#13;
if(transform.position.y&lt;player.transform.position.y){&#13;
     Debug.Log("in front of player");&#13;
     GetComponent&lt;SpriteRenderer&gt;().sortingOrder = &#13;
        (player.GetComponent&lt;SpriteRenderer&gt;().sortingOrder)+1;&#13;
     GetComponents&lt;BoxCollider2D&gt;()[1].enabled=true;&#13;
     GetComponents&lt;BoxCollider2D&gt;()[2].enabled=false;&#13;
}  &#13;
</pre><p>Let's look more closely at the code that reads <code class="literal">GetComponents&lt;BoxCollider2D&gt;()[1]</code> and <code class="literal">GetComponents&lt;BoxCollider2D&gt;()[2]</code>.</p><p>Since we had more than one <span class="strong"><strong>Box Collider 2D</strong></span> component attached to the Mayor, to enable and disable the specific ones we wanted, we had to use <code class="literal">GetCompoents</code>. The brackets after the parentheses state which <code class="literal">BoxCollider2D</code> we wanted to access. This is because <code class="literal">GetComponents</code> returns an array and the first one (in order from top to bottom) in the Inspector is at <span class="strong"><strong>index 0</strong></span> of the array, the second at <span class="strong"><strong>index 1</strong></span> of the array, and so on. The following screenshot demonstrates this point:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_022.jpg" /></div><p>
</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec80"></a>Getting the NPCs talking</h3></div></div></div><p>So far in this chapter, we have our town populated with characters and buildings. Now, let's give our hero something to talk about.</p><p>While building a conversation system for any game, there are many factors to consider, which are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>How long a conversation is going to be (we don't want the player to get bored with miles of text)?</p></li><li style="list-style-type: disc"><p>How many parties are likely to be involved in any discussion?</p></li><li style="list-style-type: disc"><p>Is this a flat one-sided conversation (such as a cutscene), or will the player be allowed to make decisions?</p></li><li style="list-style-type: disc"><p>Are there going to be branches in the conversation so that the conversation will change based on the player's response?</p></li><li style="list-style-type: disc"><p>How much content do you expect to be used in conversations ( text, video, cutscenes, animation, and so on)? All of this content will decide just how extensible your system needs to be.</p></li><li style="list-style-type: disc"><p>Will the conversation need to support any outbound triggers or states? Will the conclusion of a conversation unlock a door or grant the player some experience or items?</p></li></ul></div><p>There are lots of other factors that will affect both the design and implementation of a robust conversation for your game, so think about it carefully before touching the code.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note70"></a>Note</h3><p>For this book, we are going to build a basic conversation system that is enough to meet the goals of the project at hand. However, I am explaining each part along the way, so if you want to expand on it, you can.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec26"></a>The conversation object</h4></div></div></div><p>When we want to start talking in the game, we first need to decide what you want to include in the conversation. You can include the following things:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The name of the character who is speaking</p></li><li style="list-style-type: disc"><p>The text of the conversation</p></li><li style="list-style-type: disc"><p>An image of the character talking</p></li><li style="list-style-type: disc"><p>Choices</p></li><li style="list-style-type: disc"><p>The position of the chat</p></li></ul></div><p>The more you look at it, the more you can dream about what you want to include. You just need to remember the <span class="strong"><strong>KISS</strong></span> principle (<span class="strong"><strong>Keep it simple, stupid</strong></span>), that is, start small and then build on it.</p><p>So, create a new C# script, name it <code class="literal">ConversationEntry</code> in <code class="literal">Assets\Scripts\Classes</code>, and populate it with the following code:</p><pre class="programlisting">using UnityEngine; &#13;
 &#13;
[System.Serializable] &#13;
public class ConversationEntry { &#13;
  public string SpeakingCharacterName; &#13;
  public string ConversationText; &#13;
  public Sprite DisplayPic; &#13;
} &#13;
</pre><p>This gives us just the basics for our conversation system with regards to who's speakingâan optional picture that can be displayed in the conversation and most importantly, the conversation text to be displayed.</p><p>We also tag this class with the <code class="literal">System.Serializable</code> code attribute so that the Unity serializer knows what to do with it.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec27"></a>Saving and serializing the object for later</h4></div></div></div><p>With our core conversation entry object generated, we can start to store the conversations in the <code class="literal">.asset</code> files for use in our game and also make it possible to create the conversations outside of Unity if you wish.</p><p>As a conversation is (usually) more than just an opening line, we need a management object that will support several lines/entries of the conversation and a couple of switches to denote whether the conversation has already been played. This way, if you have multiple conversations configured for a character, it will simply play the next conversation and not repeat itself. You could just track this on the object that you attach the conversations to, but this is cleaner.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip71"></a>Tip</h3><p>As a rule of thumb, you should always keep flags, settings, or properties for a thing with another thing. If you start having variables to track the state of a thing elsewhere, it can get very messy. The only time this is not true is when a thing is meant to be shared across multiple objects.</p><p>Also note that the <code class="literal">ScriptableObject</code> entities are a fickle beast. They let us attach them to the GameObjects, and they can be automatically serialized and saved as part of the project. However, they are fixed assets that should only be edited in the editor. If you need to alter them as part of the game, you will need to save and store that change of state separately.</p><p>This is just a simple note to remember when architecting such things.</p></div><p>So, create another C# class in <code class="literal">Scripts\Classes</code> named <code class="literal">Conversation</code> and populate it with the following code:</p><pre class="programlisting">using UnityEngine; &#13;
 &#13;
public class Conversation : ScriptableObject { &#13;
 &#13;
  public ConversationEntry[] ConversationLines;    &#13;
} &#13;
</pre><p>Now, the first thing you will note is that this class is derived from a scriptable object class. As described earlier, this is what enables us to use Unity's serialization methods and store them as an <code class="literal">.asset</code> file.</p><p>We are not done yet as we need that final hook to enable us to create these (at least initially) in the editor.</p><p>Earlier, I showed you all of the code needed to create the asset for serialization, but this is rather a lot of code to be generated all the time. So, it's better to place that logic in a separate helper class that we can reuse rather than repeat ourselves all the time.</p><p>Earlier, with the <code class="literal">PositionManager</code> example, we created assets in the editor and reused them. You can reuse this code if you wish, but to simplify things, I added a little helper script to the example project in <code class="literal">Assets\Scripts\Editor</code> called<code class="literal"> CustomAssetUtility.cs</code>.</p><p>The <code class="literal">CustomAssetUtility</code> class does all the work that the preceding code does. It also uses the C# generics so that it can be reused for any type of <code class="literal">SerializableObject</code> you want to throw at it. You don't have to use the class I provided; you can just use the code earlier instead if you wish; just replace the code where the helper function is used.</p><p>If you have not done so already, create a new folder in <code class="literal">Assets\Scripts</code> named <code class="literal">Editor</code>, get the <code class="literal">CustomAssetUtility</code> class, and place it in the <code class="literal">Assets\Scripts\Editor</code> folder.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note72"></a>Note</h3><p>C# generics is a fairly advanced C# topic, which we won't go into in this book. If you want to know more, check out <a class="ulink" href="http://msdn.microsoft.com/en-us/library/ms379564(v=vs.80).aspx" target="_blank">http://msdn.microsoft.com/en-us/library/ms379564(v=vs.80).aspx</a>; alternatively, it will be better to try <span class="emphasis"><em>The C# Programming Yellow Book</em></span>, <span class="emphasis"><em>Rob Miles</em></span>, <span class="emphasis"><em>Department of Computer Science</em></span>, <span class="emphasis"><em>The University of Hull</em></span>, which is a fantastic C# primer book available at <a class="ulink" href="http://www.robmiles.com/c-yellow-book/" target="_blank">http://www.robmiles.com/c-yellow-book/</a>.</p></div><p>To show how we use this, let's create our editor script, which will create the conversation assets for us. Create a new script named <code class="literal">ConversationAssetCreator</code> in the <code class="literal">Editor</code> folder under <code class="literal">Assets\Scripts</code> and then replace its contents with the following code:</p><pre class="programlisting">using UnityEditor; &#13;
using UnityEngine; &#13;
 &#13;
public class ConversationAssetCreator : MonoBehaviour { &#13;
 &#13;
  [MenuItem("Assets/Create/Conversation")] &#13;
  public static void CreateAsset() &#13;
  { &#13;
    CustomAssetUtility.CreateAsset&lt;Conversation&gt;(); &#13;
  } &#13;
} &#13;
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note73"></a>Note</h3><p>Remember, any script that uses the <code class="literal">UnityEditor</code> namespace has to be placed in a special <code class="literal">Editor</code> folder. This ensures that it is only packaged with the editor solution and not used in the deployed game. Game projects are not deployed with the editor.</p></div><p>So, by using the helper function, instead of all the tangle of code to first generate our asset and then save it, we simply call our utility, tell it the type of asset we want to create (in angle brackets), and away it goes. I have crated the utility as well, so it can also take a string parameter if you want to force the folder you want to create the asset in; otherwise, it will take whatever is currently selected in the editor.</p><p>To test this out, create a new folder in the <code class="literal">Asset</code> folder named <code class="literal">Resources</code> (so, we can call assets directly from the code if we so wish) and then create another folder in <code class="literal">Resources</code> named <code class="literal">Conversations</code>:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_023.jpg" /></div><p>
</p><p>This just keeps all our conversations in one place and doesn't clutter up the hierarchy. If you wish, you could create further subfolders to identify characters, places, or whatever else you fancy. It won't have an impact on the running of the game; it will just keep it tidy.</p><p>With the <code class="literal">Conversation</code> folder under <code class="literal">Assets\Resources\</code> selected, click on <span class="strong"><strong>C</strong></span>reate in the <span class="strong"><strong>Project</strong></span> menu. You will see a new option named <span class="strong"><strong>Conversation</strong></span> (as you can see in the script earlier, this is what we named it):</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_024.jpg" /></div><p>
</p><p>When you click on it, a new <span class="strong"><strong>Conversation</strong></span> asset will appear, as shown in the following screenshot, which is ready for you to start configuring:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_025.jpg" /></div><p>
</p><p>Name the conversation <code class="literal">MayorWarning</code> and give it the lines and images shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_026.jpg" /></div><p>
</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec28"></a>The conversation component</h4></div></div></div><p>The last thing we need is a simple component that enables us to attach conversations to a character or other GameObject.</p><p>So, create a new class in the <code class="literal">Assets\Scripts\Classes</code> folder named <code class="literal">ConversationComponent</code> and replace its contents with the following code:</p><pre class="programlisting">using UnityEngine; &#13;
public class ConversationComponent : MonoBehaviour { &#13;
   public Conversation[] Conversations; &#13;
} &#13;
</pre><p>Nothing's complicated for now; the preceding code just holds an array of the possible conversations that the GameObject can have. Ideally, you would want to expand on this for a fuller conversation system, such as a pointer to the next conversation, or a way to track how many conversations have taken place, and so on.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec81"></a>Building a basic conversation system</h3></div></div></div><p>In order for our conversation assets to be of any use, we need a mechanism to play these conversations on the screen and have the user interact with them (if that's how your game rolls). For this, we need another manager that will take in conversations from characters and display them on the screen. If we had any logic, branching, or decisions in our conversations, it would handle those too.</p><p>Now, there are two basic approaches that we could take with the conversation system: one being reactive (where we use a messaging system to notify the manager that a conversation needs to take place) and one being just a utility (where scripts can request for a conversation to take place). Both are valid approaches, and it really comes down to personal preference as to which one you want to implement. To keep things simple, let's create the basic utility first and then point out where it can be enhanced.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec29"></a>The manager</h4></div></div></div><p>If we create our conversation manager as we did before with the messaging manager, we start with the simple singleton framework. However, we will lean on one of the great examples from <span class="strong"><strong>Unity Wiki</strong></span> as our base.</p><p>In the sample project under the <code class="literal">Assets\Scripts\Classes folder</code>, you will find a <code class="literal">Singleton</code> class that was sourced from <a class="ulink" href="http://wiki.unity3d.com/index.php/Singleton" target="_blank">http://wiki.unity3d.com/index.php/Singleton</a>. This simply saves us time and code while creating singleton objects for use in our games and ensures they always have the same consistency. Get this script and place it in your <code class="literal">Assets\Scripts\Classes</code> folder.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note74"></a>Note</h3><p>Make sure you get the <code class="literal">Singleton.cs</code> script and put it in your project or the following <code class="literal">CoversationManager.cs</code> script will not work.</p></div><p>With this in place, we can define our <code class="literal">Conversation</code> manager quite simply. Create a new C# script in <code class="literal">Assets\Scripts</code> named <code class="literal">ConversationManager</code> and replace its contents with the following code:</p><pre class="programlisting">using System.Collections; &#13;
using UnityEngine; &#13;
 &#13;
public class ConversationManager : Singleton&lt;ConversationManager&gt; &#13;
{ &#13;
  //Guarantee this will always be a singleton only -  &#13;
  //can't use the constructor! &#13;
  protected ConversationManager () {}  &#13;
 &#13;
} &#13;
</pre><p>Now that we have our manager, we can start adding functionality to it.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec30"></a>Starting a conversation</h4></div></div></div><p>We want our manager to take one of our conversation items and do something with it because we have a manager. So, create a new function as follows:</p><pre class="programlisting">public void StartConversation(Conversation conversation) &#13;
{} &#13;
</pre><p>This enables us to start a new conversation anywhere in the code using the following code:</p><pre class="programlisting">ConversationManager.Instance.StartConversation(conversation); &#13;
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec31"></a>Preparing the UI</h4></div></div></div><p>The manager is in place and we have a method to start a conversation, but it's not doing much right now. We will use the built in UI functionality discussed in <a class="link" href="#" linkend="ch05">Chapter 5</a>, <span class="emphasis"><em>Working with Unity's UI System</em></span>.</p><p>When the player walks in front of the Mayor, we are going to have a pop-up window display the conversation that ensues. To achieve this, we will create a panel that holds the text and image from the conversation we just set up.</p><p>To begin, create a Canvas, by navigating to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>UI</strong></span> | <span class="strong"><strong>Canvas</strong></span>:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_027.jpg" /></div><p>
</p><p>When you create the Canvas, the Event System is also automatically created. To keep my hierarchy nice and tidy, I prefer to drag this on to the canvas so that it becomes a child of the canvas, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_028.jpg" /></div><p>
</p><p>Now, we are going to use a panel to serve as the window in which the dialog appears.</p><p>Right-click on the canvas, and select <span class="strong"><strong>UI</strong></span> | <span class="strong"><strong>Panel</strong></span>. To view the panel and the Canvas, double-click on the panel in the hierarchy.</p><p>You will see something like this:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_029.jpg" /></div><p>
</p><p>When initially created, the panel appears as a semi-translucent rectangle that fills the entire area of the Canvas. Rename the panel <span class="strong"><strong>Dialog Box</strong></span>.</p><p>Now, let's make it a bit smaller. Start by setting the <span class="strong"><strong>Anchor</strong></span> and <span class="strong"><strong>Pivot Point</strong></span> to center-middle, by holding down <span class="emphasis"><em>Alt</em></span> + <span class="emphasis"><em>Shift</em></span> and selecting the middle-most <span class="strong"><strong>Anchor Presets</strong></span>.</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_030.jpg" /></div><p>
</p><p>Now, change the width and height of the <span class="strong"><strong>Rect Transform</strong></span> component to <code class="literal">300</code> and <code class="literal">100</code>, respectively:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_031.jpg" /></div><p>
</p><p>If you press play, you should now see a greyed box permanently in the center of the screen. Don't worry, we will make it go away shortly.</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_032.jpg" /></div><p>
</p><p>Now, let's add a place for the image and text to appear. <span class="strong"><strong>Right-click</strong></span> on the panel, and select <span class="strong"><strong>UI</strong></span> | <span class="strong"><strong>Image</strong></span>. Then right-click on the panel, and select <span class="strong"><strong>UI</strong></span> | <span class="strong"><strong>Text. </strong></span>You will see the following:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_033.jpg" /></div><p>
</p><p>We are going to now make the image appear on the left side of the dialog box and the text on the right. We also want them to stretch to the height of the box.</p><p>Let's start with the image. Rename it <span class="strong"><strong>Speaker Image</strong></span>. Change the <span class="strong"><strong>Rect Transform</strong></span> settings of the image so that they appear as shown in the following screenshot. Also, in the <span class="strong"><strong>Image</strong></span> component, select <span class="strong"><strong>Preserve Aspect Ratio</strong></span>:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_034.jpg" /></div><p>
</p><p>Now, rename the text <span class="strong"><strong>Dialog Text</strong></span>. Also, change the <span class="strong"><strong>Rect Transform</strong></span> settings and the <span class="strong"><strong>Text</strong></span> component settings so that they appear, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_035.jpg" /></div><p>
</p><p>Your panel will now appear as follows:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_036.jpg" /></div><p>
</p><p>Let's also change the image settings of the dialog box so that it is slightly more opaque as, right now, it is a little difficult to see. Select the white box next to the <span class="strong"><strong>Color</strong></span> property on the <span class="strong"><strong>Image</strong></span> component of the dialog box. Increase the <span class="strong"><strong>A</strong></span> (alpha) value to around <span class="strong"><strong>230</strong></span>, so the box will still be slightly transparent:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_037.jpg" /></div><p>
</p><p>We are now done setting up our panel so that it can hold the image and text. Now, all we need to do is make it not appear permanently on the screen. To do this, we will add a new component to the panel, the <span class="strong"><strong>Canvas Group</strong></span> component. In the <span class="strong"><strong>Dialog Box</strong></span>'s Inspector, select <span class="strong"><strong>Add Component</strong></span> | <span class="strong"><strong>Layout</strong></span> | <span class="strong"><strong>Canvas Group</strong></span>.</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_038.jpg" /></div><p>
</p><p>The Canvas Group will allow us to affect the alpha, intractability, and blocks raycast settings of the panel. Change the settings of the Canvas Group so that they appear as follows:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_039.jpg" /></div><p>
</p><p>Now, you should no longer see the <span class="strong"><strong>Dialog Box</strong></span> in the scene, since we set its alpha to 0.</p><p>For now, we are done working with the UI and will do everything else via code. Don't worry, though, you will get more practice with the UI systems, as we will use the UI system more in nearly every chapter from here on out.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec32"></a>Displaying the conversation</h4></div></div></div><p>Now, let's add some simple logic to display the text of the conversation on the screen.</p><p>Starting things off, we need some new properties in <code class="literal">ConversationManager</code> to control what needs to be displayed. So, open up the <code class="literal">ConversationManager</code> script and add the following properties to it:</p><pre class="programlisting">//Is there a converastion going on&#13;
bool talking = false;&#13;
&#13;
//The current line of text being displayed&#13;
ConversationEntry currentConversationLine;&#13;
&#13;
//the Canvas Group for the dialog box&#13;
public CanvasGroup dialogBox;&#13;
&#13;
//the image holder&#13;
public Image imageHolder;&#13;
&#13;
//the text holder&#13;
public Text textHolder;  &#13;
</pre><p>Each property explains its use, but everything will become clear as we add the rest of the functionality.</p><p>To use the UI properties, we must add the following line at the top of the script:</p><pre class="programlisting">using UnityEngine.UI;  &#13;
</pre><p>Next, we'll add a coroutine that will take a <code class="literal">Conversation</code> object and loop through all the lines to be displayed. Add the following function to the <code class="literal">ConversationManager</code> script:</p><pre class="programlisting">IEnumerator DisplayConversation(Conversation conversation)&#13;
{&#13;
    talking = true;&#13;
    foreach (var conversationLine in conversation.ConversationLines)&#13;
    {&#13;
        currentConversationLine = conversationLine;&#13;
        textHolder.text = currentConversationLine.ConversationText;&#13;
        imageHolder.sprite = currentConversationLine.DisplayPic;&#13;
        yield return new WaitForSeconds(3);&#13;
    }&#13;
    talking = false;&#13;
}  &#13;
</pre><p>This simple coroutine takes the conversation passed to it and loops through each of the individual lines of the conversation's text. Before we start, we set the <code class="literal">talking</code> flag to denote that a conversation is in progress; then, for each conversation line, we perform the following tasks:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Set a pointer to the current conversation item in the list with the <code class="literal">currentConversationLine</code> property</p></li><li style="list-style-type: disc"><p>Add the text and image to the text and image holders</p></li><li style="list-style-type: disc"><p>Wait for three seconds before moving on to the next conversation item</p></li><li style="list-style-type: disc"><p>When we run out of conversation lines, we set the <code class="literal">talking</code> flag to <code class="literal">false</code> to show that we have finished</p></li></ul></div><p>So, we have a coroutine looping through the text. The next thing to do is to use this information to display it on the screen. For this, we need an <code class="literal">OnGUI</code> method in our scripts as follows:</p><pre class="programlisting">void OnGUI()&#13;
{&#13;
    if (talking)&#13;
    {&#13;
        dialogBox.alpha = 1;&#13;
        dialogBox.blocksRaycasts = true;&#13;
    }&#13;
    else{&#13;
        dialogBox.alpha = 0;&#13;
        dialogBox.blocksRaycasts = false;&#13;
    }&#13;
}  &#13;
</pre><p>Remember when we set up the dialog box, we set its alpha to 0 and made it so that it would not block raycasts. Now, we will turn the alpha and ability to block raycast back on when <code class="literal">talking </code>is true and back off if <code class="literal">talking</code> is false.</p><p>So, when the <code class="literal">talking</code> flag is set, Unity will know that it has to display our conversation GUI on the screen.</p><p>To finish this off, we need to call the coroutine from our <code class="literal">public</code> method, which other scripts can use to start a conversation and find the information for the dialog box and its subobjects:</p><pre class="programlisting">public void StartConversation(Conversation conversation)&#13;
{&#13;
    dialogBox = GameObject.Find("Dialog Box").GetComponent&lt;CanvasGroup&gt;();&#13;
    imageHolder = GameObject.Find("Speaker Image").GetComponent&lt;Image&gt;();&#13;
    textHolder = GameObject.Find("Dialog Text").GetComponent&lt;Text&gt;();&#13;
    //Start displying the supplied conversation&#13;
    if (!talking)&#13;
    {&#13;
        StartCoroutine(DisplayConversation(conversation));&#13;
    }&#13;
}  &#13;
</pre></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec82"></a>Connecting the dots</h3></div></div></div><p>So now that we have something to talk about, we just need to be able to attach it to the characters and then start displaying it on the screen for the player to interact with.</p><p>First, we need an empty class for our NPCs. So, create a new C# script named <code class="literal">Npc</code> in the <code class="literal">Classes</code> folder under <code class="literal">Assets\Scripts</code> and replace its contents with the following code:</p><pre class="programlisting">using UnityEngine; &#13;
public class Npc : MonoBehaviour &#13;
{ &#13;
  public string Name; &#13;
  public int Age; &#13;
  public string Faction; &#13;
  public string Occupation; &#13;
  public int Level; &#13;
} &#13;
&#13;
</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip75"></a>Tip</h3><p>As NPCs are things we generate and place into the scene, we actually need to break the convention to inherit from the <code class="literal">Entity</code> class. This is actually a limitation in Unity, because only scripts that derive from <code class="literal">MonoBehaviour</code> can be attached to GameObjects in a scene. If you try to attach a class that uses or derives from <code class="literal">ScriptableObject</code>, the editor will throw an error. So, as we are adding NPCs in our scene in the editor, we need to use a separate script.</p><p>If you were generating the towns procedurally or loading them from a pre-built save file, then you could still use classes based on <code class="literal">ScriptableObject</code>.</p></div><p>With that created, add the <code class="literal">Npc.cs</code> script to the Mayor in our scene (don't forget to name your character in the <span class="strong"><strong>Inspector</strong></span> pane as well).</p><p>Next, add the <span class="strong"><strong>Conversation</strong></span> component to the Mayor's <span class="strong"><strong>NPC script</strong></span> and then drag the conversation we just built to that character in the <span class="strong"><strong>Conversations</strong></span> array. Do this by dragging it over the word <span class="strong"><strong>Conversations</strong></span>.</p><p>The <span class="strong"><strong>Inspector</strong></span> pane will now look like the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_040.jpg" /></div><p>
</p><p>So now that our character has a script and we have the <code class="literal">ConversationManager</code> set up, we just need to trigger the conversation when the hero tries to exit the left side of the screen.</p><p>To broadcast the message when the player touches the long Box Collider attached to the Mayor, we need to add the <code class="literal">MessagingClientBroadCast</code> script to the Mayor. Since the Box Collider 2D attached to the Mayor we want to interact with is set as trigger, we need to update our <code class="literal">MessagingClientBroadCast</code> script to include the following:</p><pre class="programlisting">void OnTriggerEnter2D(Collider2D col) &#13;
{      MessagingManager.Instance.Broadcast(); }  &#13;
</pre><p>So, now when the player walks in front of the Mayor, the message will be broadcasted.</p><p>To finish off, we just need to get the Mayor NPC to listen for the message the player will leave and then start his conversation. So, remove the <code class="literal">MessagingClientReceiver</code> script (that was created in the <span class="emphasis"><em>Messaging</em></span> section) from the left border that you set up earlier and add it to the Mayor NPC GameObject.</p><p>The Mayor's inspector will now appear as follows:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_041.jpg" /></div><p>
</p><p>Now, the Mayor is subscribing to and receiving the messages for the player leaving. Next, update the <code class="literal">MessagingClientReceiver</code> script (in the <code class="literal">Messaging</code> folder under <code class="literal">Assets\Scripts</code>) and update the <code class="literal">ThePlayerIsTryingToLeave</code> method with the following code:</p><pre class="programlisting">void ThePlayerIsTryingToLeave() &#13;
{ &#13;
  var dialog = GetComponent&lt;ConversationComponent&gt;(); &#13;
  if (dialog != null) &#13;
  { &#13;
    if (dialog.Conversations != null &amp;&amp; dialog.Conversations.Length &gt; 0) &#13;
    { &#13;
      var conversation = dialog.Conversations[0]; &#13;
      if (conversation != null) &#13;
      { &#13;
        ConversationManager.Instance.StartConversation(conversation); &#13;
      } &#13;
    } &#13;
  } &#13;
} &#13;
</pre><p>Here, we look to see if a <code class="literal">ConversationComponent</code> script is on the GameObject it is attached to. If it is, we see if there are any conversations defined for this NPC; if yes, we call the <code class="literal">ConversationManager</code> script and ask it to start the first conversation.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note76"></a>Note</h3><p>Granted, this is a simple example and should be extended in a full system to track conversations that are played or conditions that need to be met for a conversation to be played.</p><p>At the moment, the conversation system will keep on going even after you have left the vicinity of the character that you are talking with.</p></div><p>Lastly, if you did not do so earlier in the <span class="emphasis"><em>Messaging</em></span> section, create an empty GameObject in the scene, name it Messaging Manager, and attach the <code class="literal">MessagingManager</code> script to it. Open the <code class="literal">MessagingManager</code> script and remove the following code, if you added it earlier, as this is not going to be used in the game:</p><pre class="programlisting">public ScriptingObjects MyWaypoints; &#13;
</pre><p>Now, if you run the project and try to exit on the left side, the Mayor will harass you, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781786463456/graphics/image_06_042.jpg" /></div><p>
</p></div></div>