<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec17"></a>Contextual bandits and state</h2></div></div><hr /></div><p>Our next step in understanding RL will be for us to <span>look</span><a id="id324673124" class="indexterm"></a> at the contextual bandit problem. A contextual bandit is the multi-armed bandit problem, with multiple bandits each producing different rewards. This type of problem has many applications in online advertising, where each user is <span>thought</span><a id="id324673338" class="indexterm"></a> of as a different bandit, with the goal being to present the best advertisement for that user. To model the context of the bandit, and which bandit it is, we add the concept of state. Where we now interpret state to represent each of our different bandits. The following diagram shows the addition of state in the Contextual Bandit problem and where it lies on our path to <span>glory</span>:</p><div class="mediaobject"><img src="/graphics/9781789138139/graphics/48b557e7-55c8-46ee-9c34-f589318ef6b5.png" /></div><p>
Stateless, Contextual and Full RL models</p><p>You can see in the preceding diagram that we now need to determine the state before evaluating an action. If you recall from earlier, the Value function only accepts an action, but now we also need to evaluate state. Let's rewrite our Value, or V, function to accept inputs of action and state as a function of Quality. We can rewrite our V function in terms of Quality as follows:</p><div class="mediaobject"><img src="/graphics/9781789138139/graphics/f024b4ae-31fb-47e3-b23b-dafe4e1c25da.png" /></div><p>Consider the follwing:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><div class="mediaobject"><img src="/graphics/9781789138139/graphics/3f8e7ede-d9ca-4521-a70f-61f504300363.png" /></div>Isa table or matrix of values. We denote the different by using <code class="literal">[]</code> instead of <code class="literal">()</code></li><li style="list-style-type: disc"><div class="mediaobject"><img src="/graphics/9781789138139/graphics/e0efd03f-093a-43b9-b728-1b2a05747115.png" /></div>State</li><li style="list-style-type: disc"><div class="mediaobject"><img src="/graphics/9781789138139/graphics/53ccf771-8a62-4c4f-8b91-4219a4136bf8.png" /></div>Action</li><li style="list-style-type: disc"><div class="mediaobject"><img src="/graphics/9781789138139/graphics/61c51db1-c2bd-4340-a553-7527df6c159f.png" /></div>The learning rate, valued from <code class="literal">0</code> to <code class="literal">1</code></li><li style="list-style-type: disc"><div class="mediaobject"><img src="/graphics/9781789138139/graphics/7cd16871-f096-40d9-a6cc-ce3ab0f9eb67.png" /></div>The reward observed for the state and action</li></ul></div><p>This gives us the Quality, or Q, function which takes a state and action as input and returns the quality of a given action with a state or observation. While both Q and V functions are similar, the implementation in code within Unity is different and worth more careful discovery. Follow along as we covert the multi-armed bandit problem into a contextual bandit problem:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Open the <code class="literal">Assets/Simple/Scripts</code> folder in the <code class="literal">Project</code> window. Right-click (<span class="emphasis"><em>Command</em></span> + click on macOS) in the window, and from the context menu, select <code class="literal">Create -&gt; C# Script</code>.</li><li>Name the new script <code class="literal">SimpleArm</code>, and double click on it to open your code editor.</li><li>Simplify the script to just the following code:</li></ol></div><pre class="programlisting">      using UnityEngine;

      public class SimpleArm : MonoBehaviour {
        public Material material;
        public int rewardValue; 
      }</pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li><code class="literal">SimpleArm</code> is a simple container for <code class="literal">Material</code> and <code class="literal">rewardValue</code>. Save the file when you are done editing.</li><li>Find the <code class="literal">Bandit</code> object in the <code class="literal">Hierarchy</code> window. Click the <code class="literal">Gear</code> icon beside the <code class="literal">Bandit</code> component in the <code class="literal">Inspector</code> window, and, from the context menu, select <code class="literal">Edit Script</code>.</li><li>Replace the <strong class="userinput"><code>Gold</code></strong>, <strong class="userinput"><code>Silve</code></strong><strong class="userinput"><code>r</code></strong>, and <strong class="userinput"><code>Bronze </code></strong><strong class="userinput"><code>Material</code></strong> fields in the <code class="literal">Bandit.cs</code> script with the following code:</li></ol></div><pre class="programlisting">      public SimpleArm[] arms;</pre><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>We will use a <code class="literal">SimpleArm</code> array now, called <code class="literal">arms</code>.</li><li>Replace the entire contents of the <code class="literal">PullArm</code> method with the following code:</li></ol></div><pre class="programlisting">      if (arm &lt; 0 || arm &gt; arms.Length) return 0;
      mesh.material = arms[arm - 1].material;
      return arms[arm-1].rewardValue;</pre><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>As you can see, abstracting the <span>arms</span><a id="id325402876" class="indexterm"></a> like this <span>greatly</span><a id="id325402885" class="indexterm"></a> simplifies our <code class="literal">PullArm</code> method now. Save the file and return to Unity.</li></ol></div><p>Now that we have the <code class="literal">Bandit.cs</code> and <code class="literal">SimpleArm.cs</code> scripts complete, we can go back to Unity and set up the game objects in the scene.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip17"></a>Note</h3><p>Often, as you build up a scene, you may want to switch from deriving scripts or scene objects first. How you do this may depend on the problem you are tackling or just become a personal preference. Unity is great in that it allows you to construct those visual placeholders in the scene and then fill in the logic later.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec14"></a>Building the contextual bandits</h3></div></div></div><p>Now, with the updated logic for the <code class="literal">Bandit</code> and <code class="literal">SimpleArm</code> classes, we can continue by configuring our scene objects. Follow these steps to create the multiple bandits:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>From the menu, select <code class="literal">GameObject -&gt; Create Empty</code>. Rename the new object <code class="literal">Arms</code>. We are going to make a container for all the bandit arms that the bandits will share. Sharing the arms will make setting up this task much simpler.</li><li>Select the new <code class="literal">Arms</code> object in the <strong class="userinput"><code><span>Hierarchy</span><a id="id325405982" class="indexterm"></a></code></strong> window, and then from the menu select <code class="literal">GameObject -&gt; Create Empty</code>. This should create a new child object of <code class="literal">Arms</code>. Rename the new child object <code class="literal">GoldArm</code>.</li><li>Select <code class="literal">GoldArm</code>, and set its <code class="literal">Material</code> and <code class="literal">rewardValue</code> to one of your choosing.</li><li>With <strong class="userinput"><code><span class="strong"><strong>GoldArm</strong></span></code></strong> selected, press <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>D</em></span>(<span class="emphasis"><em>Command</em></span> + <span class="emphasis"><em>D on</em></span> macOS)to duplicate the arm. Rename the new arm <code class="literal">SilverArm</code>, and adjust its properties appropriately.</li><li>Repeat step 4 for another arm called <code class="literal">BronzeArm</code>. You can create more arms at your own discretion. Try different materials and reward values as well.</li><li>Select the <code class="literal">Bandit</code> object, and in the <strong class="userinput"><code>Inspector</code></strong> window give the <strong class="userinput"><code>Bandit</code></strong> component four arms, as shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781789138139/graphics/70f9383e-26e8-4df8-af47-46983e51558c.png" /></div><p>Setting up the Bandit arms</p><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>Select the <strong class="userinput"><code><span class="strong"><strong>Bandit</strong></span></code></strong> object and type <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>D</em></span> (<span class="emphasis"><em>Command</em></span> + <span class="emphasis"><em>D on</em></span> macOS) to duplicate the bandit. Rename the object <code class="literal">Bandit_2,</code> and then reconfigure the arms any way you like, but be sure each bandit has four arms.</li><li>Repeat step 7 to add two more bandits named<code class="literal">Bandit_3</code> and <code class="literal">Bandit_4</code>. Be sure to reconfigure the arm positions for each bandit so they are different.</li><li>Set the <span class="strong"><strong><strong class="userinput"><code>Transform Position X</code></strong></strong></span> of each bandit so they line up in a row with space between each bandit.</li><li>When you are done, save the scene and project.</li></ol></div><p>After you are done, you should now have four bandits with four arms each, which gives us a Q function that represents a 4 X 4 table of state, action values. If you recall, we placed the <code class="literal">V</code> function in the <code class="literal">SimpleDecision</code><strong class="userinput"><code><span class="strong"><strong>,</strong></span></code></strong> and that means we will have to update the decision code next.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec15"></a>Creating the ContextualDecision script</h3></div></div></div><p>We now need to upgrade the decision code <span>from</span><a id="id324673596" class="indexterm"></a> the multi-armed bandit problem to a contextual bandit problem. Go ahead and jump into the editor and follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Locate the <code class="literal">SimpleDecision</code> script in the <code class="literal">Assets/Simple/Scripts</code> folder. Select the script and type <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>D (Command + D</em></span> on macOS) to duplicate the script. This will duplicate the script and cause an error. Not to worry; the error is just a duplicate name that we will fix shortly.</li><li>Rename the <span>new</span><a id="id324673629" class="indexterm"></a> script <code class="literal">ContextualDecision</code>, and then double-click on it to open it in your code editor.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Rename the class to <code class="literal">ContextualDecision</code> as follows:</li></ol></div><pre class="programlisting">      public class ContextualDecision : MonoBehaviour, Decision</pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Add or modify the <span>variable</span><a id="id324673664" class="indexterm"></a> declarations at the top of the script as follows:</li></ol></div><pre class="programlisting">      private int action;
      private int lastAction, lastState; 
      public float[][] q; 
      public float learningRate;</pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Next, we will add a new <code class="literal">Awake</code> method to initialize our <code class="literal">q</code> table as follows:</li></ol></div><pre class="programlisting">      public void Awake()
      {
        q = new float[4][];
        for (int i = 0; i &lt; 4; i++)
        {
          q[i] = new float[4];
        }
      }</pre><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>The <code class="literal">Decide</code> method also needs to be updated to the following:</li></ol></div><pre class="programlisting">      public float[] Decide(
        List&lt;float&gt; vectorObs,
        List&lt;Texture2D&gt; visualObs,
        float reward,
        bool done,
        List&lt;float&gt; memory)
      {
        lastAction = action-1;
        if (++action &gt; 4) action = 1;
        if (lastAction &gt; -1)
        {
          q[lastState][lastAction] = q[lastState][lastAction] + 
          learningRate * (reward           - q[lastState][lastAction]);
        }
          lastState = (int)vectorObs[0];
          return new float[] { action };
        }</pre><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>Notice how we swapped out the <code class="literal">Value</code> function we used in the last example with the <code class="literal">q</code> function. Remember, the <code class="literal">q</code> or <code class="literal">Q</code> function tracks state as well as the action. Notice at the end we are saving the <code class="literal">vectorObs[0]</code> value as our state. An observation is the same as capturing or observing state. Our state in this example will represent the current bandit that the agent is pulling the arm for.</li><li>Make sure to save the script and return to the editor. Just make sure you have no compile errors before continuing. Next, we need to replace the decision script on the Brain.</li><li>Locate the <code class="literal">Brain</code> object in the <code class="literal">Hierarchy</code> window and select it. Move to the <code class="literal">Inspector</code> window, and replace the <code class="literal">Simple Decision</code> component with the <code class="literal">Context Decision</code> component.</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip18"></a>Note</h3><p>You have already swapped some components/scripts back in the first chapter. Be sure to also set the <code class="literal">learningRate</code> on the <code class="literal">Contextual Decision</code> component to a value of <code class="literal">.9</code>, again, just as we did in the last example.</p></div><p>That finishes up the new <code class="literal">ContextDecision</code> script, and now we <span>can</span><a id="id325397984" class="indexterm"></a> proceed to updating the agent script.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec16"></a>Updating the Agent</h3></div></div></div><p>We are almost done. The last thing we <span>need</span><a id="id325397998" class="indexterm"></a> to do is set up the agent to be aware of the bandits and also return an observation for the current bandit. Open up the <code class="literal">SimpleAgent</code> script in your editor, and follow these steps to update the script:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Replace the following field declarations as follows:</li></ol></div><pre class="programlisting"><span class="strong"><strong>      public Bandit bandit; //delete me</strong></span>
      public Bandit currentBandit;
      public Bandit[] bandits;</pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Next, we need to update the <code class="literal">CollectObservations</code> method as follows:</li></ol></div><pre class="programlisting">      public override void CollectObservations()
      {
        var bandit = Random.Range(0, bandits.Length);
        currentBandit = bandits[bandit];
        AddVectorObs(bandit);
      } </pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Here, we are returning the observation of the state the current agent is in. We determine the state by randomly selecting a <code class="literal">bandit</code><span class="strong"><strong> </strong></span>index that we use to pick the <code class="literal">currentBandit</code> from the array of <code class="literal">bandits</code>. We return the observation or state by using the <code class="literal">AddVectorObs(bandit)</code> call.</li><li>Modify the <code class="literal">AgentAction</code> method as follows:</li></ol></div><pre class="programlisting">      public override void AgentAction(float[] vectorAction, 
      string textAction)
      {
        int action = (int)vectorAction[0];
        AddReward(currentBandit.PullArm(action));
      }</pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>In <code class="literal">AgentStep</code>, we are again extracting the action. Then, execute the action on the <code class="literal">currentBandit</code> and collect the reward.</li><li>Finally, we <span>need</span><a id="id325398128" class="indexterm"></a> to update the <code class="literal">AgentReset</code> method with the following:</li></ol></div><pre class="programlisting">      public override void AgentReset()
      {
        if(currentBandit) currentBandit.Reset();
      }</pre><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>We just want to make sure the <code class="literal">currentBandit</code> is set before we call <code class="literal">Reset</code>. When you are done editing, save the file and return to Unity.</li><li>Select the <span class="strong"><strong>Agent</strong></span> object in the <span class="strong"><strong>Hierarchy</strong></span> window and set the <strong class="userinput"><code><span class="strong"><strong>Bandits</strong></span></code></strong> on the <span class="strong"><strong><strong class="userinput"><code>Simple Agent</code></strong></strong></span> component, as shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781789138139/graphics/db3032e0-019d-4a94-9ab1-0f74ecba80de.png" /></div><p>Setting the Bandits on the Agent</p><p>Our Agent is now configured, as shown in the previous screenshot. We now need to update the <strong class="userinput"><code><span class="strong"><strong>Brain</strong></span></code></strong> and <code class="literal">SimpleDecision</code> script with a method or algorithm that allows us to explore and yet still exploit the environment. We will cover exploration and exploitation in the next section.</p></div></div>