<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec36"></a>Generating items in the dungeon</h2></div></div><hr /></div><p>Usually in <a id="id214" class="indexterm"></a>RPG games, the player will acquire and carry items that add <a id="id215" class="indexterm"></a>some status boosting effects. The player can have weapons to increase their damage or armor to increase their defense. We are going to add some<a id="id216" class="indexterm"></a> <span class="strong"><strong>armor</strong></span> items that will power up our player.</p><p>The armor items will run on a slightly more complicated system than the health items and will require their own class. We will also need a way to deliver the items to the player. We want to be a little more interesting than just littering the dungeon floor with items, so we will create a chest that will randomly spawn items.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec32"></a>The Chest prefab</h3></div></div></div><p>Let's start with the Chest prefab. The Chest prefab<a id="id217" class="indexterm"></a> will be a lot like the Wall prefab, in that the Chest prefab will also spawn items upon iteration. We will begin by building the prefab.</p><p>This chapter includes some additional art assets that can be imported for the Chest prefab and armor items. You are welcome to take this opportunity to make your own art for this part. You can find the provided sprite sheet in the exercise files in the <code class="literal">Chapter 5</code> folder.</p><p>We will now go over the whole import process:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In <span class="strong"><strong>Projects</strong></span>, select the <span class="strong"><strong>Sprites</strong></span> folder.</p></li><li><p>Right-click either on the folder icon or anywhere in the folder.</p></li><li><p>From the right-click menu, select <span class="strong"><strong>Import New Asset…</strong></span>.</p></li><li><p>Navigate to and select the <code class="literal">Items_Sprite_Sheet.png</code> file or your sprite sheet.</p></li></ol></div><p>You now have a new <a id="id218" class="indexterm"></a>unformatted sprite sheet available in the <span class="strong"><strong>Sprites</strong></span> folder. We want to match the setting of the previous sprite sheet. Select the <span class="strong"><strong>Items_Sprite_Sheet.png</strong></span> file so that we can view it's settings in the <span class="strong"><strong>Inspector</strong></span> tab, and follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Set <span class="strong"><strong>Sprite Mode</strong></span> to <span class="strong"><strong>Multiple</strong></span>.</p></li><li><p>Set <span class="strong"><strong>Pixels Per Unit</strong></span> to <code class="literal">32</code>.</p></li><li><p>Set <span class="strong"><strong>Filter Mode</strong></span> to <span class="strong"><strong>Point</strong></span>.</p></li><li><p>Set <span class="strong"><strong>Max Size</strong></span> to <span class="strong"><strong>1024</strong></span>.</p></li><li><p>Set <span class="strong"><strong>Format</strong></span> to <span class="strong"><strong>Truecolor</strong></span>.</p></li><li><p>Click on <span class="strong"><strong>Apply</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781785287473/graphics/B04808_05_05.jpg" /><div class="caption"><p>Imported sprite sheet settings</p></div></div></li></ol></div><p>Now, we need to set up the slicing of the image. While <code class="literal">Items_Sprite_Sheet.png</code> is still selected, find and click on the <span class="strong"><strong>Sprite Editor</strong></span> button. Here, we can make sure that our sprites are properly sized.</p><p>For each sprite:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select a sprite. You<a id="id219" class="indexterm"></a> will notice a blue bounding box around the selected sprite.</p></li><li><p>Set both, the width (<span class="strong"><strong>W</strong></span>) and height (<span class="strong"><strong>H</strong></span>) to <code class="literal">32</code>. You might need to move the bounding box to accept a width and height of 32.</p><div class="mediaobject"><img src="/graphics/9781785287473/graphics/B04808_05_06.jpg" /><div class="caption"><p>Sprite Editor</p></div></div></li></ol></div><p>You can then click on <span class="strong"><strong>Apply</strong></span> in the upper-right corner of the Sprite Editor. Exit the Sprite Editor. If the sprite sheet hasn't expanded in the <span class="strong"><strong>Sprites</strong></span> folder, you can click on the white arrow on the side of the sprite to expand it. You can then inspect the individual sprites and make sure their dimensions are correct. Before we start coding, we are going to create the Chest prefab:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>From the top menu, navigate to <span class="strong"><strong>GameObject</strong></span> | <span class="strong"><strong>Create Empty</strong></span>.</p></li><li><p>Select the new empty object in the <span class="strong"><strong>Hierarchy</strong></span> panel.</p></li><li><p>Name the object <code class="literal">Chest</code>.</p></li><li><p>Set <span class="strong"><strong>Layer</strong></span> to <span class="strong"><strong>BlockingLayer</strong></span>.</p></li><li><p>Click on the <span class="strong"><strong>Add Component</strong></span> button in the <span class="strong"><strong>Inspector</strong></span> tab and add <span class="strong"><strong>Sprite Renderer</strong></span> and <span class="strong"><strong>Box Collider 2D</strong></span> components.</p></li><li><p>In the <span class="strong"><strong>Sprite</strong></span> field of the <span class="strong"><strong>Sprite Renderer</strong></span> component, select <span class="strong"><strong>Items_Sprite_Sheet_0</strong></span>.</p></li><li><p>In the <span class="strong"><strong>Sorting Layer</strong></span> field of the <span class="strong"><strong>Sprite Renderer</strong></span> component, set the <span class="strong"><strong>Sorting Layer</strong></span> field to <span class="strong"><strong>Units</strong></span>.</p></li><li><p>Drag and <a id="id220" class="indexterm"></a>drop the new <span class="strong"><strong>Chest</strong></span> prefab into the <span class="strong"><strong>Prefabs</strong></span> folder and delete it from the <span class="strong"><strong>Hierarchy</strong></span> panel.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec33"></a>Chest implementation</h3></div></div></div><p>We are ready to start coding the <a id="id221" class="indexterm"></a>functionality of the chest. As stated previously in the chapter, the chest code is very similar to the wall code. It would be a better practice to make a base class that the chest and wall can inherit from but we are going to take the lazy route. You should challenge yourself to make this base class on your own.</p><p>We will be making a new class for the chest, so inside the <span class="strong"><strong>Scripts</strong></span> folder, right-click and select <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>C# Script</strong></span> and name it <code class="literal">Chest.cs</code>. You can then open the <code class="literal">Chest.cs</code> script for editing. <span class="emphasis"><em>Code Snip 5.3</em></span> shows the whole class definition:</p><div class="informalexample"><pre class="programlisting">1 using UnityEngine;
2 using System.Collections;
3 
4 public class Chest : MonoBehaviour {
5 
6  public Sprite openSprite;
7 //  public Item randomItem;
8  
9  private SpriteRenderer spriteRenderer;
10
11  void Awake () {
12    spriteRenderer = GetComponent&lt;SpriteRenderer&gt; ();
13  }
14
15  public void Open () {
16    spriteRenderer.sprite = openSprite;
17
18 //    randomItem.RandomItemInit ();
19 //    GameObject toInstantiate = randomItem.gameObject;
20 //    GameObject instance = Instantiate (toInstantiate, new Vector3 (transform.position.x, transform.position.y, 0f), Quaternion.identity) as GameObject;
21 //    instance.transform.SetParent (transform.parent);
22
23    gameObject.layer = 10;
24    spriteRenderer.sortingLayerName = "Items";
25  }
26 }</pre></div><p>We are using a <a id="id222" class="indexterm"></a>structure similar to the wall. We have already seen most of what is happening in the <code class="literal">Chest</code> class. Let's take a look at what we have done:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">Lines 4-26</code>: This is the <code class="literal">Chest</code> class definition.</p></li><li style="list-style-type: disc"><p><code class="literal">Line 6</code>: This is a reference to the sprite that will show that the chest has been opened.</p></li><li style="list-style-type: disc"><p><code class="literal">Line 7</code>: This will be the randomized item that the chest spawns. It is commented out right now because we haven't made the Item class yet and this code will cause an error.</p></li><li style="list-style-type: disc"><p><code class="literal">Line 9</code>: This is the reference to the <span class="strong"><strong>Sprite Renderer</strong></span> component so that we can change the sprite when we need to.</p></li><li style="list-style-type: disc"><p><code class="literal">Lines 11-13</code>: The <code class="literal">Awake</code> function will set the <code class="literal">spriteRenderer</code> variable to the chest's Sprite Renderer component.</p></li><li style="list-style-type: disc"><p><code class="literal">Lines 15-25</code>: The <code class="literal">Open</code> function will switch the sprite and spawn the randomized item.</p></li><li style="list-style-type: disc"><p><code class="literal">Line 18</code>: <code class="literal">RandomItemInit</code> will be the call we make to our <code class="literal">Item</code> class when we create it later in the chapter.</p></li><li style="list-style-type: disc"><p><code class="literal">Lines 18-21</code>: These lines will be commented out till we make our <code class="literal">Item</code> class. If they are uncommented, they will cause an error.</p></li><li style="list-style-type: disc"><p><code class="literal">Line 23</code>: Here, we set the layer to one farther down the list, so that we can walk over the opened chests.</p></li><li style="list-style-type: disc"><p><code class="literal">Line 24</code>: Here, we set the sorting layer to a lower layer so that when we walk over the chest, it will appear under us.</p></li></ul></div><p>Now, you can return to the Unity Editor and add the script to the <span class="strong"><strong>Chest</strong></span> prefab. In the <span class="strong"><strong>Open Sprite</strong></span> field, select <span class="strong"><strong>Items_Sprite_Sheet_1</strong></span>. At this point, our <span class="strong"><strong>Chest</strong></span> prefab is done except that there are no items for it to spawn. We also need to add the code that will spawn the chest.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec34"></a>Spawning the chest</h3></div></div></div><p>We are going to<a id="id223" class="indexterm"></a> utilize our <code class="literal">public enum TileType</code> for the chest spawning. The <code class="literal">TileType</code> enumeration is in the <code class="literal">DungeonManager.cs</code> file. We are going to add <code class="literal">chest</code> to the enumeration set. <code class="literal">TileType</code> will look like the following <span class="emphasis"><em>Code Snip 5.4</em></span>:</p><div class="informalexample"><pre class="programlisting">1 public enum TileType {
2   essential, random, empty, chest
3 }
...
143 if (Random.Range (0, 70) == 1) {
144   gridPositions.Add (chamberTilePos, TileType.chest);
145 } else {
146  gridPositions.Add (chamberTilePos, TileType.empty);
147 }</pre></div><p>At the end of the <code class="literal">DungeonManager.cs</code> file, we also make an addition to the <code class="literal">BuildRandomChamber</code> function. We see that change at the end of <span class="emphasis"><em>Code Snip 5.4</em></span>. <code class="literal">Line 143</code> creates a probability that a chest will spawn on any given tile within a chamber area of a dungeon. On <code class="literal">Line 144</code>, we then set <code class="literal">TileType</code> to <code class="literal">TileType.chest</code> for future reference. Now, we need to switch files to <code class="literal">BoardManager.cs</code>.</p><p>We need to add the reference to the <span class="strong"><strong>Chest</strong></span> prefab. You can add the reference variable, <code class="literal">public GameObject chestTile</code>, near the other references to the different tiles. Then, the last adjustment that we need to make is in the <code class="literal">SetDungeonBoard</code> function. <span class="emphasis"><em>Code Snip 5.5</em></span> shows that change:</p><div class="informalexample"><pre class="programlisting">130 public void SetDungeonBoard (Dictionary&lt;Vector2,TileType&gt; dungeonTiles, int bound, Vector2 endPos) {
131  boardHolder.gameObject.SetActive (false);
132  dungeonBoardHolder = new GameObject ("Dungeon").transform;
133  GameObject toInstantiate, instance;
134
135  foreach(KeyValuePair&lt;Vector2,TileType&gt; tile in dungeonTiles) {
136    toInstantiate = floorTiles [Random.Range (0, floorTiles.Length)];
137    instance = Instantiate (toInstantiate, new Vector3 (tile.Key.x, tile.Key.y, 0f), Quaternion.identity) as GameObject;
138    instance.transform.SetParent (dungeonBoardHolder);
139
140    if (tile.Value == TileType.chest) {
141      toInstantiate = chestTile;
142      instance = Instantiate (toInstantiate, new Vector3 (tile.Key.x, tile.Key.y, 0f), Quaternion.identity) as GameObject;
143      instance.transform.SetParent (dungeonBoardHolder);
144    }
145     } 
...</pre></div><p>The <code class="literal">SetDungeonBoard</code> function was written in <a class="link" href="#" linkend="ch04">Chapter 4</a>, <span class="emphasis"><em>Generating Random Dungeons</em></span>. Now, we will add <code class="literal">Lines 140-144</code>. We use the tile value in our dictionary to check whether the tile has a chest on it. If it does, then we instantiate the chest tile the same way we have been instantiating everything.</p><p>At this point, we can <a id="id224" class="indexterm"></a>return to the Unity Editor. Drag and drop the <span class="strong"><strong>Chest</strong></span> prefab into the <span class="strong"><strong>Chest Tile</strong></span> field of the <span class="strong"><strong>Board Manager</strong></span> script in the <span class="strong"><strong>GameManager</strong></span> prefab. If you play the game and enter a dungeon, you should eventually find a chest. If you do not find any, you can go back to the <code class="literal">DungeonManager.cs</code> file and adjust the probability at which they spawn.</p><div class="mediaobject"><img src="/graphics/9781785287473/graphics/B04808_05_07.jpg" /><div class="caption"><p>A randomly spawned chest</p></div></div><p>When you encounter a chest, nothing will happen. It will block you from moving but it won't open. We need to add the interaction functionality in the <code class="literal">Player</code> class, but it would be empty anyway.</p><p>We need some <a id="id225" class="indexterm"></a>items for the chest to spawn. This is where our status modifying armor items come in. While we are in the Unity Editor, we can put together our Item prefab first.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec35"></a>The Item prefab</h3></div></div></div><p>The <span class="strong"><strong>Item</strong></span> prefab will be <a id="id226" class="indexterm"></a>similar to the <span class="strong"><strong>Food</strong></span> prefab. We want the item to trigger on collision so that we can <span class="emphasis"><em>pick up</em></span> the item. You can create the <span class="strong"><strong>Item</strong></span> prefab as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>From the top menu, navigate to <span class="strong"><strong>GameObject</strong></span> | <span class="strong"><strong>Create Empty</strong></span>.</p></li><li><p>Select the new empty object in the <span class="strong"><strong>Hierarchy</strong></span> panel.</p></li><li><p>Name the object <code class="literal">Item</code>.</p></li><li><p>Set <span class="strong"><strong>Tag</strong></span> to <span class="strong"><strong>Item</strong></span>.</p></li><li><p>Set <span class="strong"><strong>Layer</strong></span> to <span class="strong"><strong>Items</strong></span>.</p></li><li><p>Click on the <span class="strong"><strong>Add Component</strong></span> button in the Inspector tab and add <span class="strong"><strong>Sprite Renderer</strong></span> and <span class="strong"><strong>Box Collider 2D</strong></span> components.</p></li><li><p>Leave the <span class="strong"><strong>Sprite</strong></span> field of the <span class="strong"><strong>Sprite Renderer</strong></span> component blank.</p></li><li><p>In the <span class="strong"><strong>Sorting Layer</strong></span> field of the <span class="strong"><strong>Sprite Renderer</strong></span> component, set the sorting layer to <span class="strong"><strong>Items</strong></span>.</p></li><li><p>In the <span class="strong"><strong>Box Collider 2D</strong></span> component, check the <span class="strong"><strong>Is Trigger</strong></span> checkbox.</p></li><li><p>Drag and drop the new <span class="strong"><strong>Item</strong></span> Prefab into the <span class="strong"><strong>Prefabs</strong></span> folder and delete it from the <span class="strong"><strong>Hierarchy</strong></span> panel.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec36"></a>Item code</h3></div></div></div><p>After the prefab is made, create a<a id="id227" class="indexterm"></a> new script in the <span class="strong"><strong>Scripts</strong></span> folder. You can name the script <code class="literal">Item.cs</code>. This will be our <code class="literal">Item</code> class. We are going to use one prefab and one script to morph the item into several different types of items. So, open up <code class="literal">Item.cs</code> for editing. The following <span class="emphasis"><em>Code Snip 5.6</em></span> shows the full <code class="literal">Item</code> class:</p><div class="informalexample"><pre class="programlisting">1 using UnityEngine;
2 using System;
3 using Random = UnityEngine.Random;
4
5 public enum itemType {
6   glove, boot
7 }
8
9 public class Item : MonoBehaviour {
10 
11  public Sprite glove;
12  public Sprite boot;
13
14  public itemType type;
15  public Color level;
16  public int attackMod, defenseMod;
17
18  private SpriteRenderer spriteRenderer;
19
20  public void RandomItemInit () {
21    spriteRenderer = GetComponent&lt;SpriteRenderer&gt; ();
22    SelectItem ();
23  }
24
25  private void SelectItem () {
26    var itemCount = Enum.GetValues(typeof(itemType)).Length;
27    type = (itemType)Random.Range(0,itemCount);
28    
29    switch (type) {
30      case itemType.glove:
31        attackMod = Random.Range(1,4);
32        defenseMod = 0;
33        spriteRenderer.sprite = glove;
34        break;
35      case itemType.boot:
36        attackMod = 0;
37        defenseMod = Random.Range(1,4);
38        spriteRenderer.sprite = boot;
39        break;
40    }
41    
42    int randomLevel = Random.Range(0, 100);
43    if (randomLevel &gt;= 0 &amp;&amp; randomLevel &lt; 50) {
44      spriteRenderer.color = level = Color.blue;
45      attackMod += Random.Range(1,4);
46      defenseMod += Random.Range(1,4);
47    }
48    else if (randomLevel &gt;= 50 &amp;&amp; randomLevel &lt; 75) {
49      spriteRenderer.color = level = Color.green;
50      attackMod += Random.Range(4,10);
51      defenseMod += Random.Range(4,10);
52    }
53    else if (randomLevel &gt;= 75 &amp;&amp; randomLevel &lt; 90) {
54      spriteRenderer.color = level = Color.yellow;
55      attackMod += Random.Range(15,25);
56      defenseMod += Random.Range(15,25);
57    }
58    else {
59      spriteRenderer.color = level = Color.magenta;
60      attackMod += Random.Range(40,55);
61      defenseMod += Random.Range(40,55);
62    }
63  }
64 }</pre></div><p>Let's take a look at how the<a id="id228" class="indexterm"></a> Item class works:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">Line 3</code>: Set <code class="literal">Random</code> to use <code class="literal">UnityEngine.Random</code>.</p></li><li style="list-style-type: disc"><p><code class="literal">Lines 5-7</code>: We are making another public enumeration that will tell us the current kind of Item type, which is either a <code class="literal">glove</code> or <code class="literal">boot</code>.</p></li><li style="list-style-type: disc"><p><code class="literal">Lines 11-12</code>: We will need a reference to the <code class="literal">glove</code> and <code class="literal">boot</code> sprites.</p></li><li style="list-style-type: disc"><p><code class="literal">Line 14</code>: We will keep a variable that holds the items type for reference.</p></li><li style="list-style-type: disc"><p><code class="literal">Line 15</code>: The color of the item is going to represent how powerful the item is.</p></li><li style="list-style-type: disc"><p><code class="literal">Line 16</code>: The <code class="literal">attackMod</code> and <code class="literal">defenseMod</code> variables will be the actual numeric value that gets added to the player's attack power of defense.</p></li><li style="list-style-type: disc"><p><code class="literal">Line 18</code>: We will need a reference to Sprite Renderer to change the sprite.</p></li><li style="list-style-type: disc"><p><code class="literal">Lines 20-23</code>: This will be the function that is called by the <code class="literal">Chest</code> class when a chest is opened.</p></li><li style="list-style-type: disc"><p><code class="literal">Lines 25-63</code>: The <code class="literal">SelectItem</code> function will generate the randomized Item.</p></li><li style="list-style-type: disc"><p><code class="literal">Lines 26-27</code>: Randomly choose an Item type.</p></li><li style="list-style-type: disc"><p><code class="literal">Lines 29-40</code>: Based on the type we input, the item will have a corresponding base value. The item will have a higher <code class="literal">attackMod</code> value if it is a glove or a higher <code class="literal">defenceMod</code> value if it is a boot.</p></li><li style="list-style-type: disc"><p><code class="literal">Lines 42-62</code>: This section will change the color and adjust the modifiers. Blue is most likely to spawn but is the weakest. Magenta is the least likely to spawn and is the most powerful. The values are all randomized within a range so each item is a little different.</p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec37"></a>Adding player to item interaction</h3></div></div></div><p>Now, our randomized <a id="id229" class="indexterm"></a>item class is ready to deploy. You can return<a id="id230" class="indexterm"></a> to the Unity Editor and add the <code class="literal">Item</code> script to the <span class="strong"><strong>Item</strong></span> prefab. There are some additional settings now that we will need to define:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Set the sprite in the <span class="strong"><strong>Glove</strong></span> field to <span class="strong"><strong>Items_Sprite_sheet_2</strong></span></p></li><li style="list-style-type: disc"><p>Set the sprite in the <span class="strong"><strong>Boot</strong></span> field to <span class="strong"><strong>Items_Sprite_sheet_3</strong></span></p></li><li style="list-style-type: disc"><p>The other parameters are set at runtime by the script</p></li></ul></div><p>We still need to implement the <code class="literal">Player</code> class interaction with the <code class="literal">Chest</code> and <code class="literal">Item</code> classes. Open up the <code class="literal">Player.cs</code> script for editing. <span class="emphasis"><em>Code Snip 5.8</em></span> shows the changes needed for the item interaction:</p><div class="informalexample"><pre class="programlisting">16  public Image glove;
17  public Image boot;
18
19   public int attackMod = 0, defenseMod = 0;
20  private Dictionary&lt;String, Item&gt; inventory;
21  
22  protected override void Start () {
23    animator = GetComponent&lt;Animator&gt;();
24    health = GameManager.instance.healthPoints;
25    healthText.text = "Health: " + health;
26    position.x = position.y = 2;
27    onWorldBoard = true;
28    dungeonTransition = false;
29
30    inventory = new Dictionary&lt;String, Item&gt; ();
31
32    base.Start ();
33      }
…
61 if(horizontal != 0 || vertical != 0) {
62  if (!dungeonTransition) {
63    if (onWorldBoard)
64      canMove = AttemptMove&lt;Wall&gt; (horizontal, vertical);
65    else 
66      canMove = AttemptMove&lt;Chest&gt; (horizontal, vertical);
67
...
86  protected override void OnCantMove &lt;T&gt; (T component) {
87    if (typeof(T) == typeof(Wall)) {
88      Wall blockingObj = component as Wall;
89      blockingObj.DamageWall (wallDamage);
90    }
91    else if (typeof(T) == typeof(Chest)) {
92      Chest blockingObj = component as Chest;
93      blockingObj.Open ();
94    }
95
96    animator.SetTrigger ("playerChop");
97   }
...
146 private void UpdateInventory (Collider2D item) {
147  Item itemData = item.GetComponent&lt;Item&gt; ();
148  switch(itemData.type) {
149    case itemType.glove:
150      if (!inventory.ContainsKey("glove"))
151        inventory.Add("glove", itemData);
152      else 
153        inventory["glove"] = itemData;
154
155      glove.color = itemData.level;
156    break;
157    case itemType.boot:
158      if (!inventory.ContainsKey("boot"))
159        inventory.Add("boot", itemData);
160      else 
161        inventory["boot"] = itemData;
162
163      boot.color = itemData.level;
164    break;
165  }
166
167  attackMod = 0;
168  defenseMod = 0;
169
170  foreach (KeyValuePair&lt;String, Item&gt; gear in inventory) {
171    attackMod += gear.Value.attackMod;
172    defenseMod += gear.Value.defenseMod;
173  }
174 }
175  
176 private void OnTriggerEnter2D (Collider2D other) {
177  if (other.tag == "Exit") {
178    dungeonTransition = true;
179    Invoke ("GoDungeonPortal", 0.5f);
180    Destroy (other.gameObject);
181  } else if (other.tag == "Food" || other.tag == "Soda") {
182    UpdateHealth(other);
183    Destroy (other.gameObject);
184  } else if (other.tag == "Item") {
185    UpdateInventory(other);
186    Destroy (other.gameObject);
187  }
188 }</pre></div><p>We need to make changes throughout the <code class="literal">Player.cs</code> file. Luckily, they aren't too complicated or lengthy. Let's take a look at what was done:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">Lines 16-17</code>: We<a id="id231" class="indexterm"></a> are going to need to represent <a id="id232" class="indexterm"></a>what items we have in our inventory. These references will be images on screen that show us the type of armor Items we are carrying.</p></li><li style="list-style-type: disc"><p><code class="literal">Lines 19-20</code>: We add the modifiers for later use in the <code class="literal">Player</code> class. Items will now directly affect these player modifiers. We also add a dictionary that will be our inventory.</p></li><li style="list-style-type: disc"><p><code class="literal">Line 30</code>: Inside the <code class="literal">Start</code> function, we initialize our inventory.</p></li><li style="list-style-type: disc"><p><code class="literal">Lines 63-66</code>: Inside the <code class="literal">Update</code> function, we need to a check to see what blocking object we are sending to the <code class="literal">AttemptMove</code> function. For now, we assume that the player will only be blocked by walls on the world board and chests on the Dungeon Board.</p></li><li style="list-style-type: disc"><p><code class="literal">Lines 86-97</code>: We made our <code class="literal">OnCantMove</code> function accept a generic type <code class="literal">T</code>, which will either be a wall or chest at the moment. So, we need to check the type of incoming blocking object. We then call that blocking object's public interaction method.</p></li><li style="list-style-type: disc"><p><code class="literal">Lines 146-174</code>: The <code class="literal">UpdateInventory</code> method will be called when the player picks up a new Item. We are only going to allow one item of each type in our inventory at the moment, so we first check the Item type against what we currently have in our inventory. If we already have one item of that type, say boots, we replace it with the new boots we just picked up. Otherwise, we just accept the newly picked item into the empty slot in our inventory. We also want to change the color of our on screen inventory to match the color of the Item we just picked up. After, we calculate the new status modifier values.</p></li><li style="list-style-type: disc"><p><code class="literal">Lines 176-188</code>: At the end of the <code class="literal">OnTriggerEnter2D</code> function, we add a check for the <code class="literal">Item</code> tag. We will call the <code class="literal">UpdateInventory</code> method from here if we run into an Item.</p></li></ul></div><p>Before we return to the <a id="id233" class="indexterm"></a>Unity Editor, we need to uncomment the <a id="id234" class="indexterm"></a>commented code from our <code class="literal">Chest.cs</code> file. This will open up another field to edit in the <span class="strong"><strong>Chest</strong></span> prefab. Once you uncomment the code, return to the Unity Editor and add the <span class="strong"><strong>Item</strong></span> prefab to the <span class="strong"><strong>Random Item</strong></span> field of the <span class="strong"><strong>Chest</strong></span> prefab.</p><div class="mediaobject"><img src="/graphics/9781785287473/graphics/B04808_05_08.jpg" /><div class="caption"><p>chest and item but no visible inventory</p></div></div><p>Now, we can play the game and see our item system in action. You can find a chest and open it to reveal a random item. However, you still can't pick it up. Even if you could pick up the item, you would really have no way of knowing what is in your inventory. We did write the code that would handle this though. We only need to add the UI elements that will display our inventory. Here is what we need to add:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In <span class="strong"><strong>Hierarchy</strong></span>, right-click on the <span class="strong"><strong>Canvas</strong></span> object.</p></li><li><p>Navigate to <span class="strong"><strong>UI</strong></span> | <span class="strong"><strong>Image</strong></span>.</p></li><li><p>Name image <code class="literal">GloveImage</code>.</p></li><li><p>Set both <span class="strong"><strong>Width</strong></span> and Height to <code class="literal">50</code>.</p></li><li><p>Set <span class="strong"><strong>Pos X</strong></span> to <code class="literal">-430</code> and <span class="strong"><strong>Pos Y</strong></span> to <code class="literal">-180</code>.</p></li><li><p>Set <span class="strong"><strong>Source Image</strong></span> to <span class="strong"><strong>Items_Sprite_Sheet_2</strong></span>.</p></li><li><p>Create another image.</p></li><li><p>Name the image <code class="literal">BootImage</code>.</p></li><li><p>Set <span class="strong"><strong>Pos X</strong></span> to <code class="literal">-365</code> and <span class="strong"><strong>Pos Y</strong></span> to <code class="literal">-180</code>.</p></li><li><p>Set <span class="strong"><strong>Source Image</strong></span> to <span class="strong"><strong>Items_Sprite_Sheet_3</strong></span>.</p></li></ol></div><p>In order to activate the <a id="id235" class="indexterm"></a>inventory images, we need to set the references<a id="id236" class="indexterm"></a> in the <span class="strong"><strong>Player</strong></span> prefab. Select the <span class="strong"><strong>Player</strong></span> object in the <span class="strong"><strong>Hierarchy</strong></span> panel and find the <span class="strong"><strong>Glove</strong></span> and <span class="strong"><strong>Boot</strong></span> fields in the <span class="strong"><strong>Inspector</strong></span> tab. Drag and drop the <span class="strong"><strong>GloveImage</strong></span> and <span class="strong"><strong>BootImage</strong></span> respectively. Click on the <span class="strong"><strong>Apply</strong></span> button at the top.</p><div class="mediaobject"><img src="/graphics/9781785287473/graphics/B04808_05_09.jpg" /><div class="caption"><p>Picked up items show in inventory</p></div></div><p>Now, we have all we need to pick up items and actually see what we have in our inventory. Try this functionality out. While playing, view the player in the <span class="strong"><strong>Inspector</strong></span> tab and look at the <span class="strong"><strong>Attack Mod</strong></span> and <span class="strong"><strong>Defense Mod</strong></span> fields. They will change with every item you pick up.</p></div></div>