<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec35"></a>Generating health items in the game world</h2></div></div><hr /></div><p>Eventually, our player will be <a id="id205" class="indexterm"></a>fighting for survival against an onslaught<a id="id206" class="indexterm"></a> of baddies. It is inevitable that the player will take some health damage, so we need to provide a way for him or her to recover and continue playing. Providing the player with health recovery items is the most common approach. So, we will do just that but as usual we want to procedurally generate the items.</p><p>Rather than just randomly laying our health item tiles about the world board, we can use the environment we have created to add a layer of interactivity. The wall tiles that inhabit the world board are already laid at random. They are also destructible. We can, thus, use the wall tiles as a potential container for our health items.</p><p>By doing this, we have added a layer of game play for the player. The player now has to <span class="emphasis"><em>forage</em></span> for their health items while confronted by foes. This should add to the suspense, difficulty, and reward factors, which contribute to the overall fun of the game.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec31"></a>Implementing health item generation</h3></div></div></div><p>With our first <a id="id207" class="indexterm"></a>feature, health item generation, we have three tasks ahead of us:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Modifying the <code class="literal">Wall</code> script</p></li><li style="list-style-type: disc"><p>Setting up sprites</p></li><li style="list-style-type: disc"><p>Interacting with health items</p></li></ul></div><p>The first thing we have to do is modify our <code class="literal">Wall</code> script for the added functionality. The <code class="literal">Wall</code> script was written with the intention that the player would be able to destroy wall tiles. All we have to do is add a condition to the destruction of the wall that will spawn a food item. Food items will be our health items in this game. Open up <code class="literal">Wall.cs</code> for editing and take a look at the changes made to it in <span class="emphasis"><em>Code Snip 5.1</em></span>:</p><div class="informalexample"><pre class="programlisting">1 using UnityEngine;
2 using System.Collections;
3 using Random = UnityEngine.Random;
4
5 public class Wall : MonoBehaviour {
6   public Sprite dmgSprite;
7   public int hp = 3;
8   public GameObject[] foodTiles;
9
10  private SpriteRenderer spriteRenderer;
11
12  void Awake () {
13    spriteRenderer = GetComponent&lt;SpriteRenderer&gt; ();
14  }
15
16  public void DamageWall (int loss) {
17
18    spriteRenderer.sprite = dmgSprite;
19    hp -= loss;
20
21    if (hp &lt;= 0) {
22      if (Random.Range (0,5) == 1) {
23        GameObject toInstantiate = foodTiles [Random.Range (0, foodTiles.Length)];
24        GameObject instance = Instantiate (toInstantiate, new Vector3 (transform.position.x, transform.position.y, 0f), Quaternion.identity) as GameObject;
25        instance.transform.SetParent (transform.parent);
26      }
27
28      gameObject.SetActive (false);
29    }
30  }
31 }</pre></div><p><span class="emphasis"><em>Code Snip 5.1</em></span> shows <code class="literal">Wall.cs</code> with the necessary changes. Let's see what was done:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">Line 3</code>: We<a id="id208" class="indexterm"></a> set <code class="literal">Random</code> to be the <code class="literal">UnityEngine.Random</code> library as we have done before. Remember that there are two random libraries, one is the C# language built-in and the other is the Unity built-in.</p></li><li style="list-style-type: disc"><p><code class="literal">Line 8</code>: We are going to add a <code class="literal">GameObject</code> array to hold the two different food item tiles. We use the same technique in our <code class="literal">BoardManager</code> class with the other tile types.</p></li><li style="list-style-type: disc"><p><code class="literal">Lines 22-26</code>: This is the wall destruction condition. Given a certain probability dictated by a PRN value, we set a food tile in place of the wall tile. The actual instantiation of the food tile is the same technique we use in the <code class="literal">BoardManager</code> class.</p></li></ul></div><p>This is a fairly quick and easy adjustment to the <code class="literal">Wall</code> class to make it yield food items. At this point, we are potentially creating a paradigm by making destructible objects that will produce items for the player. It might be a good idea to make a base class that controls the general functionality of the <code class="literal">Wall</code> class and any class like the wall. This was done for the <code class="literal">Player</code> class inheriting the <code class="literal">MovingObject</code> class because we anticipate a similar <code class="literal">Enemy</code> class. This base class creation will be left up to you, though.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec08"></a>Setting up sprites</h4></div></div></div><p>In order to have our food items <a id="id209" class="indexterm"></a>appear on screen, we need to set up their sprites. Go back to the Unity Editor. We are going to make two more prefabs represent the food items:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>From the top menu, navigate to <span class="strong"><strong>GameObject</strong></span> | <span class="strong"><strong>Create Empty</strong></span>.</p></li><li><p>Select the new empty object in the <span class="strong"><strong>Hierarchy</strong></span> panel.</p></li><li><p>Name the object <code class="literal">Food</code>.</p></li><li><p>Set <span class="strong"><strong>Layer</strong></span> to <span class="strong"><strong>Items</strong></span>.</p></li><li><p>Add the tag <span class="strong"><strong>Food</strong></span>.</p></li><li><p>Click on the <span class="strong"><strong>Add Component</strong></span> button in the <span class="strong"><strong>Inspector</strong></span> tab and add a <span class="strong"><strong>Sprite Renderer</strong></span> and a <span class="strong"><strong>Box Collider 2D</strong></span>.</p></li><li><p>In the <span class="strong"><strong>Sprite</strong></span> field of the <span class="strong"><strong>Sprite Renderer</strong></span> component, select <span class="strong"><strong>Scavangers_SpriteSheet_19</strong></span>.</p></li><li><p>In the <span class="strong"><strong>Sorting Layer</strong></span> field of the <span class="strong"><strong>Sprite Renderer</strong></span> component, set <span class="strong"><strong>Sorting Layer</strong></span> to <span class="strong"><strong>Items</strong></span>.</p></li><li><p>In the <span class="strong"><strong>Box Collider 2D</strong></span> component, check the <span class="strong"><strong>Is Trigger</strong></span> checkbox.</p><div class="mediaobject"><img src="/graphics/9781785287473/graphics/B04808_05_02.jpg" /><div class="caption"><p>Food item setting</p></div></div></li></ol></div><p>You can drag and drop the <a id="id210" class="indexterm"></a>new <span class="strong"><strong>Food</strong></span> prefab into the <span class="strong"><strong>Prefabs</strong></span> folder and delete it from the <span class="strong"><strong>Hierarchy</strong></span> panel. You are going to do the same thing for the second food prefab, which we will call <code class="literal">Soda</code>. However, for step 3, name the GameObject <code class="literal">Soda</code>, and set the tag to <code class="literal">Soda</code> as well. Use the <span class="strong"><strong>Scavangers_SpriteSheet_18</strong></span> file in step 7 for your sprite.</p><p>We now have to add the food items to the <span class="strong"><strong>Wall</strong></span> prefabs. Select all 8 <span class="strong"><strong>Wall</strong></span> prefabs so that we can edit them at the same time. Under the <span class="strong"><strong>Food Tiles</strong></span> array field, set the size to <code class="literal">2</code>. Then, drag and drop the <span class="strong"><strong>Food</strong></span> and <span class="strong"><strong>Soda</strong></span> prefabs into the newly created element slots and delete the <span class="strong"><strong>Food</strong></span> and <span class="strong"><strong>Soda</strong></span> prefabs from the <span class="strong"><strong>Hierarchy</strong></span> panel.</p><div class="mediaobject"><img src="/graphics/9781785287473/graphics/B04808_05_03.jpg" /><div class="caption"><p>Health item appears when a wall is destroyed</p></div></div><p>If you play the game <a id="id211" class="indexterm"></a>now, our health items should be active. Try destroying some wall tiles to produce some health items. You will notice that we can't actually interact with the items yet. We need to make another adjustment in our code that will allow the player to pick up the health item. This will be done in the <code class="literal">Player.cs</code> file, and <span class="emphasis"><em>Code Snip 5.2</em></span> shows the changes:</p><div class="informalexample"><pre class="programlisting">134 private void UpdateHealth (Collider2D item) {
135  if (health &lt; 100) {
136    if (item.tag == "Food") {
137      health += Random.Range (1,4);
138    } else {
139      health += Random.Range (4,11);
140    }
141    GameManager.instance.healthPoints = health;
142    healthText.text = "Health: " + health;
143  }
144 }
145 private void OnTriggerEnter2D (Collider2D other) {
146  if (other.tag == "Exit") {
147    dungeonTransition = true;
148    Invoke ("GoDungeonPortal", 0.5f);
149    Destroy (other.gameObject);
150  } else if (other.tag == "Food" || other.tag == "Soda") {
151    UpdateHealth(other);
152    Destroy (other.gameObject);
153  }
154 }</pre></div><p>The changes needed in<a id="id212" class="indexterm"></a> the <code class="literal">Player.cs</code> file come at the end of the file. We need a function that will update our player health, and then we need to update the <code class="literal">OnTriggerEnter2D</code> method so that we can interact with health items. Let's take a look at how the functions work:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">Lines 134-144</code>: <code class="literal">UpdateHealth</code> will update our health value that is displayed at the bottom of the screen in game play. It takes a <code class="literal">Collider2D</code> that we will pass in from the <code class="literal">OnTriggerEnter2D</code> function.</p></li><li style="list-style-type: disc"><p><code class="literal">Line 135</code>: We don't want to exceed our maximum health so we will need to make sure we are under 100.</p></li><li style="list-style-type: disc"><p><code class="literal">Line 136-140</code>: We check to see if the item is <code class="literal">Food</code> or <code class="literal">Soda</code>. We will say that <code class="literal">Soda</code> provides more health than <code class="literal">Food</code>. But in the PCG fashion, we will let PRNs dictate the specific value of health we gain from the health items.</p></li><li style="list-style-type: disc"><p><code class="literal">Line 141-142</code>: Here, we make adjustments to the health value that the player sees.</p></li><li style="list-style-type: disc"><p><code class="literal">Lines 145-154</code>: The <code class="literal">OnTriggerEnter2D</code> function was used in the previous chapter to make it possible for the player to enter a dungeon.</p></li><li style="list-style-type: disc"><p><code class="literal">Line 150-153</code>: We added another tag check to detect a collision with <code class="literal">Food</code> or <code class="literal">Soda</code>. If we hit a health item, we are going to call our newly added <code class="literal">UpdateHealth</code> function.</p></li></ul></div><p>You can return to the Unity Editor to test the new health item functionality. First, you will want to set your health below 100. You can do this by selecting the <span class="strong"><strong>GameManager</strong></span> prefab in the <span class="strong"><strong>Prefabs</strong></span> folder and setting <span class="strong"><strong>Health Points</strong></span> to some value less than 100.</p><div class="mediaobject"><img src="/graphics/9781785287473/graphics/B04808_05_04.jpg" /><div class="caption"><p>Where to find and set health points</p></div></div><p>Now, you can play the <a id="id213" class="indexterm"></a>game. Destroy some walls to produce some health items. When you walk over the health item, you will see the health value onscreen increase. This will aid the player in surviving in the game. Adding health items was an almost easy task, but it gave us some insight on how we might approach our next item addition.</p></div></div></div>