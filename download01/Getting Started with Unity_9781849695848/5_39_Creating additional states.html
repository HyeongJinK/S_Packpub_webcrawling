<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec41"></a>Creating additional states</h2></div></div><hr /></div><p>At this stage, we have created an interesting, yet simple, artificial behavior, whereby the enemies<a id="id453" class="indexterm"></a> present in the maze will, if they see the character, or are within a specific radius, walk toward the player and alert all other enemies in this area. We will now include an additional state that we will call <code class="literal">Attack</code>, which will be triggered when these enemies are within reach of the player:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Locate the prefab <code class="literal">Zombie@attack</code> by navigating to <span class="strong"><strong>Assets</strong></span> | <span class="strong"><strong>chapter5</strong></span>| <span class="strong"><strong>chapter5_pack</strong></span>.</p></li><li><p>Click<a id="id454" class="indexterm"></a> once on this prefab, and in the <span class="strong"><strong>Inspector</strong></span> window,<a id="id455" class="indexterm"></a> click on the <span class="strong"><strong>Rig</strong></span> tab.</p></li><li><p>In the new window, select the option <span class="strong"><strong>Humanoid</strong></span> for the attribute <span class="strong"><strong>Animation Type</strong></span><a id="id456" class="indexterm"></a> and click on <span class="strong"><strong>Apply</strong></span>.</p></li><li><p>Click on the <span class="strong"><strong>Animations</strong></span> tab<a id="id457" class="indexterm"></a>, and then click on the label <span class="strong"><strong>attack</strong></span>, this will provide information on the attack clip.</p></li><li><p>Scroll down the window, check the box for the attribute <span class="strong"><strong>Loop Pose</strong></span> and click on<a id="id458" class="indexterm"></a> <span class="strong"><strong>Apply</strong></span> to apply this change.</p></li><li><p>In the <span class="strong"><strong>Project</strong></span> view<a id="id459" class="indexterm"></a>, click on the arrow located to the left of the prefab <code class="literal">Zombie@attack</code> it will reveal items included in this prefab, including an animation called <code class="literal">attack</code> symbolized by gray box with a white triangle.</p></li><li><p>Check that the <span class="strong"><strong>Animator</strong></span> window<a id="id460" class="indexterm"></a> is open and drag the animation attack to the <span class="strong"><strong>Animator</strong></span> window.</p></li><li><p>This<a id="id461" class="indexterm"></a> will create an attack state; rename this state <span class="strong"><strong>Attack</strong></span> (upper case A) using the Inspector.</p></li><li><p>Check that the <a id="id462" class="indexterm"></a>idle state is the default state</p></li></ol></div><p>Once this<a id="id463" class="indexterm"></a> is done, we will create transitions between these states:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a transition from the state <span class="strong"><strong>WalkForward</strong></span> to the state <span class="strong"><strong>Attack</strong></span>.</p></li><li><p>Create a transition from the state <span class="strong"><strong>Idle</strong></span> to the state <span class="strong"><strong>Attack</strong></span>.</p></li><li><p>Create<a id="id464" class="indexterm"></a> a new Boolean parameter called <code class="literal">withinReach</code>.</p></li><li><p>Select the transition between the states <span class="strong"><strong>WalkForward</strong></span> and <span class="strong"><strong>Attack</strong></span>.</p></li><li><p>In the <span class="strong"><strong>Inspector</strong></span> window<a id="id465" class="indexterm"></a>, set the condition for the transition to <code class="literal">withinReach = true</code>, and leave other attributes as default.</p></li><li><p>Select the transition between the states <span class="strong"><strong>Idle</strong></span> and <span class="strong"><strong>Attack</strong></span>.</p></li><li><p>In the <span class="strong"><strong>Inspector</strong></span> window, set the condition for the transition to <code class="literal">withinReach = true</code>, and leave other attributes as default.</p></li><li><p>Create a transition between the state <span class="strong"><strong>Attack</strong></span> and the state <span class="strong"><strong>WalkForward</strong></span>.</p></li><li><p>Set the conditions for the transition to <code class="literal">withinReach = false</code> and <code class="literal">ExitTime = 0.70</code> (to include an additional condition we can click on the <span class="strong"><strong>+</strong></span> button<a id="id466" class="indexterm"></a> in the same window).</p></li></ol></div><p>The <span class="strong"><strong>Animator</strong></span> window<a id="id467" class="indexterm"></a> should now include three states and two transitions to the state <span class="strong"><strong>Attack</strong></span> as highlighted in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849695848/graphics/5848_05_11.jpg" /></div><p>We have set up the animations in the <span class="strong"><strong>Animator</strong></span> window by defining states and transitions<a id="id468" class="indexterm"></a> conditions; we now need to trigger these states within the script. Ideally, we would like the attack to be triggered when the enemies are within <a id="id469" class="indexterm"></a>approximately 1.5 meter from the player. Let's modify the <code class="literal">controlZombie</code> script to implement this behavior:</p><p>Open<a id="id470" class="indexterm"></a> the script <code class="literal">controlZombie</code> and add the following lines of code to the function <code class="literal">Update</code> just after the code that calculates the distance:</p><div class="informalexample"><pre class="programlisting">if (distance &lt; 1.5f) anim.SetBool("withinReach",true);
 else anim.SetBool("withinReach",false);</pre></div><p>The variable <code class="literal">distance</code><a id="id471" class="indexterm"></a> has already been defined in this script to detect the distance between the player and the enemies. In the previous code, we use this variable to determine whether the player is within reach, so that the attack can be perpetrated. If the distance is less than 1.5 meters, the parameter <code class="literal">withinReach</code> is set to <code class="literal">true</code> (and the state should change accordingly to <span class="strong"><strong>Attack</strong></span>). If the distance is more than 1.5 meters, <a id="id472" class="indexterm"></a>then the animator parameter <code class="literal">withinReach</code> is set to <code class="literal">false</code>, and the state should change accordingly to <code class="literal">WalkForward</code>.</p><p>Finally, we will create two additional states: a state when a bullet hits an enemy and a state when the enemy dies following significant injuries. Following the steps and instructions described previously, create a state called <span class="strong"><strong>Hit</strong></span>, based on the prefab <code class="literal">Zombie@hit</code>. <a id="id473" class="indexterm"></a>We don't need to loop this animation.</p><p>We then need to create transitions to the state <span class="strong"><strong>Hit</strong></span> from the states <span class="strong"><strong>WalkForward</strong></span>, <span class="strong"><strong>Idle</strong></span>, or <span class="strong"><strong>Attack</strong></span>:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create three transitions: from the state <span class="strong"><strong>WalkForward</strong></span> to the state <span class="strong"><strong>Hit</strong></span>, from the state <span class="strong"><strong>Idle</strong></span> to the state <span class="strong"><strong>Hit</strong></span>, and from the state <span class="strong"><strong>Attack</strong></span> to the state <span class="strong"><strong>Hit</strong></span>.</p></li><li><p>Create a new Boolean parameter called <code class="literal">hit</code>, select the transition from the state <a id="id474" class="indexterm"></a>
<span class="strong"><strong>Idle</strong></span> to the state <span class="strong"><strong>Hit</strong></span>, and set the condition for the transition to <code class="literal">hit = true</code>, and leave the other attributes as default.</p></li><li><p>Repeat the last step for the transition from the state <span class="strong"><strong>WalkForward</strong></span> to <span class="strong"><strong>Hit</strong></span>, and from the state <span class="strong"><strong>Attack</strong></span> to <span class="strong"><strong>Hit</strong></span>.</p></li><li><p>Finally, <a id="id475" class="indexterm"></a>create a transition between the state <span class="strong"><strong>Hit</strong></span> and the state <span class="strong"><strong>WalkForward</strong></span>, and set the transition condition to <code class="literal">Exit Time = 0.9</code>. In this case, when the enemy is hit, it will start walking toward the user, regardless of its previous state (that is, <code class="literal">idle</code>, <code class="literal">walking</code>, or <code class="literal">attack</code>).</p></li></ol></div><p>The following figure highlights the new state and transitions that we have just created:</p><div class="mediaobject"><img src="/graphics/9781849695848/graphics/5848_05_13.jpg" /></div><p>Finally, to be able to trigger these states, we will need to modify the script that fires bullets. If the bullet hits the enemy, then its state will change accordingly. Open the script <code class="literal">shootBullet</code><a id="id476" class="indexterm"></a> and add the following code within the function <code class="literal">Update</code>, inside the conditional statement that starts with <code class="literal">if(Physics.Raycast (ray, hit, 100))</code>.</p><div class="informalexample"><pre class="programlisting">if (hit.collider.gameObject.tag == "zombie")
{
  hit.collider.gameObject.GetComponent(Animator).SetBool("hit",true);
}</pre></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>In statement 1 of the previous code, we check whether the bullet has collided with an enemy</p></li><li style="list-style-type: disc"><p>In statement 2 of the previous code, if this is the case, the Boolean parameter labeled <code class="literal">hit</code> is set to <code class="literal">true</code> for the corresponding animator</p></li></ul></div><p>We have created all necessary transitions; if we test our scene, we can see that the enemy, when hit by a bullet, transitions indefinitely between the states <span class="strong"><strong>Hit</strong></span> and <span class="strong"><strong>WalkForward</strong></span>. This is because the Boolean variable <code class="literal">hit</code> is set to <code class="literal">true</code> all the time, causing the transition from the state <span class="strong"><strong>WalkForward</strong></span> to the state <span class="strong"><strong>Hit</strong></span> to occur indefinitely. To fix <a id="id477" class="indexterm"></a>this, we need to set the variable <code class="literal">hit</code> to <code class="literal">false</code> once the transition has occurred from the state <span class="strong"><strong>Idle</strong></span>, <span class="strong"><strong>Attack</strong></span>, or <span class="strong"><strong>WalkForward</strong></span> to the state <span class="strong"><strong>Hit</strong></span>. This can be achieved by setting the variable <code class="literal">hit</code><a id="id478" class="indexterm"></a> to <code class="literal">false</code> when the enemy is in the state <span class="strong"><strong>Hit</strong></span>. We can do this through script by adding the following<a id="id479" class="indexterm"></a> line at the start of the script <code class="literal">controlZombie</code>:</p><div class="informalexample"><pre class="programlisting">var HitState:int = Animator.StringToHash("Base Layer.Hit");</pre></div><p>The previous line of code declares a state for the animator, so that we can monitor the state <span class="strong"><strong>Hit</strong></span>. Let's add the following lines in the function <code class="literal">Update</code>, within the <code class="literal">switch</code> structure:</p><div class="informalexample"><pre class="programlisting">case hitState:
  anim.SetBool("hit",false);
  break;</pre></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>In line 1 of the previous code, we test whether the enemy is in the state called <span class="strong"><strong>Hit</strong></span></p></li><li style="list-style-type: disc"><p>In line 3 of the previous code, if this is the case, we set the Boolean variable <code class="literal">hit</code> to <code class="literal">false</code></p></li></ul></div><p>Test the game, shoot at the zombie in the scene, and check that it behaves as expected (that is, following the player after being hit).</p><p>We now need to add a final state to our enemy, the state called <span class="strong"><strong>Dead</strong></span>. The enemy will enter<a id="id480" class="indexterm"></a> this state when it has sustained significant injuries. The zombie should not be able to transition to any other states from this state.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Following the steps described in the previous pages, create a state called <span class="strong"><strong>Dead</strong></span>, based on the prefab <code class="literal">Zombie@dead</code>. This animation does not need to loop.</p></li><li><p>Create a <a id="id481" class="indexterm"></a>new Boolean parameter called <code class="literal">die</code>.</p></li><li><p>Create a transition from the state <span class="strong"><strong>Hit</strong></span> to the state <span class="strong"><strong>Dead</strong></span>.</p></li><li><p>Set the condition for this transition to <code class="literal">die = true</code>.</p></li></ol></div><p>The state machine should now look as illustrated in the following screenshot (the new transition and state have been highlighted with a circle).</p><div class="mediaobject"><img src="/graphics/9781849695848/graphics/5848_05_14.jpg" /></div><p>We will manage this state through JavaScript and create the necessary code to increase damage<a id="id482" class="indexterm"></a> to the enemy when it has been hit. Add the following two lines to the start of the script <code class="literal">controlZombie</code>:</p><div class="informalexample"><pre class="programlisting">public var damage:int;
public var DeadState:int = Animator.StringToHash("Base Layer.Dead");</pre></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>In<a id="id483" class="indexterm"></a> statement 1 of the previous code, we declare a new integer variable called <code class="literal">damage</code>, that will be used to keep track of the damage inflicted to the enemy</p></li><li style="list-style-type: disc"><p>In statement 2 of the previous code, we declare a new state for the animator so that we can detect when the enemy is in the <span class="strong"><strong>Dead</strong></span> state</p></li></ul></div><p>Also, add the following line within the <code class="literal">Start</code> function<a id="id484" class="indexterm"></a> to initialize the variable damage:</p><div class="informalexample"><pre class="programlisting">damage = 0;</pre></div><p>Next, we need to apply damage to the zombie, every time it is being hit by a bullet. This can be done by<a id="id485" class="indexterm"></a> adding the following code in the function <code class="literal">Update</code><a id="id486" class="indexterm"></a> within the <code class="literal">switch</code> structure:</p><div class="informalexample"><pre class="programlisting">case hitState:
<span class="strong"><strong>  if (anim.GetBool("hit")) damage++;</strong></span>
<span class="strong"><strong>  if (damage &gt;=5) anim.SetBool("die",true);</strong></span>
  anim.SetBool("hit",false);
  break;</pre></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>In line 3 of the previous code, if the enemy has just been hit, then the damage is increased</p></li><li style="list-style-type: disc"><p>In line 4 of the previous code, if this damage is <code class="literal">5</code> or more, then the Boolean parameter <code class="literal">die</code><a id="id487" class="indexterm"></a> for the animation is set to <code class="literal">true</code></p></li><li style="list-style-type: disc"><p>In line 5 of the previous code, the parameter <code class="literal">hit</code> is set to <code class="literal">false</code> so that the damage is not increased continuously while the animation is played</p></li></ul></div><p>Last but not least, we need to assess the damage caused by the enemy on the player every time it is attacking the player. Add the following code to the start of the script <code class="literal">controlZombie</code>:</p><div class="informalexample"><pre class="programlisting">var attackState:int = Animator.StringToHash("Base Layer.Attack");</pre></div><p>In the previous line of code, we declared a new state for the animator, so that we can detect when the enemy is in the state <span class="strong"><strong>Attack</strong></span>.</p><p>Now that we have managed to create the corresponding state, we need to decrease the player's health when it is attacked.</p><p>First,<a id="id488" class="indexterm"></a> let's create a new function in the script <code class="literal">healthBar</code> to decrease the player's health:</p><div class="informalexample"><pre class="programlisting">function decreaseHealth (increment : int)
{
  currHealth -= increment;
{</pre></div><p>Then, let's create a new function in the script <code class="literal">controlZombie</code>:</p><div class="informalexample"><pre class="programlisting">function applyDamage()
{
GameObject.Find("healthBar").GetComponent(healthBar).SendMessage("decreaseHealth",5);
yield WaitForSeconds(3);
}</pre></div><p>Finally, we can add the following line of code in the script <code class="literal">controlZombie</code> in the function <code class="literal">Update</code><a id="id489" class="indexterm"></a>, within<a id="id490" class="indexterm"></a> the <code class="literal">switch</code> structure:</p><div class="informalexample"><pre class="programlisting">case attackState:
  applyDamage();
  anim.SetBool("withinReach",false);
  break;</pre></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>In line <a id="id491" class="indexterm"></a>1 of the previous code, we check whether the enemy is in the state called <span class="strong"><strong>Attack</strong></span>.</p></li><li style="list-style-type: disc"><p>In line 2 of the previous code, if this is the case, we decrease the health of the player<a id="id492" class="indexterm"></a> by <code class="literal">5</code>. This is done by calling the function <code class="literal">decreaseHealth</code> that is within the script <code class="literal">healthBar</code>. This function, <a id="id493" class="indexterm"></a>as we have seen previously, takes one parameter that is the amount by which the health should be decreased.</p></li></ul></div><p>Test the scene and check that the health of the character decreases as enemies are attacking the player. As we test the scene, we will notice that the health of the player drops to <code class="literal">0</code> after the first attack, whereas it should decrease progressively by <code class="literal">5</code> after each attack. This is because the health is decreased constantly as the attack animation is being played. As a result, we need to create a Boolean variable that will help us to ensure that the energy is decreased only once per attack.</p><p>Add the<a id="id494" class="indexterm"></a> following line at the start of the script <code class="literal">controlZombie</code>:</p><div class="informalexample"><pre class="programlisting">public var hasAttacked:boolean = false;</pre></div><p>Add the following code at the start of the code dedicated to the state <code class="literal">walkForwardState</code> as highlighted in the following code snippet:</p><div class="informalexample"><pre class="programlisting">case walkForwardState:
<span class="strong"><strong>  hasAttacked = false;</strong></span>
</pre></div><p>Modify<a id="id495" class="indexterm"></a> the code related to the state <span class="strong"><strong>Attack</strong></span> as highlighted in the following code snippet:</p><div class="informalexample"><pre class="programlisting">case attackState:
<span class="strong"><strong>  if (!hasAttacked)</strong></span>
<span class="strong"><strong>  {</strong></span>
<span class="strong"><strong>    applyDamage();</strong></span>
<span class="strong"><strong>    hasAttacked = true;</strong></span>
<span class="strong"><strong>  }</strong></span>
  anim.SetBool("withinReach",false);
  break;</pre></div><p>Finally, we need to destroy the zombie a few seconds after it has entered the state <span class="strong"><strong>Dead</strong></span>. This <a id="id496" class="indexterm"></a>can be done by adding the following code in the function <code class="literal">Update</code><a id="id497" class="indexterm"></a> within<a id="id498" class="indexterm"></a> the <code class="literal">switch</code> structure:</p><div class="informalexample"><pre class="programlisting">case deadState:
  Destroy(gameObject, 3.0);
  break;</pre></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>In line 1 of the<a id="id499" class="indexterm"></a> previous code, we check whether the enemy has entered the <span class="strong"><strong>Dead</strong></span> state</p></li><li style="list-style-type: disc"><p>In line 2 of the previous code, the zombie is destroyed after 3 seconds</p></li></ul></div><p>Test the scene and check that the health of the player decreases progressively after each attack. Also, shoot at the zombie more than five times, and check that it disappears within three seconds.</p><p>Once this is working, we will create a prefab from this enemy so that it can be duplicated later:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select the folder <span class="strong"><strong>Assets</strong></span> | <span class="strong"><strong>chapter5</strong></span> in the <span class="strong"><strong>Project</strong></span> window.</p></li><li><p>From the <span class="strong"><strong>Project</strong></span> window, select <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Prefab</strong></span>. This will create a new prefab.</p></li><li><p>Drag-and-drop the object labeled <code class="literal">zombie_hires</code> from the <span class="strong"><strong>Hierarchy</strong></span> window on this prefab.</p></li><li><p>Rename <a id="id500" class="indexterm"></a>this prefab <code class="literal">staticEnemy</code>.</p></li></ol></div></div>