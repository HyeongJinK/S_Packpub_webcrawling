<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec33"></a>Creating a gun</h2></div></div><hr /></div><p>Before<a id="id318" class="indexterm"></a> creating the necessary script for the bullet and collision detection, we will add a crosshair in the middle of the screen to improve the player's accuracy.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new GUI texture, and rename it <code class="literal">GUITexture_crossHair</code>.</p></li><li><p>Change its position to (x=0.5, y=0.5, z=0), so that it is displayed in the middle of the screen.</p></li><li><p>Drag-and-drop the texture labeled <span class="strong"><strong>Crosshair</strong></span> by selecting <span class="strong"><strong>Assets</strong></span> | <span class="strong"><strong>chapter4</strong></span> | <span class="strong"><strong>chapter4_pack</strong></span> to the <span class="strong"><strong>GUITexture</strong></span> component<a id="id319" class="indexterm"></a> of this object, as illustrated in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849695848/graphics/5848_04_12.jpg" /></div></li><li><p>This should display the crosshair in the middle of the screen in the game view.</p></li><li><p>In the <span class="strong"><strong>GUITexture</strong></span> component of the object <code class="literal">GUITexture_croshair</code>, change the <code class="literal">width</code><a id="id320" class="indexterm"></a> and <code class="literal">height</code><a id="id321" class="indexterm"></a> properties to <code class="literal">128</code>.</p></li></ol></div><p>Because bullets travel at a considerable speed, it may be difficult to detect when they collide with other objects. As a result, we will use a technique called ray casting to aim and fire a bullet. Put simply, using ray casting, we cast a ray from the middle of the screen forward (or any other position), the same way an infrared light could be used to aim <a id="id322" class="indexterm"></a>at a target. When this ray intersects with an object, we can tell whether the virtual bullet has hit an object.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new script by selecting <span class="strong"><strong>Assets</strong></span> | <span class="strong"><strong>chapter4</strong></span> | <span class="strong"><strong>Scripts</strong></span> and rename it <code class="literal">shootBullet</code>.</p></li><li><p>Modify the script as described in the following code:</p><div class="informalexample"><pre class="programlisting">function Update () 
{
  if (Input.GetButtonUp("Fire1"))
  {
    var hit : RaycastHit;
    var ray = Camera.main.ScreenPointToRay (Vector3(Screen.width/2,Screen.height/2));
    if(Physics.Raycast (ray, hit, 100)) 
    {
      print("You fired at the "+hit.collider.gameObject.tag);
    }
  }
}</pre></div></li></ol></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>In line 3<a id="id323" class="indexterm"></a> of the previous code, we check whether the <code class="literal">Fire1</code> button is pressed (that is, the mouse left button).</p></li><li style="list-style-type: disc"><p>In line 5 of the previous code, we create a variable of type <code class="literal">RaycastHit</code>. It will be used to identify the object that intersects with the ray. This way, we will be able to identify the object hit by the bullet and perform actions accordingly (for example, apply damage).</p></li><li style="list-style-type: disc"><p>In line 6 of the previous code, a new ray is created. It starts from the center of the screen and points forward.</p></li><li style="list-style-type: disc"><p>In line 9 of the previous code, the function <code class="literal">Physics.Raycast</code> casts a ray using<a id="id324" class="indexterm"></a> the three parameters <code class="literal">ray</code>, <code class="literal">hit</code>, and <code class="literal">100</code>. In our case, the ray previously created (that is, from the center of the screen) is used; it points forward and its length is 100 meters. When an object collides with this ray, its properties can be accessed through the variable <code class="literal">hit</code>.</p></li><li style="list-style-type: disc"><p>Line 11 of the previous code shows how we can access the tag of the object that collided with our ray. We access the collider, then the associated <code class="literal">gameObject</code>, and then the tag. Note that we could also access the exact point where the ray collided with the object using <code class="literal">hit.point</code>.</p></li><li style="list-style-type: disc"><p>Drag-and-drop this script on the <span class="strong"><strong>First Person Controller</strong></span>.</p></li><li style="list-style-type: disc"><p>Play the scene and target one of the objects present in the scene (for example, med pack). If we fire at this object, the console should display a message, for example, <span class="strong"><strong>You fired at the medpack</strong></span>.</p></li><li style="list-style-type: disc"><p>Stop the game and open the editor.</p></li></ul></div><p>We will fine-tune the gun as follows in order to:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Hide the mouse cursor on screen</p></li><li style="list-style-type: disc"><p>Play a sound when a bullet is fired</p></li><li style="list-style-type: disc"><p>Display and update the number of ammunitions left</p></li><li style="list-style-type: disc"><p>Allow the player to shoot only when there are enough ammunitions</p></li></ul></div><p>To <a id="id325" class="indexterm"></a>hide the mouse cursor, we can use the variable <code class="literal">Screen.showCursor</code><a id="id326" class="indexterm"></a>. This variable, when set to <code class="literal">false</code>, will hide the cursor.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open the script <code class="literal">shootBullet</code>.</p></li><li><p>Add the following line within the function <code class="literal">Start</code>:</p><div class="informalexample"><pre class="programlisting">Screen.showCursor = false;</pre></div></li><li><p>Play the scene and check that the mouse cursor is hidden after the first shot.</p></li></ol></div><p>Let's display <a id="id327" class="indexterm"></a>and <a id="id328" class="indexterm"></a>update the number of ammunitions left:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open the script <code class="literal">shootBullets</code>.</p></li><li><p>Add the following line at the start of the script:</p><div class="informalexample"><pre class="programlisting">public var nbBullets:int;</pre></div></li><li><p>Add the following code inside the <code class="literal">Start</code> function:</p><div class="informalexample"><pre class="programlisting">nbBullets = 0;</pre></div></li><li><p>Modify the function <code class="literal">Update</code><a id="id329" class="indexterm"></a> as highlighted in the following code:</p><div class="informalexample"><pre class="programlisting">function Update () 
{
if (Input.GetButtonUp("Fire1"))
  {
<span class="strong"><strong>    if (nbBullets &gt;= 1)</strong></span>
<span class="strong"><strong>    {</strong></span>
      var hit : RaycastHit;
      var ray = Camera.main.ScreenPointToRay (Vector3(Screen.width/2,Screen.height/2));
      if(Physics.Raycast (ray, hit, 100)) 
      {
        print(hit.collider.gameObject.tag);
      }
<span class="strong"><strong>   nbBullets--;</strong></span>
<span class="strong"><strong>   print("nbBullets:"+nbBullets);</strong></span>
    }
  }
}</pre></div></li></ol></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>In line 5 of the previous code, we check that we have at least one bullet to be able to fire the gun</p></li><li style="list-style-type: disc"><p>In line 13 of the previous code, since we have shot a bullet, we decrease the number of bullets that we currently have</p></li></ul></div><p>Next, <a id="id330" class="indexterm"></a>let's display the number of ammunitions (bullets) left on the screen: create a new <code class="literal">GUIText</code> object<a id="id331" class="indexterm"></a>, rename it <code class="literal">GUIText_ammo</code>, change its position to (x=0.01, y=0.25), and its font size to <code class="literal">20</code>. Finally, we will update the text displayed for the number of ammunitions left:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open the script <code class="literal">collisionDetection</code>.</p></li><li><p>Add <a id="id332" class="indexterm"></a>the following line to the start of the script:</p><div class="informalexample"><pre class="programlisting">private var guiAmmo:GameObject;</pre></div></li><li><p>Add the following line to the function <code class="literal">Start</code>:</p><div class="informalexample"><pre class="programlisting">guiAmmo = GameObject.Find("GUItext_ammo");</pre></div></li><li><p>Add the following line of code to the function <code class="literal">Update</code>:</p><div class="informalexample"><pre class="programlisting">if (hasGun) guiAmmo.guiText.text= "Ammo:"+ GetComponent(shootBullet).nbBullets;</pre></div></li></ol></div><p>In the previous line, we indirectly accessed the object <code class="literal">GUIText_ammo</code> and its <code class="literal">text</code> attribute, and set the initial text displayed.</p><p>We now need to make some adjustments: the player should only be able to fire the gun when he/she has collected the gun. As a result, we need to check whether the gun has been collected before the crosshair can be displayed or any of the bullets shot. In the previous chapters, we created a script called <code class="literal">collisionDetection</code>. Amongst other things, this script included a Boolean variable <code class="literal">hasGun</code> that was set to <code class="literal">true</code> when the<a id="id333" class="indexterm"></a> player had collected the gun. We will need to test whether this variable is set to <code class="literal">true</code> before the player can use the gun. First, we will hide some of the contextual messages and textures when the game is created:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new script called <code class="literal">initGame</code><a id="id334" class="indexterm"></a> by selecting <span class="strong"><strong>Assets</strong></span> | <span class="strong"><strong>chapter4</strong></span> | <span class="strong"><strong>Scripts</strong></span>.</p></li><li><p>Modify the <code class="literal">Start</code> function<a id="id335" class="indexterm"></a> as follows:</p><div class="informalexample"><pre class="programlisting">function Start () 
{
GameObject.Find("GUIText_ammo").guiText.text="";
GameObject.Find("GUITexture_crosshair").guiTexture.enabled=false;
GameObject.Find("GUIText_displayMessageToUser").guiText.text="";
}</pre></div></li><li><p>Add this script to the <span class="strong"><strong>First Person Controller</strong></span>.</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Line 3 of the previous code shows that the text that displays the number of ammunitions left is hidden</p></li><li style="list-style-type: disc"><p>Line 4 of the previous code shows that the crosshair is hidden</p></li><li style="list-style-type: disc"><p>Line 5 of the previous code shows that the text used to display messages to users is hidden</p></li></ul></div></li></ol></div><p>We now need to display the crosshair when the gun has been collected and also increase the<a id="id336" class="indexterm"></a> number of bullets available to the player to <code class="literal">40</code>:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open the<a id="id337" class="indexterm"></a> script <code class="literal">collisionDetection</code>.</p></li><li><p>Add the code that is highlighted to the script in the section that detects whether the gun has been collected:</p><div class="informalexample"><pre class="programlisting">if (c.gameObject.tag == "gun") 
{
hasGun = true; changeGUITexture(true, "gun");
<span class="strong"><strong>GameObject.Find("GUITexture_crosshair").guiTexture.enabled=true;</strong></span>
<span class="strong"><strong>GetComponent(shootBullet).nbBullets = 40;</strong></span>
}</pre></div></li></ol></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Lines 1 to 3 of the previous code were already in the script</p></li><li style="list-style-type: disc"><p>In line 4 of the previous code, the texture used for the crosshair is activated</p></li><li style="list-style-type: disc"><p>In line 5 of the previous code, we access the script <code class="literal">shootBullet</code><a id="id338" class="indexterm"></a> and set the variable <code class="literal">nbBullets</code><a id="id339" class="indexterm"></a> to <code class="literal">40</code></p></li></ul></div><p>Finally, we will add sound whenever the player fires a shot as shown in the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open the URL <a class="ulink" href="http://freesound.org/browse/tags/gun/" target="_blank">http://freesound.org/browse/tags/gun/</a>.</p></li><li><p>Select<a id="id340" class="indexterm"></a> a sound of your choice for the gunshot.</p></li><li><p>Once you click on the name of the sound, you will be redirected to a new page with more details on the sound, and a button labeled <span class="strong"><strong>Login to download</strong></span>. Click on this button, and register as highlighted in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849695848/graphics/5848_04_13.jpg" /></div></li><li><p>Read the terms and conditions.</p></li><li><p>After registering, you will receive an e-mail to activate your account.</p></li><li><p>Check your e-mail and activate your account accordingly.</p></li><li><p>Log<a id="id341" class="indexterm"></a> in using your newly created account.</p></li><li><p>Open the page <a class="ulink" href="http://freesound.org/browse/tags/gun/" target="_blank">http://freesound.org/browse/tags/gun/</a>.</p></li><li><p>Re-enter your login details.</p></li><li><p>Click <a id="id342" class="indexterm"></a>on the button labeled <span class="strong"><strong>Download</strong></span>.</p></li><li><p>Once the sound has been downloaded, import it in Unity3D (<span class="strong"><strong>Assets</strong></span> | <span class="strong"><strong>Import New Asset</strong></span>).</p></li><li><p>Rename this file <code class="literal">gunshot</code>.</p></li></ol></div><p>Once we have imported this sound, we need to modify the script <code class="literal">shootBullet</code> so that a sound is played whenever a bullet is shot:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open<a id="id343" class="indexterm"></a> the script <code class="literal">shootBullet</code>.</p></li><li><p>Add the following line at the start of the script to declare a variable for the sound to be played:</p><div class="informalexample"><pre class="programlisting">public var fireSound:AudioClip;</pre></div></li><li><p>Add the following code highlighted within the conditional statement that tests if we have enough bullets to fire the gun; if so, the gunshot sound can be played accordingly:</p><div class="informalexample"><pre class="programlisting">If (nbBullets &gt;= 1)
{
<span class="strong"><strong>audio.clip = fireSound;</strong></span>
<span class="strong"><strong>audio.Play();</strong></span>
</pre></div></li><li><p>Select the object <span class="strong"><strong>First Person Controller</strong></span> in the <span class="strong"><strong>Hierarchy</strong></span> window.</p></li><li><p>Locate the component <span class="strong"><strong>Shoot Bullet</strong></span> for this object in the <span class="strong"><strong>Inspector</strong></span> window.</p></li><li><p>Drag-and-drop the sound <code class="literal">gunShot</code> to the variable <code class="literal">FireSound</code><a id="id344" class="indexterm"></a> within <a id="id345" class="indexterm"></a>the component <span class="strong"><strong>Shoot Bullet</strong></span> as described in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849695848/graphics/5848_04_14.jpg" /></div></li><li><p>Test the scene and check that the sound is played when we fire the gun.</p></li></ol></div><p>At this stage, we can recognize what object we shoot at; however, it would be great to add a visual effect that simulates the impact of our bullet. This will be done using a particle system. Using the object <code class="literal">hit</code>, we will detect the location of the impact and generate a <span class="strong"><strong>particle emitter</strong></span><a id="id346" class="indexterm"></a> at this particular position.</p><p>First, let's modify the script <code class="literal">shootBullet</code> to include variables for the particles:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Include the following line at the start of the script <code class="literal">shootBullet</code>:</p><div class="informalexample"><pre class="programlisting">public var sparks:GameObject;</pre></div></li><li><p>The <a id="id347" class="indexterm"></a>variable defined in the previous line will be used as a container. It will make it possible to drag-and-drop the particle emitter to be used on impact. This particle emitter will be a prefab.</p></li><li><p>In the script <code class="literal">shootBullet</code>, add the following lines within the code that tests whether the ray casted from the middle of the screen has intersected with another object (that is, just after the line <code class="literal">print ("You fired at the "+hit.collider.gameObject.tag</code>):</p><div class="informalexample"><pre class="programlisting">var spark:GameObject = Instantiate( sparks, hit.point, Quaternion.identity );</pre></div></li><li><p>In the previous code, we created a new spark based on the prefab mentioned earlier. The spark will be instantiated at the exact position where the ray has intersected with the object.</p></li></ol></div><p>Next, we need to identify the prefab that will be used in this script (that is, instantiated). Thankfully, Unity3D includes built-in prefabs for particles, including a prefab to simulate sparks. However, this prefab needs to be imported as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select: <span class="strong"><strong>Assets</strong></span> | <span class="strong"><strong>Import Package</strong></span> | <span class="strong"><strong>Particles</strong></span>. This should show a window labeled <span class="strong"><strong>Importing package</strong></span>. As per previous sections, it includes all built-in particles (including legacy particles) that can be used in Unity3D.</p><div class="mediaobject"><img src="/graphics/9781849695848/graphics/5848_04_15.jpg" /></div></li><li><p>Click on <span class="strong"><strong>Import</strong></span>.</p></li><li><p>This<a id="id348" class="indexterm"></a> will create a new folder labeled <code class="literal">Particles</code> in <span class="strong"><strong>Assets</strong></span> | <span class="strong"><strong>Standard Assets</strong></span>, as illustrated in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849695848/graphics/5848_04_16.jpg" /></div></li><li><p>If we select: <span class="strong"><strong>Assets</strong></span> | <span class="strong"><strong>Standard Assets</strong></span> | <span class="strong"><strong>Particles</strong></span> | <span class="strong"><strong>Misc</strong></span>, we can find a prefab called <span class="strong"><strong>Sparks</strong></span>. We will use this prefab to create the sparks.</p></li><li><p>Select the prefab <span class="strong"><strong>Sparks</strong></span>.</p></li><li><p>In the <span class="strong"><strong>Inspector</strong></span> window, open the <span class="strong"><strong>Particle Animator</strong></span> component<a id="id349" class="indexterm"></a> for this object, and check the box for the option <span class="strong"><strong>Autodestruct</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781849695848/graphics/5848_04_17.jpg" /></div></li><li><p>Drag-and-drop the <span class="strong"><strong>Spark</strong></span> prefab that we have identified previously to the variable called <span class="strong"><strong>Sparks</strong></span> for the script <code class="literal">shootBullet</code>, which is a component of the <span class="strong"><strong>First Person Controller</strong></span> object as illustrated on the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849695848/graphics/5848_04_18.jpg" /></div></li></ol></div><p>Test<a id="id350" class="indexterm"></a> the scene; fire shots at objects, and check whether sparks appear at the point of impact.</p></div>