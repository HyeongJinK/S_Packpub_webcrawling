<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec130"></a>Time for action â€“ occluding tanks</h2></div></div><hr /></div><p>We will add occlusion culling to the Tank Battle game, because it is the only one with anything large enough to block objects from view:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>So, open up the<a id="id744" class="indexterm"></a> Tank Battle game now. If you completed the challenges and added the extra debris and obstacles, this section will be particularly effective for you.</p></li><li><p>Open the Occlusion window by going to Unity's toolbar and navigate to <span class="strong"><strong>Window</strong></span> | <span class="strong"><strong>Occlusion Culling</strong></span>. This window is your primary point of access for modifying the various settings associated with occlusion in your game.</p></li><li><p>Switch to the <span class="strong"><strong>Bake</strong></span> page and we can take a look at the options associated with occlusion culling.</p><div class="mediaobject"><img src="/graphics/9781849692014/graphics/2014OT_09_13.jpg" /></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="strong"><strong>Technique</strong></span>: This<a id="id745" class="indexterm"></a> setting will determine what method to use when setting up occlusion culling.</p><p>
<span class="strong"><strong>PVS Only</strong></span>: This setting will only calculate the static objects of your scene to have occlusion culling applied. This option is the least intensive for the processor but is only good if there are very few moving objects in the scene.</p><p>
<span class="strong"><strong>PVS and dynamic objects</strong></span>: This setting will precompute what objects can be seen by the camera. For dynamic objects, the system will create portals. They are used to cull objects that are on opposite sides of the portals from the camera.</p><p>
<span class="strong"><strong>Automatic Portal Generation</strong></span>: This setting will cull both static and dynamic objects based on portals. While giving the most accuracy, this option also has the highest cost for the processor.</p><p>
<span class="strong"><strong>View Cell Size</strong></span>: This setting sets how detailed the occlusion calculations are. Smaller values will result in better culling but will cause the file size to increase to store the extra information.</p><p>
<span class="strong"><strong>Near Clip Plane</strong></span> and <span class="strong"><strong>Far Clip Plane</strong></span>: These settings are used by the system to estimate what a camera can see at any point in space. They should be set to the smallest <span class="strong"><strong>Near Clip Plane</strong></span> and largest <span class="strong"><strong>Far Clip Plane</strong></span> of all the cameras in your game.</p><p>
<span class="strong"><strong>Memory Limit</strong></span>: This setting is used when either of the <span class="strong"><strong>PVS Techniques</strong></span> have been chosen. It helps guide how much detail can be put into the calculation.</p></li></ul></div></li><li><p>Select <span class="strong"><strong>PVS and dynamic objects</strong></span> for <span class="strong"><strong>Technique</strong></span> and <code class="literal">5</code> for <span class="strong"><strong>View Cell Size</strong></span>.</p></li><li><p>In order to make the occlusion system work with dynamic objects, we need to set up a number of occlusion areas. To create them, create an empty <span class="strong"><strong>GameObject</strong></span> and<a id="id746" class="indexterm"></a> add an <span class="strong"><strong>Occlusion Area</strong></span> component, found in Unity's toolbar under <span class="strong"><strong>Component</strong></span> | <span class="strong"><strong>Rendering</strong></span> | <span class="strong"><strong>Occlusion Area</strong></span>.</p></li><li><p>They need to cover the area where any dynamic objects will be located. Create and position enough areas to cover the streets of our game. Their size can be edited just as when working with <span class="strong"><strong>Box Collider</strong></span> components. Be sure to make them tall enough to cover all of your targets.</p><div class="mediaobject"><img src="/graphics/9781849692014/graphics/2014OT_09_15.jpg" /></div></li><li><p>Hit <span class="strong"><strong>Bake</strong></span> at the bottom of the <span class="strong"><strong>Occlusion</strong></span> window. A progress bar will appear at the bottom-right of the Unity Editor, telling you how much longer the calculations <a id="id747" class="indexterm"></a>will take. This process usually takes a good amount of time, especially as your game becomes more and more complex.</p></li><li><p>When the baking process has completed, the <span class="strong"><strong>Occlusion</strong></span> window should have switched to the <span class="strong"><strong>Visualization</strong></span> tab<a id="id748" class="indexterm"></a> and the camera should be selected in your <span class="strong"><strong>Scene</strong></span> window. If not, select them now. In the <span class="strong"><strong>Scene</strong></span> view, Unity will give us a preview of how occlusion culling is working. Only those objects that can be seen will be visible while the rest are turned off.</p><div class="mediaobject"><img src="/graphics/9781849692014/graphics/2014OT_09_14.jpg" /></div></li></ol></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec148"></a>
<span class="emphasis"><em>What just happened?</em></span>
</h3></div></div></div><p>We went through <a id="id749" class="indexterm"></a>the basic process for setting up occlusion culling. We took a look at the <span class="strong"><strong>Occlusion</strong></span> window and learned about the settings available there. Occlusion culling is great for reducing the number of draw calls in a scene. However, that reduction needs to be balanced against the cost of storing and retrieving the occlusion calculations. This balance is achieved by selecting a proper <span class="strong"><strong>Technique</strong></span> and an appropriate <span class="strong"><strong>View Cell Size</strong></span>. Play around with the different values now, finding a cell size that gives the appropriate amount of detail without supplying too much information.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec149"></a>Points to remember</h3></div></div></div><p>The following is a list of tips for dealing <a id="id750" class="indexterm"></a>with and avoiding lag in your games. Not all of them will apply to every game you make, but they are good to keep in mind for every project:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Avoid the transparent shaders, if possible, when creating your materials. They are a little more expensive to render. And, you can save yourself a world of headaches dealing with depth sorting, if you avoid them.</p></li><li style="list-style-type: disc"><p>Use one material per object. The greater the number of draw calls in your game, the longer each frame will take to render. Every mesh is drawn once per material on it, even if the material doesn't appear to do anything. By keeping to one material per object, especially on mobile platforms, you minimize the number of draw calls and maximize your rendering speed.</p></li><li style="list-style-type: disc"><p>Combine textures when possible. Not every texture you make will utilize the whole of the image. Whenever<a id="id751" class="indexterm"></a> possible, combine the textures of objects that are in the same scene. This maximizes your efficient use of the images, while reducing the final build size and amount of memory needed to utilize those textures.</p></li><li style="list-style-type: disc"><p>Group objects in your <span class="strong"><strong>Hierarchy</strong></span> using empty GameObjects. Though not specific to minimizing lag, it will make your project easier to work with. Especially with large and complex levels, you will be able to spend less time searching through the objects in your scene and more time making a great game.</p></li><li style="list-style-type: disc"><p>The <a id="id752" class="indexterm"></a>
<span class="strong"><strong>Console</strong></span> window is your friend. Before worrying about your game not working, first take a look at the <span class="strong"><strong>Console</strong></span> window or the bar at the bottom in Unity. Both will display any complaints that Unity might have about the way your game is currently set up. The messages here are great for pointing you in the right direction to fixing any problems. If you are ever unsure what the messages are trying to tell you, perform a Google search for the message and you should be able to easily find a solution from one of the many other Unity users. If your code ever appears to not be working and Unity isn't complaining about it, use the <a id="id753" class="indexterm"></a>
<code class="literal">Debug.Log</code> function to print messages to the <span class="strong"><strong>Console</strong></span>. This will let you find places that your code might be exiting unexpectedly, or values that are not what they should be.</p></li><li style="list-style-type: disc"><p>Device testing is important. Working in the Editor is great, but there is nothing quite like testing on the target device. You can get a much better feel for how your game is performing when it is on the device. The Editor always introduces a small amount of additional processing overhead. Also, the computer you are working on will always be more powerful than the mobile devices you might intend on deploying to.</p></li></ul></div></div></div>