<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec51"></a>Time for action â€“ creating the target state machine</h2></div></div><hr /></div><p>The use of a state machine<a id="id251" class="indexterm"></a> allows us to focus more on what the target is doing, while letting Unity handle the <span class="emphasis"><em>how it is going to do it</em></span> part.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Creating an Animator Controller is simple and done just as we have been doing for our scripts and materials. The option is second from the bottom of the <span class="strong"><strong>Create</strong></span> menu. Create one in the <code class="literal">Targets</code> folder and name it <code class="literal">TargetController</code>.</p></li><li><p>Double-click on <code class="literal">TargetController</code> to open a new window.</p><div class="mediaobject"><img src="/graphics/9781849692014/graphics/2014OT_03_11.png.jpg" /></div></li><li><p>The <span class="strong"><strong>Animator</strong></span> window is where we edit our state machines.</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>At the top-left corner of the window, there is a breadcrumb trail as you might<a id="id252" class="indexterm"></a> find on a website that lets us see where we are in the state machine at a glance.</p></li><li style="list-style-type: disc"><p>The <span class="strong"><strong>Auto Live Link</strong></span> button<a id="id253" class="indexterm"></a> in the top-right controls our ability to see the state machine's update in real time with the game. This is useful for debugging transitions and controls for the character.</p></li><li style="list-style-type: disc"><p>Underneath the breadcrumb trail, there are a list of layers and a button for adding new layers. Every state machine will have at least the <span class="strong"><strong>Base Layer</strong></span>. Adding additional layers would allow us to blend state machines. Say we have a character that walks around normal when at full health. When his health drops below half, he starts to limp. If the character has only ten percent of his health left, he starts to crawl. This would be achieved through the use of layers.</p></li><li style="list-style-type: disc"><p>At the bottom-left corner of the window, there is the <span class="strong"><strong>Parameters</strong></span> list. Clicking on the <span class="strong"><strong>+</strong></span> button will add a new parameter to the list. These parameters can be Boolean, float, vector, and integer values. The transitions between states are most often triggered by changes in the parameters. Any scripts working with the state machine can modify these values.</p></li><li style="list-style-type: disc"><p>Finally, that green box in the center with <span class="strong"><strong>Any State</strong></span> on it that allows a character to transition from any action to a specific one. When a character's health drops below zero, we want them to go to the death state. The <span class="strong"><strong>Any State</strong></span> box would hold this transition, and it would be able to pull the character out of any other state and put them in the death state.</p></li></ul></div></li><li><p>To create a new<a id="id254" class="indexterm"></a> state, right-click on the grid that is inside our <span class="strong"><strong>Animator</strong></span> window. Mouse over <span class="strong"><strong>Create State</strong></span> and select <span class="strong"><strong>Empty</strong></span>. This creates a new empty state for our state machine. Normally new states are gray but, because this is the first state in our machine it is orange, which is the color of the default state.</p></li><li><p>Every state machine will start in its default state. Click on the state to select it, and we can take a look at it in the <span class="strong"><strong>Inspector</strong></span> window.</p><div class="mediaobject"><img src="/graphics/9781849692014/graphics/2014OT_03_12.png.jpg" /></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>At the top, there is a text field for changing the name of the state.</p></li><li style="list-style-type: disc"><p>Below that, you can add a tag for organizational purposes.</p></li><li style="list-style-type: disc"><p>Next, there is a <span class="strong"><strong>Speed</strong></span> field. This field controls the speed of the animation.</p></li><li style="list-style-type: disc"><p>The <span class="strong"><strong>Motion</strong></span> field is where we will add connections to the animation clips that we created earlier.</p></li><li style="list-style-type: disc"><p>The <span class="strong"><strong>Foot IK</strong></span> option lets us decide if we want to let part of the animation be calculated with IK. We did not set up any IK for these animations, so we do not need to worry about this option.</p></li><li style="list-style-type: disc"><p>The last option, <span class="strong"><strong>Mirror</strong></span>, is used to flip the left and right (or x axis) of the<a id="id255" class="indexterm"></a> animation. If you created a right-hand-waving animation, this option would let you change it to a left-hand-waving animation.</p></li><li style="list-style-type: disc"><p>Below that, there is the list of transitions that go from this state to another state. These are transitions out of the state, not into it. As you will soon see, a transition in this list appears as the name of the current state with an arrow to the right, followed by the name of the state it is connected to.</p></li><li style="list-style-type: disc"><p>Checkboxes also appear under the <span class="strong"><strong>Solo</strong></span> and <span class="strong"><strong>Mute</strong></span> labels on the right. These are for debugging transitions between states. Any number of the transitions can be muted at one time, but only one can be soloed at a time. When a transition has been muted, it means that the state machine will ignore it when deciding which transition to make. Checking the solo box is the same as muting all but one of the transitions. It is just a quick way of making it the only active transition.</p></li></ul></div></li><li><p>We are going to need one state for each of our target's animations. So, create five more states and rename all six to match the names of the animation clips we created earlier. The default state, the orange one, should be named <code class="literal">Idle_Retract</code>.</p></li><li><p>In the <span class="strong"><strong>Project</strong></span> window, click on the little triangle to the left of the <span class="strong"><strong>Target</strong></span> model.</p><div class="mediaobject"><img src="/graphics/9781849692014/graphics/2014OT_03_13.png.jpg" /></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>This expands the model, so that we can see all of the objects that make up that model in Unity. The first group, as indicated by the little thumbnails next to each object, is the raw mesh data. This is followed by an Avatar object; this is what keeps track of the <span class="strong"><strong>Rig</strong></span> setup. Below that, there are the animation clip objects; these are what we are<a id="id256" class="indexterm"></a> interested in right now. The objects that make up the model are at the bottom of the stack.</p></li></ul></div></li><li><p>Select each state in your <span class="strong"><strong>Animator</strong></span> window and pair it with the correct clip by dragging an animation clip from the <span class="strong"><strong>Project</strong></span> window and dropping it on the <span class="strong"><strong>Motion</strong></span> field in the <span class="strong"><strong>Inspector</strong></span> window.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip17"></a>Tip</h3><p>The thumbnail for animation clips looks like a little play button.</p><div class="mediaobject"><img src="/graphics/9781849692014/graphics/2014OT_03_14.png.jpg" /></div></div></li><li><p>Before we can create our transitions, we need a few parameters. Click on the <span class="strong"><strong>+</strong></span> button next to <span class="strong"><strong>Parameters</strong></span> in the bottom-left corner of the window and select <span class="strong"><strong>Float</strong></span> from the menu that appears. A new parameter should now appear in the list.</p></li><li><p>The new field on the left is the name of the parameter; rename this one to <code class="literal">time</code>. The field on the right is the current value of this parameter. When debugging our state machine, we can modify these values here to trigger changes in the state machine. Any changes made by the scripts while the game is running will also appear here.</p></li><li><p>We need two more parameters. Create two Boolean parameters and rename them to <code class="literal">wasHit</code> and <code class="literal">inTheFront</code>. These will trigger the machine to change to the getting hit states, while the <code class="literal">time</code> parameter will trigger the machine to utilize the <code class="literal">extend</code> and <code class="literal">retract</code> states.</p></li><li><p>To create a new transition, right-click on a state and select <span class="strong"><strong>Make Transition</strong></span> from the menu that pops up. A transition line is now connected from the state to your mouse. To complete the transition creation, click on the state that you wish to connect to. There is an arrow on the line, indicating the direction of the transition.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>We need a transition from <code class="literal">Idle_Retract</code> to <code class="literal">Extend</code>.</p></li><li><p>We also need a transition from <code class="literal">Extend</code> to <code class="literal">Idle_Extend</code>.</p></li><li><p>
<code class="literal">Idle_Extend</code> needs three transitions, one each going to <code class="literal">Retract</code>, <code class="literal">Hit_Front</code>, and <code class="literal">Hit_Back</code>.</p></li><li><p>
<code class="literal">Retract</code>, <code class="literal">Hit_Front</code>, and <code class="literal">Hit_Back</code> need a transition going to <code class="literal">Idle_Retract</code>.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip18"></a>Tip</h3><p>Use the following diagram for reference. If you create a transition or state that you do not want, <a id="id257" class="indexterm"></a>select it and click on the <span class="emphasis"><em>Delete</em></span> key on your keyboard to remove it.</p><div class="mediaobject"><img src="/graphics/9781849692014/graphics/2014OT_03_16.jpg" /></div></div></li></ol></div></li><li><p>If you click on one of the transition lines, then we can take a look at its settings.</p><div class="mediaobject"><img src="/graphics/9781849692014/graphics/2014OT_03_17.png.jpg" /></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>At the top of the <span class="strong"><strong>Inspector</strong></span> window, we have the same indicators of which states we are transitioning between that we had in the state, the name of the state the transition starts in followed by an arrow, and finally<a id="id258" class="indexterm"></a> the name of the state the transition ends in.</p></li><li style="list-style-type: disc"><p>Underneath the familiar <span class="strong"><strong>Transitions</strong></span> list, there is a text field where we can give our transitions specific names. This would be useful if we had several different types of transitions between the same two states.</p></li><li style="list-style-type: disc"><p>Directly under the field, there is a more exact path-based indication of which states the transition is between.</p></li><li style="list-style-type: disc"><p>The <span class="strong"><strong>Atomic</strong></span> checkbox allows us to decide whether or not a transition can be interrupted. If <span class="strong"><strong>Atomic</strong></span> is checked, it cannot be interrupted.</p><p>In the example about the <span class="strong"><strong>Any State</strong></span> option and the death state, perhaps we were shot while pulling out a sword, going from an idle state to an attack state. That transition cannot be atomic, if we are to avoid the weirdness of completing our sword draw before falling over dead.</p></li><li style="list-style-type: disc"><p>Next is a timeline block that lets us preview the transition between animations. Dragging the little flag left and right, we can watch the transition in the <span class="strong"><strong>Preview</strong></span> window below. The top half of this <a id="id259" class="indexterm"></a>block holds wave forms that indicate the movement contained in an animation. The bottom half shows the states as boxes that overlap where the transition actually occurs. Either of these boxes can be dragged to change the length of the transition.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip19"></a>Tip</h3><p>Because our two idle animations are of negligible length, this can't be seen in our setup normally. If you temporarily create a transition between the <code class="literal">extend</code> and <code class="literal">retract</code> states, it would be visible.</p></div></li><li style="list-style-type: disc"><p>Lastly, we have a <span class="strong"><strong>Conditions</strong></span> list. Using the parameters we set up, we can create any number of conditions here that must be met before this transition can take place.</p><p>The default condition is <span class="strong"><strong>Exit Time</strong></span>. This means that, when the first state reaches a certain percentage of the way through its animation, as defined by the float field to the right, it will start transitioning into the next state. For half of our transitions, this is what we want. The other half, namely anything that exits our idle states, need to be based on our parameters.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip20"></a>Tip</h3><p>There is also another <span class="strong"><strong>Preview</strong></span> window at the bottom of the <span class="strong"><strong>Inspector</strong></span> panel. It functions just like the one for the animation import settings page, but this one plays the transition between the two relevant animations.</p></div></li></ul></div></li><li><p>Select the transition between the <code class="literal">Idle_Retract</code> state and <code class="literal">Extend</code> state. We want the targets to randomly pop up. This will be controlled by a script changing the <code class="literal">time</code> parameter.</p></li><li><p>Click on <code class="literal">Exit Time</code> under the <span class="strong"><strong>Conditions</strong></span> list to bring up the list of parameters and select time from the list.</p></li><li><p>In order to turn a float value into a conditional statement, we need to compare it with another value. That is why we got a new drop-down button of comparison options when we selected the parameter. A float value will be either greater than or less than the value on the right. Our time will be counting down, so select <span class="strong"><strong>Less</strong></span> from the list and leave the value at zero.</p></li><li><p>Change the conditions for the transition between the <code class="literal">Idle_Extend</code> and <code class="literal">Retract</code> states to be the same.</p></li><li><p>For the transition <a id="id260" class="indexterm"></a>between the <code class="literal">Idle_Extend</code> state and <code class="literal">Hit_Front</code> state, we will use both of the Boolean parameters that were created. Select the transition and click on the <span class="strong"><strong>+</strong></span> button under <span class="strong"><strong>Conditions</strong></span> to add a second condition.</p></li><li><p>For the first condition, select <span class="strong"><strong>wasHit</strong></span> and select <span class="strong"><strong>inTheFront</strong></span> for the second condition.</p></li><li><p>A Boolean is either true or false. In the case of the transitions, it needs to know which of those values it is waiting for. For this transition, both should be left as true.</p></li><li><p>Next, set up the conditions for the transition between <code class="literal">Idle_Extend</code> and <code class="literal">Hit_Back</code>, just as you did for the previous transition. The difference being that false needs to be selected from the drop-down list next to the <code class="literal">inTheFront</code> conditional.</p></li></ol></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec40"></a>
<span class="emphasis"><em>What just happened?</em></span>
</h3></div></div></div><p>We created a state machine that will be used by our targets. By linking each state to an animation and connecting them all with transitions, the target will be able to switch between animations. This transitioning is controlled through adding conditionals and parameters.</p></div></div>