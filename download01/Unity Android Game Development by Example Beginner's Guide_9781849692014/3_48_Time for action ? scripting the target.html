<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec52"></a>Time for action – scripting the target</h2></div></div><hr /></div><p>We only need one more piece before we can finish putting the target together.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>That piece is a script. Create a new script in our <code class="literal">Scripts</code> folder and name it <code class="literal">Target</code>.</p></li><li><p>First, in order to interact <a id="id261" class="indexterm"></a>with our state machine, we need a reference to the <code class="literal">Animator</code> component. It is the component that you removed from the tank and the city. The <code class="literal">Animator</code> component is what ties all of the pieces of animation together.</p><div class="informalexample"><pre class="programlisting">public Animator animator;</pre></div></li><li><p>It is followed by two float values that will dictate the range of time, in seconds, that our targets will sit in their idle states.</p><div class="informalexample"><pre class="programlisting">public float maxIdleTime = 10f;
public float minIdleTime = 3f;</pre></div></li><li><p>Next, we have three values that will hold the ID numbers of the parameters that we need to change. It is technically possible to just use the names of the parameters to set them, but using the ID number is much faster.</p><div class="informalexample"><pre class="programlisting">private int timeId = -1;
private int wasHitId = -1;
private int inTheFrontId = -1;</pre></div></li><li><p>The last two variables<a id="id262" class="indexterm"></a> will hold the ID numbers of the two idle states. We need these for checking which state we are in. All of the IDs are initially set to <code class="literal">-1</code> as a dummy value, we set them to their actual values with the following function:</p><div class="informalexample"><pre class="programlisting">private int idleRetractId = -1;
private int idleExtendId = -1;</pre></div></li><li><p>The <code class="literal">Awake</code> function<a id="id263" class="indexterm"></a> is a special function in Unity that is called on every script at the beginning of the game. Its purpose is initialization before the game gets underway, perfect for initially setting our ID values. For each ID, we make a call to the <a id="id264" class="indexterm"></a>
<code class="literal">Animator.StringToHash</code> function. This function calculates the ID number of the parameter or state that we give it the name of. The state names also need to be prefixed with <code class="literal">Base Layer</code>. This is because Unity wants us to be specific when it is possible to have several different layers with states that are named the same thing. It is also very important that the name here exactly matches the name in the <span class="strong"><strong>Animator</strong></span> window. If it does not, IDs will not match, errors will occur, and the script will not function correctly.</p><div class="informalexample"><pre class="programlisting">public void Awake() {
  timeId = Animator.StringToHash("time");
  wasHitId = Animator.StringToHash("wasHit");
  inTheFrontId = Animator.StringToHash("inTheFront");
  idleRetractId = Animator.StringToHash("Base Layer.Idle_Retract");
  idleExtendId = Animator.StringToHash("Base Layer.Idle_Extend");
}</pre></div></li><li><p>To make use of all of these IDs, we turn to our very good friend—the <code class="literal">Update</code> function. At the beginning of the function, we use the <code class="literal">GetCurrentAnimatorStateInfo</code> function<a id="id265" class="indexterm"></a> to figure out which state is the current one. We send it a zero because it wants to know the index of the layer we are inquiring about, of which we only have the one. The function returns an object with the info about the current state, and we grab the <code class="literal">nameHash</code> value (also known as the ID value) of this state right away and set our variable to it.</p><div class="informalexample"><pre class="programlisting">public void Update() {
  int currentStateId = animator.GetCurrentAnimatorStateInfo(0).nameHash;</pre></div></li><li><p>The next line of code is a comparison with our idle state IDs to figure out if we are in one of those states. If we are, we call upon the <code class="literal">SubtractTime</code> function<a id="id266" class="indexterm"></a> (which we will write in a moment) to reduce the <code class="literal">time</code> parameter.</p><div class="informalexample"><pre class="programlisting">  if(currentStateId == idleRetractId || currentStateId == idleExtendId) {
    SubtractTime();
  }</pre></div></li><li><p>If the target is not<a id="id267" class="indexterm"></a> currently in one of its idle states, we start by checking to see if we were hit. If so, the hit is cleared using the <code class="literal">ClearHit</code> function<a id="id268" class="indexterm"></a> and the <code class="literal">time</code> parameter is reset using the <code class="literal">ResetTime</code> function<a id="id269" class="indexterm"></a>. Both functions will also be written in a moment. Finally, we check to see if our timer had dropped below zero. If that is the case, we again reset the timer.</p><div class="informalexample"><pre class="programlisting">  else {
    if(animator.GetBool(wasHitId)) {
      ClearHit();
      ResetTime();
    }

    if(animator.GetFloat(timeId) &lt; 0) {
      ResetTime();
    }
  }
}</pre></div></li><li><p>In the <code class="literal">SubtractTime</code> function<a id="id270" class="indexterm"></a> we use the <code class="literal">GetFloat</code> function of our <code class="literal">Animator</code> component to retrieve the value of a float parameter. By sending it our <code class="literal">timeId</code> variable, we can receive the current value of the <code class="literal">time</code> parameter. Like we did with the tank, we then use <code class="literal">Time.deltaTime</code> to keep in pace with our frame rate and subtract time from the timer. Once done, we need to give the state machine the new value, which is done with the <code class="literal">SetFloat</code> function. We tell it which parameter to change by giving it an ID value, and we tell it what to change it to by giving it our new time value.</p><div class="informalexample"><pre class="programlisting">public void SubtractTime() {
  float curTime = animator.GetFloat(timeId);
  curTime -= Time.deltaTime;
  animator.SetFloat(timeId, curTime);
}</pre></div></li><li><p>The next function to create is <code class="literal">ClearHit</code>. This function uses <code class="literal">SetBool</code> from the <code class="literal">Animator</code> component to set Boolean parameters. It functions just as the <code class="literal">SetFloat</code> function. We just give it an ID and a value. In this case, we are setting both of our <a id="id271" class="indexterm"></a>Boolean parameters to false so that the state machine no longer thinks it has been hit.</p><div class="informalexample"><pre class="programlisting">public void ClearHit() {
  animator.SetBool(wasHitId, false);
  animator.SetBool(inTheFrontId, false);
}</pre></div></li><li><p>The last function for the script is <code class="literal">ResetTime</code>. This is another quick function. First, we use the <a id="id272" class="indexterm"></a>
<code class="literal">Random.Range</code> function to get a random value. By passing it a minimum and maximum value, our new random number will be between them. Finally we use the <code class="literal">SetFloat</code> function to give the state machine the new value.</p><div class="informalexample"><pre class="programlisting">public void ResetTime() {
  float newTime = Random.Range(minIdleTime, maxIdleTime);
  animator.SetFloat(timeId, newTime);
}</pre></div></li></ol></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec41"></a>
<span class="emphasis"><em>What just happened?</em></span>
</h3></div></div></div><p>We created a script to control the state machine of our target. For comparing states and setting parameters, we gathered and used IDs. For now, do not worry about when the hit states are activated. It will be made clear in the following section when we finally make the tank shoot.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec42"></a>Creating the prefab</h3></div></div></div><p>Now that we have the model, animations, state machine, and script, finally it is time to create the target and turn it into a prefab.</p></div></div>