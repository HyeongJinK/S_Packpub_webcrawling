<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch13lvl1sec315"></a>Time for action â€“ code consolidation</h2></div></div><hr /></div><p>We've chosen the<a id="id963" class="indexterm"></a> square that the computer player will take. What are the next steps? Well, we need to increment the <code class="literal">moves</code> variable. We need to instantiate a piece <span class="strong"><strong>Prefab</strong></span>.<a id="id964" class="indexterm"></a> We need to update the Square with the player who claimed it. We need to check for a win or a stalemate, and update the player number.</p><p>By golly, all these steps are identical to the steps we already take when the human player places a piece! We should encapsulate those steps in a function that both the human and computer player can call.</p><p>Take all of the lines that are bolded below in the <code class="literal">ClickSquare</code> function, and move them into a new function called <code class="literal">PlacePiece()</code>:</p><div class="informalexample"><pre class="programlisting">function ClickSquare(square:GameObject)
{
  if(gameIsOver) return;
<span class="strong"><strong> var piece:GameObject;</strong></span>
<span class="strong"><strong>  if(currentPlayer == 1)</strong></span>
<span class="strong"><strong>  {</strong></span>
<span class="strong"><strong>    piece = XPiece;</strong></span>
<span class="strong"><strong>  } else {</strong></span>
<span class="strong"><strong>    piece = OPiece;</strong></span>
<span class="strong"><strong>  }</strong></span>
<span class="strong"><strong>  </strong></span>
<span class="strong"><strong>  moves ++;</strong></span>

<span class="strong"><strong>  Instantiate(piece, square.transform.position, Quaternion.identity);</strong></span>
<span class="strong"><strong>    square.GetComponent.&lt;Square&gt;().player = currentPlayer;</strong></span>
<span class="strong"><strong>  </strong></span>
<span class="strong"><strong>  if(CheckForWin(square))</strong></span>
<span class="strong"><strong>  {</strong></span>
<span class="strong"><strong>    gameIsOver = true;</strong></span>
<span class="strong"><strong>    ShowWinnerPrompt();</strong></span>
<span class="strong"><strong>    return;</strong></span>
<span class="strong"><strong>  } else if(moves &gt;= 9) {</strong></span>
<span class="strong"><strong>    gameIsOver = true;</strong></span>
<span class="strong"><strong>    ShowStalematePrompt();</strong></span>
<span class="strong"><strong>    return;</strong></span>
<span class="strong"><strong>  }</strong></span>

<span class="strong"><strong>  </strong></span>
<span class="strong"><strong>  </strong></span>
<span class="strong"><strong>  currentPlayer ++;</strong></span>
<span class="strong"><strong>  if(currentPlayer &gt; 2) currentPlayer = 1;</strong></span>
<span class="strong"><strong>  </strong></span>
<span class="strong"><strong>  ShowPlayerPrompt();</strong></span>

<span class="strong"><strong>  ComputerTakeATurn();</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div><p>In place of the lines highlighted above, call the <code class="literal">PlacePiece()</code> function. The new <code class="literal">ClickSquare</code> function should look like the following:</p><div class="informalexample"><pre class="programlisting">function ClickSquare(square:GameObject)
{
  if(gameIsOver) return;

  PlacePiece();

  ComputerTakeATurn();
}</pre></div><p>The <code class="literal">PlacePiece</code> function<a id="id965" class="indexterm"></a> should look<a id="id966" class="indexterm"></a> like the following:</p><div class="informalexample"><pre class="programlisting">function PlacePiece()
{
  var piece:GameObject;
  if(currentPlayer == 1)
  {
    piece = XPiece;
  } else {
    piece = OPiece;
  }
  moves ++;
  Instantiate(piece, square.transform.position, Quaternion.identity);
  square.GetComponent.&lt;Square&gt;().player = currentPlayer;
  if(CheckForWin(square))
  {
    gameIsOver = true;
    ShowWinnerPrompt();
    return;
  } else if(moves &gt;= 9) {
    gameIsOver = true;
    ShowStalematePrompt();
    return;
  }
  currentPlayer ++;
  if(currentPlayer &gt; 2) currentPlayer = 1;
  ShowPlayerPrompt();
}</pre></div><p>At the top of the <code class="literal">PlacePiece</code> function, we have a conditional check to determine whether we should place an X or an O depending on the <code class="literal">currentPlayer</code> variable. Now that we're discretely calling this function, we can actually pass in the piece we want placed, and omit the conditional check.</p><p>Change the <code class="literal">PlacePiece()</code> function call in the <code class="literal">ClickSquare</code> function, so that you're explicitly passing a reference to the <span class="strong"><strong>XPiece</strong></span> Prefab:</p><div class="informalexample"><pre class="programlisting"> PlacePiece(XPiece);</pre></div><p>In the <code class="literal">PlacePiece</code> function, accept <code class="literal">piece</code> as a parameter:</p><div class="informalexample"><pre class="programlisting"> function PlacePiece(piece:GameObject)</pre></div><p>Delete the whole <code class="literal">currentPlayer-</code>checking conditional from the <code class="literal">PlacePiece</code> function, bolded below:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>var piece:GameObject;</strong></span>
<span class="strong"><strong>  if(currentPlayer == 1)</strong></span>
<span class="strong"><strong>  {</strong></span>
<span class="strong"><strong>    piece = XPiece;</strong></span>
<span class="strong"><strong>  } else {</strong></span>
<span class="strong"><strong>    piece = OPiece;</strong></span>
<span class="strong"><strong>  }</strong></span>
</pre></div><p>The <code class="literal">Instantiate</code> command<a id="id967" class="indexterm"></a> still refers to a <code class="literal">GameObject</code> called <code class="literal">piece</code>, which is now coming from the parameter, instead of being defined in the conditional statement. Here's<a id="id968" class="indexterm"></a> how the <code class="literal">PlacePiece</code> function should look when you're finished:</p><div class="informalexample"><pre class="programlisting">function PlacePiece(piece:GameObject)
{
  moves ++;
  Instantiate(piece, square.transform.position, Quaternion.identity);
  square.GetComponent.&lt;Square&gt;().player = currentPlayer;
  
  if(CheckForWin(square))
  {
    gameIsOver = true;
    ShowWinnerPrompt();
    return;
  } else if(moves &gt;= 9) {
    ShowStalematePrompt();
    return;
  }
  currentPlayer ++;
  if(currentPlayer &gt; 2) currentPlayer = 1;
  ShowPlayerPrompt();
}</pre></div><p>In moving this code into the <code class="literal">PlacePiece</code> function,<a id="id969" class="indexterm"></a> we may not have noticed that the <code class="literal">PlacePiece</code> code now has no idea what <code class="literal">square</code> is, since it's no longer defined inside the function. Let's also pass that in when we call <code class="literal">PlacePiece</code>. Modify the function signature:</p><div class="informalexample"><pre class="programlisting"> function PlacePiece(piece:GameObject, square:GameObject)</pre></div><p>From the<a id="id970" class="indexterm"></a> <code class="literal">ClickSquare</code> function, pass in the clicked <code class="literal">square</code> when you call <code class="literal">PlacePiece</code>:</p><div class="informalexample"><pre class="programlisting"> PlacePiece(XPiece, square);</pre></div><p>Down in the <code class="literal">ComputerTakeATurn</code> function, call the <code class="literal">PlacePiece</code> function and pass it the computer player-specific piece and square references:</p><div class="informalexample"><pre class="programlisting"> square = aEmptySquares[Random.Range(0,aEmptySquares.Count)];
<span class="strong"><strong>  PlacePiece(OPiece, square);</strong></span>
</pre></div><p>Let's test the gam<a id="id971" class="indexterm"></a>e and look for bugs.</p></div>