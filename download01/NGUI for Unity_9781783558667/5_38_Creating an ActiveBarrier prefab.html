<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec40"></a>Creating an ActiveBarrier prefab</h2></div></div><hr /></div><p>When <a id="id248" class="indexterm"></a>a <span class="strong"><strong>BarrierObject</strong></span> is dropped on the <span class="strong"><strong>Viewport</strong></span> GameObject, we want to instantiate an <span class="strong"><strong>ActiveBarrier</strong></span> prefab that will take a few seconds to build, using a slider as status indicator as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783558667/graphics/8667OT_05_08.jpg" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec55"></a>The ActiveBarrier prefab</h3></div></div></div><p>Let's <a id="id249" class="indexterm"></a>create the <span class="strong"><strong>ActiveBarrier</strong></span> prefab by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select our <span class="strong"><strong>Viewport</strong></span> GameObject.</p></li><li><p>Create a new child with <span class="emphasis"><em>Alt</em></span> + <span class="emphasis"><em>Shift</em></span> + <span class="emphasis"><em>N</em></span>.</p></li><li><p>Select this new child and rename it as <code class="literal">ActiveBarrier</code>.</p></li><li><p>Open the <span class="strong"><strong>Widget Tool</strong></span> wizard by navigating to <span class="strong"><strong>NGUI</strong></span> | <span class="strong"><strong>Create a Widget</strong></span> and perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select <span class="strong"><strong>Progress Bar</strong></span> for the <span class="strong"><strong>Template</strong></span> field.</p></li><li><p>Set <span class="strong"><strong>Dark</strong></span> sprite as <span class="strong"><strong>Empty</strong></span>.</p></li><li><p>Set the <span class="strong"><strong>Highlight</strong></span> sprite as <span class="strong"><strong>Full</strong></span>.</p></li><li><p>With our <span class="strong"><strong>ActiveBarrier</strong></span> GameObject selected, click on the <span class="strong"><strong>Add To</strong></span> button.</p></li></ol></div><p>A <span class="strong"><strong>Progress Bar</strong></span> has just been created as child of the <span class="strong"><strong>ActiveBarrier</strong></span> GameObject as shown in the following screenshot:</p></li></ol></div><div class="mediaobject"><img src="/graphics/9781783558667/graphics/8667OT_05_09.jpg" /></div><p>It doesn't look like anything. Let's configure it to look like an <span class="strong"><strong>ActiveBarrier</strong></span> prefab by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select <a id="id250" class="indexterm"></a>our new <span class="strong"><strong>Background</strong></span> GameObject from <span class="strong"><strong>Progress Bar</strong></span> and perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Uncheck its <span class="strong"><strong>Fill Center</strong></span> boolean to only keep edges.</p></li><li><p>Set its <span class="strong"><strong>Color Tint</strong></span> to {<code class="literal">100</code>, <code class="literal">200</code>, <code class="literal">100</code>, <code class="literal">255</code>}.</p></li><li><p>Set its <span class="strong"><strong>Depth</strong></span> to <code class="literal">1</code> so that it can be rendered over the <span class="strong"><strong>Viewport</strong></span> background.</p></li><li><p>Set its <span class="strong"><strong>Dimensions</strong></span> to <code class="literal">160</code> x <code class="literal">160</code>.</p></li></ol></div></li><li><p>Select our <span class="strong"><strong>Foreground</strong></span> GameObject from <span class="strong"><strong>Progress Bar</strong></span> and perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Set its <span class="strong"><strong>Color Tint</strong></span> to {<code class="literal">75</code>, <code class="literal">190</code>, <code class="literal">95</code>, <code class="literal">255</code>}.</p></li><li><p>Set its <span class="strong"><strong>Depth</strong></span> value to <code class="literal">2</code>.</p></li><li><p>Set its <span class="strong"><strong>Dimensions</strong></span> to <code class="literal">160</code> x <code class="literal">160</code>.</p></li></ol></div></li><li><p> Select our <span class="strong"><strong>Progress Bar</strong></span> from <span class="strong"><strong>ActiveBarrier</strong></span> and perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Rename it as <code class="literal">Slider</code>.</p></li><li><p>Set its <span class="strong"><strong>Transform Position</strong></span> to {<code class="literal">-80</code>, <code class="literal">0</code>, <code class="literal">0</code>} to center it.</p></li><li><p>Set the <span class="strong"><strong>UISlider</strong></span> value to <code class="literal">0</code> to make sure it's empty at start.</p></li></ol></div></li><li><p>Select our <span class="strong"><strong>ActiveBarrier</strong></span> GameObject.</p></li><li><p>Attach a collider to it by navigating to <span class="strong"><strong>NGUI</strong></span> | <span class="strong"><strong>Attach</strong></span>, and set its <span class="strong"><strong>Size</strong></span> to {<code class="literal">160</code>, <code class="literal">160</code>, <code class="literal">1</code>}.</p></li></ol></div><p>The slider of <span class="strong"><strong>ActiveBarrier</strong></span> GameObject is ready. If you click on the play button and change the <span class="strong"><strong>Slider</strong></span> value in the <span class="strong"><strong>Inspector</strong></span> view during runtime, you will see the <span class="strong"><strong>ActiveBarrier</strong></span> prefab building itself.</p><p>Let's add a label that will show the status of <span class="strong"><strong>ActiveBarrier</strong></span>: either <span class="strong"><strong>Building</strong></span> or <span class="strong"><strong>Built</strong></span>.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Duplicate our <span class="strong"><strong>Label</strong></span> GameObject in <span class="strong"><strong>BarrierObject</strong></span> and perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Drag it inside our <span class="strong"><strong>ActiveBarrier</strong></span> GameObject.</p></li><li><p>Reset its <span class="strong"><strong>Transform Position</strong></span> to {<code class="literal">0</code>, <code class="literal">0</code>, <code class="literal">0</code>}.</p></li><li><p>Set its <span class="strong"><strong>Depth</strong></span> to <code class="literal">3</code>.</p></li><li><p>Add a Localize component to it by navigating to <span class="strong"><strong>Component</strong></span> | <span class="strong"><strong>NGUI</strong></span> | <span class="strong"><strong>UI</strong></span>.</p></li><li><p>Set the key of <span class="strong"><strong>UILocalize</strong></span> to <code class="literal">BuildingBarrier</code>.</p></li></ol></div></li><li><p>Drag our <span class="strong"><strong>ActiveBarrier</strong></span> in the folder of your choice inside the <span class="strong"><strong>Project</strong></span> view to make it a prefab.</p></li><li><p>Delete the <span class="strong"><strong>ActiveBarrier</strong></span> instance from the scene.</p></li></ol></div><p>Ok, our<a id="id251" class="indexterm"></a> <span class="strong"><strong>ActiveBarrier</strong></span> prefab is ready. Now, add the following localization strings to <code class="literal">English.txt</code>:</p><div class="informalexample"><pre class="programlisting">//Game
Barrier = [99FF99]Barrier
BuildingBarrier = [FF6666]Building\nBarrier...
Wait = Wait</pre></div><p>Also, add the following localization strings to <code class="literal">French.txt</code>:</p><div class="informalexample"><pre class="programlisting">//Game
Barrier = [99FF99]Barrière
BuildingBarrier = [FF6666]Construction\nBarrière...
Wait = Attendez</pre></div><p>Now, everything is set for our <span class="strong"><strong>ActiveBarrier</strong></span> prefab.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec56"></a>Instantiating the ActiveBarrier prefab</h3></div></div></div><p>Now <a id="id252" class="indexterm"></a>that we have our prefab, we need to instantiate it when a <span class="strong"><strong>BarrierObject</strong></span> prefab is dropped inside the <span class="strong"><strong>Viewport</strong></span> GameObject.</p><p>Open our <code class="literal">ViewportHolder.cs</code> script and declare our necessary variables:</p><div class="informalexample"><pre class="programlisting">//We need our two barriers Prefabs
public Object barrierObjectPrefab;
public Object activeBarrierPrefab;

//We need the BarrierObject container
public GameObject barrierContainer;</pre></div><p>Save the script. Let's go back to the scene and assign these variables in the <span class="strong"><strong>Inspector</strong></span> view:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select the <span class="strong"><strong>Viewport</strong></span> GameObject.</p></li><li><p>Drag the <span class="strong"><strong>BarrierObject</strong></span> prefab from the <span class="strong"><strong>Project</strong></span> view in the <span class="strong"><strong>BarrierObject</strong></span> prefab field of <span class="strong"><strong>Viewport Holder</strong></span>.</p></li><li><p>Drag the <span class="strong"><strong>ActiveBarrier</strong></span> prefab from the <span class="strong"><strong>Project</strong></span> view in the <span class="strong"><strong>ActiveBarrier</strong></span> prefab field <span class="strong"><strong>Viewport Holder</strong></span>.</p></li><li><p>Drag the <span class="strong"><strong>Barrier</strong></span> GameObject in <span class="strong"><strong>UI</strong></span> from the <span class="strong"><strong>Hierarchy</strong></span> view to the <span class="strong"><strong>Barrier Container</strong></span> field in <span class="strong"><strong>Viewport Holder</strong></span>.</p></li></ol></div><p>The necessary variables are assigned. Go back to our <code class="literal">ViewportHolder.cs</code> script, and add the following two lines to call the appropriate methods, after <code class="literal">Destroy(droppedObj)</code>:</p><div class="informalexample"><pre class="programlisting">RecreateBarrierObject();
CreateActiveBarrier(droppedObj.transform);</pre></div><p>Now, we <a id="id253" class="indexterm"></a>can add these two methods that will recreate our <span class="strong"><strong>BarrierObject</strong></span> prefab. Also, we can add an <span class="strong"><strong>ActiveBarrier</strong></span> prefab to the <span class="strong"><strong>Viewport</strong></span> GameObject:</p><div class="informalexample"><pre class="programlisting">void RecreateBarrierObject()
{
  //Add a BarrierObject to the container
  Transform newBarrierTrans = NGUITools.AddChild(barrierContainer, barrierObjectPrefab as GameObject).transform;
  //Reset its localPosition to {0,0,0}
  newBarrierTrans.localPosition = Vector3.zero;
}

void CreateActiveBarrier(Transform barrierObjectTrans)
{
  //Add an ActiveBarrier to the Viewport
  Transform newActiveBarrierTrans = NGUITools.AddChild(gameObject, activeBarrierPrefab as GameObject).transform;
  //Set position to the droppedObject's position
  newActiveBarrierTrans.position = barrierObjectTrans.position;
}</pre></div><p>Click on the play button. When you drag the <span class="strong"><strong>BarrierObject</strong></span> prefab onto the <span class="strong"><strong>Viewport</strong></span> GameObject, it creates our <span class="strong"><strong>ActiveBarrier</strong></span> prefab; and it recreates a <span class="strong"><strong>BarrierObject</strong></span> prefab to be able to drag another one.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec57"></a>Barrier's building process</h3></div></div></div><p>Right <a id="id254" class="indexterm"></a>now, our dropped <span class="strong"><strong>ActiveBarrier</strong></span> instances stay empty and never build. Let's make them fill themselves at a speed depending on the number of barriers in the scene:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select our <span class="strong"><strong>ActiveBarrier</strong></span> prefab in the <span class="strong"><strong>Project</strong></span> view.</p></li><li><p>Create and add an <code class="literal">ActiveBarrierController.cs</code> script to it.</p></li></ol></div><p>Open this new <code class="literal">ActiveBarrierController.cs</code> script, and add these necessary variables and the <code class="literal">Awake()</code> method to initialize them:</p><div class="informalexample"><pre class="programlisting">//We will need the Slider and the Label's UILocalize
private UISlider slider;
private UILocalize loc;

void Awake()
{
  //Get necessary components at Awake()
  slider = GetComponentInChildren&lt;UISlider&gt;();
  loc = GetComponentInChildren&lt;UILocalize&gt;();
}</pre></div><p>Now that we have our necessary variables initialized, let's add a coroutine that will increase the <span class="strong"><strong>UISlider</strong></span> value over time, at a rate depending on a given <code class="literal">buildTime</code>:</p><div class="informalexample"><pre class="programlisting">public IEnumerator Build(float buildTime)
{
    while(slider.value &lt; 1) {
    slider.value += (Time.deltaTime / buildTime);
    yield return null;
  }
  //When slider value is &gt; 1
  BuildFinished();
}</pre></div><p>Ok. Let's add <a id="id255" class="indexterm"></a>the <code class="literal">BuildFinished()</code> method that will set the <span class="strong"><strong>Slider</strong></span> value to <code class="literal">1</code> (in case this value is higher), and change the <span class="strong"><strong>UILocalize</strong></span> key:</p><div class="informalexample"><pre class="programlisting">private void BuildFinished()
{
  //Make sure it's at 1
  slider.value = 1;
  //Set the key to "normal" barrier and update Localization
  loc.key = "Barrier";
  loc.Localize();
}</pre></div><p>Good. We just need to edit the <code class="literal">ViewportHolder.cs</code> script to add a <code class="literal">barrierCount</code> variable, and start the new <code class="literal">Build()</code> coroutine from <span class="strong"><strong>ActiveBarrier</strong></span>.</p><p>Open the <code class="literal">ViewportHolder.cs</code> script and declare a new <code class="literal">int</code> after our <code class="literal">barrierContainer</code>:</p><div class="informalexample"><pre class="programlisting">public int barrierCount = 0;</pre></div><p>Now, let's add these two simple lines of code to update the <code class="literal">barrierCount</code> variable and start the <code class="literal">Build()</code> coroutine on our new <span class="strong"><strong>ActiveBarrier</strong></span> prefab:</p><div class="informalexample"><pre class="programlisting">//Update barrierCount
barrierCount++;
//Start the Build Coroutine with the correct buildTime
StartCoroutine(newActiveBarrierTrans.GetComponent&lt;ActiveBarrierController&gt;().Build(barrierCount *2));</pre></div><p>Click on the play button. Now, our <span class="strong"><strong>ActiveBarrier</strong></span> prefab builds itself depending on the number of <span class="strong"><strong>ActiveBarriers</strong></span> on the scene!</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec58"></a>Forwarding events to viewport</h3></div></div></div><p>You may<a id="id256" class="indexterm"></a> have noticed that you cannot scroll if you click on an <span class="strong"><strong>ActiveBarrier</strong></span> prefab. That's because it catches the events instead of our viewport.</p><p>Let's simply forward its events to the viewport:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select our <span class="strong"><strong>ActiveBarrier</strong></span> prefab in the <span class="strong"><strong>Project</strong></span> view.</p></li><li><p>Attach a <span class="strong"><strong>Forward Events</strong></span> component to it by navigating to <span class="strong"><strong>Component</strong></span> | <span class="strong"><strong>NGUI</strong></span> | <span class="strong"><strong>Interaction</strong></span> and perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Check its <span class="strong"><strong>On Press</strong></span> Boolean.</p></li><li><p>Check its <span class="strong"><strong>On Drag</strong></span> Boolean.</p></li></ol></div></li><li><p>Open the <code class="literal">ActiveBarrierController.cs</code> script that is attached to it.</p></li></ol></div><p>We need to assign the target variable of the <span class="strong"><strong>UIForward Event</strong></span> component when the <span class="strong"><strong>ActiveBarrier</strong></span> prefab is created. To do so, add a new <code class="literal">Start()</code> method with the following:</p><div class="informalexample"><pre class="programlisting">void Start()
{
  //Set the UIForwardEvents' target to the viewport
  GetComponent&lt;UIForwardEvents&gt;().target = transform.parent.gameObject;
}</pre></div><p>We can now scroll no matter what. We are missing something: a cooldown on the BarrierObjects that also depends on the number of ActiveBarriers.</p></div></div>