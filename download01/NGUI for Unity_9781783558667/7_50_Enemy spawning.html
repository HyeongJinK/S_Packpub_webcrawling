<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec50"></a>Enemy spawning</h2></div></div><hr /></div><p>We want <a id="id298" class="indexterm"></a>our enemies to spawn at the top of the viewport's background.<a id="id299" class="indexterm"></a> At spawn, the Y value can be the same for each of the enemies, but we want a random X value.</p><p>First of all, let's open our <span class="strong"><strong>Game</strong></span> scene.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec67"></a>Creating the enemies container</h3></div></div></div><p>Our enemies<a id="id300" class="indexterm"></a> will be nested in a container placed at the top left-hand corner of our background in order to have the {0, 0} positioned at the top left-hand corner of the viewport.</p><p>First, let's create our enemies holder by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select our <span class="strong"><strong>Viewport</strong></span> GameObject and perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new child by pressing <span class="emphasis"><em>Alt</em></span> + <span class="emphasis"><em>Shift</em></span> + <span class="emphasis"><em>N</em></span>.</p></li><li><p>Rename this new child as <code class="literal">Enemies</code>.</p></li></ol></div></li><li><p>Attach <span class="strong"><strong>Anchor</strong></span> to it by navigating to <span class="strong"><strong>NGUI</strong></span> | <span class="strong"><strong>Attach</strong></span>. Then perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Drag our <span class="strong"><strong>Background</strong></span> from Viewport into the <span class="strong"><strong>Container</strong></span> field.</p></li><li><p>Set its <span class="strong"><strong>Side</strong></span> parameter to <span class="strong"><strong>TopLeft</strong></span>.</p></li></ol></div></li></ol></div><p>Ok, we now have our enemies container in which we will instantiate our <span class="strong"><strong>Enemy</strong></span> prefab.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec68"></a>Creating the Enemy prefab</h3></div></div></div><p>Let's create <a id="id301" class="indexterm"></a>the <span class="strong"><strong>Enemy</strong></span> prefab that will be instantiated as child of the <span class="strong"><strong>Enemies</strong></span> GameObject. You must add the <code class="literal">Enemy.png</code> file included in the <code class="literal">Assets.zip</code> file to the <span class="strong"><strong>Game</strong></span> atlas before you continue or you may create your own 128 x 160 sprite. We will use a <span class="strong"><strong>Rigidbody</strong></span> to detect collisions between the enemies and our barriers.</p><p>Once the <code class="literal">Enemy.png</code> sprite has been added to the <span class="strong"><strong>Game</strong></span> atlas, follow the given steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select our <span class="strong"><strong>Viewport</strong></span> GameObject and perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new child with <span class="emphasis"><em>Alt</em></span> + <span class="emphasis"><em>Shift</em></span> + <span class="emphasis"><em>N</em></span>.</p></li><li><p>Rename this new child as <code class="literal">Spaceship</code>.</p></li></ol></div></li><li><p>Select our new <span class="strong"><strong>Spaceship</strong></span> GameObject.</p></li><li><p>Attach a collider to it by navigating to <span class="strong"><strong>NGUI</strong></span> | <span class="strong"><strong>Attach a Collider</strong></span> and perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Uncheck its <span class="strong"><strong>Is Trigger</strong></span> Boolean to detect collisions.</p></li><li><p>Set <span class="strong"><strong>Size</strong></span> to {<code class="literal">128</code>, <code class="literal">160</code>, <code class="literal">1</code>}.</p></li></ol></div></li><li><p>Attach a <span class="strong"><strong>Rigidbody</strong></span> component to it by navigating to <span class="strong"><strong>Component</strong></span> | <span class="strong"><strong>Physics</strong></span> and then perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Uncheck its <span class="strong"><strong>Use Gravity</strong></span> Boolean.</p></li><li><p>Check its <span class="strong"><strong>Is Kinematic</strong></span> Boolean.</p></li><li><p>Check the <span class="strong"><strong>Freeze Position</strong></span> and <span class="strong"><strong>Freeze Rotation</strong></span> Booleans for all its <span class="strong"><strong>Constraints</strong></span> in order to avoid any unwanted behavior.</p></li></ol></div></li><li><p>With our selected <span class="strong"><strong>Spaceship</strong></span> GameObject, create a new <span class="strong"><strong>Sprite</strong></span> by navigating to <span class="strong"><strong>NGUI</strong></span> | <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Sprite</strong></span>:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Change its <span class="strong"><strong>Sprite</strong></span> to our new <span class="strong"><strong>Enemy</strong></span> sprite.</p></li><li><p>Change its <span class="strong"><strong>Dimensions</strong></span> to <code class="literal">128</code> x <code class="literal">160</code>.</p></li><li><p>Set its <span class="strong"><strong>Depth</strong></span> to <code class="literal">1</code>.</p></li></ol></div></li><li><p>Drag our <span class="strong"><strong>Spaceship</strong></span> GameObject in your <code class="literal">Prefabs</code> folder.</p></li><li><p>Delete our <span class="strong"><strong>Spaceship</strong></span> instance from the scene.</p></li></ol></div><p>Ok, we now have our <span class="strong"><strong>Enemy</strong></span> prefab ready. Let's add a new script to it that will handle the enemy's initialization and movement, and perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> view, select our <span class="strong"><strong>Spaceship</strong></span> prefab.</p></li><li><p>Create and attach a new <code class="literal">EnemyController.cs</code> C# script to it.</p></li><li><p>Open this new <code class="literal">EnemyController.cs</code> script.</p></li></ol></div><p>Let's create <a id="id302" class="indexterm"></a>a new <code class="literal">Initialize()</code> method that will set the enemy's position outside the game with a random X and a tween duration depending on the float value that is passed as a parameter in the following manner:</p><div class="informalexample"><pre class="programlisting">public void Initialize(float _movementDuration)
{
  //Get the Viewport's Background size
  Vector2 bgSize = 
    transform.parent.parent.FindChild("Background").GetComponent&lt;UISprite&gt;().localSize;
  //Get this enemy's sprite size
  Vector2 spriteSize = 
    transform.FindChild("Sprite").GetComponent&lt;UISprite&gt;().localSize;
  //Set its position to a random X, and Y of -(enemyHeight/2)
  transform.localPosition = 
<span class="strong"><strong>    new Vector3(Random.Range(spriteSize.x *0.5f, bgSize.x - (spriteSize.x *0.5f)), -(spriteSize.y *0.5f), 0);</strong></span>
  //Tween its position towards end of background
  TweenPosition.Begin(gameObject, _movementDuration,
    new Vector3(transform.localPosition.x, -bgSize.y + (spriteSize.y * 0.5f), 0));
}</pre></div><p>We used <code class="literal">spriteSize.x * 0.5f</code> in the preceding code because our enemy has a centered pivot and we want to avoid spawning it outside the background's width.</p><p>The <code class="literal">_movementDuration</code> parameter is used to define how much time the enemy will take to cross our entire background; it is used as speed. But to balance the speed, a value of 10 is used, which means that the enemy will need 10 seconds to hit the bottom of the background.</p><p>At this stage, your hierarchy should look as follows:</p><div class="mediaobject"><img src="/graphics/9781783558667/graphics/8667OT_07_02.jpg" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec69"></a>Creating the enemy spawn controller</h3></div></div></div><p>Before<a id="id303" class="indexterm"></a> we can launch the game, we need to add an <code class="literal">EnemySpawnController.cs</code> script<a id="id304" class="indexterm"></a> that will handle enemy spawn rates and instantiate enemies when needed. To add the script, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select the <span class="strong"><strong>Enemies</strong></span> GameObject from <span class="strong"><strong>Viewport</strong></span>.</p></li><li><p>Create and attach a new <code class="literal">EnemySpawnController.cs</code> C# script.</p></li><li><p>Open this new <code class="literal">EnemySpawnController.cs</code> script.</p></li></ol></div><p>In this new script, we need to add a <code class="literal">SpawnEnemy()</code> coroutine that will be called at random intervals to instantiate <span class="strong"><strong>Enemy</strong></span> prefabs and initialize them with the correct position and tween duration. First, we need to declare these variables as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">//We need our Enemy Prefab for Instantiation
public Object enemyPrefab;
//Random-control variables
public int firstEnemyDelay = 1;
//Min and Max intervals between 2 spawns
public float minInterval = 4;
public float maxInterval = 15;
//Min and Max Enemy MovementTime
public float minMovementTime = 20;
public float maxMovementTIme = 50;</pre></div><p>The variables declared in the previous code will be used to control our random values. You may change them in the <span class="strong"><strong>Inspector</strong></span> view. We need to assign our <code class="literal">enemyPrefab</code> variable.</p><p>To do this, go back to Unity and follow the given steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select the <span class="strong"><strong>Enemies</strong></span> GameObject from <span class="strong"><strong>Viewport</strong></span>.</p></li><li><p>Drag our <span class="strong"><strong>Spaceship</strong></span> prefab from the <span class="strong"><strong>Project</strong></span> view inside the <span class="strong"><strong>Enemy Prefab</strong></span> field in <span class="strong"><strong>Enemy Spawn Controller</strong></span>.</p></li></ol></div><p>Ok, the necessary <a id="id305" class="indexterm"></a>variables are initialized. Now, let's go back to our <code class="literal">EnemySpawnController.cs</code> script and add a new <code class="literal">SpawnEnemy()</code> coroutine by using the following code snippet:</p><div class="informalexample"><pre class="programlisting">//Coroutine that spawns enemies
IEnumerator SpawnEnemy()
{
  //First time, set to firstEnemyDelay
  float delay = firstEnemyDelay;
  //Loop while the game is running
  while(true){
    //Wait for the correct delay
    yield return new WaitForSeconds(delay);
    //Create a new enemy, stock its EnemyController
    EnemyController newEnemy =
      NGUITools.AddChild(gameObject, enemyPrefab as GameObject).GetComponent&lt;EnemyController&gt;();
    //Initialize it with random speed
    newEnemy.Initialize(Random.Range (minMovementTime, maxMovementTIme));
    //Set the new random delay
    delay = Random.Range(minInterval, maxInterval);
  }
}</pre></div><p>Our coroutine is ready. Let's start it when the game starts running. We can use the <code class="literal">Start()</code> method for this. Add this method just below our <code class="literal">SpawnEnemy()</code> coroutine in the following manner:</p><div class="informalexample"><pre class="programlisting">void Start ()
{
  //Start the Spawn Coroutine with first delay
  StartCoroutine(SpawnEnemy());
}</pre></div><p>Save the script and click on the play button. The first enemy is spawned after the <code class="literal">firstEnemyDelay</code>. After the first enemy, new enemies are spawned at random X positions, at random intervals, and at a random speed.</p><p>Your <span class="strong"><strong>Hierarchy</strong></span> view should look as follows when a few enemies have spawned:</p><div class="mediaobject"><img src="/graphics/9781783558667/graphics/8667OT_07_03.jpg" /></div><p>Spawned enemies move down and stop at the end of the Viewport's background as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783558667/graphics/8667OT_07_04.jpg" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec70"></a>Forwarding events to viewport</h3></div></div></div><p>Ok, we<a id="id306" class="indexterm"></a> now have our mobile enemies, but we still have a slight problem. You may have noticed that you cannot drag the viewport if you click on an enemy. We had the same problem before with the <span class="strong"><strong>ActiveBarrier</strong></span> prefab.</p><p>We need to add a <span class="strong"><strong>UIForwardEvents</strong></span> component to the <span class="strong"><strong>Spaceship</strong></span> prefab by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> view, select our <span class="strong"><strong>Spaceship</strong></span> prefab.</p></li><li><p>Attach a <span class="strong"><strong>Forward Events</strong></span> component to it by navigating to <span class="strong"><strong>Component</strong></span> | <span class="strong"><strong>NGUI</strong></span> | <span class="strong"><strong>Interaction</strong></span>. Then perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Check its <span class="strong"><strong>OnPress</strong></span> Boolean.</p></li><li><p>Check its <span class="strong"><strong>OnDrag</strong></span> Boolean.</p></li></ol></div></li><li><p>Open its attached <code class="literal">EnemyController.cs</code> script.</p></li></ol></div><p>Add the following line at the end of the <code class="literal">Initialize()</code> method of <code class="literal">EnemyController.cs</code> script:</p><div class="informalexample"><pre class="programlisting">//Set the Viewport as target for UIForwardEvents
GetComponent&lt;UIForwardEvents&gt;().target = transform.parent.parent.gameObject;</pre></div><p>You can now pan the viewport even if you click on an enemy. It is time to handle collisions with barriers.</p></div></div>