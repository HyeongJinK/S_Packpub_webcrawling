<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec51"></a>Handling enemy collisions</h2></div></div><hr /></div><p>We need to<a id="id307" class="indexterm"></a> handle collisions between our enemies and<a id="id308" class="indexterm"></a> ActiveBarriers. Since we have a Rigidbody attached to our <span class="strong"><strong>Enemy</strong></span> prefab, it will receive the <code class="literal">OnTriggerEnter()</code> event<a id="id309" class="indexterm"></a> when it hits the collider of an <span class="strong"><strong>ActiveBarrier</strong></span> GameObject.</p><p>Once the collisions with ActiveBarriers are implemented, we'll add collisions with the bottom of the screen, which will reduce the player's health.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec71"></a>Collisions with active barriers</h3></div></div></div><p>First of all,<a id="id310" class="indexterm"></a> we must disable the ActiveBarrier's collider by default and enable it when the barrier is built in the following manner:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> view, select our <span class="strong"><strong>ActiveBarrier</strong></span> prefab.</p></li><li><p>Disable its <span class="strong"><strong>Box Collider</strong></span> component using its checkbox.</p></li><li><p>Open the <code class="literal">ActiveBarrierController.cs</code> script attached to it.</p></li><li><p>We will need a new <code class="literal">built</code> boolean that will help us know if the barrier has finished its building process. Along with our <code class="literal">UISlider</code> and <code class="literal">UILocalize</code> variables, declare the following:</p><div class="informalexample"><pre class="programlisting">private bool built = false;</pre></div></li><li><p>Now, add the following two lines at the end of the <a id="id311" class="indexterm"></a>
<code class="literal">BuildFinished()</code> method:</p><div class="informalexample"><pre class="programlisting">//Set the build value to true and activate collider
built = true;
collider.enabled = true;</pre></div></li><li><p>Ok, now the collider is enabled only when the barrier is built. We can add a <code class="literal">HitByEnemy()</code> method with the concerned <code class="literal">enemy</code> passed as a parameter that will destroy t<a id="id312" class="indexterm"></a>he barrier and the enemy in the following manner:</p><div class="informalexample"><pre class="programlisting">public void HitByEnemy(EnemyController enemy)
{
  //If the barrier isn't built, don't go further
  if(!built) return;
  //Else, kill the enemy
  StartCoroutine(enemy.Kill());
  //Kill the barrier too
  StartCoroutine(RemoveBarrier());
}</pre></div></li><li><p>Here, we start two coroutines: one to kill the enemy and another one to remove<a id="id313" class="indexterm"></a> the barrier. Let's add the <code class="literal">RemoveBarrier()</code> coroutine now with the following code snippet:</p><div class="informalexample"><pre class="programlisting">IEnumerator RemoveBarrier()
{
  //Tween for smooth disappearance
  TweenScale.Begin(gameObject, 0.2f, Vector3.zero);
  //Notify the Viewport that a Barrier has been removed
  transform.parent.SendMessage("BarrierRemoved");
  //Wait for end of tween, then destroy the barrier
  yield return new WaitForSeconds(0.2f);
  Destroy(gameObject);
}</pre></div><p>The coroutine in the previous code scales down the barrier before it is destroyed. We send a message to the parent (<span class="strong"><strong>Viewport</strong></span>) because we need to decrease the <code class="literal">barrierCount</code> value.</p></li><li><p>Let's add the <code class="literal">BarrierRemoved()</code> method<a id="id314" class="indexterm"></a> in the <code class="literal">ViewportHolder.cs</code> script. In the <span class="strong"><strong>Hierarchy</strong></span> view, select our <span class="strong"><strong>Viewport</strong></span> GameObject and open the <code class="literal">ViewportHolder.cs</code> script attached to it.</p></li><li><p>In our <code class="literal">ViewportHolder.cs</code> script, add the following new <code class="literal">BarrierRemoved()</code> method:</p><div class="informalexample"><pre class="programlisting">void BarrierRemoved()
{
  //Decrease the barrierCount value
  barrierCount--;
}</pre></div></li><li><p>The <code class="literal">barrierCount</code> value will be updated as soon as a barrier is destroyed. Now, let's open the <code class="literal">EnemyController.cs</code> script and add the <code class="literal">Kill()</code> coroutine as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">public IEnumerator Kill()
{
  //Tween for smooth disappearance
  TweenScale.Begin(gameObject, 0.2f, Vector3.zero);
  //Deactivate the collider now
  collider.enabled = false;
  //Wait end of tween, then destroy the enemy
  yield return new WaitForSeconds(0.2f);
  Destroy(gameObject);
}</pre></div></li><li><p>Great! All of our coroutines and methods are ready. Now, we need to call the <code class="literal">HitByEnemy()</code> method of the concerned <span class="strong"><strong>ActiveBarrier</strong></span> when a collision occurs.</p></li><li><p>We just have to add the following <code class="literal">OnTriggerEnter()</code> method inside our <code class="literal">EnemyController.cs</code> script, which will call this method only if the collided object actually is a barrier:</p><div class="informalexample"><pre class="programlisting">void OnTriggerEnter(Collider other)
{
  //Store the collided object's ActiveBarrierController
  ActiveBarrierController barrierController = other.GetComponent&lt;ActiveBarrierController&gt;();
  //If it has a BarrierController, call HitByEnemy
  if(barrierController != null)
  barrierController.HitByEnemy(this);
}</pre></div></li><li><p>Save all of<a id="id315" class="indexterm"></a> the scripts and click on the play button. </p></li></ol></div><p>If you place a barrier on an enemy's trajectory, both of them will be destroyed when they collide! If the building process isn't over, nothing happens.</p><p>In the case where a barrier finishes its building process while an enemy is still inside it, a collision will occur. Perfect!</p><p>Now that the player can destroy his or her enemies, let's add a way for the enemies to destroy the player.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec72"></a>Colliding with the bottom of the screen</h3></div></div></div><p>We can<a id="id316" class="indexterm"></a> now add a collider at the bottom of the viewport's background that will destroy enemies and reduce the player's health. Before we do this, let's create a Healthbar with a HealthController script.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl3sec27"></a>Healthbar</h4></div></div></div><p>To create<a id="id317" class="indexterm"></a> this Healthbar<a id="id318" class="indexterm"></a>, we need the <code class="literal">Button.png</code> file available in the <code class="literal">Assets.zip</code> file. If you haven't added it to the <span class="strong"><strong>Game</strong></span> Atlas as a sliced sprite yet, please do so before you continue.</p><p>We will use a Progress Bar to create a Healthbar on which we will add a <code class="literal">HealthController.cs</code> script to handle the display of damage and health points. Perform the <a id="id319" class="indexterm"></a>following steps to do so:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>UI</strong></span> GameObject from <span class="strong"><strong>Anchor</strong></span>.</p></li><li><p>Open the <span class="strong"><strong>Widget Tool</strong></span> window by navigating to <span class="strong"><strong>NGUI</strong></span> | <span class="strong"><strong>Create a Widget</strong></span>. Then perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select our <span class="strong"><strong>Game</strong></span> Atlas.</p></li><li><p>Select the <span class="strong"><strong>Progress Bar</strong></span> template.</p></li><li><p>Select our <span class="strong"><strong>Button</strong></span> sprite for the <span class="strong"><strong>Empty</strong></span> field.</p></li><li><p>Select our <span class="strong"><strong>Button</strong></span> sprite for the <span class="strong"><strong>Full</strong></span> field.</p></li><li><p>With our <span class="strong"><strong>UI</strong></span> GameObject selected, click on the <span class="strong"><strong>Add To</strong></span> button.</p></li></ol></div></li><li><p>Select <a id="id320" class="indexterm"></a>the new <span class="strong"><strong>Progress Bar</strong></span> GameObject and rename it as <code class="literal">Healthbar</code>.</p></li><li><p>Attach an <span class="strong"><strong>Anchor</strong></span> to it by navigating to <span class="strong"><strong>NGUI</strong></span> | <span class="strong"><strong>Attach</strong></span>. Then perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Drag our <span class="strong"><strong>Viewport</strong></span> GameObject in the <span class="strong"><strong>Container</strong></span> field.</p></li><li><p>Set the <span class="strong"><strong>Side</strong></span> parameter to <span class="strong"><strong>Top</strong></span>.</p></li><li><p>Set <span class="strong"><strong>Pixel Offset</strong></span> to {<code class="literal">-160</code>, <code class="literal">-30</code>}.</p></li></ol></div></li><li><p>Select the <span class="strong"><strong>Background</strong></span> GameObject from <span class="strong"><strong>Healthbar</strong></span> and perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Set <span class="strong"><strong>Color Tint</strong></span> to {<code class="literal">255</code>, <code class="literal">120</code>, <code class="literal">120</code>, <code class="literal">140</code>}.</p></li><li><p>Set <span class="strong"><strong>Dimensions</strong></span> to <code class="literal">320</code> x <code class="literal">42</code>.</p></li><li><p>Change <span class="strong"><strong>Sprite Type</strong></span> to <span class="strong"><strong>Sliced</strong></span>.</p></li><li><p>Click on the <span class="strong"><strong>Edit</strong></span> button next to the <span class="strong"><strong>Sprite</strong></span> field.</p></li><li><p>Set all four border values to <code class="literal">6</code> for slicing parameters.</p></li></ol></div></li><li><p>Select the <span class="strong"><strong>Foreground</strong></span> GameObject from <span class="strong"><strong>Healthbar</strong></span> and then perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Set <span class="strong"><strong>Color Tint</strong></span> to {<code class="literal">25</code>, <code class="literal">245</code>, <code class="literal">255</code>, <code class="literal">255</code>}.</p></li><li><p>Set <span class="strong"><strong>Dimensions</strong></span> to <code class="literal">320</code> x <code class="literal">42</code>.</p></li><li><p>Change <span class="strong"><strong>Sprite Type</strong></span> to <span class="strong"><strong>Sliced</strong></span>.</p></li></ol></div></li></ol></div><p>Ok, we have a configured health bar centered at the top of the screen. We need to add a script to it that will handle health points and modify the value of <span class="strong"><strong>Slider</strong></span> accordingly. The steps to do so are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Hierarchy</strong></span> view, select our <span class="strong"><strong>Healthbar</strong></span> GameObject.</p></li><li><p>Create and add a new <code class="literal">HealthController.cs</code> script to it.</p></li><li><p>Open this new <code class="literal">HealthController.cs</code> script.</p></li></ol></div><p>In this new script, we will save a static reference to the instance of the <code class="literal">HealthController</code> class so that its methods are easily accessible from other scripts. First, let's declare necessary variables and initialize them on <code class="literal">Awake()</code> as shown in the following code:</p><div class="informalexample"><pre class="programlisting">//Static variable that will store this instance
public static HealthController Instance;
//We will need the attached slider and a HP value
private UISlider slider;
private float hp = 100;

void Awake()
{
  //Store this instance in the Instance variable
  Instance = this;
  //Get the slider Component
  slider = GetComponent&lt;UISlider&gt;();
}</pre></div><p>Ok, our <a id="id321" class="indexterm"></a>variables are now initialized correctly. Let's create a <code class="literal">Damage()</code> method that will reduce the <code class="literal">hp</code> value and update the slider as follows:</p><div class="informalexample"><pre class="programlisting">public void Damage(float dmgValue)
{
  //Set new HP value with a clamp between 0 and 100
  hp = Mathf.Clamp(hp - dmgValue, 0, 100);
  //Update the slider to a value between 0 and 1
  slider.value = hp * 0.01f;
  //If hp &lt;= 0, restart level
  if(hp &lt;= 0)
  Application.LoadLevel(Application.loadedLevel);
}</pre></div><p>Great! The <code class="literal">Damage()</code> method<a id="id322" class="indexterm"></a> is ready. Let's create the <span class="strong"><strong>EndOfScreen</strong></span> widget that will collide with the enemies.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl3sec28"></a>The EndOfScreen widget</h4></div></div></div><p>Let's create<a id="id323" class="indexterm"></a> the <a id="id324" class="indexterm"></a>
<span class="strong"><strong>EndOfScreen</strong></span> widget that will help detect enemy collisions as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Hierarchy</strong></span> view, select our <span class="strong"><strong>Viewport</strong></span> GameObject and perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new child by pressing <span class="emphasis"><em>Alt</em></span> + <span class="emphasis"><em>Shift</em></span> + <span class="emphasis"><em>N</em></span>.</p></li><li><p>Rename this new child as <code class="literal">EndOfScreen</code>.</p></li></ol></div></li><li><p>Attach a collider to it by navigating to <span class="strong"><strong>NGUI</strong></span> | <span class="strong"><strong>Attach a Collider</strong></span> and set <span class="strong"><strong>Size</strong></span> to {<code class="literal">3840</code>, <code class="literal">43</code>, <code class="literal">1</code>}.</p></li><li><p>Attach <a id="id325" class="indexterm"></a>
<span class="strong"><strong>Anchor</strong></span> to it by navigating to <span class="strong"><strong>NGUI</strong></span> | <span class="strong"><strong>Attach</strong></span>.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Drag the <span class="strong"><strong>Background</strong></span> GameObject from <span class="strong"><strong>Viewport</strong></span> in the <span class="strong"><strong>Container</strong></span> field.</p></li><li><p>Set its <span class="strong"><strong>Side</strong></span> parameter to <span class="strong"><strong>Bottom</strong></span>.</p></li><li><p>Set its <span class="strong"><strong>Pixel Offset</strong></span> to {<code class="literal">0</code>, <code class="literal">33</code>}.</p></li></ol></div></li><li><p>Click <a id="id326" class="indexterm"></a>on the <span class="strong"><strong>Untagged / Add Tag…</strong></span> button at the top of the <span class="strong"><strong>Inspector</strong></span> view.</p></li><li><p>Create a new <code class="literal">DamageZone</code> tag.</p></li><li><p>Select our <span class="strong"><strong>EndOfScreen</strong></span> GameObject.</p></li><li><p>Set <span class="strong"><strong>Tag</strong></span> to <span class="strong"><strong>DamageZone</strong></span>.</p></li><li><p>Make sure our <span class="strong"><strong>EndOfScreen</strong></span> GameObject is selected.</p></li><li><p>Create a new sprite by navigating to <span class="strong"><strong>NGUI</strong></span> | <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Sprite</strong></span> and perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Set its <span class="strong"><strong>Atlas</strong></span> type to the <span class="strong"><strong>SciFi</strong></span> Atlas.</p></li><li><p>Set its <span class="strong"><strong>Sprite</strong></span> type to the <span class="strong"><strong>Honeycomb</strong></span> sprite.</p></li><li><p>Set its <span class="strong"><strong>Sprite Type</strong></span> to <span class="strong"><strong>Tiled</strong></span>.</p></li><li><p>Set its <span class="strong"><strong>Color Tint</strong></span> values to <span class="strong"><strong>R</strong></span>: <code class="literal">255</code>, <span class="strong"><strong>G</strong></span>: <code class="literal">120</code>, <span class="strong"><strong>B</strong></span>: <code class="literal">120</code>, and <span class="strong"><strong>A</strong></span>: <code class="literal">255</code>.</p></li><li><p>Set its <span class="strong"><strong>Depth</strong></span> value to <code class="literal">2</code>.</p></li><li><p>Set its <span class="strong"><strong>Dimensions</strong></span> parameter to <code class="literal">3840</code> x <code class="literal">43</code>.</p></li></ol></div></li></ol></div><p>Good. We now have an <span class="strong"><strong>EndOfScreen</strong></span> limit with a sprite and a collider. Now, we need to edit our <code class="literal">EnemyController.cs</code> script's <code class="literal">OnTriggerEnter()</code> method<a id="id327" class="indexterm"></a> to check if the collided object has the <span class="strong"><strong>DamageZone</strong></span> tag and hurt the player if needed. Perform the following steps to do so:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> view, select our <span class="strong"><strong>SpaceShip</strong></span> prefab and open the <code class="literal">EnemyController.cs</code> script attached to it.</p></li><li><p>Within the <code class="literal">EnemyController.cs</code> script, at the very first line of the <code class="literal">OnTriggerEnter()</code> method, add the following lines to check if the collided object has a <span class="strong"><strong>DamageZone</strong></span> tag:</p><div class="informalexample"><pre class="programlisting">//Is the collided object a DamageZone?
if(other.CompareTag("DamageZone"))
{
  //In that case, hurt the player
  HealthController.Instance.Damage(30f);
  //Then, kill the enemy and don't go further
  StartCoroutine(Kill());
  return;
}</pre></div></li><li><p>Save all of the <a id="id328" class="indexterm"></a>scripts and click on the play button. Now, our enemies are destroyed when they collide with the end of the Viewport, and the player's health is decreased!</p></li></ol></div><p>Now, let's add another way to destroy our enemies.</p></div></div></div>