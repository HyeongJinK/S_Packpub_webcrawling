<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec72"></a>Creating patrolling NPCs</h2></div></div><hr /></div><p>We now have an <a id="id449" class="indexterm"></a>NPC that follows a destination object, which is valuable in itself as an exercise, but we'll need more sophisticated <a id="id450" class="indexterm"></a>behavior than this. Specifically, we'll need the NPC to patrol, that is, move across multiple destinations in order via a waypoint system, moving from one destination to the next in sequence. There are multiple approaches that could be taken to achieve this. One method is through script. Through this method, we'd create an array of different waypoint objects and iterate through them on a loop such that when the NPC reaches one destination, they'll move on to the next one. Now, this approach can be very efficient and effective, but there's another method. Specifically, instead of using script, we can create an animation to move a single destination object to different waypoint locations over time, and because the NPC continually follows the destination wherever it moves, it will continually patrol.</p><p>Let's take this second approach. Start by opening the <span class="strong"><strong>Animation</strong></span> window by selecting <span class="strong"><strong>Window</strong></span> | <span class="strong"><strong>Animation</strong></span> from the application menu. See <span class="emphasis"><em>Figure 7.32</em></span>. Dock the <span class="strong"><strong>Animation</strong></span> window into a horizontal view in the <span class="strong"><strong>Project</strong></span> panel, if you prefer, for ease of viewing.</p><div class="mediaobject"><img src="/graphics/9781785888380/graphics/B05118_07_32.jpg" /><div class="caption"><p>Figure 7.32: Accessing the Animation window</p></div></div><p>Next, select the object to animate (the destination object) from the <span class="strong"><strong>Hierarchy</strong></span> panel and, from the <span class="strong"><strong>Animation</strong></span> window, click on the <span class="strong"><strong>Create</strong></span> button. From here, you will be asked to name and save <a id="id451" class="indexterm"></a>the animation. I've called the animation <code class="literal">anim_DestPatrol</code>. See <span class="emphasis"><em>Figure 7.33</em></span>:</p><div class="mediaobject"><img src="/graphics/9781785888380/graphics/B05118_07_33.jpg" /><div class="caption"><p>Figure 7.33: Creating a new Animation</p></div></div><p>Once the animation is <a id="id452" class="indexterm"></a>created you can proceed to define animation channels. For the destination object, we'll need a channel for the position field as the object should change position around the scene. Click on the <span class="strong"><strong>Add Property</strong></span> button from the <span class="strong"><strong>Animation</strong></span> window, and then choose <span class="strong"><strong>Transform</strong></span> | <span class="strong"><strong>Position</strong></span> to add a new position channel. This will automatically create starting and ending key frames in the timeline, which are identical and hold the object position. See <span class="emphasis"><em>Figure 7.34</em></span>:</p><div class="mediaobject"><img src="/graphics/9781785888380/graphics/B05118_07_34.jpg" /><div class="caption"><p>Figure 7.34: Creating a new Animation</p></div></div><p>Now, simply click and drag the vertical, red time slider across the timeline in the <span class="strong"><strong>Animation</strong></span> window, between the 0-1 range, and then change the position of the destination <a id="id453" class="indexterm"></a>object in the <span class="strong"><strong>Scene</strong></span> tab to a new position. When you do this, Unity records the object position for that key frame. Repeat this process across the timeline, moving the destination object to different positions each time, and this creates a complete patrol animation. See <span class="emphasis"><em>Figure 7.35</em></span>:</p><div class="mediaobject"><img src="/graphics/9781785888380/graphics/B05118_07_35.jpg" /><div class="caption"><p>Figure 7.35: Building a Patrol Animation..</p></div></div><p>Play the animation <a id="id454" class="indexterm"></a>back by pressing play from either the <span class="strong"><strong>Animation</strong></span> window or via the toolbar. By default, the animation will probably play back too fast (that's an easy fix, as we'll see), but notice also that, as expected, the destination object is <span class="emphasis"><em>tweened</em></span>. That is, the Unity Animation interpolates between the key frames in the timeline, causing the destination object to slide or move smoothly between waypoints. For animation like this, however, we just want the destination to teleport or snap between waypoints immediately without any transition. To achieve this, we need to adjust the interpolation mode of the animation curves. Click on the <span class="strong"><strong>Curves</strong></span> button at the bottom left corner of the <span class="strong"><strong>Animation</strong></span> window. By default, the <span class="strong"><strong>Animation</strong></span> <a id="id455" class="indexterm"></a>window is in the <span class="strong"><strong>DopeSheet</strong></span> mode, allowing us to see key frames easily and reposition them. The Curve mode, however, lets us adjust the interpolation between key frames. See <span class="emphasis"><em>Figure 7.36</em></span>:</p><div class="mediaobject"><img src="/graphics/9781785888380/graphics/B05118_07_36.jpg" /><div class="caption"><p>Figure 7.36: Accessing Animation Curves</p></div></div><p>Now, box-select (click and drag a selection box) across all key frames in the graph view to select them <a id="id456" class="indexterm"></a>all. Then, right-click to display the key frame context menu and, from the menu, choose <span class="strong"><strong>Right Tangent</strong></span> | <span class="strong"><strong>Constant</strong></span> to change all handles to a flat constant shape, meaning all key frames retain their values over the destination object until the next key frame only. See <span class="emphasis"><em>Figure 7.37</em></span>:</p><div class="mediaobject"><img src="/graphics/9781785888380/graphics/B05118_07_37.jpg" /><div class="caption"><p>Figure 7.37: Changing Key Frame handles for interpolation</p></div></div><p>When the <span class="strong"><strong>Constant</strong></span> option is chosen from the menu, the curves between key frames will look very <a id="id457" class="indexterm"></a>different in the graphâ€”a straight line joining them. See <span class="emphasis"><em>Figure 7.38</em></span>:</p><div class="mediaobject"><img src="/graphics/9781785888380/graphics/B05118_07_38.jpg" /><div class="caption"><p>Figure 7.38: Constant interpolation</p></div></div><p>Now test this by pressing play on the toolbar. When you do this, the Destination should jump between waypoints as the animation progresses, and the NPC will continually move and travel towards the <a id="id458" class="indexterm"></a>destination. Due to the default speed of the animation, the NPC may seem confused or crazed as he is torn between rapidly changing destinations. To fix this, select the Destination object in the <span class="strong"><strong>Hierarchy</strong></span> panel and, from the <span class="strong"><strong>Object Inspector</strong></span>, double-click on the <span class="strong"><strong>Controller</strong></span> field of the Animator component to open the animator graph attached to the object, which controls when specific animations should play. See <span class="emphasis"><em>Figure 7.39</em></span>:</p><div class="mediaobject"><img src="/graphics/9781785888380/graphics/B05118_07_39.jpg" /><div class="caption"><p>Figure 7.39: Accessing the Animator asset</p></div></div><p>You can also show the <span class="strong"><strong>Animator</strong></span> window manually by choosing <span class="strong"><strong>Window</strong></span> | <span class="strong"><strong>Animator</strong></span> from the application menu. In the <span class="strong"><strong>Animator</strong></span> window, the default node is highlighted in orange. This <a id="id459" class="indexterm"></a>node (animation) will play when the object is first activated in the level, which is normally on level startup. See <span class="emphasis"><em>Figure 7.40</em></span>:</p><div class="mediaobject"><img src="/graphics/9781785888380/graphics/B05118_07_40.jpg" /><div class="caption"><p>Figure 7.40: The orange DestPatrol animation is the default in the Animator window</p></div></div><p>Select the <span class="strong"><strong>DestPatrol</strong></span> node in the graph and reduce its <span class="strong"><strong>Speed</strong></span> from the <span class="strong"><strong>Object Inspector</strong></span>. In my case, I've used a <a id="id460" class="indexterm"></a>value of <code class="literal">0.2</code>, which works <a id="id461" class="indexterm"></a>well. Once the speed is changed, replay your game to observe the effect. See <span class="emphasis"><em>Figure 7.41</em></span>:</p><div class="mediaobject"><img src="/graphics/9781785888380/graphics/B05118_07_41.jpg" /><div class="caption"><p>Figure 7.41: Reducing animation speed</p></div></div><p>On pressing play, the NPC should now move between destinations at a believable speed, moving from one waypoint to the next. If the NPC moves too fast or too slow between waypoints, increase or decrease the animation speed further to get the result you need. Congratulations! You <a id="id462" class="indexterm"></a>now have a complete, animated waypoint system. See <span class="emphasis"><em>Figure 7.42</em></span>:</p><div class="mediaobject"><img src="/graphics/9781785888380/graphics/B05118_07_42.jpg" /><div class="caption"><p>Figure 7.42: Waypoint system in action</p></div></div></div>