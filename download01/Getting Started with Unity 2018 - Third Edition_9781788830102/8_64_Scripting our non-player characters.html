<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec65"></a>Scripting our non-player characters</h2></div></div><hr /></div><p>In this section, we will write the necessary <span>scripts</span><a id="id288345145" class="indexterm"></a> to manage the Cucumber Beetles in our game. Specifically, we will write scripts to accomplish the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Beetle patrol</li><li style="list-style-type: disc">Beetle finds and eats cucumber</li><li style="list-style-type: disc">Beetle attacks player on the ground</li><li style="list-style-type: disc">Beetle stands to attack</li></ul></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec76"></a>Getting organized</h3></div></div></div><p>Since we are writing several scripts, we should stay organized. We can click <strong class="userinput"><code>Favorites</code></strong> | <strong class="userinput"><code>All Scripts</code></strong> in the <strong class="userinput"><code>Project</code></strong> panel to get a list of all the <span>scripts</span><a id="id288604682" class="indexterm"></a> in our project, but there are a lot of them, most of which we will not edit for our game. So, let's create a folder in the <strong class="userinput"><code>Project</code></strong> panel to organize our custom scripts. Here are the steps: </p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In the <strong class="userinput"><code>Project</code></strong> panel, right-click the <code class="literal">Assets</code> folder</li><li>Select <strong class="userinput"><code>Create</code></strong> | <strong class="userinput"><code>Folder</code></strong></li><li>Name the new folder <code class="literal">Custom Scripts</code></li></ol></div><p>Now that we have a folder for our custom scripts, let's move a few: </p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In the <strong class="userinput"><code>Project</code></strong> panel, click<strong class="userinput"><code>Favorites</code></strong> | <strong class="userinput"><code>All Scripts</code></strong>. </li><li>Scroll until you find the <code class="literal">BeetleNPC</code> script we created earlier in this chapter.</li><li>Drag the <code class="literal">BeetleNPC</code> script to our <code class="literal">Custom Scripts</code> folder. This moves the <code class="literal">BeetleNPC</code> script to the designated folder. You will still see it in <strong class="userinput"><code>Favorites</code></strong> | <strong class="userinput"><code>All Scripts</code></strong> because this feature shows all scripts regardless of their location.</li><li>Move the<code class="literal">CameraFollower</code>script to the<code class="literal">Custom Scripts</code>folder.</li><li>Move the<code class="literal">PlayerController</code>script to the<code class="literal">Custom Scripts</code>folder.</li><li>Move the<code class="literal">PlayerMotor</code>script to the<code class="literal">Custom Scripts</code>folder.</li></ol></div><p>When you are done moving scripts, your <code class="literal">Cucumber Scripts</code> folder should be the same as the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781788830102/graphics/6290c501-be6b-492f-a2ad-5a2bc12bf6ea.png" /></div><p>Our beetles will have the following behaviors in our game:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Search for cucumbers (patrol)</li><li style="list-style-type: disc">Eat cucumbers when found</li><li style="list-style-type: disc">Defend itself from the Cucumber Man on the ground</li><li style="list-style-type: disc">Stand to defend itself from the Cucumber Man</li></ul></div><p>The next sections will show you how to script these behaviors.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec77"></a>Beetle patrol</h3></div></div></div><p>Beetles in our game will search for cucumbers <span>within</span><a id="id288608690" class="indexterm"></a> the sandbox area. In this section, we will write a script to manage their patrol. Let's take some preparatory steps.</p><p>We will get started by creating a character controller for our <code class="literal">Beetle</code> prefab. Here are the steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In the <strong class="userinput"><code>Project</code></strong> panel, select <strong class="userinput"><code>Assets</code></strong> | <strong class="userinput"><code>Prefabs</code></strong> and click on the <code class="literal">Beetle</code> prefab</li><li>In the <strong class="userinput"><code>Inspector</code></strong> panel, click the <strong class="userinput"><code>Add Component</code></strong> button</li><li>Select <strong class="userinput"><code>Physics</code></strong> | <strong class="userinput"><code>Character Controller</code></strong></li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip37"></a>Note</h3><p>Be sure that you add the character controller to the <code class="literal">Beetle</code> prefab, not a beetle that you have in your scene.</p></div><p>We do not need to make any changes to the default character controller, but we do need to have one. </p><p>Next, let's make things easy on us and create some temporary containing walls for the beetles. You can simply add 3D cube game objects and, using the transform tools, orientate them so that they border the sandbox, or a part of the sandbox.  You can put your walls inside an empty game object called <code class="literal">Walls</code> and, in the <strong class="userinput"><code>Hierarchy</code></strong> panel, organize them inside the <code class="literal">Sandbox</code> game object. A representative example is shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781788830102/graphics/ca2ce203-f34e-4096-9ec8-52fef71ada09.png" /></div><p>Okay, now we are ready to start scripting our beetle's patrol. To get started, right-click the <strong class="userinput"><code>Assets</code></strong> | <strong class="userinput"><code>Custom Scripts</code></strong> folder in the <strong class="userinput"><code>Project</code></strong> panel. Select <strong class="userinput"><code>Create</code></strong> | <strong class="userinput"><code>C# Script</code></strong>, then name the script <code class="literal">BeetlePatrol</code>. This creates a C# script for us in our <code class="literal">Custom Scripts</code> folder. We will walk through this script from top to bottom in small chunks.</p><p>This first section of code simply imports <code class="literal">System.Collections</code>, <code class="literal">System.Collections.Generic</code>, and the <code class="literal">UnityEngine</code>. The section also has our <code class="literal">BeetlePatrol</code> class header:</p><pre class="programlisting">using System.Collections;
using System.Collections.Generic;
using UnityEngine;

publicclassBeetlePatrol:MonoBehaviour{</pre><p>Our variables are provided in the next section. The first variable, <code class="literal">isDie</code>, is a global variable the we will use to determine whether the Cucumber Beetle should stop patrolling. The remaining variables are local. Their use will be self-evident after reviewing subsequent code sections:</p><pre class="programlisting">// Variables
publicstaticboolisDie=false;

publicfloatspeed=5;
publicfloatdirectionChangeInterval=1;
publicfloatmaxHeadingChange=30;

AnimatorbeetleAnim;

CharacterControllercontroller;
floatheading;
Vector3targetRotation;
</pre><p>The next section of code is our <code class="literal">Start()</code> method, which only runs at the beginning of the game. This code sets the initial rotation for the beetle's patrol:</p><pre class="programlisting">voidStart(){

     controller=GetComponent&amp;lt;CharacterController&gt;();
beetleAnim=GetComponent&amp;lt;Animator&gt;();

//Setrandominitial rotation
heading=Random.Range(0,360);
transform.eulerAngles=newVector3(0,heading,0);

StartCoroutine(NewHeading());
}</pre><p>Our <code class="literal">Update()</code> method, shown in the following code, is our next section. This code will be executed once per game frame. Here, you can see that if condition <code class="literal">isDie</code> is <code class="literal">false</code> (or not <code class="literal">true</code>), then the code will be executed:</p><pre class="programlisting">voidUpdate(){

     if(!isDie){
transform.eulerAngles=Vector3.Slerp(transform.eulerAngles,targetRotation,
               Time.deltaTime*directionChangeInterval);
varforward=transform.TransformDirection(Vector3.forward);
controller.SimpleMove(forward*speed);
}

}</pre><p>This last section of code provides two methods. The <code class="literal">NewHeading()</code> and<strong class="userinput"><code> <code class="literal">NewHeadingRoutine()</code></code></strong> methods calculate a new direction for the beetle to move towards:</p><pre class="programlisting">IEnumeratorNewHeading() {

     while(true){
NewHeadingRoutine();
yieldreturnnewWaitForSeconds(directionChangeInterval);
}
}

voidNewHeadingRoutine() {

varfloor=transform.eulerAngles.y-maxHeadingChange;
varceil=transform.eulerAngles.y+maxHeadingChange;
heading=Random.Range(floor,ceil);
targetRotation=newVector3(0,heading,0);
}

} // this is the end of the Beetle Patrol class</pre><p>Save your script. Next, we need to associate it with the <code class="literal">Beetle</code> prefab. With the prefab selected, click the <strong class="userinput"><code>Add Component</code></strong> button in the <strong class="userinput"><code>Inspector</code></strong> panel. Then, select <strong class="userinput"><code>Scripts</code></strong> | <strong class="userinput"><code>Beetle Patrol</code></strong>. </p><p>You can drag multiple beetles into your scene and test the game. You should see them wandering around your sandbox, remaining confined by the walls you built. </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec78"></a>Beetle finds and eats cucumber</h3></div></div></div><p>Earlier in this chapter, we created a <code class="literal">BeetleNPC</code> script file and attached it to our <code class="literal">Beetle</code> prefab. That script detected collisions with the Cucumber Man. In this section, we will modify that script so that it can also detect when it collides with a cucumber.</p><p>Let's first ensure that the cucumbers <span>are</span><a id="id288614577" class="indexterm"></a> properly set up. Check that the is selected (checked) in the cucumber's <strong class="userinput"><code>Box Collider</code></strong> component in the <strong class="userinput"><code>Inspector</code></strong> panel. Next, make several copies of your cucumber throughout the sandbox area of your scene. You can place them in close proximity to your beetles for easier testing. See the following screenshot for an optimal test configuration:</p><div class="mediaobject"><img src="/graphics/9781788830102/graphics/656c978f-990c-4286-9d2c-189af8b0f6b7.png" /></div><p>The <code class="literal">BeetleNPC</code> script needs a new variable and two methods, one of which will be used as a coroutine. Let's get started with the new variable. As you can see in the following code snippet, we now have a second variable,<code class="literal">cucumberToDestroy</code>. We will use that to reference the cucumber that the beetle ate:</p><pre class="programlisting">Animatoranimator;
publicGameObjectcucumberToDestroy;</pre><p>Next, we will add an <code class="literal">OnTriggerEvent()</code> method that is similar to the <code class="literal">OnCollissionEnter</code> that we previously created in this chapter. As you can see, we are testing to see whether the beetle collided with a cucumber. When that is detected, we have four lines of code that are executed. The first line points the <code class="literal">cucumberToDestroy</code> variable to the specific cucumber the beetle collided with. The next line sets the <code class="literal">isEating</code> value to <code class="literal">true</code>. We will update the <code class="literal">BeetlePatrol</code> script to accommodate that change. The third statement plays the eating animation. The final statement calls the <code class="literal">DestroyCucumber</code> function, which we will look at next:</p><pre class="programlisting">voidOnTriggerEnter(CollidertheObject){
if(theObject.gameObject.CompareTag("Cucumber")){
cucumberToDestroy=theObject.gameObject;
BeetlePatrol.isEating=true;
animator.Play("EatingonGround");
StartCoroutine("DestroyCucumber");
}
}</pre><p>The last change to the <code class="literal">BeetleNPC</code> script is the <code class="literal">DestroyCucumber()</code> function. We are using this function to delay the destruction of the cucumber. This simulates the amount of time it takes for the beetle to eat the cucumber. You can change the parameter of <code class="literal">WaitForSecondsRealTime</code> to your liking. That parameter represents real-world seconds. Once the delay is over, the object is destroyed and the <code class="literal">isEating</code> variable is set to <code class="literal">false</code>:</p><pre class="programlisting">IEnumeratorDestroyCucumber(){

     yieldreturnnewWaitForSecondsRealtime(4);
Destroy(cucumberToDestroy.gameObject);
BeetlePatrol.isEating=false;
}</pre><p>We have two changes to make to our <code class="literal">BeetlePatrol</code> script. First, as you can see in the following code, we will add the new <code class="literal">isEating</code> variable:</p><pre class="programlisting">publicstaticboolisDie,isEating=false;</pre><p>Our final change to the <code class="literal">BeetlePatrol</code> script is to update the conditional statement, as shown in the following code. Now, we will stop the patrol if the beetle is dying or eating:</p><pre class="programlisting">voidUpdate(){

     if(!isDie&amp;&amp;!isEating){
transform.eulerAngles=Vector3.Slerp(transform.eulerAngles,targetRotation,
               Time.deltaTime*directionChangeInterval);
varforward=transform.TransformDirection(Vector3.forward);
controller.SimpleMove(forward*speed);
}
}</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec79"></a>Beetle attacks player on the ground</h3></div></div></div><p>Currently, when our Cucumber Man collides with a Cucumber Beetle, the <strong class="userinput"><code>Die</code></strong> animation is played, but no other behaviors <span>are</span><a id="id288614872" class="indexterm"></a> implemented. In this section, we will modify the necessary scripts for the following to occur each time the Cucumber Man collides with a Cucumber Beetle:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Beetle faces Cucumber Man</li><li style="list-style-type: disc">Beetle attacks Cucumber Man for specified time</li><li style="list-style-type: disc">Beetle's die animation plays</li><li style="list-style-type: disc">Beetle is removed from game</li></ul></div><p>We will use the following three lines of code inside our <code class="literal">OnCollisionEnter()</code> method to force the beetle to face the Cucumber Man when there is a collision. As you can see from the following code, we create a variable to make it easy to reference the Cucumber Man and then a second variable for the Cucumber Man's current <span>transform</span>. The third line of code tells the current Cucumber Beetle to face the Cucumber Man:</p><pre class="programlisting">varcm=GameObject.Find("CucumberMan");
vartf=cm.transform;
this.gameObject.transform.LookAt(tf);</pre><p>Now, we just need to edit the <code class="literal"><span>OnCollisionEnter</span></code> method to include two statements. The first statement plays the Attacking on Ground<strong class="userinput"><code> </code></strong>animation. The second statement makes a call to the function that will destroy the current Cucumber Beetle. Here are those two lines of code:</p><pre class="programlisting">animator.Play("AttackingonGround");
StartCoroutine("DestroySelf");</pre><p>The last change to the<code class="literal">BeetleNPC</code>script is the<code class="literal">DestroySelf()</code>function. We are using this function to simulate the battle and end of life for the current Cucumber Beetle. There are three statements inside the function. The first statement simulates the attack time. The second statement plays the <code class="literal">Die on Ground</code> animation. The final line destroys the game object, which is the current Cucumber Beetle:</p><pre class="programlisting">IEnumeratorDestroySelf(){

     yieldreturnnewWaitForSecondsRealtime(4);
animator.Play("DieonGround");
Destroy(this.gameObject,4);
}</pre><p>We have two changes to make to our <code class="literal">BeetlePatrol</code> script. First, as you can see in the following code, we will add the new <code class="literal">isAttacking</code> variable:</p><pre class="programlisting">publicstaticboolisDie,isEating,isAttacking=&lt;/span&gt;false;</pre><p>Our final change to the<code class="literal">BeetlePatrol</code>script is to update the conditional statement, as shown in the following code. Now, we will stop the patrol if the beetle is dying, eating, or attacking:</p><pre class="programlisting">voidUpdate(){

if(!isDie &amp;&amp;!isEating &amp;&amp;!isAttacking)){
transform.eulerAngles=Vector3.Slerp(transform.eulerAngles,
               targetRotation,Time.deltaTime*directionChangeInterval);
varforward=transform.TransformDirection(Vector3.forward);
controller.SimpleMove(forward*speed);
}
}</pre><p>We will make additional modifications to the scripts and behaviors in <a class="link" href="#" linkend="ch10">Chapter 10</a>, <span class="emphasis"><em>Scripting Our Points System</em></span>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec80"></a>Beetle stands to attack</h3></div></div></div><p>You will recall that the Cucumber Man <span>has</span><a id="id288604741" class="indexterm"></a> the ability to throw cherries at the Cucumber Beetles. This is a <span>ranged</span> attack, and if the Cucumber Beetle were to start walking or running on the ground toward the Cucumber Man to attack, it is likely the beetle would die before reaching the Cucumber Man.</p><p>So, if a beetle is hit by a cherry, we want the following to occur:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Beetle faces Cucumber Man</li><li style="list-style-type: disc">Beetle stands</li><li style="list-style-type: disc">Beetle runs, while standing, towards the Cucumber Man</li><li style="list-style-type: disc">Beetle attacks Cucumber Man while standing</li></ul></div><p>You can review the animations if you need a refresher on what they look like. </p><p>We will make some significant changes to our <code class="literal">BeetleNPC</code> script. The updated script is presented in the following code in its entirety, divided by sequential sections with explanations.</p><p>This section shows the imports and class-level variables. You will notice that the last three variables (<code class="literal">cherryHit</code>, <code class="literal">smoothTime</code>, and <code class="literal">smoothVelocity</code>) are new. We will use <code class="literal">cherryHit</code> to keep track of the sequence leading up to the beetle's death. The remaining two variables will be used to control how fast and smooth the beetle travels to the Cucumber Man:</p><pre class="programlisting">using System.Collections;
using System.Collections.Generic;
using UnityEngine;

publicclassBeetleNPC:MonoBehaviour{

Animatoranimator;
publicGameObjectcucumberToDestroy;
publicboolcherryHit=false;
publicfloatsmoothTime=3.0f;
publicVector3smoothVelocity=Vector3.zero;</pre><p>No change was made to the <code class="literal">Start()</code> method:</p><pre class="programlisting">voidStart(){
animator=GetComponent&amp;lt;Animator&gt;();
}</pre><p>We are now using the <code class="literal">Update()</code> method for the first time. This is necessary so that every frame in which the beetle can travel toward the Cucumber Man <span>is shown</span>. You can also see that we are using the <code class="literal">cherryHit</code> variable in our conditional statement:</p><pre class="programlisting">voidUpdate(){
if(cherryHit){
varcm=GameObject.Find("CucumberMan");
vartf=cm.transform;
this.gameObject.transform.LookAt(tf);

animator.Play("StandingRun");

transform.position=Vector3.SmoothDamp(transform.position,tf.position,
refsmoothVelocity,smoothTime);
}
}
</pre><p>The next section of our script is the <code class="literal">OnCollisionEnter()</code> method. We moved the statements we previously had in this method so that they are encapsulated in an <code class="literal">if</code> statement. If the <code class="literal">cheeryHit</code> is <code class="literal">false</code>, then the original code will be executed, otherwise the two lines of code after the <code class="literal">else</code> statement will be executed. We see there that we caused two animations to play:</p><pre class="programlisting">
voidOnCollisionEnter(Collisioncol) {
if(col.gameObject.CompareTag("Player")){

if(!cherryHit){
BeetlePatrol.isAttacking=true;

varcm=GameObject.Find("CucumberMan");
vartf=cm.transform;
this.gameObject.transform.LookAt(tf);

animator.Play("AttackingonGround");
StartCoroutine("DestroySelfOnGround");
}else{
animator.Play("StandingAttack");
StartCoroutine("DestroySelfStanding");
}
}
}</pre><p>The next section of code is the <code class="literal">OnTriggerEnter()</code> method that we previously created for handling collisions with cucumbers.  As you can see from the following code, we added an <code class="literal">else if</code> statement to check whether we collided with a <code class="literal">gameObject</code> with a tag of <code class="literal">Cherry</code>. When that condition is <code class="literal">true</code>, we set the <code class="literal">isAttacking</code> Boolean variable to <code class="literal">true</code> so that the forward motion driven by the <code class="literal">BeetlePatrol</code> script will stop. We also set the <code class="literal">cherryHit</code> value to <code class="literal">true</code> and play the animation that shows the beetle standing:</p><pre class="programlisting">voidOnTriggerEnter(CollidertheObject){
if(theObject.gameObject.CompareTag("Cucumber")){

cucumberToDestroy=theObject.gameObject;
BeetlePatrol.isEating=true;
animator.Play("EatingonGround");
StartCoroutine("DestroyCucumber");
}elseif(theObject.gameObject.CompareTag("Cherry")){
BeetlePatrol.isAttacking=true;
cherryHit=true;
animator.Play("Stand");
}
}</pre><p>The last section of our <code class="literal">BeetleNPC</code> script contains three <code class="literal">Destroy</code>-related functions. You are already familiar with <code class="literal">DestroyCucumber()</code>. We renamed the <code class="literal">DestroySelf()</code> function as <code class="literal">DestroySelfOnGround()</code> and added the new <code class="literal">DestroySelfStanding()</code>:</p><pre class="programlisting">IEnumeratorDestroyCucumber(){
yieldreturnnewWaitForSecondsRealtime(4);
Destroy(cucumberToDestroy.gameObject);
BeetlePatrol.isEating=false;
}

IEnumeratorDestroySelfOnGround(){

yieldreturnnewWaitForSecondsRealtime(4);
animator.Play("DieonGround");
Destroy(this.gameObject,4);
}

IEnumeratorDestroySelfStanding(){

yieldreturnnewWaitForSecondsRealtime(4);
animator.Play("DieStanding");
</pre><pre class="programlisting">Destroy(this.gameObject,4);
cherryHit=false;
}

} // End of BeetleNPC.cs</pre><p>In order to test this functionality, we will need to have some cherries in our scene. Start by downloading the <code class="literal">Cherries.unitypackage</code> asset package from the publisher's site. This package includes a <code class="literal">Cherry.prefab</code> file that is already set up to work in our game. It has a <code class="literal">Cherry</code> tag and a <code class="literal">Box Collider</code> with <code class="literal">Is Trigger</code> checked.</p><p>In <a class="link" href="#" linkend="ch10">Chapter 10</a>, <span class="emphasis"><em>Scripting Our Points System</em></span>, we will add the ability for the Cucumber Man to throw cherries. For now, let's place a bunch of them in our sandbox for testing. One approach, as illustrated in the following screenshot, is to surround a beetle with cherries. This will make our testing easier and faster:</p><div class="mediaobject"><img src="/graphics/9781788830102/graphics/24a23d76-3e87-4221-b6e2-2b02318c750e.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip38"></a>Note</h3><p>This is a good time to save your scene and your project.</p></div></div></div>