<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec60"></a>The elemental switch charging process</h2></div></div><hr /></div><p>The <code class="literal">PowerSource</code> component already has the required code to switch from one element to another. Let's link UI elements to it in order to give feedback to the player. We'll first add a progress slider to indicate how long the elemental switch process takes.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec117"></a>The progress prefab</h3></div></div></div><p>Let's create the <code class="literal">Progress</code> prefab, <a id="id735" class="indexterm"></a>which will<a id="id736" class="indexterm"></a> be a slider to indicate any kind of progress in the game—in this case, the elemental switch's duration, which will look like this:</p><div class="mediaobject"><img src="/graphics/9781783552979/graphics/2979OT_06_05.jpg" /></div><p>Follow these steps to create our <code class="literal">Progress</code> prefab:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>In the <span class="strong"><strong>Project</strong></span> view, enter <code class="literal">progress</code> in the search field.</p></li><li><p>Drag <code class="literal">Control - Simple Progress Bar</code> into our <code class="literal">InGame2DUI</code>.</p></li><li><p>Rename this new instance to <code class="literal">Progress</code>.</p></li><li><p>For its attached <code class="literal">UISprite</code> component:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Change <span class="strong"><strong>Size</strong></span> to <code class="literal">400 x 35</code>
</p></li><li style="list-style-type: disc"><p>Set its <span class="strong"><strong>Color Tint</strong></span> to {R:<code class="literal">180</code>, G: <code class="literal">180</code>, B: <code class="literal">180</code>, A: <code class="literal">220</code>}</p></li></ul></div></li><li><p>For its <a id="id737" class="indexterm"></a>attached <span class="strong"><strong>UISlider</strong></span> component:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Set <span class="strong"><strong>Value</strong></span> to <code class="literal">0</code>
</p></li></ul></div></li><li><p>Select its <code class="literal">Foreground</code> child GameObject, and for its <span class="strong"><strong>UISprite</strong></span>:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Set <span class="strong"><strong>Color Tint</strong></span> to {R: <code class="literal">255</code>, G: <code class="literal">230</code>, B: <code class="literal">200</code>, A: <code class="literal">255</code>}</p></li></ul></div></li><li><p>Select<a id="id738" class="indexterm"></a> its <code class="literal">Thumb</code> child GameObject and delete it.</p></li><li><p>Drag it into our <code class="literal">Assets/Resources/Prefabs</code> folder to make it a prefab.</p></li><li><p>The prefab is ready; delete our <code class="literal">InGame2DUI</code> | <code class="literal">Progress</code> from the scene.</p></li></ol></div><p>OK, now that we have our <code class="literal">Progress</code> prefab ready, let's implement it through code.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec118"></a>Progress slider implementation</h3></div></div></div><p>We will use the <code class="literal">PowerSource</code> component to make sure the progress slider is updated with the current <code class="literal">energy</code> value of the power source. The <code class="literal">energy</code> is a <code class="literal">float</code> between 0 and 1, which will be perfect<a id="id739" class="indexterm"></a> for our slider:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select the <code class="literal">PowerSources</code> | <code class="literal">Source1</code> GameObject.</p></li><li><p>Right-click and select <span class="strong"><strong>Edit Script</strong></span> on its attached <code class="literal">PowerSource</code> component's name.</p></li></ol></div><p>Within our <code class="literal">PowerSource.cs</code> script, we already have a <code class="literal">SwitchElement()</code> method that starts the <code class="literal">SwitchElementRoutine()</code> coroutine. This coroutine currently has only the <code class="literal">yield return null</code> instruction, doing nothing.</p><p>Let's replace this coroutine's single line with the following code to make sure the energy increases at each frame, updating the slider at the same time:</p><div class="informalexample"><pre class="programlisting">//Hide elemental switch menu
<span class="strong"><strong>GameManager.Instance.ShowElementalSwitch(null);</strong></span>
// Set the energy to zero
<span class="strong"><strong>energy = 0;</strong></span>
// Make it unavailable while it's charging
<span class="strong"><strong>available = false;</strong></span>
// Make it non-draggable while charging
<span class="strong"><strong>dragObject.enabled = false;</strong></span>
// Disable associated light
<span class="strong"><strong>light.enabled = false;</strong></span>
// Create the new slider
<span class="strong"><strong>CreateProgressSlider();</strong></span>
// At each frame, while energy is not full
<span class="strong"><strong>while (energy &lt; 1)</strong></span>
{
  // Add a little energy
<span class="strong"><strong>  energy += (Time.deltaTime / switchDuration);</strong></span>
  // Update associated progress slider
<span class="strong"><strong>  progressSlider.value = energy;</strong></span>
  // Wait until next frame
<span class="strong"><strong>  yield return null;</strong></span>
}
// When finished charging, make sure it's set to 1
<span class="strong"><strong>energy = 1;</strong></span>
// Set the power source type to the new one
<span class="strong"><strong>SetNewElement(newElement);</strong></span>
// Make it available again
<span class="strong"><strong>available = true;</strong></span>
// Make it draggable again
<span class="strong"><strong>dragObject.enabled = true;</strong></span>
// Re-enable the light
<span class="strong"><strong>light.enabled = true;</strong></span>
// Destroy the slider
<span class="strong"><strong>Destroy (progressSlider.gameObject);</strong></span>
</pre></div><p>OK. You can see that we call the method <code class="literal">CreateProgressSlider()</code>. Let's add it to the same file to add the <a id="id740" class="indexterm"></a>progress bar instantiation:</p><div class="informalexample"><pre class="programlisting">// Method to create the progress slider
<span class="strong"><strong>private void CreateProgressSlider()</strong></span>
{
  // Instantiate the new progress slider
  GameObject progressObject;
<span class="strong"><strong>  progressObject =  NGUITools.AddChild(uiRoot2D, </strong></span>
<span class="strong"><strong>       Resources.Load("Prefabs/Progress") as GameObject);</strong></span>
  // Retrieve its attached UISlider component
<span class="strong"><strong>  progressSlider = progressObject.GetComponent&lt;UISlider&gt;();</strong></span>
  // Add a FollowObject to the slider
<span class="strong"><strong>  progressSlider.gameObject.AddComponent(typeof(FollowObject));</strong></span>
  // Retrieve and store it                        
<span class="strong"><strong>  FollowObject sliderFollowObject =</strong></span>
<span class="strong"><strong>    progressSlider.GetComponent&lt;FollowObject&gt;();</strong></span>
  // Configure it to follow this power source
  sliderFollowObject.target = transform;
  sliderFollowObject.mainCamera = 
      GameObject.Find("GameCamera").camera;
  sliderFollowObject.uiCamera = 
    NGUITools.FindCameraForLayer(9);
  sliderFollowObject.offset = new Vector3(0,0.25f,0);
}</pre></div><p>OK, great. Everything is ready. Now, we need to link our elemental switch buttons to our power sources so<a id="id741" class="indexterm"></a> that they request the element changes.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec119"></a>Linking elemental buttons</h3></div></div></div><p>When an elemental<a id="id742" class="indexterm"></a> switch button is clicked in our UI, we would like the current power source—the one with the elemental switch <a id="id743" class="indexterm"></a>menu displayed above it—to start changing its current element. We can use our <code class="literal">GameManager</code> component for this.</p><p>Open our <code class="literal">GameManger.cs</code> script, and add this variable declaration:</p><div class="informalexample"><pre class="programlisting">// Current power source with elemental switch UI
<span class="strong"><strong>public PowerSource currentPowerSource;</strong></span>
</pre></div><p>OK, now, let's add the four simple methods that will be called upon clicking on their respective elemental switch buttons:</p><div class="informalexample"><pre class="programlisting">// Execute when Fire button is pressed
<span class="strong"><strong>public void FirePressed()</strong></span>
{
  // Request the power source to switch element;
<span class="strong"><strong>  currentPowerSource.SwitchElement(Elements.Type.Fire);</strong></span>
}

// Execute when Ice button is pressed
<span class="strong"><strong>public void IcePressed()</strong></span>
{
  // Request the power source to switch element;
<span class="strong"><strong>  currentPowerSource.SwitchElement(Elements.Type.Ice);</strong></span>
}

// Execute when Lightning button is pressed
<span class="strong"><strong>public void LightningPressed()</strong></span>
{
  // Request the power source to switch element;
<span class="strong"><strong>  currentPowerSource.SwitchElement(Elements.Type.Lightning);</strong></span>
}

// Execute when Water button is pressed
<span class="strong"><strong>public void WaterPressed()</strong></span>
{
  // Request the power source to switch element;
<span class="strong"><strong>  currentPowerSource.SwitchElement(Elements.Type.Water);</strong></span>
}</pre></div><p>Good. Let's just add the final line of code that will set the <code class="literal">currentPowerSource</code> variable to the power source on which the elemental switch UI is displayed.</p><p>Add this instruction as the first line in the <code class="literal">if(targetObject != null)</code> condition of the <code class="literal">ShowElementalSwitch()</code> method:</p><div class="informalexample"><pre class="programlisting">// Set the elements switch's current power source
<span class="strong"><strong>currentPowerSource = targetObject.GetComponent&lt;PowerSource&gt;();</strong></span>
</pre></div><p>Great. Save all code<a id="id744" class="indexterm"></a> files, and return to Unity. Now, we simply have to assign our four buttons to their respective methods:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select our <code class="literal">InGame2DUI</code> | <code class="literal">ElementSwitch</code> | <code class="literal">Fire</code> GameObject.</p></li><li><p>For its attached <code class="literal">UIButton</code> component:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Drag <code class="literal">GameManager</code> into the <span class="strong"><strong>Notify</strong></span> field of <span class="strong"><strong>On Click</strong></span>.</p></li><li style="list-style-type: disc"><p>Set <span class="strong"><strong>Method</strong></span> to <span class="strong"><strong>GameManager</strong></span> | <span class="strong"><strong>FirePressed</strong></span>.</p></li></ul></div></li></ol></div><p>Repeat the preceding steps for each of the other three elemental buttons. And that's it! By clicking on elemental buttons, our power sources change themselves after the charging duration, indicated by the progress bar.</p><p>During the charging process, the power source is no longer draggable, and the elemental switch UI won't appear. The existing code handles the light's color and mesh material to correspond to the new<a id="id745" class="indexterm"></a> element.</p><p>Now, let's see how we can make a button unavailable through code to correct an issue.</p></div></div>