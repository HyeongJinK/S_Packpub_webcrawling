<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec65"></a>Language Integrated Query</h2></div></div><hr /></div><p>Obviously, games<a id="id496" class="indexterm"></a> work with lots of data. They work with not just strings but also with objects, databases, tables, documents, and plenty more, too many to list here. However, despite the extensiveness and variety of data, there's always a common need to filter it, viewing smaller subsets of it as is relevant to our needs at the time. For example, given a complete array (or enumerated list) of all wizard objects in the scene, we might want to restrict the results even further, viewing only wizards whose health is less than 50 percent<a id="id497" class="indexterm"></a> and whose defense points are less than 5. The purpose is, perhaps, to initiate a mass flee behavior on the wizards to find a nearby potion and restore their health before resuming an attack on the player. Let's now consider the implementation of this scenario and how a technology, Linq, can help us.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip45"></a>Tip</h3><p>A complete Linq sample project can be found in the book's companion files (code bundle) at <code class="literal">Chapter06\Linq\</code>.</p></div><p>First, a very basic and sample definition of a wizard enemy class can be given, as shown in the following code sample 6-21. This class includes both the <code class="literal">Health</code> and <code class="literal">Defense</code> member variables that are critical to our behavior logic:</p><div class="informalexample"><pre class="programlisting"> //-------------------------------------------
 using UnityEngine;
 using System.Collections;
 //-------------------------------------------
 public class Enemy : MonoBehaviour 
 {
    public int Health = 100;
    public int Mana = 20;
   public int Attack = 5; 
    public int Defense = 10;
 }
 //-------------------------------------------</pre></div><p>Now, given a collection of all enemy objects in the scene, we could filter the data into a smaller array according to our criteria with the code, as shown in the following code sample 6-22.</p><p>This code effectively loops through all members, runs them through a conditional <code class="literal">if</code> statement, and then, finally adds the enemy to a results array if it passes the condition. The condition, in this case, is whether an enemy's health is less than 50 percent and their defense is less than 5:</p><div class="informalexample"><pre class="programlisting"> //Get list of enemies matching search criteria
 public void FindEnemiesOldWay()
 {
    //Get all enemies in scene
    Enemy[] Enemies = Object.FindObjectsOfType&lt;Enemy&gt;();
 
    //Filtered Enemies
    List&lt;Enemy&gt; FilteredData = new List&lt;Enemy&gt;();
 
    //Loop through enemies and check
<span class="strong"><strong>    foreach(Enemy E in Enemies)</strong></span>
    {
<span class="strong"><strong>         if(E.Health &lt;= 50 &amp;&amp; E.Defense &lt; 5)</strong></span>
         {
               //Found appropriate enemy
               <span class="strong"><strong>FilteredData.Add (E);</strong></span>
         }
    }
 
    //Now we can process filtered data
    //All items in FilteredData match search criteria
    foreach(Enemy E in FilteredData)
    {
         //Process Enemy E
         Debug.Log (E.name);
    }
 }</pre></div><p>This code works insofar as it restricts a larger data set into a smaller one on the basis of a specific criterion. However, Linq lets us <a id="id498" class="indexterm"></a>achieve the same results with less code and often greater performance. Linq is a high-level and specialized language to run queries on data sets, including arrays and objects, as well as on databases and XML documents. The queries are translated automatically by Linq, under the hood, into an appropriate language for the data set used (for example, SQL for databases). The aim is to extract the results we need into a regular array.</p><p>The following code sample 6-23 demonstrates an alternative approach to the preceding code sample 6-22 using Linq:</p><div class="informalexample"><pre class="programlisting">01 using UnityEngine;
02 using System.Collections;
<span class="strong"><strong>03 using System.Collections.Generic;</strong></span>
<span class="strong"><strong>04 using System.Linq;</strong></span>
05 //-------------------------------------------------
06 public void FindEnemiesLinqWay()
07 {
08 //Get all enemies in scene
09 Enemy[] Enemies = Object.FindObjectsOfType&lt;Enemy&gt;();
10 
11 //Perform search
<span class="strong"><strong>12 Enemy[] FilteredData = (from EnemyChar in Enemies</strong></span>
<span class="strong"><strong>13         where EnemyChar.Health &lt;= 50 &amp;&amp; EnemyChar.Defense &lt; 5</strong></span>
<span class="strong"><strong>14         select EnemyChar).ToArray();</strong></span>
15 
16 //Now we can process filtered data
17 //All items in FilteredData match search criteria
18 foreach(Enemy E in FilteredData)
19 {
20       //Process Enemy E
21       Debug.Log (E.name);
22 }
23 }
24 //-------------------------------------------------</pre></div><p>The following are the<a id="id499" class="indexterm"></a> comments for code sample 6-23:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="strong"><strong>Lines 03-04</strong></span>: To use Linq, you must include the <code class="literal">System.Collections.Linq</code> namespace, and to use <code class="literal">List</code> objects, you must include the <code class="literal">System.Collections.Generic</code> namespace.</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Lines 12-14</strong></span>: The main body of Linq code occurs here. It consists of three main parts. First, we indicated the items to pick from the source data, specifically, enemy objects from the data set <code class="literal">Enemies</code>. Second, we defined the criteria to search for, specifically where <code class="literal">EnemyChar.Health &lt;= 50 &amp;&amp; EnemyChar.Defense &lt; 5</code>. Then, when the criterion is met, we selected that object to add to the results; we selected <code class="literal">EnemyChar</code>. Finally, we converted the results to an array with the <code class="literal">ToArray</code> function.</p></li></ul></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip46"></a>Tip</h3><p>More information on Linq can be<a id="id500" class="indexterm"></a> found online in MSDN at <a class="ulink" href="http://msdn.microsoft.com/en-gb/library/bb397926.aspx" target="_blank">http://msdn.microsoft.com/en-gb/library/bb397926.aspx</a>.</p></div></div>