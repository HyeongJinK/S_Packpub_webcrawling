<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec81"></a>Creating the Seek-Health (or flee) state</h2></div></div><hr /></div><p>The <code class="literal">Seek-Health</code> state occurs when the enemy runs low on health and can restore it by collecting a medikit. This state is unlike most others, in that, it can be reached or entered from any state. The<a id="id593" class="indexterm"></a> entering of this state doesn't depend on its relationship to others, but only on the player's health. Specifically, this state should be entered when the enemy's health is reduced beyond a minimum floor. As a result of this configuration, be sure to hook up the <code class="literal">Seek-Health</code> animation state in the Mecanim graph to the <span class="strong"><strong>Any State</strong></span> node that allows the run animation to be triggered in any state, as shown here:</p><div class="mediaobject"><img src="/graphics/9781784390655/graphics/0655OT_07_24.jpg" /><div class="caption"><p>The Seek-Health state can be accessed from Any State</p></div></div><p>Each enemy maintains a <code class="literal">Health</code> variable; this variable is adjusted either up or down, depending on whether<a id="id594" class="indexterm"></a> the enemy finds a medikit or is attacked. The change occurs inside the <a id="id595" class="indexterm"></a>method <code class="literal">ChangeHealth</code>, and this is where we can determine whether a <code class="literal">SeekHealth</code> state must be initiated. The <code class="literal">ChangeHealth</code> function<a id="id596" class="indexterm"></a> is public; it allows <code class="literal">SendMessage</code> and <code class="literal">BroadcastMessage</code> to trigger it as an event, if required, as shown in the following code sample 7-11:</p><div class="informalexample"><pre class="programlisting">//Event called health changed
 public void ChangeHealth(float Amount)
 {
    //Reduce health
    Health += Amount;
 
    //Should we die?
    if(Health &lt;= 0)
    {
          StopAllCoroutines();
          Destroy(gameObject);
          return;
    }
 
    //Check health danger level
    if(Health &gt; HealthDangerLevel) return;
 
    //Health is less than or equal to danger level, now seek health restores, if available
    StopAllCoroutines();
<span class="strong"><strong>    StartCoroutine(State_SeekHealth());</strong></span>
 }</pre></div><p>The <code class="literal">State_SeekHealth</code> method can be coded, as shown in the following code sample 7-12:</p><div class="informalexample"><pre class="programlisting">01 //This coroutine runs when object is in seek health state
02 public IEnumerator State_SeekHealth()
03 {
04 //Set current state
05 CurrentState = AI_ENEMY_STATE.SEEKHEALTH;
06 
07 //Set Chase State
08 ThisAnimator.SetTrigger((int) AI_ENEMY_STATE.SEEKHEALTH);
09 
10 //This is the nearest health restore
11 HealthRestore HR = null;
12 
13 //Loop forever while in seek health state
14 while(CurrentState == AI_ENEMY_STATE.SEEKHEALTH)
15 {
16        //If health restore is not valid, then get nearest
17        <span class="strong"><strong>if(HR == null) HR = GetNearestHealthRestore(ThisTransform);</strong></span>
18 
19        //There is an active health restore, so move there
20        ThisAgent.SetDestination(HR.transform.position);
21 
22        //If HR is null, then no more health restore, go to idle
23        if(HR == null || Health &gt; HealthDangerLevel)
24        {
25              //Change to idle
26              StartCoroutine(State_Idle());
27              yield break;
28 	      }
29 
30       //Wait until next frame
31       yield return null;
32 }
33 }</pre></div><p>The following are the comments for code sample 7-12:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="strong"><strong>Line 17</strong></span>: The <code class="literal">Health-Seek</code> state begins by finding the nearest medikit in the scene and uses it for<a id="id597" class="indexterm"></a> the agent destination. This is, in a sense, cheating, because (of course) without remote viewing powers, the enemy should not be able to know where the nearest medikit is. However, remember that what matters is not what the enemy really knows but how it appears to the gamer. If the gamer doesn't know about this logic and cannot learn about it from appearances, then it would be of no significance. Also note that it's possible for the player or another enemy to collect the medikit before the enemy arrives at the destination. For this reason, on each frame, the enemy must determine whether the destination medikit is still valid, and if not, they must pick the next, nearest one.</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Line 23</strong></span>: If there is no medikit available or the health has been restored to safe limits, the<a id="id598" class="indexterm"></a> enemy would return to the <code class="literal">Idle</code> state.</p></li></ul></div><p>The <code class="literal">SeekHealth</code> state demands that we find and retrieve a reference to the nearest medikit in the scene. This is achieved using a <a id="id599" class="indexterm"></a>
<code class="literal">GetNearestHealthRestore</code> method, as shown in the following code sample 7-13:</p><div class="informalexample"><pre class="programlisting">01 //Function to get nearest health restore to Target in scene
02 private HealthRestore GetNearestHealthRestore(Transform Target)
03 {
04 //Get all health restores
05 HealthRestore[] Restores = Object.FindObjectsOfType&lt;HealthRestore&gt;();

06 
07 //Nearest
08 float DistanceToNearest = Mathf.Infinity;
09 
10 //Selected Health Restore
11 HealthRestore Nearest = null;
12 
13 //Loop through all health restores
14 foreach(HealthRestore HR in Restores)
15 {
16        //Get distance to this health restore
17 float CurrentDistance = Vector3.Distance(Target.position, HR.transform.position);

18 
19        //Found nearer health restore, so update
20        if(CurrentDistance &lt;= DistanceToNearest)
21        {
22              Nearest = HR;
23              DistanceToNearest = CurrentDistance;
24        }
25 }
26 
27 //Return nearest or null
28 return Nearest;
29 }</pre></div></div>