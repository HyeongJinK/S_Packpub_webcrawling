<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec53"></a>Developing an NPC Animator Controller</h2></div></div><hr /></div><p>The FSM must be complemented by a Mecanim animator graph, as each state involves a unique animation and each one should play at the appropriate time. You create a new animator asset simply by right-clicking inside the <strong class="userinput"><code>Project</code></strong><span>panel</span> and choosing <span><strong class="userinput"><code>Create</code></strong></span> | <span><strong class="userinput"><code>Animator Controller</code></strong></span> from the context menu; name this <code class="literal">controllerEnemy</code>.</p><p>Ensure that you add this as an <strong class="userinput"><code>Animator</code></strong> component to the zombie in the scene by dragging and dropping the asset from the <strong class="userinput"><code>Project</code></strong> panel to the mesh in the <strong class="userinput"><code>Scene</code></strong><span>Viewport</span>:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/0401c176-27d9-4e0b-a25e-0cade89a209e.png" /></div><p>Creating a new Animator Controller for the zombie NPC</p><p>First, create a new animator integer parameter and name it <code class="literal">AnimState</code>. This parameter represents the currently active state of the zombie in the graph. Its values will exactly match the value of the <code class="literal">AIState</code> enum, coded for the <code class="literal">AIEnemy</code> class: <code class="literal">0</code> = <code class="literal">Idle</code>, <code class="literal">1</code> = <code class="literal">Chase</code>, <code class="literal">2</code> = <code class="literal">Attack</code>, and <code class="literal">3</code> = <code class="literal">Dead</code>:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/8531b249-fc0e-4724-b71d-984350809cea.png" /></div><p>Creating a new Animator Controller for the zombie NPC</p><p>Now for the starting state, create a new Empty state by right-clicking in the graph and navigating to <span><strong class="userinput"><code>Create</code></strong></span> |<span> <strong class="userinput"><code>Empty</code></strong></span> from the context menu. Name <span>the</span> state <code class="literal"><span>Start</span></code>, and make it the default state (if it's not already) by right-clicking on the state and choosing <span><strong class="userinput"><code>Set as Layer Default State</code></strong></span> from the context menu. This ensures that the zombie <span class="emphasis"><em>does nothing</em></span> when the level begins, until we explicitly force it into a state:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/55e39008-cc1b-4b78-9276-50700a615dc8.png" /></div><p>Creating the zombie Start state</p><p>Now, drag and drop each state-animation clip from the <strong class="userinput"><code>Project</code></strong> panel into the animator graph to create a new animation node for each state: one each for Idle, Chase, Attack, and Death. These animations are included in the book's companion files:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/6a458a6b-cc0a-4800-a4b1-cbf46260a4ae.png" /></div><p>Adding zombie Animation-States to the graph</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note38"></a>Note</h3><p>Remember that the animator graph features three default nodes: <span><strong class="userinput"><code>Entry</code></strong>, <strong class="userinput"><code>Any State</code></strong></span>, and <span><strong class="userinput"><code>Exit</code></strong></span>. These nodes are autocreated with the animator graph. The <span><strong class="userinput"><code>Entry</code></strong></span> node is invoked when the animator graph (state machine) begins, and any connected nodes are initiated too. The <span><strong class="userinput"><code>Any State</code></strong></span> node effectively links to all other nodes and initiates those whenever the transition conditions (connections) are satisfied. The <span><strong class="userinput"><code>Exit</code></strong></span> node is initiated on leaving any substate machine (this node is useful for creating nested animator graphs). For more information on these states and transitions, refer to the online Unity documentation at: <a class="ulink" href="https://docs.unity3d.com/Manual/StateMachineTransitions.html" target="_blank"><span>https://docs.unity3d.com/Manual/StateMachineTransitions.html</span></a>.</p></div><p>Once the states have been added to <span>the</span> graph, they must be wired together logically and consistently using the state machine code. Specifically, the zombie <span>may</span> transition from <span><strong class="userinput"><code>Idle</code></strong></span> to <span><strong class="userinput"><code>Chase</code></strong></span>, from <span><strong class="userinput"><code>Chase</code></strong></span> to <span><strong class="userinput"><code>Attack</code></strong></span>, back from <span><strong class="userinput"><code>Attack</code></strong></span> to <strong class="userinput"><code><span>Chase</span></code></strong>, and from <span><strong class="userinput"><code>Chase</code></strong></span> to <span><strong class="userinput"><code>Idle</code></strong></span>. The <strong class="userinput"><code><span>Death</span></code></strong> state may, potentially, be invoked from anywhere. First, let's wire the connection from <span><strong class="userinput"><code>Start</code></strong></span> to <strong class="userinput"><code><span>Idle</span></code></strong>, which happens when the <span><strong class="userinput"><code>AnimState</code></strong></span> parameter is equal to <code class="literal">0</code>:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/c6cd5b84-4d02-4767-a205-736887f69694.png" /></div><p>Setting the Idle state from the Start node</p><p>The <span>Idle</span> state simply plays a standing animation. However, it doesn't last long enough in itself and doesn't loop as well as I want. We can easily fix this type of looping problem directly from the <span><strong class="userinput"><code>Animator</code></strong></span>, without changing any frames in the animation. We can do this simply by playing the animation forward once and then playing it again backward, looping back and forth with a ping-pong effect. Select the <span>Idle</span> node in the graph and then duplicate it, and set the <span><strong class="userinput"><code>Speed</code></strong></span> to <code class="literal">-1</code> to play backward. Now the two duplicates can be wired together to play continuously:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/09109cbf-de6b-494f-a7c0-09b8290c2998.png" /></div><p>Looping an Idle through a ping-pong sequence</p><p>The <strong class="userinput"><code>Idle</code></strong> state (whether it's playing forward or backward) may transition to the <strong class="userinput"><code>Chase</code></strong> state (usually when the player's character appears). Conversely, the <strong class="userinput"><code>Chase</code></strong> state may transition back to the <span><strong class="userinput"><code>Idle</code></strong></span> state. This can be configured in the graph with transitions that depend on the <span><strong class="userinput"><code>AnimState</code></strong></span> field being equal to <code class="literal">1</code> (for <span><strong class="userinput"><code>Chase</code></strong></span>) and <code class="literal">0</code> (for <span><strong class="userinput"><code>Idle</code></strong></span>). Ensure that you uncheck the <span><strong class="userinput"><code>Has Exit Time</code></strong></span> checkbox for each transition, as these force the state to change immediately from one to another, as opposed to waiting for the animation to complete before changing:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/2bd49909-e744-49d7-9788-4d8ca76ead04.png" /></div><p>Creating connections between Idle and Chase</p><p>The <strong class="userinput"><code><span>Chase</span></code></strong> state can also <span>change</span> to the <strong class="userinput"><code>Attack</code></strong> state, and the <span><strong class="userinput"><code>Attack</code></strong></span> state can change to the <strong class="userinput"><code><span>Chase</span></code></strong> state. Again, the change depends on the <strong class="userinput"><code><span>AnimState</span></code></strong> parameter:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/568eb69b-5cd8-4b1f-a14a-5c7e329266f0.png" /></div><p>Creating a transition between Chase and Attack</p><p><span><strong class="userinput"><code>Any State</code></strong></span> should have a connection to <strong class="userinput"><code><span>Death</span></code></strong>. This makes sense because the enemy AI can be in <strong class="userinput"><code>Idle</code></strong>, <strong class="userinput"><code>Chase</code></strong>, or <strong class="userinput"><code>Attack</code></strong> and, effectively, be killed. Create a transition from <span><strong class="userinput"><code>Any State</code></strong></span> to <span><strong class="userinput"><code>Death</code></strong></span>, based on the <code class="literal">AnimState</code> parameter being equal to <code class="literal">3</code>:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/82f62578-2c95-4aa0-a849-71fa7cf1f5cb.png" /></div><p>Building the Death state in the animator graph</p><p>The animator graph is now fully configured to <span>support</span> the FSM for the zombie character. <span>Save</span> the animator asset and associate it to an <span><strong class="userinput"><code>Animator</code></strong></span> component for the zombie, if you've not already done so. The next step is to return to the <code class="literal">AIEnemy</code> script to code the remaining AI for the zombie:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/64addf10-5311-470d-9b24-214e63a80f5d.png" /></div><p>Configuring the zombie animator</p></div>