<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec56"></a>Developing the Attack state and more</h2></div></div><hr /></div><p>The Attack state is entered when the zombie <span>arrives</span> within the attack distance to the player. During this state, the zombie repeatedly attacks the player until either the player dies or the player leaves the attack distance:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/3ef0d312-1e3c-4263-819f-7bfda1b60a79.png" /></div><p>Attack state</p><p>Consider the following code:</p><pre class="programlisting">    //------------------------------------ 
    public IEnumerator StateAttack() 
    { 
        //Run attack animation 
        ThisAnimator.SetInteger("AnimState", (int) ActiveState); 
        //While in idle state 
        while(ActiveState == AISTATE.ATTACK) 
        { 
            //Look at player 
            Vector3 PlanarPosition = new Vector3(PlayerTransform.position.x, ThisTransform.position.y, PlayerTransform.position.z); 
            ThisTransform.LookAt(PlanarPosition, ThisTransform.up); 
            //Get distance between enemy and player 
            float Distance = Vector3.Distance(PlayerTransform.position, ThisTransform.position); 
            if (Distance &gt; ThisAgent.stoppingDistance*2f) 
            { 
                ThisAgent.Stop (); 
                yield return null; 
                ActiveState = AISTATE.CHASE; 
                yield break; 
            } 
            yield return null; 
        } 
    } 
    //------------------------------------  </pre><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec57"></a>Comments</h3></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">The <code class="literal">StateAttack</code> coroutine begins <span>and</span> remains throughout the Attack state.</li><li style="list-style-type: disc">The <code class="literal">Transform.LookAt</code> function is called during the coroutine loop, on each frame, to reorient the enemy to always face the player character.</li><li style="list-style-type: disc">If the enemy falls outside the Attack distance, he reverts to the Chase state to catch up with the player. The distance between player and enemy is determined by the <code class="literal">Vector3.Distance</code> function.</li><li style="list-style-type: disc">If the zombie reaches <code class="literal">StoppingDistance</code> from the player, they stop moving and continue to attack.</li></ul></div><p>The Attack state, as it stands, is not sufficient to actually inflict damage on the player. The <code class="literal">StateAttack</code> coroutine, for example, contains no code to interact with the player character and therefore causes no damage for each <span>punch</span> or attack. To achieve this, we'll use <span class="strong"><strong>Animation Events</strong></span>. <span>That i</span>s, we'll invoke player attack functions from the animation keyframes themselves. To get started, let's add some new class variables and a function--<code class="literal">DealDamage</code>. This function inflicts damage on the player, by an <code class="literal">AttackDamage</code> amount, representing the amount of damage inflicted by the enemy. The class variables to add are as follows:</p><pre class="programlisting">    //Reference to player transform 
    private Transform PlayerTransform = null;  
    //Player health component 
    private Health PlayerHealth = null;  
    //Amount of damage to deal on attack 
    public int AttackDamage = 10;  </pre><p>The <code class="literal">DealDamage</code> function is a short, public function written as follows:</p><pre class="programlisting">    //------------------------------------ 
    //Deal damage to the player 
    public void DealDamage() 
    { 
        PlayerHealth.Value -= AttackDamage; 
        HitSound.Play (); 
    } 
    //------------------------------------ </pre><p>Now that we've added the necessary functionality to the <code class="literal">AIEnemy</code> class, let's configure the animation clip asset for <strong class="userinput"><code>Attack</code></strong> state. Specifically, we need to configure the attack animation for synchronizing enemy punches (actions) with punch sounds. Select the <span>Attack</span> animation in the <strong class="userinput"><code>Project</code></strong> panel and switch to the <span><strong class="userinput"><code>Animator</code></strong></span> tab in the object <strong class="userinput"><code>Inspector</code></strong>:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/b82dfed8-92c3-4205-88c8-7fdfa14d52be.png" /></div><p>Accessing animation data for the attack animation</p><p>Next, expand the <strong class="userinput"><code>Events</code></strong> section, to reveal the <span>attack</span> animation timeline, representing the complete attack animation. From here, we should click on and drag the red time slider from the <span><strong class="userinput"><code>Animation</code></strong></span> preview window to preview key frames:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/331e472e-2f2d-40cb-8c66-3f8fa70f3530.png" /></div><p>Previewing attack key frames</p><p>Expand the <span><strong class="userinput"><code>Events</code></strong></span> section to add animation events. Use the time-slider from the preview window to find each key frame where a zombie punch lands (strikes) the player. This is where a punch sound should play. To achieve this, an event should be added for each punch frame. To add an animation event, click on the <span><strong class="userinput"><code>Add Event</code></strong></span> button in the <strong class="userinput"><code>Inspector</code></strong>:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/81e46624-9632-4ed5-98b7-4d7353e3281f.png" /></div><p>Creating animation events</p><p>For each event, run the <strong class="userinput"><code><span>DealDamage</span></code></strong> function. The <span>name</span> is case sensitive and should match the function name as specified in the <code class="literal">AIEnemy</code> class:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/f10f8717-c22f-4676-b566-016f316457c9.png" /></div><p>Detailing animation events</p><p>Repeat this process for each punch event in the timeline, adding a single and unique event calling the <span><strong class="userinput"><code>DealDamage</code></strong></span> keyframe:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/111e6464-2218-434a-9679-e32f29e5e525.png" /></div><p>Creating an animation event for each punch key frame</p><p>For the <span><strong class="userinput"><code>DealDamage</code></strong></span> function to <span>execute</span> successfully, the zombie also needs a fully configured <span><strong class="userinput"><code>Audio Source</code></strong></span> component associated with the punch or damage sound. Add the <span><strong class="userinput"><code>Audio Source</code></strong></span> component by navigating to <span><strong class="userinput"><code>Component</code></strong></span> |<span> <strong class="userinput"><code>Audio </code></strong></span>| <span><strong class="userinput"><code>Audio Source</code></strong></span> in the application menu:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/99d86d1d-9e75-4d26-af2f-935188dab4e6.png" /></div><p>Adding an Audio Source component</p><p>Then, drag and drop the punch sound into the <strong class="userinput"><code><span>AudioClip</span></code></strong> slot, ensuring that you deactivate both the <span><strong class="userinput"><code>Play On Awake</code></strong></span> and <span><strong class="userinput"><code>Loop</code></strong></span> checkboxes. The <span><strong class="userinput"><code>AudioClip</code></strong></span> should only play when the zombie deals damage:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/095e55db-1ea6-44ac-ad40-fd95fe9d356e.png" /></div><p>Configuring the zombie Audio Source component</p><p>Now, let's create a zombie Prefab. This is a great idea because, as mentioned, a Prefab is a special asset type allowing us to easily package and reuse objects from our scene anywhere else. Zombies should feature many times in a single level as well as across multiple levels. To create a zombie Prefab, simply drag and drop the zombie <span>from</span> the <strong class="userinput"><code>Hierarchy</code></strong> panel into the <strong class="userinput"><code>Project</code></strong> panel (into a <code class="literal">prefab</code> folder):</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/647aa8b9-3cd4-4cd5-9571-d98af4412106.png" /></div><p>Creating a zombie Prefab</p><p>If you later change a single instance of the zombie in a scene and then want to apply the change to all other instances, you can do this by updating the prefab. To achieve this, select the zombie you have changed, and then navigate to <span><strong class="userinput"><code>GameObject </code></strong></span>|<span> <strong class="userinput"><code>Apply Changes to Prefab</code></strong></span> in the application menu:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/c0cc5c45-1653-430f-ac0e-7a2aaf40e38a.png" /></div><p>Applying changes to the Prefab</p></div></div>