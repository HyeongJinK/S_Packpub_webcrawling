<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec55"></a>Developing the Chase state</h2></div></div><hr /></div><p>The Chase state occurs when the NPC is following <span>and</span> moving toward the player. In <span class="emphasis"><em>Dead Keys</em></span>, this happens whenever the scene camera moves into a trigger volume or area where zombies are waiting:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/e016ef3d-f7ee-4fb2-9286-980c6ffd67f9.png" /></div><p>Chase state</p><p>The following is the <code class="literal">Chase</code> coroutine (for the <strong class="userinput"><code>Chase</code></strong> state). It contains some interesting features, detailed further in the comments section:</p><pre class="programlisting">    //------------------------------------ 
   public IEnumerator StateChase() 
    { 
        //Run chase animation 
        ThisAnimator.SetInteger("AnimState", (int) ActiveState); 
        //Set destination 
        ThisAgent.SetDestination (PlayerTransform.position); 
        //Wait until path is calculated 
        while (!ThisAgent.hasPath) 
            yield return null; 
        //While in chase state 
        while(ActiveState == AISTATE.CHASE) 
        { 
            if (ThisAgent.remainingDistance &lt;= 
            ThisAgent.stoppingDistance) 
            { 
                ThisAgent.Stop (); 
                yield return null; 
                ActiveState = AISTATE.ATTACK; 
                yield break; 
            } 
            yield return null; 
        } 
    } 
    //------------------------------------  </pre><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec56"></a>Comments</h3></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">The <code class="literal">StateChase</code> coroutine begins by setting the <code class="literal">AnimState</code> integer parameter in Mecanim, for playing the walk/chase animation. This is configured to play on a loop.</li><li style="list-style-type: disc">Next, the <span><strong class="userinput"><code>Nav Mesh Agent</code></strong></span> component is <span>used</span> to set the destination for the zombie. This will be the player location. This causes the zombie to move, walking toward the player, using the navigation mesh.</li><li style="list-style-type: disc">After setting the navmesh destination, the coroutine waits for the <code class="literal">NavMeshAgent</code> to fully calculate the zombie's path. The calculation often happens quickly, but it runs asynchronously and can take more than one frame, that is, the path is not necessarily fully calculated immediately after calling <code class="literal">SetDestination</code>.</li><li style="list-style-type: disc">Next, the couroutine loops continuously, frame by frame, until <code class="literal">remainingDistance</code> (the distance left to travel) is less thanÂ <code class="literal">stoppingDistance</code> (the distance for stopping). In other words, the zombie should continue traveling in Chase mode until it reaches the destination.</li><li style="list-style-type: disc">On reaching the player, the state changes to Attack.</li></ul></div></div></div>