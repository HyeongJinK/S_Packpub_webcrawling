<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec59"></a>Zombies and the Typer class</h2></div></div><hr /></div><p>We've now configured the zombie to <span>display</span> the selected word, and also to add text stylizations based on player input. However, we still haven't linked player input through the <code class="literal">Typer</code> class (coded in the last chapter) with the zombie NPC. Let's do this <span>now</span> by adding a new function to the <code class="literal">EnemyAI</code> class, namely <code class="literal">UpdateTypedWord</code>. This function compares the typed word with the associated word to determine the extent of a match. The purpose is twofold--firstly, to generate the <code class="literal">MatchedWord</code> string and highlight the typed portion of <span>the</span><code class="literal">AssocWord</code>, and secondly, to fire a word matched event (<code class="literal">OnTypingMatched</code>), which causes the zombie to die. Consider the following code:</p><pre class="programlisting">    //------------------------------------ 
    public void UpdateTypedWord() 
    { 
        //If not chasing or attacking, then ignore 
        if(ActiveState != AISTATE.CHASE &amp;&amp; ActiveState != 
        AISTATE.ATTACK) return; 
        MatchedWord = WordList.CompareWords (Typer.TypedWord, 
        AssocWord); 
        //Check for typing match 
        if (MatchedWord.Length != AssocWord.Length) 
            return; 
        if (MatchedWord.Equals (AssocWord)) 
            OnTypingMatched.Invoke (); //Match found. Invoke matched 
            event 
    } 
    //------------------------------------  </pre><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec59"></a>Comments</h3></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">The <code class="literal">UpdateTypedWord</code> function <span>starts</span> by determining the zombie state, as player typing and combat only applies when the zombie is chasing or attacking.</li><li style="list-style-type: disc">Next, the <code class="literal">CompareWords</code> function determines the extent of the match, if any, between the typed word and the associated word. This function is part of the <code class="literal">WordList</code> class, coded in the last chapter. It returns a string representing the amount of match between the typed string and the associated word. If there is no match, the string length will be 0. If there is a partial match, the string length will be &gt; 0, but less than the associated word length. There is a complete match when the associated word length and the typed-string length are identical.</li><li style="list-style-type: disc">When a match is detected, the <code class="literal">OnTypingMatched</code> event is invoked. This is a Unity Event on the zombie character, and this should initiate the zombie death sequence.</li></ul></div><p>To initiate the death sequence from the object Inspector (in the <code class="literal">OnTypingMatched</code> event), we'll need a public <code class="literal">Die</code> function. This is important because only public functions can be launched as actions inside Unity Events, from the object <strong class="userinput"><code>Inspector</code></strong>. Let's look at the code for this, as follows:</p><pre class="programlisting">    //------------------------------------ 
    public void Die() 
    { 
        //Update Game Score 
        GameManager.ThisInstance.Score += ScorePoints; 
        ScoreText.OnScoreChange.Invoke (); 
        //Calculate Bonus, if achieved 
        float LettersPerSecond = AssocWord.Length / Typer.ElapsedTime; 
        //If we beat best times, then get bonus 
        if (LettersPerSecond &lt; Typer.RecordLettersPerSecond)  
        { 
            //Bonus achieved 
            ++GameManager.ThisInstance.BonusLevel; 
        } 
        ActiveState = AISTATE.DEAD; 
        --ActiveEnemies; 
        //Reset matched word 
        MatchedWord = string.Empty; 
        //Update Navigator 
        Navigator.ThisInstance.EnemyDie.Invoke(); 
    } 
    //------------------------------------  </pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec60"></a>Comments</h3></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">The <code class="literal">Die</code> function starts by incrementing the player score by the <code class="literal">ScorePoints</code> variable. This is an integer property and represents the number of points achieved for killing the enemy.</li><li style="list-style-type: disc">The game then determines whether a bonus should be unlocked, because a new record has been set by typing the full word (total number of letters) in the fastest time.</li><li style="list-style-type: disc">In addition, the <code class="literal">ActiveEnemies</code> field is a static integer property. Being static, it is, in effect, shared across all instances. It represents the total number of active enemies in the level, that is, the total number of enemies who are either searching, chasing, or attacking the player right now and, thus, who can be dispatched through typing combat.</li><li style="list-style-type: disc">As the enemy is destroyed, the <code class="literal">ActiveEnemies</code> field is decremented. If this value falls to zero, the in-game camera can move forward to a new destination.</li><li style="list-style-type: disc">The camera <code class="literal">Navigator</code> class is notified of each enemy death through the <code class="literal">EnemyDie</code> event.</li></ul></div><p>Now, we can configure the zombie for a <span>death</span> event through the object <strong class="userinput"><code>Inspector</code></strong> event interface. Select the zombie, and from the <code class="literal">OnTypingMatched</code> field, call the <code class="literal">Die</code> function and enable an explosion particle:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/a3e5d51c-d710-413d-b76a-078c20efde23.png" /></div><p>Configuring the zombie typing matched event</p><p>The explosion system is included in the standard particle system package. Remember that this can be imported from <strong class="userinput"><code><span>Assets</span></code></strong> | <strong class="userinput"><code><span>Import Package</span></code></strong> | <strong class="userinput"><code><span>Particle Systems</span></code></strong> inÂ the <span><strong class="userinput"><code>Assets</code></strong></span> menu:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/fa3ee0fe-bf9e-45d1-bab0-e2a0ede4d41c.png" /></div><p>Importing the ParticleSystems package, if needed</p><p>At this point, we have completed the <code class="literal">AIEnemy</code> class, and we're almost <span>ready</span> for a test run. Let's see the full and final enemy class code, as follows:</p><pre class="programlisting">//------------------------------------ 
using UnityEngine; 
using System.Collections; 
using UnityEngine.EventSystems; 
using UnityEngine.Events; 
using UnityEngine.UI; 
//------------------------------------ 
public class AIEnemy : MonoBehaviour 
{ 
    //------------------------------------ 
    public enum AISTATE {IDLE = 0, CHASE = 1, ATTACK = 2, DEAD=3}; 
    public AISTATE ActiveState 
    { 
        get{ return mActiveState; } 
        set 
        {  
            StopAllCoroutines (); 
            mActiveState = value; 
            switch(mActiveState) 
            { 
            case AISTATE.IDLE: 
                    StartCoroutine (StateIdle()); 
                break; 
                case AISTATE.CHASE: 
                    StartCoroutine (StateChase()); 
                break; 
                case AISTATE.ATTACK: 
                    StartCoroutine (StateAttack()); 
                break; 
                case AISTATE.DEAD: 
                    StartCoroutine (StateDead()); 
                break; 
            } 
            OnStateChanged.Invoke (); 
        } 
    } 
    [SerializeField] 
    private AISTATE mActiveState = AISTATE.IDLE; 
    //------------------------------------ 
    //Events called on FSM changes 
    public UnityEvent OnStateChanged; 
    public UnityEvent OnIdleEnter; 
    public UnityEvent OnChaseEnter; 
    public UnityEvent OnAttackEnter; 
    public UnityEvent OnTypingChanged; 
    public UnityEvent OnTypingMatched; 
    //------------------------------------ 
    //Component references 
    private Animator ThisAnimator = null; 
    private NavMeshAgent ThisAgent = null; 
    private Transform ThisTransform = null; 
    //Reference to player transform 
    private Transform PlayerTransform = null; 
    //Points for enemy 
    public int ScorePoints = 10; 
    //Reference to Score Text 
    private UIScore ScoreText = null; 
    //Player health component 
    private Health PlayerHealth = null; 
    //Word associated 
    public string AssocWord = string.Empty; 
    //Extent of word match with associated word 
    public string MatchedWord = string.Empty; 
    //Amount of damage to deal on attack 
    public int AttackDamage = 10; 
    //Text component 
    private Text NameTextComp = null; 
    //Active enemy count (how many enemies wandering at one time?) 
    public static int ActiveEnemies = 0; 
    //Sound to play on hit 
    public AudioSource HitSound = null; 
    //------------------------------------ 
    void Awake() 
    { 
        ThisAnimator = GetComponent&lt;Animator&gt; (); 
        ThisAgent = GetComponent&lt;NavMeshAgent&gt; (); 
        PlayerTransform = GameObject.FindGameObjectWithTag 
        ("Player").GetComponent&lt;Transform&gt; (); 
        PlayerHealth = PlayerTransform.GetComponent&lt;Health&gt;(); 
        //Find and get associated UI Text 
        NameTextComp = GetComponentInChildren&lt;Text&gt; (); 
        ThisTransform = GetComponent&lt;Transform&gt; (); 
        HitSound = GetComponent&lt;AudioSource&gt; (); 
        ScoreText = GameObject.FindGameObjectWithTag 
        ("ScoreText").GetComponent&lt;UIScore&gt; (); 
        //Hide text 
        NameTextComp.gameObject.SetActive(false); 
    } 
    //------------------------------------ 
    void Start() 
    { 
        //Set active state 
        ActiveState = mActiveState; 
        //Get random word 
        AssocWord = WordList.ThisInstance.GetRandomWord();         
        UpdateText(); 
    } 
    //------------------------------------ 
    public IEnumerator StateIdle() 
    { 
        //Run idle animation 
        ThisAnimator.SetInteger("AnimState", (int) ActiveState); 
        //While in idle state 
        while(ActiveState == AISTATE.IDLE) 
        { 
            yield return null; 
        } 
    } 
    //------------------------------------ 
    public IEnumerator StateChase() 
    { 
        ++ActiveEnemies; 
        //Run chase animation 
        ThisAnimator.SetInteger("AnimState", (int) ActiveState); 
        //Set destination 
        ThisAgent.SetDestination (PlayerTransform.position); 
        //Wait until path is calculated 
        while (!ThisAgent.hasPath) 
            yield return null; 
        //While in idle state 
        while(ActiveState == AISTATE.CHASE) 
        { 
            if (ThisAgent.remainingDistance &lt;= 
            ThisAgent.stoppingDistance) 
            { 
                ThisAgent.Stop (); 
                yield return null; 
                ActiveState = AISTATE.ATTACK; 
                yield break; 
            } 
            yield return null; 
        } 
    } 
    //------------------------------------ 
    public IEnumerator StateAttack() 
    { 
        //Run attack animation 
        ThisAnimator.SetInteger("AnimState", (int) ActiveState); 
        //While in idle state 
        while(ActiveState == AISTATE.ATTACK) 
        { 
            //Look at player 
            Vector3 PlanarPosition = new 
            Vector3(PlayerTransform.position.x, 
            ThisTransform.position.y, PlayerTransform.position.z); 
            ThisTransform.LookAt(PlanarPosition, ThisTransform.up); 
            //Get distance between enemy and player 
            float Distance = Vector3.Distance(PlayerTransform.position,  
            ThisTransform.position); 
            if (Distance &gt; ThisAgent.stoppingDistance*2f) 
            { 
                ThisAgent.Stop (); 
                yield return null; 
                ActiveState = AISTATE.CHASE; 
                yield break; 
            } 
            yield return null; 
        } 
    } 
    //------------------------------------ 
    public IEnumerator StateDead() 
    { 
        //Run dead animation 
        ThisAnimator.SetInteger("AnimState", (int) ActiveState); 
        //While in idle state 
        while(ActiveState == AISTATE.DEAD) 
        { 
            yield return null; 
        } 
    } 
    //------------------------------------ 
    public void UpdateTypedWord() 
    { 
        //If not chasing or attacking, then ignore 
        if(ActiveState != AISTATE.CHASE &amp;&amp; ActiveState != 
        AISTATE.ATTACK) return; 
        MatchedWord = WordList.CompareWords (Typer.TypedWord, 
        AssocWord); 
        //Check for typing match 
        if (MatchedWord.Length != AssocWord.Length) 
            return; 
        if (MatchedWord.Equals (AssocWord)) 
            OnTypingMatched.Invoke (); //Match found. Invoke matched 
            event 
    } 
    //------------------------------------ 
    //Deal damage to the player 
    public void DealDamage() 
    { 
        PlayerHealth.Value -= AttackDamage; 
        HitSound.Play (); 
    } 
    //------------------------------------ 
    // Update is called once per frame 
    public void UpdateText () 
    { 
        //Build UI String 
        NameTextComp.text = "&lt;color=red&gt;" + MatchedWord + "&lt;/color&gt;" + 
        AssocWord.Substring(MatchedWord.Length,AssocWord.Length-
        MatchedWord.Length); 
    } 
    //------------------------------------ 
    public void Die() 
    { 
        //Update Game Score 
        GameManager.ThisInstance.Score += ScorePoints; 
        ScoreText.OnScoreChange.Invoke (); 
        //Calcluate Bonus, if achieved 
        float LettersPerSecond = AssocWord.Length / Typer.ElapsedTime; 
        //If we beat best times, then get bonus 
        if (LettersPerSecond &lt; Typer.RecordLettersPerSecond)  
        { 
            //Bonus achieved 
            ++GameManager.ThisInstance.BonusLevel; 
        } 
        ActiveState = AISTATE.DEAD; 
        --ActiveEnemies; 
        //Reset matched word 
        MatchedWord = string.Empty; 
        //Update Navigator 
        Navigator.ThisInstance.EnemyDie.Invoke(); 
    } 
    //------------------------------------ 
    public void WakeUp() 
    { 
        ActiveState = AISTATE.CHASE; 
    } 
    //------------------------------------ 
} 
//------------------------------------  </pre></div></div>