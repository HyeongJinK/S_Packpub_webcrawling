<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec44"></a>Health and damage</h2></div></div><hr /></div><p>Next up, we consider health and damage. Health is an interesting property, especially because it is abstract, that is, many characters have health: the player character and enemies, including the zombies. Though zombies are neither alive nor dead, but are <span class="emphasis"><em>undead</em></span>, they still normally have an equivalent metric corresponding to health. When that <span>property</span> or resource is exhausted for any character, they expire, die, or are removed from the game. Due to the generic quality of health, it's a good idea to code it once so that it can be applied limitlessly as a component to any entity that has that property. For this reason, we'll create a <code class="literal">Health</code> class. Consider the following full source code and the comments that follow it:</p><pre class="programlisting">//------------------------------------ 
using UnityEngine; 
using System.Collections; 
using UnityEngine.EventSystems; 
using UnityEngine.Events; 
//------------------------------------ 
public class Health : MonoBehaviour 
{ 
    //------------------------------------ 
    public float Value 
    { 
        get{return fValue;} 
        set 
        { 
            fValue = value; 
            OnHealthChanged.Invoke(); 
         
            if (fValue &lt;= 0f) 
                OnHealthExpired.Invoke(); 
        }  
    } 
 
    [SerializeField] 
    [Range(0f,100f)] 
    private float fValue = 100f; 
    //------------------------------------ 
    //Events called on health change 
<span class="strong"><strong>    public UnityEvent OnHealthExpired;
</strong></span><span class="strong"><strong>    public UnityEvent OnHealthChanged;</strong></span> 
    //------------------------------------ 
} </pre><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec49"></a>Comments</h3></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">The <code class="literal">fValue</code> private float variable stores the health value itself. It's declared with two C# attributes: <code class="literal">SerializedField</code> (to show the value in the <strong class="userinput"><code>Inspector</code></strong>) and <code class="literal">Range</code>, to display as a slider.</li><li style="list-style-type: disc">The <code class="literal">fValue</code> variable is accessed through the <code class="literal">Get</code> and <code class="literal">Set</code> methods for a C# property. The <code class="literal">Get</code> method simply returns <code class="literal">fValue</code>. The <code class="literal">set</code> method updates the value and validates it.</li><li style="list-style-type: disc">The <code class="literal">Set</code> method invokes the <code class="literal">HealthChanged</code> event, since the health has changed, and if the health equals or falls below zero, the <code class="literal">HealthExpired</code> event is invoked, allowing any visually scripted events in the object <strong class="userinput"><code>Inspector</code></strong> to run.</li></ul></div><p>With the <code class="literal">Health</code> script coded, you can now <span>attach</span> it to any object that should have a health property, including the player and all of his/her enemies. This demonstrates an effective coding practice when working in Unity, namely <span class="strong"><strong>Component Based Design</strong></span>. The basic idea is to encapsulate abstract and general properties (such as health, spell books, or character sheets), which can potentially apply to many different characters, into a <span>single</span> class. This class can then be attached to an object as a component, perhaps alongside other components, to collectively define that object so that the object becomes the sum of its component parts:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/9bf785f4-a655-4932-8a28-b9c5ee4e5063.png" /></div><p>Attaching the Health script to the Player object</p><p>Excellent! We now have a <code class="literal">Health</code> class. This alone doesn't do much, besides encode a health value for an object, but in collaboration with other classes and components, it'll make a big difference. To see this, let's create a health bar UI element for the player, which will update as the health changes to reflect the current health of the player. To achieve this, create a new canvas object by choosing <strong class="userinput"><code>GameObject</code></strong> | <strong class="userinput"><code>UI</code></strong> | <strong class="userinput"><code>Canvas</code></strong> from the application menu. This adds a new canvas object to the scene, which will be dedicated to a health bar. Name this object <code class="literal">UIDamage</code>:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/1e45d467-59d2-4258-9c73-111110937ff5.png" /></div><p>Creating a UI health canvas object</p><p>The health bar should act much like a traditional health bar in video games. It's presented as a horizontal bar or gauge. When full, the bar <span>appears</span> completely green, from left to right. When damage occurs, the green section of the bar moves further to the left, revealing a darker background behind it. When health has been exhausted, the bar fully retracts to the left, appearing empty:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/cd5dff69-3e4d-4cc2-91d5-d5afb8fc9ad2.png" /></div><p>Creating a health bar</p><p>To create this, we'll need two image objects overlapping each other in the screen space; one for the green front of the bar, and one for the darker background. Create the background by choosing <strong class="userinput"><code>GameObject</code></strong> | <strong class="userinput"><code>UI</code></strong> | <strong class="userinput"><code>Image</code></strong> from the application menu. Name this object <code class="literal">Image_Health_Background</code>:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/b0da686e-bd42-4904-bdc4-6a027126c16b.png" /></div><p>Creating a background image for the health bar</p><p>The health bar should be positioned at the bottom-left corner of the screen and the bar itself should be explicitly left-aligned so that when damage occurs, the right-hand edge of the bar retracts leftward, while the left-hand side remains in place. The width of the bar is, therefore, equivalent to the health value, so set it to <code class="literal">100</code>. To configure the bar this way, change its <strong class="userinput"><code>Pivot</code></strong> in the <strong class="userinput"><code>Rect Transform</code></strong> component to <code class="literal">0</code>,<code class="literal">0</code> from the object <strong class="userinput"><code>Inspector</code></strong> (positioning the pivot at the bottom-left corner). In addition, set the bar anchor to the bottom-left screen corner, fixing the bar in place:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/494d8865-771c-44ee-8ad1-791a14122c1c.png" /></div><p>Setting the pivot and anchor for the health bar background</p><p>Good work! We've created the bar's background, so let's now create the foreground. To do that, simply duplicate the background and then rename it <code class="literal">Image_Health</code>. From the <strong class="userinput"><code>Image</code></strong> component in the object <strong class="userinput"><code>Inspector</code></strong>, select a green color for the <strong class="userinput"><code>Color</code></strong> field, and leave the source image field empty to fill the image with a bold color:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/6f65c82b-4082-4ad7-bb03-4afd239ce399.png" /></div><p>Setting the image color for the foreground</p><p>You can already test the health bar by simply reducing the width of the <code class="literal">Image_Health</code> object, reducing it from <code class="literal">100</code> to a lower value above <code class="literal">0</code>. When you do this, the health bar should retract from the right to left, revealing a solid bar background behind:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/b7199462-ced3-47b0-aa07-7acdd5245255.png" /></div><p>Testing the health bar</p><p>We also need to connect the health bar to the <span>health</span> value for the player. To do this, we'll create a new script for the health bar UI and call it <code class="literal">UIHealth</code>. The following full source code includes comments afterward. This script should be attached to the health bar's foreground image:</p><pre class="programlisting">//------------------------------------ <span class="strong"><strong>
using</strong></span> UnityEngine; <span class="strong"><strong>
using</strong></span> System.Collections; 
//------------------------------------ 
<span class="strong"><strong>public class</strong></span> UIHealth : MonoBehaviour 
{ 
    <span class="strong"><strong>private</strong></span> Health PlayerHealth = <span class="strong"><strong>null</strong></span>; 
    <span class="strong"><strong>private</strong></span> RectTransform ThisTransform = <span class="strong"><strong>null</strong></span>; 
 
    // Use this for initialization 
    <span class="strong"><strong>void</strong></span> Awake ()  
    { 
        GameObject GO = GameObject.FindGameObjectWithTag ("Player"); 
        PlayerHealth = GO.GetComponent&lt;Health&gt; (); 
        ThisTransform = GetComponent&lt;RectTransform&gt; (); 
    } 
     
    // Update is called once per frame 
    <span class="strong"><strong>public void</strong></span> UpdateHealth ()  
    { 
        //Update player health 
        ThisTransform.sizeDelta = new Vector2(PlayerHealth.Value, ThisTransform.sizeDelta.y); 
    } 
} 
//------------------------------------  </pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec50"></a>Comments</h3></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span>The</span><code class="literal">PlayerHealth</code> variable references the Health<span> component</span> on the player object. This variable is assigned during the <code class="literal">Awake</code> function by searching the scene for an object tagged as <code class="literal">Player</code>. Once found, the health component is retrieved. You can display health for other characters (such as zombies), however, by exposing the <code class="literal">PlayerHealth</code> field as public and manually assigning a reference to a different object.</li><li style="list-style-type: disc">The <code class="literal">UpdateHealth</code> function updates the <code class="literal">Width</code> of the health bar based on the health of the player. The <code class="literal">RectTransform.sizeDelta</code> variable controls the width of the health bar.</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note34"></a>Note</h3><p>The <code class="literal">UpdateHealth</code> function can be called on every frame (such as in <span class="emphasis"><em>Update</em></span>) to update the GUI health status. However, continually using update in this way is performance prohibitive. Functionality such as this, when distributed across classes, soon accumulates over all updates, which substantially impacts performance. For this reason, we should opt for an event-based approach. This means identifying all possible occasions when the health can change, and then invoking an appropriate event. When the event occurs, the health must update. Using this technique means that the health UI code only updates when health changes are possible, as opposed to indiscriminately on every frame.</p></div><p>Ensure that the <span>health</span> component is attached to the <span class="emphasis"><em>foreground</em></span> health image and not the <span class="emphasis"><em>background</em></span>:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/1396d080-25f4-47d1-bfe0-3a3d35b00a19.png" /></div><p>Attaching the UI health script to the foreground health bar</p><p>Now we need to generate a health change event; we already have the mechanism in place to do this from the <code class="literal">Health</code> class. Select the <strong class="userinput"><code>Player</code></strong> object and, from the <strong class="userinput"><code>Health</code></strong> component, add an action for the <strong class="userinput"><code>OnHealthChanged ()</code></strong> event in the object <strong class="userinput"><code>Inspector</code></strong>:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/00dc6a10-46aa-4136-8610-d638f8767a68.png" /></div><p>The health script features two events coded with Unity events</p><p>Next, add the <code class="literal">HealthUI</code> object to the target field, and run the <code class="literal">UpdateHealth</code> function from the <code class="literal">UIHealth</code> component:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/115620b2-cfd2-4999-9625-2214328f0132.png" /></div><p>The Health script features two events coded with Unity Events</p><p>That's it! The <span>health</span> changed event is now successfully linked to UI health updates. Right now, there is nothing dangerous in the scene to damage our health, but this will change in the next chapter! You can, of course, test out the damage functionality using key presses inside an <code class="literal">Update</code> function.</p><p>In addition to responding to damage, we should also link the health expired event to the camera death animation that we created in the last chapter. In that chapter, we developed an animation for the camera falling to the ground upon death. Having developed this, we can now link that to the health expired event from the object <strong class="userinput"><code>Inspector</code></strong>, just as we did for the <strong class="userinput"><code>OnHealthChanged</code></strong> event.</p><p>Simply create a new action for <strong class="userinput"><code>OnHealthExpired</code></strong> (on the player's health component) and call the <strong class="userinput"><code>Animator.SetTrigger</code></strong> (string) function to activate the <strong class="userinput"><code>Die</code></strong> parameter in the graph:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/5c5447b9-a84b-4c3f-af43-c5a8072a9137.png" /></div><p>The health script features two events coded with Unity events</p><p>The <strong class="userinput"><code>Die</code></strong> parameter is simply a trigger in the animator graph that activates the death sequence. This was created in the last chapter:</p><div class="mediaobject"><img src="/graphics/9781788479837/graphics/ada95377-fd36-4329-a36f-627a9a796436.png" /></div><p>Invoking the death sequence on health expired events</p></div></div>