<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec55"></a>Placing the towers</h2></div></div><hr /></div><p>When the player buys a tower, they have the possibility to place it where they want. In order to include this feature inside our game, we need to make some changes to our towers.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec44"></a>Allowed areas</h3></div></div></div><p>To begin with, we should notice that the player is not free to place their towers wherever they want to on the map. In fact, they cannot place them along the path where the enemies are moving or in areas where there is water. Therefore, we need to implement this constraint.</p><p>Thus, we need to look at our map and find all the spots where the player can place the tower. In our case, the spots that we are looking for are the following:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781784393106/graphics/image_09_005.jpg" /></div><p>
</p><p>As we can see, it has a custom shape. Even if it is possible to implement a custom shape, it can be much more convenient to think in terms of rectangles and then to split our shape into rectangles. Of course, this can be done in more than one way; however, using fewer rectangles to cover the entire area is better. On the other hand, by using more rectangles you are able to better approximate your areas. A possible choice can be the following:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781784393106/graphics/image_09_006.jpg" /></div><p>
</p><p>In the end, we have found eleven areas.</p><p>The idea here is that the placing script, which we will write in the next section, will look at a flag that is inside our Game Manager to see if the mouse is inside an allowed position to place a tower. We can implement this very easily by using a <span class="strong"><strong>Box Colliders 2D</strong></span> on the <code class="literal">GameManager</code> object.</p><p>Let's start by adding a <span class="strong"><strong>Box Collider 2D</strong></span> on the <code class="literal">GameManager</code> by clicking on <span class="strong"><strong>Add Component</strong></span> | <span class="strong"><strong>Physics 2D</strong></span> | <span class="strong"><strong>Box Collider 2D</strong></span>. Then, we need to resize it to the same dimensions as one of the rectangles we have found, and by using the offset parameter, place it onto the map. For instance, by using this data:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781784393106/graphics/image_09_007.jpg" /></div><p>
</p><p>We should have a scene that looks something like this:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781784393106/graphics/image_09_008.jpg" /></div><p>
</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip30"></a>Tip</h3><p>To speed up the process of placing the rectangles, you could use the <code class="literal">Edit Collider</code> button on the <span class="strong"><strong>Box Collider 2D</strong></span> component.</p></div><p>We need to repeat this for all the areas that we have found, and so, in the end, the <span class="strong"><strong>Inspector</strong></span> will look like the following (in the image, the Inspector has been split in two in order to fit all the components in one image):</p><p>
</p><div class="mediaobject"><img src="/graphics/9781784393106/graphics/image_09_009.jpg" /></div><p>
</p><p>And our map will have our rectangles represented as colliders, as follows:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781784393106/graphics/image_09_010.jpg" /></div><p>
</p><p>Now, the second part of the story is to actually trigger the flag inside our <code class="literal">GameMangerScript</code>, so let's open it.</p><p>To begin with, we need to add a new private variable that holds the flag:</p><pre class="programlisting">private bool isAreaAllowed; &#13;
</pre><p>It is just a Boolean that indicates whether the position of the mouse is inside an allowed area or not.</p><p>Since it is a private variable, we need to also expose a <code class="literal">get</code> method to retrieve its value:</p><pre class="programlisting">    public bool GetIsAreaAllowed() { &#13;
        return isAreaAllowed; &#13;
    } &#13;
</pre><p>The next step is to detect when the mouse enters into one of these areas. Since they are colliders, this can be done by using two special functions in Unity: <code class="literal">OnMouseEnter()</code> and <code class="literal">OnMOuseExit()</code>. The engine calls them every time the mouse enters or exits respectively from one of the colliders attached to the <code class="literal">GameObject</code> of the script. In this case, to the colliders attached to the <code class="literal">GameManager</code>.</p><p>So, we can implement <code class="literal">OnMouseEnter()</code> in order to change the flag to a positive value:</p><pre class="programlisting">    void OnMouseEnter() { &#13;
        isAreaAllowed = true; &#13;
    } &#13;
</pre><p>And the <code class="literal">OnMouseExit()</code>, instead, to set it to <code class="literal">false</code>:</p><pre class="programlisting">    void OnMouseExit() { &#13;
        isAreaAllowed = false; &#13;
    } &#13;
</pre><p>Just save our script, and we are done with defining the allowed areas. We will see how to let the player place the towers in the next section.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec45"></a>Scripting the placement script</h3></div></div></div><p>Now that we have our areas, we can proceed by selecting the tower prefab and then clicking on <span class="strong"><strong>Add Component</strong></span> | <span class="strong"><strong>New Script</strong></span> and naming it <code class="literal">PlacingTowerScript</code>.</p><p>The key concept of this section is that a new tower should follow the mouse of the player until they click on the screen to place it.</p><p>Before we start with this, we need to take the references to the <code class="literal">GameManager</code>. Let's add the following variable:</p><pre class="programlisting">private GameManagerScript gameManager; &#13;
</pre><p>And in the <code class="literal">Start()</code> function we can get the reference to store in the variable:</p><pre class="programlisting">  void Start () { &#13;
        gameManager = GameObject.Find("GameManager").GetComponent&lt;GameManagerScript&gt;(); &#13;
  } &#13;
</pre><p>Now we can focus on the <code class="literal">Update()</code> function. Here, we need to get the mouse coordinates and convert them into a point in the map by using the <code class="literal">ScreenToWorldPoint()</code> function from our main camera. This ensures that the point will be exactly the one that the player is pointing to. Since this is inside the <code class="literal">Update()</code> function, it will move at each frame to the mouse position. In the end, we will add an <code class="literal">if</code> statement that checks whether the player clicks, and whether the click is inside an allowed area. If so, we can get rid of this script by destroying it:</p><pre class="programlisting">  void Update () { &#13;
        float x = Input.mousePosition.x; &#13;
        float y = Input.mousePosition.y; &#13;
        transform.position = Camera.main.ScreenToWorldPoint(new Vector3(x, y, 7)); &#13;
        if (Input.GetMouseButtonDown(0) &amp;&amp; gameManager.GetIsAreaAllowed()) { &#13;
            Destroy(this); &#13;
        } &#13;
  } &#13;
</pre><p>Please note that number <code class="literal">7</code> is the new vector. We decided in <span class="emphasis"><em>
<a class="link" href="#" linkend="ch07">Chapter 7</a>, Tower Defense Basics</em></span>, which of the <span class="emphasis"><em>Z</em></span>-axes of the towers should be at <code class="literal">-3</code>. This function starts from the <span class="strong"><strong>Main Camera</strong></span> that we have placed at <code class="literal">-10</code>, on the <span class="emphasis"><em>Z</em></span>-axis, thus we need to add <code class="literal">7</code> in order to reach <code class="literal">-3</code>.</p><p>We can save the script, and now our tower, once created, moves along with the mouse button until a click is performed.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec46"></a>Final tweaking of the Tower prefab</h3></div></div></div><p>There are still a few things to fix. First, we don't want the tower being able to shoot at the enemies while it is in <code class="literal">placing mode</code>, when the player is still deciding where to place it. Therefore, we need to go into our prefab and disable the <code class="literal">TowerScript</code> as follows:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781784393106/graphics/image_09_011.jpg" /></div><p>
</p><p>In this way, when a tower is created, it will not act as a tower.</p><p>Now, the problem is that when it is placed, we want it to act again. In order to do this, we need to change our script. Let's open the <code class="literal">PlacingTowerScript</code> again and just after the if-statement in the <code class="literal">Update()</code> function, add this line of code:</p><pre class="programlisting">        if (Input.GetMouseButtonDown(0) &amp;&amp; gameManager.GetIsAreaAllowed()) { &#13;
         GetComponent&lt;TowerScript&gt;().enabled = true; &#13;
            Destroy(this); &#13;
        } &#13;
</pre><p>As a result, when the tower is placed, the <code class="literal">TowerScript</code> is also enabled again.</p><p>Furthermore, we want to add a collider to the tower when it is placed. As a result, the player will not be able to place another tower over an existing one. Inside the same <code class="literal">if</code>-statement, let's add the following line:</p><pre class="programlisting">        if (Input.GetMouseButtonDown(0) &amp;&amp; gameManager.GetIsAreaAllowed()) { &#13;
         GetComponent&lt;TowerScript&gt;().enabled = true; &#13;
      gameObject.AddComponent&lt;BoxCollider2D&gt;(); &#13;
         Destroy(this); &#13;
        }             &#13;
</pre></div></div>