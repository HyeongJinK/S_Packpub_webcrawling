<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec67"></a>Minimizing lag</h2></div></div><hr /></div><p>Lag<a id="id585" class="indexterm"></a> is one of those nebulous ideas used to describe an application that is slower than expected. It is <a id="id586" class="indexterm"></a>most commonly seen and recognized in an application's frame rate. Most games run at about 60 FPS and are considered to be lagging if they drop to 30 FPS or less. However, lag and its issues run deeper and include issues such as input responsiveness, internet connectivity, and file reading/writing. As developers, we constantly fight against providing the highest quality experience we can, while maintaining the speeds and responsiveness that users expect. It essentially amounts to whether or not the processor on the user's device can handle the cost of providing the game experience. A few, simple objects in your game will result in fast processing, but several complex objects will require the most processing.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec64"></a>Occlusion</h3></div></div></div><p>Occlusion<a id="id587" class="indexterm"></a> is great for games with a lot of objects. In its basic form, anything that is at the sides or behind the camera is not seen and therefore not drawn. In Unity Pro, we are able to set up occlusion culling. This will calculate what can actually be seen by the camera and not draw anything that is blocked from view. There is a balance that has to be achieved when using these tools. The cost of calculating what cannot be seen needs to be less than the cost of just drawing the objects. There are no solid numbers for how long a scene might take to render. It all depends on the render settings that you have chosen and the detail in your models and textures. As a rule of thumb, if you have many small objects that are regularly blocked from view by larger objects, occlusion culling is the right choice.</p><p>We will add occlusion culling<a id="id588" class="indexterm"></a> to the Tank Battle game<a id="id589" class="indexterm"></a> because it is the only one with anything large enough to regularly block objects from view. Let's set it up with these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open up the Tank Battle game now. If you completed the challenges and added the extra debris and obstacles, this section will be particularly effective for you.</p></li><li><p>Open the Occlusion window by going to Unity's toolbar and navigate to <span class="strong"><strong>Window</strong></span> | <span class="strong"><strong>Occlusion Culling</strong></span>. This window is your primary point of access for modifying the various settings associated with occlusion in your game. Unfortunately, this is a Unity Pro only feature. If you try to open the window while in Unity Basic, this will result in nothing more than an error message in the <span class="strong"><strong>Console</strong></span>.</p></li><li><p>Switch to the <span class="strong"><strong>Bake</strong></span> page and we can take a look at the options associated with occlusion culling:</p><div class="mediaobject"><img src="/graphics/9781784394691/graphics/4691OT_09_13.jpg" /></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Smallest Occluder</strong></span>: This should be set to the size of the smallest thing that can <a id="id590" class="indexterm"></a>block <a id="id591" class="indexterm"></a>other things from view. Things like large boulders and houses make good occluders. Smaller things like furniture or books are generally too small to block anything of significance from view.</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Smallest Hole</strong></span>: This is the smallest gap in your scene through which you can see other objects. Smaller values require more detailed calculations. Larger values are less costly but are more likely to cause objects to flicker in and out of view as the player moves around.</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Backface Threshold</strong></span>: This setting causes the system to do extra checks for objects that might be inside others. A value of <code class="literal">100</code> means no checks will be done and the calculation time will be saved. A value of <code class="literal">5</code> will require a bunch of extra calculations to figure out where everything is in relation to each other.</p></li></ul></div></li><li><p>For our <a id="id592" class="indexterm"></a>purposes at this point, the defaults will work fine. You ideally want to find settings that are balanced between the reduced cost of rendering and the cost of calculating what should be rendered.</p></li><li><p>In order to make the occlusion system work with dynamic objects, we need to set up a number of occlusion areas. To create them, create an empty <span class="strong"><strong>GameObject</strong></span> and add an <span class="strong"><strong>Occlusion Area</strong></span> component that can be found in Unity's toolbar by navigating to <span class="strong"><strong>Component</strong></span> | <span class="strong"><strong>Rendering</strong></span> | <span class="strong"><strong>Occlusion Area</strong></span>.</p></li><li><p>You will need to <a id="id593" class="indexterm"></a>create and manipulate several of these objects. They need to cover the whole area where any dynamic objects and the camera can be located. To this end, create and position enough areas to cover the streets of our game. Their size can be edited just as when working with the <span class="strong"><strong>Box Collider</strong></span> components. You can also use the little cylinders on each side of the area to manipulate the field. Be sure to make them tall enough to cover all of your targets (as you can see in the following screenshot):</p><div class="mediaobject"><img src="/graphics/9781784394691/graphics/4691OT_09_14.jpg" /></div></li><li><p>Next, hit <span class="strong"><strong>Bake</strong></span> <a id="id594" class="indexterm"></a>at the bottom of the <span class="strong"><strong>Occlusion</strong></span> window. A progress bar will appear at the bottom-right corner <a id="id595" class="indexterm"></a>of the Unity Editor, which will tell you how much longer the calculations will take. This process usually takes a good amount of time, especially as your game becomes more and more complex. For our simple Tank Battle game, this process will not take particularly long. Our simple scene with very little in it should only take a couple of seconds to be processed. A large level that is full of detail could easily take all day to be processed.</p></li><li><p>When the baking process has completed, the <span class="strong"><strong>Occlusion</strong></span> window would switch to the <span class="strong"><strong>Visualization</strong></span> tab and, if it can be found, the camera should be selected in your <span class="strong"><strong>Scene</strong></span> window. If it is not, select it now. In the <span class="strong"><strong>Scene</strong></span> view, Unity will give us a preview of how occlusion culling is working. Only those objects that can be seen will be visible while the rest will be turned off (as seen in the following screenshot):</p><div class="mediaobject"><img src="/graphics/9781784394691/graphics/4691OT_09_15.jpg" /></div></li></ol></div><p>We went through the basic process to set up occlusion culling. We took a look at the <span class="strong"><strong>Occlusion</strong></span> window <a id="id596" class="indexterm"></a>and learned about the settings available there. Occlusion culling is great for reducing the number of draw calls in a scene. However, that reduction needs to be balanced against the cost of storing and retrieving <a id="id597" class="indexterm"></a>the occlusion calculations. This balance is achieved by selecting a proper technique and an appropriate <span class="strong"><strong>View Cell Size</strong></span>. Play around with the different values now to find a cell size that gives the appropriate amount of detail without supplying too much information.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec65"></a>Tips for minimizing lag</h3></div></div></div><p>The following is a list of<a id="id598" class="indexterm"></a> tips for dealing with and avoiding lag in your games. Not all of them will apply to every game that you make, but they are good to keep in mind for every project:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Avoid using transparency, if possible, when creating your materials. They are more expensive to render than a normal opaque material. In addition, you can save yourself a world of headaches of dealing with depth sorting, if you avoid them.</p></li><li style="list-style-type: disc"><p>Use one material per object. The greater the number of draw calls in your game, the longer each frame will take to render. Every mesh is drawn once per material on it, even if the material doesn't appear to do anything. By keeping to one material per object, especially on mobile platforms, you minimize the number of draw calls and maximize your rendering speed.</p></li><li style="list-style-type: disc"><p>Combine textures when possible. Not every texture you make will utilize the whole of the image. Whenever possible, combine the textures of objects that are in the same scene. This maximizes your efficient use of images, while reducing the final build size and amount of memory that is needed to utilize the textures.</p></li><li style="list-style-type: disc"><p>Group objects in your <span class="strong"><strong>Hierarchy</strong></span> window using empty <span class="strong"><strong>GameObject</strong></span> components. Though this is not specific to minimizing lag, it will make your project easier to work with. Especially with large and complex levels, you will be able to spend less time searching through the objects in your scene and more time making a great game.</p></li><li style="list-style-type: disc"><p>The <span class="strong"><strong>Console</strong></span><a id="id599" class="indexterm"></a> window is your friend. Before worrying about your game not working, first take a look at the <span class="strong"><strong>Console</strong></span> window or the bar at the bottom in Unity. Both will display any complaints that Unity might have about the way your game is currently setup. The messages here are great for pointing you in the right direction to fix any problems. If you are ever unsure what the messages are trying to tell you, perform a Google search for the message and you should be able to easily find a solution from one of the many Unity users. If your code ever appears to be not working and Unity isn't complaining about it, use the <code class="literal">Debug.Log</code> function to print messages to the Console. This will let you find places where your code might be exiting unexpectedly or find values that are not what they should be.</p></li><li style="list-style-type: disc"><p>Device testing is important. Working in the Editor is great, but there is nothing quite like testing on the target device. You can get a much better feel for how your game is performing when it is on the device. The Editor always introduces a small amount of additional processing overhead. In addition, the computer you are working on will always be more powerful than the mobile devices on which you might intend to deploy your game on.</p></li></ul></div></div></div>