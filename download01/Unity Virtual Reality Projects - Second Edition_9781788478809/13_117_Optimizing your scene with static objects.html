<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch13lvl1sec113"></a>Optimizing your scene with static objects</h2></div></div><hr /></div><p>In addition to your art objects, the next step in <span>optimization</span><a id="id325552060" class="indexterm"></a> might be how your scene itself is organized. If we tell Unity that specific objects will not move in the scene, it can precompute a lot of the rendering in advance rather than at runtime. We do this by defining these game objects as <span class="emphasis"><em>static</em></span>, and then <span class="emphasis"><em>baking</em></span> them into specific contexts. </p><p>We used static objects in <a class="link" href="#" linkend="ch04">Chapter 4</a>, <span class="emphasis"><em>Gazed-Based Control</em></span>, when we set up a <code class="literal">Navmesh</code> for Ethan to run through. His walkable <span class="emphasis"><em>nav</em></span> area was defined by the flat ground plane minus any large static objects that might get in his way, baked into a <span class="emphasis"><em>navmesh</em></span>.</p><p>Statics can also be used to help precompute the scene rendering. Baked lightmaps and shadowmaps precompute lighting and shadows. Baked occlusions divide the scene into static volumes that can be readily culled when out of view, saving processing by possibly eliminating many objects from consideration at once. Let's try some examples.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch13lvl2sec191"></a>Setting up the scene</h3></div></div></div><p>To demonstrate the use of static game objects, we cannot use the <span>dynamically</span><a id="id325567597" class="indexterm"></a> instantiated sunglasses by <code class="literal">SunglassesReplicator</code>. But given we have this script, we'll use it to our advantage now:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li> In <strong class="userinput"><code>Hierarchy</code></strong>, select <code class="literal">SunglassesReplicator</code> and drag the <code class="literal">Sunglasses-original</code> prefab from <strong class="userinput"><code>Project Assets</code></strong> onto its <strong class="userinput"><code>Prefab</code></strong> slot</li><li>Press <strong class="userinput"><code>Play</code></strong></li><li>While playing, in the <strong class="userinput"><code>Hierarchy</code></strong>, select all the <code class="literal">Sunglasses-original(Clone)</code> objects (there's 1000 of them!). Right-click and select <strong class="userinput"><code>Copy</code></strong></li><li>Stop the play mode</li><li>In <strong class="userinput"><code>Hierarchy</code></strong>, create an <strong class="userinput"><code>Empty</code></strong> game object and name it <code class="literal">SunglassesBorg</code>.</li><li>Paste the cloned sunglasses as children of <code class="literal">SunglassesBorg</code></li><li>Disable the <code class="literal">SunglassesReplicator</code> object, as we no longer want to use it
</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note134"></a>Note</h3><p>If you had the need to do this more than once, you could write an <span class="emphasis"><em>Editor Script</em></span>. For example, maybe you need a BorgMaker menu option in the Editor's main menubar. It could prompt you with a dialog box asking for the prefab object, duplication counts, and offset parameters, much like our <code class="literal">SunglassesReplicator</code>. Writing scripts that customize and extend the Unity Editor is common practice. If you're interested, see the <span class="emphasis"><em>Manual: Extending the Editor</em></span> (<a class="ulink" href="https://docs.unity3d.com/Manual/ExtendingTheEditor.html" target="_blank">https://docs.unity3d.com/Manual/ExtendingTheEditor.html</a>) and the <span class="emphasis"><em>Editor Scripting Intro</em></span> tutorial (<a class="ulink" href="https://unity3d.com/learn/tutorials/topics/scripting/editor-scripting-intro" target="_blank">https://unity3d.com/learn/tutorials/topics/scripting/editor-scripting-intro</a>).</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch13lvl2sec192"></a>Lighting and baking</h3></div></div></div><p>The use of lights in your scene affects frame rate. You have a great deal of control over the number of lights, types of lights, their placement, and settings. Read up on it in the <span>Unity</span><a id="id325577433" class="indexterm"></a> manual, which can be found at <a class="ulink" href="http://docs.unity3d.com/Manual/LightPerformance.html" target="_blank"><span>http://docs.unity3d.com/Manual/LightPerformance.html</span></a>.</p><p>Use baked lightmaps whenever possible, which <span>precalculates</span><a id="id325577449" class="indexterm"></a> the lighting effects into a <span>separate</span><a id="id325577458" class="indexterm"></a> image rather than at runtime. Use real-time shadows sparingly. When an object casts shadows, a shadow map is generated, which will be used to render the other objects that might receive shadows. Shadows have a high rendering overhead and generally require high-end GPU hardware. </p><p>Let's see the impact of using baked lightmaps on our scene:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Select <code class="literal">SunglassesBorg</code> and click its <strong class="userinput"><code>Static</code></strong> checkbox in the upper right of <strong class="userinput"><code>Inspector</code></strong></li><li>When prompted, answer <strong class="userinput"><code>Yes, change children</code></strong></li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip135"></a>Note</h3><p>If you get an error, "Mesh doesn't have UVs suitable for lightmapping," select the imported fbx model in your Project window, choose <strong class="userinput"><code>Generate Lightmap UVs</code></strong>, and <strong class="userinput"><code>Apply</code></strong>. </p></div><p>Depending on your Lighting settings, the lightmaps may begin generating right away.  Review and modify the lightmap settings as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Open the <strong class="userinput"><code>Lighting</code></strong> window (<strong class="userinput"><code>Window | Lighting</code></strong>)</li><li>With <strong class="userinput"><code>Auto Generate</code></strong> checked, it will start generating lightmaps any time your scene changes</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Or, uncheck it and click <strong class="userinput"><code>Generate Lighting</code></strong> to build them manually</li></ol></div><p>Here is a screen capture of the Game window running with 1000 high-poly Sunglasses with transparency. We're getting 90 FPS now, and as I move the non-static red cube around, it still renders with transparency and shadows present:</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/3f3b47c6-0cb0-4f81-bd68-5f3b76badc9a.png" /></div><p>In the <strong class="userinput"><code>Lighting</code></strong> window, there are also settings for <strong class="userinput"><code>Realtime Lighting</code></strong> (enabled by default), <strong class="userinput"><code>Baked Global Illumination</code></strong> (enabled by default), <strong class="userinput"><code>Lightmapper</code></strong> subsystem (<strong class="userinput"><code>Enlighten</code></strong> by default), and <strong class="userinput"><code>Fog</code></strong> effects (disabled by default), all of which affect the quality and performance of your scene.</p><p>Here are some more tips when dealing with lighting:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Avoid dynamic shadows, just use a "blurry blob" underneath moving things by using a <span>Projector</span><a id="id325581590" class="indexterm"></a> (see <a class="ulink" href="https://docs.unity3d.com/Manual/class-Projector.html" target="_blank">https://docs.unity3d.com/Manual/class-Projector.html</a>).</li><li style="list-style-type: disc">Check your project’s <strong class="userinput"><code>Quality Settings</code></strong> (<strong class="userinput"><code>Edit | Project Settings | Quality</code></strong>). Use fewer <strong class="userinput"><code>Pixel Lights</code></strong> (on mobile, limit to 1 or 2). Use <strong class="userinput"><code>High Resolution</code></strong> on <strong class="userinput"><code>Hard and Soft Shadows</code></strong>. </li><li style="list-style-type: disc">You can have as many baked lights as you want. Baked lighting produces high quality results, whereas real-time shadows can appear blocky.</li><li style="list-style-type: disc">When baking, you can improve lightmap quality by increasing the baked resolution (a 40-100 pixel resolution is reasonable).</li><li style="list-style-type: disc">Use light probes with baked lighting to illuminate dynamic objects.</li><li style="list-style-type: disc">Use reflection probes for reflective surfaces. These can be static (baked) or dynamic (real-time).</li></ul></div><p>Light probes (either real-time or baked) and the choice of shaders (and the shader options), can make your scene look really amazing. However, they can also have a significant effect on the performance. Balancing aesthetics and graphics performance is an art and a science. </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch13lvl2sec193"></a>Occlusion culling</h3></div></div></div><p>As we've seen, the more you try to reduce the <span>number</span><a id="id325581669" class="indexterm"></a> of objects that need to be rendered, the better. Whether or not you are using high- or low-poly models, Unity still needs to figure out which faces are in view. When there are a lot of objects, perhaps we could help Unity out by giving it some clues.</p><p>Occlusion culling disables the rendering of objects when they are not seen by the camera because they are <span>obscured</span><a id="id325581680" class="indexterm"></a> (occluded) by other objects. (See <span><a class="ulink" href="http://docs.unity3d.com/Manual/OcclusionCulling.html" target="_blank">http://docs.unity3d.com/Manual/OcclusionCulling.html</a>.) It examines your scene and, using the bounding boxes (extents) of each object, divides the world space into a hierarchy of cubes. When Unity needs to determine if an object is within view, it will throw away any objects who's culling box is obviously outside of the view, and continue through the hierarchy.</span></p><p><span>To demonstrate, we'll replicate a few copies of our <code class="literal">SunglassesBorg</code> and set up occlusion culling:</span></p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In <strong class="userinput"><code>Hierarchy</code></strong>, select <code class="literal">SunglassesBorg</code>, right-click, then <strong class="userinput"><code>Duplicate</code></strong> three times</li><li>For the first copy, set the <strong class="userinput"><code>Y-Rotation</code></strong> to <code class="literal">90</code>, then move it off to <strong class="userinput"><code>Position X</code></strong> = <code class="literal">20</code></li><li>For the second copy, set <strong class="userinput"><code>Y-Rotation</code></strong> to <code class="literal">-90</code> and move it to <strong class="userinput"><code>Position X</code></strong> = <code class="literal">-20</code></li><li>For the third copy, set <strong class="userinput"><code>Y-Rotation</code></strong> to <code class="literal">180</code> and move it <strong class="userinput"><code>Position Z</code></strong> = <code class="literal">-20</code></li></ol></div><p>When I press <strong class="userinput"><code>Play</code></strong>, with so many objects, we are down to about a 50 FPS frame rate.</p><p>Now, with the following changes, we can address our performance problem:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>All four Borgs are already <strong class="userinput"><code>Static</code></strong>, but verify that the <strong class="userinput"><code>Static: Occluder</code></strong> and <strong class="userinput"><code>Occludee</code></strong> are checked (inspect the <strong class="userinput"><code>Static</code></strong> drop-down list)</li><li>Open the <strong class="userinput"><code>Occlusion Culling</code></strong> window (<strong class="userinput"><code>Window | Occlusion Culling</code></strong>)</li><li>Click <strong class="userinput"><code>Bake</code></strong></li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note136"></a>Note</h3><p>Note that we could have, but didn't, distinguish Occludees versus Occluders in our scene. Occludees are objects that get occluded. Ocluders are ones that may be in front, occluding the others. Translucent objects that do not occlude should be marked as Occludees, but not Occluders.</p></div><p>This may take a while. Here is a top-down Scene view with the generated culling volumes:</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/1f259142-0dbc-4af7-9d47-1ac470ef6d86.png" /></div><p>Now when I press Play, the performance is back up to 90 FPS again (more or less, depending on where you're looking, as a user in the scene).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip137"></a>Note</h3><p>Another way to reduce the details in a scene is by using Global Fog, which is based on distance. Objects further away than the fog limits will not be drawn. </p></div></div></div>