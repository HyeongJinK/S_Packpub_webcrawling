<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch12lvl1sec103"></a>Adding multiplayer networking</h2></div></div><hr /></div><p>To make the scene <span>run</span><a id="id325552060" class="indexterm"></a> as multiplayer, we need at a minimum a Network Manager component and we need to identify any objects that will get spawned using the Network Identity component.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec171"></a>Network Manager and HUD</h3></div></div></div><p>First, we'll add the Network <span>Manager</span><a id="id325552075" class="indexterm"></a> component, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Create an <strong class="userinput"><code>Empty</code></strong> game object and name it <code class="literal">NetworkController</code></li><li>Select <strong class="userinput"><code>Add Component</code></strong> | <strong class="userinput"><code>Network</code></strong> | <strong class="userinput"><code>Network Manager</code></strong></li><li>Select <strong class="userinput"><code>Add Component</code></strong> | <strong class="userinput"><code>Network</code></strong> | <strong class="userinput"><code>Network Manager HUD</code></strong></li></ol></div><p>We added a <strong class="userinput"><code>Network Controller HUD</code></strong> which displays a simplistic default menu, in screen space, that Unity offers to select the runtime networking options (you can see it in the images that follow). It's for development. In a real project, you'll probably replace the default HUD with something more interesting. And for VR, you'll want to make yours in world space.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec172"></a>Network Identity and sync Transform</h3></div></div></div><p>Next, add a Network Identity to the <code class="literal">Avatar</code> prefab. We will also add a Network Transform, which instructs the networking system to synchronize the player's <strong class="userinput"><code><span>Transform</span><a id="id325552898" class="indexterm"></a></code></strong> values to the avatar instances on each client, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In <strong class="userinput"><code>Project Assets</code></strong>, select the <code class="literal">Avatar</code> prefab</li><li>Navigate to <strong class="userinput"><code>Add Component</code></strong> | <strong class="userinput"><code>Network</code></strong> | <strong class="userinput"><code>Network Identity</code></strong></li><li>Ensure the <strong class="userinput"><code>Local Player Authority</code></strong> checkbox is checked</li></ol></div><p>We will now tell the <code class="literal">Avatar</code> to sync its <strong class="userinput"><code>Transform</code></strong> properties with all other players over the network, by adding an <code class="literal">Network Transform</code> component:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Navigate to <strong class="userinput"><code>Add Component</code></strong> | <strong class="userinput"><code>Network</code></strong> | <strong class="userinput"><code>Network Transform</code></strong></li><li>Ensure that <strong class="userinput"><code>Transform Sync Mode</code></strong> is set to <strong class="userinput"><code>Sync Transform</code></strong></li><li>And <strong class="userinput"><code>Rotation Axis</code></strong> is set to <strong class="userinput"><code>XYZ (full 3D)</code></strong></li></ol></div><p>The Network Transform component is configured to share the actual Transform values with other player's instances of this object, including the full XYZ rotations.</p><p>Now, tell the <code class="literal">Network Manager</code> that our <code class="literal">Avatar</code> prefab represents players:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In <strong class="userinput"><code>Hierarchy</code></strong>, select <code class="literal">NetworkController</code></li><li>In <strong class="userinput"><code>Inspector</code></strong>, unfold the <strong class="userinput"><code>Network Manager Spawn Info</code></strong> parameters so that you can see the <strong class="userinput"><code>Player Prefab</code></strong> slot</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Drag the <code class="literal">Avatar</code> prefab from Project Assets onto the <strong class="userinput"><code>Player Prefab</code></strong> slot</li><li>Save the scene</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec173"></a>Running as a host</h3></div></div></div><p>Click on the Play mode. As <span>shown</span><a id="id325577488" class="indexterm"></a> in the following screenshot, the screen comes up with the HUD start menu, which lets you select whether you wish to run and connect this game:</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/22df3966-3c9f-41a0-811a-522eacc11ebc.png" /></div><p>Choose <strong class="userinput"><code>LAN Host </code></strong>(press <span class="emphasis"><em>H</em></span> on keyboard). This will initiate a server (default port <code class="literal">7777</code> on <code class="literal">localhost</code>) and spawn an <code class="literal">Avatar</code>. The avatar is positioned at a default location, (<code class="literal">0, 0, 0</code>). Also, it's not connected to the camera. So, it is more like a third-person view. As mentioned above, for VR you'll eventually want to modify this default HUD to run in World Space.</p><p>The next thing to do is run a second instance of the game and see two spawned avatars in the scene. However, we wouldn't want them to overlap as both are positioned at the origin, so first we define a couple of spawn positions.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec174"></a>Adding spawn positions</h3></div></div></div><p>To add a spawn position, you just need a <span>game</span><a id="id325581662" class="indexterm"></a> object with a Network Start Position component:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Navigate to <strong class="userinput"><code>GameObject</code></strong> | <strong class="userinput"><code>Create Empty</code></strong>, rename it <code class="literal">Spawn1</code>, and set its <strong class="userinput"><code>Position</code></strong> to (<code class="literal">0, 1.4, 1</code>)</li><li>Navigate to <strong class="userinput"><code>Add Component</code></strong> | <strong class="userinput"><code>Network</code></strong> | <strong class="userinput"><code>Network Start Position</code></strong></li><li>Duplicate the object (<strong class="userinput"><code>Ctrl-D</code></strong>), rename it  <code class="literal">Spawn2</code>, and set its<strong class="userinput"><code>Position</code></strong>to (<code class="literal">0, 1.4, -1</code>)</li><li>In Hierarchy, select <code class="literal">NetworkController</code>. In<strong class="userinput"><code>Inspector,  Network Manager | Spawn Info | Player Spawn Method</code></strong>, select<strong class="userinput"><code>Round Robin</code></strong></li></ol></div><p>We now have two different spawn locations. The Network Manager will choose one or the other when a new player joins the game.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec175"></a>Running two instances of the game</h3></div></div></div><p>A reasonable way to run two copies of the <span>game</span><a id="id325586478" class="indexterm"></a> on the same machine (<code class="literal">localhost</code>) is to build and run one instance as a separate executable and the other instance from the Unity Editor (the Play mode). Unfortunately, we cannot run both in VR. (Ordinarily, you can only run one VR device on a PC at a time, and one VR app on that device). So, we'll build one without VR, using a non-VR first-person controller, and run the editor version with VR enabled.  </p><p>Add a standard first-person character to the scene, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>If you do not have the standard <strong class="userinput"><code>Characters</code></strong> assets package loaded, navigate to <strong class="userinput"><code>Assets</code></strong> | <strong class="userinput"><code>Import Package</code></strong> | <strong class="userinput"><code>Characters</code></strong> and choose <strong class="userinput"><code>Import</code></strong></li><li>Find the <code class="literal">FPSController</code> in the <strong class="userinput"><code>Project</code></strong> <code class="literal">Assets /Standard Assets/Characters/FirstPersonCharacter/Prefabs/</code> folder and drag it into the scene</li><li>Reset its <strong class="userinput"><code>Transform</code></strong>, and set it looking at the front of objects. Set <strong class="userinput"><code>Position</code></strong> to eye level, (<code class="literal">0, 1.4, 0</code>)</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>With <code class="literal">FPSController</code> selected, in the <strong class="userinput"><code>Inspector</code></strong>, on the <strong class="userinput"><code>First Person Controller</code></strong> component, set <strong class="userinput"><code>Walk Speed</code></strong> to <code class="literal">1</code></li><li>Disable<code class="literal">MeMyselfEye</code></li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip119"></a>Note</h3><p>It can also be helpful to modify the <strong class="userinput"><code>XR Settings</code></strong> in <strong class="userinput"><code>Player Settings</code></strong>, by adding the SDK named <code class="literal">None</code> to the top of this list. This will cause projects to build and run without VR hardware even if you forget to uncheck the <strong class="userinput"><code>Virtual Reality Supported</code></strong> checkbox.</p></div><p>Build the executable as usual. For standalone Windows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Navigate to <strong class="userinput"><code>File</code></strong> | <strong class="userinput"><code>Build Settings...</code></strong>.</li><li>Ensure that the current scene is the only one checked in <strong class="userinput"><code>Scenes In Build</code></strong>. If it's not present, click on <strong class="userinput"><code>Add Open Scenes</code></strong>.</li><li>Open<strong class="userinput"><code>Player Settings...</code></strong>.</li><li>Under <strong class="userinput"><code>XR Settings</code></strong>, uncheck the <strong class="userinput"><code>Virtual Reality Supported</code></strong> checkbox.</li><li>Under <strong class="userinput"><code>Resolution and Presentation</code></strong>, check the <strong class="userinput"><code>Run In Background</code></strong> checkbox as true.</li><li>Select <strong class="userinput"><code>Build and Run</code></strong>, give it a name. Subsequently, you can launch the game by double-clicking after it's built.</li></ol></div><p>Enabling the <strong class="userinput"><code>Run In Background</code></strong> will permit the user input controls (keyboard and mouse) in each window when running the executables.</p><p>To run the game in Unity Editor, we need to reverse some of these settings:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In <strong class="userinput"><code>Hierarchy</code></strong>, disable <code class="literal">FPSController</code> and enable <code class="literal">MeMyselfEye</code></li><li>In <strong class="userinput"><code>Player Settings</code></strong>, check the <strong class="userinput"><code>Virtual Reality Supported</code></strong> checkbox and move your <strong class="userinput"><code>SDK</code></strong> to the top of the list</li></ol></div><p>In one of your game windows, click on the Play mode and select <strong class="userinput"><code>LAN Host (H)</code></strong>, like we did previously. Then, in the other window, select <strong class="userinput"><code>LAN Client (C)</code></strong>. In each game, you should now see two instances of the avatar, one for each player, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/8905eebd-b019-4f40-a811-729135155640.png" /></div><p>If you want to run an instance of the game on a separate machine, enter the IP address of the host machine into the <strong class="userinput"><code>Client</code></strong> input field (for instance, <code class="literal">10.0.1.14</code> on my LAN) instead of <code class="literal">localhost</code>. If each machine has its own VR device, they can each run the corresponding MeMyselfEye prefab as applicable.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip120"></a>Note</h3><p>If you're running multiple instances of the project on a single machine, just set the LAN Client address to <code class="literal">localhost</code>. If you want to run on other machines on your network (including mobile devices), note the IP address of the LAN host machine and enter that value on the Client connections (for example, mine is <code class="literal">10.0.1.14</code>). A default value for this can even be added to your project's <strong class="userinput"><code>Network Manager</code></strong> component's <strong class="userinput"><code>Network Info | Network Address</code></strong> parameter.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec176"></a>Associating Avatar with the first-person character</h3></div></div></div><p>It's not very interesting if the <span>avatars</span><a id="id325552584" class="indexterm"></a> don't move. That's the next piece of this puzzle.</p><p>You might think that we should have parented the avatar object under the player camera, (<code class="literal">MeMyselfEye</code> or <code class="literal">FPSController</code> ) and saved it as a Prefab, and then told the Network Manager to use that for spawns. But then, you'd end up with multiple cameras in the scene and controller scripts listening on user input. Not good.</p><p>We must have only one active player in the scene. Other players' avatars get spawned but are not controlled here. In other words, when the local player (and only the local player) gets spawned, its avatar should become a child of the camera. To achieve this, we will write a script:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In <strong class="userinput"><code>Project Assets</code></strong>, select <code class="literal">Avatar</code>, navigate to <strong class="userinput"><code>Add Component</code></strong> | <strong class="userinput"><code>New Script</code></strong>, and name it <code class="literal">AvatarMultiplayer</code></li><li>Open and edit the <code class="literal">AvatarMultiplayer.cs</code> script, as follows:</li></ol></div><pre class="programlisting">using UnityEngine; 
using UnityEngine.Networking; 
 
public class AvatarMultiplayer : NetworkBehaviour 
{ 
  public override void OnStartLocalPlayer () 
  { 
    GameObject camera = Camera.main.gameObject; 
    transform.parent = camera.transform; 
    transform.localPosition = Vector3.zero; 
  } 
} </pre><p>The first thing you'll notice is that we need to include the <code class="literal">using UnityEngine.Networking</code> namespace to access the networking API. Then, the class <code class="literal">AvatarMultiplayer</code> is derived from <code class="literal">NetworkBehaviour</code>, which internally is derived from <code class="literal">MonoBehaviour</code>.</p><p><code class="literal">NetworkBehaviour</code> provides additional callback functions. We are going to use <code class="literal">OnStartLocalPlayer</code>, which gets called whenever the local player object is spawned. However, it is not called when the remote player objects are spawned. Its declaration requires the <code class="literal">override</code> keyword.</p><p><code class="literal">OnStartLocalPlayer</code> is exactly what we want because only when a local player is spawned do we want to parent it to the camera. We access the current main camera object and make it the avatar's parent (<code class="literal">transform.parent = camera.transform</code>). We also reset the avatar's transform so that it's centered at the camera's position.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip121"></a>Note</h3><p>Consider improving the script to specify the actual game object you want to parent your avatar.</p></div><p>Run two instances of the game: <strong class="userinput"><code>Build</code></strong> &amp; <strong class="userinput"><code>Run</code></strong> to execute one, and use the Play mode for the other. Control the player in one window, and it moves the avatar in the other. Wow! You can even launch more executables and have a party!</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note122"></a>Note</h3><p>Depending on the size and local position of your avatar, its model objects (such as eye glasses) may be visible from the first person camera and obstruct the view. You can hide them by disabling the child graphics. But then, for example, you wont see your own shadow (which I like). Another option is to shift the avatar graphics backwards to ensure they don't obstruct the camera's view. Either way, this can be done in this <code class="literal">AvatarMultiplayer</code> script. Likewise, if your game gives each avatar a body, or chair, or whatnot, the current player's instance may not need or want all those graphic detail to be following them around.</p></div></div></div>