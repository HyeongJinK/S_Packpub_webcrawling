<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch11lvl1sec98"></a>Using Animator Controllers</h2></div></div><hr /></div><p>While recording <span>animations</span><a id="id325317274" class="indexterm"></a> as Timeline tracks is very convenient, it does have limitations. Those animations "live" in the Timeline. But, sometimes you want to treat animations as assets in their own right. For example, you would use Animation Clips if you want an animation to loop repeatedly, or transition between animations, or blend their actions, or apply the same set of animation curves to other objects.</p><p>We will take a look at a couple of existing examples of Animators and then use the existing birds one to make our Bluejay fly.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec156"></a>Definitions for Animation and Animator</h3></div></div></div><p><span class="strong"><strong>Animators</strong></span> have been the standard <span>way</span><a id="id325317296" class="indexterm"></a> of managing <span class="emphasis"><em>Animation Clips</em></span> in Unity, before Timeline. It uses an <strong class="userinput"><code>Animator Component</code></strong>, an <strong class="userinput"><code>Animator Controller</code></strong>, and an <strong class="userinput"><code>Animation Clip</code></strong>. Fortunately, if <span>you</span><a id="id325317315" class="indexterm"></a> create a new Animation Clip on an object, Unity creates each of these items for you. But it's important to understand how they fit together.</p><p>Briefly, from the Unity manual (<a class="ulink" href="https://docs.unity3d.com/Manual/animeditor-CreatingANewAnimationClip.html" target="_blank">https://docs.unity3d.com/Manual/animeditor-CreatingANewAnimationClip.html</a>):</p><div class="blockquote"><blockquote class="blockquote"><p><span class="emphasis"><em>"To animate GameObjects in Unity, the object or objects need an <span class="strong"><strong>Animator Component</strong></span> attached. This Animator Component must reference an <span class="strong"><strong>Animator Controller</strong></span>, which in turn contains references to one or more <span class="strong"><strong>Animation Clips</strong></span>."</em></span></p></blockquote></div><p>These objects originate from the Mecanim animation system folded into Unity a few versions back (you may still see references to Mecanim in the Unity Manual and web searches). This animation system is especially tailored for humanoid character animations (see <a class="ulink" href="https://docs.unity3d.com/Manual/AnimationOverview.html" target="_blank">https://docs.unity3d.com/Manual/AnimationOverview.html</a>). The terminology can seem redundant and confusing. The following definitions may help (or not!). Pay especially close attention to the use of "animator" versus "animation":</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="emphasis"><em>Animation Clips</em></span>: Describes how an object's properties change over time.</li><li style="list-style-type: disc"><span class="emphasis"><em>Animator Controller</em></span>: Organizes clips in a state machine flowchart, keeps track which clip should currently be playing, when animations should change or blend together. References the clips it uses.
</li><li style="list-style-type: disc"><span class="emphasis"><em>Animator component</em></span>: Brings together Animation Clips, the Animation Controller, and the Avatar if used.</li><li style="list-style-type: disc">Do not use <span class="emphasis"><em>legacy Animation components :</em></span> Animation component is legacy but Animation window is not!</li><li style="list-style-type: disc"><span class="emphasis"><em>Animation window</em></span>: Used to create/edit individual Animation Clips, and can animate any property you can edit in the inspector. Shows a <strong class="userinput"><code>timeline</code></strong> but is not the same as the Timeline window. Offers Dopesheet versus Curves view. </li><li style="list-style-type: disc"><span class="emphasis"><em>Animator window</em></span>: Organizes existing animation clip assets into a flowchart-like state machine graph.</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note114"></a>Note</h3><p>Actually, Timeline animation recordings also use Animation Clips, you just don't need to explicitly create them. Each recorded Animation Track in a Timeline has a corresponding animation playable file (named "Recorded (n)") in your Assets folder. </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec157"></a>ThirdPersonController Animator</h3></div></div></div><p>The <code class="literal">ThirdPersonController</code> character prefab we used for Ethan in <span>previous</span><a id="id325552343" class="indexterm"></a> chapters uses an animator controller to manage humanoid animation clips on the rigged model. For curiosity, let's examine it now (although we will not use it in this scene):</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Temporarily drag a copy of the <code class="literal">ThirdPersonController</code> prefab from your <strong class="userinput"><code>Project</code></strong><code class="literal">Assets/Standard Assets/ Characters/ThirdPersonCharacter/Prefabs/</code> folder into the scene.</li><li>Notice in <strong class="userinput"><code>Inspector</code></strong>, it has an <strong class="userinput"><code>Animator</code></strong> component and the <strong class="userinput"><code>Controller</code></strong> slot references <code class="literal">ThirPersonAnimatorController</code>. Click on that.</li><li>This will highlight the controller asset (in <code class="literal">Assets/.../ThirdPersonCharacter/Animator</code>).</li><li>Double-click<code class="literal">ThirdPersonAnimatorController</code> to open it in an <strong class="userinput"><code>Animator</code></strong> window.</li></ol></div><p>The Animator graph for Ethan is shown next. You can see that when the character is activated (<code class="literal">Entry</code>), it initializes to the <code class="literal">Grounded</code> state. The oval boxes are <strong class="userinput"><code>States</code></strong>; the lines between them are <strong class="userinput"><code>Transitions</code></strong>. On the left is the list of state <strong class="userinput"><code>Properties</code></strong> that the Animator can use. When <code class="literal">Crouch</code> is true, for example, the animation transitions to <code class="literal">Crouching</code>, plays that, then transitions back (and clears the <code class="literal">Crouch</code> state flag):</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/a3dca19f-4804-4bf7-bef1-bdecb578d7f2.png" /></div><p>If you open the <code class="literal">Grounded</code> state (double-click), you can see a <strong class="userinput"><code>Blend Tree</code></strong> with an impressive collection of <strong class="userinput"><code>Animation Clips</code></strong> for standing idle, walking, turning, and so on. These will be activated and combined (blended) based on user input. </p><p>Next, let's look at another example, the <code class="literal">BirdAnimatorController</code> used by our <code class="literal">Bluejay</code>.</p><p>You can now delete the <code class="literal">ThirdPersonController</code> object from the scene.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec158"></a>Living Birds Animator</h3></div></div></div><p>The Living Birds package comes with a lot of <span>animation</span><a id="id325552525" class="indexterm"></a> clips. You can actually open the FBX models in Blender or another animation application and examine how the models and animations are defined. These have been combined into a <code class="literal">BirdAnimationController</code>. Examine the Animator using the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Select the <code class="literal">Bluejay</code> in <strong class="userinput"><code><strong class="userinput"><code>Hierarchy.</code></strong></code></strong></li><li>Notice in <strong class="userinput"><code>Inspector</code></strong>, it has an <strong class="userinput"><code>Animator</code></strong> component, and the <strong class="userinput"><code>Controller</code></strong> slot references <code class="literal">BirdAnimatorController</code>. Click on that.</li><li>In <strong class="userinput"><code>Project Assets</code></strong>, double-click the <code class="literal">ThirdPersonAnimatorController</code> to open it in an <strong class="userinput"><code>Animator</code></strong> window.</li></ol></div><p>The Animator graph is shown here:</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/7e169721-7d83-47bc-9a1e-6fd32f0b6d2a.png" /></div><p>You can see that almost all the animations readily transition to and from the Idle one, whether Preen, Peck, Sing, or HopLeft, HopRight, HopForward, and so on. Also, note the Idle -&gt; Fly -&gt; Landing -&gt; Idle loop, as we're going to use that.</p><p>The Bluejay also has a C# script, <code class="literal">lb_Bird</code>, which invokes the Animator behaviors. It's not the cleanest code, but it is useful. The most pertinent functions are <code class="literal">OnGroundBehaviors</code> and <code class="literal">FlyToTarget</code>:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">OnGroundBehaviors</code> randomly chooses and plays one of the idle animations every 3 seconds</li><li style="list-style-type: disc"><code class="literal">FlyToTarget</code>, will cause the bird to fly to a given position, including takeoff and landing and random fluttering around; it looks reasonably natural
</li></ul></div><p>So in our project, rather than recording the Keyframe position details of the bird's animation path like we did the falling nest, we'll define specific targets and let the <code class="literal">lb_Bird</code> script actually control the bird transforms. This is a lot like using a <strong class="userinput"><code>Navmesh</code></strong> to direct Ethan's movement as we did in Chapter 4, <span class="emphasis"><em>Gaze-Based Control</em></span>. We will use Timeline to select one target position to the next, over time.  </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec159"></a>Learning to fly</h3></div></div></div><p>First, let's create a <code class="literal">BirdController</code> and specify a list of <span>locations</span><a id="id325552636" class="indexterm"></a> where the bird should fly between. Then, we'll add this to the Timeline:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In <strong class="userinput"><code>Hierarchy</code></strong>, create an <strong class="userinput"><code>Empty</code></strong> game object named <code class="literal">BirdController</code> and reset its <strong class="userinput"><code>Transform.</code></strong></li><li>Create a child <strong class="userinput"><code>Empty</code></strong> object, named <code class="literal">Location1</code>. Move it to be just atop the rock closest to the Nest .</li><li>Create another <strong class="userinput"><code>Empty</code></strong>, named <code class="literal">Location2</code>, positioned back near the Nest but not in it this time.</li><li>Continue creating location markers. The values I used, based on my scene and rock locations, are shown in the following table.</li><li>The last location should be far away. The bird will head there at the end of the video.</li></ol></div><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col /><col /><col /></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Name</p></th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Position</p></th><th style="border-bottom: 0.5pt solid ; "><p>Description</p></th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Location0</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">(0.75, 0.4, -1.25)</code></p></td><td style="border-bottom: 0.5pt solid ; "><p>Start position of the Bluejay</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Location1</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">(3, 0.8, 0)</code></p></td><td style="border-bottom: 0.5pt solid ; "><p>Atop nearest rock</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Location2</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">(1.2, 0.2, -1.7)</code></p></td><td style="border-bottom: 0.5pt solid ; "><p>Ground near Nest but not in it</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Location3</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">(2.5, 0.8, -3.4)</code></p></td><td style="border-bottom: 0.5pt solid ; "><p>Atop next nearest rock</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Location4</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">(-5.85, 0.8, -0.3)</code></p></td><td style="border-bottom: 0.5pt solid ; "><p>Next rock</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Location5</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">(-5, 0.33, 3.5)</code></p></td><td style="border-bottom: 0.5pt solid ; "><p>Last rock</p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p><code class="literal">Location6</code></p></td><td style="border-right: 0.5pt solid ; "><p><code class="literal">(45, 11, 45)</code></p></td><td style=""><p>In the distance</p></td></tr></tbody></table></div><p>Create a new C# script on the <code class="literal">BirdController</code>, named <code class="literal">BirdController</code>, and write it as follows:</p><pre class="programlisting">using System.Collections;
using System.Collections.Generic;
using UnityEngine;</pre><pre class="programlisting">
public class BirdController : MonoBehaviour
{
    public GameObject bird;
    public List&lt;GameObject&gt; targets = new List&lt;GameObject&gt;();
    public int animIndex;

    public bool collideWithObjects = false;
    public float birdScale = 1.0f;

    private int prevIndex;

    void Start()
    {
        prevIndex = 0;
    }

    void Update()
    {
        if (animIndex != prevIndex &amp;&amp; 
            index &gt; 0 &amp;&amp; 
            index &lt; targets.Count)
        {
            prevIndex = animIndex;
            bird.gameObject.SendMessage("FlyToTarget", targets[index].transform.position);
        }
    }
}
}</pre><p>There are a number of things going on here. We'll explain.</p><p><code class="literal">BirdController</code> has a reference to the <code class="literal">bird</code>, and a list of location <code class="literal">targets</code>. We'll populate this list in the Unity Editor. Each location is identified by an index value between <code class="literal">0</code> and the size of the list. An integer, <code class="literal">animIndex</code>, will be the parameter controlled by the Timeline, telling the controller which location the bird should fly to.</p><p>On each Update, we check whether the <code class="literal">animIndex</code> has changed. If so, and it's within the range for our list, it calls <code class="literal">FlyToTarget</code> on the bird. (We use <code class="literal">SendMessage</code>, not a best practice way of triggering functions in another object, but it's the least disruptive given the existing scripts provided with the Living Birds package.)</p><p>The extra two variables, <code class="literal">collideWithObjects</code> and <code class="literal">birdScale</code>, are not used but are required by the <code class="literal">lb_Bird.cs</code> script on the Bluejay.</p><p>Save the script. Now, in Unity:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Drag the <code class="literal">BirdController</code> script onto the <code class="literal">BirdController</code> object as a component</li><li>Drag <code class="literal">Bluejay</code> onto the <strong class="userinput"><code>Bird</code></strong> slot</li><li>Unfold the <strong class="userinput"><code>Targets</code></strong> list and set <strong class="userinput"><code>Size</code></strong> to <code class="literal">7</code></li><li>Drag <code class="literal">Location0</code> onto <strong class="userinput"><code>Element 0</code></strong>, <code class="literal">Location1</code> onto <strong class="userinput"><code>Element 1</code></strong>, and so on</li></ol></div><p>The Hierarchy with the BirdController component is shown here:</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/4b0724d9-d72a-411c-940f-846325678940.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec160"></a>Hacking the birds</h3></div></div></div><p>Unfortunately, like a lot of code you'll find on the internet, the Living Birds code <span>works</span><a id="id325553099" class="indexterm"></a> for its own purposes but not necessarily ours. In this case, the package is designed for generating a flock of various birds that fly and land randomly, avoid collisions and can even be killed. We have just one bird and want more control over the landing locations, so we'll make a change to use our <code class="literal">BirdController</code> rather than the <code class="literal">lb_BirdController</code> in the package.</p><p>Open the <code class="literal">lb_Bird.cs</code> file (attached to <code class="literal">Bluejay</code>) and modify it as follows:</p><p>Replace the definition of <code class="literal">controller</code> to be our <code class="literal">BirdController</code>:</p><pre class="programlisting">// lb_BirdController controller; // removed
public BirdController controller; // added</pre><p>Comment out or remove the  <code class="literal">SetController </code>function:</p><pre class="programlisting">// remove this
// void SetController(lb_BirdController cont){
//     controller = cont;
// }</pre><p>Save it. In Unity, drag the <code class="literal">BirdController</code> object onto the <strong class="userinput"><code>Bluejay</code></strong>'s <strong class="userinput"><code>LB_Bird Controller</code></strong> slot.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec161"></a>Fly away!</h3></div></div></div><p>Now, we'll add the BirdController as an <span>Animation</span><a id="id325553164" class="indexterm"></a> Track in our Timeline. The AnimIndex parameter is an integer value that will step up in value along the timeline. We want to Bluejay to start learning to fly around 80 seconds, and jump from location to location about 10 seconds apart (80, 90, 100, 110, 120, and away at 130).</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Open the <strong class="userinput"><code>Timeline Editor</code></strong> window for the <code class="literal">BlackbirdDirector</code>.</li><li>Drag the <code class="literal">BirdController</code> object from <strong class="userinput"><code>Hierarchy</code></strong> onto the <strong class="userinput"><code>Timeline</code></strong>, adding a new <strong class="userinput"><code>Animation Track.</code></strong></li><li>Press its red <strong class="userinput"><code>Record</code></strong> button.</li><li>Select the <code class="literal">BirdController</code> in <strong class="userinput"><code>Hierarchy.</code></strong></li><li>Move the <strong class="userinput"><code>Playhead</code></strong> to <code class="literal">80</code>, and in <strong class="userinput"><code>Inspector</code></strong>, set <strong class="userinput"><code>Anim Index</code></strong> to <code class="literal">1</code>.</li><li>Move the <strong class="userinput"><code>Playhead</code></strong> to <code class="literal">90</code> and set <strong class="userinput"><code>Anim Index</code></strong> to <code class="literal">2</code>.</li><li>Continue for the other indexes <code class="literal">3</code> through <code class="literal">6</code>.</li><li>Press the red <strong class="userinput"><code>Record</code></strong> button again to stop recording.</li><li>Preview the curve. If it doesn't start at 0 (prior to 80s), use <strong class="userinput"><code>Edit in Animation Window</code></strong> and add another Keyframe with value <code class="literal">0</code>.</li></ol></div><p>The <strong class="userinput"><code>Animation Track</code></strong> curve for the <strong class="userinput"><code>Anim Index</code></strong> parameter is shown here, simply incrementing by one at each keyframe:</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/832bedcd-5d9c-4039-9510-e1c6ab26ff2c.png" /></div><p><strong class="userinput"><code>Play</code></strong> it through. Wow! The bird flies from rock to rock, and eventually flies away!</p><p>You can adjust the bird's path and timing between landings by moving the location objects and the animation curve keyframes, respectively. You could also try animating the BirdController's <strong class="userinput"><code>Bird Scale</code></strong> parameter to make the bird increasingly more bold and strong as it learns to fly. A screen capture is given here with the bird flying and leaves falling:</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/948b4857-6269-415a-a4b4-23c8215fc5d0.png" /></div><p>We have a completed story. To wrap this up, let's add a little bit of interactivity, so the player can control when the story begins playing.</p></div></div>