<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch13lvl1sec112"></a>Optimizing your art</h2></div></div><hr /></div><p>Some decisions that impact performance the <span>most</span><a id="id325317274" class="indexterm"></a> are your intentionally creative ones. Maybe you want hyper-realistic graphics with high-fidelity sound because <span class="emphasis"><em>its gotta be so awesome!</em></span> Realizing you must dial that down may constitute a difficult design compromise. However, it's also likely that with a little creative <span class="emphasis"><em>outside-the-box</em></span> thinking and experimentation, you can achieve (nearly) identical visual results with much better performance. The one thing that you have most control over in your project is the content of your scenes. </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip130"></a>Note</h3><p>Quality is not only how it looks, but also how it feels. Optimizing for user experience is as fundamental a design decision as any.</p></div><p>In general, try to minimize the number of vertices and faces in your model's meshes. Avoid complex meshes. Remove faces that will never be seen, such as the ones inside of solid objects. Clean up duplicate vertices and remove doubles. This will most likely be done in the same 3D modeling application you used to create them in the first place. For example, Blender has the tools for this. Also, there are third-party tools that you can purchase to simplify model meshes.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note131"></a>Note</h3><p>Be sure to check out Unity's Import Settings for your FBX models. There are option to compress and optimize your meshes, for example. See <a class="ulink" href="https://docs.unity3d.com/Manual/FBXImporter-Model.html" target="_blank">https://docs.unity3d.com/Manual/FBXImporter-Model.html</a>.</p></div><p>Let's demonstrate what we mean. We are going to set up a <span>scene</span><a id="id325317309" class="indexterm"></a> with a high polygon count model, replicate that model 1000 times, examine it in the Profiler, and try some optimization techniques.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch13lvl2sec187"></a>Setting up the scene</h3></div></div></div><p>To begin, we'll need a high-poly model. We found one of a pair of sunglasses on Turbosquid with over 5,800 triangles, and which includes a transparent material for the lenses (<a class="ulink" href="https://www.turbosquid.com/3d-models/3ds-sunglasses-blender/764082" target="_blank">https://www.turbosquid.com/3d-models/3ds-sunglasses-blender/764082</a>). Please download the FBX file now. A copy is also included with the files for this book, for convenience. We will refer to this as <code class="literal">Sunglasses-original.fbx</code> to distinguish it from other versions we'll modify along the way.</p><p>Then, go into Unity, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Create a new scene (<strong class="userinput"><code>File</code></strong> | <strong class="userinput"><code>New Scene</code></strong>), then save it (<strong class="userinput"><code>File</code></strong> | <strong class="userinput"><code>Save <span>Scene</span><a id="id325549825" class="indexterm"></a> As</code></strong>) and name it <code class="literal">Optimization</code></li><li>Import the model into your <strong class="userinput"><code>Project</code></strong><code class="literal">Assets Models</code> folder (<strong class="userinput"><code>Assets</code></strong> | <strong class="userinput"><code>Import New Asset</code></strong>)</li><li>Create a ground plane for reference (<strong class="userinput"><code>Create</code></strong> | <strong class="userinput"><code>3D  Object</code></strong> | <strong class="userinput"><code>Plane</code></strong>), named <code class="literal">Ground Plane</code>, reset its <strong class="userinput"><code>Transform</code></strong>, and create or assign it a material with a neutral color (such as our <code class="literal">Ground Material</code> with <strong class="userinput"><code>Albedo</code></strong><code class="literal">#908070FF</code>)</li><li>Create a cube (<strong class="userinput"><code>Create</code></strong> | <strong class="userinput"><code>3D Object</code></strong> | <strong class="userinput"><code>Cube</code></strong>), <strong class="userinput"><code>Positioned</code></strong> at (<code class="literal">-1, 1, 1</code>), and give it a colored material (such as  our <code class="literal">Red Material</code> with <strong class="userinput"><code>Albedo</code></strong> <code class="literal">#E52A2AFF</code>)</li><li>Move the <code class="literal">Main Camera</code> to <strong class="userinput"><code>Position</code></strong> (<code class="literal">0, 0.5, -2</code>)</li></ol></div><p>Now add a copy of the sunglasses:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Drag a copy of the <code class="literal">Sunglasses-original</code> model into the scene</li><li>Set its <strong class="userinput"><code>Position</code></strong> (<code class="literal">0, 1, 0</code>), <strong class="userinput"><code>Rotation</code></strong> (<code class="literal">90, 180, 15</code>), and <strong class="userinput"><code>Scale</code></strong> (<code class="literal">10, 10, 10</code>)</li></ol></div><p>As a baseline, let's look at its Stats and Profile, and make a note of the values:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In the <strong class="userinput"><code>Game</code></strong> window, press <strong class="userinput"><code>Stats</code></strong></li><li>Also, open the Profiler window (<strong class="userinput"><code>Window | Profile</code></strong>)</li><li>Press <strong class="userinput"><code>Play</code></strong></li></ol></div><p>The<strong class="userinput"><code>Game</code></strong>window has the following scene and Stats window, showing the graphics hovering around 420 FPS, CPU main 2.4ms, with 22.6k Tris:</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/bbdd6501-e981-457b-87af-02069ba73e22.png" /></div><p>The corresponding Profiler window is shown next. You can see in the Rendering timeline where I moved the HMD around:</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/8ea69679-56f1-48f8-882a-834da3549185.png" /></div><p>This scene is too simple to gather much in the way of meaningful statistics. Let's create 1000 copies of the sunglasses in the scene; follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Create an <strong class="userinput"><code>Empty</code></strong> game object and name it <code class="literal">SunglassesReplicator</code></li><li>Create a new C# script on it, named <code class="literal">SunglassesReplicator</code>, and write it as follows:</li></ol></div><pre class="programlisting">using UnityEngine;

public class SunglassesReplicator : MonoBehaviour
{
    public GameObject prefab;
    public Vector3Int dup = new Vector3Int(10, 10, 10);
    public Vector3 delta = new Vector3(2, 2, 2);

    void Start()
    {
        Vector3 position = transform.position;
        for (int ix = 0; ix &lt; dup.x; ix++)
        {
            for (int iy = 0; iy &lt; dup.y; iy++)
            {
                for (int iz = 0; iz &lt; dup.z; iz++)
                {
                    position.x = transform.position.x + ix * delta.x;
                    position.y = transform.position.y + iy * delta.y;
                    position.z = transform.position.z + iz * delta.z;
                    GameObject glasses = Instantiate(prefab);
                    glasses.transform.position = position;
                }
            }
        }
    }
}</pre><p>The script takes a <code class="literal">prefab</code> object and instantiates it the <code class="literal">dup</code> number of times (<code class="literal">10</code>) in each of the X, Y, and Z axes, offsetting each by <code class="literal">delta</code> units (<code class="literal">2</code>), generating a total of 1000 instances of the prefab.</p><p>Save the script, then back in Unity, set up and assign the replicator parameters as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Make a prefab of your sunglasses. Drag the <code class="literal">Sunglasses-original</code> from <strong class="userinput"><code>Hierarchy</code></strong> into your <strong class="userinput"><code>Project</code></strong><code class="literal">Assets prefabs</code> folder </li><li>Select the <code class="literal">SunglassesReplicator</code> in <strong class="userinput"><code>Hierarchy</code></strong> again and drag the prefab from <strong class="userinput"><code>Project Assets</code></strong> onto its <strong class="userinput"><code>Prefab</code></strong> slot</li><li>Set the <code class="literal">SunglassesReplicator</code> <strong class="userinput"><code>Position</code></strong> to (<code class="literal">-10, 1, 0</code>) as the origin of our stack of sunglasses</li></ol></div><p>Press <strong class="userinput"><code>Play</code></strong> and the generated sunglasses Borg is shown in the <strong class="userinput"><code><span>Scene</span><a id="id325577558" class="indexterm"></a></code></strong> window:</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/3e129c68-50c4-4f50-bce7-c2b7558f9c11.png" /></div><p>The Stats now report over 36 million tris and a frame rate under 60 FPS. Ugh! The corresponding Profiler timeline is shown here:</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/264e59fe-b39b-4227-af8d-29686339cd5c.png" /></div><p>OK, now that we have a poorly performing scene, let's see what we can do about it.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch13lvl2sec188"></a>Decimating models</h3></div></div></div><p>One thing we can do is try to simplify the <span>models</span><a id="id325577594" class="indexterm"></a> that we imported into Unity. If you select the <code class="literal">SunGlasses-original</code> object in your <strong class="userinput"><code>Project Assets</code></strong>, you can see it consists of two meshes: the <code class="literal">Frame</code> with 4176 tris, and the <code class="literal">Lens</code> with 1664 tris. We should reduce the number of faces on the mesh, or <span class="emphasis"><em>decimate</em></span> the model. Presently, we will use the separate free and open source Blender application (<a class="ulink" href="https://docs.unity3d.com/Manual/LevelOfDetail.html" target="_blank">https://www.blender.org/</a>).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note132"></a>Note</h3><p>Note that the original FBX file of this model downloaded from Turbosquid is in FBX 6 ASCII format, which is not compatible with Blender 2.7+. The version of the file provided with this book was converted using Autodesk FBX Converter 2013 (<a class="ulink" href="http://usa.autodesk.com/adsk/servlet/pc/item?siteID=123112&amp;id=22694909" target="_blank">http://usa.autodesk.com/adsk/servlet/pc/item?siteID=123112&amp;id=22694909</a>).</p></div><p>Follow these steps to decimate the model in Blender:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Open Blender, and delete all to clear the default scene (keyboard <strong class="userinput"><code>A</code></strong> |<strong class="userinput"><code> A</code></strong> again | <strong class="userinput"><code>X</code></strong> | <strong class="userinput"><code>Delete</code></strong>)</li><li>Import the source Sunglasses fbx file (<strong class="userinput"><code>File | Import | FBX</code></strong>)</li><li>Select the sunglasses' frame model mesh (right-click)</li><li>On the right, choose the <strong class="userinput"><code>Modify</code></strong> tool (wrench icon)</li><li>Select <strong class="userinput"><code>Add Modifier | Decimate</code></strong></li><li>Set <strong class="userinput"><code>Ratio</code></strong> to <code class="literal">0.1</code>, as shown here:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788478809/graphics/fd63f9dd-25db-42f0-952c-f88346a82320.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>Then, press <strong class="userinput"><code>Apply</code></strong></li><li>Select the sunglass' lens model mesh (right-click)</li><li>Decimate it also to <strong class="userinput"><code>Ratio</code></strong><code class="literal">0.1</code> and <strong class="userinput"><code>Apply</code></strong></li><li>Delete the camera, light, and background objects (select with mouse, keyboard <strong class="userinput"><code>X</code></strong> to delete)</li><li>Export as FBX (<strong class="userinput"><code>File | Export | FBX</code></strong>) and give it a new name, such as <code class="literal">SunGlasses-decimated.fbx</code></li></ol></div><p>Now back in Unity, import the model and use it in our replicator as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Import the new <code class="literal">SunGlasses-decimated.fbx</code> file (<strong class="userinput"><code>Assets | Import New Asset</code></strong>) into your <code class="literal">Models</code> folder</li><li>Drag a copy of this model, <code class="literal">SunGlasses-decimated</code>, into the scene</li><li>Copy/paste the transform from the original (using Transform <strong class="userinput"><code>Copy Component</code></strong> from the original, and <strong class="userinput"><code>Paste Component Values</code></strong> on the decimated version)</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Save this as a prefab (drag <code class="literal">SunGlasses-decimated</code> from <strong class="userinput"><code>Hierarchy</code></strong> into your <strong class="userinput"><code>Project</code></strong><code class="literal">Assets Prefabs</code> folder)</li><li>Set this one in the <code class="literal">SunglassesReplicator</code> (drag the prefab from <strong class="userinput"><code>Project Assets</code></strong> onto the replicator's <strong class="userinput"><code>Prefab</code></strong> slot)</li></ol></div><p>Press <strong class="userinput"><code>Play</code></strong> and as expected, we are now running about 3.4M tris, about 10% of  what we had before, and we've boosted the FPS some, consistently more than 60 FPS. Better, but not good enough.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch13lvl2sec189"></a>Transparent materials</h3></div></div></div><p>Another killer of graphics processing and <span>frame</span><a id="id325552169" class="indexterm"></a> rate is the use of transparency and other rendering techniques that require each pixel to be rendered multiple times. For the sunglasses lens to appear transparent, Unity will render the solid objects behind it first, then render the semi-transparent lens pixels on top, effectively merging the pixel values. Possibly dozens of lenses stacked in front of one another causes a considerable amount of processing work. </p><p>Let's see what happens when we replace the transparent lens material with an opaque one:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In your <strong class="userinput"><code>Project</code></strong><code class="literal">Assets Materials</code> folder, create a new <strong class="userinput"><code>Material</code></strong> and name it <code class="literal">Lens_Opaque</code></li><li>For its <strong class="userinput"><code>Albedo</code></strong> color, choose an opaque gray, such as <code class="literal">#333333FF</code></li><li>Drag a copy of <code class="literal">Sunglasses-source</code> to <strong class="userinput"><code>Hierarchy</code></strong> and rename it <code class="literal">Sunglasses-opaque</code></li><li>Unfold it and select the <code class="literal">Lens</code> child object</li><li>Drag the <code class="literal">Lens_Opaque</code> material onto the Lens</li><li>Select the <code class="literal">Sunglasses-opaque</code> and drag it into the <code class="literal">Prefabs</code> folder, creating a new prefab </li><li>With <code class="literal">SunglassesReplicator</code> selected, drag the <code class="literal">Sunglasses-opaque</code> prefab onto its <strong class="userinput"><code>Prefab</code></strong> slot</li></ol></div><p>When you press <strong class="userinput"><code>Play</code></strong> now, we have 1000 of the opaque sunglasses and we get a much better frame rate, about 80 FPS.</p><p>What happens if we combine these two techniques? Let's use the opaque material on the decimated lenses. Like we just did, create another version of the prefab, named <code class="literal">Sunglasses-decimated-opaque</code>, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Drag a copy of <code class="literal">Sunglasses-decimated</code> to Hierarchy and rename it <code class="literal">Sunglasses-decimated-opaque</code></li><li>Unfold it and select the <code class="literal">Lens</code> child object</li><li>Drag the <code class="literal">Lens_Opaque</code> material onto the Lens</li><li>Select the <code class="literal">Sunglasses-decimated-opaque</code> and drag it into the <code class="literal">Prefabs</code> folder, creating a new prefab with the opaque lenses</li><li>With <code class="literal">SunglassesReplicator</code> selected, drag the <code class="literal">Sunglasses-decimated-opaque</code> prefab onto its <strong class="userinput"><code>Prefab</code></strong> slot</li></ol></div><p>Pressing <strong class="userinput"><code>Play</code></strong> we consistently get about 100 FPS, as shown in the <strong class="userinput"><code>Profiler</code></strong> timeline:</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/9cb08021-1630-4bc4-b5a3-94e64d5a3f4a.png" /></div><p>Terrific! We have the frame rate we want. But... that's not the look we want either. We have opaque lenses, but we expect translucent ones. And, disappointingly, the low poly versions of the glasses look... low poly. That's just not acceptable. Perhaps there's a compromise.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch13lvl2sec190"></a>Levels of detail</h3></div></div></div><p>Reviewing our scene, we realize that the high-poly <span>sunglasses</span><a id="id325552362" class="indexterm"></a> are really only needed for the ones closest to you. As they recede further into the distance, the low-poly version is just fine. Likewise, the transparency on the lenses is really mostly needed on the ones near you. The sunglasses in the distance, and those occluded by other glasses, do not really need transparency. Unity understands this and provides a component to automatically <span>manage</span><a id="id325552372" class="indexterm"></a> levels of detail, called <span class="strong"><strong>LOD Group</strong></span> (see <a class="ulink" href="https://docs.unity3d.com/Manual/LevelOfDetail.html" target="_blank">https://docs.unity3d.com/Manual/LevelOfDetail.html</a>).</p><p>Let's use this now. We'll create a group of sunglasses, with each of our versions for levels of detail:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In <strong class="userinput"><code>Hierarchy</code></strong>, create an <strong class="userinput"><code>Empty</code></strong> game object, name it <code class="literal">SunglassesLOD</code>, and reset its <strong class="userinput"><code>Transform</code></strong></li><li>Drag a copy of the <code class="literal">Sunglasses-original</code> prefab as a child of <code class="literal">SunglassesLOD</code></li><li>Drag a copy of the <code class="literal">Sunglasses-decimated</code> prefab as a child also</li><li>And drag a copy of the <code class="literal">Sunglasses-decimated-opaque</code> too</li><li>Select the parent <code class="literal">Sunglasses</code> object and <strong class="userinput"><code>Add Component | LOD Group</code></strong></li></ol></div><p>Look at the LOD Group component in Inspector. Notice it has several ranges for when to use each model based on camera distance, labeled <strong class="userinput"><code>LOD0</code></strong>, <strong class="userinput"><code>LOD1</code></strong>, and <strong class="userinput"><code>LOD2</code></strong>. The range is a percentage of the object's bounding box height relative to the screen height. When closest, the LOD0 objects are active. Further away, those will be deactivated and the LOD1 ones will be active, and so on.</p><p>Let's assign the LOD groups now:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Select <strong class="userinput"><code>LOD0</code></strong></li><li>Drag the <code class="literal">Sunglasses-original</code> game object from <strong class="userinput"><code>Hierarchy</code></strong> onto the <strong class="userinput"><code>Add</code></strong> button</li><li>Select <strong class="userinput"><code>LOD1</code></strong></li><li>Drag the <code class="literal">Sunglasses-decimated</code> game object onto the <strong class="userinput"><code>Add</code></strong> button</li><li>Select <strong class="userinput"><code>LOD2</code></strong></li><li>Drag the <code class="literal">Sunglasses-decimated-opaque</code> object onto <strong class="userinput"><code>Add</code></strong> also</li></ol></div><p>A screen capture of the <strong class="userinput"><code>Inspector</code></strong> is shown here:</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/09f3c2d3-81a8-4b9e-85f5-b86d3965e8a9.png" /></div><p>Notice there is a little camera icon on the top edge of the LODn groups. You  can select and slide it across to preview the LOD activations based on camera distance. You can also configure the active range of each LOD (percentage) by sliding the edge of each area box. </p><p>Now, let's try it in our scene:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Drag the <code class="literal">SunglassesLOD</code> object into your <strong class="userinput"><code>Project Prefabs</code></strong> folder</li><li>Select <code class="literal">SunglassesReplicator</code> in <strong class="userinput"><code>Hierarchy</code></strong> and drag the <code class="literal">SunglassesLOD</code> prefab onto its <strong class="userinput"><code>Prefab</code></strong> slot</li></ol></div><p>Press <strong class="userinput"><code>Play</code></strong>. The <strong class="userinput"><code>Profiler</code></strong> timeline is shown next. There's essentially no difference from our most optimized version, but we get the high-poly models and transparent lenses when we need them:</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/cded9e58-ad83-4c61-a684-49769d82c91c.png" /></div><p>Next is a screen capture of the Game view using SunglassesLOD. Closest to us are the high-poly glasses. The middle are low-poly, but with transparent lenses. Further <span>away</span><a id="id325552565" class="indexterm"></a> are low-poly and opaque <span>versions</span><a id="id325552574" class="indexterm"></a> of the model:</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/3a914a29-d7c3-44a0-90ec-c401c46c918b.png" /></div><p></p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note133"></a>Note</h3><p>There are a number LOD tools available in the Unity Asset Store to help manage levels of detail and even generate decimated meshes from your models. Unity itself is toying with such a tool, AutoLOD, available free on GitHub (<a class="ulink" href="https://blogs.unity3d.com/2018/01/12/unity-labs-autolod-experimenting-with-automatic-performance-improvements/" target="_blank">https://blogs.unity3d.com/2018/01/12/unity-labs-autolod-experimenting-with-automatic-performance-improvements/</a>). </p></div></div></div>