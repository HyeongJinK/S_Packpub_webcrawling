<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec76"></a>Juicing the scene</h2></div></div><hr /></div><p>Having the basic <span>mechanics</span><a id="id325317294" class="indexterm"></a> implemented, we can now <span class="emphasis"><em>juice it</em></span>! One of my favorite VR games is the popular Audio Shield (<a class="ulink" href="http://audio-shield.com/" target="_blank">http://audio-shield.com/</a>). We're almost there building our own, we just need to add fireballs, a compelling environment scene, and synchronizing the fireball shots with music! </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note82"></a>Note</h3><p>The term <span class="emphasis"><em>juice it</em></span> for game design was popularized by Jonasson and Purho in their presentation talk from 2012,  <span class="emphasis"><em>Juice it or lose it - a talk by Martin Jonasson &amp; Petri Purho</em></span> (<a class="ulink" href="https://www.youtube.com/watch?v=Fy0aCDmgnxg" target="_blank">https://www.youtube.com/watch?v=Fy0aCDmgnxg</a>). </p><div class="blockquote"><blockquote class="blockquote"><p>A juicy game feels alive and responds to everything you do, tons of cascading action and response for minimal user input.</p></blockquote></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec113"></a>Great balls of fire</h3></div></div></div><p>In the previous section, we disabled <strong class="userinput"><code>Use Gravity</code></strong> on the <span>shooting</span><a id="id325552564" class="indexterm"></a> balls. We did this in anticipation of changing the balls from being bouncy balls to balls of fire. Let's make that magic happen now. We will use the Particle System to render it instead of mesh geometry.</p><p>There are a lot of ways to get particle effects into your Unity project. If you recall, in <a class="link" href="#" linkend="ch04"><span>Chapter 4</span></a>, <span class="emphasis"><em>Gaze-Based Control</em></span>, we added a water hose, spark emitter, and explosion effects from the <code class="literal">Unity Standard Assets</code> package. Here, we'll build our own, but use one of the materials, <code class="literal">ParticleFireCloud</code>, provided with the package. In the Unity Asset Store, you can find many offerings of particle effects and system enhancements too.</p><p>First, make a new prefab derived from ShooterBall, named <code class="literal">FireBall</code>, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Drag a copy of <code class="literal">ShooterBall</code> prefab from the <code class="literal">Project</code> folder into <strong class="userinput"><code>Hierarchy</code></strong></li><li>Rename it FireBall</li><li>Drag <strong class="userinput"><code>FireBall</code></strong> into the <code class="literal">Project</code><span class="emphasis"><em>Prefabs</em></span> folder to create a new prefab</li><li>Select the <code class="literal">GameController</code> from <strong class="userinput"><code>Hierarchy</code></strong></li><li>Drag the <code class="literal">FireBall</code> prefab from <code class="literal">Project</code><span class="emphasis"><em>Prefabs</em></span> folder onto the <strong class="userinput"><code>Object Pooler Prefab</code></strong> slot</li></ol></div><p>OK, now we can add the particle system:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Select the <strong class="userinput"><code>FireBall</code></strong> from <strong class="userinput"><code>Hierarchy</code></strong></li><li>Disable its <strong class="userinput"><code>Mesh Renderer</code></strong>, as we will render it with particles instead</li><li>Right-click <strong class="userinput"><code>FireBall</code></strong> and select <strong class="userinput"><code>Create</code></strong> | <strong class="userinput"><code>Effects</code></strong> | <strong class="userinput"><code>Particle System</code></strong></li><li>Rename it Fireball Particle System</li></ol></div><p>There are a lot of details in working with particles, many options and configuration parameters. As we step through this quick implementation of fireballs, observe the effects of each change as we make them one at a time. Note that you can preview the particle effects in the <strong class="userinput"><code>Scene</code></strong> window. Feel free to experiment on your own.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>First, at the bottom of the Particle System <strong class="userinput"><code>Inspector</code></strong>, find the <strong class="userinput"><code>Renderer</code></strong> panel. In its <strong class="userinput"><code>Material</code></strong> slot, click the <strong class="userinput"><code>doughnut icon</code></strong> and choose the <strong class="userinput"><code>ParticleFireCloud</code></strong> material (located in <code class="literal">Standard Assets/Particle Systems/Materials</code>. If not present, you may need to import it using <strong class="userinput"><code>Assets</code></strong> | <strong class="userinput"><code>Import Package</code></strong> | <strong class="userinput"><code>ParticleSystems</code></strong>).</li><li>Near the top of the Particle System inspector, find the <strong class="userinput"><code>Shape</code></strong> panel. Select <strong class="userinput"><code>Shape: Sphere</code></strong>, and set its <strong class="userinput"><code>Radius</code></strong> to <code class="literal">0.1</code>.</li><li>Find the <strong class="userinput"><code>Emission</code></strong> panel, and set <strong class="userinput"><code>Rate of Time</code></strong> to <code class="literal">15</code>.</li><li>At the top of the inspector, set <strong class="userinput"><code>Duration</code></strong>: <code class="literal">2.00</code>.</li><li><strong class="userinput"><code>Start Lifetime</code></strong>: <code class="literal">1</code>.</li><li><strong class="userinput"><code>Start Speed</code></strong>: <code class="literal">0</code>.</li><li><strong class="userinput"><code>Start Size</code></strong>: <code class="literal">0.5</code>.</li></ol></div><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>For <strong class="userinput"><code>Start Rotation</code></strong>, click the <strong class="userinput"><code>selector icon</code></strong> on the right and choose <strong class="userinput"><code>Random Between Two Curves</code></strong>. Then click the slot and scroll to the <strong class="userinput"><code>Curve Editor</code></strong> at the bottom of the Inspector. If you're not familiar, the editor can take some getting used to. Choose a full range of values from <code class="literal">180</code> (at top of graph) to <code class="literal">-180</code> (bottom of graph), as shown:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788478809/graphics/f4a91da7-41a3-4e16-8f8e-f4a2736c3ba3.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Enable <strong class="userinput"><code>Color Over Lifetime</code></strong> and click the slot to open its <strong class="userinput"><code>Gradient Editor</code></strong>. We want to adjust the <strong class="userinput"><code>Alpha</code></strong> curve so it starts at <strong class="userinput"><code>Alpha</code></strong><code class="literal">0</code> at <strong class="userinput"><code>Location</code></strong><code class="literal">0%</code>, then becomes <strong class="userinput"><code>Alpha</code></strong><code class="literal">255</code> at <code class="literal">10%</code>, then fades out over time back to <strong class="userinput"><code>Alpha</code></strong><code class="literal">0</code> at <code class="literal">100%</code>. The editor is shown here:</li></ol></div><p></p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/b75e9c92-390a-4793-8a25-6fcef513aada.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>Set the <strong class="userinput"><code>Start Color</code></strong>, as <strong class="userinput"><code>Gradient</code></strong> (right-side selector) and then pick a range of colors such as yellow to red, as shown here:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788478809/graphics/e15d46f7-595c-4eba-b115-980f0e80eab9.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="11" type="1"><li>Next, set the <strong class="userinput"><code>Velocity Over Lifetime</code></strong>, using <strong class="userinput"><code>Random Between Two Curves</code></strong>. For each <strong class="userinput"><code>X, Y, Z</code></strong>, use the <strong class="userinput"><code>Curve Editor</code></strong> to set max and min values of <code class="literal">0.05</code> and <code class="literal">-0.05</code> respectively. (You can modify the vertical axis of the graph by clicking the axis label and typing a number; you can copy curves, for example, by right-clicking the Z slot, choosing <strong class="userinput"><code>Copy</code></strong>, then right-clicking the Y slot and choosing <strong class="userinput"><code>Paste.</code></strong>)</li></ol></div><p>At this point, we should adjust the fireball so it's about the same size as our original BouncyBall. To check:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Re-enable the FireBall's <strong class="userinput"><code>Mesh Renderer</code></strong>. Adjust the particle system by changing the Renderer's <strong class="userinput"><code>Max Particle Size</code></strong> to <code class="literal">0.1</code>, or using the <strong class="userinput"><code>Transform Scale</code></strong> </li><li>Save your work by selecting <strong class="userinput"><code>Apply</code></strong> at the top of Inspector, to update your prefab</li></ol></div><p>Now when you press <strong class="userinput"><code>Play</code></strong>, the Shooters will fire FireBalls. <span class="emphasis"><em>Oh wow!</em></span></p><p>If you'd like to add some sparkle effect to the fireball, we can do that with the <strong class="userinput"><code>Trail</code></strong> panel:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Enable the <strong class="userinput"><code>Trail</code></strong> panel</li><li>A warning may pop up tell you to add a trails material to the <strong class="userinput"><code>Renderer</code></strong></li><li>In the <strong class="userinput"><code>Renderer</code></strong> panel, select the <strong class="userinput"><code>doughnut icon</code></strong> on the <strong class="userinput"><code>Trail Material</code></strong> slot, and choose <strong class="userinput"><code>ParticleFireCloud</code></strong> as we use for the main fireball</li></ol></div><p>Speaking of trails, if you'd like to also implement trail effects on the fireball, there are several ways to do this too.  A quick solution is to duplicate our fireball particle system and modify it to use a Cone shape instead of Sphere, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Select the <strong class="userinput"><code>Fireball Particle System</code></strong> in <strong class="userinput"><code>Hierarchy.</code></strong></li><li>Right-click to <strong class="userinput"><code>Duplicate</code></strong>, move the duplicate as a child of Fireball Particle System and name it Trail Particle System.</li><li>Change its <strong class="userinput"><code>Shape</code></strong> to <strong class="userinput"><code>Cone.</code></strong></li><li>Change its <strong class="userinput"><code>Velocity Over Lifetime</code></strong>. The <strong class="userinput"><code>Z</code></strong> curve needs a higher value range, such as <code class="literal">0.75</code> to <code class="literal">0.25</code>. </li><li>The <strong class="userinput"><code>X</code></strong> and <strong class="userinput"><code>Y</code></strong> velocity curves should be smaller for some variation, such as <code class="literal">0.2</code> to <code class="literal">-0.2</code>.</li><li>Set the <strong class="userinput"><code>Size Over Lifetime</code></strong> range to <code class="literal">1.0</code> to <code class="literal">0.5</code>.</li><li>In its Transform, set <strong class="userinput"><code>Position</code></strong> to (<code class="literal">0</code>, <code class="literal">0</code>, <code class="literal">0.5</code>) to give it an extra tail.</li></ol></div><p>Here is a screenshot of the gameplay <span>window</span><a id="id325577960" class="indexterm"></a> paddling an incoming fireball!</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/f677ab59-0cd4-474f-85d4-da65e788e5a6.png" /></div><p> </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note83"></a>Note</h3><p>Special thanks to Tyler Wissler for his instructional video <span class="emphasis"><em>How To: Basic Fireballs in Unity</em></span> (June 2014), which was very helpful is developing this topic (<a class="ulink" href="https://www.youtube.com/watch?v=OWShSR6Tr50" target="_blank">https://www.youtube.com/watch?v=OWShSR6Tr50</a>).</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec114"></a>Skull environment</h3></div></div></div><p>To spice up our game, even more, we <span>should</span><a id="id325577998" class="indexterm"></a> find an exciting environment <span>and</span><a id="id325578008" class="indexterm"></a> scene. Searching the Asset Store, I found the <span class="emphasis"><em>Skull Platform</em></span> free asset (<a class="ulink" href="https://assetstore.unity.com/packages/3d/props/skull-platform-105664" target="_blank">https://assetstore.unity.com/packages/3d/props/skull-platform-105664</a>). You can use it too, or find something different.</p><p>Assuming you've found and installed the Skull Platform asset, we'll add it to our scene. First, let's render our target as a skull:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Drag <strong class="userinput"><code>Platform_Skull_o1</code></strong> as a child of <strong class="userinput"><code>Target</code></strong> (under <code class="literal">TargetWall</code>).</li><li>Set its <strong class="userinput"><code>Transform Rotation</code></strong> (<code class="literal">0</code>, <code class="literal">0</code>, <code class="literal">180</code>) and <strong class="userinput"><code>Scale</code></strong> (<code class="literal">0.3</code>, <code class="literal">0.3</code>, <code class="literal">0.3</code>).</li><li>Select the <strong class="userinput"><code>Target</code></strong> and disable its <strong class="userinput"><code>Mesh Renderer</code></strong>.</li><li>Also, create a new Spotlight (<strong class="userinput"><code>Create</code></strong> | <strong class="userinput"><code>Light</code></strong> | <strong class="userinput"><code>Spotlight</code></strong>) to shine on the skull. As a child of Target, I used the following settings: <strong class="userinput"><code>Position</code></strong> (<code class="literal">-1</code>, <code class="literal">-30</code>, <code class="literal">-0.6</code>), <strong class="userinput"><code>Rotation</code></strong> (<code class="literal">-60</code>, <code class="literal">60</code>, <code class="literal">0</code>), <strong class="userinput"><code>Range</code></strong>: <code class="literal">10</code>, <strong class="userinput"><code>Spot Angle</code></strong>: <code class="literal">30</code>, <strong class="userinput"><code>Color</code></strong>: <code class="literal">#FFE5D4FF</code>, <strong class="userinput"><code>Intensity</code></strong>: <code class="literal">3</code>.</li></ol></div><p>Next, let's add the big platform as a backdrop behind the wall. The quickest way is to merge in the Demoscene they provide:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Create an <strong class="userinput"><code>Empty</code></strong> game object in the <strong class="userinput"><code>Hierarchy</code></strong> root, name it SkullPlatform, reset its transform.</li><li>Drag a copy of the Skull Platform's demo scene named <strong class="userinput"><code>Platform</code></strong> (<code class="literal">Assets/Skull Platform/Demo/</code> folder) into the <strong class="userinput"><code>Hierarchy.</code></strong></li><li>Select the Demo's <strong class="userinput"><code>Scene</code></strong>, <strong class="userinput"><code>Lighting</code></strong>, and <strong class="userinput"><code>Particles</code></strong> objects and drag them as children of <strong class="userinput"><code>SkullPlatform.</code></strong></li><li>Now that we have the assets we want, right-click the <strong class="userinput"><code>Platform</code></strong> scene in Hierarchy and choose <strong class="userinput"><code>Remove Scene</code></strong>. When prompted, choose <strong class="userinput"><code>Don't Save</code></strong>.</li><li>Set the SkullPlatform <strong class="userinput"><code>Position</code></strong> to (<code class="literal">0</code>, <code class="literal">-1.5</code>, <code class="literal">0</code>) so it's just below the ground plane.</li><li>Select the <strong class="userinput"><code>GroundPlane</code></strong> and disable its <strong class="userinput"><code>Mesh Renderer</code></strong>.</li></ol></div><p> </p><p>Now, we'll set up the scene environment lighting:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Delete the <strong class="userinput"><code>Directional Light</code></strong> from the scene Hierarchy.</li><li>Open the <strong class="userinput"><code>Lighting</code></strong> window. If its not already a tab in your editor, use <strong class="userinput"><code>Window | Lighting</code></strong> | <strong class="userinput"><code>Settings</code></strong> and dock it next to the Inspector.</li><li>Set its <strong class="userinput"><code>Skybox Material</code></strong> to <strong class="userinput"><code>Sky</code></strong> (provided in the Skull Platform package).</li><li>In the <strong class="userinput"><code>Environmental Lighting</code></strong> section, set <strong class="userinput"><code>Source: Color </code></strong>to <code class="literal">#141415</code>.</li><li>Check the <strong class="userinput"><code>Fog</code></strong> checkbox (in <strong class="userinput"><code>Other Settings</code></strong>), <strong class="userinput"><code>Color</code></strong> to <code class="literal">#8194A1FF</code>, <strong class="userinput"><code>Mode: Exponential</code></strong>, and <strong class="userinput"><code>Density</code></strong> to 0.<code class="literal">03</code>.</li></ol></div><p>Here is a screen capture of the scene with the skull platform environment and lighting. <span class="emphasis"><em>Sweet!</em></span></p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/8f867025-b757-49a4-89ab-a59000a62103.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec115"></a>Audio synchronization</h3></div></div></div><p>We're almost there building <span>our</span><a id="id325552681" class="indexterm"></a> own version of Audio Shield, we just <span>need</span><a id="id325552690" class="indexterm"></a> to add synchronizing the fireball shots with music! </p><p>Unity provides an API for sampling audio source data, including <code class="literal">AudioSource.GetSpectrumData</code> and <code class="literal">GetOutputData</code>. Extracting actual beats in the music from this data is not trivial and requires a lot of math and some understanding of how music encoding works.</p><p>Fortunately, we found an open source script that <span>does</span><a id="id325552707" class="indexterm"></a> this for us, called Unity-Beat-Detection (<a class="ulink" href="https://github.com/allanpichardo/Unity-Beat-Detection" target="_blank">https://github.com/allanpichardo/Unity-Beat-Detection</a>). It conveniently provides Unity Events for <code class="literal">onBeat</code>, which we'll use. (It also provides  <code class="literal">onSpectrum</code> events, with music frequency bands per frame, which you could use too, for example, to change the color of the fireball or other things based on frequency bands.)</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Download the <code class="literal">AudioProcessor.cs</code> script from GitHub (we've provided a copy with the files for this book for your convenience)</li><li>Drag the file into your <code class="literal">Scripts</code> folder (or use <strong class="userinput"><code>Assets</code></strong> | <strong class="userinput"><code>Import New Asset</code></strong>)</li></ol></div><p>For your music, find any MP3 or WAV file that has a nice beat, and <span>import</span><a id="id325552752" class="indexterm"></a> it into your project. We looked on SoundCloud NoCopyrightSounds track (<a class="ulink" href="https://soundcloud.com/nocopyrightsounds/tracks" target="_blank">https://soundcloud.com/nocopyrightsounds/tracks</a>) to find one named <span class="emphasis"><em>Third Prototype - Dancefloor</em></span> (<a class="ulink" href="http://ncs.io/DancefloorNS" target="_blank">http://ncs.io/DancefloorNS</a>).</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In Project window, create a folder named Audio</li><li>Drag your music file into the Audio folder (or use <strong class="userinput"><code>Assets</code></strong> | <strong class="userinput"><code>Import New Asset</code></strong>)</li></ol></div><p>To implement this feature, we'll make a <strong class="userinput"><code>MusicController</code></strong> and then modify the <code class="literal">ShooterBallGame</code> script to use its beats to fireballs. In Unity, do the following:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In <strong class="userinput"><code>Hierarchy</code></strong>, create an <strong class="userinput"><code>Empty</code></strong> game object and name it MusicController</li><li>Add the <strong class="userinput"><code>AudioProcessor</code></strong> script as a component</li><li>Note that it automatically adds an <strong class="userinput"><code>Audio Source</code></strong> component too</li><li>Drag your imported music file onto <strong class="userinput"><code>AudioClip</code></strong> slot</li><li>Drag <strong class="userinput"><code>MusicController</code></strong> itself onto <strong class="userinput"><code>Audio Source</code></strong> slot</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip84"></a>Note</h3><p>Note the <strong class="userinput"><code>G Threshold</code></strong> parameter on <strong class="userinput"><code>Audio Process</code></strong>. You can use this to adjust the sensitivity of the beat recognition algorithm.</p></div><p>Now, update the <code class="literal">ShooterBallGame</code> script on <code class="literal">GameController</code> as follows:</p><pre class="programlisting">    void Start()
    {
        if (shootAt == null)
            shootAt = Camera.main.transform;
        pool = GetComponent&lt;ObjectPooler&gt;();

        AudioProcessor processor = FindObjectOfType&lt;AudioProcessor&gt;();
        processor.onBeat.AddListener(onBeatDetected);
    }

    void onBeatDetected()
    {
        if (Random.value &gt; 0.5f)
        {
            shooterId = 1;
            shooter = shooter1;
        } else
        {
            shooterId = 0;
            shooter = shooter0;
        }
        ShootBall();
    }</pre><p>It's very similar to the previous version, but instead of calling <code class="literal">ShootBall</code> from <code class="literal">Update</code>, based on the time interval, we call it from <code class="literal">onBeatDetected</code>. In <code class="literal">Start</code>, we add <code class="literal">onBeatDetected</code> as an <code class="literal">onBeat</code> event listener.</p><p>Also, we've decided to randomly decide which shooter to use rather than just alternating back and forth.</p><p>Press <strong class="userinput"><code>Play</code></strong> and go at it! <span class="emphasis"><em>Whoohoo,</em></span> we have our own version of Audio Shield! A screenshot of active gameplay is shown here:</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/2785d629-ecf0-4c55-b244-30c07d50d6bd.png" /></div><p></p></div></div>