<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch12lvl1sec108"></a>Using Oculus platform and avatars</h2></div></div><hr /></div><p>It is worthwhile, and fun, to mention at this point the rich platform networking tools provided by Oculus for their VR devices. As a Facebook organization, Oculus obviously has a keen interest in making VR an engaging social experience. With Oculus Platform SDK (<a class="ulink" href="https://developer.oculus.com/documentation/platform/latest/concepts/book-plat-sdk-intro/" target="_blank">https://developer.oculus.com/documentation/platform/latest/concepts/book-plat-sdk-intro/</a>), each user can create and use a personalized identity and avatar across Oculus games and apps, and find and connect with friends, all with a respectable degree of <span>security</span><a id="id325317278" class="indexterm"></a> and <span>authentication</span>. </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Oculus Platform SDK Intro (<a class="ulink" href="https://developer.oculus.com/documentation/platform/latest/concepts/book-plat-sdk-intro/" target="_blank">https://developer.oculus.com/documentation/platform/latest/concepts/book-plat-sdk-intro/</a>)</li><li style="list-style-type: disc">Oculus Platform <span>Getting</span><a id="id325317304" class="indexterm"></a> Started Guide (<a class="ulink" href="https://developer.oculus.com/documentation/platform/latest/concepts/book-pgsg/" target="_blank">https://developer.oculus.com/documentation/platform/latest/concepts/book-pgsg/</a>)</li><li style="list-style-type: disc">Oculus Avatar <span>Getting</span><a id="id325317319" class="indexterm"></a> Started Guide (<a class="ulink" href="https://developer.oculus.com/documentation/avatarsdk/latest/concepts/avatars-gsg-intro/" target="_blank">https://developer.oculus.com/documentation/avatarsdk/latest/concepts/avatars-gsg-intro/</a>)</li></ul></div><p>Along with the basic Unity integration SDK, the Oculus development ecosystem includes Oculus Rooms with match-making, 3D ambisonic audio, voice chat, lip sync, and their integrated Oculus Avatar system. </p><p>In <a class="link" href="#" linkend="ch03">Chapter 3</a>, <span class="emphasis"><em>VR Build and Run</em></span>, we included a section on <span class="emphasis"><em>Building for Oculus Rift</em></span>, where you may have set up your scene to include the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Add <code class="literal">Oculus</code> SDK to the <strong class="userinput"><code>Virtual Reality SDK</code></strong>s in <strong class="userinput"><code>Player Settings</code></strong></li><li style="list-style-type: disc">Import the <span class="emphasis"><em>Oculus Integration package</em></span> from the Asset Store, which installs an OVR folder in your Project Assets (<a class="ulink" href="https://assetstore.unity.com/packages/tools/integration/oculus-integration-82022" target="_blank">https://assetstore.unity.com/packages/tools/integration/oculus-integration-82022</a>)</li><li style="list-style-type: disc">Use the <code class="literal">OVRCameraRig</code> prefab instead of <code class="literal">Main Camera</code> in <code class="literal">MeMyselfEye</code></li></ul></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec181"></a>Oculus platform entitlement check</h3></div></div></div><p>To use the <span>Oculus</span><a id="id325581664" class="indexterm"></a> platform and cloud services, your app needs to be registered with Oculus.</p><p>Register your app in the Developer Center in order to obtain an App ID, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In your browser, go to <a class="ulink" href="https://dashboard.oculus.com/" target="_blank">https://dashboard.oculus.com/</a></li><li>Select <strong class="userinput"><code>Create New App</code></strong> and choose the device, <strong class="userinput"><code>GearVR</code></strong> or <strong class="userinput"><code>Oculus Rift</code></strong></li><li>Make a note of the <strong class="userinput"><code>App ID</code></strong> (copy into your clipboard), required to initialize the Platform SDK (if you need to revisit this page, it's located at <strong class="userinput"><code>Manage | your organization | your app | Getting Started API</code></strong>)</li><li>Create a Test User by navigating to <strong class="userinput"><code>Manage | your organization | Settings | Test Users</code></strong>, and <strong class="userinput"><code>Add Test User</code></strong></li></ol></div><p>Now in Unity, we need to configure your settings so it will pass the entitlement checks:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Select <strong class="userinput"><code>Oculus Platform | Edit Settings</code></strong> from the main menu</li><li>Paste your <strong class="userinput"><code>App ID</code></strong> into the corresponding slot in Inspector</li><li>Under the <strong class="userinput"><code>Unity Editor Settings</code></strong>, check the <strong class="userinput"><code>Use Standalone Platform</code></strong> checkbox, and enter the <strong class="userinput"><code>Test User Email</code></strong> and <strong class="userinput"><code>Password</code></strong> generated by Add Test User previously</li></ol></div><p>Setting <strong class="userinput"><code>Use Standalone Platform</code></strong> will bypass your credential's entitlement checks on the Oculus server when running in the Unity Editor. But otherwise, you need to add code for this to your project, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>On an object in your <strong class="userinput"><code>Hierarchy</code></strong>, such as <code class="literal">GameController</code>, create a script named <code class="literal">OculusEntitlementCheck</code></li><li>Write it as follows (derived from the Oculus docs):</li></ol></div><pre class="programlisting">using UnityEngine;
using Oculus.Platform;

public class OculusEntitlementCheck : MonoBehaviour
{
    void Awake()
    {
        try
        {
            Core.AsyncInitialize();
            Entitlements.IsUserEntitledToApplication().OnComplete(EntitlementCallback);
        }
        catch (UnityException e)
        {
            Debug.LogError("Oculus Platform failed to initialize due to 
                                                     exception.");
            Debug.LogException(e);
            // Immediately quit the application
            UnityEngine.Application.Quit();
        }
    }

    void EntitlementCallback(Message msg)
    {
        if (msg.IsError)
        {
            Debug.LogError("Oculus entitlement check FAILED.");
            UnityEngine.Application.Quit();
        }
        else
        {
            Debug.Log("Oculus entitlement passed.");
        }
    }
}</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec182"></a>Adding a local avatar</h3></div></div></div><p>Now, we'll add the <span>Oculus</span><a id="id325590374" class="indexterm"></a> Avatar to the scene for the local player. There are two avatar prefabs in the <strong class="userinput"><code>Project</code></strong><code class="literal">Assets/OvrAvatar</code> folder: one for the local user, which may show just the player's hands in first-person view, and one for the remote players. Note that the Oculus avatars will not appear in your Unity Scene window until you press play, as they are procedurally generated and (ordinarily) require a connection to the Oculus cloud server:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In <strong class="userinput"><code>Hierarchy</code></strong>, locate and unfold your <code class="literal">OVRCameraRig</code>. Notice it contains a child <code class="literal">TrackingSpace</code></li><li>From the <strong class="userinput"><code>Project Assets</code></strong><code class="literal">OvrAvatar/Content/Prefabs/</code> folder, drag the <code class="literal">LocalAvatar</code> into the <strong class="userinput"><code>Hierarchy</code></strong> as a child of <code class="literal">TrackingSpace</code></li><li>In Inspector, check the <strong class="userinput"><code>Start With Controllers</code></strong> checkbox</li><li>Check the <strong class="userinput"><code>Show First Person</code></strong> checkbox</li></ol></div><p>Press <strong class="userinput"><code>Play</code></strong>. You can now see your hands and controllers.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec183"></a>Adding remote avatars</h3></div></div></div><p>The Avatar SDK also uses the <span>Oculus</span><a id="id325552131" class="indexterm"></a> cloud services to get specific player's avatar settings and preferences. Set the <strong class="userinput"><code>App ID</code></strong> for the Avatar SDK, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Select <strong class="userinput"><code>Oculus Avatars | Edit Settings</code></strong> from the main menu</li><li>Paste your <strong class="userinput"><code>App ID</code></strong> into the corresponding slot in Inspector</li></ol></div><p>This may not really be necessary right now if you're OK with the default "blue" avatar, but we'll need it for <span>multiplayer</span><a id="id325552161" class="indexterm"></a> networking. According to the Oculus docs:</p><div class="blockquote"><blockquote class="blockquote"><p><span class="emphasis"><em>Note: You may ignore any <span class="strong"><strong>No Oculus Rift App ID</strong></span> warnings you see during development. While an App ID is required to retrieve Oculus avatars for specific users, you can prototype and test experiences that make use of Touch and Avatars with just the default blue avatar.</em></span></p></blockquote></div><p>To add other player's avatars, we'll use the Oculus RemoteAvatar prefab. We need to set it up for Unity Networking like we did previously with our handmade one, including a Network Identity and Network Transform. </p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In the <strong class="userinput"><code>Project Assets</code></strong> <code class="literal">OvrAvatar/Content/Prefabs/</code> folder, select the <code class="literal">RemoteAvatar</code> prefab</li><li>Choose  <strong class="userinput"><code>Add Component</code></strong> | <strong class="userinput"><code>Network</code></strong> | <strong class="userinput"><code>Network Identity</code></strong></li><li>Ensure the <strong class="userinput"><code>Local Player Authority</code></strong> checkbox is checked</li><li>Choose <strong class="userinput"><code>Add Component</code></strong> | <strong class="userinput"><code>Network</code></strong> | <strong class="userinput"><code>Network Transform</code></strong></li><li>Set <strong class="userinput"><code>Transform Sync Mode</code></strong> to <strong class="userinput"><code>Sync Transform</code></strong></li><li>Set <strong class="userinput"><code>Rotation Axis</code></strong> to <strong class="userinput"><code>XYZ (full 3D)</code></strong></li><li>Select <code class="literal">Network Manager</code> in <strong class="userinput"><code>Hierarchy</code></strong></li><li>Drag the <code class="literal">RemoteAvatar</code> onto the Network Manager's <strong class="userinput"><code>Player Prefab</code></strong> slot</li></ol></div><p>We can also modify the <code class="literal">AvatarMultiplayer</code> script we wrote previously, which moves the local player's avatar under the player camera. In the present case, we don't really want to render the remote avatar but we do want other players to sync its Transform values, so we'll disable the rendering as follows:</p><pre class="programlisting">using UnityEngine;
using UnityEngine.Networking;

public class AvatarMultiplayer : NetworkBehaviour 
{
    public override void OnStartLocalPlayer()
    {
        GameObject camera = Camera.main.gameObject;
        transform.parent = camera.transform;
        transform.localPosition = Vector3.zero;

<span class="strong"><strong>        GetComponent&lt;OvrAvatar&gt;().enabled = false;</strong></span>
    }
}</pre><p>Now, when two or more players join the same room, the players should be tracked and synchronized over the network. Here is a screen capture of an Oculus Avatar playing ball in our scene:</p><div class="mediaobject"><img src="/graphics/9781788478809/graphics/2c903197-fb56-4d46-b6dd-8703b32d361d.png" /></div></div></div>