<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec16"></a>Using packed arrays</h2></div></div><hr /></div><p>Loosely speaking, the <a id="id77" class="indexterm"></a>code inside a shader has to be executed for at least every pixel in your screen. This is the reason why GPUs are highly optimized for parallel computing. This philosophy is also evident in the standard type of variables and operators available in Cg. Understanding them is essential not just to use shaders correctly, but also to write highly optimized ones.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec31"></a>How to do it...</h3></div></div></div><p>There are two types of variables in Cg: single values and packed arrays. The latter can be identified because their type ends with a number such as <code class="literal">float3</code> or <code class="literal">int4</code>. As their names suggest, these types of variables are similar to structs, which means that they each contain several single values. Cg calls them <a id="id78" class="indexterm"></a>
<span class="strong"><strong>packed arrays</strong></span>, though they are not exactly <span class="emphasis"><em>arrays</em></span> in the traditional sense.</p><p>The elements of a packed array can be accessed as a normal struct. They are typically called <code class="literal">x</code>, <code class="literal">y</code>, <code class="literal">z</code>, and <code class="literal">w</code>. However, Cg also provides you with another alias for them, that is, <code class="literal">r</code>, <code class="literal">g</code>, <code class="literal">b</code>, and <code class="literal">a</code>. Despite there being no difference between using <code class="literal">x</code> or <code class="literal">r</code>, it can make a huge difference for the readers. Shader coding, in fact, often involves calculation with positions and colors. You might have seen this in the Standard Shaders:</p><div class="informalexample"><pre class="programlisting">o.Alpha = _Color.a;</pre></div><p>Here, <code class="literal">o</code> was a struct and <code class="literal">_Color</code> was a packed array. This is also why Cg prohibits the mixed usage of these two syntaxes: you cannot use <code class="literal">_Color.xgz</code>.</p><p>There is also another <a id="id79" class="indexterm"></a>important feature of packed arrays that has no equivalent in C#: <span class="strong"><strong>swizzling</strong></span>. Cg allows addressing and reordering elements within packed arrays in just a single line. Once again, this appears in the Standard Shader:</p><div class="informalexample"><pre class="programlisting">o.Albedo = _Color.rgb;</pre></div><p>
<code class="literal">Albedo</code> is <code class="literal">fixed3</code>, which means that it contains three values of the <code class="literal">fixed</code> type. However, <code class="literal">_Color</code> is defined as <code class="literal">fixed4</code>. A direct assignment would result in a compiler error as <code class="literal">_Color</code> is <a id="id80" class="indexterm"></a>bigger than <code class="literal">Albedo</code>. The C# way of doing this would be as follows:</p><div class="informalexample"><pre class="programlisting">o.Albedo.r = _Color.r;
o.Albedo.g = _Color.g;
o.Albedo.b = _Color.b;</pre></div><p>However, it can be compressed in Cg:</p><div class="informalexample"><pre class="programlisting">o.Albedo = _Color.rgb;</pre></div><p>Cg also allows reordering elements, for instance, using <code class="literal">_Color.bgr</code> to swap the red and blue channels.</p><p>Lastly, when a single value is assigned to a packed array, it is copied to all of its fields:</p><div class="informalexample"><pre class="programlisting">o.Albedo = 0; // Black =(0,0,0)
o.Albedo = 1; // White =(1,1,1)</pre></div><p>This is referred <a id="id81" class="indexterm"></a>to as <span class="strong"><strong>smearing</strong></span>.</p><p>Swizzling can also be used on the left-hand side of an expression, allowing only certain components of a packed array to be overwritten:</p><div class="informalexample"><pre class="programlisting">o.Albedo.rg = _Color.rg;</pre></div><p>In which case, it is <a id="id82" class="indexterm"></a>called <span class="strong"><strong>masking</strong></span>.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl3sec04"></a>Packed matrices</h4></div></div></div><p>Where swizzling <a id="id83" class="indexterm"></a>really shows its full potential is when applied to packed matrices. Cg allows types such as <code class="literal">float4x4</code>, which represents a matrix of floats with four rows and four columns. You can access a single element of the matrix using the <span class="emphasis"><em>_mRC</em></span> notation, where <span class="emphasis"><em>R</em></span> is the row and <span class="emphasis"><em>C</em></span> is the column:</p><div class="informalexample"><pre class="programlisting">float4x4 matrix;
// ...
float first = matrix._m00;
float last = matrix._m33;</pre></div><p>The <span class="emphasis"><em>_mRC</em></span> notation can also be chained:</p><div class="informalexample"><pre class="programlisting">float4 diagonal = matrix._m00_m11_m22_m33;</pre></div><p>An entire row can be selected using squared brackets:</p><div class="informalexample"><pre class="programlisting">float4 firstRow = matrix[0];
// Equivalent to
float4 firstRow = matrix._m00_m01_m02_m03;</pre></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec32"></a>See also</h3></div></div></div><p>Packed arrays are one <a id="id84" class="indexterm"></a>of the nicest features of Cg. You can discover more <a id="id85" class="indexterm"></a>about them here:</p><p>
<a class="ulink" href="http://http.developer.nvidia.com/CgTutorial/cg_tutorial_chapter02.html" target="_blank">http://http.developer.nvidia.com/CgTutorial/cg_tutorial_chapter02.html</a>
</p></div></div>