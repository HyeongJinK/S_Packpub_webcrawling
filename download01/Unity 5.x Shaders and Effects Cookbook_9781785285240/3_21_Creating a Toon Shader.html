<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec26"></a>Creating a Toon Shader</h2></div></div><hr /></div><p>One of the most used <a id="id169" class="indexterm"></a>effects in games is the <span class="strong"><strong>toon shading</strong></span>, which is also known as <a id="id170" class="indexterm"></a>
<span class="strong"><strong>cel shading</strong></span> (short for <span class="emphasis"><em>celluloid</em></span>). It is a non-photorealistic rendering technique that makes 3D models appear flat. Many games use it to give the illusion that <a id="id171" class="indexterm"></a>the graphics are being hand-drawn rather than being 3D-modeled. You can see, in the following picture, a sphere rendered with a Standard Shader (right) and Toon Shader (left):</p><div class="mediaobject"><img src="/graphics/9781785285240/graphics/Image_4850_03_04.jpg" /></div><p>Achieving this effect using just surface functions is not impossible, but it would be extremely expensive and time-consuming. The surface function, in fact, only works on the properties of the material, not its actual lighting condition. As toon shading requires to change the way light reflects, we need to create our custom lighting model instead.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec62"></a>Getting ready</h3></div></div></div><p>Let's start this recipe by creating a shader and its material and importing a special texture, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Start by creating a new shader; in this example, we will extend the one made in the previous recipe.</p></li><li><p>Create a new material for the shader and attach it to a 3D model. The toon shading works best on curved surfaces.</p></li><li><p>This recipe requires <a id="id172" class="indexterm"></a>an additional texture called <span class="strong"><strong>ramp map</strong></span>. It is <a id="id173" class="indexterm"></a>important that you change its <span class="strong"><strong>Wrap Mode</strong></span> to <span class="strong"><strong>Clamp</strong></span>. If you want the edges between the colors to be sharp, the <span class="strong"><strong>Filter Mode</strong></span> should also be set to <span class="strong"><strong>Point</strong></span>:</p><div class="mediaobject"><img src="/graphics/9781785285240/graphics/Image_4850_03_05.jpg" /></div></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec63"></a>How to do it…</h3></div></div></div><p>The toon aesthetic can be achieved with the following changes to the shader:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Add a new property for a texture called <code class="literal">_RampTex</code>:</p><div class="informalexample"><pre class="programlisting">_RampTex ("Ramp", 2D) = "white" {}</pre></div></li><li><p>Add its relative variable in the <code class="literal">CGPROGRAM</code> section:</p><div class="informalexample"><pre class="programlisting">sampler2D _RampTex;</pre></div></li><li><p>Change the <code class="literal">#pragma</code> directive so that it points to a function called <code class="literal">LightingToon()</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>#pragma</strong></span> surface surf Toon</pre></div></li><li><p>Use this lighting model:</p><div class="informalexample"><pre class="programlisting">fixed4 LightingToon (SurfaceOutput s, fixed3 lightDir, fixed atten)
{
  half NdotL = dot(s.Normal, lightDir); 
  NdotL = tex2D(_RampTex, fixed2(NdotL, 0.5));

  fixed4 c;
  c.rgb = s.Albedo * _LightColor0.rgb * NdotL * atten;
  c.a = s.Alpha;

  return c;
}</pre></div></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec64"></a>How it works…</h3></div></div></div><p>The main characteristic of the toon shading is the way the light is rendered; surfaces are not shaded uniformly. To achieve this effect, we need a ramp map. Its purpose is to remap the Lambertian light <a id="id174" class="indexterm"></a>intensity <code class="literal">NdotL</code> to another value. Using a ramp map without a gradient, we can force the lighting to be rendered in steps. The following image shows how the ramp map is used to correct the light intensity:</p><div class="mediaobject"><img src="/graphics/9781785285240/graphics/Image_4850_03_06.jpg" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec65"></a>There's more…</h3></div></div></div><p>There are many different ways one can achieve a toon shading effect. Using different ramps can produce dramatic <a id="id175" class="indexterm"></a>changes in the way your models look, so you should experiment in order to find the best one.</p><p>An alternative to ramp textures is to <span class="emphasis"><em>snap</em></span> the light intensity <code class="literal">NdotL</code> so that it can only assume a certain number of values equidistantly sampled from 0 to 1:</p><div class="informalexample"><pre class="programlisting">half4 LightingCustomLambert (SurfaceOutput s, half3 lightDir, half3 viewDir, half atten) {
half NdotL = dot (s.Normal, lightDir);  
<span class="strong"><strong>half cel = floor(NdotL * _CelShadingLevels) / (_CelShadingLevels -0.5); // Snap</strong></span>

half4 c;
  c.rgb = s.Albedo * _LightColor0.rgb * cel * atten;
  c.a = s.Alpha;

  return c;
}</pre></div><p>The snapping code multiplies <code class="literal">NdotL</code> times <code class="literal">_CelShadingLevels</code>, rounds it to an integer, and then divides it back. By doing this, the <code class="literal">cel</code> quantity is forced to assume one of the <code class="literal">_CelShadingLevels</code> <a id="id176" class="indexterm"></a>equidistant values from 0 to 1. This removes the need for a ramp texture and makes all the color steps of the same size. If you are going for this implementation, remember to add a property called <code class="literal">_CelShadingLevels</code> to your shader.</p></div></div>