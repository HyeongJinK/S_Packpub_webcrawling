<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec39"></a>Implementing a snow shader</h2></div></div><hr /></div><p>The simulation <a id="id294" class="indexterm"></a>of snow has always been a challenge in games. The vast majority of games simply includes snow directly in the model's textures so that their tops look white. However, what if one of these objects starts rotating? Snow is not just a lick of paint on a surface; it is a proper accumulation of material and should be treated as such. This recipe shows you how to give a snowy look to your models using just a shader.</p><p>This effect is achieved in two steps. First, a white color is used for all the triangles facing the sky. Second, their vertices are extruded to simulate the effect of snow accumulation. You can see the result in the following picture:</p><div class="mediaobject"><img src="/graphics/9781785285240/graphics/Image_4850_05_07.jpg" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note23"></a>Note</h3><p>Keep in mind <a id="id295" class="indexterm"></a>that this recipe does not aim to create a photorealistic snow effect. It provides a good starting point, but it is up to an artist to create the right textures and find the right parameters to make it fit your game.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec102"></a>Getting ready</h3></div></div></div><p>This effect is purely based on shaders. We will need the following:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new shader for the snow effect.</p></li><li><p>Create a new material for the shader.</p></li><li><p>Assign the newly created material to the object that you want to be snowy.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec103"></a>How to do it…</h3></div></div></div><p>To create a snowy effect, open your shader and make the following changes:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Replace the properties of the shader with the following ones:</p><div class="informalexample"><pre class="programlisting">_MainColor("Main Color", Color) = (1.0,1.0,1.0,1.0)
_MainTex("Base (RGB)", 2D) = "white" {}
_Bump("Bump", 2D) = "bump" {}
_Snow("Level of snow", Range(1, -1)) = 1
_SnowColor("Color of snow", Color) = (1.0,1.0,1.0,1.0)
_SnowDirection("Direction of snow", Vector) = (0,1,0)
_SnowDepth("Depth of snow", Range(0,1)) = 0</pre></div></li><li><p>Complete <a id="id296" class="indexterm"></a>them with their relative variables:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sampler2D</strong></span> _MainTex;
<span class="strong"><strong>sampler2D</strong></span> _Bump;
<span class="strong"><strong>float</strong></span> _Snow;
<span class="strong"><strong>float4</strong></span> _SnowColor;
<span class="strong"><strong>float4</strong></span> _MainColor;
<span class="strong"><strong>float4</strong></span> _SnowDirection;
<span class="strong"><strong>float</strong></span> _SnowDepth;</pre></div></li><li><p>Replace the <code class="literal">Input</code> structure with the following one:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>struct</strong></span> Input {
  <span class="strong"><strong>float2</strong></span> uv_MainTex;
  <span class="strong"><strong>float2</strong></span> uv_Bump;
  <span class="strong"><strong>float3</strong></span> worldNormal;
  INTERNAL_DATA
};</pre></div></li><li><p>Replace the surface function with the following one. It will color the snowy parts of the model white:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>void</strong></span> surf(Input IN, <span class="strong"><strong>inout</strong></span> SurfaceOutputStandard o) {
  <span class="strong"><strong>half4</strong></span> c = tex2D(_MainTex, IN.uv_MainTex);
  o.Normal = UnpackNormal(tex2D(_Bump, IN.uv_Bump));

  <span class="strong"><strong>if</strong></span> (dot(WorldNormalVector(IN, o.Normal), _SnowDirection.xyz) &gt;= _Snow)
    o.Albedo = _SnowColor.rgb;
  <span class="strong"><strong>else</strong></span>
    o.Albedo = c.rgb * _MainColor;
  o.Alpha = 1;
}</pre></div></li><li><p>Configure the <code class="literal">#pragma</code> directive so that it uses vertex modifiers:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>#pragma</strong></span> surface surf Standard vertex:vert</pre></div></li><li><p>Add the following vertex modifiers, which extrude the vertices covered in snow:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>void</strong></span> vert(<span class="strong"><strong>inout</strong></span> appdata_full v) {
  <span class="strong"><strong>float4</strong></span> sn = mul(UNITY_MATRIX_IT_MV, _SnowDirection);
  <span class="strong"><strong>if</strong></span> (dot(v.normal, sn.xyz) &gt;= _Snow)
    v.vertex.xyz += (sn.xyz + v.normal) * _SnowDepth * _Snow;
}</pre></div></li></ol></div><p>You can now use <a id="id297" class="indexterm"></a>the material's <span class="strong"><strong>Inspector</strong></span> tab to select how much of your model is going to be covered and how thick the snow should be.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec104"></a>How it works…</h3></div></div></div><p>This shader works in two steps.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec13"></a>Coloring the surface</h4></div></div></div><p>The first one <a id="id298" class="indexterm"></a>alters the color of the triangles that are facing the sky. It affects all the triangles with a normal direction similar to <code class="literal">_SnowDirection</code>. As seen before in <a class="link" href="#" linkend="ch03">Chapter 3</a>, <span class="emphasis"><em>Understanding Lighting Models</em></span>, comparing unit vectors can be <a id="id299" class="indexterm"></a>done using the <span class="strong"><strong>dot product</strong></span>. When two vectors are orthogonal, their dot product is zero; it is one (or minus one) when they are parallel to each other. The <code class="literal">_Snow</code> property is used to decide how aligned they should be to be considered facing the sky.</p><p>If you look closely at the surface function, you can see that we are not dotting the normal and snow direction directly. This is because they are usually defined in a different space. The snow direction is expressed in world coordinates, while the object normals are usually relative to the model itself. If we rotate the model, its normals will not change, which is not what we want. To fix this, we need to convert the normals from their object coordinates to world coordinates. This is done with the <code class="literal">WorldNormalVector()</code> function, as seen in the following code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>if</strong></span> (dot(WorldNormalVector(IN, o.Normal), _SnowDirection.xyz) &gt;= _Snow)
  o.Albedo = _SnowColor.rgb;
<span class="strong"><strong>else</strong></span>
  o.Albedo = c.rgb * _MainColor;</pre></div><p>This shader simply colors the model white; a more advanced one should initialize the <code class="literal">SurfaceOutputStandard</code> structure with textures and parameters from a realistic snow material.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec14"></a>Altering the geometry</h4></div></div></div><p>The second effect <a id="id300" class="indexterm"></a>of this shader alters the geometry to simulate the accumulation of snow. Firstly, we identify which triangles have been colored white by testing the same condition used in the surface function. This time, unfortunately, we cannot rely on <code class="literal">WorldNormalVector()</code> as the <code class="literal">SurfaceOutputStandard</code> structure is not yet initialized in the vertex modifier. We use this other method instead, which converts <code class="literal">_SnowDirection</code> to object coordinates:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>float4</strong></span> sn = mul(UNITY_MATRIX_IT_MV, _SnowDirection);</pre></div><p>Then, we can extrude the geometry to simulate the accumulation of snow:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>if</strong></span> (dot(v.normal, sn.xyz) &gt;= _Snow)
v.vertex.xyz += (sn.xyz + v.normal) * _SnowDepth * _Snow;</pre></div><p>Once again, this is a very basic effect. One could use a texture map to control the accumulation of snow more precisely or give a peculiar, uneven look.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec105"></a>See also</h3></div></div></div><p>If you need high-quality snow effects and props for your game, you can also check these resources on the Unity <a id="id301" class="indexterm"></a>
<span class="strong"><strong>Asset Store</strong></span>:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="strong"><strong>Winter Suite ($30)</strong></span>: A much more sophisticated version of the snow shader presented in this recipe can be found at <a class="ulink" href="https://www.assetstore.unity3d.com/en/#!/content/13927" target="_blank">https://www.assetstore.unity3d.com/en/#!/content/13927</a>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Winter Pack ($60)</strong></span>: A very realistic set of props and materials for snowy environments can be found at <a class="ulink" href="https://www.assetstore.unity3d.com/en/#!/content/13316" target="_blank">https://www.assetstore.unity3d.com/en/#!/content/13316</a>
</p></li></ul></div></div></div>