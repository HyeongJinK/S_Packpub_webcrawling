<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="04lvl1sec29"></a>Creating environmental audio zones</h2></div></div><hr /></div><p>As it stands right now, our <span>whole</span> game level or scene uses a single global audio mix. We did create a couple of snapshots to allow us to switch audio during game pause, but overall everywhere we go, it all sounds the same. Sure, we have several audio sources providing 3D spatial sound, but nothing describing the changes to the physical space around us. Remember, when we talked about the SFX Reverb and Echo effects, how they are used to denote space by providing more realistic reflections. Unfortunately, all our audio uses the same Reverb and Echo effects everywhere, so again, it all sounds the same. Ideally, we want to be able to create zones of where the audio should sound differently and then make changes to our mix when a player enters those zones. Let's take a look at a high level view of the village scene and identify areas where sound should be different:</p><div class="mediaobject"><img src="/graphics/9781787286450/graphics/843b3c54-9de3-49bc-a5f4-d6edc508a8ae.png" /></div><p>A map of the village scene with environmental zone-types labeled</p><p>The map shows the entire village scene labeled with environmental zone types. Each number represents a different type of environmental according to the description here:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Exposed</strong></span>: These zones are very exposed to the elements and represent large open areas. In order to emphasize this with audio, we would increase the wind volume, reduce reverb or echo, and lower the volume on the direct audio.</li><li style="list-style-type: disc"><span class="strong"><strong>Crossroads</strong></span>: These may be especially windy or turbulent areas because of the funneling effect caused by surrounding buildings. In these areas, we will increase the wind volume but maintain the other global settings.</li><li style="list-style-type: disc"><span class="strong"><strong>Sheltered</strong></span>: These areas are all directly sheltered from the wind by the buildings, which should significantly reduce the wind volume in these areas. Because these areas are between buildings, we also want to increase the reverb and echo volumes. Increasing the direct audio will provide a sense of a smaller or confined space as well.</li><li style="list-style-type: disc"><span class="strong"><strong>Fringe</strong></span>: These areas are just on the outside of the village. Despite being away from the wind, they are not subjected to being a closed area. In this area, we would reduce the wind and direct audio.</li></ul></div><p>You could of course add other <span>environmental</span> zones to what we described earlier. For instance, you may want indoor zones, underground zones, flying zones, and so on. The list is endless.</p><p>Now that we understand the concept behind environmental zones, it is time to put this to practice. Follow the exercise here to start defining and then laying out the environmental zones:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Open up Unity and direct your attention to the <strong class="userinput"><code>Audio Mixer</code></strong> window. Select the <strong class="userinput"><code>Wind</code></strong> group in the <strong class="userinput"><code>Groups</code></strong> list and then click on the <strong class="userinput"><code>+</code></strong> icon to create a new child group. Rename this new group <code class="literal">WindRaw</code>, as shown in the screenshot here:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/27f99962-be70-4422-ae8e-8a25315d6407.png" /></div><p>Creating a new WindRaw child of the Wind group</p><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Select the <strong class="userinput"><code>Wind Zone</code></strong> game <span>object</span> in the <strong class="userinput"><code>Hierarchy</code></strong> window and then in the <strong class="userinput"><code>Inspector</code></strong> window redirect the <strong class="userinput"><code>Audio Source</code></strong> to the new <code class="literal">WindRaw</code> group. Since <code class="literal">WindRaw</code> is a child of <code class="literal">Wind</code>, the group will route all audio to the parent. We create this child group so that we can change the volume of the wind audio using a child group. If you recall, our <strong class="userinput"><code>AudioWeatherVane</code></strong> script dynamically changes the volume of the <code class="literal">Wind</code> group, which would override any snapshot settings.</li><li>Right-click (<span class="emphasis"><em>Ctrl</em></span> + click on Mac) on the <code class="literal">Unpaused</code> snapshot. From the context menu, select <strong class="userinput"><code>Set as start snapshot</code></strong> and then <strong class="userinput"><code>Duplicate</code></strong> as shown in the following screenshot:<div class="mediaobject"><img src="/graphics/9781787286450/graphics/047bf431-a239-466d-9c6b-41c5cece5c2a.png" /></div></li></ol></div><p>Setting the start or global snapshot
</p><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>This will set the <strong class="userinput"><code>Unpaused</code></strong> snapshot as our starting point for our audio mixes. This also means that it will be our global mix settings. Rename the duplicate snapshot we created earlier to <code class="literal">Exposed</code>.</li><li>It is time for us to mix the audio settings for the <code class="literal">Exposed</code> snapshot. Be sure the <code class="literal">Exposed</code> snapshot is selected and make the following audio changes to your mix:
<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">WindRaw</code>: This increases the <strong class="userinput"><code>Volume</code></strong> to <code class="literal">10 dB</code>.</li><li style="list-style-type: disc"><code class="literal">Direct</code>: This reduces the <strong class="userinput"><code>Volume</code></strong> to <code class="literal">-10 dB</code> and decreases the <strong class="userinput"><code>Send level</code></strong> to <code class="literal">-60 dB</code> on the <strong class="userinput"><code>Reverb ReturnReceive</code></strong>.</li><li style="list-style-type: disc"><code class="literal">Ambient</code>: This decreases the <strong class="userinput"><code>Send level</code></strong> on the <strong class="userinput"><code>Echo ReturnReceive</code></strong> to <code class="literal">-60 dB</code>.</li></ul></div></li><li>From the menu, select <strong class="userinput"><code>GameObject</code></strong> | <strong class="userinput"><code>Create Empty</code></strong>. Rename the new object <strong class="userinput"><code>EnvironmentalZones</code></strong> and reset the <strong class="userinput"><code>Transform</code></strong> to <span class="strong"><strong>0</strong></span> (<span class="strong"><strong><strong class="userinput"><code>Position: 0,0,0</code></strong></strong></span>).</li><li>Right-click (<span class="emphasis"><em>Ctrl</em></span> + click on Mac) on the new object and select <strong class="userinput"><code>Create Empty</code></strong> from the context menu. This will create a child object attached to the <code class="literal">EnvironmentalZones</code> game object. Rename the new object <code class="literal">Zone_Exposed_1</code>. Click on the <strong class="userinput"><code>Add Component</code></strong> button in the <strong class="userinput"><code>Inspector</code></strong> window to open the component context menu. Enter <code class="literal">environmentalzone</code> in the search field and then select the Environmental Zone component. Set the parameters on the <strong class="userinput"><code>Zone_Exposed_1</code></strong> game object to match what is shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/1e7dbf70-2f03-495d-99d9-3a19e23ecbaa.png" /></div><p>Setting the Zone_Exposed_1 Transform and Environmental Zone parameters
</p><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>Double-click on the <code class="literal">Zone_Exposed_1</code> game object in the <strong class="userinput"><code>Hierarchy</code></strong> window after you set the parameters. This will highlight the <span>object</span> in the <strong class="userinput"><code>Scene</code></strong> view and allow you to see where this zone is placed. The zone is in the large wide open construction area with the boat, which is marked #1 in the preceding village map.</li><li>Select the <code class="literal">EnvironmentalZones</code> object in the <code class="literal">Hierarchy</code> window and then click on the <strong class="userinput"><code>Add Component</code></strong> button in the <strong class="userinput"><code>Inspector</code></strong> window. Enter <code class="literal">environmentalzonemanager</code> in the search field and then select the <strong class="userinput"><code>Environmental Zone Manager</code></strong> component from the list to add the component. Then, set the parameters for the component to match what is shown in the screenshot here:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/b375636e-e9d9-440c-b74c-0e71943446d6.png" /></div><p>Setting the Environmental Zone Manager parameters</p><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>After you are done editing, press play to run the scene. Walk the player around the scene and move over to the large exposed construction area with the boat. Notice that as you enter this area now, the wind noise gets very loud, and it is difficult to hear other audio. This is exactly what we were after. When you are done testing, stop the scene and save your changes.</li></ol></div><p>Okay, before we see the full effect, we should understand what is happening inside the <code class="literal">EnvironmentalZoneManager</code> script. Open up the script in your editor of choice and look for our old friends the <code class="literal">Start</code> and <code class="literal">Update</code> methods, shown for reference here:</p><pre class="programlisting">void Start()
{
    zones = GetComponentsInChildren&lt;EnvironmentalZone&gt;();
    globalInfluenceZone = new InfluenceZone
    {
        Snapshot = global,
        Weight = 1
    };
}

void Update()
{
    influenceZones.Clear();
    influenceZones.Add(globalInfluenceZone);

    for (int i = 0; i &lt; zones.Length; i++)
    {
        //zones only influence if they are within their influence
        var distance = Vector3.Distance(player.position, zones[i].transform.position);
        if (distance &lt; zones[i].influence)
        {
            influenceZones.Add(new InfluenceZone
            {
                Snapshot = zones[i].zone,
                Weight = (1 - distance / zones[i].influence) * zones[i].weight
            });
        }
    }
    //blend the zones together     
    master.TransitionToSnapshots(GetSnapshots(), GetWeights(), 1);     
}</pre><p>First off, if you are not a <span>developer</span> or have only a little knowledge of scripting, this script will likely be intimidating. There are a few sections of code that use more advanced features of C# for instance, but we won't try to understand those. Instead, we will just identify the highlights of the script here:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">void Start()</code>: We will just summarize what is going on in this method. The first line uses <code class="literal">GetComponentsInChildren</code> to load all the child zones of the game object. Next, the code creates a new <code class="literal">InfluenceZone</code> object called <code class="literal">globalInfluenceZone</code> and initializes some fields. This global zone represents the base or global audio mix. The definition for <code class="literal">InfluenceZone</code> is at the bottom of the script but really all it does is holds the data that describes a zone of influence.
</li><li style="list-style-type: disc"><code class="literal">influenceZones.Add(globalInfluenceZone);</code>: This line is second from the top of the Update method. The first line in Update clears the list (just a special container of objects) called <code class="literal">influenceZones</code>. This line of code then uses the list's <code class="literal">Add</code> method to add the <code class="literal">globalInfluenceZone</code>.</li><li style="list-style-type: disc"><code class="literal">for (int i = 0; i &lt; zones.Length; i++)</code>: This is the start of a <code class="literal">for</code> loop, which will loop through all the child zones we initialized earlier, using <code class="literal">i</code> as an indexer.</li><li style="list-style-type: disc"><code class="literal">var distance = Vector3.Distance(player.position, zones[i].transform.position);</code>: This line of code calculates the distance between our player object and the current zone in the <code class="literal">for</code> loop, identified by <code class="literal">i</code>.</li><li style="list-style-type: disc"><code class="literal">if (distance &lt; zones[i].influence)</code>: This <code class="literal">if</code> statement then checks if the distance between the player and the zone is less than the zone's <code class="literal">influence</code>. Influence represents the range at which a zone can be effective; we look into this in detail later in the chapter. If the zone is within range, then a new <code class="literal">InfluenceZone</code> is added to the list inside the statement.</li><li style="list-style-type: disc"><code class="literal">Weight = (1 - distance / zones[i].influence) * zones[i].weight</code>: This code calculates the effectiveness of the zone, based on the distance. Just recall, for the global zone we assigned a <code class="literal">Weight</code> of 1. Again, we will explain this later in the text.</li><li style="list-style-type: disc"><code class="literal">master.TransitionToSnapshots(GetSnapshots(), GetWeights(), 1);</code>: Finally, at the end of the <code class="literal">Update</code> method, we use the <code class="literal">TransitionToSnapshots</code> method of the mixer (master) to blend those zones together. <code class="literal">TransitionToSnapshots</code> takes an array of snapshots and an array of weights (type float) it uses to blend to determine the final mix. In order to simplify things, the <code class="literal">GetSnapshots()</code> and <code class="literal">GetWeights()</code> are just helper methods used to extract the array of snapshots and weights from the <code class="literal">influenceZones</code> list.</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note67"></a>Note</h3><p>There are other ways to implement audio or environmental zones using event triggers or even physics ray casting. We are not going to look at how those are implemented, but the same concepts would apply. If you are interested, you can easily find an example using triggers to control zones on the internet.</p></div><p>Well that explains the more <span>relevant</span> pieces of code, but you may still be having a hard time visualizing how all of this is supposed to come together. Here is a diagram that should help to explain the concept of zones further:</p><div class="mediaobject"><img src="/graphics/9781787286450/graphics/da2de2fa-03ac-4528-9bb6-3182520711f6.png" /></div><p>Diagram showing environmental or influence zones overlapping</p><p>In the diagram, there are four <span>different</span> environmental or influence zones represented. Each of these zones has a different influence range, denoted by their radius and strength. Imagine the player is at each of the numbered reference points in the diagram. How many influence zones affect each of the points in the diagram? Think about this question first, before looking for the answers:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>2 zones</strong></span>: The global influence zone and the single zone surrounding it</li><li style="list-style-type: disc"><span class="strong"><strong>3 zones</strong></span>: The global and the two overlapping zones</li><li style="list-style-type: disc"><span class="strong"><strong>4 zones</strong></span>: The global and the three overlapping zones</li><li style="list-style-type: disc"><span class="strong"><strong>3 zones</strong></span>: The global and the two overlapping zones</li></ul></div><p> We also provide a strength or weight factor to each zone. This allows us to control the amount of impact a zone has to the overall mix. The strength or weight of a zone will fall off as it moves from the center to the outside edge as shown in the diagram here:</p><div class="mediaobject"><img src="/graphics/9781787286450/graphics/dd26e15b-6a48-4f8d-92a5-cc1bc3b10507.png" /></div><p>Linear calculation of weight based on zone strength and range to player</p><p>Depending on the strength you set for a zone, the more effective a zone will be overall. This allows us to control the transition between overlapping zones and the global zone. The stronger a zone, the more influence it will have. Although, you generally don't want a zone so strong that it creates an unnatural transition, unless that is what you want. For example, if you have a player entering a building or other closed space, you probably want only the zone to affect what the player hears. In that case, you would likely set a very high strength on the zone. With another option maybe to use a trigger zone effect like we mentioned earlier.</p><p>When we went through the exercise of exposing parameters for scripting; however you may have noticed a number of other options to control snapshot transition on parameters. Here is an example of what that context menu looked like:</p><div class="mediaobject"><img src="/graphics/9781787286450/graphics/b9de2633-d398-4fa5-b405-c61dbfbb5d26.png" /></div><p>Parameter exposure and snapshot transition menu
</p><p>Since our <span>environmental</span> zone method uses a linear transition, shown in the preceding graph, to blend snapshot weights, the additional transition settings won't have much affect. If you were mathematically inclined, you could implement other transition forms in the zone example we used.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note68"></a>Note</h3><p>The variety of snapshot transitions made available by Unity are useful for simple transitions between snapshots using only a few parameters. Much like our first example, where we implemented the pause effect. For that reason, we won't be covering those transition types in any more detail here.</p></div><p>So, lets take a look at how all these zones come together in a complete example. Follow the directions to import the completed example:</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip69"></a>Note</h3><p>If you are disappointed that we didn't go through the exercise of setting up all the zones in the book. Don't worry; you will now have plenty of time to do that in your own game.</p></div><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>From the menu, select <strong class="userinput"><code>Assets</code></strong> | <strong class="userinput"><code>Import Package</code></strong> | <strong class="userinput"><code>Custom Package</code></strong>. This will open the <strong class="userinput"><code>Import package</code></strong> dialog. Use the dialog to go to the book's downloaded source code <code class="literal">Chapter_4_Assets</code> folder and select the <strong class="userinput"><code>Chapter_4_Zones.unitypackage</code></strong>. Then, click on the <strong class="userinput"><code>Open</code></strong> button to load the assets.</li><li>Select the defaults on the <strong class="userinput"><code>Import</code></strong> dialog and click on the <strong class="userinput"><code>Import</code></strong> button to import the assets.</li><li>After the assets import, go to the <strong class="userinput"><code>Project</code></strong> window and enter the text <code class="literal">zones</code> in the search field. This will filter the view to display a scene called <strong class="userinput"><code>The_Viking_Village_Chapter4_Zones</code></strong>. Double-click on the scene to open it.</li><li>Press play to run the scene. Move around the scene and notice how the sounds change as you move behind buildings or out in the open. When you are done testing, stop the scene. For the purposes of the samples in the book, we have generally over-emphasized various effects. This is to account for differences in a reader's hearing, equipment (headphones, speakers), and so on.</li></ol></div><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>In the <strong class="userinput"><code>Hierarchy</code></strong> window, double-click on the <code class="literal">EnvironmentalZones</code> game object and then look at the <strong class="userinput"><code>Scene</code></strong> view. Zoom the camera out using the scroll wheel, or hold <span class="emphasis"><em>Alt</em></span> + left-click, and drag until you see something like the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/a5499721-4b85-4bc2-8221-8ec206ef5206.png" /></div><p>Viewing all the environmental audio zones in the scene</p><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>All the cyan spheres represent an environmental audio zone using based on one of those snapshot settings we discussed earlier. Feel free to go back to the running scene and listen for those zone transitions. If you are so inclined, you can certainly add additional zones or change the current zones and snapshot settings to match your taste.</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note70"></a>Note</h3><p><strong class="userinput"><code>QUIZ TIME</code></strong>
Time for another quiz.
Going back to the first chapter, which of the following audio sounds we have or will use in our scene are diegetic or non-diegetic? If you forgot what those definitions mean, jump back to <a class="link" href="#" linkend="ch01">chapter 1</a>, <span class="emphasis"><em>Introducing Game Audio with Unity</em></span>, and look it up.<span class="strong"><strong>Wind</strong></span><span class="strong"><strong>Lake shore waves</strong></span><span class="strong"><strong>Music</strong></span>
Answers will be provided before the end of the chapter.</p></div><p>In the last and final section of this chapter, we look at another way to dynamically mix content, which will be the basis for other exercises later in the book.</p></div>