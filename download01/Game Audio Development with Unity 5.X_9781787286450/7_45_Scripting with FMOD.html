<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="07lvl1sec45"></a>Scripting with FMOD</h2></div></div><hr /></div><p>So far, we have managed to get away from doing any scripting and generated some fairly impressive results. Yet, as you can imagine, there always will be tasks you won't be able to complete with existing components. In fact, the <code class="literal">AudioWeatherVane</code> script we developed earlier is a very good example of that. If you recall, the script measured the force of the wind and then adjusted an Audio Mixer parameter to control the wind volume. This will be an excellent script we can upgrade to work with FMOD in order to demonstrate scripting.</p><p>First, we will start by laying the ground <span>work</span> by building a new parameter in FMOD. Open up FMOD Studio Event Editor and follow the instructions here:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Select the <code class="literal">wind</code> event in the <strong class="userinput"><code>Events</code></strong> tab and then click on the <strong class="userinput"><code>Master</code></strong> track. Then look to the deck region and right-click [<span class="emphasis"><em>Ctrl</em></span> + click on Mac] on the <strong class="userinput"><code>Volume</code></strong> knob and from the menu select <strong class="userinput"><code>Add Automation</code></strong>.</li><li>Click the <strong class="userinput"><code>+</code></strong> button at the top of the <strong class="userinput"><code>Timeline,</code></strong> and from the menu, select <strong class="userinput"><code>Add Parameter</code></strong>. When you are prompted with the <strong class="userinput"><code>Add Parameter</code></strong> dialog, name the new parameter <code class="literal">Wind_Intensity</code> and keep the default range [0,1].</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip118"></a>Note</h3><p>It is usually better to work with a normalized range of 0 to 1 for a parameter. This way if the game mechanics or other parts of a level change later, you won't need to go back and alter the parameter range. We will see how this range is calculated in the script later.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>With the <strong class="userinput"><code>Wind_Intensity</code></strong> tab opened, adjust the <strong class="userinput"><code>Volume</code></strong> automation control line to what is shown in the screenshot here:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/9d48f7ec-11e4-42f1-baf5-d38158c92541.png" /></div><p>Adjusting the Volume automation line for the Wind_Intensity parameter</p><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Select the Timeline tab to <span>return</span> to the timeline view and select the wind audio clip (blue wave forms). Then, look to the deck area again and right-click [<span class="emphasis"><em>Ctrl</em></span> + click on Mac] on the <strong class="userinput"><code>Volume</code></strong> knob, and from the menu, select <strong class="userinput"><code>Add Modulation</code></strong><span>|</span><strong class="userinput"><code>Random</code></strong>. This will add a <strong class="userinput"><code>Random</code></strong> modulation effect. Right-click [<span class="emphasis"><em>Ctrl</em></span> + click on Mac] on the <strong class="userinput"><code>Volume</code></strong> knob within the <strong class="userinput"><code>Random</code></strong> modulator and select <strong class="userinput"><code>Add Automation</code></strong> from the menu. This is shown in the screenshot here:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/7f8db11b-be8e-4594-8a8d-61a8739e6c7b.png" /></div><p>Adding a Random modulation on Volume and automating it
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note119"></a>Note</h3><p>Remember in our earlier chapters, we added some randomization to audio in order to provide variation to the listener. FMOD provides different ways in which you can create an audio randomization. In this section, we will use the most frequently used one.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Right click [<span class="emphasis"><em>Ctrl</em></span> + click on Mac] on the <strong class="userinput"><code>Pitch</code></strong> knob and then follow the same procedure as you did in step 4 to create an automated random pitch modulation.</li><li>After you complete steps 4 and 5, there will be two new <strong class="userinput"><code>Random Modulator</code></strong> tracks added. Select the <strong class="userinput"><code>Wind_Intensity</code></strong> tab and then adjust the automation lines to match what is shown in the following screnshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/45450df0-c830-45d1-85a4-199a86505265.png" /></div><p>Setting the Random Modulator automation lines for Volume and Pitch</p><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>When you are done setting the automation curves, build and save the project.</li></ol></div><p>Return to Unity and let's test this new <strong class="userinput"><code>Wind_Intensity</code></strong> parameter a little before we <span>script</span> it, by following the directions given here:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Select the <strong class="userinput"><code>EnvironmentalZones</code></strong> object in the <strong class="userinput"><code>Hierarchy</code></strong> window and then look at the <strong class="userinput"><code>Studio Event Emitter</code></strong> component in the <strong class="userinput"><code>Inspector</code></strong> window. Notice that a new parameter has been added to the component called <strong class="userinput"><code>Wind_Intensity</code></strong>. Ideally, we will want to script this parameter later, but for now, click on the checkbox to activate the parameter and then set the value to a maximum of <code class="literal">1</code>, as shown in the screenshot here:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/f6f60c88-aede-4a16-a904-d6129349fea6.png" /></div><p>Setting the Wind_Intensity parameter on the wind event emitter</p><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Press play to run the scene and move around to test. Move to an area where the wind sound is audible and wait.</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note120"></a>Note</h3><p>Do you hear it? Yes, at some point, you will hear a break or stop in the wind audio. This is a result of our random pitch modulation. Sometimes, an audio file is played quicker and as a result it ends before the loop point. Fortunately, this is an easy fix but could be quite frustrating if you were not sure what was happening.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Stop the scene and open up the FMOD <strong class="userinput"><code>Event Edito</code></strong>r. Select the <strong class="userinput"><code>wind</code></strong> event and make sure the <strong class="userinput"><code>Timeline</code></strong> tab is also open. What we want to do is shorten the loop region so that if the wind clip plays faster, the sound doesn't break but keeps playing. Select the far right end of the loop region above the wind clip and drag it over so that it stops around the <code class="literal">18</code> second mark, as shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/0b7d6c30-c81c-4b41-acf6-dfc00a2f5f18.png" /></div><p>Adjusting the loop region to account for the random pitch modulation</p><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>After the adjustment, press play to play the audio and listen to how it loops. Be sure that you also turn the <strong class="userinput"><code>Wind_Intensity</code></strong> parameter up by selecting the tab and sliding the white parameter control. Adjust the loop end point if the looping is not natural.</li><li>When you are done setting the loop to your liking, go back to Unity and select the <strong class="userinput"><code>EnvironmentalZones</code></strong> object in the <strong class="userinput"><code>Hierarchy</code></strong> window. Then, disable the <strong class="userinput"><code>Wind_Intensity</code></strong> parameter on the <strong class="userinput"><code>Studio Event Emitter</code></strong> by unchecking the parameter checkbox in the <strong class="userinput"><code>Inspector</code></strong> window.</li><li>When you are done, save everything.</li></ol></div><p>Now that we have the <strong class="userinput"><code>Wind_Intensity</code></strong> parameter working the way we think it should be, we can add the already updated <code class="literal">AudioWeatherVane</code> script to the scene, by following the instructions here:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Locate the <strong class="userinput"><code>Wind Zone</code></strong> object in the <strong class="userinput"><code>Hierarchy</code></strong> window. Select the <span>object</span> and then use the <strong class="userinput"><code>Add Component</code></strong> button in the <strong class="userinput"><code>Inspector</code></strong> window to open, locate, and then add the <code class="literal">AudioWeatherVane</code> script. Then, set the parameters in the component to match the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/f67b75ab-9307-4d1d-841b-22939fc84e95.png" /></div><p>Setting the Audio Weather Vane component parameters on the Wind Zone</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip121"></a>Note</h3><p>Remember to use the target icon to open a dialog a Select Particle System dialog to easily find an fx_smoke particle effect in the scene. Any effect will work as long as it has the External Forces option turned on. Which means the particle effect will respond to the force of the wind.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>After you have added the script and set the parameters, press play to start the scene. Yes, it was that easy to set up the script, which says a lot about your ability to find your way around Unity now.</li><li>Keep an eye on the <strong class="userinput"><code>Inspector</code></strong> window and the <strong class="userinput"><code>Audio Weather Vane</code></strong> component as you wander around the scene. Notice how the <strong class="userinput"><code>Max</code></strong>, <strong class="userinput"><code>Min,</code></strong> and <strong class="userinput"><code>Avg</code></strong> wind magnitude values change and how the wind audio adjusts as well. When you are done testing, stop the scene and save the scene and project files.</li><li>Locate the <code class="literal">AudioWeatherVane</code> script in the <strong class="userinput"><code>Project</code></strong> or <strong class="userinput"><code>Inspector</code></strong> window and then open the script in your editor of choice. We will take a more detailed look at that script next.</li></ol></div><p>Having seen the <code class="literal">AudioWeatherVane</code> script in action yet again, let's take a look at how this works with FMOD. Here is the entire script for review; you should also have the script open in your editor as well:</p><pre class="programlisting">public class AudioWeatherVane : MonoBehaviour
{
    public ParticleSystem particleTracker; //ParticleSystem must have ExternalForces set 
<span class="strong"><strong> [FMODUnity.EventRef]</strong></span>
    public string eventName;
    public string parameterName; 
    public float maxWindMagnitude = 1;
    public float minWindMagnitude = 1;
    public float avgWindMagnitude;

<span class="strong"><strong>FMOD.Studio.EventInstance windEvent; //the event </strong></span>
    private ParticleSystem.Particle[] particles;

    void Start()
    {
       particles = new ParticleSystem.Particle[10];
<span class="strong"><strong>windEvent = FMODUnity.RuntimeManager.CreateInstance(eventName); </strong></span>
    }

    //FixedUpdate runs every physics update
    void FixedUpdate()
    {
       var magnitude = 0f;
       if (particleTracker.GetParticles(particles) &gt; 0)
       {
          for (int i = 0; i &lt; particles.Length; i++)
       {
       magnitude += particles[i].velocity.magnitude;
       }
       avgWindMagnitude = magnitude / particles.Length;
       minWindMagnitude = Mathf.Min(avgWindMagnitude, minWindMagnitude);
       maxWindMagnitude = Mathf.Max(avgWindMagnitude, maxWindMagnitude);
<span class="strong"><strong>windEvent.setParameterValue(parameterName, </strong></span>
<span class="strong"><strong>                  (avgWindMagnitude - minWindMagnitude) /   maxWindMagnitude);</strong></span>
       }
    } 
}</pre><p>Since we have already covered the Unity Audio Mixer version of this script, we really only need to review the changes we made to support FMOD. The following is a detailed explanation for each of the highlighted changes in the script:</p><pre class="programlisting"><span class="strong"><strong>[FMODUnity.EventRef]</strong></span>
public string eventName;</pre><p>Adding the attribute <code class="literal">FMODUnity.EventRef</code> to the <code class="literal">eventName</code> allows for the cool event selector GUI to be added in the Inspector.</p><pre class="programlisting"><span class="strong"><strong>FMOD.Studio.EventInstance windEvent; //the event</strong></span></pre><p>These are the declarations for the event and parameter instances we will retrieve and set later. Don't be confused by the use of the explicit namespace (<code class="literal">FMOD.Studio</code>), it really is the same as declaring any other variable.</p><pre class="programlisting"><span class="strong"><strong>windEvent = FMODUnity.RuntimeManager.CreateInstance(eventName); </strong></span></pre><p>Inside the start method is where we see the <span>instances</span> of the event and parameter being set. Notice that the call to <code class="literal">FMODUnity.RuntimeManager</code> is similar to the way we have called our singleton class, [<code class="literal">AdaptiveudioManager</code>]. In fact, <code class="literal">RuntimeManager</code> is also a singleton. Essentially what we are doing is asking the <code class="literal">FMOD RuntimeManager</code> to create an event and then use the event to get the parameter.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note122"></a>Note</h3><p>If you are a developer, you will likely be familiar with the Factory method pattern, which we used. For those of you new to scripting, it is important to understand that this is just a more controlled way to create objects.</p></div><pre class="programlisting"><span class="strong"><strong>windEvent.setParameterValue(parameterName, </strong></span><span class="strong"><strong>(avgWindMagnitude - minWindMagnitude) /         (maxWindMagnitude - minWindMagnitude);</strong></span></pre><p>Lastly, we set the parameter using the normalized [0-1] value of the wind magnitude. Recall that our preference is always to use a normalized value for parameters when we can since this will require less changes if game mechanics change later. The preceding highlighted line of code keeps the min and max values updated depending on how much the wind gusts.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note123"></a>Note</h3><p>The formula we use to normalize a value is fairly standard and is of the form:<span class="emphasis"><em>normalized = (value - min) / (max - min)</em></span>
This will always return a number from 0-1, as long as the value is within that range of course.</p></div><p>That about covers our discussion on FMOD scripting. As we have seen, while scripting is done a little differently with FMOD, the concepts should all be quite familiar by now. In the next section, we will cover more scripting and start developing adaptive audio with FMOD.</p></div>