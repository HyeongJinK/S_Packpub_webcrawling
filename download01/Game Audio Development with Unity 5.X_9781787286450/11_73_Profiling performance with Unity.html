<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="11lvl1sec69"></a>Profiling performance with Unity</h2></div></div><hr /></div><p>There is no better way to understand <span>performance</span> profiling and optimization than by doing it. Therefore, in this section, we are going to get hands on and profile the example <code class="literal">Viking village</code> project as we last left it in <a class="link" href="#" linkend="ch05">Chapter 5</a>, <span class="emphasis"><em>Using Audio Mixer for Adaptive Audio</em></span>. Follow the instructions to open up Unity to the previously saved project:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Open up Unity and load the <code class="literal">GameAudioBasics</code> project you created earlier.</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note182"></a>Note</h3><p>If you have not previously created the <code class="literal">GameAudioBasics</code> project, create a new project in Unity called <code class="literal">GameAudioBasics</code> and download and/or import the <code class="literal">Viking Village</code> example project from the Asset Store. You can use the walk-through in <a class="link" href="#" linkend="ch01">Chapter 1</a>, <span class="emphasis"><em>Introducing Game Audio with Unity,</em></span> if you need help setting up the base project.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>From the menu, navigate to <strong class="userinput"><code>Assets</code></strong> | <strong class="userinput"><code>Import Package</code></strong> | <strong class="userinput"><code>Custom Package</code></strong> and use the <strong class="userinput"><code>Import</code></strong> dialog to locate and open the <code class="literal">Chapter_11_Assets</code> folder within the book's downloaded source code. Select the <strong class="userinput"><code>Chapter_11_Start.unitypackage</code></strong> and click <strong class="userinput"><code>Open</code></strong>. Follow the dialog directions to import all the assets.</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note183"></a>Note</h3><p>If you have modified the original project and want to keep your changes then either make a copy of the project folder or create a new project and download the <code class="literal">Viking Village</code> starting project again.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>After the package has finished importing, locate the <code class="literal">Chapter_11_Start</code> scene in the <strong class="userinput"><code>Project</code></strong> window and double-click on it to open it.
</li></ol></div><p>Â </p><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>From the menu, navigate to <strong class="userinput"><code>Window</code></strong> | <strong class="userinput"><code>Profiler</code></strong>. This will open the <strong class="userinput"><code>Profiler</code></strong> window. Use your mouse to drag and dock the window beside the <strong class="userinput"><code>Inspector</code></strong> window so that it is docked like the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/8a627d50-143a-4d18-9e1e-80b62add06f1.png" /></div><p>Profiler docked beside the Inspector window
</p><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Press play to <span>run</span> the scene now. Move around the scene with the <span class="emphasis"><em>W</em></span>, <span class="emphasis"><em>A</em></span>, <span class="emphasis"><em>S</em></span>, <span class="emphasis"><em>D</em></span> keys. Press <span class="emphasis"><em>Esc</em></span> to unlock the mouse and then select the <strong class="userinput"><code>Audio</code></strong> panel on the <strong class="userinput"><code>Profiler</code></strong> window. This will display details about the audio performance as shown in the following example screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/d0353b4f-556f-4550-b538-c891b19b0a80.png" /></div><p>Examining the audio performance Profiler window and Stats</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note184"></a>Note</h3><p>The stat percentages you see on your computer may be quite different. The important thing is to just watch how much and when they change.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>There is obviously a lot going on here. For now though, focus on the highlighted <strong class="userinput"><code>Stats</code></strong> as indicated in the preceding screenshot. Continue to move around the scene and watch how the graph and <strong class="userinput"><code>Stats</code></strong> change.</li><li>When you are done, unlock the mouse and stop the scene.
</li></ol></div><p>This initial test has shown us that some good and bad <span>things</span> are happening with our scene. First, our memory usage is quite consistent and minimal at only around 67.3 MB. Of course, if this was to be a mobile game that number would likely be an issue, but for now we will consider it good. Second, our audio CPU usage is hovering around 20-25% on average and may peak as high as 30%. That is a significant problem, and if we look below the <strong class="userinput"><code>Total Audio CPU</code></strong> stat, you will see the culprit is the <strong class="userinput"><code>DSP CPU</code></strong>. <span class="strong"><strong>DSP</strong></span> stands for <span class="strong"><strong>Digital Signal Processing</strong></span>, or in other <span>words</span>, the audio processing the audio system is performing. In order to better understand how DSP affects performance, open up Unity and follow the given exercise:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Press play to run the scene and make sure the <strong class="userinput"><code>Audio</code></strong> panel is highlighted on the <strong class="userinput"><code>Profiler</code></strong> window. Move around the scene until you find an area where the <strong class="userinput"><code>DSP</code></strong> and <strong class="userinput"><code>Audio CPU</code></strong> usage is high.</li><li>From the menu, navigate to <strong class="userinput"><code>Window</code></strong> | <strong class="userinput"><code>Audio Mixer</code></strong>. If the <strong class="userinput"><code>Audio Mixer</code></strong> window doesn't dock beside the <strong class="userinput"><code>Console</code></strong> window, drag it into place. Select the <strong class="userinput"><code>Master</code></strong> group and make sure all the child groups are visible.</li><li>Hover your mouse around the pause button at the top of the editor and wait for what looks like a peak <strong class="userinput"><code>Audio CPU usage. When you think the stat is peaking, press the</code></strong> pause button to freeze the scene.</li><li>With the scene paused, click on the <strong class="userinput"><code>B</code></strong> button on all the mixer groups in the <strong class="userinput"><code>Audio Mixer</code></strong> window. When you are done, you mixer window should look like the following screenshot:</li></ol></div><p><strong class="userinput"><code><div class="mediaobject"><img src="/graphics/9781787286450/graphics/991ee815-e229-4ac1-9c59-c77f73b5ecf7.png" /></div></code></strong></p><p>Bypassing all the effects on the Audio Mixer</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip185"></a>Note</h3><p>If you recall, pressing the B button causes all the effects to be bypassed for that group.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>After you are done bypassing all the groups, then press the pause button again to unfreeze the game. Watch closely the Audio graph and <strong class="userinput"><code>Stats</code></strong> panels on the <strong class="userinput"><code>Profiler</code></strong> window. You will see a very clear drop in CPU usage after the scene starts running again. An example of how this will look is shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/8cb82ff3-beab-4724-a8f3-fb5607dd26aa.png" /></div><p>Observing the impact on Audio CPU performance after bypassing effects</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note186"></a>Note</h3><p>You may notice that even as you turn off all the effects, after a while, the graph goes back to being high again. This is because the plots are normalized to show a maximum value. What this means is that you want to watch the chart for any significant changes, as we saw in the preceding screenshot.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Go back to the <strong class="userinput"><code>Audio Mixer</code></strong> window and <span>click</span> all the <strong class="userinput"><code>B</code></strong> button's again to enable all the effects. Then, click on the <strong class="userinput"><code>Channels</code></strong> tab on the <strong class="userinput"><code>Profiler</code></strong> window as shown in the following screenshot:
</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/7e02dcc8-e820-4d4c-a90c-9883795d577c.png" /></div><p>Viewing the currently active Channels (audio sources)</p><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>This tab will show you the currently active <strong class="userinput"><code>Channels</code></strong> or audio sources. Go through the list and double-click on the object to highlight it in the <strong class="userinput"><code>Hierarchy</code></strong> window. Select the object in the <strong class="userinput"><code>Hierarchy</code></strong> window and then disable it in the <strong class="userinput"><code>Inspector</code></strong> window. As you go through the list, make a note of the channels which appear to make the largest impact on performance. When you have disabled all the channels, your <strong class="userinput"><code>Profiler</code></strong> window will look like the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/55ca2850-d37d-4d65-934f-07e96d978742.png" /></div><p>Audio Profiler view after all the Channels (audio sources) have been disabled
</p><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>If you want, you can go back through the list of items again just by stopping and restarting the scene. Remember, that any changes you make to a game object during runtime will be reset when you stop the scene. After you have identified the list of sources and group effects that may be problematic, stop the scene.</li></ol></div><p>What you may find surprising is that the four musical instruments are actually consuming more than half the DSP CPU. This is because of the adaptive music with vertical remixing we put together in <a class="link" href="#" linkend="ch06">Chapter 6</a>, <span class="emphasis"><em>Introduction to FMOD</em></span>, the adaptive and dynamic audio, is consuming the CPU. We will look at some options for this later, including considering FMOD for implementing adaptive audio.</p><p>That simple technique of just walking <span>through</span> the audio sources and bypassing effects will generally help identify CPU problems. However, it will not usually identify areas where audio memory may be a problem. We will look at techniques to resolve those memory and CPU performance issues in the next section.</p></div>