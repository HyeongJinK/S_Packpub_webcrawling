<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="02lvl1sec15"></a>Building a musical keyboard</h2></div></div><hr /></div><p>Now that we have looked at how quickly we <span>can</span> create a simple empty script, let's explore the possibilities of scripting audio components. As we already saw in the last chapter, it is possible to use audio components without writing any scripts. However, scripting gives you more control over an audio source with only a few lines of code.</p><p>In this section, we are going to use scripting to build a simple keyboard that you will be able to play multiple instruments with. We will even allow the keyboard to record and play back sessions. All in less than 30 lines of code. Follow the instructions here, to start creating this script:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>We will continue where we left off from the last time by jumping back into MonoDevelop. Be sure the tab showing the <code class="literal">Keyboard</code> script is open and the script shell has not been modified.</li><li>At the top of the file, just below the <code class="literal">Keyboard</code> class definition, enter the following lines of code:</li></ol></div><pre class="programlisting">private AudioSource audioSource; 
public int transpose = 0;</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip22"></a>Note</h3><p>As you type within MonoDevelop, you will notice the editor helps you complete words by making suggestions. This feature is called <span class="strong"><strong>intellisense</strong></span> and almost all code editors provide it at some level. To accept the top suggested word at any time just tap the <span class="emphasis"><em>Tab</em></span> key.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Those couple of lines <span>just</span> store the objects <code class="literal">audioSource</code> and an integer variable called <code class="literal">transpose</code>. The keyword at the start of each line denotes whether the variable is <code class="literal">public</code> or <code class="literal">private</code>. A <code class="literal">private</code> variable is only accessible within the class, while a <code class="literal">public</code> variable is visible outside the class and exposed in the editor interface. There is a way to expose <code class="literal">private</code> variables in the editor interface but we will leave that for another time.</li><li>Next, enter the following line inside the <code class="literal">Start</code> method:</li></ol></div><pre class="programlisting">audioSource = GetComponent&lt;AudioSource&gt;();</pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>That <span>line</span> just finds an <code class="literal">AudioSource</code> component attached to the GameObject and stores the value in that <code class="literal">private</code> variable we declared earlier. <code class="literal">GetComponent</code> is a special method that searches the GameObject that the script is attached to and looks for a specific component denoted within <code class="literal">&lt;&gt;</code> tags. If there is no matching component, the method will return nothing or <code class="literal">null</code>.</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note23"></a>Note</h3><p>Be sure that you always match the character case of any variable names or keywords. For instance, <code class="literal">audioSource</code> is completely different from <code class="literal">AudioSource</code>. You will also generally want to match the white space (spaces and new lines) in the code as well. While you can get away with omitting a lot of white space, it just makes the code more readable.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Pay attention when you are entering the next section of code in the <code class="literal">Update</code> method, as it is the longest piece of code you will need to enter:</li></ol></div><pre class="programlisting">var note = -1; // invalid value to detect when note is pressed
if (Input.GetKeyDown ("a")) note = 0;  // C 
if (Input.GetKeyDown ("s")) note = 2;  // D 
if (Input.GetKeyDown ("d")) note = 4;  // E 
if (Input.GetKeyDown ("f")) note = 5;  // F 
if (Input.GetKeyDown ("g")) note = 7;  // G 
if (Input.GetKeyDown ("h")) note = 9;  // A 
if (Input.GetKeyDown ("j")) note = 11; // B 
if (Input.GetKeyDown ("k")) note = 12; // C 
if (Input.GetKeyDown ("l")) note = 14; // D 

if (note &gt;= 0 &amp;&amp; audioSource != null) 
{ // if some key pressed...     
    audioSource.pitch = Mathf.Pow(2, (note+transpose) / 12.0f);
    audioSource.Play(); 
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>This section of code within the <code class="literal">Update</code> method is run every frame of the game. Generally, our game will run from 30-60 frames per second, which put another way, means that the section of code will run 30-60 times per second or more. The first line creates a variable with the <code class="literal">var</code> keyword called <code class="literal">note</code> and sets the value to <code class="literal">-1</code>. After that, it does several <code class="literal">if</code> tests to determine what the currently typed keyboard key is using a special object called <code class="literal">Input</code>. <code class="literal">Input.GetKeyDown("")</code> returns true or false depending on whether the key is pressed. If the key is pressed (true) the value for <code class="literal">note</code> is set depending on the key pressed. <code class="literal">note</code> is set to a value that matches the pitch of the key, you can see in the end of line comments which key matches which note. The last test or <code class="literal">if</code> statement is a test to see if the value for <code class="literal">note</code> is greater than or equal to zero <span class="strong"><strong>and</strong></span> (represented with &amp;&amp;) the <code class="literal">audioSource</code> is not equal to null. In order for the script to execute the code inside the if statement, both conditions must be true, hence the use of the and (<code class="literal">&amp;&amp;</code>). Finally, if a key is <span>pressed</span> and our <code class="literal">audioSource</code> has been found, we set the pitch using some math, based on the key pressed (<code class="literal">audioSource.pitch =</code>). Then, we play the <span>sound</span> by calling the <code class="literal">Play</code> method on the audio source using <code class="literal">audioSource.Play()</code>.</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip24"></a>Note</h3><p>The math function expressed by <code class="literal">Mathf.Pow(2, (note+transpose)/12.0f)</code> is used to calculate the frequency or pitch of a note using the 12-<span class="strong"><strong>tone equal temperament</strong></span> (<span class="strong"><strong>TET</strong></span>) method or 12-TET. It is a way of tuning a musical instrument to match a 12 note octave scale, or in our case, a virtual musical instrument. This allows us to tune a single note of an instrument into a full virtual instrument. In <a class="link" href="#" linkend="ch10">Chapter 10</a>, <span class="emphasis"><em>Composing Music</em></span>, we use other methods to play and create virtual musical instruments.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>After you are done entering all the code in the editor, your script should match what is shown in the screenshot here:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/52dba9a2-e408-447d-b84f-598c3174eb31.png" /></div><p>Completed script in editor.</p><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Now that we have our script written from the menu, select <strong class="userinput"><code>File</code></strong> | <strong class="userinput"><code>Save</code></strong> to save the script. After the file is saved, return it to the Unity editor and wait while the script compiles, which should only take a few seconds. At this point, you will want to open the <strong class="userinput"><code>Console</code></strong> window and make sure no red compiler errors appear. An example of a compiler error is shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/e922e0a0-9f95-4164-8bac-ad2d811747d5.png" /></div><p>Compiler errors shown in the Console window
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip25"></a>Note</h3><p>The compiler errors will often be the result of typos, incorrect case, or missing semicolons and/or braces. Try to take your time when entering a script for the first time in order to avoid these simple but frustrating mistakes.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>Unity is <span>generally</span> very helpful in locating the script error, showing the line and position. However, you can also double-click on the error in the <strong class="userinput"><code>Console</code></strong> window and your code editor will open automatically with the cursor set on the offending line.</li><li>Be sure that your script is clean of any errors, you may see some warnings (yellow yield sign), but just ignore those and then click on the play button. The scene will run empty; this is because we have yet to set or even import our instrumental notes.</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note26"></a>Note</h3><p>If you are unable to play the scene, it likely means you have a script compilation error. Verify that the console window has no errors, and if you made any changes to the script, be sure they are saved.</p></div><p>Well, hopefully you managed to get that script entered without any compiler errors. If you entered the script without any errors, give yourself a pat on the back. For those of you that had a few errors, don't get frustrated, it happens to the best of us.</p><p>If you feel that you just can't figure out this scripting thing and are completely stuck, not to worry. The completed version of the script is provided in the source code download folder called <code class="literal">Scripts</code> for this chapter.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="02lvl2sec14"></a>Importing and playing notes</h3></div></div></div><p>Of course, in order to use our new <code class="literal">Keyboard</code> script, we are going to <span>need</span> some notes recorded for at least one instrument. Let's get back into Unity and import some tunes by following the following exercise:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>From the menu, select <strong class="userinput"><code>Assets</code></strong> | <strong class="userinput"><code>Import Package</code></strong> | <strong class="userinput"><code>Custom Package...</code></strong>. A file explorer dialog will open. Use the dialog to find the book's downloaded source code for <code class="literal">Chapter_2_Assets</code> and a file inside called <code class="literal">Chapter_2_Keyboard_Tunes.unitypackage</code>. Select the file and click on the <strong class="userinput"><code>Open</code></strong> button to begin importing the asset.
</li><li>A progress dialog will quickly flash showing the <span>asset</span> being decompressed and then the <strong class="userinput"><code>Import Unity Package</code></strong> dialog will be shown as follows:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/a30b4373-f632-435a-add0-c0113dd636e0.png" /></div><p>Import Unity Package importing keyboard tunes</p><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Click on the <strong class="userinput"><code>Import</code></strong> button on the dialog to import all the tunes into the project. Again, you will see another progress dialog quickly flash and the assets will be imported.
</li><li>Select the <code class="literal">VirtualKeyboard</code> object in the <strong class="userinput"><code>Hierarchy</code></strong> window. In the <strong class="userinput"><code>Inspector</code></strong> window, expand the <strong class="userinput"><code>Audio Source</code></strong> component we added earlier. Set the component's <strong class="userinput"><code>AudioClip</code></strong> source to the <code class="literal">ukulele</code> clip by clicking on the target icon beside the setting and then selecting the item from <strong class="userinput"><code>Select AudioClip</code></strong> dialog, as shown in the screenshot here:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/f5138ba1-2883-4e7d-a381-7e11cf59bdba.png" /></div><p>Setting the AudioClip source</p><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Close the dialog after you make the selection. Keep all the defaults for the <strong class="userinput"><code>Audio Source</code></strong> component. No need to set 3D sound or other fancy audio settings.</li><li>Click on the play button to start the scene running. After the scene starts running, type some notes by typing any of the following keys a,s,d,f,g,h,j,k, or l.</li><li>Depending on your <span>musical</span> skills, you may be able to <span>play</span> notes or something that sounds like music. You can change the type of instrument anytime while the scene is running. Just be sure if you change an instrument to click back in the <strong class="userinput"><code>Game</code></strong> view, otherwise the keyboard strokes won't register.
</li></ol></div><p> </p><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>The audio sounds provided in the imported asset will generally be recorded from instruments playing a C4 note or middle C. However, not all the audio is recorded at the middle C, some of it may be other notes. If you have a musical ear you can alter the instrument so it starts from middle C by setting the <code class="literal">transpose</code> on the <code class="literal">Keyboard</code> component. A <code class="literal">transpose</code> value of +12 or -12 will increase/decrease the note by a full octave. While a transpose value of +1/-1 will tune the note up or down the scale to D (+1) or B (-1) for instance. The following chart shows how the notes are arranged and written on sheet music, with corresponding matching keyboard keys shown underneath:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/713a4a49-042c-4304-8918-3ee943e58751.jpg" /></div><p>Notes matching keyboard keys</p><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>When you are done playing the keyboard, click on the play button to stop the scene. Be sure to save the scene by selecting from the menu <strong class="userinput"><code>File</code></strong> | <strong class="userinput"><code>Save</code></strong><strong class="userinput"><code>scene</code></strong><strong class="userinput"><code>as...</code></strong>. This will open a <strong class="userinput"><code>Save Scene</code></strong> dialog, keep the default path, name the scene <code class="literal">VirtualKeyboard</code>, and click on <strong class="userinput"><code>Save</code></strong>.</li></ol></div><p>As you can see, with just a <span>small</span> amount of code, we <span>were</span> able to control playing an audio source into a virtual instrument. While the keyboard is not perfect, it certainly demonstrates the power and ease of scripting audio. In the next section, we are going to make some improvements to the <code class="literal">Keyboard</code> script in order to demonstrate other scripting and audio concepts.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="02lvl2sec15"></a>Enhancing the virtual keyboard</h3></div></div></div><p>Our Keyboard script allows us to play an audio source like an instrument. In order to demonstrate a couple of other scripting concepts with audio sources, let's add a couple of features to our script by following the following exercise:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>The first set of <span>features</span> that we will add is the ability to record a session and then play the audio back. This may sound like an incredibly complex task, but it is something we can accomplish with just a few more lines of code.</li><li>Open back up MonoDevelop or your favorite script editor and add the following lines just after the declaration of the <code class="literal">transpose</code> variable, as shown here:</li></ol></div><pre class="programlisting">public int transpose = 0; //after this line 
<span class="strong"><strong>private List&lt;int&gt; notes = new List&lt;int&gt;(); 
private int index = 0; 
public bool record; 
public bool playback;</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>The first new variable is marked <code class="literal">private</code> and is used to store the <code class="literal">notes</code> played as we record. The variable is a <code class="literal">List</code> that stores a specific type, in this case, <code class="literal">integers</code> or note values. Next, is a variable called <code class="literal">index</code>, which will be used to indicate the playback position. After that, we have two Boolean variables marked <code class="literal">public</code>, which will allow us to control if the script is recording or playing.</li><li>Make your way down to the middle of the <code class="literal">Update</code> method, the empty line between the top section of <code class="literal">if</code>'s and the bottom <code class="literal">if</code> statement and insert the following section of code:</li></ol></div><pre class="programlisting"><span class="strong"><strong>if (record) { 
   notes.Add (note); 
} else if (playback) { 
   index = index + 1; 
   if (index &gt; notes.Count - 1) 
       index = 0; 
   note = notes [index]; 
}</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>That piece of <span>code</span> may be a little tricky as you have to be careful to get all the braces (<code class="literal">{}</code>) in the right place. Apart from that, the code is fairly simple. The first <code class="literal">if</code> statement checks if the script is set to <code class="literal">record</code>, if so, then it adds the currently played note to that List, called <code class="literal">notes</code>. Next, comes a second <code class="literal">if</code> statement prefixed with an <code class="literal">else</code>. The <code class="literal">else</code> ensures that if the first test fails, then the second <code class="literal">if</code> statement will be tested. However, unlike the aforementioned multiple if statements, the first condition must fail. This if/else statement, therefore, adds two additional states or modes to our keyboard, which already had a default play state. Inside the <code class="literal">else if</code> statement, if the <code class="literal">playback</code> value is <code class="literal">true</code>, then it does a test to make sure that the incremented index value is not greater than the number of items in the list subtracted by one. We subtract by one to make sure the index value is never greater than the number of items in the list. If the value of the index is greater than the list count, we reset the index to zero in the next line. In the last line of the code <code class="literal">note = notes[index];</code>, we index or select into the list by a value represented by the <code class="literal">index</code> variable. Just remember, that while the script is in playback mode, the index value will keep looping over the values in the list. Thus, any session you record will keep looping until you stop playback.</li><li>After you are done entering those few lines, save the file and go back to the Unity editor. As mentioned earlier, make sure the script compiles with no compiler errors. If you have no compiler errors, press play. Otherwise, go back and fix the compiler errors.</li><li>As the scene is running, be sure to select the <code class="literal">VirtualKeyboard</code> object in the <strong class="userinput"><code>Hierarchy</code></strong> window, so you can look at the components in the <strong class="userinput"><code>Inspector</code></strong> window, as shown here:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787286450/graphics/189ee9de-d8c5-48e5-bf1e-339ae5e48c53.png" /></div><p>Keyboard script running in the Record mode
</p><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>Click on the checkbox next to the <strong class="userinput"><code>Record</code></strong> setting on the <strong class="userinput"><code>Keyboard</code></strong> component. Click on the mouse in the <strong class="userinput"><code>Game</code></strong> view and then type some keys to play the virtual instrument. After a 15-30 seconds of playing, click on the <strong class="userinput"><code>Record</code></strong> checkbox to stop recording. Then click on the <strong class="userinput"><code>Playback</code></strong> checkbox to play the session you just recorded.</li></ol></div><p>If you are trying to find or think of something to play, the following score is always a good starting place:</p><div class="mediaobject"><img src="/graphics/9781787286450/graphics/bfd372b5-4dea-4ec5-bab4-9024ec11c203.jpg" /></div><p>Play the song by typing the respective keys as shown, on your keyboard.</p><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Let the session play for a couple of loops. When you are finished testing the new features, click on the play button to stop the scene.</li></ol></div><p>As you can see, with just a <span>dozen</span> additional lines of code, we added a couple of significant features to our simple example. Of course, there are plenty of other features you could add to this example in order to create a full-blown synthetic keyboard, perhaps, even allowing you to create musical scores in Unity and play the songs back later in a game, similar to an <span class="strong"><strong>MIDI</strong></span> track. For now, that is all we are going to cover with this script, but feel free to add any additional <span>features</span> on your own. We will reuse this <code class="literal">Keyboard</code> script later in <a class="link" href="#" linkend="ch08">Chapter 8</a>, <span class="emphasis"><em>Visualizing Audio in Games</em></span>, syncing audio with graphics to demonstrate how audio can be synced with graphics.</p><p>If you are still feeling uncomfortable with scripting, that certainly is expected. The preceding exercise was really only intended to introduce you to a few core concepts that you can apply for the rest of the scripting examples in this chapter and the book. In the next section, we will look at another example that demonstrates more audio scripting concepts and is more practical for an actual game.</p></div></div>