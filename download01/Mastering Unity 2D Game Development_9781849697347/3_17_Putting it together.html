<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec21"></a>Putting it together</h2></div></div><hr /></div><p>So far, our hero can move to the left and right of the screen, but it is a little flat. As we have some animation in our spritesheet, let's put that into action.</p><p>As described earlier, in<a id="id256" class="indexterm"></a> order to get the animation running, we will need the following prerequisites:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>An <span class="strong"><strong>Animator</strong></span> component in our game object</p></li><li style="list-style-type: disc"><p>An <span class="strong"><strong>Animator</strong></span> controller to manage our animation that is bound to the animator</p></li><li style="list-style-type: disc"><p>At least one animation clip to play in the controller</p></li></ul></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec29"></a>Setting up the animation controller</h3></div></div></div><p>To get started, first we<a id="id257" class="indexterm"></a> need to add the <span class="strong"><strong>Animator</strong></span> component to the player's game object by navigating to <span class="strong"><strong>Add Component</strong></span> | <span class="strong"><strong>Miscellaneous</strong></span> | <span class="strong"><strong>Animator</strong></span> in the <span class="strong"><strong>Inspector</strong></span> pane. Leave all the other options alone for now.</p><p>Next, create a<a id="id258" class="indexterm"></a> new animation <span class="strong"><strong>Controller</strong></span> in <code class="literal">Assets/Animation/Controllers</code> by navigating to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Animator Controller</strong></span> in the <span class="strong"><strong>Project</strong></span> window (or by right-clicking on it while viewing the folder). Then, drag the new controller to the <span class="strong"><strong>Controller</strong></span> property<a id="id259" class="indexterm"></a> in the <span class="strong"><strong>Animator</strong></span> component we just created.</p><p>You should now have something that looks like the following screenshot:</p><p> </p><div class="mediaobject"><img src="/graphics/9781849697347/graphics/7347OT_03_15.jpg" /></div><p>Now, we just need<a id="id260" class="indexterm"></a> to add our animation clip. Open the new<a id="id261" class="indexterm"></a> animation <span class="strong"><strong>Controller</strong></span> (if you haven't done so already) by double-clicking on it, then open the <span class="strong"><strong>Animation</strong></span> window by navigating to <span class="strong"><strong>Menu</strong></span> | <span class="strong"><strong>Window</strong></span> | <span class="strong"><strong>Animation</strong></span> (or press <span class="emphasis"><em>Ctrl</em></span> or <span class="emphasis"><em>Command 6</em></span>).</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip17"></a>Tip</h3><p>You may have to rearrange your Windows at this point, as the default location for the <span class="strong"><strong>Animation</strong></span> window is next to the <span class="strong"><strong>Project</strong></span> view. I recommend moving it next to the main window so you can see both the <code class="literal">Project</code> folder and the <span class="strong"><strong>Animation</strong></span> window at the same time.</p><p>This is easily done by dragging the tab for the <span class="strong"><strong>Animation</strong></span> window to the desired point. When<a id="id262" class="indexterm"></a> it gets near a point in the editor where it can dock, it will do so automatically.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec30"></a>Adding your first animation clip (idle)</h3></div></div></div><p>To add your first<a id="id263" class="indexterm"></a> animation clip, create a new clip by opening the clip selection drop-down menu and selecting <span class="strong"><strong>[Create New Clip]</strong></span> (as shown earlier <a id="id264" class="indexterm"></a>in the <span class="emphasis"><em>Animator Dope Sheet</em></span> section, marked as item 2). This will prompt you for a location to save the new clip. Save it under <code class="literal">Assets/Animation/Clips</code> as <code class="literal">CharacterIdle.anim</code>.</p><p>For the idle<a id="id265" class="indexterm"></a> animation, we only need to add one sprite to show the hero standing at rest, so drag the sprite named <span class="strong"><strong>01_5</strong></span> onto the timeline at position <span class="strong"><strong>0</strong></span>, as shown here:</p><div class="mediaobject"><img src="/graphics/9781849697347/graphics/7347OT_03_16.jpg" /></div><p>The <span class="strong"><strong>Animation</strong></span> controller should<a id="id266" class="indexterm"></a> now look like the following screenshot, with a single state for<a id="id267" class="indexterm"></a> the idle<a id="id268" class="indexterm"></a> animation (highlighted in orange to denote it is in the default state):</p><div class="mediaobject"><img src="/graphics/9781849697347/graphics/7347OT_03_17.jpg" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec31"></a>Adding another animation clip (run)</h3></div></div></div><p>To add the running animation, you'll need to add another clip. This<a id="id269" class="indexterm"></a> time it is called <code class="literal">CharacterRun</code>, and instead<a id="id270" class="indexterm"></a> of just dragging a single sprite, we will add three sprites to form one animation set. First, set<a id="id271" class="indexterm"></a> the <span class="strong"><strong>Sample</strong></span> rate to <code class="literal">12</code> in the <span class="strong"><strong>Animation</strong></span> window; select the <span class="strong"><strong>01_2</strong></span>, <span class="strong"><strong>01_3</strong></span>, and <span class="strong"><strong>01_4</strong></span> sprites together and drag them to the timeline window, which will order them on the timeline appropriately as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849697347/graphics/7347OT_03_18.jpg" /></div><a id="id272" class="indexterm"></a><p>Looking at <a id="id273" class="indexterm"></a>the <span class="strong"><strong>Animation</strong></span> controller now, you will see that an additional state is added to the view; the <a id="id274" class="indexterm"></a>main difference being that it is gray (as it's not the default), and at this point, nothing connects the two states together:</p><div class="mediaobject"><img src="/graphics/9781849697347/graphics/7347OT_03_19.jpg" /></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip18"></a>Tip</h3><p>You can also create<a id="id275" class="indexterm"></a> the animation clips with multiple sprites by selecting the sprites in the <span class="strong"><strong>Project</strong></span> view and dragging them together to the <span class="strong"><strong>Scene</strong></span> or <span class="strong"><strong>Project</strong></span> hierarchy. This will automatically create a new game object complete with <span class="strong"><strong>Sprite Renderer</strong></span>, <span class="strong"><strong>Animation</strong></span> component, <span class="strong"><strong>Animation Controller</strong></span>, and <span class="strong"><strong>Clip</strong></span> for the set. If you start this way and add an<a id="id276" class="indexterm"></a> idle animation clip later, just be sure to check which state is the default state.</p><p>There is a lot of <a id="id277" class="indexterm"></a>power in Unity to automate the creation of animations.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec32"></a>Connecting animation states</h3></div></div></div><p>At the moment, our two<a id="id278" class="indexterm"></a> states are not connected. So when we run<a id="id279" class="indexterm"></a> the project, the hero is always idle (lazy guy); let's change that.</p><p>To tell the controller to move between the two states, we need the following prerequisites:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>A transition link between the two states</p></li><li style="list-style-type: disc"><p>A parameter or event to activate the transition</p></li><li style="list-style-type: disc"><p>Something to change the value of that parameter, usually in a script</p></li></ul></div><p>So, first we create the transition between the default idle state by right-clicking on the <span class="strong"><strong>CharacterIdle</strong></span> state<a id="id280" class="indexterm"></a> and selecting <span class="strong"><strong>Make Transition</strong></span>. This <a id="id281" class="indexterm"></a>will change the mouse cursor to an arrow. Then, click on the state we want to transition to, which in this case is<a id="id282" class="indexterm"></a> the <span class="strong"><strong>CharacterRun</strong></span> state. Clicking <a id="id283" class="indexterm"></a>on the new transition shows you the properties of that transition in the inspector, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849697347/graphics/7347OT_03_20.jpg" /></div><p>As shown in the <span class="strong"><strong>Inspector</strong></span> pane, at the lower-right corner, by default, the new transitions are controlled by<a id="id284" class="indexterm"></a> a single parameter called <span class="strong"><strong>Exit Time</strong></span>, which simply<a id="id285" class="indexterm"></a> means that when the first animation ends, it will transition to the second. We don't want that here as we want to control when the <span class="strong"><strong>Run</strong></span> animation is activated.</p><p>First, we need a new parameter, which we will be able to access later from our character controller script. So click on the <span class="strong"><strong>+</strong></span> symbol as indicated in the parameter section of the animation controller and add a new <span class="strong"><strong>Float</strong></span> parameter called <code class="literal">speed</code>.</p><div class="mediaobject"><img src="/graphics/9781849697347/graphics/7347OT_03_21.jpg" /></div><p>Now in the <span class="strong"><strong>Inspector</strong></span> pane, change the <span class="strong"><strong>Exit Time</strong></span> parameter by clicking<a id="id286" class="indexterm"></a> on it and selecting the new <a id="id287" class="indexterm"></a>
<span class="strong"><strong>speed</strong></span> parameter; give it a value of <code class="literal">0.1</code>. This tells the animator that when the speed is greater than 0.1 units, it will transition from the idle state to the run state.</p><p>Next, repeat the process<a id="id288" class="indexterm"></a> and add a transition from the <span class="strong"><strong>CharacterRun</strong></span> state back to the <span class="strong"><strong>CharacterIdle</strong></span> state, choosing the same parameter value; however, this<a id="id289" class="indexterm"></a> time, set it to <span class="strong"><strong>Less</strong></span> with a value of <code class="literal">0.1</code>, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849697347/graphics/7347OT_03_22.jpg" /></div><p>If you run the project at this point, the character still doesn't run when it moves. For this, we need to<a id="id290" class="indexterm"></a> update <a id="id291" class="indexterm"></a>our <span class="strong"><strong>Character</strong></span> movement script.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec33"></a>Accessing controllers from a script</h3></div></div></div><p>Like most things<a id="id292" class="indexterm"></a> in Unity, to access another component, we just<a id="id293" class="indexterm"></a> need a reference to it. With the animation controllers, it is no different.</p><p>Update your <code class="literal">CharacterMovement.cs</code> script<a id="id294" class="indexterm"></a> by performing the following steps:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>A new <span class="strong"><strong>Animator</strong></span> reference to hold a link to our sprites animator is needed, as mentioned in the<a id="id295" class="indexterm"></a> following code:</p><div class="informalexample"><pre class="programlisting">//Reference to the player's animator component.
private Animator anim;</pre></div></li><li style="list-style-type: disc"><p>Discover the actual animator from the sprite object within the <code class="literal">Awake</code> function<a id="id296" class="indexterm"></a> to ensure we capture it at startup using using the technique we highlighted earlier in <a class="link" href="#" linkend="ch02">Chapter 2</a>, <span class="emphasis"><em>Character Building, for accessing components</em></span>; in this case, the <code class="literal">Rigidbody2D</code> component:</p><div class="informalexample"><pre class="programlisting">void Awake()
{
  //Setting up references.
  playerRigidBody2D = (Rigidbody2D)GetComponent(typeof(Rigidbody2D));
}</pre></div></li><li style="list-style-type: disc"><p>In the<a id="id297" class="indexterm"></a> <code class="literal">Update</code> function, we update a <code class="literal">float</code> parameter<a id="id298" class="indexterm"></a> we defined earlier in the animator with the value of the movement that we got from the user control. Refer to the following code:</p><div class="informalexample"><pre class="programlisting">void Update(){
  //Cache the horizontal input.
  movePlayerVector = Input.GetAxis("Horizontal");
  
<span class="strong"><strong>  anim.SetFloat("speed", Mathf.Abs(movePlayerVector));</strong></span>
</pre></div></li></ul></div><p>Now if you run the project, your hero will start <a id="id299" class="indexterm"></a>running in the correct direction when you tell him to and then rest when you stop.</p><p>If you also arrange<a id="id300" class="indexterm"></a> Windows in a way that you can see both the <span class="strong"><strong>Game</strong></span> and <span class="strong"><strong>Animator</strong></span> windows at the<a id="id301" class="indexterm"></a> same time, you will see that each state will become active as and when it reacts to the input.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec34"></a>Extra credit</h3></div></div></div><p>We have a nice run and stand animation, but wouldn't it be better if our hero had a spring in his step? So let's extend<a id="id302" class="indexterm"></a> our running animation, and also highlight one of the pitfalls of doing so and how to fix it by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Select the <span class="strong"><strong>Player</strong></span> game object, open the <span class="strong"><strong>Animation</strong></span> window, and select the <span class="strong"><strong>CharacterRun</strong></span> animation clip.</p></li><li><p>Click on the middle keyframe in the animation.</p></li><li><p>In the <span class="strong"><strong>Inspector</strong></span> pane, change the <span class="strong"><strong>Y Transform</strong></span> value to <code class="literal">0.1</code>.</p></li></ol></div><p>This will update your animation as follows:</p><div class="mediaobject"><img src="/graphics/9781849697347/graphics/7347OT_03_23.jpg" /></div><p>However, when you now run your project and make the hero run around, you will see the hero doing his new run animation and bobbing up and down as expected. However, it will soon stop moving; what the heck? The reason is simple; by setting the <span class="strong"><strong>Y</strong></span> property of the game objects in the <span class="strong"><strong>Transform</strong></span> pane, you also have to set the <span class="strong"><strong>X</strong></span> and <span class="strong"><strong>Z</strong></span> properties to <code class="literal">0</code> because they are all part of the <span class="strong"><strong>Transform</strong></span> pane's<a id="id303" class="indexterm"></a> <span class="strong"><strong>Vector3</strong></span> property. This may be changed in future versions of Unity. However, currently, it isn't possible to just animate a single property of constructs, such as vectors or other complex types.</p><p>There is a workaround, which is more on the lines of how you should create complex game objects that have <a id="id304" class="indexterm"></a>many parts. Just split <span class="strong"><strong>Character</strong></span> from the rendering of its sprite by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Rename our current <span class="strong"><strong>Player</strong></span> game object to <code class="literal">PlayerSprite</code>.</p></li><li><p>Create a new game object named <code class="literal">Player</code>.</p></li><li><p>Click and drag the <a id="id305" class="indexterm"></a>
<span class="strong"><strong>PlayerSprite</strong></span> game object to be a child of the <span class="strong"><strong>Player</strong></span> game object.</p></li><li><p>Reset all the <span class="strong"><strong>Transform</strong></span> pane's values of both the <span class="strong"><strong>Player</strong></span> and <span class="strong"><strong>PlayerSprite</strong></span> game objects (otherwise, everything will be an offset).</p></li><li><p>Remove the <code class="literal">CharacterMovement</code> script, <code class="literal">RigidBody 2D</code>, and <code class="literal">Box Collider 2D</code> components from the <span class="strong"><strong>PlayerSprite</strong></span> game object and add them to the <span class="strong"><strong>Player</strong></span> game object again.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note27"></a>Note</h3><p>Also, be sure to update the options of the physics components and the bounds of the box collider. This is because they are not on the sprite object; they no longer automatically recognize the regions they need to work with but just tweak them until they are correct.</p></div></li></ol></div><p>The <span class="strong"><strong>Player</strong></span> (<span class="strong"><strong>Controller</strong></span>) game object view will look like the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849697347/graphics/7347OT_03_24.jpg" /></div><p>The <span class="strong"><strong>PlayerSprite</strong></span> (<span class="strong"><strong>Animator</strong></span>/<span class="strong"><strong>Sprite Renderer</strong></span>) game<a id="id306" class="indexterm"></a> object view is shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849697347/graphics/7347OT_03_25.jpg" /></div><p>With our scene reordered, the player's movements and physics are controlled by the parent <span class="strong"><strong>Player</strong></span> object, and the <span class="strong"><strong>Sprite Rendering</strong></span> and <span class="strong"><strong>Animator</strong></span> are controlled by the child <span class="strong"><strong>PlayerSprite</strong></span> object. We just<a id="id307" class="indexterm"></a> need to update our control script <a id="id308" class="indexterm"></a>so it knows where to find everything. Perform the following step:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Edit the <code class="literal">CharacterMovement.cs</code> C# script and update it as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Add a reference to the point of the new <span class="strong"><strong>PlayerSprite</strong></span> game object as follows:</p><div class="informalexample"><pre class="programlisting">    //Reference to the player's sprite GameObject.
<span class="strong"><strong>    private GameObject playerSprite;</strong></span>
</pre></div></li><li style="list-style-type: disc"><p>Add discovery for the <span class="strong"><strong>PlayerSprite</strong></span> game object and alter the discovery for the animation component based on the new <code class="literal">playerSprite</code> reference as follows:</p><div class="informalexample"><pre class="programlisting">    void Awake()
    {
      // Setting up references.
      playerRigidBody2D = (Rigidbody2D)GetComponent(typeof(Rigidbody2D));
<span class="strong"><strong>      playerSprite = transform.Find("PlayerSprite").gameObject;</strong></span>
<span class="strong"><strong>      anim = (Animator)playerSprite.GetComponent(typeof(Animator));</strong></span>
    }</pre></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip19"></a>Tip</h3><p>Make sure you have renamed the GameObjects as shown in the previous screenshot or this will give an error when you run the project.</p></div></li><li style="list-style-type: disc"><p>Alter the <code class="literal">Flip()</code> logic to work with the <span class="strong"><strong>PlayerSprite</strong></span> game object's rendering option as follows:</p><div class="informalexample"><pre class="programlisting">    void Flip()
    {
      //Switch the way the player is labelled as facing.
      facingRight = !facingRight;

      //Multiply the player's x local scale by -1.
<span class="strong"><strong>      Vector3 theScale = playerSprite.transform.localScale;</strong></span>
<span class="strong"><strong>      theScale.x *= -1;</strong></span>
<span class="strong"><strong>      playerSprite.transform.localScale = theScale;</strong></span>
    }</pre></div></li></ul></div></li></ol></div><p>So, when we run the<a id="id309" class="indexterm"></a> game now, the entire <span class="strong"><strong>Player</strong></span> object is moved by the script and the animation runs independently.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec35"></a>Getting curvy</h3></div></div></div><p>As a nice last touch, let's clean up the running of the animation to be a bit smoother. At present, the hero jerks <a id="id310" class="indexterm"></a>up and down with<a id="id311" class="indexterm"></a> the frames it has, but we can improve this by using the <span class="strong"><strong>Curves</strong></span> features of the <span class="strong"><strong>Animation</strong></span> editor.</p><p>To do this, let's make some space in the <span class="strong"><strong>Animation</strong></span> window's timeline to add a few extra frames by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Move the last keyframe back from <span class="strong"><strong>0.02</strong></span> to <span class="strong"><strong>0.04</strong></span>.</p></li><li><p>Drag the <span class="strong"><strong>01_3</strong></span> sprite again onto the timeline at <span class="strong"><strong>0.02</strong></span> and <span class="strong"><strong>0.03</strong></span>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note28"></a>Note</h3><p>You should now have five frames in the animation.</p></div></li><li><p>Set the <span class="strong"><strong>Position.y</strong></span> property from <code class="literal">0.01</code> to <code class="literal">0.05</code>.</p></li><li><p>Set the <span class="strong"><strong>Position.y</strong></span> property from <code class="literal">0.02</code> to <code class="literal">0.1</code>.</p></li><li><p>Set the <span class="strong"><strong>Position.y</strong></span> property from <code class="literal">0.03</code> to <code class="literal">0.05</code>.</p></li><li><p>Click on the <span class="strong"><strong>Curves</strong></span> button at the bottom of the Animator window to switch between the views.</p></li></ol></div><p>With extra frames and settings, you should now see the curve as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849697347/graphics/7347OT_03_26.jpg" /></div><p>Now, while<a id="id312" class="indexterm"></a> running the project, the slight<a id="id313" class="indexterm"></a> hop in our hero's step should look a lot smoother.</p></div></div>