<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl2sec90"></a>The missing random piece</h2></div></div><hr /></div><p>We have <a id="id664" class="indexterm"></a>our battle scene up and running, and when the player runs away he/she will still be at the place on the map where the battle occurred. Wouldn't it be nice to also enter the battle scene? So let's add that.</p><p>To keep things simple (you can always extend it later), we will just use a simple probability to work out whether the player is likely to enter a battle while travelling. If a battle is going to occur, we just figure out then where on the player's journey the battle will take place. This way it looks random and catches the player off guard when it happens (if it does, there's always a chance it won't).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note95"></a>Note</h3><p>Alternatively, you could place empty game objects on the scene with colliders to change the probability of an event occurring and have a script to start a battle if one happens. Similar techniques are used in the Pokemon style games where deep grassy areas always have a higher probability of a random battle occurring.</p></div><p>So to start off, we will add a couple of extra parameters to control the battle event probability in the <code class="literal">MapMovement</code> script, as follows:</p><div class="informalexample"><pre class="programlisting">int EncounterChance = 100;
float EncounterDistance = 0;</pre></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip51"></a>Tip</h3><p>Ideally, the <code class="literal">EncounterChance</code> parameter should be controlled by some logic based on the player's level and how dangerous the area of the world they are currently in, but you can extend that later if you wish.</p><p>It is set to <code class="literal">100</code> for now to ensure the player will always hit the first battle to send him home.</p></div><p>Next, in the <code class="literal">Update</code> method where we track when a player taps or clicks on the map to move, we <a id="id665" class="indexterm"></a>check the probability of an event occurring. If that event occurs, then set the <code class="literal">EncounterDistance</code> property as follows to denote when the event will occur along the player's journey:</p><div class="informalexample"><pre class="programlisting">if (inputActive &amp;&amp; Input.GetMouseButtonUp(0))
{
    StartLocation = transform.position.ToVector3_2D();
    timer = 0;
    TargetLocation =
     WorldExtensions.GetScreenPositionFor2D(Input.mousePosition);

    startedTravelling = true;

    //Work out if a battle is going to happen and if it's likely 
    //then set the distance the player will travel before it 
    //happens
<span class="strong"><strong>    var EncounterProbability = Random.Range(1, 100);</strong></span>
<span class="strong"><strong>    if (EncounterProbability &lt; EncounterChance &amp;&amp; </strong></span>
<span class="strong"><strong>        !GameState.PlayerReturningHome</strong></span>
<span class="strong"><strong>    {</strong></span>
<span class="strong"><strong>        EncounterDistance = (Vector3.Distance(StartLocation,</strong></span>
<span class="strong"><strong>        TargetLocation) / 100) * Random.Range(10, 100);</strong></span>
<span class="strong"><strong>    }</strong></span>
<span class="strong"><strong>    else</strong></span>
<span class="strong"><strong>    {</strong></span>
<span class="strong"><strong>        EncounterDistance = 0;</strong></span>
<span class="strong"><strong>    }</strong></span>
}</pre></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip52"></a>Tip</h3><p>At this point, you will notice that the code between touch and click is becoming duplicated; try to refactor this (clean it up) so less code is duplicated. There is no spoon.</p></div><p>We know that if an <a id="id666" class="indexterm"></a>event occurs and when it does, all that is left is to act on it. So, in the <code class="literal">Update</code> method where we animate the player across the screen, we simply need an additional check to see whether we have travelled to the event and if so, stop and enter the battle. We can do so using the following code:</p><div class="informalexample"><pre class="programlisting">    if (TargetLocation != Vector3.zero &amp;&amp; TargetLocation !=
    transform.position &amp;&amp; TargetLocation != StartLocation)
    {
        transform.position = 
            Vector3.Lerp(StartLocation, 
                TargetLocation, 
        MovementCurve.Evaluate(timer));
        timer += Time.deltaTime;
    }
    if (startedTravelling &amp;&amp; Vector3.Distance(StartLocation,
        transform.position.ToVector3_2D()) &gt; 0.5)
    {
        this.collider2D.enabled = true;
        startedTravelling = false;
    }

    //If there is an encounter distance, then a battle must occur. 
    //So when the player has travelled far enough, 
    //stop and enter the battle scene
<span class="strong"><strong>    if (EncounterDistance &gt; 0)</strong></span>
<span class="strong"><strong>    {</strong></span>
<span class="strong"><strong>        if (Vector3.Distance(StartLocation, </strong></span>
<span class="strong"><strong>            transform.position) &gt; EncounterDistance)</strong></span>
<span class="strong"><strong>        {</strong></span>
<span class="strong"><strong>            TargetLocation = Vector3.zero;</strong></span>
<span class="strong"><strong>            NavigationManager.NavigateTo("Battle");</strong></span>
<span class="strong"><strong>        }</strong></span>
<span class="strong"><strong>    }</strong></span>
</pre></div></div>