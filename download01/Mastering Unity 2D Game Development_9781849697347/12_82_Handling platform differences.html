<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch12lvl1sec75"></a>Handling platform differences</h2></div></div><hr /></div><p>Unity<a id="id1206" class="indexterm"></a> does a lot for developers to abstract us from the many platforms you can deploy to. Most of the common functions, such as memory management, audio, controller inputs, purchasing, and so on, are all implemented with a single generic interface with Unity3D. This means you do not need to write a separate code to play an audio file, or draw to the screen for each and every device or platform that you want to support and deploy to. It really is a big time saver (ask anyone who has written their own engine just how much fun they had doing everything multiple times for each platform).</p><p>Unity does a lot, but it doesn't do everything. For the following fringe areas, you will have to do the leg work to get these features implemented:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Social integration (Facebook and so on)</p></li><li style="list-style-type: disc"><p>In-app purchasing</p></li><li style="list-style-type: disc"><p>Alternate physics or networking implementations</p></li></ul></div><p>The list<a id="id1207" class="indexterm"></a> goes on. In a lot of cases, there are already pre-made assets on the Unity store that have done the hard work to build these implementations. A fair few, you will note, do not support all platforms. In these cases, it will get you most of the way, but you will either have to wait for them to support platform X or write it yourself.</p><p>In all cases, assets need to integrate tightly with the underlying platform. They have made use of the interoperability features available in Unity, which this chapter will go through in detail, what each asset has to offer, and what it brings to the table. Some are simple to perform, others not so much. Also, in some cases, you will have to work with the Unity platform build system to push your changes onto the platform (though not absolutely necessary, this will save you from having to repeat every build or if you want to create your assets). The following diagram shows the layout of how Unity works with the platforms it supports:</p><div class="mediaobject"><img src="/graphics/9781849697347/graphics/7347OT_12_01.jpg" /></div><p>In <a id="id1208" class="indexterm"></a>general, the patterns you need to support are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Using different code paths with directives</p></li><li style="list-style-type: disc"><p>Accessing the native platform from Unity</p></li><li style="list-style-type: disc"><p>Calling the platforms from Unity</p></li><li style="list-style-type: disc"><p>Implementing reusable libraries that are natively compiled to work on all platforms</p></li></ul></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec145"></a>Preprocessor directives</h3></div></div></div><p>When<a id="id1209" class="indexterm"></a> you want the code to run in a particular<a id="id1210" class="indexterm"></a> way on one platform and in a different way on another, you can use the precompiler directives to tell Unity to pick one section of code over another (when it builds the project), or to simply ignore the sections of the code. This is also true for the editor, which Unity considers a platform, just like any other. So, we can have the code to run and deploy in the editor, but restrict its execution when it's deployed to another platform. You could say the special editor classes do this, but you may also want to do this with any other code.</p><p>The <a id="id1211" class="indexterm"></a>preprocessor directives (or the platform defines) that <a id="id1212" class="indexterm"></a>Unity recognizes are listed in the following table:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col align="left" /><col align="left" /></colgroup><thead><tr><th style="border-bottom: 0.5pt solid ; " align="left" valign="bottom">
<p>Statement</p>
</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_EDITOR</code></p>
</td><td style="" align="left" valign="top">
<p>This code will run <a id="id1213" class="indexterm"></a>only in the editor, not on a platform</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_EDITOR_WIN</code></p>
</td><td style="" align="left" valign="top">
<p>This code specifically<a id="id1214" class="indexterm"></a> targets the editor on Windows (if you have the code that runs differently than on a Mac)</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_EDITOR_OSX</code></p>
</td><td style="" align="left" valign="top">
<p>This<a id="id1215" class="indexterm"></a> code specifically targets the editor on Mac (if you have the code that runs differently than on a PC)</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_STANDALONE</code></p>
</td><td style="" align="left" valign="top">
<p>This code targets the<a id="id1216" class="indexterm"></a> desktop platforms (Windows/Mac/Linux)</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_STANDALONE_OSX</code></p>
</td><td style="" align="left" valign="top">
<p>This code targets<a id="id1217" class="indexterm"></a> Mac OS X only (this includes Universal, PPC, and Intel architectures)</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_DASHBOARD_WIDGET</code></p>
</td><td style="" align="left" valign="top">
<p>This code targets<a id="id1218" class="indexterm"></a> the Mac OS X dashboard widget deployments</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_STANDALONE_WIN</code></p>
</td><td style="" align="left" valign="top">
<p>This <a id="id1219" class="indexterm"></a>code targets the Windows desktop only (excluding Windows 8)</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_STANDALONE_LINUX</code></p>
</td><td style="" align="left" valign="top">
<p>This code targets<a id="id1220" class="indexterm"></a> the Linux desktop clients only</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_WEBPLAYER</code></p>
</td><td style="" align="left" valign="top">
<p>This code targets<a id="id1221" class="indexterm"></a> the Web players</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_WII</code></p>
</td><td style="" align="left" valign="top">
<p>This code targets the <a id="id1222" class="indexterm"></a>Wii platform only</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_IPHONE</code></p>
</td><td style="" align="left" valign="top">
<p>This code targets <a id="id1223" class="indexterm"></a>the iPhone platform only</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_ANDROID</code></p>
</td><td style="" align="left" valign="top">
<p>This code targets the<a id="id1224" class="indexterm"></a> Android platform only</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_PS3</code></p>
</td><td style="" align="left" valign="top">
<p>This <a id="id1225" class="indexterm"></a>code targets the PlayStation 3 platform only</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_XBOX360</code></p>
</td><td style="" align="left" valign="top">
<p>This code targets the<a id="id1226" class="indexterm"></a> Xbox 360 platform only</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_FLASH</code></p>
</td><td style="" align="left" valign="top">
<p>This code targets the <a id="id1227" class="indexterm"></a>Adobe Flash platform only</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_BLACKBERRY</code></p>
</td><td style="" align="left" valign="top">
<p>This code targets<a id="id1228" class="indexterm"></a> the BlackBerry10 platform only</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_WP8</code></p>
</td><td style="" align="left" valign="top">
<p>This <a id="id1229" class="indexterm"></a>code targets the Windows Phone 8 platform only</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_WP_8_1</code></p>
</td><td style="" align="left" valign="top">
<p>This code targets <a id="id1230" class="indexterm"></a>the Windows Phone 8.1 app or Universal projects on Windows Phone 8</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_METRO / NETFX_COREÂ </code></p>
</td><td style="" align="left" valign="top">
<p>This code<a id="id1231" class="indexterm"></a> targets the Windows Store 8.0, Windows Store 8.1, and Universal 8.1 apps</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_METRO_8_0</code></p>
</td><td style="" align="left" valign="top">
<p>This code targets the <a id="id1232" class="indexterm"></a>Windows 8.0 platform only</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_METRO_8_1</code></p>
</td><td style="" align="left" valign="top">
<p>This code targets the <a id="id1233" class="indexterm"></a>Windows 8.1 apps or Universal projects on Windows 8.1</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_WINRT</code></p>
</td><td style="" align="left" valign="top">
<p>This code targets all <a id="id1234" class="indexterm"></a>the RT-based platforms, including Windows Phone and Windows 8, regardless of the version</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_WINRT_8_0</code></p>
</td><td style="" align="left" valign="top">
<p>This code targets all <a id="id1235" class="indexterm"></a>the RT-based platforms, including Windows Phone 8.0 and Windows 8.0</p>
</td></tr><tr><td style="" align="left" valign="top">
<p><code class="literal">UNITY_WINRT_8_1</code></p>
</td><td style="" align="left" valign="top">
<p>This code targets all the<a id="id1236" class="indexterm"></a> RT-based platforms, including Windows Phone 8.1, Windows 8.1, and the Universal apps</p>
</td></tr></tbody></table></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note148"></a>Note</h3><p>It's worth noting that you are not limited to just the Unity preprocessor directives. You can use Visual Studio's directives or even create your own by adding the following class to the top of your <code class="literal">#define MyDirective</code> class (no semicolon). Then, you can block out sections of your code by enabling or disabling this line. If a directive does not exist, it will always be skipped.</p></div><p>To<a id="id1237" class="indexterm"></a> use these directives, we will simply <a id="id1238" class="indexterm"></a>declare them with an <code class="literal">#if</code> statement to surround the code we want to target. For example, if you recall in <a class="link" href="#" linkend="ch11">Chapter 11</a>, <span class="emphasis"><em>Onward Wary Traveler</em></span>, we learned that <code class="literal">File</code> classes don't work for Windows 8 because the OS does not have the <code class="literal">File</code> class or more specifically, the <code class="literal">System.IO</code> class (if you build the project for Windows 8 currently, you will get lots of such errors). So, to be able to load the files for Windows 8, you need to use different code.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl3sec91"></a>Updating the save system for another platform</h4></div></div></div><p>To<a id="id1239" class="indexterm"></a> walk through <a id="id1240" class="indexterm"></a>the use of preprocessor directives, let's handle one such platform that needs some attention, that is, Windows 8. In Unity's implementation on Windows 8 (due to its asynchronous way of working), they have added some specialized classes because the default implementations of these classes are not available on Windows 8 (in this case, the <code class="literal">File</code> class). On Windows 8, you need to use the <code class="literal">UnityEngine.Windows.File</code> class instead of the normal <code class="literal">UnityEngine.File</code> class.</p><p>So, open up the <code class="literal">GameState</code> script and update the following code by adding the highlighted snippet:</p><div class="informalexample"><pre class="programlisting">  public static void SaveState()
  {
    try
    {
      PlayerPrefs.SetString("CurrentLocation", Application.loadedLevelName);
      var playerSerializedState = SerializerHelper.Serialise&lt;PlayerSaveState&gt;
      (CurrentPlayer.GetPlayerSaveState());
<span class="strong"><strong>      #if UNITY_METRO</strong></span>
<span class="strong"><strong>      UnityEngine.Windows.File.WriteAllBytes(saveFilePath, playerSerializedState);</strong></span>
<span class="strong"><strong>      #else</strong></span>
      using (var file = File.Create(saveFilePath))
      {
        file.Write(playerSerializedState, 0, playerSerializedState.Length);
      }
<span class="strong"><strong>      #endif</strong></span>
    }
    catch
    {
      Debug.LogError("Saving data failed");
    }
  }</pre></div><p>In <a id="id1241" class="indexterm"></a>the preceding <a id="id1242" class="indexterm"></a>code, we have added a preprocessor directive for the <code class="literal">UNITY_METRO</code> target (and moved up the <code class="literal">playerSerializedState</code> variable as it can be used by all platforms).</p><p>Now when you build for Windows 8, it will use the first block of code. For all other platforms, it will use the second block.</p><p>We have to perform something similar for the <code class="literal">LoadState</code> class as follows:</p><div class="informalexample"><pre class="programlisting">  public static void LoadState(Action LoadComplete)
  {
    <span class="strong"><strong>PlayerSaveState LoadedPlayer;</strong></span>
    try
    {
      if (SaveAvailable)
      {
<span class="strong"><strong>        #if UNITY_METRO</strong></span>
<span class="strong"><strong>        var playerSerializedState = UnityEngine.Windows.File.ReadAllBytes(saveFilePath);</strong></span>
<span class="strong"><strong>        LoadedPlayer = SerializerHelper.DeSerialise&lt;PlayerSaveState&gt;</strong></span>
<span class="strong"><strong>        (playerSerializedState);</strong></span>
<span class="strong"><strong>        #else</strong></span>
        //Get the file
        using (var stream = File.Open(saveFilePath, FileMode.Open))
        {
          LoadedPlayer = SerializerHelper.DeSerialise&lt;PlayerSaveState&gt;
          (stream);
        }
<span class="strong"><strong>        #endif</strong></span>
        CurrentPlayer = LoadedPlayer.LoadPlayerSaveState(CurrentPlayer);
        }
      }
      catch
      {
      Debug.LogError("Loading data failed, file is corrupt");
    }
    LoadComplete();
  }</pre></div><p>Additionally, since the <code class="literal">File</code> class on Windows 8 only returns a byte array (<code class="literal">byte[]</code>), we need <a id="id1243" class="indexterm"></a>an additional <code class="literal">deserialize</code> function to<a id="id1244" class="indexterm"></a> work with the byte arrays instead of a stream. So, open the <code class="literal">SerializationHelper</code> script and add the following method:</p><div class="informalexample"><pre class="programlisting">public static T DeSerialise&lt;T&gt;(byte[] input)
{
  T output = default(T);
  //Create an XML formatter
  var serializer = new XmlSerializer(typeof(T));
  try
  {
    //Create an in-memory stream with the serialsed data in it
    using (var stream = new MemoryStream(input))
    {
      //Deserialize the data from the stream
      output = (T)serializer.Deserialize(stream);
    }
  }
  catch { }

  //Return the deserialized output
  return output;
}</pre></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip97"></a>Tip</h3><p>If you want to keep things simple, you can also convert the <code class="literal">load</code> function to always pass a byte array for all platforms, and get rid of the first deserialization method.</p></div><p>Finally, one last fix. If you build for Windows 8 now, you will still have one error that remains<a id="id1245" class="indexterm"></a> in the <code class="literal">SerializationHelper</code> script. This is because the implementation of the <code class="literal">MemoryStream</code> class on Windows 8 doesn't have a <code class="literal">GetStream</code> method. Now, you can use <a id="id1246" class="indexterm"></a>another preprocessor directive and use a different implementation for Windows 8. However, in this case, if you simply switch to using the <code class="literal">ToArray()</code> method, it'll give you the result you want.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note149"></a>Note</h3><p>This may not always be the case! If you need to encode data for text or images, you may find that using <code class="literal">ToArray</code> doesn't fit because it can output the data differently, and you may potentially lose some data in certain formats. Just test and check whether it still behaves as you require!</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl3sec92"></a>Build note</h4></div></div></div><p>Currently, there<a id="id1247" class="indexterm"></a> have been a few inconsistencies<a id="id1248" class="indexterm"></a> among the builds of Unity. In some builds, the project works fine; in others, it crashes when you try to use the singleton classes.</p><p>In testing, it seems as though the execution order of singletons is altered, and they are actually destroyed after they are created. This mostly seems to affect the .NET-based builds.</p><p>If this happens, you will need to compensate with a minor update to the singleton script in <code class="literal">Assets\Scripts\Classes</code> and update the <code class="literal">OnDestroy</code> method with the following code:</p><div class="informalexample"><pre class="programlisting">  public void OnDestroy()
  {
<span class="strong"><strong>    #if !UNITY_METRO</strong></span>
    applicationIsQuitting = true;
<span class="strong"><strong>    #endif</strong></span>
  }</pre></div><p>By specifying <code class="literal">!UNITY_METRO</code>, we are stating that this code should be run on all platforms except Windows 8 (in the last tested build 4.5.2, Windows phone was unaffected). If you find this <a id="id1249" class="indexterm"></a>occurring on other platforms, add them to <a id="id1250" class="indexterm"></a>the ignore list. Consider the following instance:</p><div class="informalexample"><pre class="programlisting">#if !UNITY_METRO &amp;&amp; !UNITY_ANDROID</pre></div><p>This process doesn't actually destroy the singleton script as it is recreated each time it is used (if it has already been destroyed). However, this flag is there to ensure that it is not recreated when the application is actually shutting down.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec146"></a>Getting access to Unity</h3></div></div></div><p>The first<a id="id1251" class="indexterm"></a> and simplest bridge between<a id="id1252" class="indexterm"></a> the platforms is to allow access to your Unity game <a id="id1253" class="indexterm"></a>from a native platform. As you can see in the following diagram, the first challenge is to enable a platform to talk to your Unity package:</p><div class="mediaobject"><img src="/graphics/9781849697347/graphics/7347OT_12_02.jpg" /></div><p>On <a id="id1254" class="indexterm"></a>the .NET platforms such as Windows<a id="id1255" class="indexterm"></a> and Windows phone, the following two patterns<a id="id1256" class="indexterm"></a> are used to access the game embedded within the Unity player directly from the host platform:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">UnityEngine</code> namespace from the Unity player</p></li><li style="list-style-type: disc"><p>The static classes in your Unity project</p></li></ul></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl3sec93"></a>Accessing the UnityEngine namespace</h4></div></div></div><p>Once <a id="id1257" class="indexterm"></a>you have built a project<a id="id1258" class="indexterm"></a> for the .NET platforms, you have a ready-to-run solution.</p><p>The player that deploys with the project also gives you indirect access to all the components and game objects within your scenes through the <code class="literal">UnityEngine</code> namespace.</p><p>For the game objects, you can simply query with the <code class="literal">GameObject.Find</code> method, as shown in the following code example:</p><div class="informalexample"><pre class="programlisting">var _cube = UnityEngine.GameObject.Find("Cube");</pre></div><p>The preceding code will give you a game object that you can manipulate however you wish to, as if you were in Unity itself.</p><p>Alternatively, if you want to access scripts or non-standard content, you will need to cast the objects you search for to use them properly. Refer to the following example:</p><div class="informalexample"><pre class="programlisting">var mainScript = (MainScript)UnityEngine.GameObject.FindObjectOfType(typeof(MainScript));</pre></div><p>This will give you a reference to an instance of a class of the <code class="literal">MainScript</code> type in your current scene.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note150"></a>Note</h3><p>All the functions are not scene aware. So, if you have to access the items in specific scenes, you will need to track that manually through a static property or through events (refer to the next section).</p><p>Additionally, if your script is used on several objects in the scene, be sure to perform the search from an instance of an object.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl3sec94"></a>The static classes</h4></div></div></div><p>The second <a id="id1259" class="indexterm"></a>method to access your Unity project<a id="id1260" class="indexterm"></a> from .NET platforms (such as Windows) is to expose specific variables outside the confines of your game or app.</p><p>To do this, declare a static variable within a class in your project, as shown in the following example:</p><div class="informalexample"><pre class="programlisting">public class MyExternalCass : MonoBehaviour 
{
  public static bool TurnOnAds;
}</pre></div><p>Then, from your project, once you have built it, you can access this variable using the following code:</p><div class="informalexample"><pre class="programlisting">MyExternalClass.TurnOnAds = false;</pre></div><p>You will then have the logic in your game to make use of these variables.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note151"></a>Note</h3><p>It is highly recommended that you use classes that are single scripts to expose variables in this fashion. Do not use this method on the reusable classes.</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec147"></a>Access to the platform</h3></div></div></div><p>If you<a id="id1261" class="indexterm"></a> reverse the previous implementation, there<a id="id1262" class="indexterm"></a> are cases where you need to access a specific behavior on the native platform itself.</p><div class="mediaobject"><img src="/graphics/9781849697347/graphics/7347OT_12_03.jpg" /></div><p>If you <a id="id1263" class="indexterm"></a>need a bit more interactivity from your<a id="id1264" class="indexterm"></a> Unity project, and you wish to enable Unity to communicate directly to the platform, then the following are the two common methods to achieve this:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Static events (.NET platforms only)</p></li><li style="list-style-type: disc"><p>Plugins</p></li></ul></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl3sec95"></a>Static events in your Unity project</h4></div></div></div><p>We <a id="id1265" class="indexterm"></a>covered events back in <a class="link" href="#" linkend="ch05">Chapter 5</a>, <span class="emphasis"><em>NPCs and Interactions</em></span>, to <a id="id1266" class="indexterm"></a>enable a loose coupling between an action and a dependency. We can reuse events to bridge the gap between Unity and the .NET platforms such as Windows and Windows Phone.</p><p>We will begin by defining a <code class="literal">static</code> event in Unity, which is intended to indicate an action the project needs the native platform to enact:</p><div class="informalexample"><pre class="programlisting">public static EventHandler PurchaseRequested;
public static void Purchase(string productID)
{
  if (PurchaseRequested != null)
  {
    PurchaseRequested(productID, null);
  }
}</pre></div><p>The previous<a id="id1267" class="indexterm"></a> code sets up a delegate that can be used to enact an in-app purchase on the native platform. When requested in code, it tells whatever object is listening<a id="id1268" class="indexterm"></a> that the user wishes to purchase an item in the game.</p><p>Then, in the platform project, you will hook up to the delegate to perform the action when the event is raised, for example, on Windows Phone to complete a purchase, you would need to use the following code:</p><div class="informalexample"><pre class="programlisting">private void Unity_Loaded()
{
  //Hook up the IAP request to platform
  InAppPurchase.PurchaseRequested += PurchaseRequested;
}
private void PurchaseRequested(object sender, EventArgs e)
{
  var ProductId = (string)sender;
  //Purchase requests must be done on UI thread so use dispatcher
  Dispatcher.BeginInvoke(() =&gt; PurchaseItem(ProductId));
}

private async void PurchaseItem(string productID)
{
  //Do stuff to purchase the item from the store
}</pre></div><p>The code hooks up to the previous <code class="literal">PurchaseRequested</code> event in the <code class="literal">InAppPurchase</code> class, and when a purchase is requested, it is routed to the UI thread and the item is purchased.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip98"></a>Tip</h3><p>Each platform handles in-app purchase differently, or you could choose to use a third-party in-app solution such as Lotaris. The final implementation is up to you.</p></div><p>The example is kept simple just to demonstrate one method for your Unity project to communicate with the platform solution.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl3sec96"></a>Embedding platform DLLs</h4></div></div></div><p>The <a id="id1269" class="indexterm"></a>only other method to enable the platform <a id="id1270" class="indexterm"></a>features in your Unity project is to create your platform class library and embed that library in your project.</p><p>To enable this, Unity has even more special folders in the <code class="literal">Assets</code> folders. The root folder of this structure is the <code class="literal">Plugins</code> folder, shown as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">Plugins</code> (editor plugins)</p></li><li style="list-style-type: disc"><p><code class="literal">Plugins\x86</code> (Pro only)</p></li><li style="list-style-type: disc"><p><code class="literal">Plugins\x86_64</code> (Pro only)</p></li><li style="list-style-type: disc"><p><code class="literal">Plugins\Android</code></p></li><li style="list-style-type: disc"><p><code class="literal">Plugins\iOS</code></p></li><li style="list-style-type: disc"><p><code class="literal">Plugins\BlackBerry</code></p></li><li style="list-style-type: disc"><p><code class="literal">Plugins\WP8</code></p></li><li style="list-style-type: disc"><p><code class="literal">Plugins\Metro</code></p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note152"></a>Note</h3><p>On the mobile platforms, <code class="literal">Plugins</code> are supported in the free version.</p><p>You will need Unity Pro to build plugins for desktop systems (targeted at x86/x64/any CPU).</p><p>Plugins are not supported on the current web player for security reasons; there's no information yet whether this will also be true for WebGL in U5.</p></div><p>To enable your plugin to work for each platform, you will need to install it in each of the previous folders per platform.</p><p>However, on the .NET platforms, you also need an attritional editor plugin (explained in detail in the next section) that provides the basic interface for your plugin due to the way .NET plugins are compiled.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch12lvl4sec18"></a>The editor plugin (.NET only)</h5></div></div></div><p>The <a id="id1271" class="indexterm"></a>editor plugin is just a shell or <a id="id1272" class="indexterm"></a>interface for how your plugin will operate. Unity will use this while in the editor for testing/editing purposes.</p><p>The mock interface needs to resemble what your real plugin interface will look like in order for other scripts and code to be able to access the real plugin on each platform.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note153"></a>Note</h3><p>For the DLL that is going to be placed in <code class="literal">Assets\Plugins</code>, it must be a .NET 3.5 Framework class library. Just be sure to select this framework while creating the editor Plugin DLL.</p></div><p>As a <a id="id1273" class="indexterm"></a>simple example, create a<a id="id1274" class="indexterm"></a> new <code class="literal">Class Library</code> project in your code editor (Visual Studio or MonoDevelop), and then create a new C# class (usually, there is a default <code class="literal">Class1.cs</code> class created with the class library). You can then define a plugin interface in the new class for the editor that looks like the following code:</p><div class="informalexample"><pre class="programlisting">namespace MyAwesomePlugin
{
  public class MyPluginClass
  {
    public static string GetPlatform
    {
      get
      {
        return "This is the Editor";
      }
    }
  }
}</pre></div><p>This simple class just exposes a static string to return the name of the platform.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch12lvl4sec19"></a>The platform plugin</h5></div></div></div><p>For the platform plugin, we will create another Class Library, which targets the level of framework <a id="id1275" class="indexterm"></a>required by the target platform. For<a id="id1276" class="indexterm"></a> example, a Windows 8 (store app) class library for the Windows 8.0 platform.</p><p>Then, create a new class (or reuse the default class) and enter the following code:</p><div class="informalexample"><pre class="programlisting">namespace MyAwesomePlugin
{
  public class MyPluginClass
  {
    public static string GetPlatform
    {
      get
      {
        return "Welcome to Windows 8";
      }
    }
  }
}</pre></div><p>As <a id="id1277" class="indexterm"></a>you can see, it has the same namespace, same <a id="id1278" class="indexterm"></a>class name, and same property as our editor class, but now the implementation has changed.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note154"></a>Note</h3><p>This is just a very simple example; the real platform implementation could have any platform-specific code within it, as it will be executed against the platform when deployed.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch12lvl4sec20"></a>Accessing the plugin</h5></div></div></div><p>So, we <a id="id1279" class="indexterm"></a>have our editor (mock) and platform (Windows 8) plugins defined; you just need to copy them to your Unity project. Now, perform<a id="id1280" class="indexterm"></a> the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Copy the DLL from the Windows 8 class library to <code class="literal">Assets\Plugins\Metro</code>.</p></li><li><p>Copy the DLL from the editor class library in <code class="literal">Assets\Plugins</code> (if requiredâ.NET only).</p></li></ol></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip99"></a>Tip</h3><p>Although not critical, it's best to name the two DLLs and any others you create for other platforms using the same DLL name. This just makes it easier to manage later if you need to add more to the plugin.</p></div><p>With your DLLs now in your project, you can access the plugin from anywhere in your Unity project by calling the following code:</p><div class="informalexample"><pre class="programlisting">string WhatsMyPlatform = MyAwesomePlugin.MyPluginClass.GetPlatform;</pre></div><p>When you run the project from the editor, this will return in the following manner:</p><p><span class="strong"><strong>This is the Editor</strong></span></p><p>However, when you run this on an actual Windows 8 machine, this will return in the following manner:</p><p><span class="strong"><strong>Welcome to Windows 8</strong></span></p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec148"></a>Native plugins (Pro only)</h3></div></div></div><p>The <a id="id1281" class="indexterm"></a>last integration approach is the one <a id="id1282" class="indexterm"></a>that takes the most effort but can have the most benefitâit also has the advantage of being the most reusable.</p><p>If you are running the Pro version of Unity, you can import the native C++ DLLs and their corresponding functionalities into Unity3D. Generally, this is used to access a third-party function library such as Physics and Math or Physics. Some assets on the <span class="strong"><strong>Asset</strong></span> store also ship with native plugins to enable them to be as fast as possible (and as a by-product, they ensure that you cannot copy their code from a compiled library):</p><div class="mediaobject"><img src="/graphics/9781849697347/graphics/7347OT_12_04.jpg" /></div><p>The plugin, once created, should be placed in the <code class="literal">Plugins</code> folder mentioned previously, and then called from the code as follows:</p><div class="informalexample"><pre class="programlisting">[DllImport ("PluginName")]
private static extern float FooPluginFunction ();</pre></div><p>This effectively gives you a pointer to the code that will run outside of Unity3D. By calling the previous function, Unity interprets this and passes it on to the external library to process and return from.</p><p>The advantage <a id="id1283" class="indexterm"></a>of using the native plugins is mainly speed. You get direct access to a native platform and all the performance boosts it provides. It is by far the most complicated way to enable such features, and deciding on using it would simply come down to if you need that level of power.</p><p>In some <a id="id1284" class="indexterm"></a>cases, native plugins are the <a id="id1285" class="indexterm"></a>only way to access the underlying features of a platform, especially if it is a feature that Unity itself does not support.</p><p>Additionally, native plugins can be created to be used on all platforms so long as they are not using platform-specific features; in which case, you would still need one plugin per platform.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip100"></a>Tip</h3><p>One very cool feature with native plugins is that you can even interact with Unity3D's own rendering engine, just in case you feel adventurous and want to spice it <a id="id1286" class="indexterm"></a>up a bit. For more details on this, check out the Unity scripting guide at <a class="ulink" href="http://docs.unity3d.com/Documentation/Manual/NativePluginInterface.html" target="_blank">http://docs.unity3d.com/Documentation/Manual/NativePluginInterface.html</a>.</p><p>For more information about the native plugins, refer to the Unity scripting reference guide at <a class="ulink" href="http://docs.unity3d.com/Documentation/Manual/Plugins.html" target="_blank">http://docs.unity3d.com/Documentation/Manual/Plugins.html</a>.</p></div></div></div>