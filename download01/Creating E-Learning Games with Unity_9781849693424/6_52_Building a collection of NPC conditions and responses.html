<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec53"></a>Building a collection of NPC conditions and responses</h2></div></div><hr /></div><p>To specialize how the NPC will respond, we need to write specific conditions and response classes and then populate the <code class="literal">DecisionMgr</code> for the NPC by placing these components in the editor. To prove this, let's develop a test case for an NPC that will perform the following logic:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Patrol on a curve, facing forward.</p></li><li><p>When the NPC gets close enough to the player, stop and face the player.</p></li><li><p>When the NPC is far enough away from the player, follow the path and face forward.</p></li></ol></div><p>To implement this logic, we will need two conditions and one response.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec55"></a>Implementing the condition_closerThanThresh script</h3></div></div></div><p>Let's <a id="id318" class="indexterm"></a>create a<a id="id319" class="indexterm"></a> condition to check if the NPC is close enough to the player. This will be used by the <code class="literal">npcDecisionMgr</code> to determine when to stop patrolling and face the player.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new script called <code class="literal">condition_closerThanthresh</code>.</p></li><li><p>In MonoDevelop, edit the signature of the class declaration so that it inherits from <code class="literal">npcCondition</code> rather than <code class="literal">MonoBehaviour</code>. Also, add the explicit serialization tag to this class so the editor can save it:</p><div class="informalexample"><pre class="programlisting">[System.Serializable]
public class condition_closerThanThresh : npcCondition {</pre></div></li><li><p>This class<a id="id320" class="indexterm"></a> will <a id="id321" class="indexterm"></a>need three parameters to perform its tasks. A float to represent the target threshold, and two GameObject references for the two objects whose distance we will check:</p><div class="informalexample"><pre class="programlisting">public float thresh;
public GameObject trackObj;
public GameObject baseObj;</pre></div></li><li><p>We want to provide an implementation for the <code class="literal">eval()</code> method that was declared in the NPC base. To do this, note the syntax <code class="literal">public override bool</code>, which is as follows:</p><div class="informalexample"><pre class="programlisting">public override bool eval()</pre></div></li><li><p>The <code class="literal">eval()</code> method will check the distance between the two GameObjects <code class="literal">trackObj</code> and <code class="literal">baseObj</code> for each frame. Don't forget these need to be set in the inspector; they can be the NPCs and the player or any two GameObjects for that matter (objects that have a transform):</p><div class="informalexample"><pre class="programlisting">bool rval = false;
Vector3 vDisp = (this.baseObj.transform.position -trackObj.transform.position);
float dist = vDisp.magnitude;
if ( dist &lt; thresh)
  rval = true;
return rval;</pre></div></li></ol></div><p>Congratulations, you have written a condition script that tests whether two GameObjects are closer than a set threshold.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec56"></a>Implementing the condition_fartherThanThresh script</h3></div></div></div><p>Let's <a id="id322" class="indexterm"></a>create a <a id="id323" class="indexterm"></a>condition to check if the NPC is far enough from the player.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new script called <code class="literal">condition_fartherThanthresh</code>.</p></li><li><p>In MonoDevelop, edit the signature of the class declaration so that it inherits from <code class="literal">npcCondition</code> rather than <code class="literal">MonoBehaviour</code>. Also add the explicit serialization tag to this class so the editor can save it:</p><div class="informalexample"><pre class="programlisting">[System.Serializable]
public class condition_fartherThanThresh : npcCondition {</pre></div></li><li><p>The <code class="literal">eval()</code> method will have the same signature and implementation as the closer condition <a id="id324" class="indexterm"></a>script explained previously, except that instead of checking if the distance is less than the threshold, you will check if the distance is greater than the threshold:</p><div class="informalexample"><pre class="programlisting">bool rval = false;
Vector3 vDisp = (this.baseObj.transform.position - trackObj.transform.position);
float dist = vDisp.magnitude;
if ( dist &gt; thresh)
  rval = true;
return rval;</pre></div></li></ol></div><p>Congratulations! <a id="id325" class="indexterm"></a>You have combined the complement-condition script with the closer-than script. With both of these combined, we will be able to make the NPC start and stop a behavior based on proximity.</p><p>We need one more script to make the NPC respond to these proximity changes. Since the NPC knows how to behave in the <code class="literal">patrol</code> and <code class="literal">turnToPlayer</code> states, we want to make the NPC change the internal state as a response.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec57"></a>Implementing the response_changeState script</h3></div></div></div><p>Let's create <a id="id326" class="indexterm"></a>a response script<a id="id327" class="indexterm"></a> that will change the internal state on the associated <code class="literal">npcScript</code> class to a specified value. This helper script will prove very useful as it will allow our NPC to react to conditions in the world by changing the <code class="literal">npcScript</code> state to response.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new script in the editor, and name it <code class="literal">response_changeState</code>.</p></li><li><p>As with the previous two cases, modify the class signature to make it inherit from <code class="literal">npcResponse</code> (not <code class="literal">npcCondition</code>), and be sure to add the explicit serialization tag as well:</p><div class="informalexample"><pre class="programlisting">[System.Serializable]
public class response_changeState : npcResponse {</pre></div></li><li><p>This class will have two members, an <code class="literal">npcState</code> enumeration and a reference to the <code class="literal">npcScript</code> class. When fired, the script will set the state on the <code class="literal">npcScript</code> reference to the value set in the local enumeration:</p><div class="informalexample"><pre class="programlisting">public npcScript.npcState newstate;
public npcScript npc;</pre></div></li><li><p>As with classes that derive from <code class="literal">npcCondition</code>, we need to override the abstract method provided in the base class. Instead of <code class="literal">eval()</code>, we will override <code class="literal">dispatch()</code>:</p><div class="informalexample"><pre class="programlisting">public override bool dispatch()</pre></div></li><li><p>If this response<a id="id328" class="indexterm"></a> class has an NPC reference, it will set the value of <code class="literal">newState</code> on to NPC through the <code class="literal">SetState()</code> setter method that <code class="literal">npcScript</code> implements:</p><div class="informalexample"><pre class="programlisting">if (npc != null)
{
  npc.SetState (newstate);
  rval = true;
}
return rval;</pre></div></li></ol></div><p>Congratulations! <a id="id329" class="indexterm"></a>We now have all the pieces to finally develop an <code class="literal">npcDecisionMgr</code> class that can tell the NPC to patrol or face the play when close enough. While it's true that we invest resources into developing a generic decision handling system, let's see how this pays dividends when implementing the logic in the editor.</p></div></div>