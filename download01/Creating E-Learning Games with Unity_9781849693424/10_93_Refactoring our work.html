<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec90"></a>Refactoring our work</h2></div></div><hr /></div><p>Now that <a id="id503" class="indexterm"></a>we have a fully functional system for loading and unloading scene files, we will dedicate our attention to the integration and refactoring of the remaining GameObjects, hierarchies, and scripts.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec67"></a>The pop-up system</h3></div></div></div><p>To refactor our pop-up system,<a id="id504" class="indexterm"></a> perform the following steps to complete the moving of our game content from the <code class="literal">testbed</code> scene file to the <code class="literal">MAIN</code> scene file.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch10lvl3sec03"></a>Updating level 3 pop ups</h4></div></div></div><p>Let's begin by<a id="id505" class="indexterm"></a> refactoring the pop-up panel system:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Under <span class="strong"><strong>_global</strong></span>, ensure that the player (named <span class="strong"><strong>Player1</strong></span>), camera (named <span class="strong"><strong>MainCamera</strong></span>), and game (named <span class="strong"><strong>Game</strong></span>) child objects can be found. Also make sure that a GameObject of type <code class="literal">GUITexture</code> named <span class="strong"><strong>score</strong></span> is present as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_10_01.jpg" /></div></li><li><p>We will change the behavior of the pop ups that are shown at the start and completion of each level. Rather than instantiating them from a Prefab, we will add them at design time in the editor and selectively activate and deactivate them as necessary. This will make the task of refactoring the pop-up system more straightforward.</p></li><li><p>Load the <code class="literal">TESTBED3</code> scene file. Find the <code class="literal">MainCamera</code> GameObject<a id="id506" class="indexterm"></a>, and open the <span class="strong"><strong>Hierarchy</strong></span> tab to display the UI pop up's child objects.</p></li><li><p>Press the <span class="emphasis"><em>Shift</em></span> key, select all of the pop ups, and copy them with <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>C</em></span>.</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_10_02.jpg" /></div></li><li><p>Load the <code class="literal">MAIN</code> scene file. Select the <code class="literal">MainCamera</code> GameObject, and paste the level 3 pop ups with <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>V</em></span>. This will paste the pop ups that we copied from step 4.</p></li><li><p>Now, we need to change the behavior of the buttons. Starting with the pop up named <span class="strong"><strong>popup_Level3Start</strong></span>, select this panel, and open the <span class="strong"><strong>Button1</strong></span> hierarchy.</p></li><li><p>Change the <a id="id507" class="indexterm"></a>actions of this button to <code class="literal">CameraLookPlayer()</code> so that the camera looks down on the start of the level, and call <code class="literal">DisableObject(popup_Level3Start)</code> so that this panel disappears but remains attached to the <code class="literal">MainCamera</code> GameObject persistent in <code class="literal">_global</code>.</p></li><li><p>Next, select the <span class="strong"><strong>popup_Level3Finish</strong></span> panel, and open the <span class="strong"><strong>Button1</strong></span> hierarchy.</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_10_51.jpg" /></div></li><li><p>Change the first action of this button to <code class="literal">LoadLevelMainMenu</code> (to tell <code class="literal">GameMgr</code> to unload <code class="literal">Level3</code>, leaving just <code class="literal">_global</code>).</p></li><li><p>Change the next action to <code class="literal">HideGameObject(popup_Level3Finish)</code> to disable update and rendering of this panel, while still leaving it attached to the <code class="literal">MainCamera</code> GameObject persistent in <code class="literal">_global</code>.</p></li><li><p>Change the last action to <code class="literal">EnableObject(popup_MainMenu)</code> to make the main menu show up again.</p></li><li><p>Lastly, click on the <span class="strong"><strong>popup_Level3Repeat</strong></span> panel, and open the <span class="strong"><strong>Button1</strong></span> hierarchy.</p></li><li><p>Change the first action to <code class="literal">CameraLookUp()</code> to point the camera towards the sky (which makes the pop ups show up in a visually appealing way).</p></li><li><p>Change the <a id="id508" class="indexterm"></a>next action to <code class="literal">LoadLevel3</code>. This will tell the <code class="literal">GameMgr</code> script to destroy the <code class="literal">_level3</code> GameObject (and all of its children), and then reload the <code class="literal">_level3</code> GameObject, thereby resetting its state.</p></li><li><p>Change the final action to <code class="literal">DisableObject(popup_Level3Repeat)</code> to hide this panel while still leaving it attached to the <code class="literal">MainCamera</code> GameObject persistent in <code class="literal">_global</code>.</p></li></ol></div><p>Congratulations! You have finished updating the pop ups for <code class="literal">Level3</code>. Let's move on to pop ups of <code class="literal">Level2</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch10lvl3sec04"></a>Updating level 2 pop ups</h4></div></div></div><p>Now that pop ups <a id="id509" class="indexterm"></a>of level 3 are updated, let's follow the same procedure to update the pop ups for the second level.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Load the <code class="literal">TESTBED2</code> scene file. Find the <code class="literal">MainCamera</code> GameObject, and open hierarchy to display the UI pop up's child objects.</p></li><li><p>Press <span class="emphasis"><em>Shift</em></span>, select all of the pop ups, and copy them with <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>C</em></span>.</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_10_03.jpg" /></div></li><li><p>Load the <code class="literal">MAIN</code> scene file. Select the <code class="literal">MainCamera</code> GameObject, and paste the level 3 pop ups with <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>V</em></span>.</p></li><li><p>Now we need to change the behavior of the buttons. Starting with <span class="strong"><strong>popup_Level2Start</strong></span>, select this panel, and open the <span class="strong"><strong>Button1</strong></span> hierarchy.</p></li><li><p>Change the first action of this button to <code class="literal">EnableObject(raceStarterPrefab)</code>. Set the reference to <code class="literal">raceStarterPrefab</code> by dragging-and-dropping it from the <span class="strong"><strong>Project</strong></span> tab directly into the data field of the button's action. This way, the button will instance a GameObject from this Prefab on click.</p></li><li><p>Change the second action of this button to <code class="literal">EnableObject(setupLevel2Prefab)</code>. In a similar fashion as earlier, set the reference to <code class="literal">setupLevel2Prefab</code> by dragging-and-dropping it from the <span class="strong"><strong>Project</strong></span> tab directly in to the data field of the button's action. This way, the button will instance a GameObject from the Prefab on click.</p></li><li><p>Change <a id="id510" class="indexterm"></a>the third action to <code class="literal">CameraLookPlayer()</code><a id="id511" class="indexterm"></a> so that the view will track the hero as the character moves in the world.</p></li><li><p>Change the last action of this button to <code class="literal">HideGameObject(popup_Level2Start)</code> to hide this panel while still leaving it attached to the <code class="literal">MainCamera</code> GameObject persistent in <code class="literal">_global</code>.</p></li><li><p>Next, select the <span class="strong"><strong>popup_Level2Finished</strong></span> button, and open up the <span class="strong"><strong>Button1</strong></span> hierarchy.</p></li><li><p>Change the first action of this button to <code class="literal">CameraLookUp()</code>. This will orient the camera to a point above the player so that the subsequent pop ups will display in a visually appealing way.</p></li><li><p>Change the next action of this button to <code class="literal">LoadLevel3</code> (to tell <code class="literal">GameMgr</code> to unload <code class="literal">Level2</code> by destroying the root GameObject instance, and then load <code class="literal">Level3</code>). Throughout this process, <code class="literal">_global</code> and all of its child objects will be preserved.</p></li><li><p>Change the last action of this button to <code class="literal">HideGameObject(popup_Level2Finish)</code>. This will disable the rendering of this panel while still leaving it attached to the <code class="literal">MainCamera</code> GameObject persistent in <code class="literal">_global</code>.</p></li><li><p>Lastly, select the <span class="strong"><strong>popup_Level2Repeat</strong></span> panel, and open the <span class="strong"><strong>Button1</strong></span> hierarchy.</p></li><li><p>Change the first action to <code class="literal">CameraLookUp()</code> to point the camera towards the sky (which makes the pop ups show up in a visually appealing way).</p></li><li><p>Change the next action to <code class="literal">LoadLevel2</code>. This will tell the <code class="literal">GameMgr</code> script to destroy the <code class="literal">_level2</code> GameObject (and all of its children), and then reload the <code class="literal">_level2</code> GameObject, thereby resetting its state.</p></li></ol></div><p>Congratulations! You have finished updating the pop ups for level 2. Let's move on to the pop ups of level 1.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch10lvl3sec05"></a>Updating level 1 pop ups</h4></div></div></div><p>Now that <a id="id512" class="indexterm"></a>pop ups of level 2 are finished, let's update and modify the pop ups for level 1.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>We need to create a start pop up for level 1 that matches the pattern of the other two levels.</p></li><li><p>Copy <code class="literal">popup_Level2Start</code> from <code class="literal">MainCamera</code>, and paste it on <code class="literal">MainCamera</code> as well.</p></li><li><p>Rename the <a id="id513" class="indexterm"></a>copy as <code class="literal">popup_Level1Start</code>.</p></li><li><p>At this point in time, your <code class="literal">MainCamera</code> hierarchy should look similar to the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_10_04.jpg" /></div></li><li><p>Set the first action on <code class="literal">Button1</code> to <code class="literal">CameraLookPlayer()</code> so that when the level starts, the camera will track the hero.</p></li><li><p>Set the second action on <code class="literal">Button1</code> to <code class="literal">DisableObject(popup_Level1Start)</code>. This will hide this panel while still leaving it attached to the <code class="literal">MainCamera</code> GameObject persistent in <code class="literal">_global</code>.</p></li><li><p>We will not need to allow the user to repeat level 1. Since there is no fail condition, we will not need a repeat pop up for level 1. The level complete pop up will be dynamically allocated as a reward for finishing the level 1 mission of returning flags to the monument as originally designed.</p></li><li><p>To support easy programmatic access to these pop ups, we will write a <code class="literal">PopupMgr</code> script to store references to these pop-up objects. This class will then be used to access these pop ups for easy enabling and disabling.</p></li><li><p>Create a new script with the C# script wizard named <code class="literal">PopupMgr</code>, and attach it to the <code class="literal">MainCamera</code> instance in the <code class="literal">_global</code> hierarchy.</p></li><li><p>Give this script eight public references to the following GameObject pop ups:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">public GameObject MainMenu;</code></p></li><li style="list-style-type: disc"><p><code class="literal">public GameObject Level1Start;</code></p></li><li style="list-style-type: disc"><p><code class="literal">public GameObject Level2Start;</code></p></li><li style="list-style-type: disc"><p><code class="literal">public GameObject Level2Finish;</code></p></li><li style="list-style-type: disc"><p><code class="literal">public GameObject Level2Repeat;</code></p></li><li style="list-style-type: disc"><p><code class="literal">public GameObject Level3Start;</code></p></li><li style="list-style-type: disc"><p><code class="literal">public GameObject Level3Finish;</code></p></li><li style="list-style-type: disc"><p><code class="literal">public GameObject Level3Repeat;</code></p></li></ul></div><p>These are references to the actual pop-up objects that the <code class="literal">PopupMgr</code> script will enable and disable as the game moves from level to level.</p></li><li><p>Make sure to assign the actual instances of these GameObjects to these variables in the <code class="literal">PopupMgr</code> script by either dragging-and-dropping them in or selecting them from the selection panel.</p></li></ol></div><p>Congratulations! The<a id="id514" class="indexterm"></a> pop-up system has been fully refactored for our game. As level 1 is now fully functional, let's turn our attention to integrating the rest of <code class="literal">TESTBED2</code> and <code class="literal">TESTBED3</code> into our game.</p></div></div></div>