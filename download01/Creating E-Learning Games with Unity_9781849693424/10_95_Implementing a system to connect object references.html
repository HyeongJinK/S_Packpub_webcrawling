<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec92"></a>Implementing a system to connect object references</h2></div></div><hr /></div><p>Level 1 signals level 2 to load when the <span class="strong"><strong>Level 1 completes</strong></span> pop up's <span class="strong"><strong>Next</strong></span> button is pressed; it <a id="id517" class="indexterm"></a>signals for the <code class="literal">_level1</code> GameObject to be destroyed and the <code class="literal">_level2</code> GameObject to be loaded from the <code class="literal">LEVEL2</code> scene file. We must refactor the start-up logic of <code class="literal">_level2</code> so that we can find and connect some object references to GameObjects in the <code class="literal">_global</code> hierarchy.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new script named <code class="literal">Level2Extras</code><a id="id518" class="indexterm"></a>, and attach an instance of it to the <code class="literal">_level2</code> GameObject. This script will be used to directly access certain GameObjects inside <code class="literal">_level2</code> for enabling and disabling.</p></li><li><p>Give the <code class="literal">Level2Extras</code> script the following three public GameObject references; these are the assorted GameObjects that this script will be in charge of activating:</p><div class="informalexample"><pre class="programlisting">
<code class="literal">public GameObject raceStartup;</code>
<code class="literal">public GameObject setupLevel2;</code>
<code class="literal">public GameObject LevelLogicObj;</code>
</pre></div></li><li><p>Drag-and-drop the <code class="literal">LevelLogicObj</code> object from the <code class="literal">_level2</code> GameObject hierarchy into the <code class="literal">LevelLogicObj</code> reference of the <code class="literal">Level2Extras</code> script.</p></li><li><p>Drag-and-drop the <code class="literal">setupLevel2</code> GameObject from the <code class="literal">_level2</code> GameObject hierarchy into the <code class="literal">setupLevel2</code> reference of the <code class="literal">Level2Extras</code> script.</p></li><li><p>Drag-and-drop<a id="id519" class="indexterm"></a> the <code class="literal">raceStartup</code> GameObject from the <code class="literal">_level2</code> GameObject hierarchy into the <code class="literal">raceStartup</code> reference of the <code class="literal">Level2Extras</code> script.</p></li><li><p>At this point your <code class="literal">Level2Extras</code> script should look something like the following:</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_10_52.jpg" /></div></li><li><p>Observe that as you click on the populated references inside <code class="literal">Level2Extras</code>, Unity highlights the GameObject instances with a unique yellow border so that you can quickly find the actual object instances that are connected in the hierarchy.</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_10_06.jpg" /></div></li><li><p>Now that <code class="literal">Level2Extras</code> has been properly configured, create another script named <code class="literal">Level2Init</code>, and add an instance of it to the <code class="literal">_level2</code> GameObject.</p></li><li><p>The <code class="literal">level2Init</code> script<a id="id520" class="indexterm"></a> will use the <code class="literal">Level2Extras</code> script as an interface to find specific GameObjects and connect them into the appropriate level 2 pop ups. This <a id="id521" class="indexterm"></a>needs to happen since the pop ups are global; they cannot preserve references to objects that are dynamically loaded from later levels.</p></li><li><p>In the <code class="literal">start()</code> method of <code class="literal">Level2Init</code>, the script attempts to locate the <code class="literal">Player</code> GameObject, named as either <code class="literal">Player</code> or <code class="literal">Player1</code>:</p><div class="informalexample"><pre class="programlisting">GameObject playerObj = GameObject.Find ("Player1");
if (playerObj == null)
  playerObj = GameObject.Find ("Player");</pre></div></li><li><p>If a suitable player object is found, the code sets the initial position and the orientation for the player. This is so that when level 2 starts, the player begins at the starting line of the race:</p><div class="informalexample"><pre class="programlisting">if (playerObj != null)
{
  playerObj.transform.position =
    new Vector3(-110.0f, 3.0f, 166.0f);
  p.GetComponent&lt;playerControls&gt;().moveDirection =
    new Vector3(1.0f, 0.0f, 0.0f);
}</pre></div></li><li><p>In the <code class="literal">Update()</code> method of <code class="literal">Level2Init</code>, the class attempts to find the <code class="literal">MainCamera</code> GameObject. If it can be found, the <code class="literal">PopupMgr</code> script<a id="id522" class="indexterm"></a> component is stored:</p><div class="informalexample"><pre class="programlisting">GameObject camObj = GameObject.Find ("MainCamera");
if (camObj)
{
  PopupMgr ppm = camObj.GetComponent&lt;PopupMgr&gt;();</pre></div></li><li><p>If an instance of<a id="id523" class="indexterm"></a> the <code class="literal">PopupMgr</code> script can be found on this GameObject, we activate <code class="literal">popup_Level2Start</code> and deactivate <code class="literal">popup_Level2Finish</code> and <code class="literal">popup_Level2Repeat</code>. By setting these objects to active, we tell Unity that these scripts should be allowed to call their internal <code class="literal">Update()</code> methods. Conversely, when setting <code class="literal">SetActive(false)</code>, we can tell Unity to suspend scripts as needed:</p><div class="informalexample"><pre class="programlisting">// set up the level2 popups initial state
ppm.Level2Finish.SetActive(false);
ppm.Level2Repeat.SetActive (false);
ppm.Level2Start.SetActive(true);</pre></div></li><li><p>Then we store a reference to the <code class="literal">PopupMgrScript</code> on the <code class="literal">popup_Level2Start</code> GameObject for later use:</p><div class="informalexample"><pre class="programlisting">PopupButtonScript pbs = 
  ppm.Level2Start.transform.FindChild
  ("Button1").gameObject.GetComponent&lt;PopupButtonScript&gt;();</pre></div></li><li><p>We also store a reference to the <code class="literal">Level2Extras</code> script for easy access later in the method:</p><div class="informalexample"><pre class="programlisting">Level2Extras l2x = GetComponent&lt;Level2Extras&gt;();</pre></div></li><li><p>If the <code class="literal">Level2Extras</code> component can be found, we need to associate <code class="literal">setupLevel2</code> to the <code class="literal">popup_Level2Start</code> instance on its first button action. Then, we associate <code class="literal">raceStartup</code> to the <code class="literal">popup_Level2Start</code> instance on its second button action:</p><div class="informalexample"><pre class="programlisting">pbs.actions[0].data.obj = l2x.setupLevel2;
pbs.actions[1].data.obj = l2x.raceStartup;</pre></div></li><li><p>Next, we try to cache a reference to the <code class="literal">response_ShowRaceResultsPopup</code> component that is attached to <code class="literal">LevelLogicObj</code> inside <code class="literal">Level2Extras</code>:</p><div class="informalexample"><pre class="programlisting">response_ShowRaceResultsPopup rrp = l2x.LevelLogicObj.GetComponent&lt;response_ShowRaceResultsPopup&gt;();</pre></div></li><li><p>If the race <a id="id524" class="indexterm"></a>results pop-up component can be found, we connect the <code class="literal">player</code>, <code class="literal">GameMgr</code>, <code class="literal">PassPopup</code>, and <code class="literal">FailPopup</code> to this script. This will allow this response script to operate correctly during the race:</p><div class="informalexample"><pre class="programlisting">rrp.player = GameObject.Find ("Player1");
rrp.gm = GameObject.Find ("Game").GetComponent&lt;gameMgr&gt;();
rrp.passPopup = ppm.Level2Finish;
rrp.retryPopup = ppm.Level2Repeat;</pre></div></li><li><p>After this, the <code class="literal">Level2Init</code> script will destroy itself. This stops the init logic from running more than once when <code class="literal">_level2</code> is loaded. If <code class="literal">_level2</code> is ever reloaded (during a restart perhaps), this script will be re-instanced when <code class="literal">_level2</code> is loaded again.</p></li></ol></div><p>Congratulations! The logic for configuring the missing references of level 2 on startup has been completed. Let's move our attention to how the mission 2 logic is actually set up.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec68"></a>Updating the SetupMission2 script</h3></div></div></div><p>Prior to <a id="id525" class="indexterm"></a>integrating<a id="id526" class="indexterm"></a> the missions together, we developed our game so that mission 1, mission 2, and mission 3 individually selected five states from a bank of 50. While this is fine for playing them in isolation, we need to add continuity of the state selections across all three levels. We will do this by storing the selections when they are made in level 1, and then by restoring them as level 2 and level 3 are loaded.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>To begin, load the <code class="literal">LEVEL1</code> scene file. Find the <code class="literal">Monument</code> GameObject, and open the <code class="literal">SetupMissionOne</code> script.</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_10_07.jpg" /></div></li><li><p>In the <code class="literal">SetupMission()</code> method<a id="id527" class="indexterm"></a>, on line 65, we find the <code class="literal">player</code> GameObject named either <code class="literal">Player</code> or <code class="literal">Player1</code>:</p><div class="informalexample"><pre class="programlisting">GameObject playerObj = GameObject.Find ("Player1");
if (playerObj == null)
  p = GameObject.Find ("Player");</pre></div></li><li><p>If a player can be found, we cache a reference to the <code class="literal">PlayerData</code> component attached to it:</p><div class="informalexample"><pre class="programlisting">pd = p.GetComponent&lt;playerData&gt;();</pre></div></li><li><p>If there are <a id="id528" class="indexterm"></a>any flag <a id="id529" class="indexterm"></a>choices in <code class="literal">PlayerData</code> at this point, we clear them. This is a reasonable assumption to make in level 1 as it is the first gameplay level that we encounter. The subsequent levels will access these values when populating their scenes. Clearing the <code class="literal">flagChoices</code> array before use is a good defensive practice so that we don't accidentally end up with more flag instances in the level than intended:</p><div class="informalexample"><pre class="programlisting">if (pd.flagChoices.Count &gt; 0)
  pd.flagChoices.Clear();</pre></div></li><li><p>In the <code class="literal">SetupMission()</code> method, on line 92, as the initial set of flags are chosen, we store the flag index in the <code class="literal">playerData</code> component. Here, they will be carried with the player through level 2 and level 3:</p><div class="informalexample"><pre class="programlisting">if (pd != null)
  pd.flagChoices.Add (index);</pre></div></li><li><p>Now that the first mission has been successfully updated to store flag choices in <code class="literal">PlayerData</code>, we shall now move our attention towards refactoring level 2 and level 3 to use this data.</p></li><li><p>In the <code class="literal">Start()</code> method of the <code class="literal">SetupMissionTwo</code> script, while we are iterating over the flags, we check if there is a <code class="literal">PlayerData</code> component on the player. If one can be found, we assign the flag index from the list in <code class="literal">PlayerData</code> to the variable index rather than a randomly assigned one:</p><div class="informalexample"><pre class="programlisting">if (pd != null)
  index = pd.flagChoices[k];</pre></div></li></ol></div><p>Congratulations! This completes the required updates for level 2. Now, when starting the game and selecting <span class="strong"><strong>NEW</strong></span>, level 1 will be shown initially, and upon completion, the game will dynamically load level 2. Let's continue updating the code in the same light as we integrate and refactor level 3.</p></div></div>