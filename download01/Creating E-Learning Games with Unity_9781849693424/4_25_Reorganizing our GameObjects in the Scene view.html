<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec28"></a>Reorganizing our GameObjects in the Scene view</h2></div></div><hr /></div><p>The following <a id="id207" class="indexterm"></a>GameObjects will be the focus of our design activities in this chapter:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">GameMgr</code>: This <a id="id208" class="indexterm"></a>script will handle the choreography between the game and its particular states. It will hold the logic that moves the game from the main screen and between the individual levels.</p></li><li style="list-style-type: disc"><p><code class="literal">PlayerData</code>: This <a id="id209" class="indexterm"></a>script will hold the game instance-specific attributes of the player. This will include variables such as score and current level.</p></li><li style="list-style-type: disc"><p><code class="literal">Game</code>: This is the GameObject that <a id="id210" class="indexterm"></a>holds the scripts necessary for game control. It will hold the <code class="literal">GameMgr</code> script as well as the <code class="literal">MissionMgr</code> script.</p></li><li style="list-style-type: disc"><p><code class="literal">_level1</code>: This <a id="id211" class="indexterm"></a>class will hold all of the objects that are specific to the first level.</p></li><li style="list-style-type: disc"><p><code class="literal">_global</code>: This class<a id="id212" class="indexterm"></a> will hold all of the objects that are global or persistent across all game levels as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_04_06.jpg" /></div></li></ul></div><p>Taking an already working system of code and reworking it so that it is more extendible is called <span class="strong"><strong>Refactoring</strong></span><a id="id213" class="indexterm"></a>. By refactoring our game into a number of scene files, we will find that the game becomes easier to extend and maintain. This is important for us to be able to add new lessons and levels to the game.</p><p>Previously, our approach to game programming in Unity was to place all <code class="literal">GameObject</code> instances inside one scene file. This worked because the lifespan of all GameObjects was the sameâ€”the duration of the whole program.</p><p>In a multilevel game, we will want to keep some objects persistent for the entire lifespan of the program. Other objects, we will want to only use during a particular level, and perhaps we may want some objects only fleetingly during a particular level.</p><p>Let's separate our work thus far into two scene files: one for persistent objects and one for level-one-specific objects.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec35"></a>Creating a global scene</h3></div></div></div><p>The global scene<a id="id214" class="indexterm"></a> file will contain all persistent GameObjects and scripts that have a lifespan of the entire game. To create this file, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new empty GameObject, and name it <code class="literal">_global</code>.</p></li><li><p>Set its position to (<code class="literal">0</code>, <code class="literal">0</code>, <code class="literal">0</code>). Doing this before we drag-and-drop objects beneath it will ensure that the world space positions of the child objects will stay the same as they were previously.</p></li><li><p>Drag-and-drop the following GameObjects beneath the <code class="literal">_global</code> GameObject. These will eventually be moved to a new scene file named <code class="literal">MAIN</code> as shown in the following screenshot.</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">MainCamera</code></p></li><li style="list-style-type: disc"><p><code class="literal">MissionMgr</code></p></li><li style="list-style-type: disc"><p><code class="literal">Player</code></p></li></ul></div></li><li><p>Rename <code class="literal">MissionMgr</code> to <code class="literal">Game</code>. We rename it because we are expanding the responsibilities of this object beyond just <code class="literal">MissionMgr</code>; we will be adding another script to this object to increase its responsibilities in the game, so a more generic name is appropriate.</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_04_05.jpg" /></div></li><li><p>Create a new script, and name it <code class="literal">GameMgr</code>. Attach it to the object named <code class="literal">Game</code>. We will implement this script later in this chapter.</p></li><li><p>Create a <a id="id215" class="indexterm"></a>new script, and name it <code class="literal">PlayerData</code>. Attach it to the object named <code class="literal">Game</code>. We will implement this script later in this chapter.</p></li><li><p>Create a new scene by selecting <span class="strong"><strong>New Scene</strong></span> from the <span class="strong"><strong>File</strong></span> drop-down menu. This will be the new starting scene for our game going forward. Name it <code class="literal">MAIN</code>.</p></li><li><p>Switch back to the <code class="literal">CHAPTER3_SCENE1</code> scene file. Copy the <code class="literal">_global</code> GameObject from the <span class="strong"><strong>Hierarchy</strong></span> tab by either right-clicking on it and selecting <span class="strong"><strong>Copy</strong></span> or by clicking on the object and pressing <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>C</em></span>.</p></li><li><p>Switch to the <code class="literal">MAIN</code> scene again, and paste the <code class="literal">_global</code> object into this scene by pressing <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>V</em></span>.</p></li></ol></div><p>Congratulations! We have created a scene file that will act as the launcher for our new game framework. Let's repeat the process for the first level.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec36"></a>Creating a first level scene</h3></div></div></div><p>The <code class="literal">LEVEL1</code> scene<a id="id216" class="indexterm"></a> file will contain all transient GameObjects and scripts that have a lifespan for just the first level of the game. The level one scene will look like the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_04_07.jpg" /></div><p>To create the first-level scene, <a id="id217" class="indexterm"></a>perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new, empty GameObject, and name it <code class="literal">_level1</code>.</p></li><li><p>Set its position to (<code class="literal">0</code>, <code class="literal">0</code>, <code class="literal">0</code>). Doing this before we drag-and-drop objects beneath it will ensure that the world space positions of the child objects will stay the same as they were previously.</p></li><li><p>Switch back to scene <code class="literal">Chapter3_Scene1</code>. Drag-and-drop the following game objects beneath the <code class="literal">_level1</code> GameObject:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">Directional light</code></p></li><li style="list-style-type: disc"><p><code class="literal">FlagLocators</code></p></li><li style="list-style-type: disc"><p><code class="literal">Monument</code></p></li><li style="list-style-type: disc"><p><code class="literal">Terrain</code></p></li></ul></div></li><li><p>Create a new scene by navigating to <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>New Scene</strong></span> from the drop-down menu. This will be the scene for our first level going forward. Name it <code class="literal">LEVEL1</code>.</p></li><li><p>Switch back to the <code class="literal">CHAPTER3_SCENE1</code> level. Copy the <code class="literal">_level1</code> GameObject from the <span class="strong"><strong>Hierarchy</strong></span> tab by either right clicking on it and selecting <span class="strong"><strong>Copy</strong></span> or by selecting the object and pressing <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>C</em></span>.</p></li><li><p>Switch to the <code class="literal">LEVEL1</code> scene again, and paste the <code class="literal">_level1</code> object into this scene by pressing <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>V</em></span>.</p></li></ol></div><p>Congratulations! <a id="id218" class="indexterm"></a>We now have a second scene file that will correspond to the game content for level one. Now we need to make sure that these levels are added the project.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec37"></a>Adding new scenes to the project</h3></div></div></div><p>In order to ensure these scenes<a id="id219" class="indexterm"></a> are available to the game project, we need to add them to the build as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_04_01.jpg" /></div><p>To add the scenes to the<a id="id220" class="indexterm"></a> build, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Double-click on the <span class="strong"><strong>MAIN</strong></span> scene in the project tab. Once it is loaded, select <span class="strong"><strong>Build Settings</strong></span> from the <span class="strong"><strong>File</strong></span> drop-down menu, and notice that the previous pop-up window appears. Once there, click on the <span class="strong"><strong>Add Current</strong></span> button; observe now that a new scene file name has been added to the <span class="strong"><strong>scenes in build</strong></span> window.</p></li><li><p>Repeat this process for <code class="literal">LEVEL1</code> as well as for <code class="literal">CHAPTER3_SCENE1</code>, <code class="literal">CHAPTER2_SCENE1</code>, and <code class="literal">CHAPTER1_SCENE1</code>. While we don't need the last three in our final build, let's add them so that they are available for convenience.</p></li></ol></div><p>Congratulations! Now these new scenes will be accessible to the game. Let's connect the new level one scene to the main scene file with a simple pop up.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec38"></a>Creating the PopupMainMenu GameObject</h3></div></div></div><p>A great game<a id="id221" class="indexterm"></a> requires an interesting and usable user interface system. Our game will require a number of pop-up windows that will be used to communicate to the user. The user will also be able to interact with the game by selecting buttons on pop ups. The first pop up we need to create is the one that starts the game on the main menu.</p><p>A number of middleware technologies exist to help the Unity developer create active UI systems quickly and with high quality; at the time of writing this book, NGUI and EGUI are pop-up systems available on the Unity asset store for this very purpose. While it is possible to use any one of these or other extensions to build your UI, we will develop our own from scratch. Let's create a start screen from which we will launch level one by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Switch to the <code class="literal">MAIN</code> scene file.</p></li><li><p>Create a plane, and parent it to <code class="literal">MainCamera</code>. This will serve as the background to our pop-up window panel.</p></li><li><p>Set its position to (<code class="literal">0</code>, <code class="literal">0</code>, <code class="literal">0</code>), and orient it towards the camera. Translate it along its <span class="emphasis"><em>z</em></span> axis so that it is forward from the camera by <code class="literal">9</code> units.</p></li><li><p>Scale the plane by <code class="literal">1.5</code> on the <span class="emphasis"><em>x</em></span> axis, and rotate it to 270 degrees around the <span class="emphasis"><em>x</em></span> axis. At this point, the plane should move with the camera and occlude its line of sight to the rest of the scene. Now, by enabling this GameObject, we have a fullscreen backdrop for menus. Name this plane <code class="literal">PopupMainMenu</code>.</p></li><li><p>Create a new, colored material, and apply it to the plane. In our example, I selected the green color.</p></li><li><p>Create a<a id="id222" class="indexterm"></a> 3D text object. Notice that the component is named <code class="literal">TextMesh</code>. This will be used to communicate with the user in our simple menu page. Parent it to <code class="literal">PopupMainMenu</code>. Set its relative position to (<code class="literal">-3.3</code>, <code class="literal">0.8</code>, <code class="literal">2.9</code>) so that it is near the top and centered. Set its scale to (<code class="literal">0.6</code>, <code class="literal">1</code>, <code class="literal">1</code>), and apply a 90 degree rotation to the <span class="emphasis"><em>x</em></span> axis so that it is nicely centered at the top of the screen.</p></li><li><p>Note that the <code class="literal">TextMesh</code> component in the inspector is a container for the 3DText specific parameters. Set the text to the name of our game Geography Quest.</p></li><li><p>Set the <span class="strong"><strong>CharacterSize</strong></span> to <code class="literal">0.5</code> and the <span class="strong"><strong>FontSize</strong></span> to <code class="literal">21</code> to make the title appear with an appealing size and shape. Just as one might do with a word processor, set the font style to bold for extra visual impact.</p></li><li><p>Name this 3DText object <code class="literal">textGeographyQuest</code> to keep the hierarchy easy to read and maintain.</p></li><li><p>Now, we need a prompt for the user to click to start. Let's duplicate the previous GameObject by clicking on it and pressing <span class="emphasis"><em>Ctr</em></span> + <span class="emphasis"><em>D</em></span>.</p></li><li><p>Rename this object <code class="literal">textClickToContinue</code>. Set the text field of the <code class="literal">TextMesh</code> on this object to <code class="literal">New</code>.</p></li><li><p>Move the GameObject to (<code class="literal">-1.8</code>,<code class="literal"> 0.9</code>, <code class="literal">1.2</code>), and scale the font size down to <code class="literal">15</code> to place and scale the text appropriately.</p></li><li><p>Our menu is almost complete! Let's write a script to handle the mouse-click event. Create a new script, and name it <code class="literal">MainMenuScript</code>. Attach this script to the <code class="literal">PopupMainMenu</code> object.</p></li><li><p>This script will have two private member variables. One to store the main <code class="literal">Game</code> GameObject (the one that holds the <code class="literal">GameMgr</code> and <code class="literal">MissionMgr</code> classes) and one to hold the <code class="literal">GameMgr</code> script instance itself (attached to <code class="literal">Game</code>). We make these private because the object being referred to doesn't need to change during the lifespan of the game, so finding it automatically on startup is more robust. They can be configured as shown in the following code:</p><div class="informalexample"><pre class="programlisting">private GameMgr gm;
Private GameObject GameObj;</pre></div></li><li><p>Inside the <code class="literal">Start()</code> method, we will search for the object named <code class="literal">Game</code>. If it is found, we store a reference to the <code class="literal">GameMgr</code> script instance attached to this object as shown in the following code. Recall that the <code class="literal">Start()</code> method gets invoked by the Unity engine for any class that inherits from <code class="literal">MonoBehavior</code> the first time it runs after instantiation:</p><div class="informalexample"><pre class="programlisting">GameObj = GameObject.Find("Game");
if (GameObj)
{
  gm = GameObj.GetComponent&lt;GmeMgr&gt;();
};</pre></div></li><li><p>We now<a id="id223" class="indexterm"></a> implement a method to handle the mouse click as shown in the following code. Unity will automatically invoke a method called <code class="literal">OnMouseDown()</code> when the user clicks the mouse, so we will use that for detecting the click. This is one of many methods that the <code class="literal">MonoBehavior</code> base class provides for new C# scripts that you create in Unity3D with the new script wizard:</p><div class="informalexample"><pre class="programlisting">void OnMouseDown() { };</pre></div></li><li><p>Inside this method, if we have a <code class="literal">GameMgr</code> script reference, then we will do two things. We call <code class="literal">gm.SetState()</code>, and change the state to <code class="literal">eGameState.eGS_Level1</code> as shown in the following code. This enumeration is defined inside of the <code class="literal">GameMgr</code> class and corresponds to the game being in level one. We will investigate how <code class="literal">GameMgr</code> handles this next. Of course, <code class="literal">gm</code> will only be defined if we remember to rename the <code class="literal">MissionMgr</code> to <code class="literal">Game</code> as requested earlier in this chapter:</p><div class="informalexample"><pre class="programlisting">gm.SetState(gameMgr.eGameState.eGS_Level1);</pre></div></li><li><p>We also then set the <code class="literal">GameObject</code> active flag to <code class="literal">false</code>. This causes the object to cease to update. No scripts or components attached to <code class="literal">PopupMainMenu</code> will run until <code class="literal">active</code> is set to <code class="literal">true</code> again. This has the effect of disabling the pop up (which is what we will want).</p></li></ol></div><p>Congratulations! This pop up will be created when the <code class="literal">MAIN</code> scene is loaded, and when clicked, it will tell the <code class="literal">GameMgr</code> to change levels to level one.</p></div></div>