<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec93"></a>Refactoring level 3</h2></div></div><hr /></div><p>When level 2 <a id="id530" class="indexterm"></a>signals level 3 to load (when the player pressed the level 3 pop up's <span class="strong"><strong>Continue</strong></span> button), it signals for the <code class="literal">_level2</code> Gameobject to be destroyed and the <code class="literal">_level3</code> GameObject to be loaded from the <code class="literal">LEVEL3</code> scene file. We must refactor the start up logic of <code class="literal">_level3</code> so that we can find and connect some object references to GameObjects in the <code class="literal">_global</code> hierarchy. To accomplish this, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new script named <code class="literal">Level3Extras</code>, and attach an instance of it to the <code class="literal">_level3</code> GameObject. This script will be used to directly access certain GameObjects inside <code class="literal">_level3</code> for enabling and disabling.</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_10_08.jpg" /></div></li><li><p>Give the <code class="literal">Level3Extras</code> script the following single public GameObject reference. The <code class="literal">Level3Extras</code> script needs a reference to the <code class="literal">setupLevel3</code> object so that it can connect this reference to the appropriate pop-up button later on in the script:</p><div class="informalexample"><pre class="programlisting">public GameObject setupLevel3;</pre></div></li><li><p>Drag-and-drop the <code class="literal">SetupLevel3</code> GameObject from the <code class="literal">_level3</code> GameObject hierarchy into the <code class="literal">SetupLevel3</code> reference of the <code class="literal">Level3Extras</code> script.</p></li><li><p>Now that <code class="literal">Level3Extras</code> has been properly configured, create another script named <code class="literal">Level3Init</code>, and add an instance of it to the <code class="literal">_level3</code> GameObject.</p></li><li><p>The <code class="literal">level3Init</code> script will use the <code class="literal">Level3Extras</code> as an interface to find specific GameObjects and connect them into the appropriate level 3 pop ups. This needs to happen since the pop ups are global; they cannot preserve references to objects that are dynamically loaded from subsequent levels in the game.</p></li><li><p>In <code class="literal">Level3Init</code>, we first try to find a reference to a GameObject named <code class="literal">MainCamera</code>:</p><div class="informalexample"><pre class="programlisting">GameObject go = GameObject.Find ("MainCamera");</pre></div></li><li><p>If the <code class="literal">MainCamera</code> GameObject can be found, we try to cache a reference to the <code class="literal">PopupMgr</code> script component attached to it:</p><div class="informalexample"><pre class="programlisting">if (go)
{
  PopupMgr ppm = go.GetComponent&lt;PopupMgr&gt;();</pre></div></li><li><p>If the <code class="literal">PopupMgr</code> script <a id="id531" class="indexterm"></a>can be found, we set the initial state of the UI pop ups for level 3. As before, we use <code class="literal">SetActive(false)</code> to suspend the <code class="literal">Update()</code> loop of some scripts and <code class="literal">SetActive(true)</code> to enable others. Namely, we deactivate <code class="literal">popup_Level3Finish</code> and <code class="literal">popup_Level3Restart</code>. We then activate <code class="literal">popup_Level3Start</code> so that the level starts with the relevant UI displayed. Note that at this point, the camera is looking up from <code class="literal">popup_Level2Finish</code>:</p><div class="informalexample"><pre class="programlisting">if (ppm)
{
  ppm.Level3Finish.SetActive (false);
  ppm.Level3Repeat.SetActive(false);
  ppm.Level3Start.SetActive(true);</pre></div></li><li><p>Next, we try to cache a reference to <code class="literal">PopupButtonScript</code>, which is attached to <code class="literal">button1</code> child of <code class="literal">popup_Level3Start</code>. We use <code class="literal">transform.FindChild()</code> to search for an object in a hierarchy by name. Once we find it, we can get the component for <code class="literal">PopupButtonScript</code> itself using <code class="literal">GetComponent()</code>:</p><div class="informalexample"><pre class="programlisting">PopupButtonScript pbs =
  ppm.Level3Start.transform.FindChild 
  ("Button1").gameObject.GetComponent&lt;PopupButtonScript&gt;();</pre></div></li><li><p>Now that we have <code class="literal">PopupButtonScript</code>, we assign a reference to the <code class="literal">Level3Extras</code> script (attached to this object) to the data field of the first action of <code class="literal">PopupButtonScript</code>. This way, when the button is clicked, the <code class="literal">EnableObject</code> action will operate on the <code class="literal">SetupLevel3</code> GameObject (accessed from <code class="literal">Level3Extras</code>):</p><div class="informalexample"><pre class="programlisting">Level3Extras l3x = GetComponent&lt;Level3Extras&gt;();
if (l3x)
{
  pbs.actions[0].data.obj = l3x.setupLevel3;
}</pre></div></li><li><p>Next, we connect the <code class="literal">popup_Level3Finish</code> pop up to the <code class="literal">response_ShowLevel3Results</code> component. This will allow <code class="literal">LevelLogicObj</code> to display the level complete UI:</p><div class="informalexample"><pre class="programlisting">GameObject llo = GameObject.Find ("LevelLogicObj");
if (llo != null)
{
   llo.GetComponent&lt;response_ShowLevel3Results&gt;().passPopup = ppm.Level3Finish;
}</pre></div></li><li><p>In <code class="literal">_level3</code>, the fail <a id="id532" class="indexterm"></a>condition is triggered from the <code class="literal">Timer</code> GameObject, when the time remaining reaches zero. To enable this component to display the <code class="literal">popup_Level3Repeat</code> UI, we must connect them together via the <code class="literal">PopupMgr</code> script:</p><div class="informalexample"><pre class="programlisting">GameObject TimeObj = GameObject.Find ("Time");
if (TimeObj != null)
{
  TimeObj.GetComponent&lt;TimeScript&gt;().failPopup =
    ppm.Level3Repeat;
}</pre></div></li><li><p>Congratulations! The initial setup for <code class="literal">_level3</code> is now complete. Let's turn our attention to updating the <a id="id533" class="indexterm"></a>
<code class="literal">SetupMissionThree()</code> script. To begin, locate this script instance attached to the <code class="literal">setupLevel3</code> object. As with the previous two examples, this script is responsible for connecting the missing references between pop ups that have global persistence and the GameObjects that they refer to inside of specific level scene filesâ€”inside <code class="literal">_level3</code> in this instance.</p></li><li><p>At the beginning of <code class="literal">Start()</code>, we search for the <code class="literal">Player</code> GameObject (named either <code class="literal">Player</code> or <code class="literal">Player1</code>). If it is found, we store a reference to the <code class="literal">PlayerData</code> component for later use:</p><div class="informalexample"><pre class="programlisting">playerData pd = null;
GameObject go = GameObject.Find ("Player1");
if (go == null)
  go = GameObject.Find ("Player");
if (go != null)
{
  pd = go.GetComponent&lt;playerData&gt;();
}</pre></div></li><li><p>Still in the <code class="literal">start</code> method, in the block where five random cards are chosen, we check for the presence of the <code class="literal">PlayerData</code> component on the player. If there is no data, it means we are playing this mission in standalone mode, and so we should use five randomly chosen indices. If, however, <code class="literal">PlayerData</code> has information contained therein, it means that we should use those indices to populate our world to ensure the flag choices are consistent with the previous level:</p><div class="informalexample"><pre class="programlisting">if (pd != null)
  index = pd.flagChoices[k];</pre></div></li></ol></div><p>Congratulations! <a id="id534" class="indexterm"></a>Mission 3 has been updated now to use the flag choices that were randomly chosen in <code class="literal">LEVEL1</code> and reused in <code class="literal">LEVEL2</code>. With that, your e-learning game is complete! Please take a moment to pause, look at how far we have come since <a class="link" href="#" linkend="ch01">Chapter 1</a>, <span class="emphasis"><em>Introduction to E-Learning and the Three Cs of 3D Games</em></span>, and give yourself a pat on the back for a job well done!</p></div>