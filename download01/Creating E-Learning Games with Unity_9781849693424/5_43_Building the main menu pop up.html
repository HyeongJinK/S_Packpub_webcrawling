<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec45"></a>Building the main menu pop up</h2></div></div><hr /></div><p>Let's put all of this <a id="id270" class="indexterm"></a>together and build a functional and extensible pop up for the main menu.</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_05_031.jpg" /></div><p>This pop up will display the name of the game on the title screen and present the user with three working buttons. From this, we will be able to make a pop-up Prefab that can be used for other UI. Perform the following steps to create a main menu pop up:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>To start, let's create the base of the panel. Create a plane that will be the base of the pop up. Set its position to <code class="literal">0</code>, <code class="literal">0</code>, <code class="literal">8.6</code> and its <span class="strong"><strong>X</strong></span> rotation to <code class="literal">-90</code>.</p></li><li><p>Scale the panel to <code class="literal">1.54</code>, <code class="literal">1</code>, <code class="literal">1</code> so that it is a bit wider than it is tall.</p></li><li><p>On the <code class="literal">MeshRenderer</code>, we associate a new material called <code class="literal">popupMaterial</code>. This material has a white-colored component and a texture that is opaque gray with round edges with full alpha. Applying this material makes the plane appear rounded at the corners.</p></li><li><p>Let's rename the plane to <code class="literal">popup_MainMenu</code> to reflect its actual role.</p></li><li><p>The main menu pop up will have four child objects: a text field for the pop-up title and three child objects for the buttons.</p></li><li><p>Create a <code class="literal">3DText</code> object, parent it to the <code class="literal">MainMenu</code> panel, and set its local position to <code class="literal">0</code>, <code class="literal">0.1</code>, <code class="literal">3</code>. This will place the text in front of the panel, that is, front and center. Set the anchor to <code class="literal">middleCenter</code> and the font size to <code class="literal">21</code>. Set the font style to <code class="literal">Bold</code>.</p></li><li><p>Move the game object to <code class="literal">-1.8</code>,<code class="literal">0.9</code>,<code class="literal">1.2</code> and scale down the font size to <code class="literal">15</code> to place and scale the text appropriately.</p></li><li><p>Let's create a button object to use the three interactive elements on the menu. To start, create a plane, rotate it by <code class="literal">-90</code> in the x plane, parent it to the <code class="literal">MainMenu</code> plane, and set its local position to <code class="literal">0</code>, <code class="literal">0.1</code>, <code class="literal">0.2</code>.</p></li><li><p>Set the scale<a id="id271" class="indexterm"></a> of this new object to <code class="literal">0.3</code>, <code class="literal">0.1</code>, <code class="literal">0.2</code>. Rename it to <code class="literal">Button1</code> to make the object hierarchy more clear.</p></li><li><p>Create a <code class="literal">3DText</code> object, attach it to the button, and set the font size to <code class="literal">68</code>. Set the text field to <code class="literal">New</code>.</p></li><li><p>The first button will be for the new action. To handle this, we will need to write a script. Create a new script called <code class="literal">popupButtonScript.cs</code>. Attach an instance of this script to <code class="literal">Button1</code> (the new button).</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_05_07.jpg" /></div></li><li><p>Inside this script, we will create a public enumeration that specifies all of the actions that can occur when the button is pressed. Loading levels one through three, showing and hiding GameObjects, instantiating a Prefab, self-destructing, and quitting the application will be the first actions our button supports:</p><div class="informalexample"><pre class="programlisting">public enum popUpAction { 
  Invalid = -1,  //used to encode error action
  LoadLevel1 = 0,  //used to load level 0
  LoadLevel2 = 1,  //used to load level1
  LoadLevel3 = 2,  // used to load level2
  ShowGameObject =3,  //used to show a GameObject
  HideGameObject = 4,  //used to hide a GameObject
  QuitApplication = 5,  //used to quit application
  DestroyGameObject = 6, //used to destroy a GameObject instance
  Instantiate = 7 //used to instantiate an object from a prefab
}</pre></div></li><li><p>We want to be able to set in script, when we click on a button, which action will be <a id="id272" class="indexterm"></a>invoked on the click. This will require setting the enumeration as well as some side data that will be processed with the click. This class will be called <code class="literal">popupResponse</code>. In order to populate the array of actions on the button with this custom class, we need to make it serializable. Recall that if this class had inherited from <code class="literal">MonoBehavior</code>, then this would have included the serializable functionality; since we don't inherit from any base class, we need to add this back explicitly. This will allow the class properties to be saved inside the editor:</p><div class="informalexample"><pre class="programlisting">[System.Serializable] 
public class popupResponse
{
  public popupAction action;
  public popupData data;
}</pre></div></li><li><p>We will also need a class to describe the side data that the button needs to operate on when clicked. This will be contained in the serializable <code class="literal">popupData</code> class. This class contains a set of variables of different datatypes that a button may or may not use as side data while processing its action:</p><div class="informalexample"><pre class="programlisting">[System.Serializable] 
public class popupData
{
  public GameObject obj; // a potential GameObject to operate on
  public int id; //an integer id to use when processing a popup
  public string name;//a string to use when processing a popup
}</pre></div></li><li><p>We keep a list of actions (pop-up response classes) that will be invoked on a click on each button. This is kept as an array and not as a single response so that a button can perform an arbitrary number of tasks on a click.</p><div class="informalexample"><pre class="programlisting">public list&lt;popupResponse&gt; actions; </pre></div></li><li><p>We create an enumeration for the current state of the button. This will be used to codify whether or not the mouse pointer is over the button and whether we should display the highlighted or non-highlighted texture:</p><div class="informalexample"><pre class="programlisting">public enum eButtonState
{
  Invalid = -1,
  Off = 0,
  On = 1 // a tri state enum used to encode if a button is clicked or not
};</pre></div></li><li><p>We keep two variables of the <code class="literal">eButtonState</code> type. The <code class="literal">ButtonState</code> variable represents the current <code class="literal">eButtonState</code> of the button; namely, if it is<code class="literal"> On</code> or <code class="literal">Off</code>. The <code class="literal">PrevTickButtonState</code> variable stores the <code class="literal">ButtonState</code> for every frame <a id="id273" class="indexterm"></a>that the button itself updates. We use two state variables to search for the frame where the state changes so that we can dispatch the button actions on that frame:</p><div class="informalexample"><pre class="programlisting">Public eButtonState ButtonState;
Public eButtonSTate prevTickButtonState;</pre></div></li><li><p>We add two public <code class="literal">Texture</code> references in this script. This allows the programmer to associate an <code class="literal">On</code> and <code class="literal">Off</code> texture for the button. When the mouse is over the button, the <code class="literal">On</code> texture will be displayed. When the mouse is not over the button, the <code class="literal">Off</code> texture will be shown:</p><div class="informalexample"><pre class="programlisting">Public Texture On;
Public Texture Off;</pre></div></li><li><p>We keep references to the object named <code class="literal">Game</code> in the scene. We also keep a reference to the <code class="literal">gameManager</code> script attached to this. These are cached in the <code class="literal">start</code> method.</p></li><li><p>In the <code class="literal">Update()</code> loop of the button GameObject, we compare <code class="literal">prevTickButtonState</code> with <code class="literal">ButtonState</code>:</p><div class="informalexample"><pre class="programlisting">PrevTickButtonState = ButtonState;</pre></div></li><li><p>In the <code class="literal">OnMouseDown()</code> method of this GameObject (mouse down on the button), we call the <code class="literal">Dispatch()</code> method, which iterates through all of the <code class="literal">buttonResponses</code> in the action list.</p></li><li><p>The <code class="literal">Dispatch()</code> method is where the brunt of the work for the button occurs. It loops over all of the actions in the action array (from <code class="literal">0</code> to <code class="literal">Count</code>):</p><div class="informalexample"><pre class="programlisting">for (int i= 0; I &lt; actions.Count; i++)
{
  popupResponse r = actions[i];
}</pre></div></li><li><p>A <code class="literal">switch</code> statement is used to selectively update the logic of the button based on the type of action in the actions array in each slot. Each potential <code class="literal">popupAction</code> has its own implementation in this block:</p><div class="informalexample"><pre class="programlisting">switch(r.action)
{
  // each case() implements a different behavior
}</pre></div></li><li><p>The case for <code class="literal">LoadLevel 1</code>, <code class="literal">LoadLevel 2</code>, or <code class="literal">LoadLevel 3</code> will use the <code class="literal">GameMgr</code> component reference, and set the <code class="literal">GameState</code> in the <code class="literal">GameMgr</code> component to <code class="literal">levelLoad</code>, which then performs the <code class="literal">Application.LoadLevelAdditive</code> call.</p></li><li><p>The case for <code class="literal">Instantiate</code> will dereference the <code class="literal">GameObj</code> object in the <code class="literal">popupData sideData</code> member, and perform a <code class="literal">GameObject.Instantiate</code> call on it to duplicate that Prefab. It will then set the parent to the GameObject <a id="id274" class="indexterm"></a>that has the name <code class="literal">'name'</code> from the <span class="strong"><strong>sideData</strong></span> field. Lastly, it will set the position and orientation to <code class="literal">post</code> and rotation of the Prefab after it is initialized (the <code class="literal">pos</code> and <code class="literal">rot</code> values of the Prefab at the time it is created).</p></li><li><p>The <code class="literal">HideObject</code> and <code class="literal">ShowObject</code> actions will set the object referenced by the <code class="literal">sideData</code> to either <code class="literal">active =true</code> or <code class="literal">active=false</code>. This has the effect of disabling or enabling the renderer as well as the rest of the game logic/components on this object.</p></li><li><p>The self-destruct method will call <code class="literal">Destroy()</code> on the parent object of the button. This has the effect of destroying the pop up and all the children buttons and such. Of course, this assumes that buttons are a 1-layer child of the main pop-up root! Whether you decide to destroy or hide an object, it will depend on the specific needs of your game. Destroying an object will of course free up more memory; however, this should be done for every frame. If a lightweight way to hide and unhide an object is required, consider just disabling and enabling the renderer with <code class="literal">HideObject</code> and <code class="literal">ShowObject</code>.</p></li></ol></div><p>Congratulations! We have an implemented <code class="literal">popupButtonScript</code> attached to our <span class="strong"><strong>NEW</strong></span> button. Let's configure it:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>On the <span class="strong"><strong>NEW</strong></span> button, open up the <code class="literal">popupButtonScript</code> and set the number of actions to <code class="literal">2</code> (by manually setting <code class="literal">size = 2</code>). This will correspond to two actions that will be invoked, one at a time, on mouse click.</p></li><li><p>Set the action of <span class="strong"><strong>Element 0</strong></span> to be <code class="literal">LoadLevel1</code>. Open up the <span class="strong"><strong>Data</strong></span> field associated with this action and set the name to <code class="literal">LEVEL1</code> (to match the scene file name).</p></li><li><p>For <span class="strong"><strong>Element 1</strong></span>, set the action to <code class="literal">SelfDestruct</code>. By putting this second, we guarantee the button will load the new level and then destroy the pop up (which is what we want!).</p></li><li><p>Set the <code class="literal">On</code> texture to a light blue-colored texture and the <code class="literal">Off</code> texture to a dark blue variation. Set the <code class="literal">ButtonState</code> to <code class="literal">Off</code> by default.</p></li></ol></div><p>Congratulations! We now have a working <span class="strong"><strong>NEW</strong></span> button that starts a new game by loading a new level and destroying the menu pop up. At this point, we can delete the previous main menu page.</p><p>Let's continue building out the <code class="literal">MainMenu</code> Prefab:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Duplicate the <span class="strong"><strong>NEW</strong></span> button twice, and translate the two copies below the first one to (<code class="literal">0</code>,<code class="literal">0.1</code>,<code class="literal">-1.5</code>) and (<code class="literal">0</code>,<code class="literal">0.1</code>,<code class="literal">-3</code>).</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_05_08.jpg" /></div></li><li><p>Rename the second button to <code class="literal">Button2</code> and set the name of the text field to <code class="literal">Info</code>. Rename the third button to <code class="literal">Button3</code> and set the name of the text field to <code class="literal">QUIT</code>.</p></li><li><p>Open<a id="id275" class="indexterm"></a> the <code class="literal">popupButtonScript</code> on the third button, and change the <code class="literal">On</code> and <code class="literal">Off</code> textures to light and dark red textures, respectively. Change the number of actions in the script to <code class="literal">1</code> and set the action to <code class="literal">QuitApplication</code>.</p></li><li><p>Open the <code class="literal">popupButtonScript</code> on the second button and change two actions. The first one should be <code class="literal">Instantiate</code>, where <code class="literal">obj</code> is the <code class="literal">popup_Info</code> Prefab, and the parent object's name is codified under the name field <code class="literal">MainCamera</code>.</p></li><li><p>Set the second element of this array to <code class="literal">SelfDestruct</code>. With this, the <span class="strong"><strong>Info</strong></span> button will create a new instance of a <code class="literal">popup_info</code> panel and destroy itself. The pattern we will use to return to the main menu will be such that the <code class="literal">popup_info</code> button allocates a new instance of the pop up when instructed to do so, after which it will destroy itself. In this way, the content of the UI pop up for both pages is completely contained inside the pop-up Prefabs we have created in the editor.</p></li><li><p>Let's create a<a id="id276" class="indexterm"></a> new script that manages the pop up at its top level; call it <code class="literal">popupPanel</code>. Associate an instance of this script with the root of the <code class="literal">MainMenu</code>.</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_05_09.jpg" /></div></li><li><p>In this script, create a single public string named <code class="literal">nametxt</code> and a reference to  <code class="literal">TextMesh</code>. In the <code class="literal">start</code> method, copy the public string variable's contents over the top of the string member of the <code class="literal">TextMesh</code>. This gives a simpler interface to name the pop up; we will use this script as a central place to interface with the pop up.</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_05_05.jpg" /></div></li></ol></div><p>Great! Now, we<a id="id277" class="indexterm"></a> have three functional buttons on our pop up. When we move over them, the <code class="literal">PopupButton</code> script swaps the highlighted and non-highlighted textures for an additional visual cue.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Drag-and-drop this pop up into the <span class="strong"><strong>Project</strong></span> tab to make a Prefab out of it. Name the Prefab <code class="literal">popup_MainMenu</code>. We will need to reinstance our main menu from the Prefab at a later time.</p></li><li><p>Let's create a new Prefab based on this one. It will be used for the <span class="strong"><strong>Information</strong></span> tab. To begin, copy and paste the <code class="literal">popup_MainMenu</code> Prefab. Rename it <code class="literal">popup_Info</code>.</p></li><li><p>Keeping the dimensions the same, rename the panel to <code class="literal">Info</code> by changing the pop-up name parameter in the <code class="literal">popupPanel</code> script.</p></li><li><p>Delete button 2 and button 3 from the <code class="literal">popup_Info</code> object; we only need one button on this panel to return to the main menu. Open the <code class="literal">popupButtonScript</code> on the single button and ensure that there are two valid actions.</p></li><li><p>Set the first action to <code class="literal">Instantiate</code>. In the data member for that action, set the <code class="literal">Obj</code> to instantiate to a reference to the <code class="literal">popup_MainMenu</code> Prefab. This will tell the button to create a copy of the <code class="literal">popup_MainMenu</code> Prefab when the button is clicked. To tell the script which GameObject to parent this new instance to, add the name of the object to the <span class="strong"><strong>Name</strong></span> field and change the name field to <code class="literal">MainCamera</code>.</p></li><li><p>Set the second action to <code class="literal">SelfDestruct</code> so that this button will delete itself on a click.</p></li><li><p>In the <code class="literal">popup_Info</code> object, add five more <code class="literal">TextMesh</code> GameObject instances. Put them on successive lines at a distance of <code class="literal">0.8</code> units in z from one another. These will be used to store the lines of text in your information pop up. Set the first three lines of text to the following:</p><div class="informalexample"><pre class="programlisting">Geography Quest © 2014
PACKT Publishing
all rights reserved</pre></div></li><li><p>Save this Prefab to the project folder by dragging-and-dropping it into your assets folder. Name the new Prefab <code class="literal">popup_Info</code>.</p></li><li><p>Go back to <a id="id278" class="indexterm"></a>your <code class="literal">popup_MainMenu</code> and open up the button 2 <code class="literal">popupButtonScript</code> component. Find the <code class="literal">Instantiate</code> command in the actions array for this button. Now, go to the <span class="strong"><strong>Data</strong></span> field for this action, and change the <code class="literal">obj</code> reference to the Prefab <code class="literal">popup_Info</code> by dragging-and-dropping it from the <span class="strong"><strong>Project</strong></span> tab back to this field. Also, make sure the name of the parent object is also set at this time to <code class="literal">MainCamera</code>.</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_05_06.jpg" /></div></li></ol></div><p>Congratulations! We now have a working information screen pop-up that has been connected to the <span class="strong"><strong>Info</strong></span> button of our working main menu pop up. If you have not already done so, please delete the previous main menu panel from the last chapter; we will not need this anymore as our pop-up system can do the job of starting our game. Please make sure there is only one instance of <code class="literal">popup_MainMenu</code> attached to the camera by default, and that there is no <code class="literal">popup_info</code> object instance on the main camera by default.</p><div class="mediaobject"><img src="/graphics/9781849693424/graphics/3424OS_05_10.jpg" /></div></div>