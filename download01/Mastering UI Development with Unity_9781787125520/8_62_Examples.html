<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec63"></a>Examples</h2></div></div><hr /></div><p>The main point in this <span>chapter</span><a id="id325334202" class="indexterm"></a> is providing <span>examples</span><a id="id325334211" class="indexterm"></a> of how to create common UI animations and effects, so let's get to it.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec90"></a>Animating pop up windows to fade in and out</h3></div></div></div><p>With our first example, we will continue to <span>work</span><a id="id325368567" class="indexterm"></a> on our main scene. Duplicate the <code class="literal">Chapter7</code> scene to create a new scene named <code class="literal">Chapter8</code>. Open the <code class="literal">Chapter8</code> scene and complete this example within it.</p><p>Currently, we have a <code class="literal">Pause Panel</code> and <code class="literal">Inventory Panel</code> that instantly appear when the <span class="emphasis"><em>P</em></span> or <span class="emphasis"><em>I</em></span> key is pressed. That's not <span>terribly</span><a id="id325368617" class="indexterm"></a> interesting, so let's add <span>some</span><a id="id325368626" class="indexterm"></a> animations to have the panels <span class="emphasis"><em>pop</em></span> in and out with fade and scale animations.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip88"></a>Note</h3><p>It can get rather tedious having to expand all of the parents to see their children every time you go to a new scene. A shortcut to open all parents is to select everything in the Hierarchy and then press the right arrow key on the keyboard. You can do this multiple times if you have multiple nestings. The left arrow key will collapse the parents.</p></div><p>Our workflow to set up these animations and their functionality will be to create Animation Clips, set up our Animator, and then write code that sets the Animator's parameters at the appropriate times. To make the steps easier to digest, I've broken them into sections. The first section covers all of the steps involved with setting up the Animation Clips and Animator and the second section covers the sets involved with writing code.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch08lvl3sec70"></a>Setting up the animations</h4></div></div></div><p>To create a "pop" in and <span>out</span><a id="id325599126" class="indexterm"></a> animation on the <code class="literal">Pause Panel</code> and <code class="literal">Inventory Panel</code>, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>We'll start by adding an Animation Clip to the <code class="literal">Pause Panel</code> that will cause it to scale and fade in. Open the Animation Window and select <code class="literal">Pause Panel</code> from the <strong class="userinput"><code>Hierarchy</code></strong>. Select <strong class="userinput"><code>Create</code></strong> to add a new Animation Clip. Save the new Animation Clip in the <code class="literal">Assets/Animation</code> folder and name it <code class="literal">FadeAndScale</code>.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>We want to control four properties of this panel: its scale, its alpha value, its ability to be interacted with, and its raycast blocking. Let's start with scale. We can adjust this property from the Rect Transform component. Select <strong class="userinput"><code>Add Property</code></strong> and click on the plus sign next to <strong class="userinput"><code>Scale</code></strong> under <strong class="userinput"><code>Rect Transform</code></strong>, as follows:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/a4faff4e-a781-4bee-a148-b1270f760bea.png" /></div></li><li>Two keyframes are initialized for the <strong class="userinput"><code>Scale</code></strong> property at <strong class="userinput"><code>0:00</code></strong> and <strong class="userinput"><code>1:00</code></strong>. This means that the animation will last 1 second, which is a bit long for a pop-in animation. Select the keyframe at <strong class="userinput"><code>1:00</code></strong> and drag it to <strong class="userinput"><code>0:30</code></strong> to make the animation half a second long:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/d708fd12-86d5-47c0-887b-eaf8d6836871.png" /></div></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>We want the panel to start out small and then get big. To achieve this, we will need to adjust the <span class="emphasis"><em>x</em></span> and <span class="emphasis"><em>y</em></span> scale. Expand the <strong class="userinput"><code>Scale</code></strong> property (select the arrow next to <strong class="userinput"><code>Pause Panel : Scale</code></strong>) to view the <span class="emphasis"><em>x</em></span>, <span class="emphasis"><em>y</em></span>, and <span class="emphasis"><em>z</em></span> properties of <strong class="userinput"><code>Scale</code></strong>. Currently, the scale for all three coordinates are set to <code class="literal">1</code> at <span>both</span><a id="id325628436" class="indexterm"></a> keyframes. Since we want the scale to start small and then enlarge to its normal size, we want it to scale from <code class="literal">0</code> to <code class="literal">1</code>. We only need to adjust the <span class="emphasis"><em>x</em></span> and <span class="emphasis"><em>y</em></span> scale since <span class="emphasis"><em>z</em></span> scale doesn't really affect a 2D object. So, at the keyframe <strong class="userinput"><code>0:00</code></strong>, change the <strong class="userinput"><code>Scale.x</code></strong> and <strong class="userinput"><code>Scale.y</code></strong> properties to <code class="literal">0</code> by typing <code class="literal">0</code> in their property boxes, as follows:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/793f69c2-472a-450f-af81-9f92f7977d2a.png" /></div>
If you play the animation, you'll note that the <code class="literal">Pause Panel</code> quickly scaling in. Since parent/child relationships scale children with their parents, we don't have to animate the scale of all the <code class="literal">Pause Panel</code> children separately.</li><li>Now, let's control the alpha of the panel to fade it in. We don't want to animate the alpha on the <strong class="userinput"><code>Color</code></strong> property of the Image component of <code class="literal">Pause Panel</code>. Doing so would only affect the alpha of the panel's background image and would not affect the children. Instead, we want to animate the alpha value on the Canvas Group component. This will make the alpha of the Pause Panel and all its children work in unison. Remember that this was the whole reason we used a Canvas Group component to begin with.
Let's select <strong class="userinput"><code>Add Property | Canvas Group | Alpha</code></strong>:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/f4cacddb-c26d-4325-b86f-0a7abb0b5699.png" /></div></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>To fade in, the panel should start completely transparent and end completely opaque. Both keyframes already have the <strong class="userinput"><code>CanvasGroup.Alpha</code></strong> property set to <code class="literal">1</code>, so change the <strong class="userinput"><code>CanvasGroup.Alpha</code></strong> property to <code class="literal">0</code> at the first keyframe. Playing the animation (or scrubbing the playhead) will show the panel and all of its children fading in.</li><li>We will need to animate whether or <span>not</span><a id="id325628540" class="indexterm"></a> the panel can be interacted with. We don't want the player to be able to interact with the drop-down menu or mute buttons when the panel is still popping in. This too is controlled by the Canvas Group component—select <strong class="userinput"><code>Add Property | Canvas Group | Interactable</code></strong>.</li><li>The <code class="literal">Pause Panel</code> and its children should be interactable only after it has fully popped in to the scene. So, deselect the checkbox next to <strong class="userinput"><code>CanvasGroup.Interactable</code></strong> at the first keyframe to make the Canvas Group animate from interactable to not interactable. When you scrub the playhead, you'll see that the property does not turn back on until the very last frame.</li><li>The last item we will need to animate is its raycast blocking.  Select <strong class="userinput"><code>Add Property | Canvas Group | Blocks Raycast</code></strong>. Animate it from <code class="literal">false</code> to <code class="literal">true</code> as you did with the <strong class="userinput"><code>Interactable</code></strong> property.
Your <code class="literal">FadeAndScale</code> Animation Clip's timeline should now appear, as follows:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/37d32931-c2f6-4570-880b-af56ff7fc57d.png" /></div></li><li>Now that we have our Animation Clip set up, we can start working inside the Animator. When we created the <code class="literal">FadeAndScale</code> Animation clip, an Animator named <code class="literal">Pause Panel</code> was automatically created. An Animator component was also added to the <code class="literal">Pause Panel</code> GameObject, with the <code class="literal">Pause Panel</code> Animator assigned to it.
With <code class="literal">Pause Panel</code> selected, open the Animator Window. You should see something similar to the following:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/7fc9ece2-2e78-4219-aa3b-1d4d01022213.png" /></div>
You will see a state named <code class="literal">FadeAndScale</code>. This state uses the <code class="literal">FadeAndScale</code> Animation Clip as its <strong class="userinput"><code>Motion</code></strong>. Selecting the <code class="literal">FadeAndScale</code> State will show the following properties in <span>the</span><strong class="userinput"><code>Inspector</code></strong>:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/21dd070d-ec5e-479c-ad9d-18faf7405dc7.png" /></div></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="11" type="1"><li>Currently, since the <code class="literal">FadeAndScale</code> state is connected to the <code class="literal">Entry</code> node and set as the Layer Default State, when we play the game, the <code class="literal">FadeAndScale</code> animation will play instantly. It will also play on loop. That's <span>not</span><a id="id325628729" class="indexterm"></a> at all what we want, obviously. Let's stop it from playing when the game starts by creating an empty state as the Layer Default State. Right-click anywhere within the Animator and select <strong class="userinput"><code>Create State | Empty</code></strong>:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/6f0dade5-023a-4388-a7a5-bb127d227ba3.png" /></div>
This will add a gray colored state named <code class="literal">New State</code> to the Animator. </li><li>Rename <code class="literal">New State</code> to <code class="literal">Empty State</code> by changing its name in its <strong class="userinput"><code>Inspector</code></strong>.</li><li>Set <code class="literal">Empty State</code> to the Layer Default State by right-clicking on it and selecting <strong class="userinput"><code>Set as Layer Default State</code></strong>:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/09b65b52-f385-4db0-bab9-3296bb66ab4b.png" /></div></li></ol></div><p>It will now be connected to <code class="literal">Entry</code> via a transition. <code class="literal">FadeAndScale</code> will also now no longer be the Layer Default State and will not have any transitions connected to it:</p><div class="mediaobject"><img src="/graphics/9781787125520/graphics/3f83358c-fe07-4b50-9428-17f2a386b84a.png" /></div><p>We used an empty state as our Layer Default State, because we want the panel to do nothing, while it waits for us to <span>tell</span><a id="id325628841" class="indexterm"></a> it to start animating.</p><div class="orderedlist"><ol class="orderedlist arabic" start="14" type="1"><li>Rearrange the items to a more viewable layout. I personally like the following layout for this Animator:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/d731aa62-a7fb-4fba-97b1-617f43eab5ce.png" /></div></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="15" type="1"><li>The <code class="literal">FadeAndScale</code> Animation Clip now no longer instantly plays when the game starts. It is still set to have its animation loop, however. To fix this, select the <code class="literal">FadeAndScale</code> Animation Clip from your <strong class="userinput"><code>Project</code></strong> folder view. This will bring up its <strong class="userinput"><code>Inspector</code></strong>.</li></ol></div><p>Deselect the <strong class="userinput"><code>Loop Time</code></strong> property to disable looping on the animation:</p><div class="mediaobject"><img src="/graphics/9781787125520/graphics/f3dcc9bb-b6a2-4d23-aa5c-bf7e492c4f59.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="16" type="1"><li>We want the <code class="literal">Pause Panel</code> to be able to fade in and fade out on command, but we don't have an Animation Clip for fading out, only one for fading in. We actually don't need to create a whole Animation Clip to <span>achieve</span><a id="id325628914" class="indexterm"></a> this motion. We can simply play the <code class="literal">FadeAndScale</code> Animation Clip backward.
Duplicate the <code class="literal">FadeAndScale</code> state by selecting it and pressing <span class="emphasis"><em>Ctrl </em></span>+ <span class="emphasis"><em>D</em></span>. This will give you a new state named <code class="literal">FadeAndScale 0</code> that has the <code class="literal">FadeAndScale</code> Animation Clip set as its <strong class="userinput"><code>Motion</code></strong>:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/955f2d36-422a-4363-9cb7-0f7df321eaa6.png" /></div></li><li>Rename the <code class="literal">FadeAndScale</code> state to <code class="literal">FadeAndScaleIn</code> and the <code class="literal">FadeAndScale 0</code> state to <code class="literal">FadeAndScaleOut</code>.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="18" type="1"><li>To set the <code class="literal">FadeAndScaleOut</code> state to play the <code class="literal">FadeAndScale</code> Animation Clip backward, we simply have to change its <strong class="userinput"><code>Speed</code></strong> to <code class="literal">-1</code> in its <strong class="userinput"><code>Inspector</code></strong>:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/8c41f98f-6854-4cbc-8edd-7962923e9a30.png" /></div></li><li>Now that we have all of our <span>states</span><a id="id325629041" class="indexterm"></a> set up properly, we can create the transitions between them. Start by creating two Trigger Parameters named <code class="literal">FadeIn</code> and <code class="literal">FadeOut</code>:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/7e037fed-a186-4f4e-b191-28279b0ae6aa.png" /></div>
We are using Trigger Parameters here because we want these values to instantly reset after we've used them. That way, we can create an animation "cycle" without having to write code that resets the parameter values.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="20" type="1"><li>You create transitions between <span>states</span><a id="id325629074" class="indexterm"></a> by right-clicking on the first state, selecting <strong class="userinput"><code>Make Transition</code></strong>, and then clicking on the second state:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/7390d1d2-1ad0-44ea-8915-189bf071ab5b.png" /></div>
Create transitions between the states in the following manner:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/0d735de9-c4b3-4cbf-92e3-8383278cf54c.png" /></div>
This transition flow will allow the panel to transition from no animation to the <code class="literal">FadeAndScale</code> Animation, then to the reversed <code class="literal">FadeAndScale</code> Animation, and back and forth between the two.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="21" type="1"><li>If you play the game, <code class="literal">Pause Panel</code> will instantly go from <span>the</span><code class="literal">Empty State</code> to the <code class="literal">FadeAndScaleIn</code> state and then to the <code class="literal">FadeAndScaleOut</code> state, and back and forth between the two indefinitely. This is because transitions are automatically set to occur after an animation is complete. To stop this, you have to tell the transitions to only occur after a parameter has been set.
Select the transition between the <code class="literal">Empty State</code> and the <code class="literal">FadeAndScaleIn</code> state. Select the plus sign in the <strong class="userinput"><code>Conditions</code></strong> list to add a <span>new</span><a id="id325629146" class="indexterm"></a> condition. Ensure that the condition is set to the <code class="literal">FadeIn</code> trigger. Since we don't want timing to be a factor of our transition, deselect <strong class="userinput"><code>Has Exit Time</code></strong>:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/f0b51e08-79aa-47c5-9835-97ca2cd22bf6.png" /></div></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="22" type="1"><li>Complete the same steps for the transitions between the <code class="literal">FadeAndScaleIn</code> and <code class="literal">FadeAndScaleOut</code> states. Set the condition from the <code class="literal">FadeAndScaleIn</code> and <code class="literal">FadeAndScaleOut</code> state to the <code class="literal">FadeOut</code> trigger, and set the condition from the <code class="literal">FadeAndScaleOut</code> and <code class="literal">FadeAndScaleIn</code> state to the <code class="literal">FadeIn</code> trigger. Additionally, deselect <strong class="userinput"><code>Fixed Duration</code></strong> and set all values to <code class="literal">0</code> to ensure an instant <span>transition</span>:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/86f6b4e2-41d3-4aad-915d-2ef4724c0fb7.png" /></div></li><li>If you play the game now, you'll note that the <code class="literal">Pause Panel</code> is visible when the game starts. This is because our animation states supersede the code we wrote in <code class="literal">ShowHidePanels.cs</code> that made the <code class="literal">Pause Panel</code> invisible at the start of the scene. We'll deal with our broken code later, but for now, make the <code class="literal">Pause Panel</code> invisible at start by setting its <span><strong class="userinput"><code>Canvas Group</code></strong></span> component to <span>have</span><a id="id325629281" class="indexterm"></a> the following values:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/54c05ce9-18ba-4007-933d-d12d702e013f.png" /></div>
Now when you play the game, the <code class="literal">Pause Panel</code> will not appear at the start.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="24" type="1"><li>We've completed setting up the animations for the <code class="literal">Pause Panel</code>, but before you proceed to the <code class="literal">Inventory Panel</code>, check whether the animations are working correctly. To do so, arrange your windows so that your Game View and Animator window are both visible:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/fc8e81ea-f8d7-463c-b48f-3574f0635204.png" /></div>
You'll see the progress bar on the current state of <code class="literal">Pause Panel</code> running. To force the transitions, click on the circles next to the appropriate Trigger parameters.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="25" type="1"><li>If your animations are working the way they should, you can now set up the animations on <span>the</span><code class="literal">Inventory Panel</code>. You may be thinking, "Ugh, now I have to do all of this again for the Inventory Panel?!" However, worry not, you don't have to do it again, because you can reuse the Animator for the <code class="literal">Pause Panel</code> on the <code class="literal">Inventory Panel</code>. All of the properties we changed on the <code class="literal">Pause Panel</code> in the <code class="literal">FadeAndScale</code> Animation Clip also exist on the <code class="literal">Inventory Panel</code>. So, to give the same set of animations and controls to the <code class="literal">Inventory Panel</code>, we can simply attach the Animator we created to <code class="literal">Inventory Panel</code>.
Since we will be using the Animator <span>we</span><a id="id325629367" class="indexterm"></a> created on two different objects, it's a good idea to rename it. Change the name from <code class="literal">Pause Panel</code> to <code class="literal">PopUpPanels</code>. Now, drag it on to the <code class="literal">Inventory Panel</code>.</li><li>Just as we had to change the properties of the Canvas Group on <code class="literal">Pause Panel</code> to stop it from appearing when the scene starts, we also have to change the properties on the Canvas Group of the <code class="literal">Inventory Panel</code>. Set the properties as they appear in step 23.</li></ol></div><p>Now that we are done setting up our animations for our two panels, we can begin writing code that will trigger the animations when the P and I keys are hit to bring up the panels.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch08lvl3sec71"></a>Setting the Animator's Parameters with code</h4></div></div></div><p>We have a script named <code class="literal">ShowHidePanels.cs</code> attached to <span>the</span><code class="literal">Main Camera</code> that would bring the <code class="literal">Pause Panel</code> and <code class="literal">Inventory Panel</code> up when the P and I keys are pressed. Sadly, it no longer functions, since the animations now supersede the <span>properties</span><a id="id325629421" class="indexterm"></a> of the Canvas Groups we set within it. We can reuse the logic, but will have to do a bit of work to get out panels popping again.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip89"></a>Note</h3><p>The changes that we will make to ShowHidePanels.cs will cause the panels <span>in</span> preceding chapter scenes to stop appearing. If you plan on accessing the previous chapter scenes, save a secondary copy of this script as it is now so that you can access it l<span>ater. </span></p></div><p>To trigger the animations on the <code class="literal">Pause Panel</code> and <code class="literal">Inventory Panel</code> with code, complete the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Open the <code class="literal">ShowHidePanels.cs</code> script. We have to delete everything related to Canvas Groups and their properties. After you delete all the code related to Canvas Groups, you'll have a barebones script that appears, as follows:</li></ol></div><pre class="programlisting">using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class ShowHidePanels : MonoBehaviour {
    public bool inventoryUp=false;
    public bool pauseUp=false;

    // Use this for initialization
    void Start () {
    }

    // Update is called once per frame   
    void Update () { 
        //inventory panel
        if(Input.GetKeyDown(KeyCode.I) &amp;&amp; pauseUp==false){
            //not visible 
            if(inventoryUp==false){
                inventoryUp=true;

            //already visible
            }else{
                inventoryUp=false;
            }
        }

        //pause panel
        if(Input.GetButtonDown("Pause")){ 
            //not visible 
            if(pauseUp==false){ 
                pauseUp=true; 
                Time.timeScale=0;

            //already visible 
            }else{
                pauseUp=false;
                Time.timeScale=1;
            } 
        }
    }
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Instead of referencing the <code class="literal">Pause Panel</code> and <code class="literal">Inventory Panel</code> with their Canvas Group components, we'll now reference them with their Animator components. Create the following two variable declarations at the top of the class:</li></ol></div><pre class="programlisting">public Animator inventoryPanelAnim;
public Animator pausePanelAnim;</pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Now, all we have to do is set the appropriate animation trigger parameters when we want the panels to appear and disappear. We will do that using the <code class="literal">SetTrigger()</code> function. To call and dismiss the inventory panel, add the following two lines to your if statement that checks for the I key to appear as follows:</li></ol></div><pre class="programlisting">if(Input.GetKeyDown(KeyCode.I) &amp;&amp; pauseUp==false){ 
<span class="emphasis"><em>//not visible</em></span>
    if(inventoryUp==false){
        inventoryUp=true;
<span class="strong"><strong>inventoryPanelAnim.SetTrigger("FadeIn");</strong></span>

<span class="emphasis"><em>//already visible</em></span>
    }else{
        inventoryUp=false;
<span class="strong"><strong>inventoryPanelAnim.SetTrigger("FadeOut");</strong></span>
    }
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Now, update the if statement for the pause key with the following two lines:</li></ol></div><pre class="programlisting">if(Input.GetButtonDown("Pause")){ 
<span class="emphasis"><em>//not visible</em></span>
    if(pauseUp==false){
        pauseUp=true;
        Time.timeScale=0;
<span class="strong"><strong>pausePanelAnim.SetTrigger("FadeIn");</strong></span>

<span class="emphasis"><em>//already visible</em></span>
    }else{
        pauseUp=false;
        Time.timeScale=1;

<span class="strong"><strong>pausePanelAnim.SetTrigger("FadeOut");</strong></span>
 }
} </pre><p>That's all we have to do to the code.</p><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Drag the <code class="literal">Inventory Panel</code> and the <code class="literal">Pause Panel</code> into their appropriate slots on the Show Hide Panels component:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/85ff6ba1-5095-4967-b46f-b04706d2d90c.png" /></div></li><li>Play the game and watch it kind of work. <code class="literal">Inventory Panel</code> should appear and disappear as necessary, but the <code class="literal">Pause Panel</code> won't work the way it is supposed to. This is because the following line of code stops all animations from happening that depend on time scale:</li></ol></div><pre class="programlisting">Time.timeScale=0;</pre><p>That line of code was used to effectively pause the game. However, that means its pausing our <code class="literal">Pause Panel</code> pop-up animation. Don't worry, you can still use this simple pause code and run animations when the game is paused. All you have to do is tell the Animator on the <code class="literal">Pause Panel</code> that it can still function <span>when</span><a id="id325636596" class="indexterm"></a> the time scale is set to <code class="literal">0</code>. You do this by changing <span>the</span><strong class="userinput"><code>Update Mode</code></strong> on the Animator component from <strong class="userinput"><code>Normal</code></strong> to <strong class="userinput"><code>Unscaled Time</code></strong>:</p><div class="mediaobject"><img src="/graphics/9781787125520/graphics/8415a1ed-a4a1-4517-b311-d0039c3743e2.png" /></div><p>You only need to do this on the Animator component of <code class="literal">Pause Panel</code>. <code class="literal">Inventory Panel</code> will not be animating when the game is paused, so its <strong class="userinput"><code>Update Mode</code></strong> can remain as <strong class="userinput"><code>Normal</code></strong>.</p><p>Play the game, and you should have smoothly animating Pause and Inventory Panels.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec91"></a>Animating a complex loot box with Particle System</h3></div></div></div><p>For this example, we'll work with a new scene. The animation we will create is a bit complicated—a chest will fly in to the scene and then wait for the player to open it. Once the player opens it, the chest will animate open with a particle <span>system</span><a id="id325636690" class="indexterm"></a> that pops in front of it. Then, three collectibles will fly out in sequence. Each collectible will have its own "shiny" animation that begins to play. The following figure is a storyboard of sorts that <span>shows</span><a id="id325636698" class="indexterm"></a> a few key frames of the animation playing out:</p><div class="mediaobject"><img src="/graphics/9781787125520/graphics/b2959396-ae49-4811-b04a-3813c7c317fc.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note90"></a>Note</h3><p>The chest sprite sheet was obtained from <a class="ulink" href="https://bayat.itch.io/platform-game-assets" target="_blank">https://bayat.itch.io/platform-game-assets</a>
and the item sprite sheets were obtained from <a class="ulink" href="https://opengameart.org/content/shining-coin-shining-health-shining-power-up-sprite-sheets" target="_blank">https://opengameart.org/content/shining-coin-shining-health-shining-power-up-sprite-sheets</a>.</p></div><p>This example has a lot going on with it. It's not particularly complicated to build out, but providing the steps to build it entirely from scratch <span>would</span><a id="id325636734" class="indexterm"></a> require too many steps. I don't have the page count to do all of that; at this point in the text, you can hopefully look at a scene already built out and understand how it was achieved. Therefore, we will start this example with a package file that has all the items placed in the scene, some of the animations <span>already</span><a id="id325636743" class="indexterm"></a> created, and all of the new sprite sheets included.</p><p>Before you begin, import the <code class="literal">Chapter 8 Example 2-Starting.unitypackage</code> asset package.</p><p>If you'd like to view the completed example, view the package labeled <code class="literal">Chapter 8 Example 2-Completed.unitypackage</code>—a video demonstrating the completed example is provided as well.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note91"></a>Note</h3><p>Note that Unity Layers do not save in Unity asset packages. The example will describe creating a Layer named UI Particles and having the cameras ignore or include the layer, but this does not get displayed in the provided package.</p></div><p>To make the example easier to absorb, I have broken the steps into three distinct sections. To complete this example, we will perform the following functions:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Set up the various animations for the individual items</li><li>Create the particle system that displays when the chest opens and make sure that it displays properly within the UI</li><li>Tie all of the animations together and make sur<span>e that their time approp</span>riately using a state machine</li></ol></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch08lvl3sec72"></a>Setting up the animations</h4></div></div></div><p>Let's start this section by creating the animations for <span>each</span><a id="id325636830" class="indexterm"></a> of the objects within the scene. To create all the animations for this scene, complete the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>If you have not done so already, import the <code class="literal">Chapter 8 Example 2-Starting.unitypackage</code> package. You should see a scene that has two Canvases--one with a button and a background image and another with a chest, items, and a button, as shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787125520/graphics/7a85ba66-46c3-47ce-8437-3171383257af.png" /></div><p>In the preceding screenshot, you will also note that there are a few animation clips and controllers provided in the asset folder.</p><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>The <code class="literal">Chest</code> object needs two animations, flying in from the side of the screen and one of its sprite sheet opening. Let's make the flying in animation first. Select the <code class="literal">Chest</code> object in the Hierarchy and then select <strong class="userinput"><code>Create</code></strong> in the Animation window to create a new Animation Clip. Name the new Animation Clip <code class="literal">ChestFlyingIn.anim</code> and save it in the <code class="literal">Assets/Animations/Clips</code> folder.</li><li>A new Animation Controller named <code class="literal">Chest.controller</code> was automatically created. Move it to the <code class="literal">Assets/Animations/Controllers</code> folder.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Select <strong class="userinput"><code>Add Property</code></strong> and expand <strong class="userinput"><code>Rect Transform</code></strong>. Click on the plus sign next to <strong class="userinput"><code>Anchored Position</code></strong>. This will allow us to animation the position of the <code class="literal">Chest</code> position within the Canvas:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787125520/graphics/fb48f3f5-1878-46c5-a1b3-71991f0cb9b1.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Currently, the animation is 1 second long, which is a bit longer than we want. Move the second keyframe to the 0:30 mark so that it will be half a second long.</li><li>The position of the chest in the scene right now is where we want it to be at the end of the fly-in animation, so we will not <span>affect</span><a id="id325636969" class="indexterm"></a> the position at the second keyframe. However, we want it to start off screen, so with the animation playhead on the first frame, use the <strong class="userinput"><code><span>Mov</span>e</code></strong> tool to move the chest outside of the Canvas area. Since r<span>ecord</span> is automatically selected, this will update the Chest's position at the first frame:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787125520/graphics/b2315ecc-cb17-4554-96d4-b9c413fb6074.png" /></div><p>If you scrub the playhead, you will see the chest move from left to right.</p><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>Now, let's make the chest fly in at an arc instead of the straight line. We'll do this with Animation Curves. Select the <strong class="userinput"><code>Curves</code></strong> tab, as follows:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787125520/graphics/aa9f8378-c479-4236-a887-48ae84574e3e.png" /></div><p>The green line represents the y property of the anchored position. Select the <strong class="userinput"><code>Anchored Postion.y</code></strong> property to focus on it.</p><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>Select the first and second key frame anchors to affect their handles. Move their handles until the green curve looks more like an arc:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787125520/graphics/42d043ec-828a-46c0-85e2-0b20d155077b.png" /></div><p>Now, when you play the animation, you will see the chest move in an arcing path.</p><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Let's have the chest fade in as it <span>flies</span><a id="id325637126" class="indexterm"></a> by adding a color property to the animation. Select <strong class="userinput"><code>Add Property</code></strong>, then expand <strong class="userinput"><code>Image</code></strong>. Click on the plus sign next to <strong class="userinput"><code>Color</code></strong>. On the first frame, change the <strong class="userinput"><code>Color.a</code></strong> property to <code class="literal">0</code> to make the chest invisible on the first frame:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/eecb3042-eae5-44c5-aee3-e989315ad002.png" /></div></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>Whenever a new animation is created, it is automatically set to loop. We don't want this animation to play on a loop, so select the <code class="literal">ChestFlyingIn</code> Animation Clip from the Project view to see its Inspector properties. Deselect the <strong class="userinput"><code>Loop Time</code></strong> checkbox.</li><li>We don't want the <code class="literal">ChestFlyingIn</code> Animation Clip to automatically play when the scene starts. Since this was the first Animation Clip created for <span>the</span><code class="literal">Chest</code>, it will be set to the Animator default state. With the <code class="literal">Chest</code> selected, open the <strong class="userinput"><code><span>Animator</span> Window</code></strong>.</li></ol></div><p>Create a new default state by right-clicking within the Animator Window and selecting <strong class="userinput"><code>Create State | Empty</code></strong>. Rename the new state <code class="literal">Empty State</code> and set it as the default state by right-clicking on it and selecting <strong class="userinput"><code>Set as Layer Default State</code></strong>. We will do more with the Chest's Animator later, but for now, this is all we are going to do.</p><div class="mediaobject"><img src="/graphics/9781787125520/graphics/f8b69f83-db10-4530-8649-2c52860f949b.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="12" type="1"><li>Now, let's set up the chest opening animation. With Chest still selected, in the Animation window, select <strong class="userinput"><code>Create New Clip…</code></strong> from the Animation Clip drop-down list:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/031ae8ac-7072-414f-9a1d-bb54775b59c6.png" /></div>
Name the new Animation Clip <code class="literal">ChestOpening.anim</code> and save it in the <code class="literal">Assets/Animations/Clips</code> folder.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="13" type="1"><li>This Animation Clip will contain all of the <span>sprites</span><a id="id325637360" class="indexterm"></a> from the sprite sheet. From the Project view, drag and drop all of the sub-sprites into the Animation timeline. A new property for <strong class="userinput"><code>Image.Sprite</code></strong> will automatically be added, and all of the sub-sprites will be added to the timeline in a sequence:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787125520/graphics/873ddb69-fb92-48f7-baae-8f87e54fd733.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="14" type="1"><li>Right now, the animation is way too fast. The animation is running at 60 frames per second, and there are only 6 frames. Change the animation's <strong class="userinput"><code>Samples</code></strong> value to <code class="literal">12</code>; this will change the animation's frame rate to 12 fps:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787125520/graphics/12ea1aad-867c-4a69-97ff-1478b1e89135.png" /></div><p></p><div class="orderedlist"><ol class="orderedlist arabic" start="15" type="1"><li>Since the <code class="literal">Chest</code> has an animation that will affect its alpha value, let's ensure that this animation has full alpha whenever it plays.  Select <strong class="userinput"><code>Add Property</code></strong>, then expand <strong class="userinput"><code>Image</code></strong>. Click on the plus sign next to <strong class="userinput"><code>Color</code></strong>. The first <span>frame</span><a id="id325637426" class="indexterm"></a> already has its alpha set to 1.  On the sixth frame, change the <strong class="userinput"><code>Color.a</code></strong> property to <code class="literal">1</code> by simply adding a keyframe to the last frame:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787125520/graphics/627d4b81-5bb6-4b4d-a0f6-19fc85594047.png" /></div><p>Technically, we only need the alpha set to 1 on the first frame, but I like to add a start and end frame here so that I am very sure about what the animation is doing with that value.</p><div class="orderedlist"><ol class="orderedlist arabic" start="16" type="1"><li>We don't want this animation to play on a loop, so select the <code class="literal">ChestOpening</code> Animation Clip from the Project view to take a look at its Inspector properties. Deselect the <strong class="userinput"><code>Loop Time</code></strong> checkbox.</li><li>All of the other animations needed for this example have been already set up. They are very similar to this one in set up or similar to the ones created in the preceding example. However, they are not hooked up to the correct GameObjects.
Let's give the other objects in t<span>he</span><code class="literal">Chest Open Canvas</code> their animations. Drag the <code class="literal">Coin</code> animator to the Inspector of the <code class="literal">Coin</code> Animator, the Heart Animator to the Inspector of the  <code class="literal">Hearts</code>, and the <code class="literal">PowerUp</code> Animator to the PowerUp's Inspector. You can now preview the animations of all the items popping out of the chests and shining.</li><li>Let's initialize the chest and all of the objects as invisible. Select the <code class="literal">Chest</code>, <code class="literal">Coin</code>, <code class="literal">Heart</code>, and <code class="literal">PowerUp</code> GameObjects from the Hierarchy. In their Image component, change their alpha values to <code class="literal">0</code>.</li><li>The <code class="literal">Chest Open Canvas</code> and the <code class="literal">Button</code> on that Canvas both have animations, as well. These animations will affect a Canvas Group component on the objects. Right now, they don't have Canvas Group components, though. So, add a Canvas Group component to <code class="literal">Chest Open Canvas</code> and its child <code class="literal">Button</code>.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="20" type="1"><li>Initialize the new Canvas Group components to have <strong class="userinput"><code>Alpha</code></strong> values of <code class="literal">0</code> and their <strong class="userinput"><code>Interactable</code></strong> and <strong class="userinput"><code>Blocks Raycasts</code></strong> properties set to <code class="literal">false</code>.</li><li>Now, add the <code class="literal">CanvasGroupFadeInOut</code> Animator to <code class="literal">Chest Open Canvas</code> and its child <code class="literal">Button</code>.</li></ol></div><p>The animations are now completely set up for each of the objects. We still need to finish working on the Animator Controller for the <code class="literal">Chest</code> and add some more logic for the various Animators, but we are done with the Animation Clips for now.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch08lvl3sec73"></a>Creating a Particle System that displays in the UI</h4></div></div></div><p>Now that we have the animations set up, we can <span>create</span><a id="id325637570" class="indexterm"></a> a particle system that will "pop" when the chest opens up. As stated in the text, my two preferred ways of displaying particles in front of UI are to either use <strong class="userinput"><code>Screen Space - Camera</code></strong> as the Canvas <strong class="userinput"><code>Render Mode</code></strong> or to use a Render Texture. Since the second option is more complicated, it merits an example. You'll notice that our Canvases all have their Render Modes set to <strong class="userinput"><code>Screen Space - Overlay,</code></strong> so using a Render Texture is the best method for the way the project is currently set up.</p><p>We will create a particle system that is rendered to a texture via a second camera and then have that texture displayed on a Raw Image within the UI.</p><p>To create a particle system that displays in the UI, complete the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>The first thing we will need to do is create a material that will be used for the particle. Create a new folder in the <code class="literal">Assets</code> folder named <code class="literal">Textures and Materials</code>. Now, right-click within the new folder and select <strong class="userinput"><code>Create | Material</code></strong>. Name the new material <code class="literal">StarsMaterial</code>.</li><li>Set the <code class="literal">StarsMaterial</code><strong class="userinput"><code>Shader</code></strong> to <strong class="userinput"><code>Unlit/Transparent</code></strong> and drag the star icon sprite into its texture slot.</li><li>To display the particles in front of the UI objects, we will need a second Camera. Duplicate the <code class="literal">Main Camera</code> using <span class="emphasis"><em>C</em></span><span class="emphasis"><em>trl</em></span> + <span class="emphasis"><em>D</em></span> and rename the duplicate <code class="literal">UI Particles Camera</code>.</li><li>You can only have one Audio Listener in the scene, so delete the Audio Listener component on the new camera.</li><li>You also won't want any code later to think this might possibly be the <code class="literal">Main Camera</code>, so change the tag from <code class="literal">MainCamera</code> to <strong class="userinput"><code>Untagged</code></strong>.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li><span>This camera</span> will be used only to display the particle pop we're going to make, so we might as well make the particle system a child of this camera by right-clicking on the <code class="literal">UI Particles Camera</code> and selecting <strong class="userinput"><code>Particle System</code></strong>.
Since this book isn't about Particle Systems, but about UI, we will not spend time going over every property of Particle Systems. Luckily, most are somewhat self-explanatory and fiddling with the various properties let you see what they can do. Therefore, rather than going through each property of the <code class="literal">Particle System</code>, I will simply provide screenshots of the necessary properties. When you apply the properties, I suggest adding the material in the <strong class="userinput"><code>Renderer</code></strong> properties first, so you get a better idea of what the <code class="literal">Particle System</code> will look <span>like:</span></li></ol></div><div class="mediaobject"><img src="/graphics/9781787125520/graphics/c1788f99-f926-44e3-8cb1-89731a75f369.png" /></div><div class="mediaobject"><img src="/graphics/9781787125520/graphics/0f64a138-5382-4849-9a44-2a0a6ce73b6f.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>It will be a lot easier to take a look at <span>whether</span><a id="id325336216" class="indexterm"></a> what we are about to do is working if we have the particle system constantly playing. Therefore, for now, re-select <strong class="userinput"><code>Looping</code></strong> and <strong class="userinput"><code>Play on Awake</code></strong> so that we can see the particle system constantly playing when the game is playing.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>We want to make sure that the <code class="literal">UI Particles Camera</code> displays only the <code class="literal">Particle System</code> and the <code class="literal">Main Camera</code> displays everything but the <code class="literal">Particle System</code>. That way, we will accomplish this with <strong class="userinput"><code>Layers</code></strong>. Select the <strong class="userinput"><code>Layers</code></strong> drop-down menu and select <strong class="userinput"><code>Add Layer…</code></strong> Add a new <strong class="userinput"><code>User Layer</code></strong> named <code class="literal">UI Particles</code>. Now, assign <code class="literal">UI Particles</code> to the <strong class="userinput"><code>Layer</code></strong> property of <code class="literal">Particle System</code>.</li><li>Now, tell each of the cameras what they will be displaying using their <strong class="userinput"><code>Culling Mask</code></strong> property. Set the <strong class="userinput"><code>Culling Mask</code></strong> property of the <code class="literal">UI Particles Camera</code> to only display <strong class="userinput"><code>UI Particles</code></strong> and the <strong class="userinput"><code>Culling Mask</code></strong> property of the <code class="literal">Main Camera</code> to exclude <strong class="userinput"><code>UI Particles</code></strong>.</li><li>Now, let's have the <code class="literal">UI Particles Camera</code> render to a texture. Within the <code class="literal">Textures and Materials</code> folder, right-click and select <strong class="userinput"><code>Create | Render Texture</code></strong>, and name it <code class="literal">StarPopRenderTexture</code>. Change its <strong class="userinput"><code>Size</code></strong> to <code class="literal">512</code> x <code class="literal">512</code>.</li><li>Assign the <code class="literal">StarPopRenderTexture</code> to the <strong class="userinput"><code>Target Texture</code></strong> property of the <code class="literal">UI Particles Camera</code>'s Camera component.</li><li>The only thing left to do is have the render texture display in the UI. Create a new UI Canvas with <strong class="userinput"><code>Create | UI | Canvas</code></strong>. Rename the Canvas to <code class="literal">Particle Canvas</code>.</li><li>With the <code class="literal">Particle Canvas</code> selected, select <strong class="userinput"><code>Create | UI | Raw Image</code></strong>. Rename it <code class="literal">Particle Renderer</code>.</li><li>Change <span>the</span><strong class="userinput"><code>Width</code></strong> and <strong class="userinput"><code>Height</code></strong> of the <code class="literal">Particle Renderer</code> to <code class="literal">512</code> and <code class="literal">512</code> , respectively, to match the properties of <code class="literal">StarPopRenderTexture</code>.</li><li>Assign <code class="literal">StarPopRenderTexture</code> to the <strong class="userinput"><code>Texture</code></strong> property of the Raw Image component of the <strong class="userinput"><code>Particle Renderer</code></strong>.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="16" type="1"><li>We don't want this image to block our mouse clicks, so deselect <strong class="userinput"><code>Raycast Target</code></strong> from the Raw Image component.</li><li>Now, we just need to make sure that the <code class="literal">Particle Canvas</code> displays in front of the other two Canvases. Set the <strong class="userinput"><code>Canvas Sort Order</code></strong> to <code class="literal">2</code> on the <code class="literal">Particle Canvas</code>' Canvas component.</li><li>Play the game now, and you should now see the particles displaying the the scene.</li><li>We set the Particle System to be constantly playing, so deselect <strong class="userinput"><code>Looping</code></strong> and <strong class="userinput"><code>Play on Awake</code></strong> to reset the values to what they should be.</li></ol></div><p>Now that the particle system is set to display in front of the UI, we can set up the logic to have the animation trigger in the correct order.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch08lvl3sec74"></a>Building a State Machine and timing the animations</h4></div></div></div><p>The last thing to do is set up the <span>state</span><a id="id325336478" class="indexterm"></a> machine <span>and</span><a id="id325336487" class="indexterm"></a> write the code that will make the various animations play.</p><p>To hook up the various animations and have them play at the correct time, complete the following <span>steps</span>:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>We'll start by creating the state machine that will work as the logic for our animation sequences. Create a new Animator Controller named <code class="literal">ChestOpeningStateMachine.controller</code> in <code class="literal">Assets/Animations/Controllers</code>.</li><li>Open the <code class="literal">ChestOpeningStateMachine</code> Animator Controller and create 12 new empty states. Arrange, name, and transition the states, as shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787125520/graphics/8f543383-7446-4efd-b89a-7fd964fc838d.png" /></div><p>The state machine shown in the preceding screenshot demonstrates the sequence of events for the animations and interactions of the chest opening. The states labeled with <strong class="userinput"><code>Waiting On Player</code></strong> will "play" when the game is waiting for the player to press a button to proceed the animation. The other animations will automatically play based on timed events. </p><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li><span>The</span> state machine created in the previous steps will not actually contain any animations. It is simply a flow chart describing what is currently happening in the game. We will also use it to send information to the various objects in the scene to let them know what they should or should not be doing. Since we just want this to control the logic of this sequence, and not actually animate anything in the scene, we can add it on an Animator component to any object in the scene. Therefore, let's add it to the "ubiquitous" <code class="literal">Main Camera</code>. Drag the <code class="literal">ChestOpeningStateMachine</code> Animator from the project view to the Inspector of the <code class="literal">Main Camera</code>.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Now, we will need to set the conditions of transition for the various states within the state machine. Create four animation Trigger Parameters named <code class="literal">ShowChest</code>, <code class="literal">OpenChest</code>, <code class="literal">CloseChest</code>, and <code class="literal">AnimationComplete</code>.</li><li>Now, set Trigger Conditions for each transition, as shown with the following screenshot; with each transition, make sure that you deselect <strong class="userinput"><code>Has Exit Time</code></strong> and <strong class="userinput"><code>Fixed Duration</code></strong>:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/bb029e8e-254e-4fda-b03e-9582002a3242.png" /></div></li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip92"></a>Note</h3><p>I highly recommend that you bookmark this image or print out a screenshot of your <code class="literal">ChestOpeningStateMachine</code> Animator while working through this example. Having this as a flow chart that you can easily reference while working this example will make the steps being completed a lot easier to follow. </p></div><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Before we proceed to write code, let's set up the Animator for the <code class="literal">Chest</code>. Currently, the Animator of the <code class="literal">Chest</code> should look something as follows:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/46c32556-c127-4fbe-857b-ced65b13bd04.png" /></div>
The Animator only contains the animation states, but does not yet indicate how they are all connected. We will need to create transitions and set up the Animation Parameters. Rearrange the states and add transitions to the Animator so it appears as follows:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/40fd2ee9-2933-4147-bd4c-c0d1f7d48666.png" /></div></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>Create three animation Trigger Parameters named <code class="literal">ShowChest</code>, <code class="literal">OpenChest</code>, and <code class="literal">Reset</code>.</li><li>Now, set Trigger Conditions for <span>each</span><a id="id325336730" class="indexterm"></a> transition, as shown with the following screenshot; with each transition, make sure <span>that</span><a id="id325336739" class="indexterm"></a> you deselect <strong class="userinput"><code>Has Exit Time</code></strong> and <strong class="userinput"><code>Fixed Duration</code></strong>:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/915adbb9-8fe9-4247-82bd-2379f58f3998.png" /></div></li><li>Now that our Animators are all appropriately set, we can begin coding. We will use the <code class="literal">ChestOpeningStateMachine</code> Animator to make each appropriate animation play when the player clicks on the specified button during the specified state. The <code class="literal">ChestOpeningStateMachine</code> Animator will then automatically set the appropriate triggers on the Animators on the various objects that appear in the full animated sequence.
We need a way to keep track of which items in the scene have Animators that will be controlled by the <code class="literal">ChestOpeningStateMachine</code> Animator, what their various parameters are, and what conditions need to be met to have those parameters set. We'll keep track of all of this information on a single script. Create a new script called <code class="literal">ChestAnimControls</code> and save it in <code class="literal">Assets/Scripts</code>.</li><li>To give us a nice clean way of keeping track of all of the necessary information, we'll use classes and an enumerated list (I'll explain what these are and why we are using them momentarily). Delete the <code class="literal">Start()</code> and <code class="literal">Update()</code> functions from the <code class="literal">ChestAnimControls</code> class, and write the following code:</li></ol></div><pre class="programlisting">//the different types of parameters
public enum TypesOfParameters{floatParam, intParam, boolParam, triggerParam};

//properties of animation parameters
[System.Serializable]
public class ParameterProperties{
    public string parameterString; //what string sets it?
    public string whichState; //name of the state its called from, null=not called by the state machine
    public TypesOfParameters parameterType; //what type of Animator Parameter is it?
    public float floatValue; //float value required, if float
    public int intValue; //int value required, if int
    public bool boolValue; //bool value required, if bool
}
//make a list of all animatable objects and their parameters
[System.Serializable]
public class AnimatorProperties{
    public string name; //so the name will appear in the inspector rather than "Element 0, Element 1, etc"
    public Animator theAnimator; //the animator
    public List&lt;ParameterProperties&gt; animatorParameters; //its parameter properties
} </pre><p>You'll note that the preceding code is in the following three parts: the enumerated list <code class="literal">TypesOfParameters</code>, the class <code class="literal">ParameterProperties</code>, and the class <code class="literal">AnimatorProperties</code>.
First, let's look at the enumerated list <code class="literal">TypesOfParameters</code>. This is a list of the types of Animator Parameters that can be used within an Animator. <span>An enumerated list</span> is a custom type that contains a set of constants that are represented with names. A benefit of using an enumerated list is that the list appears as a drop-down menu within the Inspector.
Now, let's look at the <code class="literal">ParameterProperties</code> class. Each object that is animated within the scene has a set of properties related to its Animator Parameters that we need to keep track of. A class can be an effective tool for grouping sets of data together. Therefore, I used a class to group together the name of the parameter, which state the parameter will be set in, what type of parameter it is, its value if it is a float, integer, or Boolean parameter. Note that the type of parameter is defined using the enumerated list, <code class="literal">TypesOfParameters</code>. This was done because there are a finite and specific set of parameters available for each animator parameter.
Now, let's look at the <code class="literal">AnimatorProperties</code> class. For each object in the scene, we will need to keep track of its name, its animator, and all of its parameters along with the conditions in which they are set. Note that the list of parameters and their properties is defined by the <code class="literal">ParameterProperties</code> class.
A big benefit of working with Unity is the ability to assign and view public variables in the inspector. However, when you create a class within a class, the public variables are not visible within the inspector unless you place <code class="literal">[System.Serializable]</code> above the class. This gives the subclass the serializable attribute and allows its public variables to be visible in the Inspector.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note93"></a>Note</h3><p>I would like to point out that this code allows for the Animators to have Float, Int, and Bool parameters, even though the only parameters we use in any of our Animators are Triggers. I wrote it in this way to make it work more universally so that you can reuse this code for other animations in the future.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="11" type="1"><li>If the code we wrote in the preceding <span>step</span><a id="id325336850" class="indexterm"></a> is overwhelming you, don't worry—seeing it all listed out in the Inspector will clear it up a bit. All we've done so far is set up a few different groups of data. Now, we will need to actually create a variable that will use the information. We need a <span>list</span><a id="id325336858" class="indexterm"></a> of all animated items, so add the following code to your script:</li></ol></div><pre class="programlisting">public List&lt;AnimatorProperties&gt; animatedItems; //all the animated items controlled by this state machine</pre><div class="orderedlist"><ol class="orderedlist arabic" start="12" type="1"><li>Attach the <code class="literal">ChestAnimControls</code> script to the <code class="literal">Main Camera</code> by dragging it into its Inspector.</li><li>In Inspector of the <code class="literal">Main Camera</code>, click on the arrow next to <strong class="userinput"><code>Animated Items</code></strong> to expand the list:</li></ol></div><div class="mediaobject"><img src="/graphics/9781787125520/graphics/7fab28f5-0fc5-4339-be1f-ee5dfbf70b61.png" /></div><p>We have a total of six items that need to have their Animators controlled by this script and the State Machine we created. So, change <strong class="userinput"><code>Size</code></strong> to <code class="literal">6</code>. E<span>xpa</span>nd<strong class="userinput"><code> </code></strong><strong class="userinput"><code>Animator Parameters</code></strong> of <strong class="userinput"><code>Element 0</code></strong> and <strong class="userinput"><code>Element 0:</code></strong></p><div class="mediaobject"><img src="/graphics/9781787125520/graphics/772f5447-8d23-44a4-9ecf-4b12be840321.png" /></div><p>Remember that the <code class="literal">animatedItems</code>variable was a list of <code class="literal">AnimatorProperties</code>. So, <strong class="userinput"><code>Element 0</code></strong> (and all the other <strong class="userinput"><code>Elements</code></strong> for that matter) contains all of the items that were grouped in the <code class="literal">AnimatorProperties</code> class.</p><div class="orderedlist"><ol class="orderedlist arabic" start="14" type="1"><li>The first item we will need to list data for is the <code class="literal">Chest Open Canvas</code> GameObject. Type <strong class="userinput"><code>Chest Open Canvas</code></strong> in the <strong class="userinput"><code>Name</code></strong> slot and drag the <code class="literal">Chest Open Canvas</code> from the Hierarchy in to the <strong class="userinput"><code>The Animator</code></strong> slot.
Once you type <strong class="userinput"><code>Chest Open Canvas</code></strong> in the <strong class="userinput"><code>Name</code></strong> slot, you'll see that the label <strong class="userinput"><code>Element 0</code></strong> is replaced with <strong class="userinput"><code>Chest Open Canvas</code></strong>. Whenever you have a list of objects in Unity's inspector, if the first item in the object is a string, the string will replace the <strong class="userinput"><code>Element x</code></strong> label:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/19b1617e-5918-418e-93d6-98b11b31c42e.png" /></div></li><li>Now, we will need to list out all of the parameters that are used with in the <code class="literal">Chest Open Canvas</code>'s Animator and the conditions in which it is set. It has two parameters that we need to list data for, so change the <strong class="userinput"><code>Size</code></strong> of <strong class="userinput"><code>Animator Parameters</code></strong> to <code class="literal">2</code>. Expand the two resulting <strong class="userinput"><code>Elements</code></strong>, as follows: </li></ol></div><div class="mediaobject"><img src="/graphics/9781787125520/graphics/92f4ebed-7053-4301-8f39-01c208f495a4.png" /></div><p>Remember that the <code class="literal">animatorParameters</code> variable was a list of <code class="literal">ParameterProperties</code>. So, the two <strong class="userinput"><code>Elements</code></strong> contain all of the items that were grouped in the <code class="literal">ParameterProperties</code> class. Additionally, within the <code class="literal">ParameterProperties</code> class, the <code class="literal">parameterType</code> was a <code class="literal">TypesOfParameters</code> variable. <code class="literal">TypesOfParameters</code> was an enumerated list, so any variable of that type will appear as a drop-down menu with the options that appeared within the defined list. </p><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="16" type="1"><li>We now need to <span>list</span><a id="id325337143" class="indexterm"></a> out each parameter of the <code class="literal">Chest Open Canvas</code>, which state in the <code class="literal">ChestOpeningStateMachine</code> will cause <span>the</span><a id="id325337158" class="indexterm"></a> parameter to be set, and specify its parameter type:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/90d861fd-7760-4d68-af3a-18dcb9f50abb.png" /></div>
Since each is a Trigger Animator Parameter, we do not have to worry about the values for <strong class="userinput"><code>Float Value</code></strong>, <strong class="userinput"><code>Int Value</code></strong>, or <strong class="userinput"><code>Bool Value</code></strong>.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="17" type="1"><li>Now, we can fill in the Animator information for the other five animated objects in the same way we filled out the information for the <code class="literal">Chest Open Canvas</code>. Fill in the information for the animator of <code class="literal">Chest</code>, as follows:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/2ac08f90-040d-4caf-8a1f-cc5c486db522.png" /></div></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="18" type="1"><li>Fill in the information <span>for</span><a id="id325337219" class="indexterm"></a> the Animator of<code class="literal"><span>Coin</span></code>, as follows:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/d969f7ee-ff4d-4839-aa40-fa7ab44120d0.png" /></div></li><li>Fill in the information <span>for</span><a id="id325337245" class="indexterm"></a>  the Animator of<code class="literal">Heart</code>, as follows:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/25a2c28f-e1dd-4915-90ce-51a7963f6a4e.png" /></div></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="20" type="1"><li>Fill in <span>the</span><a id="id325337378" class="indexterm"></a> information <span>for</span><a id="id325337386" class="indexterm"></a> the Animator of<code class="literal">PowerUp</code>, as follows:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/b71a176c-5084-4c2c-8d03-20539a1b34a4.png" /></div></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="21" type="1"><li>Fill in <span>the</span><a id="id325337415" class="indexterm"></a> information for <span>the</span><a id="id325337424" class="indexterm"></a> Animator of<code class="literal">Button</code>, as follows:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/289e1162-2cb2-4560-9a7a-d9909894af7c.png" /></div></li><li>Now that we have all the appropriate data values for the State Machine initialized and defined, let's actually have the State Machine perform its appropriate logic. First, we will need to create a variable for the Animator. Add the following variable initialization to your script:</li></ol></div><pre class="programlisting">Animator theStateMachine; //the state machine animator component</pre><div class="orderedlist"><ol class="orderedlist arabic" start="23" type="1"><li>Now, initialize the State Machine's Animator in an <code class="literal">Awake()</code> function:</li></ol></div><pre class="programlisting">void Awake(){
    theStateMachine=GetComponent&lt;Animator&gt;(); //get the state machine
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="24" type="1"><li>To have the State Machine automatically set the various parameters of the individual Animators at the appropriate state, we will need to loop through all of the animated items we have listed and each of their listed parameters. If the animated item has a parameter, which is to be set at the current state of the State Machine, we will set it based on the conditions listed. Create the following function to perform that functionality:</li></ol></div><pre class="programlisting">//check if any of the animations need their parameters set
//called from enter state
public void CheckForParameterSet(){
    //loop through all of the objects
    foreach (AnimatorProperties animatorProp in animatedItems){
        //loop through its set of parameters
<span>foreach(ParameterProperties parameter in 
        animatorProp.animatorParameters){
            //find the ones called on the current state       
            if(theStateMachine.GetCurrentAnimatorStateInfo(0)
            .IsName(parameter.whichState)){
                //determine parameter type
                //float types
                if(parameter.parameterType==
                TypesOfParameters.floatParam){
                    animatorProp.theAnimator.
                   SetFloat(parameter.parameterString, 
                   parameter.floatValue);
                //int types
                }else if(parameter.parameterType==
                TypesOfParameters.intParam){
                  animatorProp.theAnimator.
                  SetInteger(parameter.parameterString,
                  parameter.intValue);
                //bool type
                }else if(parameter.parameterType==
                TypesOfParameters.boolParam){
                    animatorProp.theAnimator.
                    SetBool(parameter.parameterString, 
                    parameter.boolValue);

                //trigger type
                }else{
                    animatorProp.theAnimator.
                    SetTrigger(parameter.parameterString);</span>
                }
            }
        }
    }
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="25" type="1"><li>The <code class="literal">CheckForParameterSet</code>function will determine whether a specified Animator needs a parameter set at the current state of the State Machine. However, this function is not currently called anywhere. We want this function to be called whenever a state in the State machine starts. We can accomplish this with a State Machine Behaviour. Open the <code class="literal">ChestOpeningStateMachine</code> Animator and select the <strong class="userinput"><code>Canvas Fading I</code></strong><strong class="userinput"><code>n</code></strong> state. In the state's <strong class="userinput"><code>Inspector</code></strong>, click on the <strong class="userinput"><code>Add Behaviour</code></strong> button. Select <strong class="userinput"><code>New Script</code></strong>, enter <code class="literal">ChestStateMachineBehaviour</code>, and click on the <strong class="userinput"><code>Create and Add</code></strong> button. A new script named <code class="literal">ChestStateMachineBehaviour</code> will be added to the <code class="literal">Assets</code> folder. Move it to the <code class="literal">Assets/Scripts</code> folder and open it.</li><li>A lot of stuff is included within this State Machine Behaviour. We only need the <code class="literal">OnStateEnter</code> function. Adjust the code within the <code class="literal">ChestStateMachineBehaviour</code> class to include the following to call the <code class="literal">CheckForParameterSet</code> function on the <code class="literal">ChestAnimControls</code> script when it starts:</li></ol></div><pre class="programlisting">ChestAnimControls theControllerScript;

public void Awake(){
    //get the script that holds the state machine logic
    theControllerScript=FindObjectOfType&lt;ChestAnimControls&gt;();
}

// OnStateEnter is called when a transition starts and the state machine starts to evaluate this state
override public void OnStateEnter(Animator animator, AnimatorStateInfo stateInfo, int layerIndex){
    theControllerScript.CheckForParameterSet();
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="27" type="1"><li>We will need this script to on every state that does not say <strong class="userinput"><code>Waiting On Player</code></strong>. Add the <code class="literal">ChestStateMachineBehaviour</code> to each of the states in the right-hand column (the ones that do not say <strong class="userinput"><code>Waiting On Player</code></strong>) by clicking on the <strong class="userinput"><code>Add Behaviour</code></strong> button and selecting <code class="literal">ChestStateMachineBehaviour</code> in their Inspector.
The State Machine will now appropriately call each of the individual item's animations when the appropriate states are entered, but we don't have anything that actually controls the flow of the state machine. Right now, it's going to just stay in the <strong class="userinput"><code>Waiting on Player (Show Chest)</code></strong> state. We will need to write up some logic to control the flow within the State Machine. Remember that each of the states that say <strong class="userinput"><code>Waiting on Player</code></strong> are going to wait on the player to perform some interaction with the game before proceeding to the next state. So, let's start our State Machine logic by making a script that can be used by the buttons when the player clicks on them. Let's start with the button that is on the <code class="literal">Button Canvas</code> that says <strong class="userinput"><code>Start</code></strong>.
Add the following function to your script:.</li></ol></div><pre class="programlisting">public void PlayerInputTrigger(string triggerString){
    theStateMachine.SetTrigger(triggerString);
} </pre><p>This function will trigger State Machine's trigger parameter specified by the string sent as an argument.</p><div class="orderedlist"><ol class="orderedlist arabic" start="28" type="1"><li>We will need to call that function from the <strong class="userinput"><code>Start</code></strong> button, so add the following <strong class="userinput"><code>On Click ()</code></strong> Event to the <code class="literal">Button</code> on the <code class="literal">Button Canvas</code>:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/9b94f66f-a5f8-4e47-82cb-00d8f6ea666e.png" /></div></li><li>Now, we will need to create some logic that will have the <code class="literal">Button</code> on the <code class="literal">Chest Open Canvas</code> transition from the other two <strong class="userinput"><code>Waiting On Player</code></strong> states. Create a new script called <code class="literal">OpenCloseButton</code> in the <code class="literal">Assets/Scripts</code> folder.</li><li>Add the <code class="literal">UnityEngine.UI</code> namespace to the <code class="literal">OpenCloseButton</code> script with:</li></ol></div><pre class="programlisting"> using UnityEngine.UI;</pre><div class="orderedlist"><ol class="orderedlist arabic" start="31" type="1"><li>Now, add the following code to the <code class="literal">OpenCloseButton</code> script: </li></ol></div><pre class="programlisting">Text buttonText;
Animator chestAnimController;

void Awake(){
    buttonText=transform.GetComponentInChildren&lt;Text&gt;();
    chestAnimController=Camera.main.GetComponent&lt;Animator&gt;();
}

public void OpenOrClose(){
    Debug.Log("click");
    if(buttonText.text=="Open"){
        chestAnimController.SetTrigger("OpenChest");
        SetText("Close");
    }else{
        chestAnimController.SetTrigger("CloseChest");
        SetText("Open");
    }
}
public void SetText(string setTextTo){
    buttonText.text=setTextTo;
}</pre><p>The <code class="literal">OpenOrClose()</code> function will be called by the button's <strong class="userinput"><code>On Click ()</code></strong> Event. The <code class="literal">Button</code> on the <code class="literal">Chest Open Canvas</code> will be used to open and close the chest. It will set the appropriate trigger based on the current text written on the button and will change its text to "Open" or "Close" with the <code class="literal">SetText()</code> function.</p><div class="orderedlist"><ol class="orderedlist arabic" start="32" type="1"><li>Add the <code class="literal">OpenCloseButton</code> script as a component to the <code class="literal">Button</code> on the <code class="literal">Chest Open Canvas</code>.</li><li>Now, add the following <strong class="userinput"><code>On Click ()</code></strong> Event to the Button on the <code class="literal">Chest Open Canvas</code>:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/7578f453-403e-4504-82ab-f3594569d5bd.png" /></div></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="34" type="1"><li>If you play the game now and click on the <strong class="userinput"><code>Start</code></strong> button, all that happens is that the Canvas fades in. This is because we still haven't done anything to set the <code class="literal">AnimationComplete</code> trigger in the <code class="literal">ChestOpeningStateMachine</code> Animator. We will need another script to set this trigger. Create a new script called <code class="literal">AnimationControls</code> in the <code class="literal">Assets/Scripts</code> folder.</li><li>Adjust the code within the <code class="literal">AnimationControls</code> class, as follows:</li></ol></div><pre class="programlisting">Animator chestAnimController;

void Awake(){
  chestAnimController=Camera.main.GetComponent&lt;Animator&gt;();
}

//call as an animation event on last frame of animations
public void ProceedStateMachine(){
  chestAnimController.SetTrigger("AnimationComplete");
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="36" type="1"><li>The preceding code simply sets the <code class="literal">AnimationComplete</code>trigger with the <code class="literal">ProceedStateMachine()</code> function.</li><li>This trigger is used to allow each of the individual animations to play fully before the next state is started. To make sure that the animation trigger isn't set until the entire animation has played, we'll use Animation Events to call the <code class="literal">ProceedStateMachine()</code>function at the appropriate time within the necessary animations.
When you use an Animation Event, the function you want to call must be on a script attached to the same object as the animation. We want the function to be called at the end of animations on the <code class="literal">Chest Open Canvas</code>, the <code class="literal">Chest</code>, the <code class="literal">Coin</code>, the <code class="literal">Heart</code>, the <code class="literal">PowerUp</code>, and the <code class="literal">Button</code> on the <code class="literal">Chest Open Canvas</code>. Therefore, add the <code class="literal">AnimationControls</code> script as a component to each of them.</li><li>Now, we will need to add the <code class="literal">ProceedStateMachine()</code> function as an Animation Event to the various animations. Select the <code class="literal">Chest Open Canvas</code> and view its <code class="literal">CanvasGroupFadeIn</code> animation. On its last animation frame, right-click on the top dark gray area of the timeline and select <code class="literal">Add Animation Event</code>. In the Inspector, select <strong class="userinput"><code>ProceedStateMachine()</code></strong> from the drop-down menu. It will be the very last function in the list. You should now have a white flag above the last keyframe that says <strong class="userinput"><code>ProceedStateMachine</code></strong> when you hover over it:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/089e981d-b879-46ea-aa3d-893c1afe7fca.png" /></div></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="39" type="1"><li>If you play the game now and click on the <strong class="userinput"><code>Start</code></strong> button, the Canvas will fade in and the chest will fly in. The State Machine <span>will</span><a id="id325337924" class="indexterm"></a> stay on the "Chest Flying In Animation". To have the animation <span>sequence</span><a id="id325337932" class="indexterm"></a> finish out, add the <code class="literal">ProceedStateMachine()</code> function as an Animation Event to each of the following animations at the following locations:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/bd15116a-e0b3-4c3c-bb06-200f27435611.png" /></div></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="40" type="1"><li>Playing the game now almost works the way it should. There's a bit of an issue with the timing on the items popping out of the chest when you replay the animation sequence. Currently, there is a bit of a problem with the <code class="literal">AnimationComplete</code> trigger. We need that trigger to definitely be unset whenever any of the <strong class="userinput"><code>Waiting On Player</code></strong> states start. Otherwise, it will be set to true when the State Machine restarts, causing some timing issues. To fix this, we need one more State Machine Behaviour. Select the <strong class="userinput"><code>Waiting on Player (Show Chest)</code></strong> state and <strong class="userinput"><code>Create and Add</code></strong> a new State Machine Behaviour called <code class="literal">ResetTriggers</code> in its Inspector. Remember that whenever you create a new State Machine Behaviour, it is added to the <code class="literal">Asset</code> folder, so move it to the <code class="literal">Asset/Scripts</code> folder.</li><li>We want the Trigger Parameter <code class="literal">AnimationComplete</code> to reset whenever a <strong class="userinput"><code>Waiting On Player</code></strong> states start, so change the code in the <code class="literal">ResetTriggers</code> class, as follows:</li></ol></div><pre class="programlisting">// OnStateEnter is called when a transition starts and the state machine starts to evaluate this state
override public void OnStateEnter(Animator animator, AnimatorStateInfo stateInfo, int layerIndex){
    animator.ResetTrigger("AnimationComplete");
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="42" type="1"><li>Now, add the <code class="literal">ResetTriggers</code> State Machine Behaviour to all three of the <strong class="userinput"><code>Waiting on Player</code></strong> states. Playing the game now should have the animation sequence firing correctly, with everything but the particle system. We want the particle system to play when the chest opens. Create a new script called <code class="literal">PlayParticles</code> in the <code class="literal">Assets/Scripts</code> folder.</li><li>Edit the <code class="literal">PlayParticles</code> class to have the following code:</li></ol></div><pre class="programlisting">public ParticleSystem stars;

void PlayTheParticles(){
    if(!stars.isPlaying){
        stars.Play();
    }
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="44" type="1"><li>All this code does is check whether the particle system is currently playing with the function <code class="literal">PlayTheParticles()</code>. If it is not playing, it plays when the function runs.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="45" type="1"><li>We'll have this function triggered via an Animation Event on the <code class="literal">Chest</code>. So, add the script to the <code class="literal">Chest</code> as a <span>component</span><a id="id325338124" class="indexterm"></a> and assign the <code class="literal">Particle System</code> from the Hierarchy to the <strong class="userinput"><code>Stars</code></strong> slot.</li><li>Add the <code class="literal">PlayTheParticles</code> function as an Animation Event on <span>the</span><a id="id325338145" class="indexterm"></a> very first frame of the <code class="literal">ChestOpening</code> Animation:
<div class="mediaobject"><img src="/graphics/9781787125520/graphics/989984b9-ff4f-4020-bd50-753371b9a3c3.png" /></div></li></ol></div><p>Playing the game now should result in all animations playing at the appropriate times and the particle system displaying when the chest opens. Wow! That was a doozy of an example to write up.</p></div></div></div>