<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec41"></a>Configuring a character in Unity</h2></div></div><hr /></div><p>We will continue<a id="id274" class="indexterm"></a> working with the character that was imported with <a id="id275" class="indexterm"></a>embedded animations.</p><p>With the character imported, we go right to the <span class="strong"><strong>Rig</strong></span> tab of <span class="strong"><strong>Import Settings</strong></span> to explore the remaining two animation types: <span class="strong"><strong>Generic</strong></span> and <span class="strong"><strong>Humanoid</strong></span>. As mentioned in previous chapters, there are two animation types that are required in order to use Mecanim, a powerful animation control tool introduced in the 4th version of Unity. I can't stress enough, how awesome Mecanim is; this system allows you to significantly improve your development pipeline and reduce the amount of code to control animations, but more about that in the next chapter. Right now we need to figure out how to set up the model to be used by this system.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec61"></a>Generic and humanoid – what's the difference?</h3></div></div></div><p>This is exactly how it sounds—Generic can be used for everything, from a dragon to a toaster, whereas, Humanoid can only be used on the characters that have the humanoid bone topology.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec13"></a>Generic Animation Type</h4></div></div></div><p>Generic is the easier type and <a id="id276" class="indexterm"></a>you might end up using and relying on it most of the time especially when the humanoid doesn't work for you. So let's get the easier part out of the way and look at the following:</p><div class="mediaobject"><img src="/graphics/9781785282843/graphics/B04214_05_07.jpg" /></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="strong"><strong>Avatar Definition</strong></span>: <span class="strong"><strong>Generic Animation Type</strong></span> doesn't allow us to make full use of <span class="strong"><strong>Character Avatar</strong></span>, so leave it at the default; as <span class="strong"><strong>Create From This Model.</strong></span>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Root node</strong></span>: This is the node that contains animation translation; by selecting the node from the drop-down menu, you will enable the <span class="strong"><strong>Root Motion</strong></span> parameters in the <span class="strong"><strong>Animation</strong></span> tab. For now set <span class="strong"><strong>Root node</strong></span> to <span class="strong"><strong>Robot</strong></span> from the drop down menu.</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Optimize Game Objects</strong></span>: By default, Unity creates an empty GameObject for every transform in your character, checking this box allows us to prevent this from happening and increase the overall performance, since Unity doesn't have to deal with those extra transforms.</p></li></ul></div><p>Thankfully, you can <a id="id277" class="indexterm"></a>still create some of these transforms on demand if you need to reference them through the code. Select the transform from the hierarchy by clicking on the <span class="strong"><strong>+</strong></span> sign of the <span class="strong"><strong>Extra Transforms to Expose</strong></span> list which appears when you've selected the <span class="strong"><strong>Optimize Game Objects</strong></span> option.</p><div class="mediaobject"><img src="/graphics/9781785282843/graphics/B04214_05_08.jpg" /></div><p>Now let's move to the <span class="strong"><strong>Animation</strong></span> tab and look at how the <span class="strong"><strong>Clip</strong></span> options changed since we last used them for <span class="strong"><strong>Legacy Animation</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781785282843/graphics/B04214_05_09.jpg" /></div><p>As you can see, there is a <a id="id278" class="indexterm"></a>significant increase in the number of options, as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="strong"><strong>Loop Time</strong></span>: Checking this option will make our clip play through till the end and then restart from the beginning. This also enables the following options:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="strong"><strong>Loop Pose</strong></span>: This makes your animation loop seamlessly. However, this only works well if the starting pose matches the end pose; it will take the difference and will make a blend throughout the clips length to make them match.</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Cycle Offset</strong></span>: This is the offset to the cycle of a looping animation.</p></li></ul></div></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Root Transform Rotation</strong></span>, <span class="strong"><strong>Root Transform Position (Y)</strong></span>, and <span class="strong"><strong>Root Transform Position (XZ)</strong></span>: These serve a very similar purpose—they prevent the GameObject from being rotated or translated along the respected axis by the AnimationClip. In other words, if you don't want your GameObject to be moved by the animation, check <span class="strong"><strong>Bake Into Pose</strong></span> in the required category, to prevent it. They will only appear if you've specified the <span class="strong"><strong>Root Node</strong></span> in the <span class="strong"><strong>Rig</strong></span> tab.</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Based Upon</strong></span>: You can choose the GameObjects rotation or position to be based on the <span class="strong"><strong>Root Node</strong></span> specified in the <span class="strong"><strong>Rig</strong></span> tab, or the way you set it up on exporting, by choosing <span class="strong"><strong>Original</strong></span>.</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Offset</strong></span>: This allows you to add the offset to the rotation or translation of the GameObject if you chose <span class="strong"><strong>Root Transform Rotation</strong></span> or <span class="strong"><strong>Root Transform Position (Y)</strong></span> to be based on <span class="strong"><strong>Root Node</strong></span> (the <span class="strong"><strong>Original</strong></span> values will be taken from the model).</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Mask</strong></span>: This is very simple to understand and use. Let's say you need to remove a motion from the <span class="strong"><strong>Neck</strong></span> transform, and its children, in one of your animations. To do that you, need to go under the <span class="strong"><strong>transform</strong></span> menu, and uncheck the <span class="strong"><strong>Neck</strong></span> transform. If you run the animation now, you will notice that the <span class="strong"><strong>Neck</strong></span> transform, and its children, aren't moving. We will talk about the application of Masks in the next chapter.</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Definition</strong></span>: This allows you to choose to, either create the mask from this specific model, or copy it from another mask.</p></li></ul></div><p>To create a <a id="id279" class="indexterm"></a>custom avatar mask for our character, do the following:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Click on <span class="strong"><strong>Create</strong></span> from the drop down menu and select <span class="strong"><strong>Avatar Mask</strong></span>.</p></li><li><p>Go under the <span class="strong"><strong>Transform</strong></span> drop down menu of the <span class="strong"><strong>Avatar Mask</strong></span>.</p></li><li><p>Drag the <span class="strong"><strong>RobotAvatar</strong></span> generated by our character model (it can be found inside the imported <span class="strong"><strong>Robot</strong></span> model).</p></li><li><p>Click on the <span class="strong"><strong>Import skeleton</strong></span> button.</p></li></ol></div><p>This should load all the transforms from our character, into the mask, and allow us to configure them here, to be assigned to multiple objects with the same bone structure.</p><div class="mediaobject"><img src="/graphics/9781785282843/graphics/B04214_05_10.jpg" /></div><p>
<span class="strong"><strong>Events</strong></span> are improved and expanded from the Legacy Animation; now you can trigger any function on any GameObject just by filling in the blanks and specifying the frame on the timeline.</p><div class="mediaobject"><img src="/graphics/9781785282843/graphics/B04214_05_11.jpg" /></div><p>This covers the<a id="id280" class="indexterm"></a> <span class="strong"><strong>Animation</strong></span> tab for the <span class="strong"><strong>Generic Animation Type</strong></span>; we will omit talking about the <span class="strong"><strong>Curves</strong></span> and <span class="strong"><strong>Motion</strong></span> parameters as they aren't required for this example.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec14"></a>Humanoid Animation Type</h4></div></div></div><p>Imagine yourself in a<a id="id281" class="indexterm"></a> situation where you have multiple humanoid characters that require the same animation—sitting, walking, running, and so on; or there is a specific animation that you would like to reuse on multiple humanoids. Usually, you would be required to create each animation for every single character, taking into consideration their body proportions. With <span class="strong"><strong>Humanoid Animation Type</strong></span>, that is not the case, you can cut out a lot of steps in your usual animation pipeline by referencing animations using <span class="strong"><strong>CharacterAvatars</strong></span>, and tweak them to match and tailor to any character using a muscle<a id="id282" class="indexterm"></a> system. Let's take a look at how this is done.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec07"></a>Character avatar</h5></div></div></div><p>First things first, we <a id="id283" class="indexterm"></a>need to switch our <span class="strong"><strong>Animation Type</strong></span> of the imported <a id="id284" class="indexterm"></a>Robot from <span class="strong"><strong>Generic</strong></span> to <span class="strong"><strong>Humanoid</strong></span>, and hit <span class="strong"><strong>Apply</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781785282843/graphics/B04214_05_12.jpg" /></div><p>
<span class="strong"><strong>Avatar Definition</strong></span>, using the default <span class="strong"><strong>Create From This Model</strong></span> parameter, will generate a Robot Avatar for this model automatically, by trying to map the Robot's skeleton onto the humanoid topology. The key factors in successful mapping are hierarchy and naming (bone direction and ratio also contribute, however, not as significantly as those two). The algorithm will search for a bone called <span class="strong"><strong>Hip</strong></span>, check if it's a root bone, and which bones are attached to it. So make sure that you're using proper naming conventions to get the best out of this process.</p><p>If the process is successful you'll see a check mark next to the <span class="strong"><strong>Configure…</strong></span> button, but regardless, let's click on it and see what has actually happened.</p><p>Unity will open a new scene with our character in the center and ask you to save the current scene; it would be wise to do so.</p><div class="mediaobject"><img src="/graphics/9781785282843/graphics/B04214_05_13.jpg" /></div><p>Robot Avatar shows<a id="id285" class="indexterm"></a> us a humanoid body with bones <a id="id286" class="indexterm"></a>represented by lined (mandatory) and dotted (optional) circles. As you can see, all the mandatory bones were successfully matched, leaving a few optional bones unchecked.</p><p>We can check the rest of our bones by switching between body parts at the right bottom corner (<span class="strong"><strong>Body</strong></span>, <span class="strong"><strong>Head</strong></span>, <span class="strong"><strong>LeftHand</strong></span>, and <span class="strong"><strong>RightHand</strong></span>).</p><p>Here is where it gets interesting. Take a look at the <span class="strong"><strong>Scene</strong></span> window in our character model (hitting the <span class="strong"><strong>Configure…</strong></span> button takes us to a different scene with our character).</p><div class="mediaobject"><img src="/graphics/9781785282843/graphics/B04214_05_14.jpg" /></div><p>All the bones that were mapped on the avatar successfully, now appear green. Any additional bones that don't follow the Unity topology standards will be marked as grey. In order to map the skeleton on the template, Unity will exclude any additional bones and, as a result, it will not be <a id="id287" class="indexterm"></a>animated. A very common example <a id="id288" class="indexterm"></a>of this is, if you are using the three bone structure for the torso such as the lower back, spine, and chest, then the spine will be grayed out; however, unlike avatar mask, it doesn't exclude its children, therefore, chest and its children will animate just fine. This is a bit unfortunate and there are some things that you need to keep in mind when creating a skeleton if you wish it to be recognized as a humanoid by Unity.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec08"></a>Correct topology</h5></div></div></div><p>By topology, I mean <a id="id289" class="indexterm"></a>that the skeleton must have certain bones <a id="id290" class="indexterm"></a>that follow a strict hierarchy. Now, that doesn't mean that your character must have a certain skeleton or bust, you may or may not have certain bones, but there are those that define us as humanoids and they must exist. Here is the structure skeleton we must respect in order for our character to be recognized as a humanoid by Unity standards:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="strong"><strong>Hips</strong></span> | <span class="strong"><strong>Upper Leg</strong></span> | <span class="strong"><strong>Lower Leg</strong></span> | <span class="strong"><strong>Foot</strong></span> | <span class="strong"><strong>Toes</strong></span>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Hips</strong></span> | <span class="strong"><strong>Spine</strong></span> | <span class="strong"><strong>Chest</strong></span> | <span class="strong"><strong>Neck</strong></span> | <span class="strong"><strong>Head</strong></span>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Chest</strong></span> | <span class="strong"><strong>Shoulder</strong></span> | <span class="strong"><strong>Arm</strong></span> | <span class="strong"><strong>Forearm</strong></span> | <span class="strong"><strong>Hand</strong></span>
</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Hand</strong></span> | <span class="strong"><strong>Proximal</strong></span> | <span class="strong"><strong>Intermediate</strong></span> | <span class="strong"><strong>Distal</strong></span>
</p></li></ul></div><p>The sad part here is <a id="id291" class="indexterm"></a>that if you have any extra bones that<a id="id292" class="indexterm"></a> are not included in the list, there is no way to add them to the avatar, the list is fixed. Keep in mind, however, that the humanoid animation type was designed as a compromise based on numerous humanoid rig standards. If you are using a different standard or have more bones to increase control and precision, or using the humanoid rig screws in your animation, then you can always switch to <span class="strong"><strong>Generic</strong></span> without a need to re-rig your character.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec15"></a>Wrong topology example</h4></div></div></div><p>Allow me to illustrate an <a id="id293" class="indexterm"></a>example how a perfectly fine bone structure created in Blender can go wrong when viewed in Unity.</p><div class="mediaobject"><img src="/graphics/9781785282843/graphics/B04214_05_15.jpg" /></div><p>If you look at the image above you'll see that the <span class="strong"><strong>Hips</strong></span> bone is the only one grayed out by Unity. That is happening because <span class="strong"><strong>Hips</strong></span> is a child of the <span class="strong"><strong>LowerBack</strong></span> bone. This is where Unity gets confused; it automatically assigns the topmost bone in the hierarchy to be <span class="strong"><strong>Hips</strong></span>, searches down the hierarchy for two bones that represent <span class="strong"><strong>UpperLegs</strong></span> and finds <span class="strong"><strong>R_Thigh</strong></span> and <span class="strong"><strong>L_Thigh</strong></span> (since they are children of the <span class="strong"><strong>LowerBack</strong></span> child bone, they meet the requirements and will work just fine). But with our <span class="strong"><strong>Hips</strong></span> bone from Blender, Unity will simply ignore it, as well as the animation data associated with it, as if it doesn't exist.</p><p>If you aren't planning on using animation referencing, you may simply ignore this issue and switch to <span class="strong"><strong>Generic Animation Type</strong></span>, everything is going to work just fine there. However, if you do plan to rely on the animation referencing, then the only way to make it work, will be to go <a id="id294" class="indexterm"></a>back to Blender, and reparent bones so that <span class="strong"><strong>LowerBack</strong></span> is a child of the <span class="strong"><strong>Hips</strong></span> bone.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec09"></a>Muscles</h5></div></div></div><p>Before we go into this topic, there <a id="id295" class="indexterm"></a>is one thing that is vital to proper muscle work, and that is the T-pose. Make sure that your character was modeled and rigged in the T-pose; this is very important. If, for any reason, that's not the case with your character, you can follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Find the <span class="strong"><strong>Pose</strong></span> drop down menu at the bottom of the <span class="strong"><strong>Inspector</strong></span> window</p></li><li><p>Select <span class="strong"><strong>Enforce T-Pose</strong></span>
</p></li></ol></div><p>With a bit of luck, this will help (note that it's OK to have your character animated out of it, but the actual rig needs to be in the T-Pose).</p><p>The actual muscles in Unity are deceptively easy to use. Think of them as restrains that you might have already applied during the rigging process. Unity tries to apply its own settings of how the body parts should bend and twist.</p><p>Let's talk about the benefits of it. Imagine that you have an animation that is to be applied on two characters, one of which is naked and the other one is geared in full plate medieval armor. Simply referencing animation won't work, you would have a naked character looking stiff, or geared with body parts penetrating his own armor. Muscles allow you to configure their avatars individually, applying different restrains and making sure that the animations look better on both of them. Don't expect this system to create miracles and make a full plated guy's backflip look equally pretty, as it is ridiculous (unless you've designed a specific armor set).</p><p>As for the actual <a id="id296" class="indexterm"></a>muscle configuration, it's very intuitive:</p><div class="mediaobject"><img src="/graphics/9781785282843/graphics/B04214_05_16.jpg" /></div><p>The editor is <a id="id297" class="indexterm"></a>divided into three categories:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="strong"><strong>Muscle Group Preview</strong></span>: This allows you to test a group of muscles by applying different motions that may or may not be a part of your animation.</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Per-Muscle Settings</strong></span>: This allows you to apply restrains on each individual muscle (generated from a humanoid skeleton and mapped on a character's bones). You can dig into hierarchy, specify the range of motion using the slider on the right, and test it with a slider on the left, under a <span class="strong"><strong>Preview</strong></span> column.</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Additional Settings</strong></span>: This gives you extra options to play with to make sure that your character animates well.</p></li></ul></div><p>After all the options are set, just click on <span class="strong"><strong>Apply</strong></span>, then on the <span class="strong"><strong>Done</strong></span> button, and you will return to the previous scene.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec10"></a>Adjust character muscles</h5></div></div></div><p>In the next <a id="id298" class="indexterm"></a>chapter, we will be importing the locomotion animation package from the Unity Asset Store. The Humanoid animation type will help us to reference them onto our character, but to make sure that the character looks fine with a random set of animations; proper set up of the muscle system is required. Try to edit the muscles and utilize the motion sliders to restrict character movement in order to avoid geometry overlapping. In the case of our character, the most problematic area will be the chest that might cause the hands to crush into the geometry while running. The final result should have no overlapping geometry while testing the character with the <span class="strong"><strong>Muscle Group Preview</strong></span> sliders.</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec62"></a>Additional options</h3></div></div></div><p>The Humanoid <a id="id299" class="indexterm"></a>animation type further extends our options in the <span class="strong"><strong>Animation</strong></span> tab.</p><p>Animation clips now have additional indicators for <span class="strong"><strong>Looping</strong></span>, <span class="strong"><strong>RootTransforms</strong></span>, and <span class="strong"><strong>Root Rotation</strong></span> called <span class="strong"><strong>loop match</strong></span>. These indicators evaluate the difference between the first and final frame of the animation and suggest whether the <span class="strong"><strong>Loop Pose</strong></span> option should be used.</p><div class="mediaobject"><img src="/graphics/9781785282843/graphics/B04214_05_17.jpg" /></div><p>The new humanoid <a id="id300" class="indexterm"></a>animation type also brought a <span class="strong"><strong>Humanoid</strong></span> setting to a <span class="strong"><strong>Mask</strong></span>.</p><p>Using the humanoid mask, you can enable or disable the different groups of muscles and IKs to be affected by the animation, and see the result right in the preview window. As of v5.01, Unity supports only <span class="strong"><strong>LeftFoot</strong></span>, <span class="strong"><strong>RightFoot</strong></span>, <span class="strong"><strong>LeftHand</strong></span>, and <span class="strong"><strong>RightHand</strong></span> IK goals for the humanoid animation type.</p><p>This concludes this part of the animation pipeline. I hope you've managed to grasp the essentials of how this system works and what to expect from it.</p></div></div>