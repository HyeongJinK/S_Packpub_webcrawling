<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch01lvl1sec12"></a>Creating a custom diffuse lighting model</h2></div></div><hr /></div><p>Using Unity's built-in lighting<a id="id39" class="indexterm"></a> functions is all well and good, but you will quickly outgrow these and want to create a lot more custom lighting models. Speaking from experience, we have never worked on a project that has used just the built-in Unity lighting functions and called it good. We would create custom lighting models for just about everything. This would allow us to do things such as produce rim lighting effects, more Cubemap-based types of lightings, or even control over how your Shaders react to gameplay, as seen in Shaders that control force fields.</p><p>This recipe will focus on creating our own custom diffuse lighting model that we can use to modify and create a number of different effects.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec17"></a>How to do it…</h3></div></div></div><p>Using the basic diffuse Shader we created in the last recipe, let's modify it again by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Let's modify the <code class="literal">#pragma</code> statement to the following code:</p><div class="informalexample"><pre class="programlisting">#pragma surface surf BasicDiffuse</pre></div></li><li><p>Add the following code to the subshader:</p><div class="informalexample"><pre class="programlisting">inline float4 LightingBasicDiffuse (SurfaceOutput s, fixed3 lightDir, fixed atten)
{
  float difLight = max(0, dot (s.Normal, lightDir));

  float4 col;
  col.rgb = s.Albedo * _LightColor0.rgb * (difLight * atten * 2);
  col.a = s.Alpha;
  return col;
}</pre></div></li><li><p>Save the Shader in MonoDevelop and return to Unity. The Shader will compile, and if everything went well, you will see that no real visible change has happened to our Material. What we have done is removed the connection to the built-in Unity diffuse lighting and created our own lighting model that we can customize.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec18"></a>How it works…</h3></div></div></div><p>There are definitely a lot of elements working here, so let's try to break it down piece by piece and learn why this works in the way that it does:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">#pragma</code> surface directive tells the Shader which lighting model to use for its calculation. It worked when we first created the Shader because Lambert is a lighting model defined in the <code class="literal">Lighting.cginc</code> file. So it was able to use this on creation. We have now told the Shader to look for a lighting model by the name <span class="strong"><strong>BasicDiffuse</strong></span>.</p></li><li style="list-style-type: disc"><p>Creating a <a id="id40" class="indexterm"></a>new lighting model is done by declaring a new lighting model function. Once you have done that, you simply replace the function's name with a name of your choice. For example, <code class="literal">LightingName</code> becomes <code class="literal">Lighting&lt;Your Chosen Name&gt;</code>. There are three types of lighting model functions that you can use:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<code class="literal">half4 LightingName (SurfaceOutput s, half3 lightDir, half atten){}</code>
</p><p>This function is used for forward rendering when the view direction is not needed.</p></li><li style="list-style-type: disc"><p>
<code class="literal">half4 LightingName (SurfaceOutput s, half3 lightDir, half3 viewDir, half atten){}</code>
</p><p>This function is used in forward rendering when a view direction is needed.</p></li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<code class="literal">half4 LightingName_PrePass (SurfaceOutput s, half4 light){}</code>
</p><p>This function is used when you are using deferred rendering for your project.</p></li></ul></div></li><li style="list-style-type: disc"><p>The dot product function<a id="id41" class="indexterm"></a> is <a id="id42" class="indexterm"></a>another built-in mathematical function in the Cg language. We can use it to compare the directions of two vectors in space. The dot product checks whether two vectors are either parallel to each other or perpendicular. By giving the dot product function, for two vectors you will get a float value in the range of <code class="literal">-1</code> to <code class="literal">1</code>; where <code class="literal">-1</code> is parallel and has the vector facing away from you, <code class="literal">1</code> is parallel and has the vector facing toward you, and 0 is completely perpendicular to you.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note06"></a>Note</h3><p>"The vector dot product (or inner product) of the normalized vectors N and L is a measure of the angle between the two vectors. The smaller the angle between the vectors, the greater the dot-product value will be, and the more incident light the surface will receive."</p><p>Reference:</p><p>
<a class="ulink" href="http://http.developer.nvidia.com/CgTutorial/cg_tutorial_chapter05.html" target="_blank">http://http.developer.nvidia.com/CgTutorial/cg_tutorial_chapter05.html</a>
</p></div></li><li style="list-style-type: disc"><p>To complete the <a id="id43" class="indexterm"></a>diffuse calculation, we need to multiply it with the data being provided to us by Unity and by the <code class="literal">SurfaceOutput</code> struct. For this we need to multiply the <code class="literal">s.Albedo</code> value (which comes from our <code class="literal">surf</code> function) with the incoming <code class="literal">_LightColor0.rgb</code> value (which Unity provides), and then multiply the result of that with <code class="literal">(difLight * atten)</code>. Then, finally, return that value as the color. See the following code:</p><div class="informalexample"><pre class="programlisting">inline float4 LightingBasicDiffuse (SurfaceOutput s, fixed3 lightDir, fixed atten)
{
  float difLight = max(0, dot (s.Normal, lightDir));

  float4 col;
col.rgb = s.Albedo * _LightColor0.rgb * (difLight * atten * 2);
  col.a = s.Alpha;
  return col;
}</pre></div></li></ul></div><p>The following screenshot demonstrates the result of our basic diffuse Shader:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084_01_07.jpg" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec19"></a>There's more…</h3></div></div></div><p>By using the built-in Cg function called <code class="literal">max</code>, we can clamp the values that get returned from the dot product function. The <code class="literal">max</code> function<a id="id44" class="indexterm"></a> takes two arguments, <code class="literal">max(arg1, arg2)</code>. We are using it in our Shader to make sure the values we are using for our diffuse calculation are between 0 and the maximum of the dot product. This way we will never get a value below 0, especially not -1, which would create extremely black areas in your Shader that wouldn't play well with your Shader math later in the Shader process.</p><p>There is also<a id="id45" class="indexterm"></a> the <code class="literal">saturate</code> function within the Cg function library. This helps us to clamp float values between 0 and 1 as well. The only difference between <code class="literal">max()</code> and <code class="literal">saturate()</code>, is that you simply feed your float value into <code class="literal">saturate</code>. The <code class="literal">max</code> function takes two arguments and returns the maximum value between the two.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec20"></a>See also</h3></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>You can find more information on the Surface Shader lighting model function arguments at <a class="ulink" href="http://docs.unity3d.com/Documentation/Components/SL-SurfaceShaderLighting.html" target="_blank">http://docs.unity3d.com/Documentation/Components/SL-SurfaceShaderLighting.html</a>
</p></li></ul></div></div></div>