<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec32"></a>Masking reflections in Unity3D</h2></div></div><hr /></div><p>Having a reflection is nice, but we aren't going to want to make reflective spheres all the time. Just about everything reflects a certain amount of its environment, and hence, we need some sort of per pixel control over the reflection effect.</p><p>In this recipe, we are going to look at a technique that lets us drive the reflection amount, by using a texture as a mask. Basically, we can use the gray scale values of a texture to say how reflective the surface is, meaning that a black value in the texture is going to produce a non-reflective surface and a white value is going to produce a fully reflective surface. This allows for a level of artistic control that is seen in just about every game production pipeline these days. So, let's take a look at how to do it in Unity using Surface Shaders.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec81"></a>Getting ready</h3></div></div></div><p>Let's get our new<a id="id267" class="indexterm"></a> scene <a id="id268" class="indexterm"></a>ready for our new masked reflection Shader.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>We will need to have a Cubemap ready for our Shader, you can generate a new one or just use the one from the previous recipe. The Cubemap we will be using for this recipe, which is included in the sample code for this book, is shown here:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_04_19.jpg" /></div></li><li><p>We will also need a texture that will describe where the surface of our object is reflective and where it is not. Remember, black will represent zero reflectivity and white will represent full reflectivity, with all the gray scale in between providing a certain amount of reflectivity. See the following texture for the one we are using in this recipe:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_04_18.jpg" /></div></li><li><p>Finally, create a new scene with an object, ground, and a directional light so that we can see our Shader in all its reflectiveness!</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec82"></a>How to do it…</h3></div></div></div><p>With our <a id="id269" class="indexterm"></a>scene set up, we can now begin to write the code necessary to <a id="id270" class="indexterm"></a>produce our reflection effect.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Add the following properties to your Shader. This will let us assign our own custom Cubemap and reflection masks to our Shader:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_04_20.jpg" /></div></li><li><p>We then need to make sure we add the same properties as variables to our <code class="literal">SubShader</code> block.</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_04_21.jpg" /></div></li><li><p>In order for us to properly simulate the reflection from the Cubemap, we are going to need to declare the <code class="literal">worldRefl</code> property in the <code class="literal">Input</code> struct. We can use this data as the<a id="id271" class="indexterm"></a> lookup parameter <a id="id272" class="indexterm"></a>in the <code class="literal">texCUBE()</code> function.</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_04_22.jpg" /></div></li><li><p>Lastly, we <a id="id273" class="indexterm"></a>need to update our <code class="literal">surf()</code> function<a id="id274" class="indexterm"></a> with the following code. This will be explained in the next section of this recipe:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_04_23.jpg" /></div></li></ol></div><p>The following screenshot shows the result of masking the reflection component with a texture in a Unity3D Surface Shader:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_04_16.jpg" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec83"></a>How it works…</h3></div></div></div><p>This <a id="id275" class="indexterm"></a>Shader works quite simply by first sampling the <a id="id276" class="indexterm"></a>Cubemap using the <code class="literal">texCUBE()</code> function. This function is built-in to the CGFX language. It provides us with the sampled Cubemap colors that we can then apply to the surface of our Shader. Unity helps us in this endeavor by providing us with the <code class="literal">worldRefl</code> property in the Input struct. As explained in the last recipe, this property will pass in for us the reflection vector from our camera view.</p><p>Once we have the reflection element, we then need to sample our reflection mask texture. This is simply done by using the <code class="literal">tex2D()</code> built-in function, which we have seen before in <a class="link" href="#" linkend="ch02">Chapter 2</a>, <span class="emphasis"><em>Using Textures for Effects</em></span>.</p><p>With both texture types sampled and stored into a variable in our <code class="literal">surf()</code> function, we simply have to multiply the Cubemap colors with the reflection texture colors and pass that into the <code class="literal">o.Emission</code> parameter of our surface's <code class="literal">Output</code> struct. Finally, to globally control the overall reflection intensity, we multiply the result of the reflection masking by our <code class="literal">_ReflectionAmount</code> property. This will let us control the overall amount of reflection over the whole surface.</p><p>The following <a id="id277" class="indexterm"></a>screenshot shows the different results by <a id="id278" class="indexterm"></a>controlling the overall reflection with the <code class="literal">_ReflectionAmount</code> property:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_04_24.jpg" /></div></div></div>