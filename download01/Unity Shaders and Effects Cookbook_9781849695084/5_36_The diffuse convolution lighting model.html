<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec38"></a>The diffuse convolution lighting model</h2></div></div><hr /></div><p>Diffuse convolution <a id="id333" class="indexterm"></a>is the process of blurring a Cubemap <a id="id334" class="indexterm"></a>such that the overall intensity of the lighting in the Cubemap is retained but the details are blurred out. This type of technique is really useful when you want to achieve a more globally-lit surface. You can fake the effects of global illumination by capturing a Cubemap of your scene and running it through a diffuse convolution algorithm, and then lighting your model with the convolved Cubemap.</p><p>We are going to look at how we can use this technique inside Unity using Surface Shaders. We will also utilize CubeMapGen to produce our diffuse convolved Cubemap. </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec99"></a>Getting ready</h3></div></div></div><p>In order for us to achieve this technique, we need to be able to create a Cubemap that has been convolved. There are a few ways to do this, but we will focus on using CubeMapGen from ATI. You can download this tool from their site using this link: <a class="ulink" href="http://developer.amd.com/resources/archive/archived-tools/gpu-tools-archive/cubemapgen/" target="_blank">http://developer.amd.com/resources/archive/archived-tools/gpu-tools-archive/cubemapgen/</a>.</p><p>The following image shows the CubeMapGen user interface as well as a Cubemap loaded into the program:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_35.jpg" /></div><p>Let's walk through the process of creating a<a id="id335" class="indexterm"></a> convolved Cubemap:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Launch CubeMapGen and load one of the Cubemaps that comes with the application. They will be located in the install directory of CubeMapGen.</p></li><li><p>Once you have loaded a Cubemap into the tool, we need to filter it, which means to convolve it or blur it with intelligence. So, we need to go into the blue section of the user interface and set <span class="strong"><strong>Filter Type</strong></span> to <span class="strong"><strong>Gaussian</strong></span>, <span class="strong"><strong>Base Filter Angle</strong></span> to <code class="literal">72.00</code>, <span class="strong"><strong>Mip Initial Filter Angle</strong></span> to <code class="literal">7.60</code>, <span class="strong"><strong>Mip Filter Angle Scale</strong></span> to <code class="literal">2.02</code>, and <span class="strong"><strong>Edge fix up</strong></span> to <span class="strong"><strong>4</strong></span>. Then hit the <span class="strong"><strong>Filter Cubemap</strong></span> button at the bottom of the blue section of the interface. This will take a little while, but you should end up with something like the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_36.jpg" /></div></li><li><p>Once <a id="id336" class="indexterm"></a>CubeMapGen has completed its filter process, you can then save your Cubemap into separate faces by hitting the <span class="strong"><strong>Save Cubemap to Images</strong></span> button in the green section of the user interface. This will create each of the sides of the Cubemap for you. We can then take these images and construct a new Cubemap inside of Unity.</p></li><li><p>Now that we have completed the Cubemap creation, we need to set up a scene to create our Shader with. So, create a new scene and place some objects in the scene with one directional light. We will also need a new Material and a new Shader.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec100"></a>How to do it…</h3></div></div></div><p>With all of our<a id="id337" class="indexterm"></a> assets generated, we can now walk through the process of creating our Shader to utilize our convolved Cubemap.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>As usual, let's create the properties that will let an artist interact with our Shader so that they can tune it how they see fit.</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_37.jpg" /></div></li><li><p>We then need to declare our <code class="literal">#pragma</code> statements. In this case, we are going to create a new lighting model, as we want our Cubemap to light our model and not the lights themselves. We are also going to need to declare the 3.0 target shading model so that we don't run into a texture interpolation error.</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_38.jpg" /></div></li><li><p>In order for<a id="id338" class="indexterm"></a> us to be able to access the data coming in from our properties, we need to create the link between the <code class="literal">Properties</code> block and the <code class="literal">SubShader</code> block by declaring a corresponding variable for each of our properties. Enter the following code to create this link:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_39.jpg" /></div></li><li><p>Our <code class="literal">Input</code> struct is going to be pretty simple this time around, as all we need is the world normal from our model. We will need the <code class="literal">INTERNAL_DATA</code> statement, as we will be including a normal map in our Shader and this will give us the modified normal.</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_40.jpg" /></div></li><li><p>Our next task is to create the structure for our lighting model. We will want to include the view direction, as we are going to be creating a simple specular for our Shader as well.</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_41.jpg" /></div></li><li><p>Our lighting<a id="id339" class="indexterm"></a> function is no good if we don't actually fill it with stuff that calculates our lighting. So, let's start that by getting all of our lighting vectors in order:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_42.jpg" /></div></li><li><p>Then we need to take care of our Specular component.</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_43.jpg" /></div></li><li><p>Finally, we combine all of our calculations together to form our lighting model:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_44.jpg" /></div></li><li><p>With our lighting model completed we can now simply process our textures, sample our convolved Cubemap with the world normal of the model, and pass the result to the <code class="literal">SurfaceOutput</code> struct:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_45.jpg" /></div></li></ol></div><p>Using the world <a id="id340" class="indexterm"></a>normal, we can look up a color in a convolved Cubemap to give our models a very realistic look.</p><p>The result of our diffuse convolution shader can be seen in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_34.jpg" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec101"></a>How it works…</h3></div></div></div><p>Another simple <a id="id341" class="indexterm"></a>yet visually stunning technique is the diffuse convolution technique. While it is a bit more interactive than the sphere map approach, the lighting is still locked off to a single Cubemap. You could update the Cubemap in real time to sample the environment around you, but the process of convolving the Cubemap would be too computationally expensive to do in real time. Not to worry though. This is why Unity has provided us with the light probe technique. It allows us to place points in an environment and sample the convolved ambient light coming into each point. This is commonly referred to as <a id="id342" class="indexterm"></a>
<span class="strong"><strong>ambient cube shading</strong></span>.</p><p>This Shader, though, is great for setting up small scenes in which there isn't too much motion or interactivity with lights. This is commonly referred to as Image based lighting, as we are using the Cubemap images to light our model and not a light itself. This technique is great for cinematics in your game, or even a vehicle customization screen.</p><p>This simply works by taking the world normals of the model after they have been modified by the normal map, and using that data to look up a position in the Cubemap to retrieve its pixel color. This is why we have to declare <code class="literal">float3</code>, <code class="literal">worldNormal</code>, and the <code class="literal">INTERNAL_DATA</code> parameters in our Input struct. We then have to use the<a id="id343" class="indexterm"></a> <code class="literal">WorldNormalVector()</code> function provided to us by Unity to get the final normal vector for our <code class="literal">texCUBE()</code> lookup. The rest of the Shader is pretty familiar to us by now.</p><p>In the following screenshot, we can see how the world normal looks up which color it should be from the Cubemap surrounding it:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_60.jpg" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec102"></a>There's more…</h3></div></div></div><p>For more information on using light probes within Unity to get Ambient Cubemaps. refer to <a class="ulink" href="http://docs.unity3d.com/Documentation/Manual/LightProbes.html" target="_blank">http://docs.unity3d.com/Documentation/Manual/LightProbes.html</a>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec103"></a>See also</h3></div></div></div><p>Remember to reference the <span class="emphasis"><em>Creating Cubemaps in Unity3D</em></span> recipe in <a class="link" href="#" linkend="ch04">Chapter 4</a>, <span class="emphasis"><em>Reflecting Your World</em></span>, if you need a refresher.</p></div></div>