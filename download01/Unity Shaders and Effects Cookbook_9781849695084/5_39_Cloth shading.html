<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec41"></a>Cloth shading</h2></div></div><hr /></div><p>Cloth is another very common shading task that needs to be achieved in the process of making games or shading real-time interactive experiences. It involves understanding how the fibers of the cloth disperse the lighting over the surface to produce the look of cloth. It is also very view-dependent and so we will look at some new tricks we can employ to fake the effects of light glancing over the surface of the cloth, and the tiny fibers producing a very distinctive rim lighting effect.</p><p>This Shader will <a id="id380" class="indexterm"></a>introduce us to the concept of detail normal maps and detail textures. By combining two normal maps together, we can actually achieve a higher level of detail that you could store in a 2048 x 2048 texture. This technique will help us simulate the micro level of bumps in the surface that will allow us to disperse the specular component over a wide surface.</p><p>Here, we can see the final cloth shader we are going to make in this recipe:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_46.jpg" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec112"></a>Getting ready</h3></div></div></div><p>This <a id="id381" class="indexterm"></a>Shader is going to require that we gather three different types of textures in order to simulate a cloth-like surface.</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>We are going to need a Detail Normal map. This map will be tiled over the surface to simulate the micro stitching in the cloth.</p></li><li style="list-style-type: disc"><p>We will need a Normal Variation map that will give us a nice variation in the stitching to make it feel less uniform and more like it has been worn over the years.</p></li><li style="list-style-type: disc"><p>Finally, we need a Detail Diffuse map that we can multiply over the base color in order to give the diffuse a bit more depth and realism, and to emphasize the stitching in the cloth.</p></li></ul></div><p>The following screenshot shows the three textures we will be using for this recipe. They are also included on this book's support page located at <a class="ulink" href="http://www.packtpub.com/support" target="_blank">www.packtpub.com/support</a>:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_47.jpg" /></div><p>To complete the setup, we need to create a scene with an object and a directional light. Then finally, create a new Shader and Material to assign to our main object.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec113"></a>How to do it…</h3></div></div></div><p>Let's get our Shader started by filling in our <code class="literal">Properties</code> block.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Our Shader is going to take just a few properties here to control which textures we use and how the falloff of our Fresnel and specular components look.</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_49.jpg" /></div></li><li><p>As we <a id="id382" class="indexterm"></a>want to have full control over how the lighting reacts to the surface of our cloth, we are going to declare a new lighting model in our <code class="literal">#pragma</code> statements, as well as setting this Shader to use Shader model 3.0. In order for us to create our own custom lighting model, we have to declare the name of our lighting model in the <code class="literal">#pragma</code> statements.</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_50.jpg" /></div></li><li><p>Now, we have to make the connection between the <code class="literal">Properties</code> block and the <code class="literal">SubShader</code> block. In order to use the data coming in from our <code class="literal">Properties</code> block, we have to declare the same named variables in our <code class="literal">SubShader</code> block.</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_51.jpg" /></div></li><li><p>To control the tiling rates of our detail textures independently, we need to declare the UV parameters in the <code class="literal">Input</code> struct. The UV information will be connected if you put <code class="literal">uv</code> in front of the same name of the texture. Connect the texture's tiling rates within the <code class="literal">Input</code> struct:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_52.jpg" /></div></li><li><p>Now, we <a id="id383" class="indexterm"></a>need to build the function that will become our lighting model. Create the lighting function structure to start the process of creating a custom lighting model. We are going to need the <code class="literal">viewDir</code> lighting function structure for this Shader, as the cloth surface has view-dependent components.</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_53.jpg" /></div><p>It's <a id="id384" class="indexterm"></a>always a good idea to take care of all your lighting vectors at the beginning of your lighting function. This frees you up to worry about other parts of the lighting calculation, instead of always having to normalize your vectors. Let's add our lighting vectors to the beginning of our lighting model:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_54.jpg" /></div></li><li><p>Our next task is to calculate our Specular component. Add the following code just after the lighting vectors:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_55.jpg" /></div><p>The shading of cloth is very dependent on how you are looking at its surface. The more glancing the surface of the cloth, the more the fibers catch the light behind it and amplify the intensity of the Specular component.</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_56.jpg" /></div></li><li><p>With all <a id="id385" class="indexterm"></a>our main lighting calculations completed, we just need to output the final color. Complete the lighting model by entering the following code, just beneath the Fresnel calculation:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_57.jpg" /></div></li><li><p>Finally, we finish our Shader by filing in our <code class="literal">surf()</code> function. Here, we just need to unpack our normal maps, and send all the data to our <code class="literal">SurfaceOuput</code> struct. Let's complete the Shader by sampling our textures:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_58.jpg" /></div></li></ol></div><p>The following screenshot demonstrates the result of using this cloth surface shader on a cloth-like model:</p><div class="mediaobject"><img src="/graphics/9781849695084/graphics/5084OT_05_48.jpg" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec114"></a>How it works…</h3></div></div></div><p>Overall our cloth <a id="id386" class="indexterm"></a>shader isn't that complicated really. We are doing some very basic lighting operations, but sometimes that's all you need for your Shaders. When writing Shaders you want to really look at the surface you are trying to simulate and break it into its components, and then program them one at a time. The real magic comes in how you end up combining the different calculations, much like blending layers in Photoshop.</p><p>The new technique demonstrated in our cloth shader is the process of combining two normal maps with different tiling rates. Our basic linear algebra will show that we can in fact add two vectors together to result in a new position. So we can do just that with our normal maps. We take our Variation Normal map, which provides us a vector by using the<a id="id387" class="indexterm"></a> <code class="literal">UnpackNormal()</code> function, and add the normal vector from the Detail Normal map. This will basically result in a new normal map. We then need to normalize our final vector, so that it is back in the <code class="literal">0</code> to <code class="literal">1</code> range. If we don't, our normal map will look very bruised and visually wrong.</p><p>Finally, the combination of the Fresnel and the Specular calculation allows us to create the effect of the tiny fibers of cloth to catch the light at glancing angles to the surface of our object.</p></div></div>