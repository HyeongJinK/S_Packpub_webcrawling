<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec31"></a>The Game Master</h2></div></div><hr /></div><p>Even though we created a <span class="emphasis"><em>GameMaster.cs</em></span> scripts, we have not really utilized it to manage our game. We created bits and pieces of our game assets and used them to perform quick testing. In this chapter, we will start looking at how to create a better game manager for our RPG.</p><p>There are a few things that I want the GameMaster.cs to perform. These are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Having a reference to the UI Controller for each particular scene</p></li><li style="list-style-type: disc"><p>Having a reference to the Player Character in the scene</p></li><li style="list-style-type: disc"><p>Having a reference to the Non-Player Character(s) in the scene</p></li><li style="list-style-type: disc"><p>Having a reference to the Audio Source for control</p></li><li style="list-style-type: disc"><p>There should always be one instance of the GameMaster class available</p></li></ul></div><p>As we create our GameMaster, we will add or subtract some of the elements as we see fit. Let's start by integrating the User Interface with the GameMaster.</p><p>Open up your Main Menu scene. It should look something like the following figure:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785285004/graphics/image_05_001.jpg" /></div><p>
</p><p>In the preceding figure, I added a few UI elements. There is a button that is a place holder for game settings indicated by the (*). When the button is pressed, you will get a panel that will give you the ability to control the master volume of the game.</p><p>Here is a screenshot of the Hierarchy Window for the main menu scene:</p><p>
</p><div class="mediaobject"><img src="/graphics/9781785285004/graphics/image_05_002.jpg" /></div><p>
</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec33"></a>Managing game settings and audio</h3></div></div></div><p>Create an Empty Game Object and name it <span class="emphasis"><em>uiController</em></span>. We now need to create a UI Controller script that will handle the user interaction. Create a new C# script and name it <span class="emphasis"><em>UIController.cs</em></span>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note37"></a>Note</h3><p>Note that the scripts in this chapter will be updated and modified as we progress.</p></div><p>Here is a listing of the UI Controller:</p><pre class="programlisting">using UnityEngine; &#13;
using UnityEngine.UI; &#13;
using System.Collections; &#13;
 &#13;
public class UIController : MonoBehaviour &#13;
{ &#13;
  public Canvas SettingsCanvas; &#13;
  public Slider ControlMainVolume; &#13;
 &#13;
  public void Update() &#13;
  { &#13;
  } &#13;
 &#13;
  public void DisplaySettings() &#13;
  { &#13;
    GameMaster.instance.DISPLAY_SETTINGS = !GameMaster.instance.DISPLAY_SETTINGS; &#13;
    this.SettingsCanvas.gameObject.SetActive(GameMaster.instance.DISPLAY_SETTINGS); &#13;
  } &#13;
 &#13;
  public void MainVolume() &#13;
  { &#13;
    GameMaster.instance.MasterVolume(ControlMainVolume.value); &#13;
  } &#13;
 &#13;
} &#13;
</pre><p>Currently, we have just a few functions defined: <code class="literal">DisplaySettings()</code> and <code class="literal">MainVolume()</code>. The functions are really simple, they are referencing the UI components needed to display the settings panel, and also to retrieve the value of the volume control slider. The information is then passed to the <code class="literal">GameMaster.cs</code> script for further processing.</p><p>We need to make several changes to the <code class="literal">GameMaster.cs</code> script. Here is a listing of the code:</p><pre class="programlisting">using UnityEngine; &#13;
using UnityEngine.UI; &#13;
using UnityEngine.SceneManagement; &#13;
 &#13;
using System.Collections; &#13;
 &#13;
public class GameMaster : MonoBehaviour &#13;
{ &#13;
 &#13;
  public static GameMaster instance; &#13;
 &#13;
  // let's have a reference to the player character &#13;
  // and start position of player character &#13;
  public GameObject PC; &#13;
  public GameObject START_POSITION; &#13;
  public GameObject CHARACTER_CUSTOMIZATION; &#13;
 &#13;
  // let's have a reference to the current scene/level &#13;
  public Scene CURRENT_SCENE; &#13;
 &#13;
  // Ref to UI Elements ... &#13;
  public bool DISPLAY_SETTINGS = false; &#13;
  public UIController UI; &#13;
 &#13;
  public int LEVEL = 0; &#13;
 &#13;
  // initial audio levels for background and &#13;
  // sound FX &#13;
  public float AUDIO_LEVEL = 0.33f; &#13;
  public float FX_LEVEL = 0.33f; &#13;
 &#13;
  void Awake() &#13;
  { &#13;
    // simple singleton &#13;
    if (instance == null) &#13;
    { &#13;
      instance = this; &#13;
    } &#13;
    else if (instance != this) &#13;
    { &#13;
      Destroy(this); &#13;
    } &#13;
 &#13;
    // keep the game object when moving from &#13;
    // one scene to the next scene &#13;
    DontDestroyOnLoad(this); &#13;
 &#13;
  } &#13;
 &#13;
  // Use this for initialization &#13;
  void Start() &#13;
  { &#13;
    // let's find a reference to the UI controller of the loaded scene &#13;
    if (GameObject.FindGameObjectWithTag("UI") != null) &#13;
    { &#13;
      GameMaster.instance.UI = GameObject.FindGameObjectWithTag("UI").GetComponent&lt;UIController&gt;(); &#13;
    } &#13;
 &#13;
    GameMaster.instance.UI.SettingsCanvas.gameObject.SetActive(GameMaster.instance.DISPLAY_SETTINGS); &#13;
  } &#13;
 &#13;
  // Update is called once per frame &#13;
  void Update() &#13;
  { &#13;
 &#13;
  } &#13;
 &#13;
  public void MasterVolume(float volume) &#13;
  { &#13;
    GameMaster.instance.AUDIO_LEVEL = volume; &#13;
    GameMaster.instance.GetComponent&lt;AudioSource&gt;().volume = GameMaster.instance.AUDIO_LEVEL; &#13;
  } &#13;
 &#13;
  public void StartGame() &#13;
  { &#13;
    // NOTE: Start the game, load the scene that allows the player &#13;
    // to customize their character &#13;
    SceneManager.LoadScene(SceneName.CharacterCustomization); &#13;
  } &#13;
 &#13;
} &#13;
</pre><p>This code needs a bit of explanation. The first and most important concept to take away is the concept of a Singleton. This is done by first defining a static variable, which will be used to hold our <code class="literal">GameMaster instance</code>:</p><pre class="programlisting">public static GameMaster instance;&#13;
Then in our <span class="emphasis"><em>Awake()</em></span> function, we need the following code:&#13;
void Awake()&#13;
{&#13;
// simple singleton&#13;
if (instance == null)&#13;
{&#13;
instance = this;&#13;
}&#13;
else if (instance != this)&#13;
{&#13;
Destroy(this);&#13;
}&#13;
// keep the game object when moving from&#13;
// one scene to the next scene&#13;
DontDestroyOnLoad(this);&#13;
}</pre><p>In the <span class="emphasis"><em>Awake()</em></span> function, we are checking to see if the instance variable has been initialized. It sets the instance variable once. The next check ensures that we are always having one instance; in other words, if the GameMaster object gets instantiated a second time by mistake, it will destroy it. The last line of code <span class="emphasis"><em>DotDestroyOnLoad()</em></span> will ensure that the GameObject does not get destroyed when we move from one scene to the next.</p><p>In the <span class="emphasis"><em>Start()</em></span> function, we are checking to see if there is a uiController present, and if one exists, we are getting a reference to it. Once we have a reference to the uiController, we make sure that the <span class="emphasis"><em>Settings Panel</em></span> by default is disabled, hidden.</p><p>The <span class="emphasis"><em>MasterVolume()</em></span> function gets called from the UIController.cs script, which then passes the actual value from the slider defined to control the volume of the background music.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec34"></a>Managing scenes</h3></div></div></div><p>The next item I want to make is to have the GameMaster control loading the different scenes for the game. Let's look at how the <span class="emphasis"><em>GameMaster.cs</em></span> will look like with the new addition of scene management.</p><pre class="programlisting">using UnityEngine; &#13;
using UnityEngine.UI; &#13;
using UnityEngine.SceneManagement; &#13;
 &#13;
using System.Collections; &#13;
 &#13;
/// &lt;summary&gt; &#13;
/// This class is used to make referencing easier in the code &#13;
/// &lt;/summary&gt; &#13;
public static class SceneName &#13;
{ &#13;
  public const string MainMenu = "MainMenu"; &#13;
  public const string CharacterCustomization = "CH4_CC"; &#13;
  public const string Level_1 = "CH5"; &#13;
} &#13;
 &#13;
public class GameMaster : MonoBehaviour &#13;
{ &#13;
 &#13;
  public static GameMaster instance; &#13;
 &#13;
  // let's have a reference to the player character &#13;
  // and start position of player character &#13;
  public GameObject PC; &#13;
  public GameObject START_POSITION; &#13;
  public GameObject CHARACTER_CUSTOMIZATION; &#13;
 &#13;
  // let's have a reference to the current scene/level &#13;
  public Scene CURRENT_SCENE; &#13;
 &#13;
  // Ref to UI Elements ... &#13;
  public bool DISPLAY_SETTINGS = false; &#13;
  public UIController UI; &#13;
 &#13;
  public int LEVEL = 0; &#13;
 &#13;
  // initial audio levels for background and &#13;
  // sound FX &#13;
  public float AUDIO_LEVEL = 0.33f; &#13;
  public float FX_LEVEL = 0.33f; &#13;
 &#13;
  void Awake() &#13;
  { &#13;
    // simple singleton &#13;
    if (instance == null) &#13;
    { &#13;
      instance = this; &#13;
    } &#13;
    else if (instance != this) &#13;
    { &#13;
      Destroy(this); &#13;
    } &#13;
 &#13;
    // keep the game object when moving from &#13;
    // one scene to the next scene &#13;
    DontDestroyOnLoad(this); &#13;
  } &#13;
 &#13;
  // for each level/scene that has been loaded &#13;
  // do some of the preparation work &#13;
  void OnLevelWasLoaded() &#13;
  { &#13;
    GameMaster.instance.CURRENT_SCENE = SceneManager.GetActiveScene(); &#13;
 &#13;
    if (GameMaster.instance.CURRENT_SCENE.name.Equals(SceneName.CharacterCustomization)) &#13;
    { &#13;
      if (GameObject.FindGameObjectWithTag("BASE") != null) &#13;
      { &#13;
        GameMaster.instance.CHARACTER_CUSTOMIZATION = GameObject.FindGameObjectWithTag("BASE") as GameObject; &#13;
      } &#13;
    } &#13;
 &#13;
    // If we are at any other scene except character customization &#13;
    // let's go ahead and get reference to player and player &#13;
    // stat position &#13;
    if (!this.CURRENT_SCENE.name.Equals(SceneName.CharacterCustomization)) &#13;
    { &#13;
      // let's get a reference to our player character &#13;
      if (GameMaster.instance.PC == null) &#13;
      { &#13;
        if (GameObject.FindGameObjectWithTag("Player") != null) &#13;
        { &#13;
          GameMaster.instance.PC = GameObject.FindGameObjectWithTag("Player") as GameObject; &#13;
        } &#13;
      } &#13;
 &#13;
      if (GameObject.FindGameObjectWithTag("START_POSITION") != null) &#13;
      { &#13;
        GameMaster.instance.START_POSITION = GameObject.FindGameObjectWithTag("START_POSITION") as GameObject; &#13;
      } &#13;
 &#13;
      if (GameMaster.instance.START_POSITION != null &amp;&amp; GameMaster.instance.PC != null) &#13;
      { &#13;
        GameMaster.instance.PC.transform.position = GameMaster.instance.START_POSITION.transform.position; &#13;
        GameMaster.instance.PC.transform.rotation = GameMaster.instance.START_POSITION.transform.rotation; &#13;
      } &#13;
    } &#13;
 &#13;
    DetermineLevel(); &#13;
 &#13;
  } &#13;
 &#13;
  private void DetermineLevel() &#13;
  { &#13;
    switch(GameMaster.instance.CURRENT_SCENE.name) &#13;
    { &#13;
      case SceneName.MainMenu: &#13;
      case SceneName.CharacterCustomization: &#13;
        { &#13;
          GameMaster.instance.LEVEL = 0; &#13;
          break; &#13;
        } &#13;
 &#13;
      case SceneName.Level_1: &#13;
        { &#13;
          GameMaster.instance.LEVEL = 1; &#13;
          GameMaster.instance.PC.GetComponent&lt;IKHandle&gt;().enabled = true; &#13;
          break; &#13;
        } &#13;
      default: &#13;
        { &#13;
          GameMaster.instance.LEVEL = 0; &#13;
          break; &#13;
        } &#13;
    } &#13;
  } &#13;
 &#13;
  // Use this for initialization &#13;
  void Start() &#13;
  { &#13;
    // let's find a reference to the UI controller of the loaded scene &#13;
    if (GameObject.FindGameObjectWithTag("UI") != null) &#13;
    { &#13;
      GameMaster.instance.UI = GameObject.FindGameObjectWithTag("UI").GetComponent&lt;UIController&gt;(); &#13;
    } &#13;
 &#13;
    GameMaster.instance.UI.SettingsCanvas.gameObject.SetActive(GameMaster.instance.DISPLAY_SETTINGS); &#13;
  } &#13;
 &#13;
  // Update is called once per frame &#13;
  void Update() &#13;
  { &#13;
 &#13;
  } &#13;
 &#13;
  public void MasterVolume(float volume) &#13;
  { &#13;
    GameMaster.instance.AUDIO_LEVEL = volume; &#13;
    GameMaster.instance.GetComponent&lt;AudioSource&gt;().volume = GameMaster.instance.AUDIO_LEVEL; &#13;
  } &#13;
 &#13;
  public void StartGame() &#13;
  { &#13;
    // NOTE: Start the game, load the scene that allows the player &#13;
    // to customize their character &#13;
    SceneManager.LoadScene(SceneName.CharacterCustomization); &#13;
  } &#13;
 &#13;
  public void LoadLevel() &#13;
  { &#13;
    switch(GameMaster.instance.LEVEL) &#13;
    { &#13;
      // load level 1 &#13;
      case 1: &#13;
        { &#13;
          GameMaster.instance.PC = GameObject.FindGameObjectWithTag("Player") as GameObject; &#13;
          SceneManager.LoadScene(SceneName.Level_1); &#13;
          break; &#13;
        } &#13;
    } &#13;
  } &#13;
} &#13;
</pre><p>We have already discussed what the <span class="emphasis"><em>Awake()</em></span> function is doing; let's take a look at the next important function, <span class="emphasis"><em>OnLevelWasLoaded()</em></span>.</p><p>The <span class="emphasis"><em>OnLevelWasLoaded()</em></span> function is called by Unity after the scene had been loaded. We are using this function in the GameMaster script to perform a few tasks. The first thing we do is get the current scene we are in. This information will be used later to determine what the GameMaster will do.</p><p>We check to see if we are in the character customization scene. This is where the player can customize the PC before they start playing the game. If we are in the character customization scene, we want to get a reference to the <span class="emphasis"><em>Base</em></span> GameObject in the scene. If you recall, the <span class="emphasis"><em>Base</em></span> GameObject has the <span class="emphasis"><em>CharacterCutomization.cs</em></span> script attached to it, which is used to well customize the character.</p><p>If we are in any other scene, then we want to get a reference to the Player Character, and also the starting position of the player character at the beginning of the scene, if there is one.</p><p>We then use the <span class="emphasis"><em>DetermineLevel()</em></span> function to determine the level we are currently on to make some more configuration.</p><p>The two function currently implemented for starting the game and loading the levels are handled by the <span class="emphasis"><em>StartGame()</em></span> function and the <span class="emphasis"><em>LoadLevel()</em></span> function.</p><pre class="programlisting">/// &lt;summary&gt;&#13;
/// This class is used to make referencing easier in the code&#13;
/// &lt;/summary&gt;&#13;
public static class SceneName&#13;
{&#13;
public const string MainMenu = "MainMenu";&#13;
public const string CharacterCustomization = "CH4_CC";&#13;
public const string Level_1 = "CH5";&#13;
}</pre><p>The <span class="emphasis"><em>SceneName</em></span> class is designed to make it easier to refer to the scene names in the C# code. This makes it easier to chance the actual scene name within the project, but have a consistent call name in the code.</p><p>This is all good so far, but we can try to make it better.</p></div></div>