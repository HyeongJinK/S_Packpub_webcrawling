<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec97"></a>Time for action â€“ setting up nine States and three Scenes</h2></div></div><hr /></div><p>We're going to modify some States and create some new ones. We're also going to use three Scenes.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl4sec04"></a>In Unity</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create <a id="id364" class="indexterm"></a>three Scenes: <code class="literal">Scene0</code>, <code class="literal">Scene1</code>, and <code class="literal">Scene2.</code>
</p></li><li><p>In the menu, open <a id="id365" class="indexterm"></a>
<span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Build Settings....</strong></span>
</p></li><li><p>Add the three Scenes to <span class="strong"><strong>Scenes in Build.</strong></span>
</p></li><li><p>Temporarily add some GameObjects to <span class="strong"><strong>Scene1</strong></span> and <span class="strong"><strong>Scene2</strong></span> for testing.</p></li><li><p>Open <span class="strong"><strong>Scene1</strong></span> and add a <span class="strong"><strong>Cube</strong></span> GameObject.</p></li><li><p>Open <span class="strong"><strong>Scene2</strong></span> and add two <span class="strong"><strong>Sphere</strong></span> GameObjects.</p></li><li><p>Reload <span class="strong"><strong>Scene0</strong></span>
</p></li><li><p>Double-click on <span class="strong"><strong>BeginState</strong></span> to edit</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl4sec05"></a>In MonoDevelop</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Edit the <code class="literal">BeginState</code> constructor<a id="id366" class="indexterm"></a> method <a id="id367" class="indexterm"></a>as follows to add an <code class="literal">if</code> statement for loading <code class="literal">Scene0</code>:</p><div class="informalexample"><pre class="programlisting">public BeginState (StateManager managerRef)
{
  manager = managerRef;
  if(Application.loadedLevelName != "Scene0")
    Application.LoadLevel("Scene0");
}</pre></div></li><li><p>Make new C# classes for the new States. The following State Machine files should be coded as shown in Appendix A:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">BeginState</code> file</p></li><li style="list-style-type: disc"><p>The <code class="literal">SetupState</code> file</p></li><li style="list-style-type: disc"><p>The <code class="literal">PlayStateScene1_1</code> file: (1 of 2 available States in <span class="strong"><strong>Scene1</strong></span>)</p></li><li style="list-style-type: disc"><p>The <code class="literal">PlayStateScene1_2</code> file: (2 of 2 available States in <span class="strong"><strong>Scene1</strong></span>)</p></li><li style="list-style-type: disc"><p>The <code class="literal">WonStateScene1</code> file</p></li><li style="list-style-type: disc"><p>The <code class="literal">LostStateScene1</code> file</p></li><li style="list-style-type: disc"><p>The <code class="literal">PlayStateScene2</code> file</p></li><li style="list-style-type: disc"><p>The <code class="literal">WonStateScene2</code> file</p></li><li style="list-style-type: disc"><p>The <code class="literal">LostStateScene2</code> file</p></li><li style="list-style-type: disc"><p>The <code class="literal">StateManager</code> file</p></li><li style="list-style-type: disc"><p>The <code class="literal">IStateBase</code> file</p></li></ul></div></li><li><p>Verify that the <code class="literal">StateManager</code>
<a id="id368" class="indexterm"></a> script is<a id="id369" class="indexterm"></a> attached to the <span class="strong"><strong>GameManager</strong></span> GameObject</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec138"></a>
<span class="emphasis"><em>What just happened?</em></span>
</h3></div></div></div><p>You just created nine States that the game can be in. You also created three Scenes that the game will use, determined by the State the game is in.</p><p>Notice the <code class="literal">if</code> statement added in step 9. How did I know about <code class="literal">Application.loadedLevelName</code> to be able to use it?</p><p>I knew I wanted the States to control the loading of the Scenes, so how is a Scene loaded using code?</p><p>I searched the Scripting Reference using terms like scene and load. It didn't actually show exactly what I wanted, but I did see things like <code class="literal">Application.LoadLevelAdditive.</code> That sounded like what I wanted to do, so I clicked it. That provided all kinds of links, but to find everything that's available, I needed to look at the class itself. Obviously, the class name is <code class="literal">Application</code>.</p><p>Reading that page showed me the variable <code class="literal">loadedLevelName</code>. This allows me to check if the <span class="strong"><strong>Scene</strong></span> (level) I want is loaded. If not, then <code class="literal">Application.LoadLevel()</code> is called to load the <span class="strong"><strong>Scene</strong></span> I want for that particular State.</p><p>The following screenshot is a side-by-side view of the Project panel and the Inspector panel, showing <code class="literal">StateManager</code> as a Component of <span class="strong"><strong>GameManager</strong></span>:</p><div class="mediaobject"><img src="/graphics/9781849696586/graphics/6586OT_09_02.jpg" /></div><p>With these 11 C# classes coded, the three Scenes listed in <span class="strong"><strong>Build Settings</strong></span>, the <code class="literal">StateManager</code> script <a id="id370" class="indexterm"></a>attached to the <span class="strong"><strong>GameManager</strong></span> GameObject, and <span class="strong"><strong>Scene0</strong></span> loaded in Unity; you should be able to click on <span class="strong"><strong>Play</strong></span> and see the States switch in<a id="id371" class="indexterm"></a> the <span class="strong"><strong>Console</strong></span>. As shown in the previous <a id="id372" class="indexterm"></a>
<span class="strong"><strong>States and Scenes</strong></span> diagram, when you press the Space bar key and the <span class="emphasis"><em>Return</em></span> key, watch the Scenes change in the <span class="strong"><strong>Game</strong></span> panel.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec139"></a>Calling the Restart method of the StateManager</h3></div></div></div><p>This method was added to<a id="id373" class="indexterm"></a> restart the game from scratch.</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">Destroy(gameObject)</code> method destroys the GameObject this <code class="literal">StateManager</code> script is attached to, the <span class="strong"><strong>GameManager</strong></span>. Why destroy it?</p></li><li style="list-style-type: disc"><p>According to the State Machine, there are three places <code class="literal">Restart()</code> is called:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>At <code class="literal">LostStateScene1</code>
</p></li><li style="list-style-type: disc"><p>At <code class="literal">LostStateScene2</code>
</p></li><li style="list-style-type: disc"><p>At <code class="literal">WonStateScene2</code>
</p></li></ul></div></li><li style="list-style-type: disc"><p>If you have lost the game while in Scenes 1 or 2, the game needs to be restarted from scratch.</p></li><li style="list-style-type: disc"><p>If you have completed the game by winning in <span class="strong"><strong>Scene2</strong></span>, then you're done. Restart the game.</p></li></ul></div><p>When destroying the <span class="strong"><strong>GameManager</strong></span>, there's no longer a State Machine, nor any data that was part <a id="id374" class="indexterm"></a>of the State Machine. However, by calling <code class="literal">Application.LoadedLevel("Scene0")</code>, <span class="strong"><strong>Scene0</strong></span> is loaded. Whenever <span class="strong"><strong>Scene0</strong></span> is loaded, a new <span class="strong"><strong>GameManager</strong></span> with attached <code class="literal">StateManager</code> is created because it's part of the <span class="strong"><strong>Hierarchy</strong></span> of <span class="strong"><strong>Scene0</strong></span>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note59"></a>Note</h3><p>Everything in a <span class="strong"><strong>Hierarchy</strong></span> is created when a <span class="strong"><strong>Scene</strong></span> is loaded.</p></div><p>So why wasn't a new <span class="strong"><strong>GameManager</strong></span> created the other times <span class="strong"><strong>Scene0</strong></span> was loaded, such as winning or losing in <span class="strong"><strong>Scene1</strong></span> or <span class="strong"><strong>Scene2</strong></span>? Actually, it was created but it was immediately destroyed since we already had a <span class="strong"><strong>GameManager</strong></span>. See the <code class="literal">Awake()</code> method in <code class="literal">StateManager</code>. This was discussed in <a class="link" href="#" linkend="ch08">Chapter 8</a>, <span class="emphasis"><em>Developing the State Machine</em></span>.</p><p>You may be wondering if the <span class="strong"><strong>GameManager</strong></span> is destroyed and the State Machine with it, then how could <code class="literal">Application.LoadedLevel("Scene0")</code> be called? Needless to say, I could have put this method before calling <code class="literal">Destroy()</code>, but it doesn't make any difference.</p><p>The GameObject isn't destroyed immediately. Look up <span class="strong"><strong>Destroy</strong></span> in the <span class="strong"><strong>Scripting Reference</strong></span> and you'll see this phrase:</p><div class="blockquote"><blockquote class="blockquote"><p>Actual object destruction is always delayed until after the current Update loop, but will always be done before rendering.</p></blockquote></div><p>I can hear you saying that "<code class="literal">Restart()</code> isn't part of <code class="literal">Update()</code>." Actually it is. What called <code class="literal">Restart()</code>? We'll pick one of the three, <code class="literal">WonStateScene2</code>.</p><p>Here's the section of code calling <code class="literal">Restart()</code>:</p><div class="informalexample"><pre class="programlisting">public void StateUpdate()
{
  if (Input.GetKeyUp (KeyCode.Space)) 
  {
    manager.Restart();
  }</pre></div><p>The <code class="literal">Restart()</code> method is called in the <code class="literal">StateUpdate()</code> method, and what calls the <code class="literal">StateUpdate()</code> method? The <code class="literal">StateManager</code> does in the <code class="literal">Update()</code> method<a id="id375" class="indexterm"></a>:</p><div class="informalexample"><pre class="programlisting">void Update()
{
  if (activeState != null)
    activeState.StateUpdate();
}</pre></div><p>As far as Unity is concerned, all this code execution happened in the <code class="literal">Update()</code> method. So once everything is finished executing as a result of <code class="literal">Update()</code> being called, the <span class="strong"><strong>GameManager</strong></span> is then destroyed. So <code class="literal">Application.LoadLevel("Scene0")</code> was called and executed before<a id="id376" class="indexterm"></a> the <span class="strong"><strong>GameManager</strong></span> and the State Machine were destroyed.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note60"></a>Note</h3><p>I didn't forget <code class="literal">PlayStateScene1_2</code>. This State will be used in <a class="link" href="#" linkend="ch10">Chapter 10</a>, <span class="emphasis"><em>Moving Around, Collisions, and Keeping Score</em></span>.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec140"></a>Add a Player GameObject</h3></div></div></div><p>We need to add a GameObject named <code class="literal">Player</code> to this game. You may use any similar shaped GameObject of your choice that you have available, or simply use a GameObject such as a <span class="strong"><strong>Cube</strong></span> added from the <a id="id377" class="indexterm"></a>
<span class="strong"><strong>GameObject</strong></span> menu. The important part is that it be named <code class="literal">Player</code>.</p><p>It is going to behave like a hovercraft in the play States, so it floats above the terrain or any GameObject. In <code class="literal">SetupState,</code> we'll spin it around, select a color for it to use during the game, and set the allowed number of <code class="literal">Lives</code>.</p><p>In the following picture, on the left is the <span class="strong"><strong>Player</strong></span> that was created using a flattened <span class="strong"><strong>Cube</strong></span>, and a slightly stretched <span class="strong"><strong>Sphere</strong></span>.</p><p>The <span class="strong"><strong>Cube</strong></span> scale settings are <code class="literal">2</code>, <code class="literal">0.5</code>, <code class="literal">3</code>. The <span class="strong"><strong>Sphere</strong></span> scale settings are <code class="literal">0.32</code>, <code class="literal">1.3</code>, <code class="literal">0.35</code>. The <span class="strong"><strong>Sphere</strong></span> is a child of the <span class="strong"><strong>Cube</strong></span>. <span class="strong"><strong>Cube</strong></span> is renamed to <span class="strong"><strong>Player</strong></span>. Naming it <span class="strong"><strong>Player</strong></span> is required to have it work with the code.</p><p>On the right is a simple model I'll use just because it looks a little bit nicer than a floating brick. The model used isn't that important. The purpose of this model and the whole game is to study the C# code we will be writing.</p><div class="mediaobject"><img src="/graphics/9781849696586/graphics/6586OT_09_03.jpg" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch09lvl3sec08"></a>Placing and using the Player Collider</h4></div></div></div><p>The <span class="strong"><strong>Box Collider of Player</strong></span> is actually moved below <span class="strong"><strong>Player</strong></span> so the collider can detect when it collides with the terrain. The <span class="strong"><strong>Is Trigger</strong></span> property is checked. This makes a collider only detect when it <a id="id378" class="indexterm"></a>collides with another collider instead of bouncing off it.</p><p>When it does detect colliding <a id="id379" class="indexterm"></a>with any other collider such as the terrain or any other GameObject, <span class="strong"><strong>Player</strong></span> will slowly rise up higher to get over it because vertical force is applied to <span class="strong"><strong>Player</strong></span> whenever the collider is triggered.</p><p>The collider is extended a bit to the front and rear so as it moves, <span class="strong"><strong>Player</strong></span> can rise in advance to go over small changes in the terrain, or other small GameObjects.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch09lvl3sec09"></a>Placing and using the Sphere Collider</h4></div></div></div><p>First thing to notice is that the <span class="strong"><strong>Sphere</strong></span> isn't using a <span class="strong"><strong>Sphere Collider</strong></span>, it's using a <span class="strong"><strong>Box Collider</strong></span> instead. Since the <span class="strong"><strong>Player Box Collider</strong></span> is being used for hovering, I used a <span class="strong"><strong>Box Collider</strong></span> on the <span class="strong"><strong>Sphere</strong></span> for <span class="strong"><strong>Player</strong></span> to actually collide with other GameObjects, and also to prevent <span class="strong"><strong>Player</strong></span> from ever falling through the terrain.</p></div></div></div>