<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec83"></a>Time for action â€“ modify StateManager</h2></div></div><hr /></div><p>Edit the <code class="literal">StateManager</code> class to use the <code class="literal">IStateBase</code> interface. This allows the <code class="literal">activeState</code> variable to store all of the State class objects. Also add the code that does the switching to the next State:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Modify <a id="id292" class="indexterm"></a>
<code class="literal">StateManager</code> as shown in the next screenshot.</p></li><li><p>Remove the <code class="literal">Debug.Log</code> statement.</p></li><li><p>Save all files.</p></li><li><p>In Unity click on <span class="strong"><strong>Play</strong></span>.</p></li><li><p>Now press the Space bar key to cycle through the States.</p><div class="mediaobject"><img src="/graphics/9781849696586/graphics/6586OT_08_07.jpg" /></div></li></ol></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec118"></a>
<span class="emphasis"><em>What just happened?</em></span>
</h3></div></div></div><p>The following is the output to the <span class="strong"><strong>Console</strong></span> as you repeatedly press the Space bar key:</p><div class="mediaobject"><img src="/graphics/9781849696586/graphics/6586OT_08_08.jpg" /></div><p>The State Machine starts with <code class="literal">BeginState</code> being active. Pressing the Space bar key makes <code class="literal">PlayState</code> the active State. Pressing the Space bar again makes <code class="literal">WonState</code> the active State, and then pressing<a id="id293" class="indexterm"></a> the Space bar key once more makes <code class="literal">BeginState</code> active again.</p><p>We now have a working State Machine. For the benefits a State Machine provides, there isn't much code involved to changing States.</p><p>Let us follow the code flow for switching States:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>There are no States<a id="id294" class="indexterm"></a> created as of yet</p></li><li style="list-style-type: disc"><p>The <code class="literal">StateManager</code> script is a Unity script, therefore Unity instantiates (creates) the <code class="literal">StateManager</code> Component object</p></li></ul></div><p>On <code class="literal">StateManager</code>:</p><p>Line 7: <code class="literal">private IStateBase activeState;</code>
</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">activeState</code> variable will store a reference to a State which is an <code class="literal">IStateBase</code> type of object</p></li><li style="list-style-type: disc"><p>The <code class="literal">activeState</code> variable currently has a value of null, meaning there is no reference to a State object stored yet</p></li></ul></div><p>Line 9: <code class="literal">void Start()</code>
</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Unity then calls the <code class="literal">Start()</code> method, executing line 11</p></li></ul></div><p>Line 11: <code class="literal">activeState = new BeginState(this);</code>
</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">new</code> keyword instantiates the <code class="literal">BeginState</code> object</p></li><li style="list-style-type: disc"><p>The <code class="literal">BeginState()</code> constructor method is called, and passes the argument <code class="literal">this</code> to the <code class="literal">BeginState</code> constructor</p></li><li style="list-style-type: disc"><p>The <code class="literal">this</code> keyword is a reference to this object, which is the <code class="literal">StateManager</code> Component object</p></li><li style="list-style-type: disc"><p>
<code class="literal">BeginState</code>
<a id="id295" class="indexterm"></a> is receiving a reference to the <code class="literal">StateManager</code> object at line 11</p></li></ul></div><p>On <code class="literal">BeginState</code>:</p><p>Line 10: <code class="literal">public BeginState(StateManager managerRef)</code>
</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>This is the constructor for initializing member variables</p></li><li style="list-style-type: disc"><p>The parameter variable <code class="literal">managerRef</code> is assigned the reference of the <code class="literal">StateManager</code> object</p></li></ul></div><p>Line 12: <code class="literal">manager = managerRef;</code>
</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">StateManager</code> reference that is stored in <code class="literal">managerRef</code>, is assigned to the member variable <code class="literal">manager</code> that was declared on line 8</p></li></ul></div><p>Line 8: <code class="literal">private StateManager manager;</code>
</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The variable <code class="literal">manager</code> stores a <code class="literal">StateManager</code> type of object</p></li><li style="list-style-type: disc"><p>Every time a new State is created, <code class="literal">manager</code> stores a reference of the <code class="literal">StateManager</code> class, because each State needs to be able to call the <code class="literal">SwitchState()</code> method on <code class="literal">StateManager</code>
</p></li></ul></div><p>Line 13: <code class="literal">Debug.Log("Constructing BeginState");</code>
</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>This simply sends a text message to the Unity <span class="strong"><strong>Console</strong></span>
</p></li><li style="list-style-type: disc"><p>This is needed temporarily so we can see the States changing when we press the Space bar key</p></li><li style="list-style-type: disc"><p>The code block is now finished</p></li><li style="list-style-type: disc"><p>Code flow now jumps back to the place that had called this <code class="literal">BeginState</code> constructor method, which was <code class="literal">StateManager</code> line 11</p></li></ul></div><p>On <code class="literal">StateManager</code>:</p><p>Line 11: <code class="literal">activeState = new BeginState(this);</code>
</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">BeginState</code> object has been created and initialized</p></li><li style="list-style-type: disc"><p>A reference of the <code class="literal">BeginState</code> object is now assigned to the member variable <code class="literal">activeState</code>
</p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note49"></a>Note</h3><p>At this point, <code class="literal">BeginState</code> is now the active State.</p></div><p>Line 14: <code class="literal">void Update()</code>
</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>This method is called every frame by Unity to execute its code block</p></li></ul></div><p>Line 16: <code class="literal">if(activeState != null)</code>
</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>This <code class="literal">if</code> statement says that if the value in <code class="literal">activeState</code> is not equal to null, then execute</p></li><li style="list-style-type: disc"><p>Its checking <a id="id296" class="indexterm"></a>to see if the variable <code class="literal">activeState</code> is storing a reference to a State object</p></li><li style="list-style-type: disc"><p>If it isn't, the value stored will be null, like it was when we first clicked on <span class="strong"><strong>Play</strong></span>
</p></li><li style="list-style-type: disc"><p>Since <code class="literal">activeState</code> is now storing a reference to <code class="literal">BeginState</code>, this <code class="literal">if</code> statement is true</p></li></ul></div><p>Line 17: <code class="literal">activeState.StateUpdate();</code>
</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Using Dot Syntax, the <code class="literal">StateUpdate</code>() method on <code class="literal">BeginState</code> is called every frame</p></li><li style="list-style-type: disc"><p>The code flow now jumps to line 16 of <code class="literal">BeginState</code>
</p></li></ul></div><p>On <code class="literal">BeginState</code>:</p><p>Line 16: <code class="literal">public void StateUpdate()</code>
</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>This method is called every frame by the <code class="literal">StateManager</code>
</p></li><li style="list-style-type: disc"><p>There is no game to control yet, nor any game generated events</p></li><li style="list-style-type: disc"><p>Therefore, we are simply checking for a press of the Space bar key to change to another State</p></li></ul></div><p>Line 18: <code class="literal">if(Input.GetKeyUp(KeyCode.Space)</code>
</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Unity is checking whether we have pressed the Space bar key</p></li><li style="list-style-type: disc"><p>When we do, then the the code block is executed</p></li></ul></div><p>Line 20: <code class="literal">manager.SwitchState(new PlayState (manager));</code>
</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The Dot Syntax is used to call the <code class="literal">SwitchState()</code> method on <code class="literal">StateManager</code> line 20</p></li><li style="list-style-type: disc"><p>The variable <code class="literal">manager</code> stores a reference to <code class="literal">StateManager</code>
</p></li><li style="list-style-type: disc"><p>The argument new <code class="literal">PlayState(manager)</code> is being passed to the <code class="literal">SwitchState()</code> method<a id="id297" class="indexterm"></a>
</p></li><li style="list-style-type: disc"><p>Similar to when <code class="literal">BeginState</code> was instantiated, here we have a new <code class="literal">PlayState</code> object being instantiated by using the <code class="literal">new</code> keyword</p></li><li style="list-style-type: disc"><p>Similar to the <code class="literal">BeginState()</code> constructor method, the <code class="literal">PlayState()</code> constructor method takes a parameter of a reference to <code class="literal">StateManager</code>, which is stored in the member variable <code class="literal">manager</code>
</p></li><li style="list-style-type: disc"><p>Code flow now jumps to line 10 of <code class="literal">PlayState</code> to initialize it's member variables</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note50"></a>Note</h3><p>The code flow logic for line 10 of <code class="literal">PlayState</code> is the same as line 10 of <code class="literal">BeginState</code>.</p></div></li><li style="list-style-type: disc"><p>The argument<a id="id298" class="indexterm"></a> <code class="literal">new PlayState(manager)</code> is now a reference to the new <code class="literal">PlayState</code> object just created</p></li><li style="list-style-type: disc"><p>It is this <code class="literal">PlayState</code> reference that is actually passed to the <code class="literal">SwitchState()</code> method on <code class="literal">StateManager</code>
</p></li><li style="list-style-type: disc"><p>Code flow now jumps to <code class="literal">StateManager</code> line 20</p></li></ul></div><p>On <code class="literal">StateManager</code>:</p><p>Line 20: <code class="literal">public void SwitchState(IStateBase newState)</code>
</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The parameter takes the <code class="literal">PlayState</code> object reference and assigns it to the variable <code class="literal">newState</code>
</p></li><li style="list-style-type: disc"><p>This variable stores an <code class="literal">IStateBase</code> type of object</p></li><li style="list-style-type: disc"><p>Remember, all States implement the <code class="literal">IStateBase</code> interface</p></li></ul></div><p>Line 22: <code class="literal">activeState = newState;</code>
</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">PlayState</code> reference stored in <code class="literal">newState</code> is now assigned to <code class="literal">activeState</code>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note51"></a>Note</h3><p>At this point, <code class="literal">PlayState</code> is now the active State.</p></div></li></ul></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch08lvl4sec02"></a>Summarizing the code flow</h4></div></div></div><p>I did a lot of explaining,<a id="id299" class="indexterm"></a> but there were just the following basic things that took place after clicking on <span class="strong"><strong>Play</strong></span>:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>The <code class="literal">StateManager</code> object instantiated a <code class="literal">BeginState</code> object and stored its reference in <code class="literal">activeState</code>.</p></li><li><p>The <code class="literal">BeginState</code> object waited for us to press the Space bar key to switch States.</p></li><li><p>The <code class="literal">BeginState</code> object instantiated a <code class="literal">PlayState</code> object and told <code class="literal">StateManager</code> to store the <code class="literal">PlayState</code> class reference in <code class="literal">activeState</code>.</p></li></ol></div><p>Note that steps 2 and 3 just repeat for switching to any State, no matter how many you have.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec119"></a>Adding another State</h3></div></div></div><p>You've probably noticed <a id="id300" class="indexterm"></a>we haven't used <code class="literal">LostState</code>. Let's see how easy it is to include another State.</p></div></div>