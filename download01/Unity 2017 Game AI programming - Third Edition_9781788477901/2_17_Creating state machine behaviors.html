<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec24"></a>Creating state machine behaviors</h2></div></div><hr /></div><p>Now that we're familiar with the concept of a state machine, let's get our hands dirty and start <span>implementing</span><a id="id288183627" class="indexterm"></a> our very own.</p><p>As of Unity 2017.1, state machines are still part of the animation system, but worry not, they are flexible and no animations are actually required to implement them. Don't be alarmed or confused if you see code referencing the <code class="literal">Animator</code> component or the <code class="literal">AnimationController</code> asset as it's merely a quirk of the current implementation. It's possible that Unity will address this in a later version, but the concepts will likely not change.</p><p>Let's fire up Unity, create a new project, and get to it.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec8"></a>Creating the AnimationController asset</h3></div></div></div><p>The <code class="literal">AnimationController</code> asset is a type of asset within Unity that handles <span>states</span><a id="id288320086" class="indexterm"></a> and transitions. It is, in essence, an FSM, but it also does much more. We'll focus on the FSM portion of its functionality. An animator controller can be created from the <strong class="userinput"><code>Assets</code></strong> menu, as shown in the following image:</p><div class="mediaobject"><img src="/graphics/9781788477901/graphics/b727a1f5-0b79-431b-8f2d-ebfe1b26c976.png" /></div><p>Once you create the animator controller, it will pop up in your project assets folder, ready to be named. We'll name it <code class="literal">TankFsm</code>. When you select the animator controller, unlike most other asset types, the hierarchy is blank. That is because animation controllers use their own window. You can simply click on <strong class="userinput"><code>Open</code></strong> in the hierarchy to <span>open</span><a id="id288320117" class="indexterm"></a> up the <strong class="userinput"><code>Animator</code></strong> window, or open it in the <strong class="userinput"><code>Window</code></strong> menu, as you can see in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781788477901/graphics/ff3f7cca-cb60-413a-813f-7d1c97268c3a.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip4"></a>Note</h3><p>Be sure to select <strong class="userinput"><code>Animator</code></strong> and not <strong class="userinput"><code>Animation</code></strong> as these are two different windows and features entirely.</p></div><p>Let's familiarize ourselves with this window before moving forward.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec9"></a>Layers and parameters</h3></div></div></div><p>Layers, as the name implies, allow us to stack different state <span>machine</span><a id="id288559463" class="indexterm"></a> levels on top of each other. This panel allows us to organize the layers easily and have a visual representation. We will not be doing much in this panel for now as it primarily relates to animation, but it's good to be familiar with it. Refer to the following screenshot of the window to find your way around the layers:</p><div class="mediaobject"><img src="/graphics/9781788477901/graphics/695f5374-b50e-4726-89f0-8e054f65ce26.png" /></div><p>Here is a summary of the items shown in the previous screenshot:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Add layer</strong></span>: The <strong class="userinput"><code>+</code></strong> button creates a new layer at the bottom of the list.</li><li style="list-style-type: disc"><span class="strong"><strong>Layer list</strong></span>: These are the layers currently inside the animator controller. You can click to select a layer and drag and drop layers to rearrange them.</li><li style="list-style-type: disc"><span class="strong"><strong>Layer settings</strong></span>: The gear icon brings up a menu to edit animation-specific settings for the layer.</li></ul></div><p>Second, we have the <strong class="userinput"><code>Parameters</code></strong> panel, which is far more relevant to our use of the animator controller. Parameters are <span>variables</span><a id="id288320210" class="indexterm"></a> that determine when to transition between states, and we can access them via scripts to drive our states. There are four types of parameters—<code class="literal">float</code>, <code class="literal">int</code>, <code class="literal">bool</code>, and <code class="literal">trigger</code>. You should already be familiar with the first three as they are primitive types in C#, but <code class="literal">trigger</code> is specific to the animator controller, not to be confused with physics triggers, which do not apply here. Triggers are just a means to trigger a transition between states explicitly.</p><p>The following screenshot shows the elements in the <strong class="userinput"><code>Parameters</code></strong> panel:</p><div class="mediaobject"><img src="/graphics/9781788477901/graphics/6f4ffc8c-9fd0-4fd4-a748-646c9333d431.png" /></div><p>Here is a summary of the items depicted in the previous screenshot:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Search</strong></span>: We can quickly search through our parameters here. Simply type in the name and the list will populate with the search results.</li><li style="list-style-type: disc"><span class="strong"><strong>Add parameter</strong></span>: This button lets you add new parameters. When you click on it, you must select the parameter type.</li><li style="list-style-type: disc"><span class="strong"><strong>Parameter list</strong></span>: This is the list of parameters you've created. You can assign and view their values here. You can also reorder the parameters to your liking by dragging and dropping them in the correct order. This is merely for organization and does not affect functionality at all.</li></ul></div><p>Lastly, there is an eyeball icon, which you can click to hide the <strong class="userinput"><code>Layers</code></strong> and <strong class="userinput"><code>Parameters</code></strong> panels altogether. When the panels are closed, you can still create new layers by clicking on the <strong class="userinput"><code>Layers</code></strong> dropdown and selecting <strong class="userinput"><code>Create New Layer</code></strong>:</p><div class="mediaobject"><img src="/graphics/9781788477901/graphics/3e22cfb1-47be-4ba6-9793-5d74545a2410.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec10"></a>The animation controller inspector</h3></div></div></div><p>The <span>animation</span><a id="id288320300" class="indexterm"></a> controller inspector is slightly different from the regular inspector found throughout Unity. While the regular inspector allows you to add components to the game objects, the animation controller inspector has a button labeled <strong class="userinput"><code>A</code></strong><strong class="userinput"><code>dd Behaviour</code></strong>, which allows you to add a <code class="literal">StateMachineBehaviour</code> to it. This is the main distinction between the two types of inspectors, but apart from this, it will display the serialized information for any selected state, substate, transition, or blend tree, just as the regular inspector displays the data for the selected game object and its components.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec11"></a>Bringing behaviors into the picture</h3></div></div></div><p>State machine <span>behaviors</span><a id="id288320357" class="indexterm"></a> are a unique, new concept in Unity 5. While states existed, conceptually, in the original implementation of Mecanim, transitions were handled behind the scenes and you did not have much control over what happened upon entering, transitioning, or exiting a state. Unity 5 addressed this issue by introducing behaviors; they provide the built-in functionality to handle typical FSM logic.</p><p>Behaviors are sly and tricky. Though their name might lead you to believe they are related to <code class="literal">MonoBehaviour</code>, do not fall for it; if anything, these two are distant cousins at best. In fact, behaviors derive from <code class="literal">ScriptableObject</code>, not <code class="literal">MonoBehaviour</code>, so they exist only as assets, which cannot be placed in a scene or added as components to a <code class="literal">GameObject</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec12"></a>Creating our very first state</h3></div></div></div><p>Okay, so the header is not entirely true since Unity creates a few <span>default</span><a id="id288320385" class="indexterm"></a> states for us in our animator controller—<strong class="userinput"><code>New State</code></strong>, <strong class="userinput"><code>Any State</code></strong>, <strong class="userinput"><code>Entry</code></strong>, and <strong class="userinput"><code>Exit</code></strong>—but let's just agree that those don't count for now, okay? Let's take a look at some of the things we can do in our newly-created animation controller:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">You can select states in this window by clicking on them, and you can move them by dragging and dropping them anywhere in the canvas.</li><li style="list-style-type: disc">Select the state named <strong class="userinput"><code>New State</code></strong> and delete it by either right-clicking and then clicking on <strong class="userinput"><code>Delete</code></strong> or simply hitting the <span class="emphasis"><em><span class="strong"><strong>Delete</strong></span></em></span> key on your keyboard.</li><li style="list-style-type: disc">If you select the <strong class="userinput"><code>Any State</code></strong> state, you'll notice that you do not have the option to delete it. The same is true for the <strong class="userinput"><code>Entry</code></strong> state. These are required states in an animator controller and have unique uses, which we'll cover up ahead:</li></ul></div><div class="mediaobject"><img src="/graphics/9781788477901/graphics/bf672253-6bac-4ff3-9db6-a04bf200f060.png" /></div><p>To create our (true) first state, right-click anywhere on the canvas and then select <strong class="userinput"><code>Create State</code></strong>, which opens up a few options, from which we'll select <strong class="userinput"><code>Empty</code></strong>. The other two options, <strong class="userinput"><code>From Selected Clip</code></strong> and <strong class="userinput"><code>From New Blend Tree</code></strong>, are not immediately applicable to our project, so we'll skip these. Now we've officially created our first state.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec13"></a>Transitioning between states</h3></div></div></div><p>You'll notice that upon creating our state, an arrow is created connecting the <strong class="userinput"><code>Entry</code></strong> state to it, and that its node is orange. Unity will automatically set default states to look orange to differentiate them from other states. When you only have one state, it is automatically selected as the default state, and as such, it is automatically connected to the entry state. You can manually select which state is the default state by right-clicking on it and then clicking on <strong class="userinput"><code>Set as Layer Default State</code></strong>. It will then become orange, and the entry state will automatically connect itself to it. The connecting arrow is a <span class="strong"><strong>transition connector</strong></span>. Transition connectors allow us some control over how and when the <span>transition</span><a id="id288566410" class="indexterm"></a> occurs, but the connector from the entry state to the <span>default</span><a id="id288566417" class="indexterm"></a> state is unique in that it does not provide us with any options, since this transition happens automatically.</p><p>You can manually assign transitions between states by right-clicking on a state node and then selecting <strong class="userinput"><code>Make Transition</code></strong>. This will create a transition arrow from the state you selected to your mouse cursor. To select the destination of the transition, simply click on the destination node and that's it. Note that you cannot redirect the transitions though. We can only hope that the kind folks behind Unity add that functionality at a later point, but for now, you must remove a transition by selecting it and deleting it, and then assigning an all-new transition manually.</p></div></div>