<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec34"></a>The scriptable profiler tool</h2></div></div><hr /></div><p>The fact that developers <a id="id411" class="indexterm"></a>can use the Unity profiler for profiling their own code or certain pieces of code is very important. In order to display statistics information about some of your function or for some part of your code in the Unity profiler, you just need to include your code between two calls, <code class="literal">Profiler.BeginSample</code> and <code class="literal">Profiler.EndSample</code>. After that you can use the visual Unity profiler tool to search for bottlenecks and spikes in your code.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note23"></a>Note</h3><p>The profiler is only available in Unity Pro. In standalone games, the profiler can dump all profiling information using <code class="literal">Profiler.log</code> and <code class="literal">Profiler.enabled</code>.</p></div><p>To create your own tool, you can utilize the following Unity API calls:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<code class="literal">FindObjectsOfTypeAll</code>
</p></li><li style="list-style-type: disc"><p>
<code class="literal">FindObjectsOfType</code>
</p></li><li style="list-style-type: disc"><p>
<code class="literal">GetRuntimeMemorySize</code>
</p></li><li style="list-style-type: disc"><p>
<code class="literal">GetMonoHeapSize</code>
</p></li><li style="list-style-type: disc"><p>
<code class="literal">GetMonoUsedSize</code>
</p></li><li style="list-style-type: disc"><p>
<code class="literal">Profiler.BeginSample</code>
</p></li><li style="list-style-type: disc"><p>
<code class="literal">Profiler.EndSample</code>
</p></li><li style="list-style-type: disc"><p>
<code class="literal">UnloadUnusedAssets</code>
</p></li><li style="list-style-type: disc"><p>
<code class="literal">System.GC.GetTotalMemory</code>
</p></li><li style="list-style-type: disc"><p>
<code class="literal">Profiler.usedHeapSize</code>
</p></li></ul></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec84"></a>Unity profiler tricks</h3></div></div></div><p>There is the capability to export the <a id="id412" class="indexterm"></a>profiling information to a binary file, which can then be imported again later. This is empowered through scripting by means of:</p><div class="informalexample"><pre class="programlisting">  function Start () {
        Profiler.logFile = "yourName.log";

        Profiler.enableBinaryLog = true; // writes to "yourName.log.data"

        Profiler.enabled = true;
  }</pre></div><p>And reimported into the profiler:</p><div class="informalexample"><pre class="programlisting">Profiler.AddFramesFromFile ("yourName.log");</pre></div><p>The API to get to the profiler frame information into the script is uncovered in:</p><div class="informalexample"><pre class="programlisting">UnityEditorInternal.ProfilerDriver</pre></div><p>Not documented, yet totally open in the <code class="literal">UnityEditorInternal</code> namespace. Other suitable APIs:</p><div class="informalexample"><pre class="programlisting">Profiler.BeginSample("Your Label Name");
Profiler.EndSample();
Profiler.GetRuntimeMemorySize(o : Object) : int</pre></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec85"></a>Creating a simple profiler</h3></div></div></div><p>Now is the time to develop <a id="id413" class="indexterm"></a>our own simple and very useful profiler tool from scratch. In the future, you will be able to use these scripts from our simple profiler for all of your projects as well as any other examples discussed in this book. Of course, you can modify all methods to meet your specific problem if you have a strong desire or if you have to do it, or you can use them all in their original form if this functionality will be enough for your tasks. First, let's look at a very simple class, which is a core class in our simple code profiler<a id="id414" class="indexterm"></a> tool. In the following code you can see a very simple <code class="literal">ExampleProfilerClass</code>:</p><p>Listing 1-3. ExampleProfilerClass.cs</p><div class="informalexample"><pre class="programlisting">using UnityEngine;

public class ExampleProfilerClass
{
  int counter = 0;
  
  float startedTime = 0;
  float totalTime = 0;
  float endTime = 0;
  float elapsedTime = 0;
  
  bool wasStartedFlag = false;
  
  public string indexStr;
  
  public float TotalTime {
    get { 
      return totalTime; 
    }
  }
  
  public int Counter {
    get { 
      return counter;
    }
  }
  
  public ExampleProfilerClass(string indexStr)
  {
    this.indexStr = indexStr;
  }

  void ShowError() {
    Debug.LogError("ExampleProfilerClass {START / END} ERROR: [index] = [" + indexStr + "]");  
  }
  
  public void Start() {
    if (wasStartedFlag) { 
      ShowError(); 
    }
    
    counter++;

    wasStartedFlag = true;

    startedTime = Time.realtimeSinceStartup;
  }
  
  public void End() {
    endTime = Time.realtimeSinceStartup;
    
    if (false == wasStartedFlag) { 
      ShowError(); 
    }
    
    wasStartedFlag = false;

    elapsedTime = (endTime - startedTime);

    totalTime += elapsedTime;
  }
  
  public void ClearStatistics() {
    wasStartedFlag = false;

    totalTime = 0;

    counter = 0;
  }
}</pre></div><p>You need to attach the <code class="literal">ExampleProfilerClass</code> script to one of the objects in your scene. The code is very<a id="id415" class="indexterm"></a> straightforward and simple, as are all the other examples in this book. The entire code of our profiler is shown in Listing 1-4:</p><p>Listing 1-4. SimpleProfiler.cs</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections.Generic;

public class SimpleProfiler : MonoBehaviour {
  float startedTime = 0;
  float followingTime = 1;
  float totalTimeInMilliSeconds = 0;
  float averageTimeInMilliSeconds = 0;
  float framesPerSecond = 0;
  float savedTimeInMilliSeconds = 0;
  float percentageSavedFromTotal = 0;
  float timeInMilliSecondsPerFrame = 0;
  float timeInMilliSecondsPerCall = 0;
  float callsNumberPerFrame = 0;

  int frameCount = 0;
  int colWidth = 30;

  static Dictionary&lt;string, ExampleProfilerClass&gt; statistics = new Dictionary&lt;string, ExampleProfilerClass&gt;();

  string profilerInfo = "ALREADY STARTED !";

  Rect windowRect = new Rect(25, 25, 800, 300);
  
  void Awake() {
    startedTime = Time.time;
  }
  
  void OnGUI() {
    GUI.Box(windowRect,"Simple Profiler");
    GUI.Label(windowRect, profilerInfo);
  }
  
  public static void Start(string indexStr) {
    if (false == statistics.ContainsKey(indexStr)) {
      statistics[indexStr] = new ExampleProfilerClass(indexStr);
    }
    
    statistics[indexStr].Start();
  }
  
  public static void End(string indexStr) {
    statistics[indexStr].End();
  }
  
  void Update() {
    frameCount++;
    
    if (Time.time &gt; followingTime)
    {
      profilerInfo = "\n\n\n";

      totalTimeInMilliSeconds = (Time.time - startedTime) * 1000;
      averageTimeInMilliSeconds = (totalTimeInMilliSeconds / frameCount);
      framesPerSecond = (1000 / (totalTimeInMilliSeconds / frameCount));

      profilerInfo += "Frames per Second: ";
      profilerInfo += framesPerSecond.ToString("0.#") + " frames; \nAverage Frame Time: ";
      profilerInfo += averageTimeInMilliSeconds.ToString("0.#") + " ms \n\n\n";
      profilerInfo += "Time Percentages".PadRight(colWidth);
      profilerInfo += "ms per Frame".PadRight(colWidth);
      profilerInfo += "ms per Call".PadRight(colWidth);
      profilerInfo += "Calls number per Frame".PadRight(colWidth);
      profilerInfo += "NameIndex";
      profilerInfo += "\n";
      
      foreach(ExampleProfilerClass statisticsRecord in statistics.Values)
      {
        savedTimeInMilliSeconds = (statisticsRecord.TotalTime * 1000);
        percentageSavedFromTotal = (savedTimeInMilliSeconds * 100) / totalTimeInMilliSeconds;
        callsNumberPerFrame = statisticsRecord.Counter / (float)frameCount;
        timeInMilliSecondsPerCall = savedTimeInMilliSeconds / statisticsRecord.Counter;
        timeInMilliSecondsPerFrame = savedTimeInMilliSeconds / frameCount;
        
        profilerInfo += (percentageSavedFromTotal.ToString("0.000") + "%").PadRight(colWidth);
        profilerInfo += (timeInMilliSecondsPerFrame.ToString("0.000") + " ms").PadRight(colWidth);
        profilerInfo += (timeInMilliSecondsPerCall.ToString("0.0000") + " ms").PadRight(colWidth);
        profilerInfo += (callsNumberPerFrame.ToString("0.000")).PadRight(colWidth);
        profilerInfo += (statisticsRecord.indexStr);
        profilerInfo += "\n";
        
        statisticsRecord.ClearStatistics();
      }
      
      frameCount = 0;

      startedTime = Time.time;

      followingTime = Time.time + 1;
    }   
  }
}</pre></div><p>The following is a simple<a id="id416" class="indexterm"></a> test code, which performs mathematical operations in a cycle. You can hang this script on any object (or on multiple objects simultaneously) in your scene, just for testing your <code class="literal">SimpleCodeProfiler</code> tool.</p><p>Listing 1-5. TestProfilerCode.cs</p><div class="informalexample"><pre class="programlisting">using UnityEngine;

public class TestProfilerCode : MonoBehaviour {
  float tmpFloat;

  void Update () {
    SimpleProfiler.Start("YOUR_UNIQUE_LABEL_1");

    for (int i = 0; i &lt; 10; i++) {
      for (int degree = 0; degree &lt; 360; degree++) {
        tmpFloat = Mathf.Cos(degree * Mathf.Deg2Rad);
      }
    }

    SimpleProfiler.End("YOUR_UNIQUE_LABEL_1");

    ///////////////////////////////////////////////////

    SimpleProfiler.Start("YOUR_UNIQUE_LABEL_2");
    
    for (int i = 0; i &lt; 50; i++) {
      for (int degree = 0; degree &lt; 180; degree++) {
        tmpFloat = Mathf.Sqrt(Mathf.Cos(degree * Mathf.Deg2Rad) + Mathf.Sin(degree * Mathf.Deg2Rad));
      }
    }
    
    SimpleProfiler.End("YOUR_UNIQUE_LABEL_2");
  }
}</pre></div></div></div>