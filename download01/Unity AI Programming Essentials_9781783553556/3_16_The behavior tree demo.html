<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec20"></a>The behavior tree demo</h2></div></div><hr /></div><p>Now that<a id="id67" class="indexterm"></a> we know about the different nodes we can use, we'll <a id="id68" class="indexterm"></a>create a demo that shows how to use the action and decision nodes. The demo will show how to have a character perform multiple tasks. We will have an entity, an enemy spaceship, patrolling an area, but only for a given amount of time; then, the ship will return to its home base. The steps for this example might seem overly complicated and we could do a similar AI ourselves without behavior trees with a simple script by hardcoding the different states. However, remember that behavior trees are easily extendible and scalable. With this demo, instead of two behaviors, we could take time to create a more complex character, going up to about 30 behaviors easily, but extending a script to do that would be pretty complicated and hard to maintain.</p><p>The start of this is similar to the pathfinding and patrol RAIN demos, except we will use a spaceship model instead of a walking character. You'll need to create a simple scene with a ship model (the examples have a <code class="literal">ship.blend</code> model you can use) and an object for the home base. The initial setup should look something like this:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_03_01.jpg" /></div><p>Then, add RAIN to the scene, create a waypoint route to patrol the block, create a navigation mesh, and add an AI to the ship. Remember that the ship model should not interfere with the navigation mesh creation; you can set it to a different layer, such as <span class="strong"><strong>Ignore Raycast</strong></span>, and then in RAIN's navigation mesh menu, deselect this layer from the <span class="strong"><strong>Included Layers </strong></span>dropdown:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_03_02.jpg" /><div class="caption"><p>The scene after performing the given steps</p></div></div><p>In the <a id="id69" class="indexterm"></a>AI for the ship, there is no behavior tree yet, so click on <a id="id70" class="indexterm"></a>the <span class="strong"><strong>Mind</strong></span> button in the RAIN menu (the little head icon) and then click on <span class="strong"><strong>Open Behavior Editor</strong></span> and create a new behavior tree called <code class="literal">ship</code>:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_03_03.jpg" /></div><p>Just like with the pathfinding demos, first we need to set up the behavior tree to have a basic waypoint route follow system. Under the root node in the behavior tree, we need to create a <span class="strong"><strong>waypointpatrol</strong></span> node and a <span class="strong"><strong>move</strong></span> node, with the <span class="strong"><strong>waypointpatrol </strong></span>node set to use our waypoint route and setting its move variable to the <span class="strong"><strong>move</strong></span> node. Do this by right-clicking on the root node and navigating to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Actions</strong></span> | <span class="strong"><strong>Choose Patrol Waypoints</strong></span>. Then, right-click on the new <span class="strong"><strong>waypointpatrol</strong></span> node and navigate to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Actions</strong></span> | <span class="strong"><strong>Move</strong></span>. Then, set the <span class="strong"><strong>waypointpatrol</strong></span> waypoint to <span class="strong"><strong>Patrol Route</strong></span> (with quotes), the <span class="strong"><strong>Move Target Variable</strong></span> field to move the target, and the <span class="strong"><strong>Repeat</strong></span> type to <span class="strong"><strong>Forever</strong></span>. The behavior tree should look like the following:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_03_04.jpg" /></div><p>We'll speed <a id="id71" class="indexterm"></a>up the ship movement, so select the <span class="strong"><strong>move</strong></span> node <a id="id72" class="indexterm"></a>and set the <span class="strong"><strong>Move Speed</strong></span> value to <code class="literal">5</code>.</p><p>When we run the demo now, the ship will patrol around the block, similar to our pathfinding demos. To extend this, we'll add an additional functionality of moving to a home base after a given number of seconds. However, two things need to be added to the scene before we make additions to the behavior tree. First, we need to create a navigation point for the home base so that the RAIN AI system can know where it is. In Unity, navigate to <span class="strong"><strong>RAIN</strong></span> | <span class="strong"><strong>Create Navigation Target</strong></span>. Rename both the GameObject and the target name in the RAIN menu for it to <span class="strong"><strong>gameBase</strong></span>, and place it under our cylinder that visualizes our game base. This creates a new point RAIN can navigate to:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_03_05.jpg" /></div><p>For our character logic, as we said we will have the entity patrol for a given number of seconds, then return to the home base. We'll use a Boolean variable to track whether the patrolling is done, but instead of just storing the variable in a script, we will have RAIN's memory system to store it. The memory for a character is what it <span class="emphasis"><em>remembers</em></span> or <span class="emphasis"><em>knows</em></span>. It is a way to store values that will be accessible to the other AI systems on a character. The possible values <a id="id73" class="indexterm"></a>for memory are basic primitive variables<a id="id74" class="indexterm"></a> such as <code class="literal">bool</code>, <code class="literal">int</code>, <code class="literal">float</code>, or <code class="literal">vector</code>, for example, <code class="literal">Vector2</code>, <code class="literal">Vector3</code>, <code class="literal">Vector4</code>, or a GameObject. We'll use two memory variables for this demo. Select the AI component of the ship and click on the <span class="strong"><strong>Memory</strong></span> icon, which looks like a little light bulb, which you can see in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_03_06.jpg" /></div><p>Then, add two variables for the memory. The first is a Boolean called <span class="strong"><strong>donePatrolling</strong></span>, which will initially be <code class="literal">false</code> but will become <code class="literal">true</code> when the 5-second timer runs out, signaling the ship to return to the base. The second is a GameObject variable that will store the navigation waypoint for the game base. Create <span class="strong"><strong>gameBase</strong></span> and set it to the game base GameObject.</p><p>Now that we have a memory set up, we can start modifying our behavior tree. We already have part of the behavior tree set up that patrols the waypoint route. So, as a next step, we will only let the ship continue to patrol if our <span class="strong"><strong>donePatrolling</strong></span> Boolean variable is <code class="literal">false</code>. Add a constraint node above the <span class="strong"><strong>waypointpatrol</strong></span> node. The recall constraint is the node that uses a logical expression and can evaluate success or failure. Add the <code class="literal">donePatrolling == false</code> line to the constraint field in the <span class="strong"><strong>Constraint</strong></span> node. The <span class="strong"><strong>Constraint</strong></span> node will look like this:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_03_07.jpg" /></div><p>The little <span class="strong"><strong>e</strong></span> symbol<a id="id75" class="indexterm"></a> in the <span class="strong"><strong>Constraint</strong></span> field means that it can<a id="id76" class="indexterm"></a> take an expression, a one-line statement. This is done for simple checks and saves us from writing the code for a custom action node. Besides the basic Boolean test in this example, many other simple expressions can be created, for example, if we had an integer for an enemy's ammo amount, it can do a check to see how much ammo the character has, and if it is empty, it can stop attacking and instead go get more ammo. We can also have a check on an entity's health or HP, and if it's too low, a character can run away instead of fighting with the player. However, let's get back to our demo.</p><p>If we run the demo now, the ship will behave the same as before, but if we go into the memory for the character and change <span class="strong"><strong>donePatrolling</strong></span> to true, the ship will do nothing when we start the demo:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_03_08.jpg" /></div><p>The check<a id="id77" class="indexterm"></a> in the preceding screenshot shows the <span class="strong"><strong>Constraint</strong></span> node<a id="id78" class="indexterm"></a> in action; however, go ahead and change the value of <span class="strong"><strong>donePatrolling</strong></span> back to false.</p><p>Our additional logic for the ship's behavior tree is to return home after 5 seconds of patrolling. While the ship is patrolling, we want a timer running to 5 seconds. When the timer is complete, the <span class="strong"><strong>donePatrolling</strong></span> variable will be set to <code class="literal">false</code>, stopping the patrol and the ship will start to move back to the <span class="strong"><strong>gameBase</strong></span> navigation point. The first step for this is to right-click on the root node and navigate to <span class="strong"><strong>Switch To</strong></span> | <span class="strong"><strong>Parallel</strong></span>. Then, create a new sequencer node and add it to the root. The tree should look like this:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_03_09.jpg" /></div><p>With the parallel node at every update, both of its children will be updated, allowing us to continue patrolling while we have a timer running. We want two things to happen if <span class="strong"><strong>donePatrolling</strong></span> is <code class="literal">false</code>: the ship should continue to patrol and the timer should start to run. RAIN<a id="id79" class="indexterm"></a> supports copying and pasting of nodes, so right-click<a id="id80" class="indexterm"></a> on the <span class="strong"><strong>Constraint</strong></span> node and select <span class="strong"><strong>Copy</strong></span>, then right-click on the <span class="strong"><strong>sequencer</strong></span> node and click on <span class="strong"><strong>Paste</strong></span>. The node will be copied with its children, so delete the newly copied <span class="strong"><strong>waypointpatrol</strong></span> and the <span class="strong"><strong>move</strong></span> node. Then, add a <span class="strong"><strong>timer</strong></span> action node below the second <span class="strong"><strong>Constraint</strong></span> node, and set the time to 5 seconds. Now, the screen should look like this:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_03_10.jpg" /></div><p>After the <span class="strong"><strong>timer</strong></span> node, we need a node that will set the <span class="strong"><strong>donePatrolling</strong></span> variable to <code class="literal">true</code>. We can do this using an <span class="strong"><strong>expression</strong></span> node and using its <span class="strong"><strong>Expression</strong></span> value to set <span class="strong"><strong>donePatrolling</strong></span> to <code class="literal">true</code>. We use as shown in the next screenshot:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_03_11.jpg" /></div><p>However, the <a id="id81" class="indexterm"></a>ability to customize AI nodes is important, so<a id="id82" class="indexterm"></a> instead of using an <span class="strong"><strong>expression</strong></span> node again, we will use a <span class="strong"><strong>Custom Action</strong></span> node. To create a <span class="strong"><strong>Custom Action</strong></span> node, right-click on the lower <span class="strong"><strong>Constraint</strong></span> node and navigate to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Actions</strong></span> | <span class="strong"><strong>Custom Action</strong></span>. Change the name of the node (via the name field in the node editor) to <span class="strong"><strong>StopPatrolling</strong></span>. For the <span class="strong"><strong>Class</strong></span> value, choose <span class="strong"><strong>Create Custom Action</strong></span>. The following screenshot will guide you through:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_03_12.jpg" /></div><p>Set the name of <span class="strong"><strong>Custom Action Name</strong></span> to <span class="strong"><strong>StopPatrolling</strong></span> and leave the script type to <span class="strong"><strong>C Sharp</strong></span>. Then, close<a id="id83" class="indexterm"></a> the behavior tree editor and open<a id="id84" class="indexterm"></a> the <code class="literal">StopPatrolling.cs</code> script from <span class="strong"><strong>Assets</strong></span> | <span class="strong"><strong>AI</strong></span> | <span class="strong"><strong>Actions</strong></span>. The script contains an outline for an action that the user can define. The code is as follows:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;
using System.Collections.Generic;
using RAIN.Core;
using RAIN.Action;

[RAINAction]
public class StopPatrolling : RAINAction
{
    public StopPatrolling()
    {
        actionName = "StopPatrolling";
    }

    public override void Start(AI ai)
    {
        base.Start(ai);
    }

    public override ActionResult Execute(AI ai)
    {
        return ActionResult.SUCCESS;
    }

    public override void Stop(AI ai)
    {
        base.Stop(ai);
    }
}</pre></div><p>This contains the three basic methods you would expect to see in an action: one to call when the action is started, another when it is stopped, and an <code class="literal">Execute</code> method that is called when <a id="id85" class="indexterm"></a>running the action that returns the state of the action node: success, failure, or running. With this outline, you can create all kinds of custom actions, but for now, all you need to do is set the <code class="literal">donePatrolling</code> variable in the memory to <code class="literal">true</code>. Change the <code class="literal">Start</code> method to the following:</p><div class="informalexample"><pre class="programlisting">public override void Start(AI ai)
{
     base.Start(ai);

     ai.WorkingMemory.SetItem("donePatrolling", true);
}</pre></div><p>This code does what we need, setting the <code class="literal">donePatrolling</code> variable to <code class="literal">true</code>. The AI object in this code, just called <code class="literal">ai</code>, is the AI for the character. It contains access to various AI classes, such as the AI's mind<a id="id86" class="indexterm"></a> and senses. Here, we access <code class="literal">WorkingMemory</code> and<a id="id87" class="indexterm"></a> can get the different memory items as well as set values for them. That is all the action needs to do so that <code class="literal">ActionResult</code> can leave returning success.</p><p>If we run the project now, we should see the ship patrol for 5 seconds, but instead of moving back to the game base, the ship just stops. The last thing we need to add is a <span class="strong"><strong>move</strong></span> node to the home base. Set the move target to <span class="strong"><strong>"gameBase"</strong></span> (RAIN requires the quotes), and as we want the ship to return home faster than it patrols, change the speed to <code class="literal">10</code>. And since we want the ship to stop as soon as it is near the base, change the <span class="strong"><strong>Repeat</strong></span> dropdown to <span class="strong"><strong>Until Success</strong></span> and set a <span class="strong"><strong>Close Enough</strong></span> distance to <code class="literal">0.1</code>. This will make the ship go to the <span class="strong"><strong>gameBase</strong></span> target and stop. The screen should look as shown:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_03_13.jpg" /></div><p>If we run the<a id="id88" class="indexterm"></a> demo now, the ship will patrol for 5 seconds and<a id="id89" class="indexterm"></a> then just stop again. The issue here is the <span class="strong"><strong>Sequencer</strong></span> node: it goes through its children returning on the first fail. After the <span class="strong"><strong>stopPatrolling</strong></span> node is activated, the <span class="strong"><strong>constraint</strong></span> nodes will return failure, so when the sequencer calls, it stops after the first constraint. To remedy this, right-click on the <span class="strong"><strong>sequencer</strong></span> node and change its type to <span class="strong"><strong>Selector</strong></span> and rename it to <span class="strong"><strong>selector</strong></span>.</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_03_14.jpg" /></div><p>As you can<a id="id90" class="indexterm"></a> see in the preceding screenshot, recalling the <span class="strong"><strong>selector</strong></span> node<a id="id91" class="indexterm"></a> works by going through its children returning on the first success instead of failure. So, after patrolling is done and the <span class="strong"><strong>constraint</strong></span> node under the selector returns <code class="literal">false</code>, instead of the tree stopping, the <span class="strong"><strong>move</strong></span> node can be called. If you run the demo now, everything should work as expected: the ship will patrol for 5 seconds and then quickly return to the game base as shown:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_03_15.jpg" /></div><p>If you didn't end up with this result, try not to get frustrated. Setting up behavior trees is pretty precise, and a misnamed variable or wrong node placement will cause interruptions.</p><p>If things are not working for you, open the RAIN behavior tree editor while the game is running (or paused). It will highlight the nodes with red for failure, green for success, and yellow for running:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_03_16.jpg" /></div><p>This is how<a id="id92" class="indexterm"></a> the RAIN behavior tree editor will display<a id="id93" class="indexterm"></a> the status of all the nodes.</p></div>