<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec31"></a>Using senses with RAIN</h2></div></div><hr /></div><p>For this demo, we<a id="id173" class="indexterm"></a> will use RAIN 2.14 and have a ship that patrols a path, looks for pieces of gold, and picks them up. To start, we'll use a setup similar to that of the<a id="id174" class="indexterm"></a> demo in <a class="link" href="#" linkend="ch03">Chapter 3</a>, <span class="emphasis"><em>Behavior Trees</em></span>. You can start from there or recreate it; we just need a ship, a wall, a path, with the ground being a little larger, and the objects spread out a little.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note09"></a>Note</h3><p>When changing the base geometry of your game levels, you need to regenerate the navigation mesh. This is done by selecting the <span class="strong"><strong>Navigation Mesh</strong></span> object in your scene and clicking on the <span class="strong"><strong>Generate NavMesh</strong></span> button.</p></div><p>Here is our basic setup. The following image shows the starting point of our sensor demo:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_06_03.jpg" /></div><p>We also just need the behavior tree for the ship to only patrol the path. Set up this behavior like we did in <a class="link" href="#" linkend="ch02">Chapter 2</a>, <span class="emphasis"><em>Patrolling</em></span>, or if you are using the behavior tree demo, delete the timer node functionality. The new behavior tree should look like the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_06_04.jpg" /></div><p>This will be the <a id="id175" class="indexterm"></a>starting point of the behavior tree for our sensor demo. If you start the demo now, the ship will just keep circling the wall.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec19"></a>Setting up aspects in RAIN</h3></div></div></div><p>For <a id="id176" class="indexterm"></a>our sensor <a id="id177" class="indexterm"></a>demo, we will have<a id="id178" class="indexterm"></a> the ship look for gold, which will be represented by a simple game object. Create a <span class="strong"><strong>Sphere</strong></span> object in Unity by navigating to <span class="strong"><strong>Game Object</strong></span> | <span class="strong"><strong>Create Other</strong></span> | <span class="strong"><strong>Sphere</strong></span>. Make it a little smaller by giving it <span class="strong"><strong>Scale</strong></span> of <span class="strong"><strong>0.25</strong></span> for <span class="strong"><strong>X</strong></span>, <span class="strong"><strong>Y</strong></span>, and <span class="strong"><strong>Z</strong></span>, and change the material to a golden color. We'll be duplicating the object later so if you want duplicating to be easier, make it a prefab. This is our starting point, as illustrated in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_06_05.jpg" /><div class="caption"><p>The starting point of our object (Sphere)</p></div></div><p>To have an aspect, the game object needs an <span class="strong"><strong>Entity</strong></span> component. With <span class="strong"><strong>Gold</strong></span> selected, go to <span class="strong"><strong>RAIN</strong></span> | <span class="strong"><strong>Create Entity</strong></span>. There<a id="id179" class="indexterm"></a> are a few settings to customize, but for <a id="id180" class="indexterm"></a>now just change the <span class="strong"><strong>Entity Name</strong></span> field to <span class="strong"><strong>Gold</strong></span>. The other important setting is <span class="strong"><strong>Form</strong></span>, which is the game object attached to it; we can leave it to <span class="strong"><strong>Sphere</strong></span>.</p><p>Click on the<a id="id181" class="indexterm"></a> <span class="strong"><strong>Add Aspect</strong></span> dropdown and select <span class="strong"><strong>Visual Aspect</strong></span>. Set the aspect name to <span class="strong"><strong>Gold</strong></span> as well. The setting should look like the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_06_06.jpg" /></div><p>We now have an entity with a visual aspect. Create a <span class="strong"><strong>Prefab</strong></span> tab for this <span class="strong"><strong>Gold</strong></span> object and then add it to the opposite side of the wall as the ship. The scene should look like the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_06_07.jpg" /><div class="caption"><p>A sensor demo with gold</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec20"></a>Setting up a visual sensor in RAIN</h3></div></div></div><p>We have<a id="id182" class="indexterm"></a> the <a id="id183" class="indexterm"></a>gold aspect; next we need a visual sensor. Select <span class="strong"><strong>Ship AI</strong></span>, click <a id="id184" class="indexterm"></a>on the eye icon for the sensors tab, and from the <span class="strong"><strong>Add Sensor</strong></span> dropdown, select <span class="strong"><strong>Visual Sensor</strong></span>. Go to the <span class="strong"><strong>Advanced Settings</strong></span> (selecting the gear icon) icon and adjust the horizontal and vertical angles as well as the range until the sensor can see a bit in front of the ship. Typically, you will make these very large so that the character can see most of the level. For this demo, the sensor values are <span class="strong"><strong>120</strong></span> for <span class="strong"><strong>Horizontal Angle</strong></span>, <span class="strong"><strong>45</strong></span> for <span class="strong"><strong>Vertical Angle</strong></span>, and <span class="strong"><strong>15</strong></span> for <span class="strong"><strong>Range</strong></span>. Also, check the <span class="strong"><strong>Require Line of Sight</strong></span> option so that the ship can't see gold through the wall. The setup should look like the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_06_08.jpg" /></div><p>If you <a id="id185" class="indexterm"></a>run the <a id="id186" class="indexterm"></a>demo<a id="id187" class="indexterm"></a> now, you will see the ship moving with the sensor (in <span class="strong"><strong>Editor View</strong></span>). The ship with a visual sensor should look like the following image:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_06_09.jpg" /></div><p>This<a id="id188" class="indexterm"></a> completes <a id="id189" class="indexterm"></a>setting up the sensor for our ship.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec21"></a>Changing activities based on sensing</h3></div></div></div><p>We now have the ship<a id="id190" class="indexterm"></a> sensing the gold as it passes by, but it still doesn't react to it. To do this, we will update the behavior tree for the ship.</p><p>The first thing we want is a detect node as the ship is moving so it can know if it sees <span class="strong"><strong>Gold</strong></span>. Open the behavior tree for the ship and create a detect node. As the detect node will be running continuously, change its <span class="strong"><strong>Repeat</strong></span> type to <span class="strong"><strong>Forever</strong></span> and right-click on the root node and change its type to <span class="strong"><strong>Parallel</strong></span>. For the detection part of the detect node to work, set the <span class="strong"><strong>Aspect</strong></span> field to <span class="strong"><strong>"Gold"</strong></span> and set the sensor it will be using to <span class="strong"><strong>"Visual Sensor</strong></span>". Finally, we need to set the form of the aspect, the game object attached. Set <span class="strong"><strong>Form Variable</strong></span> to <span class="strong"><strong>gold</strong></span>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note10"></a>Note</h3><p>The whole quotes thing in RAIN can be confusing: why some fields need quotes and others don't. This is planned to be improved in future versions of RAIN, but for now for Expressions (fields with the little e symbol) a value with quotes means the name of an object and without means the value of a variable. So in our case, <span class="strong"><strong>"Visual Sensor"</strong></span> and <span class="strong"><strong>"Gold"</strong></span> were both in quotes as they were referring to objects by name, but <span class="strong"><strong>gold</strong></span> is an actual variable we store data in, so it doesn't have quotes.</p></div><p>Your setup should look like the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_06_10.jpg" /></div><p>In the preceding screenshot, you can see the behavior tree with the <span class="strong"><strong>detect</strong></span> node.</p><p>Now if you run<a id="id191" class="indexterm"></a> the game, the gold will be detected, but the ship still doesn't move to it yet. To do this, we will use a selector node similar to the original behavior tree demo. Place a <span class="strong"><strong>selector</strong></span> node under root and create a <span class="strong"><strong>constraint</strong></span> node as a child with a <span class="strong"><strong>Constraint</strong></span> value of <span class="strong"><strong>gold == null</strong></span>. Then, move the original patrol node to be a child of the constraint. The setup should look the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_06_11.jpg" /></div><p>The preceding screenshot shows a detection behavior tree with a <span class="strong"><strong>constraint</strong></span> node.</p><p>Now if you run the demo, when the ship sees the gold, the gold value will not be null and it will stop moving. However, instead of stopping, we want it to move over to the gold; so, add another constraint node with the <span class="strong"><strong>Expressiongold != null</strong></span> value and a <span class="strong"><strong>move</strong></span> node below it that has a <span class="strong"><strong>Move Target</strong></span> value of <span class="strong"><strong>gold</strong></span>. Here is how the behavior tree with the <span class="strong"><strong>detect</strong></span> node settings will look:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_06_12.jpg" /></div><p>If you run the demo now, the ship will move to the gold when it sees it. However, let's change this so<a id="id192" class="indexterm"></a> that the ship goes back to patrolling after the pickup. Make sure that both root and selector nodes are set to <span class="strong"><strong>Forever</strong></span> for their <span class="strong"><strong>Repeat</strong></span> type. Then, create a new custom action node (like in <a class="link" href="#" linkend="ch03">Chapter 3</a>, <span class="emphasis"><em>Behavior Trees</em></span>) and put it under the move node for the gold. Create a new class for the custom action and call it <code class="literal">PickUpGold</code>. Set its code to this:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using RAIN.Core;
using RAIN.Action;

[RAINAction]
public class PickUpGold : RAINAction
{
    public PickUpGold()
    {
        actionName = "PickUpGold";
    }

    public override void Start(AI ai)
    {
        base.Start(ai);

        GameObject gold = ai.WorkingMemory.GetItem&lt;GameObject&gt;("gold");

        ai.WorkingMemory.SetItem&lt;GameObject&gt;("gold", null);

        Object.Destroy(gold);
    }

    public override ActionResult Execute(AI ai)
    {
        return ActionResult.SUCCESS;
    }

    public override void Stop(AI ai)
    {
        base.Stop(ai);
    }
}</pre></div><p>The important <a id="id193" class="indexterm"></a>code here is in the <code class="literal">Start</code> method. We got the <code class="literal">gold</code> game object that was sensed from the memory and then erased it from memory by setting the <code class="literal">gold</code> value to <code class="literal">null</code>. Then, we destroyed the <code class="literal">gold</code> object, so it won't be sensed anymore. If you run the code now, the ship will follow the path, pick up gold when it sees it, and then go back to the path.</p><p>Next, try adding several more gold prefabs to the scene and run the demo, as shown in the following image:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_06_13.jpg" /></div><p>Now in the demo, the ship will go and collect all the different gold pieces it sees and then return to the path.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec22"></a>RAIN sensor filters</h3></div></div></div><p>If you<a id="id194" class="indexterm"></a> tried <a id="id195" class="indexterm"></a>running the demo with multiple gold pieces, you must have seen a small problem. The ship always goes to the first piece of gold it sees, but that might not be the closest. If it sees a distant piece from the corner of its eye, it will go straight to it even if there are ones closer to it. A quick fix for this is to add a <a id="id196" class="indexterm"></a>filter<a id="id197" class="indexterm"></a> to the RAIN sensors. Filters are ways to manipulate the list of sensed objects, and RAIN might have more in the future but for now, it just has one: <span class="strong"><strong>NearestXFilter</strong></span>. Select <span class="strong"><strong>Visual Sensor</strong></span> in the ship and set the <span class="strong"><strong>Size</strong></span> field to <span class="strong"><strong>1</strong></span> and select <span class="strong"><strong>NearestXFilter</strong></span> under the <span class="strong"><strong>Filters</strong></span> section. The following screenshot will show the settings of <span class="strong"><strong>NearestXFilter</strong></span> on the sensor:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_06_14.jpg" /></div><p>The <span class="strong"><strong>NearestXFilter</strong></span> filter will send a given number of closest objects to the sensor. In our case, we just leave it to one. If you run the demo now, the ship will always pick up the gold that it can see and that is the closest to it first. This completes our ship demo.</p></div></div>