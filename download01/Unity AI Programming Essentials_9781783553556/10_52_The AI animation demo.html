<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec49"></a>The AI animation demo</h2></div></div><hr /></div><p>As the first<a id="id284" class="indexterm"></a> step, create a new scene and add a plane to it with a scale of <span class="emphasis"><em>X</em></span> equal to 10, <span class="emphasis"><em>Y</em></span> equal to 1, and <span class="emphasis"><em>Z</em></span> equal to 10 to give us a floor where characters can walk around (and if you want, change its material so it's not white). Then, add the <span class="strong"><strong>penelope</strong></span> model to your scene that's at <code class="literal">Assets/Objects/penelopeFX</code>. Next, we'll do our basic RAIN setup and add a navigation mesh by going to <span class="strong"><strong>RAIN</strong></span> | <span class="strong"><strong>Create NavMesh</strong></span>. Make sure the navigation mesh will cover the floor, so change its <span class="strong"><strong>Size</strong></span> to <span class="strong"><strong>100</strong></span> and then generate the mesh. Next, create a waypoint route by going to <span class="strong"><strong>RAIN</strong></span> | <span class="strong"><strong>Create Waypoint Route</strong></span>, rename it <code class="literal">PenelopeRoute</code>, and add a few points in front of the <span class="strong"><strong>penelope</strong></span> model for the character to walk. Lastly, add a RAIN AI object by selecting <span class="strong"><strong>penelope</strong></span> and going to <span class="strong"><strong>RAIN</strong></span> | <span class="strong"><strong>Create AI</strong></span>. Your screen should look similar to the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_10_01.jpg" /><div class="caption"><p>The scene for the AI animation demo</p></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note19"></a>Note</h3><p>If you need more details on how to set up a scene with a character patrolling a path, refer to <a class="link" href="#" linkend="ch02">Chapter 2</a>, <span class="emphasis"><em>Patrolling</em></span>.</p></div><p>Now that <a id="id285" class="indexterm"></a>we have a scene, let's create a behavior tree for Penelope; we want her to just walk following the path and stopping at the end. Select Penelope's AI object and open <span class="strong"><strong>Behavior Editor</strong></span>. Create a new behavior tree called <code class="literal">WalkPenelope</code> and add a patrol route node to the root. Set the route to <span class="strong"><strong>"PenelopeRoute"</strong></span>. We just want Penelope to walk the route once and then stop, so set the <span class="strong"><strong>Repeat</strong></span> field to <span class="strong"><strong>Never</strong></span> and the <span class="strong"><strong>Loop Type</strong></span> field to <span class="strong"><strong>One Way</strong></span>. Lastly, set the <span class="strong"><strong>Move Target Variable</strong></span> field to <span class="strong"><strong>moveTarget</strong></span> and create a child <span class="strong"><strong>move</strong></span> node that uses <span class="strong"><strong>moveTarget</strong></span> to move. The tree should look like the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_10_02.jpg" /></div><p>If you run the demo now, Penelope will travel around the path, but there will be no character animation; she will just slide on the ground. To fix this, we'll add animation to our character.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec30"></a>Configuring RAIN animations</h3></div></div></div><p>To<a id="id286" class="indexterm"></a> configure animation for Penelope<a id="id287" class="indexterm"></a> on her RAIN menu, select the <span class="strong"><strong>Animation</strong></span> tab. (Again, this is the tab with a little figure running on it.) RAIN supports two animation systems: <span class="strong"><strong>BasicAnimator</strong></span> and <span class="strong"><strong>MecanimAnimator</strong></span>. Since the Penelope character doesn't use Mecanim, leave the animator as basic. The <span class="strong"><strong>Add Animation State</strong></span> dropdown will then be automatically populated with the different animation clips available. Choose the animation states <span class="strong"><strong>run</strong></span> and <span class="strong"><strong>idle</strong></span>.</p><p>Your animation tab should look like the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_10_03.jpg" /></div><p>Here <a id="id288" class="indexterm"></a>are some of the animation <a id="id289" class="indexterm"></a>parameters:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="strong"><strong>State Name</strong></span>: This <a id="id290" class="indexterm"></a>specifies the name of the animation clip; this is what we'll use in the animate node in the behavior tree when calling animations.</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Animation Clip</strong></span>: This specifies the legacy<a id="id291" class="indexterm"></a> animation clip associated with this state.</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Fade in Time</strong></span>, <span class="strong"><strong>Fade Out Time</strong></span>: This<a id="id292" class="indexterm"></a> specifies the amount of time required to fade in and out of the animation. This can be useful to create smooth transitions between animation clips.</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Wrap Mode</strong></span>: This <a id="id293" class="indexterm"></a>provides the wrap mode for the animation. This can be left to default to use the clip's default settings. Other options are to loop or to play the animation once and go to the beginning or end of the clip.</p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec31"></a>Using the animate node</h3></div></div></div><p>Now <a id="id294" class="indexterm"></a>we need to configure the behavior tree to play<a id="id295" class="indexterm"></a> the animations. As our first step, let's get Penelope running. Right-click on the <span class="strong"><strong>root</strong></span> node in the <code class="literal">WalkPenelope</code> behavior tree and go to <span class="strong"><strong>Switch To Parallel</strong></span> and then rename the node to <code class="literal">parallel</code>. By being parallel, we can add an animate node and have it update the animation at the same time as the patrol node is being executed. So add an animate node, rename it to <code class="literal">animate run</code>, and set <span class="strong"><strong>Animation State</strong></span> to <span class="strong"><strong>run</strong></span>. Your setting should look like the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_10_04.jpg" /></div><p>If you run the demo now, you'll see the Penelope character perform the animation while it's moving. But the timing seems a little off. Change the moving speed of the <span class="strong"><strong>move</strong></span> node to <span class="strong"><strong>3</strong></span>. Then slow down the animation a little by going back to the <span class="strong"><strong>Animation</strong></span> tab and setting the <span class="strong"><strong>Speed</strong></span> field to <span class="strong"><strong>0.75</strong></span>. If you run the demo now, the animation is a bit better. But when Penelope gets to the end of the route, the run animation just keeps on playing. To fix this, let's track a variable in the memory called <code class="literal">stopped</code>. When it is false, the run animation will play as it does now, and when <code class="literal">stopped</code> is <code class="literal">true</code>, an idle animation will be played instead.</p><p>The first thing you need to do to fix the animation's issues with ending is add a <span class="strong"><strong>selector</strong></span> node as the new root. Remember, the <span class="strong"><strong>selector</strong></span> node is used for the <code class="literal">if</code>/<code class="literal">else</code> logic, so we'll use it to switch between its running state and playing an idle animation. Add a <span class="strong"><strong>constraint</strong></span> node under <span class="strong"><strong>selector</strong></span> and rename it to <code class="literal">is stopped</code>. Set <span class="strong"><strong>Constraint</strong></span> to <span class="strong"><strong>stopped == false</strong></span>. Then add a new animate node under the <span class="strong"><strong>selector</strong></span> node, name it <code class="literal">animate idle</code>, and set <span class="strong"><strong>Animation State</strong></span> to <span class="strong"><strong>idle</strong></span>. This will only start running when <code class="literal">stopped</code> is true, so we need to add an expression node to run the <span class="strong"><strong>expression</strong></span> node after our moving is done. Make a new <span class="strong"><strong>sequencer</strong></span> node and make it the parent of <span class="strong"><strong>waypointpatrol</strong></span>. Then add an expression node under the <span class="strong"><strong>sequencer</strong></span> node with an <span class="strong"><strong>Expression</strong></span> value of <span class="strong"><strong>stopped = true</strong></span>.</p><p>This should look like the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_10_05.jpg" /></div><p>To <a id="id296" class="indexterm"></a>summarize, the selector acts as <code class="literal">if</code>/<code class="literal">else</code> using the <code class="literal">stopped</code> variable in the memory, which is automatically created in the tree when <a id="id297" class="indexterm"></a>we start using it. Then the run animation is played in parallel while the character is moving, and when the moving is done, the expression sets <span class="strong"><strong>stopped = true</strong></span> and the idle animation is played. If you run the animation now, Penelope will run and then switch to idle at the end of the path.</p><p>However, there is one problem: the transition from the running to the idle state is very abrupt. If you run the demo, you'll easily notice a visual jump from the running to the idle state for Penelope at the end of the path. To help with this, you can adjust the ramping parameters for the animations. Go back to RAIN's <span class="strong"><strong>Animation</strong></span> tab and set the <span class="strong"><strong>Fade Out Time</strong></span> field of the run animation to <span class="strong"><strong>2</strong></span>. Now, if you run the animation, Penelope will start to transition out of the running state for two seconds, and although everything doesn't look perfect, the transition is much smoother than before. Feel free to play with other ramp settings to get a better effect.</p><p>This shows how RAIN works with Unity's legacy animation system; now, let's look at Mecanim.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec32"></a>RAIN and the Mecanim demo</h3></div></div></div><p>Mecanim <a id="id298" class="indexterm"></a>is Unity's latest animation system that's <a id="id299" class="indexterm"></a>able to <a id="id300" class="indexterm"></a>play animations<a id="id301" class="indexterm"></a> on arbitrary characters. We won't go into detail on how Mecanim works and instead focus just on RAIN's usage.</p><p>For this demo, we will use a character already set up for Mecanim from Unity's sample. If you haven't already done so, download and import Unity's Mecanim demo, <span class="strong"><strong>Mecanim Example Scenes v1.0</strong></span>, which<a id="id302" class="indexterm"></a> is free on the Asset Store. Add the teddy bear character from <code class="literal">Character/Teddy2/TeddyBar.fbx</code> to your scene. Then, in<a id="id303" class="indexterm"></a> the <span class="strong"><strong>Animator</strong></span> component for Teddy, set the <span class="strong"><strong>Controller</strong></span> field to <span class="strong"><strong>IdleRunJump</strong></span> from <span class="strong"><strong>Controllers</strong></span>. Then, add a RAIN AIRig to Teddy by going to <span class="strong"><strong>RAIN</strong></span> | <span class="strong"><strong>Create AI</strong></span>. We'll <a id="id304" class="indexterm"></a>have Teddy walk on a <a id="id305" class="indexterm"></a>different route, so create a new waypoint <a id="id306" class="indexterm"></a>patrol route and name it <code class="literal">TeddyRoute</code>. Your scene should look like this:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_10_06.jpg" /></div><p>In the preceding screenshot, you can see Teddy with a new path set up in your scene.</p><p>Next, we need to configure animations for Teddy. Go to the <span class="strong"><strong>Animation</strong></span> tab in Teddy's RAIN AIRig and select <span class="strong"><strong>MecanimAnimator</strong></span>. Then, we need to add states for running and idling. Select <span class="strong"><strong>Base Layer.Run</strong></span> and <span class="strong"><strong>Base Layer.Idle</strong></span> from <span class="strong"><strong>Add Animation State</strong></span>.</p><p>Your screen should look like the following:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_10_07.jpg" /></div><p>These <a id="id307" class="indexterm"></a>are the basic animations added to Teddy. Besides <a id="id308" class="indexterm"></a>adding the states, we need to set Mecanim parameters. From<a id="id309" class="indexterm"></a> the<a id="id310" class="indexterm"></a> teddy bear object's <span class="strong"><strong>Animator</strong></span> component, open <span class="strong"><strong>Controller</strong></span> for <span class="strong"><strong>IdleRunJump</strong></span>. The following is the Teddy Mecanim diagram:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_10_08.jpg" /></div><p>This shows the different parameters for the Teddy character; we'll only be setting <span class="strong"><strong>Speed</strong></span>. Go back to the <span class="strong"><strong>Animation</strong></span> tab for Teddy to set up <span class="strong"><strong>Start Parameter</strong></span> under <span class="strong"><strong>Base Layer.Run</strong></span>. Set the <span class="strong"><strong>Parameter Name</strong></span> field to <span class="strong"><strong>Speed</strong></span> and leave the <span class="strong"><strong>Parameter Type</strong></span> field<a id="id311" class="indexterm"></a> to <span class="strong"><strong>Float</strong></span> and the <span class="strong"><strong>Parameter Value</strong></span> field to <span class="strong"><strong>1</strong></span>. Then, do <a id="id312" class="indexterm"></a>the<a id="id313" class="indexterm"></a> same for<a id="id314" class="indexterm"></a> <span class="strong"><strong>Base Layer.Idle</strong></span>, except set the <span class="strong"><strong>Parameter Value</strong></span> field to <span class="strong"><strong>0</strong></span>. The new settings should look like this:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_10_09.jpg" /></div><p>This sets up the animation. Now we can set up the behavior tree for Teddy. Create a new behavior tree called <span class="strong"><strong>WalkTeddy</strong></span> and recreate the behavior tree from <span class="strong"><strong>WalkPenelope</strong></span>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note20"></a>Note</h3><p>With RAIN, you can copy and paste nodes from one part of a tree to another and from one tree to a different one.</p></div><p>From the<a id="id315" class="indexterm"></a> animate node's perspective, it doesn't matter<a id="id316" class="indexterm"></a> whether the animator is Mecanim or not, so we only need to make <a id="id317" class="indexterm"></a>a few simple changes. Change the waypoint <a id="id318" class="indexterm"></a>patrol node's waypoint route to <span class="strong"><strong>"TeddyRoute"</strong></span>. Then, in the <span class="strong"><strong>animate run</strong></span> node, set <span class="strong"><strong>Animation State</strong></span> to <span class="strong"><strong>Base Layer.Run</strong></span> and set animation idle's <span class="strong"><strong>Animation State</strong></span> field to <span class="strong"><strong>Base Layer.Idle</strong></span>. And one important change for Mecanim is to set the animate node's <span class="strong"><strong>Repeat</strong></span> field to <span class="strong"><strong>Forever</strong></span>. The following screenshot shows the new behavior tree:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_10_10.jpg" /></div><p>If you run the demo now, you'll see Teddy running along the path and then be in the idle state at the end, just like Penelope. But there is one problem: Teddy is running way too fast. The reason is that RAIN is moving the model and the animation system is also applying movement to the character, making Teddy move fast artificially. To fix this, go back to the <span class="strong"><strong>Animator</strong></span> component of <span class="strong"><strong>Teddy</strong></span> and uncheck <span class="strong"><strong>Apply Root Motion</strong></span>. This will keep the animation system from applying movement and Teddy will now run at a better rate. Running the demo now, Teddy will run and idle at the end.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec33"></a>Additional Mecanim nodes</h3></div></div></div><p>Besides <a id="id319" class="indexterm"></a>using the animate node for<a id="id320" class="indexterm"></a> Mecanim, RAIN has additional nodes specifically for Mecanim, mostly useful in special cases. The nodes are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
<span class="strong"><strong>Mecanim IK</strong></span>: This<a id="id321" class="indexterm"></a> node is used to modify the inverse kinematics on part of a model</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Mecanim State</strong></span>: This node is used to<a id="id322" class="indexterm"></a> check the animation controller state</p></li><li style="list-style-type: disc"><p>
<span class="strong"><strong>Mecanim Parameter</strong></span>: This node is <a id="id323" class="indexterm"></a>used to change a Mecanim parameter</p></li></ul></div><p>These<a id="id324" class="indexterm"></a> are less-used nodes but are good<a id="id325" class="indexterm"></a> to know.</p></div></div>