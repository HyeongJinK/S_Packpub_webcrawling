<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec34"></a>RAIN's demo</h2></div></div><hr /></div><p>The basic <a id="id207" class="indexterm"></a>start of the<a id="id208" class="indexterm"></a> demo will be similar to our others, a ground with several walls around for our ships to travel. This is how the basic starting point of our demo should look:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_07_02.jpg" /><div class="caption"><p>The basic starting point of our demo</p></div></div><p>One of the first things we will need is the ability to query a random location in the scene to spawn and find points to travel to. Create a class called <code class="literal">Ground</code> and add it to the ground plane. This class will be used to provide higher-level information about the level, the first of which is being able to find a random position in the level. Here is the <code class="literal">Ground</code> class with the random position chooser method:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_07_03.jpg" /></div><p>In the preceding<a id="id209" class="indexterm"></a> code, we are able to ask for a random position at anytime from anywhere in the game. In the <code class="literal">Start</code> method for the <code class="literal">Ground</code> class, we store the <code class="literal">max</code> and <code class="literal">min</code> positions<a id="id210" class="indexterm"></a> for it, and as we don't want positions on the very edge of the level, it is scaled to 90 percent by multiplying by <code class="literal">0.9f</code>. The <code class="literal">min</code> and <code class="literal">max</code> positions are static, so we can add a static method, <code class="literal">randomLevelPosition()</code>, that returns a random 2D position on the level with a constant height. We'll be using this method in several other spots in the code.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note12"></a>Note</h3><p>We could do additional checks on this position finding to make sure that the spot never overlaps any of the walls in the scene, but to make the code simpler for this demo, we won't worry about this edge case. However, you would do this in a production game.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec23"></a>Reacting to game events</h3></div></div></div><p>Next, we <a id="id211" class="indexterm"></a>want to have some ships chase gold pieces, but we'll make it more dynamic than in the last demo. Create a <span class="strong"><strong>Sphere</strong></span> object with a gold color and add a <span class="strong"><strong>RAIN</strong></span> entity to it (by navigating to <span class="strong"><strong>RAIN</strong></span> | <span class="strong"><strong>Create Entity</strong></span>) and add a <span class="strong"><strong>Visual Aspect</strong></span> called <span class="strong"><strong>Gold</strong></span> to it so that AI characters can sense it. Turn this gold piece into a prefab. Instead of just placing it manually in the scene, we want them to be spawned randomly; add the code mentioned in the following screenshot to the <code class="literal">Ground</code> script:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_07_04.jpg" /></div><p>In the Unity editor, drag the <span class="strong"><strong>Gold</strong></span> prefab to the <code class="literal">Transform gold</code> in this script. This script randomly spawns a gold<a id="id212" class="indexterm"></a> piece somewhere in the level every 2 seconds by tracking the time using <code class="literal">Time.deltaTime</code>. If you run the game now, you'll see a gold piece created randomly every 2 seconds. Next, we need ships to collect these.</p><p>Our AI ship characters will pick a random spot on the level and travel there and then after arriving, pick another random spot to go to; however, if they see a piece of gold along the way, they will stop and pick it up. To do this, create a ship object with a RAIN visual sensor with a horizontal angle of <span class="strong"><strong>120</strong></span>, a vertical angle of <span class="strong"><strong>45</strong></span>, and a range of <span class="strong"><strong>15</strong></span>. The behavior tree for the ship will be straightforward. Set the root node to parallel and one <span class="strong"><strong>Detect</strong></span> child set to look for <span class="strong"><strong>Gold</strong></span> and store its form in the <code class="literal">gold</code> variable. Add another child to the root with a constraint to test if <span class="strong"><strong>gold == null</strong></span>. If gold is not <span class="strong"><strong>null</strong></span>, it should move to pick up the gold; if it is, pick a random spot on the level and move there. To pick a random spot in the level, create a new <span class="strong"><strong>Custom Action</strong></span> option with a new script called <code class="literal">ChooseRandomSpot</code>. Set the following code for it:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_07_05.jpg" /></div><p>The <code class="literal">Start</code> method <a id="id213" class="indexterm"></a>uses our static <code class="literal">Ground</code> method to find a random position in the level and sets it to the <code class="literal">moveTarget</code> variable in the AI's memory. Next, add a <span class="strong"><strong>move</strong></span> node to go to the <code class="literal">moveTarget</code> variable. If you need a review of how to set up these nodes, check <a class="link" href="#" linkend="ch06">Chapter 6</a>, <span class="emphasis"><em>Sensors and Activities</em></span>. The behavior tree for the ship should look like the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_07_06.jpg" /></div><p>Change the ship to a prefab and add a few ships to the level. Now if you run the game, your ships <a id="id214" class="indexterm"></a>will wander around, but if they see gold, they will race to pick it up and the first one there collects it.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl3sec01"></a>Using RAIN's motor directly</h4></div></div></div><p>However, if you<a id="id215" class="indexterm"></a> run the game now, you'll see a problem. As expected, the ship will look for gold, and if it doesn't see any, it will pick a random position on the level and move toward it. If it sees gold along the way, it doesn't stop to pick it up; it keeps moving to its target location.</p><p>Our root node is a parallel type, so the character is always trying to detect gold, but it still ignores it while traveling. This is because our <span class="strong"><strong>move</strong></span> node will keep running until it hits its destination, and even if it sees something, it is not interrupted until it gets there. To fix this, delete the <span class="strong"><strong>move</strong></span> node underneath <span class="strong"><strong>ChooseRandomSpot Custom Action</strong></span>. Then, change <span class="strong"><strong>ChooseRandomAction</strong></span> to the code shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_07_07.jpg" /></div><p>This is a big<a id="id216" class="indexterm"></a> change, so let's discuss what is going on. The <code class="literal">Start</code> method is the same as before: store a random position to move to in memory. However, our action method is different. The first thing it does is it queries the memory for gold. If we have gold, we don't need to keep moving to our target, so we return failure. Then, we get our <code class="literal">moveTarget</code> variable out of memory and check the position of the <code class="literal">Body</code> variable of our AI. If it is within one unit of the goal, we say that this is close enough and return success. Finally, if we don't have gold and aren't close to <code class="literal">moveTarget</code>, we call on the AI's motor system to move to the target and keep updating it by returning the running state.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note13"></a>Note</h3><p>With this update, we could have used a regular class variable to store <code class="literal">moveTarget</code>, but we keep it in memory to keep things consistent.</p></div><p>If you run the demo now, we will see the ships moving around as new gold appears in more expected ways, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_07_08.jpg" /></div><p>You can see the ships <a id="id217" class="indexterm"></a>wandering and chasing gold in the preceding screenshot.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl3sec02"></a>Adding large game events</h4></div></div></div><p>As the last <a id="id218" class="indexterm"></a>step of this demo, let's have a giant bomb go off in the scene and then have all of our AI stop to simulate having them all destroyed. To start, create a large red sphere to represent the bomb and turn it into a prefab. We will have the AI characters react to this bomb in the standard way by adding a RAIN Entity component to it and a visual aspect and have visual sensors on the ships detect it. But to show we can access the AI systems directly, let's have the bomb go off using the <code class="literal">Ground</code> class:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_07_09.jpg" /></div><p>Here, we added a bomb transform to the script, so drag the bomb prefab in the Unity prefab over to it. There<a id="id219" class="indexterm"></a> is also a field for a countdown that when it goes to 0, the bomb goes off and is instantiated into the scene. At this point, we grab all the AIs in the scene and send them a message, in this case, to disable it. We could have made this more complex than a simple disabling; this just shows us that we can have our game AI react to game events from anywhere. If you run the demo now, the ships stop when the bomb goes off, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_07_10.jpg" /></div><p>In the preceding <a id="id220" class="indexterm"></a>screenshot, you can see the ships reacting to a bomb.</p></div></div></div>