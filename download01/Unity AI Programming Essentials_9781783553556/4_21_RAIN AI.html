<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec24"></a>RAIN AI</h2></div></div><hr /></div><p>We have<a id="id112" class="indexterm"></a> already looked at a basic wander behavior for RAIN in <a class="link" href="#" linkend="ch02">Chapter 2</a>, <span class="emphasis"><em>Patrolling</em></span>, when creating patrolling AI, but there, we manually created each possible location for the NPC to go to. In this demo, we will pick random points to wander to from anywhere in the navigation mesh. The NPCs won't have any interaction, though such features are not difficult to add. Here is a breakdown of the steps we will do in this section:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Set up a world</p></li><li style="list-style-type: disc"><p>Build the behavior tree</p></li><li style="list-style-type: disc"><p>Add a script to pick new points</p></li><li style="list-style-type: disc"><p>Add the NPCs</p></li><li style="list-style-type: disc"><p>Learn about the RAIN AI world and behavior tree setup</p></li></ul></div><p>First, we'll create a new world. Start with a large plane called <code class="literal">floor</code>, and add some cubes shaped into walls. You will need to add a navigation mesh and bake it into the scene. These are the same steps we have performed for RAIN demos in earlier chapters. The following is an example of how the scene could look:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_04_04.jpg" /></div><p>Next comes <a id="id113" class="indexterm"></a>the behavior tree. From the RAIN menu, select <span class="strong"><strong>Behavior Tree Editor</strong></span>. Create a new tree called <code class="literal">RandomWalk</code>. The objective of this AI is broken into three steps, taken in this order: select a target, walk to it, and then wait a moment. This is a good case for the RAIN decision node sequenced. Under the root node, we will right-click and go to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Decisions</strong></span> | <span class="strong"><strong>Sequencer</strong></span>.</p><p>As there is no behavior tree node built into RAIN that will choose a random location, we will use a custom action and write our own script. Right-click on the new SEQ node and navigate to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Actions</strong></span> | <span class="strong"><strong>Custom Action</strong></span>. Set the <span class="strong"><strong>Repeat</strong></span> property to <span class="strong"><strong>Until Success</strong></span> because we want it to continue processing this node until it returns a success and then move on to the next node. Name the custom action node <code class="literal">Select Next Target</code>. You'll notice that you can put spaces in the name. This is useful as it shows up in the behavior tree, making it easier to follow:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_04_05.jpg" /></div><p>We could add the script now, but we'll finish the rest of the nodes in the tree and then come back; for now, we will assume that the script will find a spot to walk to. The next action is to walk to it. This needs two things happening simultaneously, animation and actual walking, which <a id="id114" class="indexterm"></a>means that we will use the <span class="strong"><strong>Parallel</strong></span> decision node. Right-click on the sequence node and select <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Decisions</strong></span> | <span class="strong"><strong>Parallel</strong></span>. Name it <span class="strong"><strong>Walk to Target</strong></span>.</p><p>Under <span class="strong"><strong>Walk to Target</strong></span>, right-click and go to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Actions</strong></span> | <span class="strong"><strong>Animate</strong></span>. Name it <code class="literal">Appear Walking</code>. Set the animation state to <span class="strong"><strong>walk</strong></span>. Also under <span class="strong"><strong>Walk to Target</strong></span>, right-click and navigate to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Actions</strong></span> | <span class="strong"><strong>Move</strong></span>. Name it <code class="literal">Move</code>. Set the <span class="strong"><strong>Move Speed</strong></span> property to <code class="literal">1</code>, so it moves 1 meter per second. The <span class="strong"><strong>Move Target</strong></span> value should be set to <span class="strong"><strong>TargetPoint</strong></span> without the quotes. <span class="strong"><strong>TargetPoint</strong></span> doesn't exist yet; our script will create it.</p><p>The last step that the NPC must perform is generate a wait moment. To give the NPC more life, we will make sure that it uses an idle animation, which also means two things must happen simultaneously. Right-click on the root sequence node (<span class="strong"><strong>SEQ</strong></span>) and go to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Decisions</strong></span> | <span class="strong"><strong>Parallel</strong></span>. Name it <code class="literal">Look Busy</code>. Add an animation action under this and set <span class="strong"><strong>idle</strong></span> as its <span class="strong"><strong>Animation State</strong></span> and <span class="strong"><strong>Stand here</strong></span> as its name.</p><p>Also, under the <span class="strong"><strong>Look Busy</strong></span> node, we will right-click and go to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Actions</strong></span> | <span class="strong"><strong>Wait for Timer</strong></span>. Name it <code class="literal">For a couple seconds</code>. Set the <span class="strong"><strong>Seconds</strong></span> property to <span class="strong"><strong>2</strong></span>.</p><p>The behavior tree is now complete. All we need to do now is fill in the script that gets our <span class="strong"><strong>TargetPoint</strong></span>, so it knows where to move.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec11"></a>RAIN AI custom wander scripts</h3></div></div></div><p>To start <a id="id115" class="indexterm"></a>creating our needed wander scripts, first select<a id="id116" class="indexterm"></a> the <span class="strong"><strong>Select Next Target</strong></span> action in the behavior tree. Under the <span class="strong"><strong>Class</strong></span> property, set it to <span class="strong"><strong>Create Custom Action</strong></span>, which pops up a box to define the script. The following screenshot shows what a RAIN custom action creation dialog looks like:</p><div class="mediaobject"><img src="/graphics/9781783553556/graphics/3556OT_04_06.jpg" /></div><p>Set the <a id="id117" class="indexterm"></a>name to <code class="literal">SelectRandomTarget</code> and the script <a id="id118" class="indexterm"></a>to <span class="strong"><strong>CSharp</strong></span>. This will generate the default custom action script file already filled with a few common methods. In this demo, we only need to use the <code class="literal">Execute</code> function:</p><div class="informalexample"><pre class="programlisting">public override ActionResult Execute(AI ai)
{
  var loc = Vector3.zero;
  List&lt;RAINNavigationGraph&gt; found = new List&lt;RAINNavigationGraph&gt;();
  do
  {
    loc = ai.Kinematic.Position;
    loc.x += Random.Range(-8f, 8f);
    loc.z += Random.Range(-8f, 8f);
    found = NavigationManager.Instance.GraphsForPoints(
      ai.Kinematic.Position,
      loc, 
      ai.Motor.StepUpHeight,
      NavigationManager.GraphType.Navmesh,
      ((BasicNavigator)ai.Navigator).GraphTags);
  } 
  while ( Vector3.Distance(loc, ai.Kinematic.Position) &lt; 2f 
      || found.Count == 0);
  ai.WorkingMemory.SetItem&lt;Vector3&gt;("TargetPoint", loc);
  return ActionResult.SUCCESS;
}</pre></div><p>In this code, we try to find a good value for the <code class="literal">loc</code> variable, a location variable that is set to a different random location, up to 18 meters away. The <code class="literal">found</code> variable identifies whether a<a id="id119" class="indexterm"></a> path exists or not. These two things are determined in a loop, which ends as long as two conditions are met. First, the distance has to be greater than 2, as the movement should be detected by the player and second, we see if the points found is greater than zero. If it found none, then we would not be able to get to that location.</p><p>Once the <code class="literal">loc</code> variable has a location that works, the next thing it does is use RAIN's memory<a id="id120" class="indexterm"></a> system and sets a memory entry, <span class="strong"><strong>TargetPoint</strong></span>, to <a id="id121" class="indexterm"></a>the new location. Remember that we have the <span class="strong"><strong>Move</strong></span> action in our behavior set to find <span class="strong"><strong>TargetPoint</strong></span>, so <span class="strong"><strong>Move</strong></span> will go to our newly found location. Finally, we return a success.</p><p>This completes our behavior and script. The last thing we need to do is give that behavior to some NPCs and run the game.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec12"></a>Putting NPCs in the RAIN demo</h3></div></div></div><p>Start by <a id="id122" class="indexterm"></a>adding another simple NPC character <a id="id123" class="indexterm"></a>to the game, like we did in the first chapter. We don't need<a id="id124" class="indexterm"></a> to add any scripts directly to it. Instead, make sure that the NPC is selected in the hierarchy, and from the RAIN menu, select <span class="strong"><strong>Create AI</strong></span>.</p><p>In the AI GameObject/component that was added, from the <span class="strong"><strong>Mind</strong></span> tab, set the <span class="strong"><strong>Behavior Tree Asset</strong></span> value to <span class="strong"><strong>RandomWalk</strong></span>, which is found in <span class="strong"><strong>Assets</strong></span>. Under the animation tab, click on the <span class="strong"><strong>Add Existing Animations</strong></span> button.</p><p>Now, try the game. A single NPC should be walking around the screen, pausing, and then walking to another location at random. To create a larger crowd, just duplicate the NPC GameObject in the scene at several locations.</p></div></div>