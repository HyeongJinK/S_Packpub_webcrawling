<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec60"></a>Using basic Photoshop-like Blend modes with screen effects</h2></div></div><hr /></div><p>The screen effects aren't just <span>limited</span><a id="id325209385" class="indexterm"></a> to adjusting the <span>colors</span><a id="id325209485" class="indexterm"></a> of a rendered image from our game. We can also use them to combine other images with our <code class="literal">RenderTexture</code>. This technique is no different than creating a new layer in Photoshop and choosing a <strong class="userinput"><code>Blend</code></strong> mode to blend two images together or, in our case, a texture with a <code class="literal">RenderTexture</code>. This becomes a very powerful technique as it gives the artists in a production environment a way to simulate their blending modes in the game rather than just in Photoshop.</p><p>For this particular recipe, we are going to take a look at some of the more common blend modes, such as <strong class="userinput"><code>Multiply</code></strong>, <strong class="userinput"><code>Add</code></strong>, and <strong class="userinput"><code>Overlay</code></strong>. You will see how simple it is to have the power of Photoshop <strong class="userinput"><code>Blend</code></strong> modes in your game.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec151"></a>Getting ready</h3></div></div></div><p>To begin, we have to get our assets ready. So let's follow the next few steps to get our screen effects system up and running for our new <strong class="userinput"><code>Blend</code></strong> mode screen effect:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>We will need another texture to perform our <strong class="userinput"><code>Blend</code></strong> mode effect. In this recipe, we will use a grunge-type texture. This will make the effect very obvious when we are testing it out.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>The following screenshot is the grunge map used in the making of this effect. Finding a texture with enough detail and a nice range of grayscale <span>values</span><a id="id325453977" class="indexterm"></a> will make for a nice <span>texture</span><a id="id325453986" class="indexterm"></a> to test our new effect:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/b2b6e932-490c-4975-a6e9-608a301cc2a8.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip73"></a>Note</h3><p>The preceding texture is available in the example code for this book in <code class="literal">Chapter 9 </code>| <code class="literal">Textures</code> folder.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec152"></a>How to do it...</h3></div></div></div><p>The first <strong class="userinput"><code>Blend</code></strong> mode that we will implement is the <strong class="userinput"><code>Multiply</code></strong> blend mode as seen in Photoshop. Let's begin by modifying the code in our shader first:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Create a new shader by duplicating the <code class="literal">ScreenGreyscale</code> code by selecting it from the <strong class="userinput"><code>Project</code></strong> tab under the <code class="literal">Chapter 9 </code>| <code class="literal">Shaders</code> folder and pressing <span class="emphasis"><em>Ctrl </em></span>+ <span class="emphasis"><em>D.</em></span> Once duplicated, rename the script to <code class="literal">ScreenBlendMode</code>. Then, double-click on this shader to open it in your script editor.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>We need to add some new properties so that we have a texture to blend with and a slider for an opacity value. Enter the following code in your new shader:</li></ol></div><pre class="programlisting">Properties 
{
  _MainTex ("Base (RGB)", 2D) = "white" {}
  _BlendTex ("Blend Texture", 2D) = "white"{}
  _Opacity ("Blend Opacity", Range(0,1)) = 1
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Enter the corresponding <span>variables</span><a id="id325465310" class="indexterm"></a> in our <code class="literal">CGPROGRAM</code> so that we can <span>access</span><a id="id325465322" class="indexterm"></a> the data from our <code class="literal">Properties</code> block, replacing the previously created variables:</li></ol></div><pre class="programlisting">Pass
{
  CGPROGRAM
  #pragma vertex vert_img
  #pragma fragment frag
  #pragma fragmentoption ARB_precision_hint_fastest
  #include "UnityCG.cginc"

<span class="strong"><strong>  uniform sampler2D _MainTex;</strong></span>
<span class="strong"><strong>  uniform sampler2D _BlendTex;</strong></span>
<span class="strong"><strong>  fixed _Opacity;</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>We modify our <code class="literal">frag()</code> function so that it performs the multiply operation on our two textures:</li></ol></div><pre class="programlisting">fixed4 frag(v2f_img i) : COLOR
{
  //Get the colors from the RenderTexture and the uv's
  //from the v2f_img struct
  fixed4 renderTex = tex2D(_MainTex, i.uv);
  fixed4 blendTex = tex2D(_BlendTex, i.uv);

  //Perform a multiply Blend mode
  fixed4 blendedMultiply = renderTex * blendTex;

  //Adjust amount of Blend Mode with a lerp
  renderTex = lerp(renderTex, blendedMultiply, _Opacity);

  return renderTex;
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Save the shader and return to the Unity editor to let the new shader code compile and check for errors. If no errors occurred, then we can move on to creating our script file.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Now that the shader is finished, let's work on the script needed to make the effect show up. From the <strong class="userinput"><code>Project</code></strong> tab, go to the <code class="literal">Chapter 09 </code>| <code class="literal">Scripts</code> folder. Once there, select the <code class="literal">TestRenderImage</code> script and duplicate it by pressing <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>D</em></span>. Rename the newly created script to <code class="literal">RenderBlendMode</code>. Once renamed, double-click on it to enter your IDE of choice.</li><li>Our first step in modifying our script is to rename the class to match our filename, <code class="literal">RenderBlendMode</code>:</li></ol></div><pre class="programlisting">[ExecuteInEditMode]
public class RenderBlendMode : MonoBehaviour {</pre><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>In our script file, we need to create the corresponding variables. We will need a texture so that we can assign one to the shader and a slider to <span>adjust</span><a id="id325209560" class="indexterm"></a> the final <span>amount</span><a id="id325209604" class="indexterm"></a> of the Blend mode we want to use:</li></ol></div><pre class="programlisting">#region Variables
public Shader curShader;
public Texture2D blendTexture;
public float blendOpacity = 1.0f;
private Material screenMat;
#endregion</pre><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>We then need to send our variable data to the shader through the <code class="literal">OnRenderImage()</code> function:</li></ol></div><pre class="programlisting">void OnRenderImage(RenderTexture sourceTexture, RenderTexture destTexture)
{
    if (curShader != null)
    {
        ScreenMat.SetTexture("_BlendTex", blendTexture);
        ScreenMat.SetFloat("_Opacity", blendOpacity);

        Graphics.Blit(sourceTexture, destTexture, ScreenMat);
    }
    else
    {
        Graphics.Blit(sourceTexture, destTexture);
    }
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>To complete the script, we simply fill in our <code class="literal">Update()</code> function so that we can clamp the value of the <code class="literal">blendOpacity</code> variable between a value of <code class="literal">0.0</code> and <code class="literal">1.0</code>:</li></ol></div><pre class="programlisting">void Update()
{
    blendOpacity = Mathf.Clamp(blendOpacity, 0.0f, 1.0f);
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="11" type="1"><li>With this complete, we assign the <span>screen</span><a id="id325209667" class="indexterm"></a> effect script to our <strong class="userinput"><code>Main Camera</code></strong> (remove the previous <code class="literal">Render BSC</code> script if it is attached) and add our screen effect shader to our script so that it has a shader to use for the per-pixel operations. In order for the effect to be fully functional, the script <span>and</span><a id="id325453497" class="indexterm"></a> shader look for a texture. You can assign any texture to the <strong class="userinput"><code>Texture</code></strong> field in the <strong class="userinput"><code>Inspector</code></strong> for the screen effect script. Once this texture is in place, you will see the effect of multiplying this texture over the game's rendered screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/a87845ae-8b30-4bdd-aae9-f44598ec31df.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="12" type="1"><li>The following screenshot demonstrates the screen effect with a smaller <code class="literal">Blend Opacity</code> option:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/a1bb9a7b-f542-4424-a36b-0b41fad3af86.png" /></div><p>With our first blend mode set up, we can begin to add a couple of simpler blend modes to get a better understanding of how easy it is to add more effects and really fine-tune the <span>final</span><a id="id325453542" class="indexterm"></a> result in <span>your</span><a id="id325453552" class="indexterm"></a> game. However, first let's break down what is happening here.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec153"></a>How it works...</h3></div></div></div><p>Now we are starting to gain a ton of power and flexibility in our screen effects programming. I am sure that you are now starting to understand how much you can do with this simple system in Unity. We can literally replicate the effects of Photoshop layer blending modes in our game to give artists the flexibility they need to achieve high-quality graphics in a short amount of time.</p><p>With this particular recipe, we look at how to multiply two images together, add two images together, and perform a screen blending mode, using just a little bit of mathematics. When working with Blend modes, you have to think on a per-pixel level. For instance, when we are using the multiply blend mode, we literally take each pixel from the original <code class="literal">RenderTexture</code> and multiply it by each pixel of the Blend texture. The same goes for the add Blend mode. It is just a simple mathematical operation of adding each pixel from the source texture, or <code class="literal">RenderTexture</code>, to the Blend texture.</p><p>The screen Blend mode is definitely a bit <span>more</span><a id="id325453577" class="indexterm"></a> involved, but it is actually doing the same thing. It takes each image, <code class="literal">RenderTexture</code>, and Blend texture, inverts them, <span>then multiplies them together</span>, and inverts them again to achieve the final look. Just as Photoshop blends its textures together using blend modes, we can do the <span>same</span><a id="id325453594" class="indexterm"></a> with screen effects.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec154"></a>There's more...</h3></div></div></div><p>Let's continue this recipe by adding a couple <span>more</span><a id="id325453609" class="indexterm"></a> blend modes to <span>our</span><a id="id325453618" class="indexterm"></a> screen effect:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In the screen effect shader, let's add the following code to our <code class="literal">frag()</code> function and change the value we are returning to our script. We will also need to comment out the multiply blend so that we don't return that as well:</li></ol></div><pre class="programlisting">fixed4 frag(v2f_img i) : COLOR
{
  //Get the colors from the RenderTexture and the uv's
  //from the v2f_img struct
  fixed4 renderTex = tex2D(_MainTex, i.uv);
  fixed4 blendTex = tex2D(_BlendTex, i.uv);

  //Perform a multiply Blend mode
<span class="strong"><strong>  //fixed4 blendedMultiply = renderTex * blendTex;</strong></span>

<span class="strong"><strong>  //Perform an additive Blend mode</strong></span>
<span class="strong"><strong>  fixed4 blendedAdd = renderTex + blendTex;</strong></span>

  //Adjust amount of Blend Mode with a lerp
  renderTex = lerp(renderTex, <span class="strong"><strong>blendedAdd</strong></span>, _Opacity);

  return renderTex;
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Save the shader file in your IDE of choice and <code class="literal">MonoDevelop</code> and return to the Unity editor to let the shader compile. If no errors occurred, you should see a result similar to the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/c4315029-be0d-4e75-8ad1-97c9cc31d4b0.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>This is a simple add <span>blending</span><a id="id325453720" class="indexterm"></a> mode <span>with</span><a id="id325454037" class="indexterm"></a> a figure of <code class="literal">0.5</code> set for the <code class="literal">Blend Opacity</code>:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/9c15701e-2802-49d6-a9f8-b2f1c5ef633e.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip74"></a>Note</h3><p><span> As</span> you can see, this has the opposite effect of multiply because we are adding the two images together.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Finally, let's add one more blend mode called a screen blend. This one is a little bit more involved, from a mathematical standpoint, but still simple to implement. Enter the following code in the <code class="literal">frag()</code> function of our shader:</li></ol></div><pre class="programlisting">    fixed4 frag(v2f_img i) : COLOR
    {
      //Get the colors from the RenderTexture and the uv's
      //from the v2f_img struct
      fixed4 renderTex = tex2D(_MainTex, i.uv);
      fixed4 blendTex = tex2D(_BlendTex, i.uv);

      //Perform a multiply Blend mode
      //fixed4 blendedMultiply = renderTex * blendTex;

      //Perform an additive Blend mode
<span class="strong"><strong>      //fixed4 blendedAdd = renderTex + blendTex;</strong></span>

<span class="strong"><strong>      //Perform screen blending mode</strong></span>
<span class="strong"><strong>      fixed4 blendedScreen = (1.0 - ((1.0 - renderTex) * (1.0 - blendTex)));</strong></span>

      //Adjust amount of Blend Mode with a lerp
      renderTex = lerp(renderTex, <span class="strong"><strong>blendedScreen</strong></span>, _Opacity);

      return renderTex;
    }
</pre><p>The following screenshot <span>demonstrates</span><a id="id325454107" class="indexterm"></a> the results of <span>using</span><a id="id325454116" class="indexterm"></a> a screen type Blend mode to blend two images together in a screen effect:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/355fa221-ad3a-47f0-b5ff-2caedaf9cb64.png" /></div><p>Here's a screenshot displaying the effect:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/f9f2d080-a77e-4dbf-b0a0-6a477686f7cb.png" /></div></div></div>