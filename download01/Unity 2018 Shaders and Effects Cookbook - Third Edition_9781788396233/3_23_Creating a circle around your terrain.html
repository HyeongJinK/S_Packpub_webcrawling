<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec30"></a>Creating a circle around your terrain</h2></div></div><hr /></div><p>Many RTS games display distances (range attack, moving distance, sight, and so on) by drawing a circle around the selected unit. If the terrain is flat, this can be done <span>simply</span><a id="id325209443" class="indexterm"></a> by <span>stretching</span><a id="id325209451" class="indexterm"></a> a quad with the texture of a circle. If that's not the case, the quad will most likely be clipped behind a hill or another piece of geometry. This recipe will show you how to create a shader that allows you to draw circles around an object of arbitrary complexity. If you want to be able to move or animate your circle, we will need both a shader and C# script.</p><p>The following screenshot shows an example of drawing a circle in a hilly region using a shader:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/7fa4c19b-0730-4b15-96ef-192d961567a1.png" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec63"></a>Getting ready</h3></div></div></div><p>Despite working with every piece of geometry, this technique is oriented to terrains. Hence, the first step is setting up a terrain in Unity, but instead of using a model, we will create one within the Unity editor:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Let's start by creating a new shader called <code class="literal">RadiusShader</code> and the respective material, <code class="literal">RadiusMat</code>.</li><li>Have the character for your object ready; we will draw a circle around it.</li><li>From the menu, navigate to <strong class="userinput"><code>GameObject</code></strong> | <strong class="userinput"><code>3D Object</code></strong> | <strong class="userinput"><code>Terrain</code></strong> to create a new terrain.</li><li>Create the geometry for your terrain. You can either import an existing one or draw your own using the tools available (<strong class="userinput"><code>Raise/Lower Terrain</code></strong>, <strong class="userinput"><code>Paint Height</code></strong>, <strong class="userinput"><code>Smooth Height</code></strong>).</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>The terrains are special objects in Unity, and the way texture mapping works on them is different from traditional 3D models. You cannot provide <code class="literal">_MainTex</code> from a shader as it needs to be provided directly from the terrain itself. To do this, select <strong class="userinput"><code>Paint Texture</code></strong><span>and</span><a id="id325453581" class="indexterm"></a> then <span>click</span><a id="id325453591" class="indexterm"></a> on <strong class="userinput"><code>Add Texture...</code></strong>:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/426d9b4e-030e-45d1-8793-78973e566472.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note43"></a>Note</h3><p>The creation  of a terrain isn't covered in this book, but if you would like to learn more about it, check out the following link: <a class="ulink" href="https://docs.unity3d.com/Manual/terrain-UsingTerrains.html" target="_blank">https://docs.unity3d.com/Manual/terrain-UsingTerrains.html</a></p></div><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Now that the texture is set, you <span>have</span><a id="id325454776" class="indexterm"></a> to change the material of the terrain so that a custom shader can be provided. From <strong class="userinput"><code>Terrain Settings</code></strong>, change the <strong class="userinput"><code>Material</code></strong> property to <code class="literal">Custom</code>, and then drag the <strong class="userinput"><code>Radius</code></strong> material to the <code class="literal">Custom Material</code> box:</li></ol></div><p></p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/e263bf33-5eea-40c6-abf9-fa4f22f5b0f2.png" /></div><p>You are now ready to create your shader.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec64"></a>How to do it...</h3></div></div></div><p>Let's start by editing the <code class="literal">RadiusShader</code> file:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In the <span>new</span><a id="id325454854" class="indexterm"></a> shader, remove the <code class="literal">_Glossiness</code> and <code class="literal">_Metallic</code> properties <span>and</span><a id="id325454869" class="indexterm"></a> add these four properties:</li></ol></div><pre class="programlisting">_Center("Center", Vector) = (200,0,200,0) 
_Radius("Radius", Float) = 100 
_RadiusColor("Radius Color", Color) = (1,0,0,1) 
_RadiusWidth("Radius Width", Float) = 10</pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Add their respective variables to the <code class="literal">CGPROGRAM</code> section, remembering to remove the declaration of <code class="literal">_Glossiness</code> and <code class="literal">_Metallic</code>:</li></ol></div><pre class="programlisting">float3 _Center; 
float _Radius; 
fixed4 _RadiusColor; 
float _RadiusWidth; </pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li><code class="literal">Input</code> to <span>our</span> surface function requires not only the UV of the texture but also the position (in world coordinates) of every point of the terrain. We can retrieve this parameter by changing the <code class="literal">struct Input </code> as follows:</li></ol></div><pre class="programlisting">struct Input 
{ 
  float2 uv_MainTex; // The UV of the terrain texture 
  float3 worldPos;   // The in-world position 
}; </pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Lastly, we use this surface function:</li></ol></div><pre class="programlisting">void surf(Input IN, inout SurfaceOutputStandard o) 
{
  // Get the distance between the center of the 
  // place we wish to draw from and the input's 
  // world position
  float d = distance(_Center, IN.worldPos);

  // If the distance is larger than the radius and
  // it is less than our radius + width change the color
  if ((d &gt; _Radius) &amp;&amp; (d &lt; (_Radius + _RadiusWidth)))
  {
    o.Albedo = _RadiusColor;
  }
  // Otherwise, use the normal color
  else
  {
    o.Albedo = tex2D(_MainTex, IN.uv_MainTex).rgb;
  }
}</pre><p>These steps are all it <span>takes</span><a id="id325460917" class="indexterm"></a> to draw a <span>circle</span><a id="id325460925" class="indexterm"></a> on your terrain. You can use the material's Inspector tab to change the position, radius, and color of the circle:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/722b4c6b-2bbd-41c0-b499-9465aa86835c.png" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl3sec0"></a>Moving the circle</h4></div></div></div><p>This is great, but you'll likely also <span>want</span><a id="id325463146" class="indexterm"></a> to change where the <span>circle</span><a id="id325463155" class="indexterm"></a> is at run-time, which we can do via code. If you want the circle to follow your character, other steps are necessary:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Create a new C# script called <code class="literal">SetRadiusProperties</code>.</li><li>Since you may wish to see this change both in the game and outside, we can add a tag to the top of the class saying to execute this code while in the editor, in addition to when the game is being played, by adding the following tag:</li></ol></div><pre class="programlisting"><span class="strong"><strong>[ExecuteInEditMode]</strong></span>
public class SetRadiusProperties : MonoBehaviour</pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Add these properties to the script:</li></ol></div><pre class="programlisting">public Material radiusMaterial; 
public float radius = 1; 
public Color color = Color.white; </pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>In the <code class="literal">Update()</code> method, add these lines of code:</li></ol></div><pre class="programlisting">if(radiusMaterial != null)
{
    radiusMaterial.SetVector("_Center", transform.position);
    radiusMaterial.SetFloat("_Radius", radius);
    radiusMaterial.SetColor("_RadiusColor", color);
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Attach the script to the object you wish to have the circle drawn around.</li><li>Finally, drag the <code class="literal">RadiusMat</code> material to the <strong class="userinput"><code>Radius Material</code></strong> slot of the script:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/429aae9a-c5fc-4c1b-8715-ea483857ffb4.png" /></div><p>You can now move your <span>character</span><a id="id325453486" class="indexterm"></a> around and this will create a nice <span>circle</span><a id="id325453495" class="indexterm"></a> around it. Changing the properties of the <code class="literal">Radius</code> script will change the radius as well.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec65"></a>How it works...</h3></div></div></div><p>The relevant parameters to draw a circle are its center, radius, and color. They are all available in the shader with the names <code class="literal">_Center</code>, <code class="literal">_Radius</code>, and <code class="literal">_RadiusColor</code>. By adding the <code class="literal">worldPos</code> variable to the <code class="literal">Input</code> structure, we are asking Unity to provide us with the position of the pixel that we are drawing expressed in world coordinates. This is the actual position of an object in the editor.</p><p>The <code class="literal">surf()</code> function is where the circle is actually drawn. It calculates the distance from the point being drawn and the center of the radius, and then it checks whether it is between <code class="literal">_Radius</code> and <code class="literal">_Radius + _RadiusWidth</code>; if this is the case, it uses the chosen color. In the other case, it just samples the texture map like all the other shaders we have seen so far.</p></div></div>