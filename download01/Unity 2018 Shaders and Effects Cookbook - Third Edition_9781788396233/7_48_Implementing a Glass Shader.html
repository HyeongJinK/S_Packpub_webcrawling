<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec51"></a>Implementing a Glass Shader</h2></div></div><hr /></div><p>Glass is a very complicated material; it should not be a surprise that other chapters have already created shaders to simulate it in the <span class="emphasis"><em>Adding transparency to PBR</em></span> recipe of <a class="link" href="#" linkend="ch05">Chapter 5</a>, <span class="emphasis"><em>Physically-Based Rendering</em></span>. We already know how to make our glasses semi-transparent to show the objects <span>behind</span><a id="id325451200" class="indexterm"></a> it perfectly and that works for a number of applications. However, most glasses are not perfect. For instance, if you look through a stain glass window you may notice distortions or deformations when you look through them. This recipe will teach you how to achieve that effect. The idea behind this effect is to use a Vertex and Fragment Shader with a <code class="literal">GrabPass</code>, and then sample the grab texture with a little change to its UV data to create a distortion. You can see the effect in the following screenshot, using the glass-stained textures from the Unity Standard Assets:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/10dcc055-7504-4137-b0c2-3d5e832ca3ec.png" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec127"></a>Getting ready</h3></div></div></div><p>The setup for this recipe is similar to the one presented previously in <a class="link" href="#" linkend="ch06">Chapter 6</a>, <span class="emphasis"><em>Vertex Functions</em></span>:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Create a new Vertex and Fragment Shader. You can start by copying the one used in the previous recipe, <span class="emphasis"><em>Using the grab pass to draw behind objects</em></span>, as a base by selecting it and hitting <span class="emphasis"><em>Ctrl</em></span>+<span class="emphasis"><em>D</em></span> to duplicate it. Once duplicated, change its name to <code class="literal">WindowShader</code>.</li><li>Create a material that will use the shader (<code class="literal">WindowMat</code>).</li><li>Assign the material to a quad or another flat geometry that will simulate your glass.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Place some objects <span>behind</span><a id="id325453400" class="indexterm"></a> it so that you can see the distortion effect:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/0b485e74-74c8-49d8-804e-e5fe5a11f274.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec128"></a>How to do it…</h3></div></div></div><p>Let's start by editing the Vertex and Fragment Shaders:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Create a <code class="literal">Properties</code> block with these items in it:</li></ol></div><pre class="programlisting">Properties 
{
  _MainTex("Base (RGB) Trans (A)", 2D) = "white" {}
  _Colour("Colour", Color) = (1,1,1,1)
  _BumpMap("Noise text", 2D) = "bump" {}
  _Magnitude("Magnitude", Range(0,1)) = 0.05
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Add their variables in the second pass:</li></ol></div><pre class="programlisting">sampler2D _MainTex;
fixed4 _Colour;

sampler2D _BumpMap;
float _Magnitude;</pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Add the texture information to the input and output structures:</li></ol></div><pre class="programlisting">float2 texcoord : TEXCOORD0;</pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Transfer the UV data from the <span>input</span><a id="id325454834" class="indexterm"></a> to the output structure:</li></ol></div><pre class="programlisting">// Vertex function
vertOutput vert(vertInput v) 
{
  vertOutput o;
  o.vertex = UnityObjectToClipPos(v.vertex);
  o.uvgrab = ComputeGrabScreenPos(o.vertex);
<span class="strong"><strong>o.texcoord = v.texcoord;</strong></span>
  return o;
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Use the following Fragment function:</li></ol></div><pre class="programlisting">half4 frag(vertOutput i) : COLOR 
{
  half4 mainColour = tex2D(_MainTex, i.texcoord);
  half4 bump = tex2D(_BumpMap, i.texcoord);
  half2 distortion = UnpackNormal(bump).rg;

  i.uvgrab.xy += distortion * _Magnitude;

  fixed4 col = tex2Dproj(_GrabTexture, UNITY_PROJ_COORD(i.uvgrab));
  return col * mainColour * _Colour;
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>This material is transparent, so it changes its tags in the <code class="literal">SubShader</code> block:</li></ol></div><pre class="programlisting">Tags{ "Queue" = "Transparent" "IgnoreProjector" = "True" "RenderType" =
  "Opaque" }</pre><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>What's left now is to set the texture for the glass, and for a normal map to displace the grab texture:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/ab6ab4ea-527e-45c6-8ee7-ad1db323c7d9.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec129"></a>How it works…</h3></div></div></div><p>The core that this shader uses is a grab pass to take what has already been rendered on the screen. The part where the distortion takes place is in the Fragment function. Here, a <span>normal</span><a id="id325457702" class="indexterm"></a> map is unpacked and used to offset the UV data of the grab texture:</p><pre class="programlisting">half4 bump = tex2D(_BumpMap, i.texcoord);
half2 distortion = UnpackNormal(bump).rg;

i.uvgrab.xy += distortion * _Magnitude;</pre><p>The <code class="literal">_Magnitude</code> slider is used to determine how strong the effect is:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/c84b714c-cd47-4e68-b376-53debc26660a.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec130"></a>There's more…</h3></div></div></div><p>This effect is very generic; it grabs the screen and creates a distortion based on a normal map. There is no reason why it shouldn't be used to simulate more interesting things. Many games use distortions around explosions or other sci-fi devices. This material can be applied to a sphere and, with a different <span>normal</span><a id="id325460910" class="indexterm"></a> map, it would simulate the heat wave of an explosion perfectly.</p></div></div>