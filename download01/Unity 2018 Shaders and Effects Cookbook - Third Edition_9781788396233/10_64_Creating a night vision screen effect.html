<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec64"></a>Creating a night vision screen effect</h2></div></div><hr /></div><p>Our next screen effect is definitely a <span>more</span><a id="id325209384" class="indexterm"></a> popular one. The night vision screen effect is seen in <span class="emphasis"><em>Call of Duty: Modern Warfare</em></span>, <span class="emphasis"><em>Halo</em></span>, and just about any first-person shooter out in the market today. It is the effect of brightening the whole image using that very distinct lime-green color.</p><p>In order to achieve our night vision effect, we need to break down our effect using Photoshop. It is a simple process of finding some reference images online and composing a layered image to see what kind of blending modes you will need or in which order we will need to combine our layers. The following screenshot shows the result of performing just this process in Photoshop:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/469ad236-72f2-4dfc-877f-1f59be5e7f6c.png" /></div><p>Let's begin to break down our rough Photoshop composite <span>image</span><a id="id325209413" class="indexterm"></a> into its component parts so that we can better understand the assets we will have to gather. In the next recipe, we will cover the process of doing this.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec161"></a>Getting ready</h3></div></div></div><p>Let's begin this screen effect by again breaking down our effect into its component layers. Using Photoshop, we can construct a layered image to better illustrate how we can go about capturing the effect of night vision:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Tinted green</strong></span>: Our first layer in our <span>screen</span><a id="id325219385" class="indexterm"></a> effect is the iconic green color, found in just about every night vision image. This will give our effect that signature night vision look, as shown in the following screenshot:</li></ul></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/bda3ea5e-e18f-4841-8b92-282ba647a795.png" /></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Scan lines</strong></span>: To increase the <span>effect</span><a id="id325442700" class="indexterm"></a> of this being a new type of display for the player, we include scan lines over the top of our tinted layer. For this, we will use a texture created in Photoshop and let the user tile it so that the scan lines can be bigger or smaller.
</li><li style="list-style-type: disc"><span class="strong"><strong>Noise</strong></span>: Our next layer is a simple noise <span>texture</span><a id="id325442714" class="indexterm"></a> that we tile over the tinted image and scan lines to break up the image and add even more detail to our effect. This layer simply emphasizes that digital read-out look:</li></ul></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/90061d70-7115-4c27-8849-8654a081c961.png" /></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Vignette</strong></span>: The last layer in our night vision effect is the vignette. If you look at the night vision effect in <span class="emphasis"><em>Call of Duty: Modern Warfare</em></span>, you will <span>notice</span><a id="id325445066" class="indexterm"></a> that it uses a vignette that fakes the effect of looking down a scope. We will do that for this screen effect:</li></ul></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/39871be4-a061-4f0c-a557-caac443a022e.png" /></div><p>Let's create a screen effect system by gathering our textures. Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Gather up a vignette texture, noise texture, and scan line texture, like the ones we just saw. Like before, I have these textures available in the book's example code under the <code class="literal">Chapter 10</code> | <code class="literal">Textures</code> folder.</li><li>Find a sample scene to make it easy to see the effect of the shader. I will be using the same scene as in the previous recipe, so feel free to use the <code class="literal">10.1 Sample Scene</code> again.</li><li>Create a new shader by duplicating the <code class="literal">ScreenGrayscale</code> code; select it from the <strong class="userinput"><code>Project</code></strong> tab under the <code class="literal">Chapter 9</code> | <code class="literal">Shaders</code> folder and press <span class="emphasis"><em>Ctrl </em></span>+ <span class="emphasis"><em>D</em></span>. Once duplicated, rename the script to  <code class="literal">ScreenNightVision</code>. Then drag and drop the script into the <code class="literal">Chapter 10 </code>| <code class="literal">Shaders</code> folder, creating it if needed.</li><li>Next, go the <code class="literal">Chapter 9 </code>| <code class="literal">Scripts</code> folder and duplicate the <code class="literal">TestRenderImage</code> script. Rename the new file to <code class="literal">RenderNightVision</code> and then drag and drop it into the <code class="literal">Chapter 10 </code>| <code class="literal">Scripts</code> folder, creating it if needed.</li></ol></div><p>Finally, with our screen effect system up and <span>running</span><a id="id325451210" class="indexterm"></a> and our textures gathered, we can begin the process of recreating this <span>night vision</span> effect.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec162"></a>How to do it...</h3></div></div></div><p>With all of our assets gathered and the screen effect system running smoothly, let's begin to add the code necessary to both the script and shader. We will begin our coding with the <code class="literal">RenderNightVision.cs</code> script, so double-click on this file now to open it in your code editor of choice:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>We will begin by entering the code in our script. Our first step in modifying our script is to rename the class to match our filename, <code class="literal">RenderNightVision</code>:</li></ol></div><pre class="programlisting">[ExecuteInEditMode]
public class <span class="strong"><strong>RenderNightVision </strong></span>: MonoBehaviour {</pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>We need to create a few variables that will allow the user of this effect to adjust it in the script's <strong class="userinput"><code>Inspector</code></strong>. Enter the following code in the <code class="literal">NightVisionEffect.cs</code> script:</li></ol></div><pre class="programlisting">#region Variables 
    public Shader curShader; 
     
    public float contrast = 3.0f; 
    public float brightness = 0.1f; 
    public Color nightVisionColor = Color.green; 
     
    public Texture2D vignetteTexture; 
     
    public Texture2D scanLineTexture; 
    public float scanLineTileAmount = 4.0f; 
     
    public Texture2D nightVisionNoise; 
    public float noiseXSpeed = 100.0f; 
    public float noiseYSpeed = 100.0f; 
     
    public float distortion = 0.2f; 
    public float scale = 0.8f; 
     
    private float randomValue = 0.0f; 
    private Material screenMat; 
    #endregion </pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Next, we need to complete our <code class="literal">OnRenderImage()</code> function so that we are passing the right data to the shader in order for the shader to process the screen effect properly. Complete the <code class="literal">OnRenderImage()</code> function with the following code:</li></ol></div><pre class="programlisting">void OnRenderImage(RenderTexture sourceTexture, RenderTexture destTexture)
{
    if (curShader != null)
    {
        ScreenMat.SetFloat("_Contrast", contrast);
        ScreenMat.SetFloat("_Brightness", brightness);
        ScreenMat.SetColor("_NightVisionColor", nightVisionColor);
        ScreenMat.SetFloat("_RandomValue", randomValue);
        ScreenMat.SetFloat("_distortion", distortion);
        ScreenMat.SetFloat("_scale", scale);

        if (vignetteTexture)
        {
            ScreenMat.SetTexture("_VignetteTex", vignetteTexture);
        }

        if (scanLineTexture)
        {
            ScreenMat.SetTexture("_ScanLineTex", scanLineTexture);
            ScreenMat.SetFloat("_ScanLineTileAmount", scanLineTileAmount);
        }

        if (nightVisionNoise)
        {
            ScreenMat.SetTexture("_NoiseTex", nightVisionNoise);
            ScreenMat.SetFloat("_NoiseXSpeed", noiseXSpeed);
            ScreenMat.SetFloat("_NoiseYSpeed", noiseYSpeed);
        }

        Graphics.Blit(sourceTexture, destTexture, ScreenMat);
    }
    else
    {
        Graphics.Blit(sourceTexture, destTexture);
    }
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>To complete the <code class="literal">NightVisionEffect.cs</code> script, we simply need to make sure that we clamp certain variables so that they stay within a range. These ranges are <span>arbitrary</span><a id="id325454749" class="indexterm"></a> and can be changed at a later time. These are just values that worked well:</li></ol></div><pre class="programlisting">void Update()
{
    contrast = Mathf.Clamp(contrast, 0f, 4f);
    brightness = Mathf.Clamp(brightness, 0f, 2f);
    randomValue = Random.Range(-1f, 1f);
    distortion = Mathf.Clamp(distortion, -1f, 1f);
    scale = Mathf.Clamp(scale, 0f, 3f);
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>We can now turn our attention over to the shader portion of this screen effect. Open the shader, if you haven't already, and begin by entering the following properties in the <code class="literal">Properties</code> block:</li></ol></div><pre class="programlisting">Properties 
{ 
    _MainTex ("Base (RGB)", 2D) = "white" {} 
    _VignetteTex ("Vignette Texture", 2D) = "white"{} 
    _ScanLineTex ("Scan Line Texture", 2D) = "white"{} 
    _NoiseTex ("Noise Texture", 2D) = "white"{} 
    _NoiseXSpeed ("Noise X Speed", Float) = 100.0 
    _NoiseYSpeed ("Noise Y Speed", Float) = 100.0 
    _ScanLineTileAmount ("Scan Line Tile Amount", Float) = 4.0 
    _NightVisionColor ("Night Vision Color", Color) = (1,1,1,1) 
    _Contrast ("Contrast", Range(0,4)) = 2 
    _Brightness ("Brightness", Range(0,2)) = 1 
    _RandomValue ("Random Value", Float) = 0 
    _distortion ("Distortion", Float) = 0.2 
    _scale ("Scale (Zoom)", Float) = 0.8 
} </pre><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>To make sure that we are passing the data from our <code class="literal">Properties</code> block to our <code class="literal">CGPROGRAM</code> block, we need to make sure to declare them with the same name in the <code class="literal">CGPROGRAM</code> block:</li></ol></div><pre class="programlisting">Pass
{
  CGPROGRAM 
  #pragma vertex vert_img 
  #pragma fragment frag 
  #pragma fragmentoption ARB_precision_hint_fastest 
  #include "UnityCG.cginc" 

  uniform sampler2D _MainTex; 
  uniform sampler2D _VignetteTex; 
  uniform sampler2D _ScanLineTex; 
  uniform sampler2D _NoiseTex; 
  fixed4 _NightVisionColor; 
  fixed _Contrast; 
  fixed _ScanLineTileAmount; 
  fixed _Brightness; 
  fixed _RandomValue; 
  fixed _NoiseXSpeed; 
  fixed _NoiseYSpeed; 
  fixed _distortion; 
  fixed _scale; </pre><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>Our effect is also going to include a lens distortion to further convey the effect that we are looking through a lens and the edges of the image are being distorted by the angle of the lens. Enter the following function just after the variable declarations in the <code class="literal">CGPROGRAM</code> block:</li></ol></div><pre class="programlisting">    float2 barrelDistortion(float2 coord)  
    { 
        // lens distortion algorithm 
        // See http://www.ssontech.com/content/lensalg.htm 
 
        float2 h = coord.xy - float2(0.5, 0.5); 
        float r2 = h.x * h.x + h.y * h.y; 
        float f = 1.0 + r2 * (_distortion * sqrt(r2)); 
 
        return f * _scale * h + 0.5; 
    } </pre><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>We can now concentrate on the meat of our <code class="literal">NightVisionEffect</code> shader. Let's start this by entering the code that is necessary to get the render texture and vignette texture. Enter the following code in the <code class="literal">frag()</code> function of our shader:</li></ol></div><pre class="programlisting">    fixed4 frag(v2f_img i) : COLOR 
    { 
        //Get the colors from the RenderTexture and the uv's 
        //from the v2f_img struct 
        half2 distortedUV = barrelDistortion(i.uv); 
        fixed4 renderTex = tex2D(_MainTex, distortedUV); 
        fixed4 vignetteTex = tex2D(_VignetteTex, i.uv); </pre><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>The next step in our <code class="literal">frag()</code> function is to <span>process</span><a id="id325454873" class="indexterm"></a> the scan lines and <code class="literal">Noise</code> textures and apply the proper animated UVs to them:</li></ol></div><pre class="programlisting">//Process scan lines and noise 
half2 scanLinesUV = half2(i.uv.x * _ScanLineTileAmount, i.uv.y * _ScanLineTileAmount); 
fixed4 scanLineTex = tex2D(_ScanLineTex, scanLinesUV); 

half2 noiseUV = half2(i.uv.x + (_RandomValue * _SinTime.z * _NoiseXSpeed), 
                  i.uv.y + (_Time.x * _NoiseYSpeed)); 
fixed4 noiseTex = tex2D(_NoiseTex, noiseUV); </pre><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>To complete all of our layers in the screen effect, we simply need to process the luminance value of our render texture, and then apply the night vision color to it to achieve that iconic night vision look:</li></ol></div><pre class="programlisting">// get the luminosity values from the render texture using the     //YIQ values. 
        fixed lum = dot (fixed3(0.299, 0.587, 0.114), renderTex.rgb); 
        lum += _Brightness; 
        fixed4 finalColor = (lum *2) + _NightVisionColor; </pre><div class="orderedlist"><ol class="orderedlist arabic" start="11" type="1"><li>Lastly, we will combine all the layers together and return the final color of our night vision effect:</li></ol></div><pre class="programlisting">  //Final output 
  finalColor = pow(finalColor, _Contrast); 
  finalColor *= vignetteTex; 
  finalColor *= scanLineTex * noiseTex; 

  return finalColor; 
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="12" type="1"><li>When you have finished entering the code, return to the Unity editor to let the script and shader compile. If there are no errors, select the <code class="literal">MainCamera</code> in your scene. Remove the <strong class="userinput"><code>Render Old Film</code></strong> component, if it is there already, and add the <code class="literal">RenderNightVision</code> component. Once there, drag and drop the <code class="literal">ScreenNightVision</code> shader into the <strong class="userinput"><code>Cur Shader</code></strong> property of the component and then <span>assign</span><a id="id325460912" class="indexterm"></a> the <strong class="userinput"><code>Night Vision Color</code></strong> property to a green color like the following: </li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/1cef2a93-75bc-4f90-9c2d-0b5350346092.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="13" type="1"><li>Afterward, assign the textures to their proper spot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/4e25ab49-91e6-4059-acb3-e9d312b9a38f.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="14" type="1"><li>Afterward, make sure to play in the editor to see the full, final version of the effect:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/be09699e-0483-40f1-a74d-1b9cf2e2be9d.png" /></div><p>The final result of our night-vision screen effect</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec163"></a>How it works...</h3></div></div></div><p>The night vision effect is actually very similar to the old film screen effect, which shows us just how modular we can make these components. Just by simply swapping the textures that we are using for overlays and changing the speed at which our tiling rates are being calculated, we can achieve very <span>different</span><a id="id325463169" class="indexterm"></a> results using the same code.</p><p>The only difference with this effect is the fact that we are including a lens distortion to our screen effect. So let's break this down so that we can get a better understanding of how it works.</p><p>The following code snippet illustrates the code used in processing our lens distortion. It is a snippet of code provided to us by the makers of <span class="emphasis"><em>SynthEyes</em></span>, and the code is freely available to use in your own effects:</p><pre class="programlisting">float2 barrelDistortion(float2 coord)  
{ 
    // lens distortion algorithm 
    // See http://www.ssontech.com/content/lensalg.htm 
    float2 h = coord.xy - float2(0.5, 0.5); 
    float r2 = h.x * h.x + h.y * h.y; 
    float f = 1.0 + r2 * (_distortion * sqrt(r2)); 
 
    return f * _scale * h + 0.5; 
} </pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec164"></a>There's more...</h3></div></div></div><p>It is not uncommon in video games to have the need to highlight certain objects. For instance, a thermal visor should only apply a post-processing effect to people and other <span>sources</span><a id="id325465005" class="indexterm"></a> of heat. Doing this is already possible with the knowledge gathered so far in this book; you can, in fact, change the shader or material of an object by code. However, this is often laborious and has to be replicated on every the object.</p><p>A more effective way to use replaced shaders. Each shader has a tag called <code class="literal">RenderType</code> that has never been used so far. This property can be used to force a camera to apply a <span>shader</span><a id="id325465472" class="indexterm"></a> only to certain objects. You can do this by attaching the following script to the camera:</p><pre class="programlisting">using UnityEngine; 
 
public class ReplacedShader : MonoBehaviour { 
 
    public Shader shader; 
    void Start () { 
        GetComponent&lt;Camera&gt;().SetReplacementShader(shader, "Heat"); 
    } 
} </pre><p>After entering the play mode, the camera will query all the objects that it has to render. If they don't have a shader decorated with <code class="literal">RenderType = "Heat"</code>, they will not be rendered. Objects with such a tag will be rendered with the shader attached to the script.</p></div></div>