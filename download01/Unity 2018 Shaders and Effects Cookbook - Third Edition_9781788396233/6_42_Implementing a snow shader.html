<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec46"></a>Implementing a snow shader</h2></div></div><hr /></div><p>The simulation of snow has always <span>been</span><a id="id325209386" class="indexterm"></a> a challenge in games. The vast majority of games simply include snow directly in the model's texture so that their tops look white. However, what if one of these objects starts rotating? Snow is not just a lick of paint on a surface; it is a proper accumulation of material and should be treated as such. This recipe shows you how to give a snowy look to your models using just a shader.</p><p>This effect is achieved in two steps. First, white is used for all the triangles facing the sky. Second, their vertices are extruded to simulate the effect of snow accumulation. You can see the result in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/a0d4435e-3f59-4017-9fa4-eb84c6aacadb.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note59"></a>Note</h3><p>Keep in mind that this recipe does not aim to create a photorealistic snow effect. It provides a good starting point, but it is up to the artist to create the right textures and find the right parameters to make it fit your game.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec109"></a>Getting ready</h3></div></div></div><p>This effect is purely <span>based</span><a id="id325209420" class="indexterm"></a> on shaders. We will need the following:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Create a new shader for the snow effect (<code class="literal">SnowShader</code>).</li><li>Create a new material for the shader (<code class="literal">SnowMat</code>).</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Assign the newly created material to the object that you want to be snowy and assign a color so it's easier to tell where the snow is:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/9196b1b5-8a1a-4eca-83ae-35545b44f595.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec110"></a>How to do it…</h3></div></div></div><p>To create a snowy effect, open your <span>shader</span><a id="id325442708" class="indexterm"></a> and make the following changes:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Replace the properties of the shader with the following ones:</li></ol></div><pre class="programlisting">_Color("Main Color", Color) = (1.0,1.0,1.0,1.0)
_MainTex("Base (RGB)", 2D) = "white" {}
_Bump("Bump", 2D) = "bump" {}
_Snow("Level of snow", Range(1, -1)) = 1
_SnowColor("Color of snow", Color) = (1.0,1.0,1.0,1.0)
_SnowDirection("Direction of snow", Vector) = (0,1,0)
_SnowDepth("Depth of snow", Range(0,1)) = 0</pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Complete them with their relative variables:</li></ol></div><pre class="programlisting"><span class="strong"><strong>sampler2D</strong></span> _MainTex;
<span class="strong"><strong>sampler2D</strong></span> _Bump;
<span class="strong"><strong>float</strong></span> _Snow;
<span class="strong"><strong>float4</strong></span> _SnowColor;
<span class="strong"><strong>float4</strong></span> _Color;
<span class="strong"><strong>float4</strong></span> _SnowDirection;
<span class="strong"><strong>float</strong></span> _SnowDepth;</pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Replace the <code class="literal">Input</code> structure with the following one:</li></ol></div><pre class="programlisting">struct Input 
{
  float2 uv_MainTex;
  float2 uv_Bump;
  float3 worldNormal;
  INTERNAL_DATA
};</pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Replace the surface function <span>with</span><a id="id325445200" class="indexterm"></a> the following one. It will color the snowy parts of the model white:</li></ol></div><pre class="programlisting">void surf(Input IN, inout SurfaceOutputStandard o) 
{
  half4 c = tex2D(_MainTex, IN.uv_MainTex);

  o.Normal = UnpackNormal(tex2D(_Bump, IN.uv_Bump));

  if (dot(WorldNormalVector(IN, o.Normal), _SnowDirection.xyz) 
      &gt;= _Snow)
  {
  o.Albedo = _SnowColor.rgb;
  }
  else
  {
  o.Albedo = c.rgb * _Color;
  }

  o.Alpha = 1;
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Configure the <code class="literal">#pragma</code> directive so that it uses vertex modifiers:</li></ol></div><pre class="programlisting">#pragma surface surf Standard vertex:vert</pre><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Add the following vertex modifiers, which extrude the vertices covered in snow:</li></ol></div><pre class="programlisting">void vert(inout appdata_full v) 
{
  float4 sn = mul(UNITY_MATRIX_IT_MV, _SnowDirection);

  if (dot(v.normal, sn.xyz) &gt;= _Snow)
  {
    v.vertex.xyz += (sn.xyz + v.normal) * _SnowDepth * _Snow;
  }
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>You can now use the material's <strong class="userinput"><code>Inspector</code></strong> tab to <span>select</span><a id="id325453364" class="indexterm"></a> how much of your model is going to be covered and how thick the snow should be:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/f4095731-97f1-47b0-9389-c67aeb5d1033.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec111"></a>How it works…</h3></div></div></div><p><span>This shader works in two steps:</span></p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Coloring the surface</li><li style="list-style-type: disc">Altering the geometry.</li></ul></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec8"></a>Coloring the surface</h4></div></div></div><p>The first step alters the color of the triangles that are facing the sky. It affects all the triangles with a normal direction similar to <code class="literal">_SnowDirection</code>. As <span>seen</span><a id="id325453409" class="indexterm"></a> before in <a class="link" href="#" linkend="ch04">Chapter 3</a>, <span class="emphasis"><em>Understanding Lighting Models</em></span>, comparing unit vectors can be done using the <span class="strong"><strong>dot product</strong></span>. When two vectors are orthogonal, their dot product is zero; it is one (or minus one) when they are parallel to each other. The <code class="literal">_Snow</code> property is used to <span>decide</span><a id="id325453509" class="indexterm"></a> how aligned they should be in order to be considered as facing the sky.</p><p>If you look closely at the surface function, you can see that we are not dotting the normal and snow direction directly. This is because they are usually defined in a different space. The snow direction is expressed in world coordinates, while the object normals are usually relative to the model itself. If we rotate the model, its normals will not change, which is not what we want. To fix this, we need to convert the normals from their object coordinates to world coordinates. This is done with the <code class="literal">WorldNormalVector()</code> function, as seen in the following code:</p><pre class="programlisting"><span class="strong"><strong>if</strong></span>(dot(WorldNormalVector(IN, o.Normal), _SnowDirection.xyz) &gt;=
  _Snow)
{
  o.Albedo = _SnowColor.rgb;
}
<span class="strong"><strong>else
</strong></span>{
  o.Albedo = c.rgb * _Color;
}</pre><p>This shader simply colors the model white; a more advanced one should initialize the <code class="literal">SurfaceOutputStandard</code> structure with textures and parameters from a realistic snow material.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec9"></a>Altering the geometry</h4></div></div></div><p>The second effect of this shader alters the <span>geometry</span><a id="id325453638" class="indexterm"></a> to simulate the accumulation of snow. Firstly, we identify which triangles have been colored white by testing the same condition used in the surface function. This time, unfortunately, we cannot rely on <code class="literal">WorldNormalVector()</code> as the <code class="literal">SurfaceOutputStandard</code> structure is not yet initialized in the vertex modifier. We use this other method instead, which converts <code class="literal">_SnowDirection</code> to object coordinates:</p><pre class="programlisting"><span class="strong"><strong>float4</strong></span>sn = mul(UNITY_MATRIX_IT_MV, _SnowDirection);</pre><p>Then, we can extrude the geometry to simulate the accumulation of snow:</p><pre class="programlisting"><span class="strong"><strong>if</strong></span>(dot(v.normal, sn.xyz) &gt;= _Snow)
{
    v.vertex.xyz += (sn.xyz + v.normal) * _SnowDepth * _Snow;
}</pre><p>Once again, this is a very basic effect. You could use a texture map to control the accumulation of snow more precisely or give a peculiar, uneven look.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec112"></a>See also</h3></div></div></div><p>If you need high-quality snow effects <span>and</span><a id="id325454780" class="indexterm"></a> props for your game, you can also check these resources on the Unity Asset Store:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Winter Suite ($30)</strong></span>: A much more sophisticated version of the snow shader presented in this recipe can be found at <a class="ulink" href="https://www.assetstore.unity3d.com/en/#!/content/13927" target="_blank">https://www.assetstore.unity3d.com/en/#!/content/13927</a>.</li><li style="list-style-type: disc"><span class="strong"><strong>Winter Pack ($60)</strong></span>: A very realistic set of props and materials for snowy environments can be found at <a class="ulink" href="https://www.assetstore.unity3d.com/en/#!/content/13316" target="_blank">https://www.assetstore.unity3d.com/en/#!/content/13316</a>.</li></ul></div></div></div>