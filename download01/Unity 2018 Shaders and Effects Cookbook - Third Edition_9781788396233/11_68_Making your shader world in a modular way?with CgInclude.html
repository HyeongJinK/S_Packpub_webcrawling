<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch11lvl1sec67"></a>Making your shader world in a modular way with CgInclude</h2></div></div><hr /></div><p>Knowing about the built-in <code class="literal">CgInclude</code> files is great, but what if we want to build our own <code class="literal">CgInclude</code> files to store our own lighting models and helper functions? We can, in fact, create our own <code class="literal">CgInclude</code> files, but we need to learn a little more code syntax before we can start using them <span>efficiently</span><a id="id325209386" class="indexterm"></a> in our shader-writing pipelines. Let's take a look at the process of creating a new <code class="literal">CgInclude</code> file from scratch.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec169"></a>Getting ready</h3></div></div></div><p>Let's walk through the process of generating a new item for this recipe:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>From the <strong class="userinput"><code>Project</code></strong> tab, right-click on the <code class="literal">Assets</code> folder and select <strong class="userinput"><code>Show in Explorer</code></strong>. You should see your project folder. Then create a text file by right-clicking and selecting <strong class="userinput"><code>New | Text Document</code></strong>:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/bedc118e-8681-411f-90a0-7a6ed3f7b397.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Rename the file to <code class="literal">MyCGInclude</code> and replace the <code class="literal">.txt</code> file extension with <code class="literal">.cginc</code>: </li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/59367882-16c1-4b31-a97e-e7d0c6943e49.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Windows will give you a warning message saying that the <strong class="userinput"><code>File may become unusable</code></strong>, but it will still work.</li><li>Import this new <code class="literal">.cginc</code> file into your Unity project and let it compile. If all goes well, you will see that Unity knew to compile it into a <code class="literal">CgInclude</code> file.</li></ol></div><p>We are now ready to begin creating our own custom <code class="literal">CgInclude</code> code. Simply double-click on the <code class="literal">CgInclude</code> file that you created in order to open it in your IDE of choice.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec170"></a>How to do it...</h3></div></div></div><p>With our <code class="literal">CgInclude</code> file open, we can begin to enter the code that will get it working with our Surface Shaders. <span>The following steps</span> will get our <code class="literal">CgInclude</code> file ready for use <span>within</span><a id="id325445063" class="indexterm"></a> our Surface Shaders and allow us to continually add more code to it as we develop more shaders:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>We begin our <code class="literal">CgInclude</code> file with what is called a preprocessor directive. These are statements such as <code class="literal">#pragma</code> and <code class="literal">#include</code>. In this case, we want to define a new set of code that will be executed if our shader includes this file in its compiler directives. Enter the following code at the top of your <code class="literal">CgInclude</code> file:</li></ol></div><pre class="programlisting">#ifndef MY_CG_INCLUDE 
#define MY_CG_INCLUDE </pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>We always need to make sure that we close <code class="literal">#ifndef</code> or <code class="literal">#ifdef</code> with <code class="literal">#endif</code> to close the definition check, just like an <code class="literal">if</code> statement needs to be closed with two brackets in C#. Enter the following code just after the <code class="literal">#define</code> directive:</li></ol></div><pre class="programlisting">#endif </pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>At this point, we just need to <span>implement the contents</span> of the <code class="literal">CgInclude</code> file. So, we finish off our <code class="literal">CgInclude</code> file by entering the following code after the <code class="literal">#define</code> and before the <code class="literal">#endif</code>:</li></ol></div><pre class="programlisting"><span class="strong"><strong>fixed4 _MyColor; 
 
inline fixed4 LightingHalfLambert(SurfaceOutput s, fixed3 lightDir, fixed atten) 
{ 
    fixed diff = max(0, dot(s.Normal, lightDir)); 
    diff = (diff + 0.5)*0.5; 
 
    fixed4 c; 
    c.rgb = s.Albedo * _LightColor0.rgb * ((diff * _MyColor.rgb) * atten); 
    c.a = s.Alpha; 
    return c; 
}</strong></span> 
#endif </pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>With this completed, you now have your very first <code class="literal">CgInclude</code> file. With just this little bit of code, we can greatly reduce the amount of code that we have to rewrite, and we can begin to store the lighting models that we use all the time here so that we never lose them. Your <code class="literal">CgInclude</code> file should look similar to the following code:</li></ol></div><pre class="programlisting">#ifndef MY_CG_INCLUDE 
#define MY_CG_INCLUDE 
 
fixed4 _MyColor; 
 
inline fixed4 LightingHalfLambert(SurfaceOutput s, fixed3 lightDir, fixed atten) 
{ 
    fixed diff = max(0, dot(s.Normal, lightDir)); 
    diff = (diff + 0.5)*0.5; 
 
    fixed4 c; 
    c.rgb = s.Albedo * _LightColor0.rgb * ((diff * _MyColor.rgb) * atten); 
    c.a = s.Alpha; 
    return c; 
} 
#endif </pre><p>There are a couple more steps that we need to <span>complete</span><a id="id325453366" class="indexterm"></a> before we can fully utilize this <code class="literal">CgInclude</code> file. We simply need to tell the current shader that we are working with to use this file and its code. To complete the process of creating and using <code class="literal">CgInclude</code> files, let's complete the next set of steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>We have to have our <code class="literal">CgInclude</code> file in the same directory as our shader, so drag and drop it into the <code class="literal"><span>Chapter 11 </span></code>| <code class="literal">Shaders</code> folder from the <strong class="userinput"><code>Project</code></strong> tab.</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip76"></a>Note</h3><p>If <span class="emphasis"><em>step 1</em></span> is not completed, you will get a compilation error.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Now that we are in the folder, select the <code class="literal">Desaturate</code> shader created in the previous recipe and duplicate it (<span class="emphasis"><em>Ctrl </em></span>+ <span class="emphasis"><em>D</em></span>). Name the duplicate <code class="literal">Colorize</code>, and double-click on it to open it up.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>From there, update the shader name:</li></ol></div><pre class="programlisting">Shader "CookbookShaders/Chapter11/<span class="strong"><strong>Colorize</strong></span>" </pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>If you turn your attention to our shader, you will see that we need to tell our <code class="literal">CGPROGRAM</code> block to include our new <code class="literal">CgInclude</code> file, so that we can access the code it contains. Modify the directives of our <code class="literal">CGPROGRAM</code> block to include the following code:</li></ol></div><pre class="programlisting">CGPROGRAM
<span class="strong"><strong>#include "MyCGInclude.cginc"</strong></span>
// Physically based Standard lighting model, and enable shadows on all light types
#pragma surface surf Standard fullforwardshadows</pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Our current shader is currently using the built-in Standard lighting model, but we want to use the Half Lambert lighting model that we created in our <code class="literal">CgInclude</code>. As we have included the code from our <code class="literal">CgInclude</code> file, we can use the Half Lambert lighting model with the following code:</li></ol></div><pre class="programlisting">CGPROGRAM 
#include "MyCGInclude.cginc" 
<span class="strong"><strong>#pragma surface surf HalfLambert</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Finally, we have also declared a custom <span>variable</span><a id="id325454837" class="indexterm"></a> in our <code class="literal">CgInclude</code> file to show that we can set up default variables for our shaders to use. To see this in action, enter the following code in the <code class="literal">Properties</code> block of your shader:</li></ol></div><pre class="programlisting">Properties 
{ 
    _MainTex ("Base (RGB)", 2D) = "white" {} 
    _DesatValue ("Desaturate", Range(0,1)) = 0.5 
    <span class="strong"><strong>_MyColor ("My Color", Color) = (1,1,1,1)</strong></span> 
} </pre><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>Lastly, we need to update our <code class="literal">surf</code> function header since we use <code class="literal">SurfaceOutput</code> in our <code class="literal">LightingHalfLambert</code> function:</li></ol></div><pre class="programlisting">void surf (Input IN, inout<span class="strong"><strong> SurfaceOutput</strong></span> o) </pre><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>Back in Unity, create a new material that will use the newly created <code class="literal">Colorize</code> shader (<code class="literal">ColorizeMat</code>) and assign it to the sphere we created in the last recipe. Assign the material as normal and modify the <strong class="userinput"><code>MyColor</code></strong> value from the <strong class="userinput"><code>Inspector</code></strong> to see how it modifies the object. The following screenshot shows the result of using our <code class="literal">CgInclude</code> file:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/0c5ebcc3-0411-4cb9-ad7c-b7fb1b5b1579.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec171"></a>How it works...</h3></div></div></div><p>When using shaders, we can include other sets of code using the <code class="literal">#include</code> preprocessor directive. This tells Unity that we want to let the current shader use the code from within the included file in the shader; this is the reason why these files are called <code class="literal">CgInclude</code> files. We are including snippets of Cg code using the <code class="literal">#include</code> directive.</p><p>Once we have declared the <code class="literal">#include</code> directive and Unity is able to find the file in the project, Unity will then look for code snippets that have been defined. This is where we start to use the <code class="literal">#ifndef</code> and <code class="literal">#endif</code> directives. When we declare the <code class="literal">#ifndef</code> directive, we are simply saying "if not defined, define something with a name." In this recipe's case, we said we wanted to <code class="literal">#define MY_CG_INCLUDE</code>. So, if Unity doesn't find a definition called <code class="literal">MY_CG_INCLUDE</code>, it goes and creates it when the <code class="literal">CgInclude</code> file is compiled, thereby giving us access to the code that follows. The <code class="literal">#endif</code> method simply says <span>that</span><a id="id325453842" class="indexterm"></a> this is the end of this definition, so stop looking for more code.</p><p>You can now see how powerful this is we can now store all of our lighting models and custom variables in one file and greatly reduce the amount of code that we have to write. The real power is when you can begin to give your shaders flexibility by defining multiple states of functions in the <code class="literal">CgInclude</code> files.</p></div></div>