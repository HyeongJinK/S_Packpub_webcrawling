<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec34"></a>Creating a Phong Specular type</h2></div></div><hr /></div><p>The specularity of an object <span>surface</span><a id="id325453690" class="indexterm"></a> simply describes how shiny it is. These types of effects are often referred to as view-dependent effects in the shader world. This is because, in order to achieve a realistic Specular effect in your shaders, you need to include the direction of the camera or the user facing the object's surface. The most basic and performance-friendly Specular type is the Phong Specular effect. It is the calculation of the light direction reflecting off of the surface compared to the user's view direction. It is a very common Specular model used in many applications, from games to movies. While it isn't the most realistic in terms of accurately modeling the reflected Specular, <span>it gives a great approximation of what is expected of shininess</span> that performs well in most situations. Additionally, if your object is further away from the camera and there is no need for a very accurate Specular, this is a great way to provide a Specular effect to your shaders.</p><p>In this recipe, we will be covering how to implement the per-vertex version of the shader and also the per-pixel version using some new parameters in the Surface Shader's <code class="literal">Input</code> struct. We will see the difference and discuss when and why to use these two different implementations for different situations.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec73"></a>Getting ready</h3></div></div></div><p>To start with this recipe, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Create a new shader (<code class="literal">Phong</code>), material(<code class="literal">PhongMat</code>), and a new scene with a sphere in it with a <strong class="userinput"><code>Plane</code></strong> underneath it (<strong class="userinput"><code>GameObject</code></strong> | <strong class="userinput"><code>3D Objects </code></strong>| <strong class="userinput"><code>Plane</code></strong>).</li><li>Attach the shader to the material and the material to the object. To finish off your new scene, create a new directional light if one is not there already, so <span>that</span><a id="id325453784" class="indexterm"></a> you can see your Specular effect as you code it:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/e2d37856-3414-4d96-8e31-ca2eedd5876c.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec74"></a>How to do it...</h3></div></div></div><p>Follow these steps to create a Phong lighting model:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>You might be seeing a pattern at this point, but we always like to start out with our most basic part of the shader writing process: the creation of properties. So, let's remove all of the current properties with their definitions in the <code class="literal">SubShader</code> block and then add the <span>following</span><a id="id325453818" class="indexterm"></a> properties to the shader:</li></ol></div><pre class="programlisting">Properties 
{ 
  _MainTint ("Diffuse Tint", Color) = (1,1,1,1) 
  _MainTex ("Base (RGB)", 2D) = "white" {} 
  _SpecularColor ("Specular Color", Color) = (1,1,1,1) 
  _SpecPower ("Specular Power", Range(0,30)) = 1 
} </pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>We then have to make sure to add the corresponding variables to our <code class="literal">CGPROGRAM</code> block in our <code class="literal">SubShader{}</code> block:</li></ol></div><pre class="programlisting">float4 _SpecularColor; 
sampler2D _MainTex; 
float4 _MainTint; 
float _SpecPower; </pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Now, we have to add our custom lighting model so that we can compute our own Phong Specular. Don't worry if it doesn't make sense at this point; we will cover each line of code in <span>the <span class="emphasis"><em>How it works...</em></span> section of this recipe</span>. Add the following code to the shader's <code class="literal">SubShader{}</code> function:</li></ol></div><pre class="programlisting">fixed4 LightingPhong (SurfaceOutput s, fixed3 lightDir, 
                      half3 viewDir, fixed atten) 
{ 
  // Reflection 
  float NdotL = dot(s.Normal, lightDir); 
  float3 reflectionVector = normalize(2.0 * s.Normal * 
     NdotL - lightDir); 
 
  // Specular 
  float spec = pow(max(0, dot(reflectionVector, viewDir)), 
     _SpecPower); 
  float3 finalSpec = _SpecularColor.rgb * spec; 
 
  // Final effect 
  fixed4 c; 
  c.rgb = (s.Albedo * _LightColor0.rgb * max(0,NdotL) * 
     atten) + (_LightColor0.rgb * finalSpec); 
  c.a = s.Alpha; 
  return c; 
} </pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Next, we have to tell the <code class="literal">CGPROGRAM</code> block that it <span>needs</span><a id="id325460919" class="indexterm"></a> to use our custom Lighting function instead of one of the built-in ones. We do this by changing the <code class="literal">#pragma</code> statement to the following:</li></ol></div><pre class="programlisting">CGPROGRAM 
#pragma surface surf Phong </pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Finally, let's update the <code class="literal">surf</code> function to the following:</li></ol></div><pre class="programlisting">void surf (Input IN, inout SurfaceOutput o) 
{
 half4 c = tex2D (_MainTex, IN.uv_MainTex) * _MainTint;
 o.Albedo = c.rgb;
 o.Alpha = c.a;
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>The following screenshot demonstrates the result of our custom Phong lighting model using our own custom reflection vector:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/6c60f1d5-8129-4892-800f-54aab093d4b5.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip50"></a>Note</h3><p>Try changing the <strong class="userinput"><code>Specular Power</code></strong> property and notice the effect that you see.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec75"></a>How it works...</h3></div></div></div><p>Let's break down the Lighting function by itself, as the <span>rest</span><a id="id325464993" class="indexterm"></a> of the shader should be pretty familiar to you at this point.</p><p>In the previous recipes, we have used a Lighting function that provided only the light direction, <code class="literal">lightDir</code>.</p><p>Unity comes with a set of Lighting functions that you can use, including one that provides the view direction, <code class="literal">viewDir</code>.</p><p>To figure out how to write <span>your</span><a id="id325453522" class="indexterm"></a> own custom lighting mode refer to the following table replacing NameYouChoose with the lighting function name you gave in the <code class="literal">#pragma</code> statement or go to <span><a class="ulink" href="http://docs.unity3d.com/Documentation/Components/SL-SurfaceShaderLighting.html" target="_blank">http://docs.unity3d.com/Documentation/Components/SL-SurfaceShaderLighting.html</a></span> for more details:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col /><col /></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Not view-dependent</strong></span></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal"><span><code class="literal">half4 LightingNameYouChoose</code> (<code class="literal">SurfaceOutput s</code>, <code class="literal">half3</code><code class="literal">lightDir</code>, <code class="literal">half atten</code></span></code>);</p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p><span class="strong"><strong>View-dependent</strong></span></p></td><td style=""><p><code class="literal">half4 LightingNameYouChoose (SurfaceOutput s, half3 lightDir, half3 viewDir, half atten);</code></p></td></tr></tbody></table></div><p> </p><p>In our case, we are using a Specular shader, so we need to have the view-dependent <code class="literal">Lighting</code> function structure. We have to write the following:</p><pre class="programlisting">CPROGRAM 
#pragma surface surf Phong 
fixed4 LightingPhong (SurfaceOutput s, fixed3 lightDir, half3 viewDir, fixed atten) 
{ 
  // ... 
} </pre><p>This will tell the shader that we want to create our own view-dependent shader. Always make sure that your Lighting function name is the same in your <code class="literal">Lighting</code> function declaration and the <code class="literal">#pragma</code> statement, or Unity will not be able to find your lighting model.</p><p>The components that play a role in the <code class="literal">Phong</code> model are described in the following image. We have the light direction <span class="strong"><strong>L</strong></span> (coupled with its perfect reflection <span class="strong"><strong>R</strong></span>) and normal direction <span class="strong"><strong>N</strong></span>. They have all been <span>encountered</span><a id="id325209544" class="indexterm"></a> before in the Lambertian model, with the exception of <span class="strong"><strong>V</strong></span>, which is the <span class="strong"><strong>view direction</strong></span>:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/e47f1b2a-6123-47e3-b0e6-7411a6530e22.png" /></div><p>The <code class="literal">Phong</code> model assumes that the final light intensity of a reflective surface is given by two components, its diffuse color, and Specular value, as follows:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/adbe840b-59a8-4ee0-a200-efaa563eb371.png" /></div><p>The diffuse component <span class="emphasis"><em>D</em></span> remains unchanged from the Lambertian model:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/740481f8-3bdf-473d-9c5a-fe9521d40c6d.png" /></div><p>The Specular component <span class="emphasis"><em>S</em></span> is defined as follows:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/ae05b506-7ff8-4b7d-b0a4-c604702bcdc5.png" /></div><p>Here, <span class="emphasis"><em>p</em></span> is the Specular power defined as <code class="literal">_SpecPower</code> in the shader. The only unknown parameter is <span class="emphasis"><em>R</em></span>, which is the reflection of <span class="emphasis"><em>L</em></span> according to <span class="emphasis"><em>N</em></span>. In <span>vector</span><a id="id325209633" class="indexterm"></a> algebra, this can be calculated as follows:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/6665cd4e-aecc-4333-91c5-c47072130e9e.png" /></div><p>This is exactly what is calculated in the following:</p><pre class="programlisting">float3 reflectionVector = normalize(2.0 * s.Normal * NdotL - 
                                    lightDir);</pre><p>This has the effect of bending the normal towards the light; as a vertex, normal is pointing away from the light, it is forced to look at the light. Refer to the following diagram for a more visual representation. The script that produces this debug effect is included in this book's support page at <span><a class="ulink" href="https://www.packtpub.com/books/content/support" target="_blank">https://www.packtpub.com/books/content/support</a></span>:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/49613513-1de4-4f8d-b350-b22610c69862.png" /></div><p>The following diagram <span>displays</span><a id="id325209678" class="indexterm"></a> the final result of our Phong Specular calculation isolated in the shader:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/1ba5c5f2-a7f5-465b-ad27-af0f0935fa25.png" /></div></div></div>