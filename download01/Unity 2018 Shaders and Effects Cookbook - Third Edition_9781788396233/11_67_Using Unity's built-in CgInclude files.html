<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch11lvl1sec66"></a>Using Unity's built-in CgInclude files</h2></div></div><hr /></div><p>Our first step in writing our own <code class="literal">CgInclude</code> files is to understand what Unity is already providing with us for shaders. When writing Surface Shaders, there is a lot <span>happening</span><a id="id325457684" class="indexterm"></a> under the hood, which makes the process of writing Surface Shaders so efficient. We can see this code in the included <code class="literal">CgInclude</code> files found in the directory that you installed Unity in at <code class="literal"><span>Editor </span></code><span>|</span> <code class="literal">Data </code>| <code class="literal"><span>CGIncludes</span></code>. All the files contained within this folder do their part to render our objects with our shaders on the screen. Some of these files take care of shadows and lighting, some take care of helper functions, and some manage platform dependencies. Without them, our shader-writing experience would be much more laborious.</p><p>You can find a list of the <span>information</span><a id="id325460894" class="indexterm"></a> that Unity has provided us with at the following link:<span><a class="ulink" href="http://docs.unity3d.com/Documentation/Components/SL-BuiltinIncludes.html" target="_blank">http://docs.unity3d.com/Documentation/Components/SL-BuiltinIncludes.html</a>.</span></p><p>Let's begin the process of understanding these built-in <code class="literal">CgInclude</code> files, using some of the built-in helper functions from the <code class="literal">UnityCG.cginc</code> file:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/f3f2144c-8d3b-4193-bee0-2d3726f16b24.png" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec165"></a>Getting ready</h3></div></div></div><p>Before we start diving into the meat of writing the shader, we need to get a few items set up in our scene. Let's do the following and then open the shader in your IDE of choice:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Create a new scene and fill it with a <span>simple</span><a id="id325463138" class="indexterm"></a> sphere model.</li><li>Create a new shader (<code class="literal">Desaturate</code>) and material (<code class="literal">DesaturateMat</code>).</li><li>Attach the new shader to the new material and assign the material to the sphere.</li><li>Create a directional light and position it above your sphere.</li><li>Finally, open the <code class="literal">UnityCG.cginc</code> file from Unity's <code class="literal">CgInclude</code> folder located in Unity's install directory. This will let us analyze some of the helper functions' code so that we can understand what is happening when we use them.</li><li>You should now have a simple scene set up to work on the shader. Refer to the following screenshot, which is an example:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/68b26fbe-d956-4a5a-884d-a9155440cdd3.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec166"></a>How to do it...</h3></div></div></div><p>With the scene prepared, we can now begin the process of experimenting with some of the built-in helper functions included with the <code class="literal">UnityCG.cginc</code> file. Double-click on the <span>shader</span><a id="id325464998" class="indexterm"></a> that was created for this scene in order to open it in your IDE of choice and insert the code given in the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Add the following code to the <code class="literal">Properties</code> block of the new shader file. We will need a single texture and slide for our example shader:</li></ol></div><pre class="programlisting">Properties 
{ 
    _MainTex ("Base (RGB)", 2D) = "white" {} 
    _DesatValue ("Desaturate", Range(0,1)) = 0.5 
} </pre><p><span>We</span> then need to make sure that we create the data connection between our <code class="literal">Properties</code> and <code class="literal">CGPROGRAM</code> blocks.</p><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Use the following code, placed after the <code class="literal">CGPROGRAM</code> declaration and <code class="literal">#pragma</code> directives, <span>removing the other default properties</span>:</li></ol></div><pre class="programlisting">sampler2D _MainTex; 
<span class="strong"><strong>fixed _DesatValue;</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Next, we just have to update our <code class="literal">surf()</code> function to include the following code. We introduce a new function that we haven't seen yet, which is built into Unity's <code class="literal">UnityCG.cginc</code> file:</li></ol></div><pre class="programlisting">void surf (Input IN, inout SurfaceOutputStandard o) 
{ 
  half4 c = tex2D (_MainTex, IN.uv_MainTex); 
  c.rgb = lerp(c.rgb, Luminance(c.rgb), _DesatValue); 

  o.Albedo = c.rgb; 
  o.Alpha = c.a; 
} </pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Save your script and return to the Unity editor. From there, you should be able to assign a material to the <code class="literal">DesaturateMat</code> (I used the <code class="literal">TerrainBlend</code> texture from the <code class="literal"><span>Chapter 3</span> </code>| <code class="literal">Textures</code> folder):</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/63cca709-18a4-4399-af63-d21b1735b8e3.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>With the shader code modified, you should see something similar to the preceding screenshot. We have simply used a helper function, built into Unity's <code class="literal">CgInclude</code> file, to give us an effect of desaturating the main texture of our shader. Notice that if we change the value to <code class="literal">1</code>, all of the color leaves, giving us a grayscale effect:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/0d9095e7-4d88-48f4-b320-ba36f3af2d0a.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec167"></a>How it works...</h3></div></div></div><p>Using the built-in helper function named <code class="literal">Luminance()</code>, we are able to quickly get a desaturation or grayscale effect on our shaders. This is all possible because of the <code class="literal">UnityCG.cginc</code> file is brought automatically to our shader as we are using a Surface Shader.</p><p>If you search through the <code class="literal">UnityCG.cginc</code> file when opened in a script editor, you will find the implementation of this function at line <span class="emphasis"><em>473</em></span>. The following snippet is taken from the file:</p><pre class="programlisting">// Converts color to luminance (grayscale)
inline half Luminance(half3 rgb)
{
    return dot(rgb, unity_ColorSpaceLuminance.rgb);
}</pre><p>As this function is included in the file and Unity automatically compiles with this file, we can use the function in our code as well, thereby reducing the amount of code that we have to write over and over again.</p><p>Notice there is also a <code class="literal">Lighting.cginc</code> file, which Unity comes with. This file houses all the lighting models that we use when we declare something like <code class="literal">#pragma Surface surf Lambert</code>. Sifting through this file reveals that all the built-in lighting models are defined here for reuse and modularity.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec168"></a>There's more...</h3></div></div></div><p>You'll notice that the <code class="literal">Luminance</code> function we are <span>using</span><a id="id325209646" class="indexterm"></a> will return the dot product between the color passed in and a property called <code class="literal">unity_ColorSpaceLuminance</code>. To see what that is, you can use<strong class="userinput"><code> <span>Find</span></code></strong> menu in your text editor (<span><span class="emphasis"><em>Ctrl </em></span>+ <span class="emphasis"><em>F</em></span></span>) and type it in. After searching for it, you should be able to see the following on line <span class="emphasis"><em>28</em></span>:</p><pre class="programlisting">#ifdef UNITY_COLORSPACE_GAMMA
#define unity_ColorSpaceGrey fixed4(0.5, 0.5, 0.5, 0.5)
#define unity_ColorSpaceDouble fixed4(2.0, 2.0, 2.0, 2.0)
#define unity_ColorSpaceDielectricSpec half4(0.220916301, 0.220916301, 0.220916301, 1.0 - 0.220916301)
<span class="strong"><strong>#define unity_ColorSpaceLuminance half4(0.22, 0.707, 0.071, 0.0) // Legacy: alpha is set to 0.0 to specify gamma mode</strong></span>
#else // Linear values
#define unity_ColorSpaceGrey fixed4(0.214041144, 0.214041144, 0.214041144, 0.5)
#define unity_ColorSpaceDouble fixed4(4.59479380, 4.59479380, 4.59479380, 2.0)
#define unity_ColorSpaceDielectricSpec half4(0.04, 0.04, 0.04, 1.0 - 0.04) // standard dielectric reflectivity coef at incident angle (= 4%)
<span class="strong"><strong>#define unity_ColorSpaceLuminance half4(0.0396819152, 0.458021790, 0.00609653955, 1.0) // Legacy: alpha is set to 1.0 to specify linear mode</strong></span>
#endif</pre><p>This means that, depending on the color space being used, the values given will change. By default, Unity uses a Gamma color space as only certain platforms support linear. To check what color space you are using in your project, you can go to <strong class="userinput"><code>Edit | Project Settings| Player | Other Settings</code></strong> and <span>look</span><a id="id325453479" class="indexterm"></a> at the <strong class="userinput"><code>Color Space</code></strong> property.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note75"></a>Note</h3><p>For more information on color spaces check out: <a class="ulink" href="http://www.kinematicsoup.com/news/2016/6/15/gamma-and-linear-space-what-they-are-how-they-differ" target="_blank">http://www.kinematicsoup.com/news/2016/6/15/gamma-and-linear-space-what-they-are-how-they-differ</a>.</p></div></div></div>