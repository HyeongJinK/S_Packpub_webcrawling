<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec33"></a>Creating a toon shader</h2></div></div><hr /></div><p>One of the most used effects in <span>games</span><a id="id325209371" class="indexterm"></a> is <span class="strong"><strong>toon shading</strong></span>, which is also known as <span class="strong"><strong>celluloid</strong></span> (<span class="strong"><strong>CEL</strong></span>) shading. It is a non-photorealistic rendering technique that makes 3D models appear flat. Many <span>games</span><a id="id325209390" class="indexterm"></a> use it to give the illusion that the graphics are being hand-drawn rather than being 3D modeled. You can see, in the <span>following</span><a id="id325209398" class="indexterm"></a> diagram, a sphere rendered with a toon Shader (left) and a Standard Shader (right):</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/1f791073-b993-4037-b83a-6935eceafce8.png" /></div><p>Achieving this effect using just surface functions is not impossible, but it would be extremely expensive and time consuming. The surface function, in fact, only works on the properties of the material, not its actual lighting condition. As toon shading requires us to change the way light reflects, we need to create our custom lighting model instead.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec69"></a>Getting ready</h3></div></div></div><p>Let's start this recipe by creating a shader and its <span>material</span><a id="id325209434" class="indexterm"></a> and importing a special texture, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Start by creating a new shader; in this example, we will duplicate the one made in the previous recipe by selecting it in the <strong class="userinput"><code>Project</code></strong> tab and then hit <span class="emphasis"><em>Ctrl </em></span>+ <span class="emphasis"><em>D</em></span>. We will change the name of this new <code class="literal">shader</code> to <code class="literal">ToonShader</code>.</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip47"></a>Note</h3><p>You can rename an object in the <strong class="userinput"><code>Project</code></strong> window by single-clicking on the name.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Create a new material for the shader (<code class="literal">ToonShaderMat</code>) and attach it to a 3D model. Toon shading works best on curved surfaces.</li><li>This recipe requires an additional <span>texture</span><a id="id325209490" class="indexterm"></a> called a <span class="strong"><strong>ramp map</strong></span>,<span class="strong"><strong> </strong></span>which will be used to dictate when we want to use certain colors depending on the shade received:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/4f3521d4-4248-43f3-96dd-70d530552278.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>This book has an example texture in <code class="literal">Chapter 4</code> <span>| </span><code class="literal">Textures</code> folder. If you decide to import your own, it is important that you select your next texture and, from the <strong class="userinput"><code>Inspector</code></strong> tab, change the ramp map's <strong class="userinput"><code>Wrap Mode</code></strong> to <strong class="userinput"><code>Clamp</code></strong>. If you want the edges between the colors to be sharp, the <strong class="userinput"><code>Filter Mode</code></strong> should also be set to <strong class="userinput"><code>Point</code></strong>:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/96e97a49-b61b-4bc1-9152-4ab4446980ad.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note48"></a>Note</h3><p>The example project included with this book already has this step completed in the <code class="literal">Assets </code>| <code class="literal">Chapter 4 </code>| <code class="literal">Texture </code>| <code class="literal">ToonRamp</code> file, but it is a good idea to verify that this is the case before moving forward.  </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec70"></a>How to do it...</h3></div></div></div><p>The toon aesthetic can be achieved with the following changes to the shader:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Add a new property for a <span>texture</span><a id="id325445078" class="indexterm"></a> called <code class="literal">_RampTex</code>:</li></ol></div><pre class="programlisting">_RampTex ("Ramp", 2D) = "white" {} </pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Add its relative variable in the <code class="literal">CGPROGRAM</code> section:</li></ol></div><pre class="programlisting">sampler2D _RampTex; </pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Change the <code class="literal">#pragma</code> directive so that it points to a function called <code class="literal">LightingToon()</code>:</li></ol></div><pre class="programlisting">#pragma surface surf Toon </pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Replace the <code class="literal">LightingSimpleLambert</code> function with the following function instead:</li></ol></div><pre class="programlisting">fixed4 LightingToon (SurfaceOutput s, fixed3 lightDir, 
            fixed atten) 
{ 
  // First calculate the dot product of the light direction and the 
  // surface's normal
  half NdotL = dot(s.Normal, lightDir); 

  // Remap NdotL to the value on the ramp map
  NdotL = tex2D(_RampTex, fixed2(NdotL, 0.5)); 

  // Next, set what color should be returned
  half4 color; 

  color.rgb = s.Albedo * _LightColor0.rgb * (NdotL * atten ); 
  color.a = s.Alpha; 

  // Return the calculated color
  return color; 
} </pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Save the script, open up the <code class="literal">ToonShaderMat</code>, and assign the <code class="literal">Ramp</code> property to your ramp map. If all goes well, you should see <span>something</span><a id="id325451212" class="indexterm"></a> like the following in your scene:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/6e303b21-e31f-45b4-bc58-852180bec567.png" /></div><p></p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip49"></a>Note</h3><p>This effect may be modified by the lighting in the scene. You can change the illumination of the scene by going to <strong class="userinput"><code>Window </code></strong>| <strong class="userinput"><code>Lighting </code></strong>| <strong class="userinput"><code>Settings</code></strong> and changing the <strong class="userinput"><code>Environment </code></strong>| <strong class="userinput"><code>Environment Lighting </code></strong>| <strong class="userinput"><code>Intensity Multiplier</code></strong> property to <code class="literal">0</code>.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec71"></a>How it works...</h3></div></div></div><p>The main characteristic of toon <span>shading</span><a id="id325453400" class="indexterm"></a> is the way the light is rendered; surfaces are not shaded uniformly. To achieve this effect, we need a ramp map. Its purpose is to remap the Lambertian light intensity <code class="literal">NdotL</code> to another value. Using a ramp map without a gradient, we can force the lighting to be rendered in steps. The following diagram shows how the ramp map is used to correct the light intensity:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/3d410099-eb71-4ef3-99f7-bc18dc4923a2.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec72"></a>There's more...</h3></div></div></div><p>There are many different ways whereby you can achieve a toon <span>shading</span><a id="id325453744" class="indexterm"></a> effect. Using different ramps can produce dramatic changes in the way your models look, so you should experiment in order to find the best one.</p><p>An alternative to ramp textures is to <span class="strong"><strong>snap</strong></span> the light intensity <code class="literal">NdotL</code> so that it can only assume a certain number of values equidistantly sampled from <code class="literal">0</code> to <code class="literal">1</code>:</p><pre class="programlisting">half4 LightingCustomLambert (SurfaceOutput s, half3 lightDir, 
                half3 viewDir, half atten) 
{ 
  half NdotL = dot (s.Normal, lightDir); 

  // Snap instead
  half cel = floor(NdotL * _CelShadingLevels) / 
             (_CelShadingLevels - 0.5); 

  // Next, set what color should be returned
  half4 color; 

  color.rgb = s.Albedo * _LightColor0.rgb * (cel * atten ); 
  color.a = s.Alpha; 

  // Return the calculated color
  return color; 
} </pre><p><span>To snap a number we first multiply</span> <code class="literal">NdotL</code> by the <code class="literal">_CelShadingLevels</code> variable,  round the result to an integer through the <code class="literal">floor</code> function, and then divides it back. This rounding is done by the <code class="literal">floor</code> function which will effectively remove the decimal point from a number. By doing this, the <code class="literal">cel</code> quantity is forced to assume one of the <code class="literal">_CelShadingLevels</code> equidistant values from <code class="literal">0</code> to <code class="literal">1</code>. This removes the need for a ramp texture and makes all the color steps of the same size. If you are going for this implementation, remember to add a property called <code class="literal">_CelShadingLevels</code> to your shader. You can find an example of this in the example code for this chapter. Try dragging the <strong class="userinput"><code>Levels</code></strong> property to see how it <span>affects</span><a id="id325454829" class="indexterm"></a> how the screenshot is shown:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/02ab9e1d-0cdf-4e4e-8df0-9f4d2249b721.png" /></div></div></div>