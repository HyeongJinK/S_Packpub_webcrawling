<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec55"></a>Profiling your shaders</h2></div></div><hr /></div><p>Now that we know how we can reduce the <span>overhead</span><a id="id325209371" class="indexterm"></a> that our shaders might take, let's take a look at how to find problematic shaders in a scene where you might have a lot of shaders or a ton of objects, shaders, and scripts, all running at the same time. To find a single object or shader among a whole game can be quite daunting, but Unity provides us with its built-in <strong class="userinput"><code>Profiler</code></strong>. This allows us to actually see, on a frame-by-frame basis, what is happening in the game, and each item that is being used by the GPU and CPU.</p><p>Using the <strong class="userinput"><code>Profiler</code></strong>, we can isolate <span>items</span><a id="id325209400" class="indexterm"></a> such as shaders, geometry, and general rendering items using its interface to create blocks of profiling jobs. We can filter out items until we are looking at the performance of just a single object. This then lets us see the effects on the CPU and GPU that the object has while it is performing its functions at runtime.</p><p>Let's take a look through the different sections of the <strong class="userinput"><code>Profiler</code></strong> and learn how to debug our scenes and, most importantly, our shaders.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec137"></a>Getting ready</h3></div></div></div><p>Let's use our <strong class="userinput"><code>Profiler</code></strong> by getting a few assets ready and launching the <strong class="userinput"><code>Profiler</code></strong> window:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Let's use the scene from the last recipe and launch the Unity <strong class="userinput"><code>Profiler</code></strong> from <strong class="userinput"><code>Window </code></strong>| <strong class="userinput"><code>Profiler</code></strong> or <span class="emphasis"><em><span class="strong"><strong>Ctrl</strong></span></em></span> + <span class="emphasis"><em><span class="strong"><strong>7</strong></span></em></span>. Feel free to drag and drop or move it so you can see it well. I personally put it at the same spot as the <strong class="userinput"><code>Inspector</code></strong> tab.</li><li>Let's also duplicate our sphere a couple more times to see how that affects our rendering.</li><li>From the <strong class="userinput"><code>Profiler</code></strong> tab, click on the <strong class="userinput"><code>Deep Profile</code></strong> option to get additional information about the project and then play your game!</li></ol></div><p>You should see something <span>similar</span><a id="id325442711" class="indexterm"></a> to the following image:</p><div class="mediaobject"><img src="/graphics/9781788396233/graphics/9b1d7ec6-4316-4efb-8701-6fa3f0b73b2f.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec138"></a>How to do it...</h3></div></div></div><p>To use the <strong class="userinput"><code>Profiler</code></strong>, we will take a look at some of the UI elements of this window. Before we hit Play, let's take a look at how to get the information we need from the <strong class="userinput"><code>Profiler</code></strong>:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>First, click on the larger blocks in the <strong class="userinput"><code>Profiler</code></strong> window called <strong class="userinput"><code>GPU Usage</code></strong>, <strong class="userinput"><code>CPU Usage</code></strong>, and <strong class="userinput"><code>Rendering</code></strong>. You will find these blocks on the left-hand <span>side</span><a id="id325445083" class="indexterm"></a> of the upper window:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/7f56eed4-fcba-44e8-9393-d0cd9d70add5.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Using these blocks, we can see different data specific to those major functions of our game. The <strong class="userinput"><code>CPU Usage</code></strong> is showing us what most of our scripts are doing, as well as physics and overall rendering. The <strong class="userinput"><code>GPU Usage</code></strong> block is giving us detailed information about the elements that are specific to our lighting, shadows, and render queues. Finally, the <strong class="userinput"><code>Rendering</code></strong> block is giving us information about the drawcalls and amount of geometry we have in our scene at any one frame.</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip69"></a>Note</h3><p>If you do not see the GPU Usage option, click on <strong class="userinput"><code>Add Profiler</code></strong> | <strong class="userinput"><code>GPU</code></strong>. It is possible that it may not show up if your graphics card drivers are not up to date.</p></div><p>By clicking on each of these blocks, we can isolate the type of data we see during our profiling session.</p><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Now, click on the tiny colored blocks in one of these <strong class="userinput"><code>Profile</code></strong> blocks and hit Play, or <span class="emphasis"><em><span class="strong"><strong>Ctrl</strong></span></em></span> + <span class="emphasis"><em><span class="strong"><strong>P</strong></span></em></span>, to run the scene.</li><li>This lets us dive down even deeper into our profiling session so that we can filter out what is being reported back to us. While the scene is running, uncheck all of the boxes, except for <strong class="userinput"><code>Opaque</code></strong>in the<strong class="userinput"><code>GPU Usage</code></strong>block. Notice that we can now see just how much time is <span>being</span><a id="id325451213" class="indexterm"></a> used to render the objects that are set to the <strong class="userinput"><code>Render Queue</code></strong> of <strong class="userinput"><code>Opaque</code></strong>:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/f1788f05-9ae9-4b35-995a-56b18119413c.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Another great function of the <strong class="userinput"><code>Profiler</code></strong> window is the action of clicking and dragging in the graph view.</li><li>This will automatically pause your game so that you can further analyze a certain spike in the graph to find out exactly which item is causing the performance problem. Click and drag around in the graph view to pause the game and see the effect of using this functionality:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/d746ba3a-0d51-44da-a232-f97cf76a0daf.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>Turning our attention now towards the lower half of the <strong class="userinput"><code>Profiler</code></strong> window, you will notice that there is a <span>dropdown</span> item available when we have the <strong class="userinput"><code>GPU Block</code></strong> selected. We can expand this to get even more detailed information about the current active profiling <span>session</span><a id="id325453410" class="indexterm"></a> and, in this case, more information about what the camera is currently rendering and how much time it is taking up:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/0b0b40ed-3467-4d45-af09-ff204fc0d96d.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip70"></a>Note</h3><p>If you click on the button that says <strong class="userinput"><code>No Details</code></strong> and changes the option to <strong class="userinput"><code>Show Related Objects</code></strong>, you can see what objects are being used in the functions being called.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>This gives us a complete look at the inner workings of what Unity is processing in this particular frame. In this case, we can see that our three spheres with our optimized shader are taking roughly <strong class="userinput"><code>0.066</code></strong> milliseconds to draw to the screen, they are taking up fifteen drawcalls, and this process is taking <strong class="userinput"><code>8.4%</code></strong> of the GPU's time in every frame (the numbers will likely be different depending on what hardware you have for your computer). It's this type of information we can use to diagnose and solve performance issues with regard to shaders. Let's conduct a test to see the effects of adding one more texture to our shader and blending two diffuse textures together using a <code class="literal">lerp</code>function. You will see the effects in the <strong class="userinput"><code>Profiler</code></strong> pretty clearly.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Modify the <code class="literal">Properties</code> block of your <span>shader</span><a id="id325454771" class="indexterm"></a> with the following code to give us another texture to use:</li></ol></div><pre class="programlisting">Properties 
{
  _MainTex ("Base (RGB)", 2D) = "white" {}
  _BlendTex("Blend Texture", 2D) = "white" {}
  _NormalMap ("Normal Map", 2D) = "bump" {}
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>Then let's feed our texture to <code class="literal">CGPROGRAM</code>:</li></ol></div><pre class="programlisting">sampler2D _MainTex;
sampler2D _NormalMap;
<span class="strong"><strong>sampler2D _BlendTex;</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="11" type="1"><li>Now it's time to update our <code class="literal">surf()</code> function accordingly so that we blend our diffuse textures together:</li></ol></div><pre class="programlisting">void surf (Input IN, inout SurfaceOutput o) 
{
  fixed4 c = tex2D (_MainTex, IN.uv_MainTex);
  fixed4 blendTex = tex2D(_BlendTex, IN.uv_MainTex);

  c = lerp(c, blendTex, blendTex.r);

  o.Albedo = c.rgb;
  o.Alpha = c.a;
  o.Normal = UnpackNormal(tex2D(_NormalMap, IN.uv_MainTex));
}</pre><p>Once you save your modifications in your shader and return to Unity's editor, we can run our game and see the <span>increase in milliseconds</span> of our new shader.</p><div class="orderedlist"><ol class="orderedlist arabic" start="12" type="1"><li>Attach a new texture <span>inside</span><a id="id325454861" class="indexterm"></a> of your <code class="literal">Blend Texture</code>:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/58f2bc33-651e-474e-ad9d-f70d8a1199ff.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="13" type="1"><li>Press Play to start the game again with the <strong class="userinput"><code>Profiler</code></strong> turned on. Press Play once you have returned to Unity and let's take a look at the results in our <strong class="userinput"><code>Profiler</code></strong>:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788396233/graphics/a2295c30-d580-4724-89cd-b0b16e83c5cc.png" /></div><p>You can see now that the amount of time to render our <strong class="userinput"><code>Opaque</code></strong> Shaders in this scene is taking <strong class="userinput"><code>0.069</code></strong> milliseconds, up from <strong class="userinput"><code>0.066</code></strong> milliseconds. By adding another texture and using the <code class="literal">lerp()</code> function, we increased the render time for our spheres. While it's a small change, imagine having 20 shaders all working in different ways on different objects.</p><p>Using the information given here, you can <span>pinpoint</span><a id="id325460898" class="indexterm"></a> areas that are causing performance decreases more quickly and solve these issues using the techniques from the previous recipe.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec139"></a>How it works...</h3></div></div></div><p>While it's completely out of the scope of this book to describe how this tool actually works internally, we can surmise that Unity has given us a way to view the computer's performance while our game is running. Basically, this window is tied very tightly to the CPU and GPU to give us real-time feedback of how much time is being taken for each of our scripts, objects, and render queues. Using this information, we have seen that we can track the efficiency of our shader writing to eliminate problem areas and code.</p><p>It's important to note that games running with the <strong class="userinput"><code>Profiler</code></strong> open, as well as from within the editor in general, will make the game slightly slower than it would be when compiled and running in a normal situation. You might even see the <strong class="userinput"><code>Editor</code></strong> in the <strong class="userinput"><code>Profilers</code></strong> list of CPU expenses.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec140"></a>There's more...</h3></div></div></div><p>It is also possible to profile specifically for mobile platforms. Unity provides us with a couple of extra features when the Android or iOS build target is set in the <strong class="userinput"><code>Build Settings</code></strong>. We can actually get real-time information from our mobile devices while the game is running. This becomes very useful because you are able to profile directly on the device itself instead of <span>profiling</span><a id="id325463133" class="indexterm"></a> directly in your editor. To find out more about this process, refer to Unity's documentation at the following link:<span><a class="ulink" href="http://docs.unity3d.com/Documentation/Manual/MobileProfiling.html" target="_blank">http://docs.unity3d.com/Documentation/Manual/MobileProfiling.html</a>.<a class="ulink" href="http://docs.unity3d.com/Documentation/Manual/MobileProfiling.html" target="_blank">http://docs.unity3d.com/Documentation/Manual/MobileProfiling.html</a></span></p></div></div>