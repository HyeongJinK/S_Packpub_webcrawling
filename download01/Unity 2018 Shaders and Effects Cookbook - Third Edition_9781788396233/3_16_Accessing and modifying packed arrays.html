<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec23"></a>Accessing and modifying packed arrays</h2></div></div><hr /></div><p>Loosely speaking, the code inside a <span>shader</span><a id="id325209370" class="indexterm"></a> has to be <span>executed</span><a id="id325209379" class="indexterm"></a> for at least every pixel in your screen. This is the reason why GPUs are highly optimized for parallel computing; they can execute multiple processes at the same time. This philosophy is also evident in the standard type of variables and operators available in Cg. Understanding them is essential, not just so that you can use the shaders correctly, but also to write highly optimized ones.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec37"></a>How to do it...</h3></div></div></div><p>There are two types of variables in Cg: single values and packed arrays. The latter can be identified because their type ends with a number such as <code class="literal">float3</code> or <code class="literal">int4</code>. As their <span>names</span><a id="id325209400" class="indexterm"></a> suggest, these <span>types</span><a id="id325209409" class="indexterm"></a> of variables are similar to structs, which means that they each contain several single values. Cg calls them packed arrays, though they are not exactly <span class="emphasis"><em>arrays</em></span> in the traditional sense.</p><p>The elements of a packed array can be accessed as a normal struct. They are typically called <code class="literal">x</code>, <code class="literal">y</code>, <code class="literal">z</code>, and <code class="literal">w</code>. However, Cg also provides you with another alias for them, that is, <code class="literal">r</code>, <code class="literal">g</code>, <code class="literal">b</code>, and <code class="literal">a</code>. Despite there being no difference between using <code class="literal">x</code> or <code class="literal">r</code>, it can make a huge difference for the readers. Shader coding, in fact, often involves calculation with positions and colors. You might have seen this in the Standard Shaders:</p><pre class="programlisting">o.Alpha = _Color.a; </pre><p>Here, <code class="literal">o</code> was a struct and <code class="literal">_Color</code> was a packed array. This is also why Cg prohibits the mixed usage of these two syntaxes: you cannot use <code class="literal">_Color.xgz</code>.</p><p>There is also another important feature of packed arrays that has no <span>equivalent</span><a id="id325442711" class="indexterm"></a> in C#: <span class="strong"><strong>swizzling</strong></span>. Cg allows addressing and reordering elements within packed arrays in just a single line. Once again, this appears in the Standard Shader:</p><pre class="programlisting">o.Albedo = _Color.rgb; </pre><p><code class="literal">Albedo</code> is <code class="literal">fixed3</code>, which means that it contains three values of the <code class="literal">fixed</code> type. However, <code class="literal">_Color</code> is defined as a  <code class="literal">fixed4</code> type.  A direct assignment would <span>result</span><a id="id325445065" class="indexterm"></a> in a <span>compiler</span><a id="id325445074" class="indexterm"></a> error as <code class="literal">_Color</code> is bigger than <code class="literal">Albedo</code>. The C# way of doing this would be as follows:</p><pre class="programlisting">o.Albedo.r = _Color.r; 
o.Albedo.g = _Color.g; 
o.Albedo.b = _Color.b; </pre><p>However, it can be compressed in Cg:</p><pre class="programlisting">o.Albedo = _Color.rgb; </pre><p>Cg also allows reordering elements, for instance, using <code class="literal">_Color.bgr</code> to swap the red and blue channels.</p><p>Lastly, when a single value is assigned to a packed array, it is copied to all of its fields:</p><pre class="programlisting">o.Albedo = 0; // Black =(0,0,0) 
o.Albedo = 1; // White =(1,1,1) </pre><p>This is <span>referred</span><a id="id325445191" class="indexterm"></a> to as <span class="strong"><strong>smearing</strong></span>.</p><p>Swizzling can also be used on the left-hand side of an expression, allowing only certain components of a packed array to be overwritten:</p><pre class="programlisting">o.Albedo.rg = _Color.rg; </pre><p>In this case, it is called <span class="strong"><strong>masking</strong></span>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec38"></a>There's more...</h3></div></div></div><p>Where swizzling really shows its full potential is when it's applied to packed matrices. Cg allows types such as <code class="literal">float4x4</code>, which represents a matrix of floats with four rows and four columns. You can access a single element of the matrix using the <code class="literal">_mRC</code> notation, where <span class="emphasis"><em>R</em></span> is <span>the</span><a id="id325451207" class="indexterm"></a> row and <span class="emphasis"><em>C</em></span> is <span>the</span><a id="id325451219" class="indexterm"></a> column:</p><pre class="programlisting">float4x4 matrix; 
// ... 
float first = matrix._m00; 
float last = matrix._m33; </pre><p>The <code class="literal">_mRC</code> notation can also be chained:</p><pre class="programlisting">float4 diagonal = matrix._m00_m11_m22_m33; </pre><p>An entire row can be selected using squared brackets:</p><pre class="programlisting">float4 firstRow = matrix[0]; 
// Equivalent to 
float4 firstRow = matrix._m00_m01_m02_m03; </pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec39"></a>See also</h3></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">In addition to being easier to write, swizzling, smearing, and masking properties have performance benefits as well</li><li style="list-style-type: disc">However, inappropriate use of swizzling can also make your code harder to understand at first glance, and may make it harder for the compiler to automatically optimize your code</li><li style="list-style-type: disc">Packed arrays are one of the nicest features of Cg. You can discover more <span>about</span><a id="id325453395" class="indexterm"></a> them here: <span><a class="ulink" href="http://http.developer.nvidia.com/CgTutorial/cg_tutorial_chapter02.html" target="_blank">http://http.developer.nvidia.com/CgTutorial/cg_tutorial_chapter02.html</a></span></li></ul></div></div></div>