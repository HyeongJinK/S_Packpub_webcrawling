<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec26"></a>Merge requests</h2></div></div><hr /></div><p>Merge requests – commonly known as <span>pull</span><a id="id326288631" class="indexterm"></a> requests in other tools such as GitHub or BitBucket – are tasks that are assigned to someone that requests that they want to merge one branch into another. Using the <span>GitLab flow</span> described in <a class="link" href="#" linkend="ch03">Chapter 3</a>, <span class="emphasis"><em>GitLab Flow</em></span>, this is usually merging a feature branch into the master, or merging the master into a release, production, or pre-production/staging branch.</p><p>In this chapter, we'll continue using our example project to demonstrate the features of GitLab by creating a branch, completing some work, and then beginning a merge request. Next, we'll explore different parts of the merge request, including code review, assigning reviewers, and linking/closing issues from merge requests.</p><p> </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec36"></a>Example project continued</h3></div></div></div><p>Let's continue with our example project by adding <span>Composer</span><a id="id326288183" class="indexterm"></a> integration. The GitLab flow policy says that we should be doing this work on a branch, and that branch names should start with the issue number followed by a hyphen-separated description of the branch. For our example, we'll use <code class="literal">1-add-composer.json</code> and check it out like so:</p><pre class="programlisting"><span class="strong"><strong>git branch 1-add-composer.json</strong></span>
<span class="strong"><strong>git checkout 1-add-composer.json</strong></span></pre><p>We can also shorten this to the following:</p><pre class="programlisting"><span class="strong"><strong>git checkout -b 1-add-composer.json</strong></span></pre><p>Now, let's add our <code class="literal">composer.json</code> file. You'll need to follow the instructions to install Composer at <a class="ulink" href="https://getcomposer.org" target="_blank">https://getcomposer.org</a>. Then, from the directory with your project, run the following:</p><pre class="programlisting"><span class="strong"><strong>composer init</strong></span></pre><p>This will lead you through an interactive prompt where you can specify a package name, author, license, and so on. Go through the prompt and choose not to interactively require dependencies or add to <code class="literal">.gitignore</code>.</p><p>We'll need to add some packages to our <code class="literal">composer.json</code> file as well, so run the following commands to add a dependency on Monolog:</p><pre class="programlisting"><span class="strong"><strong>composer require monolog/monolog</strong></span></pre><p>Now, we can commit the <code class="literal">composer.json</code> file and push it to the remote repository like so:</p><pre class="programlisting"><span class="strong"><strong>git add composer.json</strong></span>
<span class="strong"><strong>git commit -m "#1 adding composer.json file"</strong></span>
<span class="strong"><strong>git push origin 1-add-composer.json</strong></span></pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec37"></a>Creating a merge request</h3></div></div></div><p>If we go back to our issue view, we'll see <span>that</span><a id="id325277250" class="indexterm"></a> there's now a related branch:</p><p> </p><p> </p><div class="mediaobject"><img src="/graphics/9781789534344/graphics/cf602d56-1182-4bbe-9143-692616c127e9.png" /></div><p>Let's click that branch name. We'll be taken to a view of the changed code. You'll see in this view that we can see the author of the commits and the changed files, including additions and deletions. Up at the top, you can also change the <strong class="userinput"><code>Source</code></strong> and <strong class="userinput"><code>Target</code></strong> if you wanted to compare different branches, such as merging a sub-feature into a feature branch, or the master into a staging branch:</p><div class="mediaobject"><img src="/graphics/9781789534344/graphics/7200bade-7f33-4a10-a879-3245ff51d72e.png" /></div><p>Now, let's click the <strong class="userinput"><code>Create merge request</code></strong> button to get started on merging this code. You'll notice that the title and description have already been filled in with some information because GitLab has associated this branch with our issue. You can put <code class="literal">WIP:</code> at the start of the title of a merge request if you don't want it to be merged until you're ready. This indicates that the pull request is a <strong class="userinput"><code>Work In Progress</code></strong> and that you still have more commits to make before you're ready for review. This is commonly used on bigger changes when you might want someone to review your strategy or progress before you continue. If you put <strong class="userinput"><code>Closes #54</code></strong> or <strong class="userinput"><code>Fixes #73</code></strong>, GitLab will know <span>that</span><a id="id325418561" class="indexterm"></a> this merge request is associated with that issue and will close off that issue. Let's leave the issue request as it is and assign it to ourselves. You'll notice that you can also assign labels and/or milestones to a merge request, much like an issue. In this case, we'll assign the label and the milestone we created to this <span class="strong"><strong>merge request</strong></span> (<span class="strong"><strong>MR</strong></span>):</p><div class="mediaobject"><img src="/graphics/9781789534344/graphics/6485fd72-7432-4b61-8fa4-84b01514856e.png" /></div><p>When you scroll further down, you'll see more fields that you can utilize. First, we have approvals, which is only available to paid plans but handy if you want to ensure that a merge request is approved by a specific person or people (potentially a domain expert, QA person, senior developer, and so on). You can also set a number of approvals that are required before merge – another feature that's useful for ensuring rigorous code quality standards by making a number of users review the code before merging. We also have the option to close the source branch on merge, which is handy for keeping the repository clean by deleting branches once they're complete. If you ever need to do more work on the branch, you can simply re-branch and commit work with no issues. Lastly, the option to squash commits before merging can be useful if you commit frequently but don't want to store the whole commit message history (especially if you have a tendency to name them <code class="literal">wip</code>, <code class="literal">wip2</code>, <code class="literal">more wip</code>, or <code class="literal">whoops bugfix</code>). This will simply squash all of the commits into one before doing the merge commit, and label the squashed commit with the title of the merge request:</p><div class="mediaobject"><img src="/graphics/9781789534344/graphics/84707f52-e428-4be9-9b8e-d67ac1e34b66.png" /></div><p>Let's click <strong class="userinput"><code>Submit merge request</code></strong> and move on to the <span>next</span><a id="id325727389" class="indexterm"></a> section: code review.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec38"></a>Code review with merge requests</h3></div></div></div><p>You should now be faced with <span>your</span><a id="id325727819" class="indexterm"></a> merge request, which seems like a bit of a complex UI. Let's break down what we're seeing here:</p><div class="mediaobject"><img src="/graphics/9781789534344/graphics/2bc9d55d-285d-4a45-b326-26970a6bc1d7.png" /></div><p>Across the top we have our status; some information about when it was created and by who; an <strong class="userinput"><code>Edit</code></strong> button if we want to change the title, description, approvals required, and so on; and a <strong class="userinput"><code>Close merge request</code></strong> button, which will decline the merge request immediately and close it. Not to worry though, you can reopen it again if you accidentally press this button. Next up, we have our title and description, which we can flesh out as much as needed. I've left it pretty sparse since this is just an example project, but you might want to put more information about the solution you used to solve the problem, how to test the code, and so on. After that, we have some information about the branch we are merging and merging into, with the option to inspect and edit the files in the web <span class="strong"><strong>integrated development environment</strong></span> (<span class="strong"><strong>IDE</strong></span>).</p><p>The button to <strong class="userinput"><code>Check out branch</code></strong> will open a modal with some instructions on how to check out and <span>merge</span><a id="id325740045" class="indexterm"></a> the branch locally, although merging locally isn't always possible if you have protected certain branches to stop them being committed to. The last button with the cloud/download icon presents a <span>drop-down</span><a id="id325740052" class="indexterm"></a> menu that allows you to download the patches as a plain git diff or an email patch.</p><p>The next part of the merge request deals with the approvals and merging. Approvals are a paid-only feature, so we won't be using them at the moment, but merging is definitely what we want to be doing. You have a chance to override the decisions to delete the source branch after you've completed it if you want to keep it for any reason, and also a button that lets you modify the merge commit message. The main showrunner here is the <strong class="userinput"><code>Merge</code></strong> button, which will automatically merge our work into the master branch. We won't click it for now, though, because there's a bit more to discover, such as the following:</p><div class="mediaobject"><img src="/graphics/9781789534344/graphics/0b73d1bc-6572-44db-89d0-52b884e61e16.png" /></div><p>Just like with issues, you have the option to <span class="emphasis"><em>react</em></span> to posts using a thumbs up or thumbs down, or an emoji reaction; however, remember that you can't react to your own MRs. We also have a discussion section where the merge request can be discussed. Make some comments now to try it out, and remember that there's a Markdown syntax guide in the appendix if you need some memory jogging. Like with issues, you can also use the dropdown to the right of the <strong class="userinput"><code>Comment</code></strong> button in order to <strong class="userinput"><code>Start a discussion</code></strong> in case you wanted to discuss something specifically, but have it nicely threaded and easily accessible and followable by anyone reading.</p><p>Now, click on the <strong class="userinput"><code>Commits</code></strong> tab next to the <strong class="userinput"><code>Discussion</code></strong> tab:</p><div class="mediaobject"><img src="/graphics/9781789534344/graphics/77c594ef-1ca8-43b6-b87a-0e85417b1b8c.png" /></div><p>This is quite a simple view and just shows us the commits that make up our merge request. You can click a commit title to be taken directly to it if you want to see what changes it involved specifically, or copy the unique SHA hash, which identifies the commit using the clipboard symbol on the right. If you click the <strong class="userinput"><code>Changes</code></strong> tab next to the <strong class="userinput"><code>Commits</code></strong> tab, you'll be taken to the last main part of the merge request. Now, we can <span>start</span><a id="id325938555" class="indexterm"></a> auditing our code more directly:</p><div class="mediaobject"><img src="/graphics/9781789534344/graphics/c6efb3e8-d362-41e6-a001-19dbf2ac1f05.png" /></div><p> </p><p>While this may just look like a normal diff window, it has one big difference. If you hover your mouse over the left-hand side, you'll see a little comment icon appear:</p><div class="mediaobject"><img src="/graphics/9781789534344/graphics/31782250-bd07-47ee-b8c5-b8914f76f573.png" /></div><p>If we click that button, it opens up a comment window where we (or our colleagues) can comment on our code:</p><div class="mediaobject"><img src="/graphics/9781789534344/graphics/43917edb-37cf-4cf9-9bd4-994ba88d8463.png" /></div><p> </p><p>Here, we have our example comment. Now, we can hit the <strong class="userinput"><code><span>Comment</span><a id="id325938613" class="indexterm"></a></code></strong> button to finalize it:</p><div class="mediaobject"><img src="/graphics/9781789534344/graphics/c2a3f49a-3c53-40e9-9880-c4ac4a99b574.png" /></div><p>Okay, it looks like my colleagues have a bit to say about my work already, and I've responded to one of them. Looks like we'll have some more work to do. I've also put a reaction on Shmouf's post using the smiley face icon and marked it as resolved using the little tick icon next to the commentor's role (the part that says <strong class="userinput"><code>Guest</code></strong>, <strong class="userinput"><code>Maintainer</code></strong>, and so on).</p><p>Now, open your <code class="literal">composer.json</code> file and change the license type to MIT, and then run the following:</p><pre class="programlisting"><span class="strong"><strong>git add composer.json</strong></span>
<span class="strong"><strong>git commit -m "changing to MIT license"</strong></span>
<span class="strong"><strong>git push origin 1-add-composer.json</strong></span></pre><p>Now, if you refresh your code review window, you'll see the changes and can mark the <span>comment</span><a id="id325938740" class="indexterm"></a> as resolved.</p><p>All that's left for us to do now is merge the commit using the <strong class="userinput"><code>Merge</code></strong> button that we discussed earlier. Once done, it'll change to show you that the merge has been completed, along with the merge commit hash:</p><div class="mediaobject"><img src="/graphics/9781789534344/graphics/aedc9357-6100-4155-b172-37b0f0eb0f2c.png" /></div><p>If you've merged accidentally, you can <span class="emphasis"><em>undo</em></span> the commit with the <strong class="userinput"><code>Revert</code></strong> button, which will have to create a new commit on the merged into branch. You can also <strong class="userinput"><code>Cherry-pick</code></strong> the code if you want to take this merge request and apply it to another branch.</p></div></div>