<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec16"></a>Manual installation</h2></div></div><hr /></div><p>There are some situations where you won't be able to use an omnibus package to <span>install</span><a id="id325172285" class="indexterm"></a> GitLab, potentially if you want to use your own existing hardware, existing server software, or your own database. In these cases, you can do a manual installation of GitLab, which we will run through in this section. Please be aware that it is a more complicated process, and using the omnibus installation package is recommended if possible.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec10"></a>Initial packages</h3></div></div></div><p>There are some initial packages you'll need to <span>install</span><a id="id325172264" class="indexterm"></a> before you even think about language runtimes. Many might be available through your chosen operating system's package manager, otherwise you might need to source them from the net. The current list is as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">gcc</li><li style="list-style-type: disc">g++</li><li style="list-style-type: disc">libc</li><li style="list-style-type: disc">make</li><li style="list-style-type: disc">curl</li><li style="list-style-type: disc">openssh-server</li><li style="list-style-type: disc">logrotate</li><li style="list-style-type: disc">rsync</li><li style="list-style-type: disc">cmake</li><li style="list-style-type: disc">zlib development library</li><li style="list-style-type: disc">yaml development library</li><li style="list-style-type: disc">ssl development library</li><li style="list-style-type: disc">GDBM development library</li><li style="list-style-type: disc">GNU readline development library</li><li style="list-style-type: disc">ncurses 5 development library</li><li style="list-style-type: disc">libffi development library</li><li style="list-style-type: disc">XML development library</li><li style="list-style-type: disc">XSLT development library</li><li style="list-style-type: disc">curl SSL development library</li><li style="list-style-type: disc">ICU development library</li><li style="list-style-type: disc">RE2 development library</li></ul></div><p>If you're on a system with the apt package manager, such as Ubuntu or Debian, all of these packages can be installed by using the following code:</p><pre class="programlisting"><span class="strong"><strong>sudo apt-get install -y build-essential zlib1g-dev libyaml-dev libssl-dev libgdbm-dev libreadline-dev libncurses5-dev libffi-dev curl openssh-server libxml2-dev libxslt-dev libcurl4-openssl-dev libicu-dev logrotate rsync python-docutils pkg-config cmake libre2-dev
</strong></span></pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec11"></a>Languages, frameworks, and Git</h3></div></div></div><p>First, you'll need to <span>install</span><a id="id325168898" class="indexterm"></a> Ruby 2.3.x. You can use a packaged version if <span>your</span><a id="id325168891" class="indexterm"></a> OS <span>has</span><a id="id326409286" class="indexterm"></a> one or you may have to compile it from the source (available at <a class="ulink" href="https://www.ruby-lang.org/en/" target="_blank">https://www.ruby-lang.org/en/</a>). GitLab advises against using a version manager such as RVM, rbenv, and chruby as they can have problems interacting with the GitLab shell once it's been called from OpenSSH. After Ruby <span>has</span><a id="id326409305" class="indexterm"></a> been installed, install the Bundler gem with the following command:</p><pre class="programlisting"><span class="strong"><strong>sudo gem install bundler</strong></span></pre><p>Next up, there's Go. Used for several daemons and services, you can download this directly from the <span>Go</span><a id="id326410257" class="indexterm"></a> home page (<a class="ulink" href="https://golang.org/dl/" target="_blank">https://golang.org/dl/</a>) and follow their guides to getting started.</p><p>Node.js is used for compiling assets used by GitLab, and Yarn is used for managing JavaScript dependencies. You need at least version 6.0.0 of Node (<a class="ulink" href="https://nodejs.org/en/download/package-manager/" target="_blank">https://nodejs.org/en/download/package-manager/</a>) and 12.0.0 of <span>Yarn</span><a id="id326410277" class="indexterm"></a> (<a class="ulink" href="https://yarnpkg.com/en/docs/install/#mac-stable" target="_blank">https://yarnpkg.com/en/docs/install/#mac-stable</a>) to get this all working.</p><p>Now, you'll need to create a Git user for GitLab with the following command; remember the password you choose:</p><pre class="programlisting"><span class="strong"><strong>sudo adduser --gecos 'GitLab' git</strong></span></pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec12"></a>Databases</h3></div></div></div><p>As discussed in the <span class="emphasis"><em>Requirements</em></span> section, PostgreSQL is the <span>database</span><a id="id326410416" class="indexterm"></a> that's recommended by GitLab for running with full feature availability. You can find out how to download it from the <span>PostgreSQL</span><a id="id326410426" class="indexterm"></a> website at <a class="ulink" href="https://www.postgresql.org/download/" target="_blank">https://www.postgresql.org/download/</a>.</p><p>Once installed, connect to the database via a psql session with an admin user and run the following commands:</p><pre class="programlisting"><span class="strong"><strong>CREATE USER git CREATEDB;</strong></span>
<span class="strong"><strong>CREATE EXTENSION IF NOT EXISTS pg_trgm; -- Enables an extension required by GitLab</strong></span>
<span class="strong"><strong>CREATE DATABASE gitlabhq_production OWNER git;</strong></span></pre><p>Now, you should have your database set up. First, we'll need to log in and set a password for this user:</p><pre class="programlisting"><span class="strong"><strong>sudo -u git -H psql gitlabhq_production</strong></span>
<span class="strong"><strong>\password</strong></span></pre><p>Exit the database connection with <code class="literal">\q</code> and move on to the other main datastore, Redis. It may be available in your OS package manager (assuming that one is available), otherwise you can find installation instructions on the <span>Redis</span><a id="id325219369" class="indexterm"></a> website at <a class="ulink" href="https://redis.io/download" target="_blank">https://redis.io/download</a>:</p><pre class="programlisting">sed 's/^port .*/port 0/' /etc/redis/redis.conf.orig | sudo tee /etc/redis/redis.conf

# Enable Redis socket
echo 'unixsocket /var/run/redis/redis.sock' | sudo tee -a /etc/redis/redis.conf

# Grant permission to the socket to all members of the group
echo 'unixsocketperm 770' | sudo tee -a /etc/redis/redis.conf

# Create the directory which contains the socket
mkdir /var/run/redis
sudo chown redis:redis /var/run/redis
sudo chmod 755 /var/run/redis

# Persist the directory which contains the socket, if applicable
if [ -d /etc/tmpfiles.d ]; then
 echo 'd /var/run/redis 0755 redis redis 10d -' | sudo tee -a /etc/tmpfiles.d/redis.conf
fi

# Add git to the redis group
sudo usermod -aG redis git</pre><p>You'll need to restart the Redis server and it should be good to go.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec13"></a>GitLab</h3></div></div></div><p>Now, we're finally ready to install <span>GitLab</span><a id="id325219397" class="indexterm"></a> itself! Log in (or use <code class="literal">su</code>) as the git user and check out the GitLab Community Edition repository:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Make sure that you go to the GitLab website first and pick a branch that's new and stable, like I have in the following code:</li></ol></div><pre class="programlisting"><span class="strong"><strong>      git clone https://gitlab.com/gitlab-org/gitlab-ce.git -b 11-1-stable 
      gitlab</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Next up, change into the directory that you just checked GitLab into:</li></ol></div><pre class="programlisting"><span class="strong"><strong>      cd gitlab</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Copy the example <code class="literal">config</code> and edit the file with your preferred text editor, according to the directions at the top of the file:</li></ol></div><pre class="programlisting"><span class="strong"><strong>      cp config/gitlab.yml.example config/gitlab.yml</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Make the uploads directory:</li></ol></div><pre class="programlisting"><span class="strong"><strong>      mkdir public/uploads/</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Copy the default config files:</li></ol></div><pre class="programlisting"><span class="strong"><strong>      cp config/secrets.yml.example config/secrets.yml</strong></span>
<span class="strong"><strong>      cp config/unicorn.rb.example config/unicorn.rb</strong></span>
<span class="strong"><strong>      cp config/initializers/rack_attack.rb.example config/initializers
      /rack_attack.rb</strong></span>
<span class="strong"><strong>      cp config/resque.yml.example config/resque.yml</strong></span>
<span class="strong"><strong>      cp config/database.yml.postgresql config/database.yml</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Edit <code class="literal">config/database.yml</code> with your preferred text editor and update the production | password value with your git user password.</li><li>Configure the global <code class="literal">git</code> settings:</li></ol></div><pre class="programlisting"><span class="strong"><strong>      git config --global core.autocrlf input</strong></span>
<span class="strong"><strong>      git config --global gc.auto 0</strong></span>
<span class="strong"><strong>      git config --global repack.writeBitmaps true</strong></span>
<span class="strong"><strong>      git config --global receive.advertisePushOptions true</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>Install gems:</li></ol></div><pre class="programlisting"><span class="strong"><strong>      bundle install —deployment</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Install GitLab Shell:</li></ol></div><pre class="programlisting"><span class="strong"><strong>      bundle exec rake gitlab:shell:install 
      REDIS_URL=unix:/var/run/redis/redis.sock RAILS_ENV=production
      SKIP_STORAGE_VALIDATION=true</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>Install GitLab Workhorse:</li></ol></div><pre class="programlisting"><span class="strong"><strong>      bundle exec rake "gitlab:workhorse:install[/home/git/gitlab-
      workhorse]" RAILS_ENV=production</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="11" type="1"><li>Install Gitaly:</li></ol></div><pre class="programlisting"><span class="strong"><strong>      bundle exec rake "gitlab:gitaly:install[/home/git/gitaly]" 
      RAILS_ENV=production</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="12" type="1"><li>Install GitLab (answer <code class="literal">yes</code> to any questions):</li></ol></div><pre class="programlisting"><span class="strong"><strong>      bundle exec rake gitlab:setup RAILS_ENV=production</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="13" type="1"><li>Check the status of GitLab:</li></ol></div><pre class="programlisting"><span class="strong"><strong>      bundle exec rake gitlab:env:info RAILS_ENV=production</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="14" type="1"><li>Prepare and compile the assets:</li></ol></div><pre class="programlisting"><span class="strong"><strong>      bundle exec rake gettext:compile RAILS_ENV=production</strong></span>
<span class="strong"><strong>      yarn install --production --pure-lockfile</strong></span>
<span class="strong"><strong>      bundle exec rake gitlab:assets:compile RAILS_ENV=production 
      NODE_ENV=production</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="15" type="1"><li>Start GitLab:</li></ol></div><pre class="programlisting"><span class="strong"><strong>      lib/support/init.d/gitlab start</strong></span></pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec14"></a>Installing nginx</h3></div></div></div><p>The last thing we have to do is set up a web server. The server that's recommended by <span>GitLab</span><a id="id325223450" class="indexterm"></a> is nginx, at least version 1.12.1. Once you have it installed, set up the config:</p><pre class="programlisting"><span class="strong"><strong>sudo cp /home/git/gitlab/lib/support/nginx/gitlab /etc/nginx/sites-available/gitlab</strong></span>
<span class="strong"><strong>sudo ln -s /etc/nginx/sites-available/gitlab /etc/nginx/sites-enabled/gitlab</strong></span></pre><p>Now, you'll need to edit that config in your preferred text editor to update the <code class="literal">YOUR_SERVER_FQDN</code> value to match the hostname you'll be using for GitLab.</p><p>Finally, you should be all done and able to browse to the URL for GitLab that you set, and create a password to log in.</p></div></div>