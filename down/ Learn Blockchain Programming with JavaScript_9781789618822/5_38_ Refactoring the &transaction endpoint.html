<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec41"></a>Refactoring the /transaction endpoint</h2></div></div><hr /></div><p>We're going to refactor the <code class="literal">/transaction</code> endpoint in <span>this</span><a id="id325458919" class="indexterm"></a> section, so that it works perfectly with the new <code class="literal">/transaction/broadcast</code> endpoint. Let's apply the following steps to modify the endpoint:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>To get started, go to the <code class="literal">dev/networkNode.js</code> file and delete everything that is in the <code class="literal">/transaction</code> endpoint. The only time the <code class="literal">/transaction</code> endpoint will be hit is when the broadcast takes place. When the <code class="literal">/transaction</code> endpoint is being hit, the <code class="literal">newTransaction</code> variable will be sent as data. This condition can be defined as follows: </li></ol></div><pre class="programlisting">app.post('/transaction', function(req, res) {
<span class="strong"><strong>const newTransaction = req.body;</strong></span>

};</pre><p>In the preceding highlighted line, the <code class="literal">newTransaction</code> variable is sent to the <code class="literal">/transaction</code> endpoint with the help of <code class="literal">req.body</code>. </p><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Next, add the new transaction to the <code class="literal">pendingTransactions</code> array of whichever node receives the call. To do this, the new <code class="literal">addTransactionToPendingTransactions</code> method will be used. Therefore, after the preceding line of code, add the following line: </li></ol></div><pre class="programlisting">bitcoin.addTransactionToPendingTransactions();</pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>This method simply takes in the <code class="literal">newTransaction</code> variable that is received:</li></ol></div><pre class="programlisting">bitcoin.addTransactionToPendingTransactions(<span class="strong"><strong>newTransaction</strong></span>);</pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Now, from the <code class="literal">addTransactionToPendingTransactions</code> method, we get the index of the block in which the transaction will be added. Let's save this block index in the new <code class="literal">/transaction</code> endpoint. At the start of the preceding line of code, add the variable as follows:</li></ol></div><pre class="programlisting"><span class="strong"><strong>const blockIndex</strong></span> = bitcoin.addTransactionToPendingTransactions(newTransaction);</pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>The final thing to do is to send <span>back</span><a id="id325690795" class="indexterm"></a> a response. After the preceding line, add the following: </li></ol></div><pre class="programlisting">res.json({ note: 'Transaction will be added in block ${blockIndex}.'});</pre><p>We've now finished refactoring the <code class="literal">/transaction</code> endpoint. </p></div>