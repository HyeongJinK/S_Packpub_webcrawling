<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec35"></a>Building the /register-nodes-bulk endpoint</h2></div></div><hr /></div><p>The next endpoint that we are going to build is our <code class="literal">register-nodes-bulk</code> endpoint; this is the final endpoint that we need to build. These three <span>endpoints</span><a id="id325683634" class="indexterm"></a> that we have been working on will all work together to create our decentralized blockchain network.</p><p>Before we start building the endpoint, let's try to understand what the <code class="literal">register-nodes-bulk</code> endpoint does. Whenever a new node gets broadcast to all the other nodes inside of the network, we want to take all of the nodes that are already inside of the network and send that data back to our new node so that the new node can register and recognize all of the nodes that are already present inside of the network.</p><p>The <code class="literal">register-nodes-bulk</code> endpoint will be accepting data that contains the URLs of every node that is already present in the network. Then, we're simply going to register all of these network nodes with the new node.</p><p> The new node is the node on which the <code class="literal">register-nodes-bulk</code> endpoint is hit. This endpoint is only ever hit on a new node that's being added to our network.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>To build the <code class="literal">register-nodes-bulk</code> endpoint, we'll have to make an assumption that all of the node URLs that are currently in our network are being passed in as data, and that we can access them on the <code class="literal">req.body.allNetworkNodes</code> property. This is because we're sending in the <code class="literal">allNetworkNodes</code> data when we call this endpoint in the <code class="literal">Promise.all(regNodesPromise)</code> block. Over here, we're sending in <code class="literal">allNetworkNodes</code> to the <code class="literal">register-nodes-bulk</code> endpoint. This will give us access to the <code class="literal">allNetworkNodes</code> data inside of the endpoint.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Let's add the following line of code to our <code class="literal">register-nodes-bulk</code> endpoint that we created in the previous sections: </li></ol></div><pre class="programlisting">app.post('/register-nodes-bulk', function (req, res) {
<span class="strong"><strong> const allNetworkNodes = req.body.allNetowrkNodes;</strong></span>

});</pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Next, let's loop through every node URL present in the <code class="literal">allNetworkNodes</code> array and register it with the new node, as follows:</li></ol></div><pre class="programlisting">app.post('/register-nodes-bulk', function (req, res) {
    const allNetworkNodes = req.body.allNetowrkNodes;
<span class="strong"><strong>allNetworkNodes.forEach(networkNodeUrl =&gt; { </strong></span>
<span class="strong"><strong>        //...</strong></span>
<span class="strong"><strong>    });</strong></span>

});</pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Now, all we're going to do inside of the loop is register each network node URL with the current node that we're on, which is the new node being added to the network:</li></ol></div><pre class="programlisting">app.post('/register-nodes-bulk', function (req, res) {
    const allNetworkNodes = req.body.allNetowrkNodes;
    allNetworkNodes.forEach(networkNodeUrl =&gt; { 
<span class="strong"><strong>bitcoin.networkNodes.push(metworkNodeUrl);</strong></span>
    });

});</pre><p>What's happening in the preceding highlighted line of code is that as we cycle through all the network nodes with our <code class="literal">forEach</code> loop, we are registering each one by pushing that <code class="literal">networkNodeUrl</code> into our <code class="literal">networkNodes</code> array.</p><p> Whenever we hit the <code class="literal">/register-nodes-bulk</code> endpoint, we are on the new node that's being added to the network. All of these <code class="literal">networkNodeUrls</code> are being registered to the new node that we are adding.</p><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Now there are a couple of instances in which we do not want to add a <code class="literal">networkNodeUrl</code> to our <code class="literal">networkNodes</code> array. To handle <span>these</span><a id="id325698323" class="indexterm"></a> instances, we are going to use an if statement. But before that, we need to define a conditional statement, as follows: </li></ol></div><pre class="programlisting">const nodeNotAlreadyPresent = bitcoin.networkNodes.indexOf(networkNodeUrl) == -1;</pre><p>One reason that we would not want to add a <code class="literal">networkNodeUrl</code> to our <code class="literal">networkNodes</code> array is if this <code class="literal">networkNodeUrl</code> already exists in our <code class="literal">networkNodes</code> array; that's what we have mentioned in the conditional statement. </p><p>All this statement is doing is testing to see if the <code class="literal">networkNodeUrl</code> that we're on is present inside of our <code class="literal">networkNodes</code> array. From here, it will simply evaluate this as either true or false.</p><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Now we can add the <code class="literal">nodeNotAlreadyPresent</code> variable and the if statement, as <span>highlighted  in the following code </span>:</li></ol></div><pre class="programlisting">app.post('/register-nodes-bulk', function (req, res) {
    const allNetworkNodes = req.body.allNetowrkNodes;
    allNetworkNodes.forEach(networkNodeUrl =&gt; {
    const nodeNotAlreadyPresent = 
      bitcoin.networkNodes.indexOf(networkNodeUrl) == -1; 
        if(<span class="strong"><strong>nodeNotAlreadyPresent</strong></span>)bitcoin.networkNodes.push(networkNodeUrl);
 });

});</pre><p>The preceding if statement states that if the node is not already present inside of our <code class="literal">networkNodes</code> array, then we're going to register that node.</p><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>Now, another instance in which we would not want to register a network node is if that network node has the same URL as the network node that we are currently on. To handle this, we'll have to make another variable:</li></ol></div><pre class="programlisting">const notCurrentNode = bitcoin.currentNodeUrl !==networkNodeUrl</pre><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>Next, add this variable to our <code class="literal">if</code> statement: </li></ol></div><pre class="programlisting">app.post('/register-nodes-bulk', function (req, res) {
    const allNetworkNodes = req.body.allNetowrkNodes;
    allNetworkNodes.forEach(networkNodeUrl =&gt; {
    const nodeNotAlreadyPresent = 
      bitcoin.networkNodes.indexOf(networkNodeUrl) == -1; 
        if(nodeNotAlreadyPresent &amp;&amp; notCurrentNode)
         bitcoin.networkNodes.push(networkNodeUrl);
 });

});</pre><p> </p><p>Basically, all we're stating in the <code class="literal">if</code> statement is that as we cycle through each network node that we're adding, if that node is not already present in our network node array and if that node is not our current node's URL, then we want to add the <code class="literal">networkNodeUrl</code> to our <code class="literal">networkNodes</code> array.</p><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Once we have completed the <code class="literal">forEach</code> loop, we'll have registered all of the network nodes that are already present inside of our blockchain network. All we have to do at this point is send back a response, as follows: </li></ol></div><pre class="programlisting">app.post('/register-nodes-bulk', function (req, res) {
    const allNetworkNodes = req.body.allNetowrkNodes;
    allNetworkNodes.forEach(networkNodeUrl =&gt; {
    const nodeNotAlreadyPresent = 
      bitcoin.networkNodes.indexOf(networkNodeUrl) == -1; 
        if(nodeNotAlreadyPresent &amp;&amp; notCurrentNode)
         bitcoin.networkNodes.push(networkNodeUrl);
 });
res.json({note: 'Bulk registration successful.' });

});</pre><p>Let's quickly review what we <span>have</span><a id="id325704637" class="indexterm"></a> done so far. The endpoint that we've built is accepting all of the network nodes as data, and then we are cycling through all of the network nodes that are already present in our blockchain network. For each n<span>ode, </span>as long as it is not already registered with the <code class="literal">currentNode</code> and is not the same URL as the <code class="literal">currentNode</code>, we are going to add <span>the node</span> to our <code class="literal">networkNodes</code> array.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec31"></a>Testing the /register-nodes-bulk endpoint</h3></div></div></div><p>In this section, we're <span>going</span><a id="id325897690" class="indexterm"></a> to test our <code class="literal">register-nodes-bulk</code> endpoint to make sure that it works properly. This will allow us to gain a clear understanding of how it works: </p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>To test the endpoint, we are going to head over to Postman. Here, we'll hit the <code class="literal">localhost:3001/register-nodes-bulk</code> endpoint.  When we test this endpoint, we expect to receive some data, which is the <code class="literal">allNetworkNodes</code> array.</li><li>Consequently, in the body tab inside Postman, with the <strong class="userinput"><code>raw</code></strong> option and <strong class="userinput"><code>JSON (application/json)</code></strong> format selected for the text, add the following lines of code to the body:</li></ol></div><pre class="programlisting">{
    "allNetworkNodes": []
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Inside of this array, there are going to be the URLs of all of the nodes that are already present in our blockchain network:</li></ol></div><pre class="programlisting">{
    "allNetworkNodes": [
    "http://localhost:3002",
    "http://localhost:3003",
    "http://localhost:3004"
    ]
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>When we run this request now, we should register all three of these URLs with our node that's running on <code class="literal">localhost:3001</code>. Let's see if that works. Click on the <strong class="userinput"><code>Send</code></strong> button and you will receive a response that states <strong class="userinput"><code>Bulk registration successful.</code></strong></li><li>Now, if we head over to the browser, we can double check that it worked. In the address bar, type <code class="literal">localhost:3001/blockchain</code> and then press <span class="emphasis"><em>Enter</em></span>. You will get to observe the three URLs that were added inside of <code class="literal">networkNodes</code> array, since those are bulk registered: </li></ol></div><div class="mediaobject"><img src="/graphics/9781789618822/graphics/5d3b788f-bd15-4eb2-902c-cec4a35b56fb.png" /></div><p>Similarly, you can try <span>experimenting</span><a id="id325916685" class="indexterm"></a> by adding new nodes to the other nodes on different URLs. You'll get to observe the similar response in the <code class="literal">networkNodes</code> array of these nodes. </p><p>So, it looks like our <code class="literal">register-node-bulk</code> endpoint is working just as it should.</p></div></div>