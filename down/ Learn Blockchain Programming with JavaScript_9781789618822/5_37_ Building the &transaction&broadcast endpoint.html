<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec40"></a>Building the /transaction/broadcast endpoint</h2></div></div><hr /></div><p>In this section, let's <span>build</span><a id="id325268059" class="indexterm"></a> a new endpoint called <code class="literal">/transaction/broadcast</code>. Anytime we want to create a new transaction from now on, we're going to hit this <code class="literal">/transaction/broadcast</code> endpoint. This endpoint will do two things:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">It will create a new transaction.</li><li style="list-style-type: disc">It will then broadcast that new transaction to all the other nodes in the network.</li></ul></div><p>Let's go through the following steps to create the endpoint: </p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>To add this endpoint, go to the <code class="literal">dev/networkNode.js</code> file where we have defined all the endpoints, and add this new endpoint as follows:</li></ol></div><pre class="programlisting">app.post('/transaction/broadcast', function(req, res) )  {

});</pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Then, in order for the endpoint to carry out the aforementioned functionalities, add the following highlighted code to the endpoint:</li></ol></div><pre class="programlisting">app.post('/transaction/broadcast', function(req, res) )  {
<span class="strong"><strong> const newTransaction = bitcoin.createNewTransaction();</strong></span>

});</pre><p>The <code class="literal">createNewTransaction()</code> method here is the modified method from the previous section.</p><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>The <code class="literal">createNewTransaction()</code> method takes in the <code class="literal">amount</code>, <code class="literal">sender</code>, and <code class="literal">recipient</code> parameters. For our endpoint, let's assume that all of that data is being sent on the <code class="literal">req.body</code>. Therefore, those parameters will be defined as shown highlighted in the following code: </li></ol></div><pre class="programlisting">app.post('/transaction/broadcast', function(req, res) )  {
    const newTransaction = bitcoin.createNewTransaction(<span class="strong"><strong>req.body.amount, req.body.sender, req.body.recipient</strong></span>);

});</pre><p> </p><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Next, let's add the <code class="literal">newTransaction</code> variable to the <code class="literal">pendingTransactions</code> array on the node with the help of the <code class="literal">addTransactionToPendingTransactions</code> method. Therefore, after the preceding line of code, add the following line:</li></ol></div><pre class="programlisting">bitcoin.addTransactionToPendingTransactions (newTransaction);</pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Now, broadcast the new transactions to all the other nodes inside the network. This can be done as follows:</li></ol></div><pre class="programlisting">bitcoin.netowrkNodes.forEach(networkNodeUrl =&gt; {
    //...
});</pre><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Inside this <code class="literal">forEach</code> loop, let's define the code to broadcast the transactions. To do this, make requests to the <code class="literal">/transaction</code> endpoints on all the <span>other</span><a id="id325698452" class="indexterm"></a> nodes inside the network. Therefore, define some options for these requests. Inside of the loop, let's add the following line: </li></ol></div><pre class="programlisting">const requestOptions = {

};</pre><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>Then, define all our options, as shown here:</li></ol></div><pre class="programlisting">const requestOptions = {
<span class="strong"><strong>uri: networkNodeUrl + '/transaction',</strong></span>
<span class="strong"><strong>    method: 'POST',</strong></span>
<span class="strong"><strong>    body: newTransaction,</strong></span>
<span class="strong"><strong>    json: true</strong></span>
};</pre><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>Next, let's create an array of promises to push all the requests into that array, so that we can run all the requests at the same time. Let's define the array before the <code class="literal">forEach</code> loop as follows:</li></ol></div><pre class="programlisting">const requestPromises = []; </pre><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Then, after defining all of the options, make the request as follows: </li></ol></div><pre class="programlisting">requestPromises.push(rp(requestOptions));</pre><p>With this preceding line of code, we're going to push all the requests into the <code class="literal">requestPromises</code> array. After the <code class="literal">forEach</code> loop has run, we should have all of the requests that we have defined inside the <code class="literal">requestPromises</code> array.</p><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>Next, let's run all of the requests. After the <code class="literal">forEach</code> loop, add the following line:</li></ol></div><pre class="programlisting">promise.all(requestPromises)</pre><div class="orderedlist"><ol class="orderedlist arabic" start="11" type="1"><li>Finally, after all the requests have run, we'll add the following line:</li></ol></div><pre class="programlisting">.then(data =&gt; {

});</pre><div class="orderedlist"><ol class="orderedlist arabic" start="12" type="1"><li>We're not actually going to use the data that comes back from all of these requests, but we are going to send a response, because, at <span>this</span><a id="id325852901" class="indexterm"></a> point, the entire broadcast is complete. Therefore, inside the preceding block of code, add the following highlighted code: </li></ol></div><pre class="programlisting">.then(data =&gt; {
<span class="strong"><strong> res.json({ note: 'Transaction created and broadcast successfully.'})</strong></span>
});</pre><p>By adding this preceding line of code, we have successfully completed building the <code class="literal">/transaction/broadcast</code> endpoint.</p></div>