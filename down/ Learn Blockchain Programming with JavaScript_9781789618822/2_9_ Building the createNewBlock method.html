<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec15"></a>Building the createNewBlock method</h2></div></div><hr /></div><p>Let's continue with building our <span>blockchain</span><a id="id325462128" class="indexterm"></a> data structure. After defining our constructor function in the previous section, the next thing that we want to do with our constructor function is to place a method in our <code class="literal">Blockchain</code> function. This method that we are going to create will be called <code class="literal">createNewBlock</code>. As its name suggests, this method will create a new block for us. Let's follow the below mentioned steps to build the method: </p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>The <code class="literal">createNewBlock</code> method will be defined as follows: </li></ol></div><pre class="programlisting">Blockchain.prototype.createNewBlock = function () { 

}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Now we've got this <code class="literal">createNewBlock </code> method on our blockchain <code class="literal">prototype</code> object. This method will take the three parameters, as highlighted in the following line of code: </li></ol></div><pre class="programlisting">Blockchain.prototype.createNewBlock = function (<span class="strong"><strong>nonce, previousBlockHash, hash</strong></span>) { 

}</pre><p>We'll learn in depth about these three parameters in further sections, so don't worry if you're not familiar with them.</p><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Now, the next thing that we want to do inside of our <code class="literal">createNewBlock</code> method is to create a <code class="literal">newBlock</code> object. Let's define this as follows: </li></ol></div><pre class="programlisting">Blockchain.prototype.createNewBlock = function (nonce, previousBlockHash, hash) { 
<span class="strong"><strong>const newBlock = { </strong></span>

<span class="strong"><strong>    };  </strong></span>

}</pre><p>This <code class="literal">newBlock</code> object is going to be a new block inside of our <code class="literal">BlockChain</code>, so all of the data is going to be stored inside of this block. This <code class="literal">newBlock</code> object is a pretty important part of our blockchain.</p><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Next, on the <code class="literal">newBlock</code> object, we're going to have an <code class="literal">index</code> property. This <code class="literal">index</code> value will basically be the block number. It will describe what number of block the <code class="literal">newBlock</code> is in our chain (for example, it may be the first block):</li></ol></div><pre class="programlisting">Blockchain.prototype.createNewBlock = function (nonce, previousBlockHash, hash) { 
    const newBlock = { 
<span class="strong"><strong>index: this.chain.length + 1,</strong></span>
    };   

}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Our next property is going to be a <code class="literal">timestamp</code>, because we want to know when the block was created: </li></ol></div><pre class="programlisting">Blockchain.prototype.createNewBlock = function (nonce, previousBlockHash, hash) { 
    const newBlock = { 
        index: this.chain.length + 1,
<span class="strong"><strong>timestamp: Date.now(),</strong></span>
    };   

}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Then, the next property we will add will be for the <code class="literal">transactions</code>. When we create a new block, we'll want to put all of the new transactions or the pending transactions that have just been created into the new block so that they're inside of our blockchain and can never be changed: </li></ol></div><pre class="programlisting">Blockchain.prototype.createNewBlock = function (nonce, previousBlockHash, hash) { 
    const newBlock = { 
        index: this.chain.length + 1,
        timestamp: Date.now(),
<span class="strong"><strong>transactions: this.newTransactions,</strong></span>
    };   

}</pre><p>The preceding highlighted line of code states that all of the transactions in the block should be the new transactions that are waiting to be placed into a block.</p><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>The next property that we are <span>going</span><a id="id325982574" class="indexterm"></a> to have on our block is a <code class="literal">nonce</code>, and this will be equal to the <code class="literal">nonce</code> parameter that we passed into our function earlier:</li></ol></div><pre class="programlisting">Blockchain.prototype.createNewBlock = function (nonce, previousBlockHash, hash) { 
    const newBlock = { 
        index: this.chain.length + 1,
        timestamp: Date.now(),
        transactions: this.newTransactions, 
<span class="strong"><strong> nonce: nonce,</strong></span>
    };   

}</pre><p>Now, you might be wondering what a <code class="literal">nonce</code> is. Basically, a nonce comes from a proof of work. In our case, this is simply any number; it doesn't matter which. This nonce is pretty much proof that we've created this new block in a legitimate way by using a <code class="literal">proofOfWork</code> method.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip3"></a>Note</h3><p>All of this might seem a little bit confusing right now, but don't worry — once we build more on our blockchain data structure, it will be much easier to understand how everything works together to create a functional blockchain. So, if you don't understand what a nonce is right now, don't worry about it. We're going to deal with this property in further sections, and it will become clearer as we move on.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>The next property is going to be a <code class="literal">hash</code>:</li></ol></div><pre class="programlisting">Blockchain.prototype.createNewBlock = function (nonce, previousBlockHash, hash) { 
    const newBlock = { 
        index: this.chain.length + 1,
        timestamp: Date.now(),
        transactions: this.newTransactions, 
        nonce: nonce,
<span class="strong"><strong>hash: hash,</strong></span>
    };   

}</pre><p>Basically, this <code class="literal">hash</code> will be the data from our <code class="literal">newBlock</code>. What's going to happen is we're going to pass our transactions or our <code class="literal">newTransactions</code> into a hashing function. What this means is that all of our transactions are going to be compressed into a single string of code, which will be our <code class="literal">hash</code>.</p><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Finally, our last property on our <code class="literal">newBlock</code> will be our <code class="literal">previousBlockHash</code>:</li></ol></div><pre class="programlisting">Blockchain.prototype.createNewBlock = function (nonce, previousBlockHash, hash) { 
    const newBlock = { 
        index: this.chain.length + 1,
        timestamp: Date.now(),
        transactions: this.newTransactions, 
        nonce: nonce,
        hash: hash,
<span class="strong"><strong>previousBlockHash: previousBlockHash,</strong></span>
    };   

}</pre><p>This <code class="literal">previousBlockHash</code> property is very similar to our <code class="literal">hash</code> property, except our <code class="literal">hash</code> property deals with the data from our current block hashed into a string, and the <code class="literal">previousBlockHash</code> property deals with the data from our previous block or the previous block to the current block hashed into a string.</p><p>So, <code class="literal">hash</code> and <code class="literal">previousBlockHash</code> are both hashes. The only difference is that the <code class="literal">hash</code> property deals with the data of the current block, and, the <code class="literal">previousBlockHash</code> property deals with the hashing of the data of the previous block.  This is how you create a new block, and this is what every block in our blockchain will look like.</p><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>Continuing with our <code class="literal">createNewBlock</code> method, the next thing that we want to do is set <code class="literal">this.newTransaction</code> as equal to an empty array, as follows:</li></ol></div><pre class="programlisting">Blockchain.prototype.createNewBlock = function (nonce, previousBlockHash, hash) { 
    const newBlock = { 
        index: this.chain.length + 1,
        timestamp: Date.now(),
        transactions: this.newTransactions, 
        nonce: nonce,
        hash: hash,
        previousBlockHash: previousBlockHash,          
    };

<span class="strong"><strong> this.newTransaction = []; </strong></span>

}</pre><p>We do this because, once we create our new block, we are putting all of the new transactions into the <code class="literal">newBlock</code>. Therefore, we want to clear out the entire new transactions array so that we can start over for the next block.</p><div class="orderedlist"><ol class="orderedlist arabic" start="11" type="1"><li>Next, what we simply want to do is take the new block that we've created and push it into our chain, and then we're going to return the <code class="literal">newBlock</code>:</li></ol></div><pre class="programlisting">Blockchain.prototype.createNewBlock = function (nonce, previousBlockHash, hash) { 
    const newBlock = { 
        index: this.chain.length + 1,
        timestamp: Date.now(),
        transactions: this.newTransaction, 
        nonce: nonce,
        hash: hash,
        previousBlockHash: previousBlockHash,          
    };

    this.newTransaction = [];
<span class="strong"><strong>  this.chain.push(newBlock);</strong></span>

<span class="strong"><strong>return newBlock;</strong></span>
}</pre><p>By adding these last two lines of code, our <code class="literal">createNewBlock</code> method is ready. Basically, what this method does on a high level is it creates a new block. Inside of <span>this</span><a id="id326132792" class="indexterm"></a> block, we have our transactions and the new transactions that have been created since our last block was mined. After we've created a new block, let's clear out the new transactions, push the new block into our chain, and simply return our new block.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec6"></a>Testing the createNewBlock method</h3></div></div></div><p>Now lets test the <code class="literal">createNewBlock</code> method <span>that</span><a id="id326132811" class="indexterm"></a> we created in the preceding section:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>The first thing that we need to do is export our <code class="literal">Blockchain</code> constructor function because we are going to use this function in our <code class="literal">test.js</code> file. So, to export the constructor function, we will go to the bottom of the <code class="literal">blockchain.js</code>file, type the following line of code, and then save the file: </li></ol></div><pre class="programlisting">module.exports = Blockchain;</pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Next, go to the <code class="literal">dev/test.js</code> file, as this is where we will be testing our <code class="literal">createNewBlock</code> method. Now, the first thing that we want to do in our <code class="literal">dev/test.js</code> file is import our <code class="literal">Blockchain</code> constructor function, so type the following: </li></ol></div><pre class="programlisting">const Blockchain = require('./blockchain');</pre><p>This preceding line of code simply requires or calls the <code class="literal">blockchain.js</code> file.</p><p> </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl3sec0"></a>Testing the Blockchain constructor function</h4></div></div></div><p>Let's test the Blockchain <span>constructor</span><a id="id326132921" class="indexterm"></a> function as follows: </p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Lets make an instance of our <code class="literal">Blockchain</code> constructor function, so we will add the following line of code:</li></ol></div><pre class="programlisting">const bitcoin = new Blockchain();</pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>The <code class="literal">bitcoin</code> variable in the preceding line of code is just used for the purpose of an example. Then we add the following line of code:</li></ol></div><pre class="programlisting">console.log(bitcoin); </pre><p>With the preceding line of code, <code class="literal">bitcoin</code> should be our blockchain. There is currently no data or blocks in this, but it should log out as a blockchain. Let's save the <code class="literal">test.js</code> file and run the test to observe the output on the terminal window.</p><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Now go to our terminal window. In here, we're currently in the <code class="literal">blockchain</code> directory, and our <code class="literal">test.js</code> file is in our <code class="literal">dev</code> folder, so type the following command in the terminal: </li></ol></div><pre class="programlisting"><span class="strong"><strong>node dev/test.js</strong></span></pre><p>This preceding line of code will allow us to run the test that we have written to test our <code class="literal">Blockchain</code> constructor function.</p><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Now press <span class="emphasis"><em>Enter</em></span>, and we'll get to observe the <code class="literal">Blockchain</code> on the terminal window, as highlighted in the following screenshot: </li></ol></div><div class="mediaobject"><img src="/graphics/9781789618822/graphics/7bc06210-6fea-4b69-925f-73a3dad82720.png" /></div><p>From the output in the preceding screenshot, we can observe that <code class="literal">Blockchain</code> has an empty chain and an empty transactions array. This is exactly what we expected the output to be. </p><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl3sec1"></a>Testing the createNewBlock method</h4></div></div></div><p>Let's follow the below mentioned <span>steps</span><a id="id326195034" class="indexterm"></a> to test the createNewBlock method: </p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Firstly, underneath where we created our <code class="literal">bitcoin</code> variable, type in the following highlighted line of code:</li></ol></div><pre class="programlisting">const Blockchain = require('./blockchain');

const bitcoin = new Blockchain();

<span class="strong"><strong>bitcoin.createNewBlock();</strong></span>

console.log(bitcoin); </pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>This <code class="literal">createNewBlock()</code> method requires three parameters, such as <code class="literal">nonce</code>, <code class="literal">previousBlockHash</code>, and a <code class="literal">hash</code>. For test purposes, we can just pass in whatever we want for now. Here, the nonce will just be a number. Then we will create a dummy hash for our <code class="literal">previousBlockHash</code>, followed by another hash for our <code class="literal">hash</code> parameter, as follows:</li></ol></div><pre class="programlisting">bitcoin.createNewBlock(2389,'OIUOEREDHKHKD','78s97d4x6dsf');</pre><p>Right now, we are creating our <code class="literal">bitcoin</code> blockchain, followed by a new block in our bitcoin blockchain. When we log out of our bitcoin blockchain, we should have one block in it.</p><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Save this file and run our <code class="literal">test.js</code> file again in the terminal. You'll then get to observe the following output: </li></ol></div><div class="mediaobject"><img src="/graphics/9781789618822/graphics/3c4d5d34-0acd-4cb7-8959-3824ff632870.png" /></div><p> </p><p> </p><p>In the preceding screenshot, you can observe the entire blockchain data structure in the <code class="literal">chain</code> array. This has one block in it, or one object in it. This block also has the <code class="literal">hash</code>, <code class="literal">nonce</code>, and <code class="literal">previousBlockHash</code> parameters that we had passed. It also has the <code class="literal">timestamp</code> and the <code class="literal">index</code> of <code class="literal">1</code>. It has no transactions because we haven't created any transactions yet. Consequently, we can conclude that the <code class="literal">createNewBlock</code> method works just fine. </p><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Now let's test our method even further by creating a couple more blocks in our chain. Let's duplicate the following lines of code  multiple times and then try to change the values in it as we wish:</li></ol></div><pre class="programlisting">bitcoin.createNewBlock(2389,'OIUOEREDHKHKD','78s97d4x6dsf');</pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>After duplicating the code and <span>changing</span><a id="id326207168" class="indexterm"></a> the value, save the file. Now, when we run our <code class="literal">test.js</code> file, we should have three blocks in our chain, as shown in the following screenshot: </li></ol></div><div class="mediaobject"><img src="/graphics/9781789618822/graphics/12e6b4f6-703c-47ba-9363-cfa6cfea3efd.png" /></div><p>In the preceding screenshot, you may have observed the three blocks inside of the <code class="literal">chain</code> array. These are all of the blocks that we've created with our <code class="literal">createNewBlock</code> method. </p><p> </p></div></div></div>