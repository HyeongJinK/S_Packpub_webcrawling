<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec33"></a>Building  the /register-and-broadcast-node endpoint </h2></div></div><hr /></div><p>Let's start building our register and <span>broadcast</span><a id="id325469152" class="indexterm"></a> node endpoint. The function of this endpoint will be to register the new node with itself and then broadcast the new node to all the other nodes that are already present in the network. So, let's get started with building the endpoint:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>From the preceding sections, in the <code class="literal">dev/networkNode.js</code> file, we already have the following code:</li></ol></div><pre class="programlisting">app.post('/register-and-broadcast-node', function(req, res) {
       const newNodeUrl = req.body.newNodeUrl;</pre><p><span>Here,</span> we defined a variable called <code class="literal">newNodeUrl</code>, and this <code class="literal">newNodeUrl</code> data will be passed onto the request body, similar to how we have transaction data being passed into the transaction endpoint. With access to the <code class="literal">newNodeUrl</code>, the first thing that we want to do is register <span>the node</span> with the node's <code class="literal">register-and-broadcast-node</code> endpoint.</p><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>To register it, all we have to do is put the <code class="literal">newNodeUrl</code> inside of our <code class="literal">networkNodes</code> array on our <code class="literal">blockchain</code> data structure. To do that, in the preceding code block, add the following highlighted code: </li></ol></div><pre class="programlisting">app.post('/register-and-broadcast-node', function(req, res) {
       const newNodeUrl = req.body.newNodeUrl;
<span class="strong"><strong> bitcoin.networkNodes.push(newNodeUrl);     </strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>By adding the preceding line of code, we are pushing the <code class="literal">newNodeUrl</code> into the <code class="literal">networkNodes</code> array. We only want to do this if the <code class="literal">newNodeUrl</code> isn't already present in the array. Check for this with the help of the <code class="literal">if</code> statement, as follows: </li></ol></div><pre class="programlisting">app.post('/register-and-broadcast-node', function(req, res) {
       const newNodeUrl = req.body.newNodeUrl;
<span class="strong"><strong> if (bitcoin.networkNodes.indexOf(newNodeUrl) == -1)
</strong></span>bitcoin.networkNodes.push(newNodeUrl);<span class="strong"><strong></strong></span></pre><p>What the <code class="literal">if</code> statement is doing is checking if the <code class="literal">newNodeUrl</code> is not already present in the <code class="literal">networkNodes</code> array. If it is not present, then it is added to the array. Consequently, with the help of the preceding block of code, the <code class="literal">newNodeUrl</code> is registered with the <code class="literal">register-and-broadcast-node</code> endpoint.</p><p> </p><p> </p><p> </p><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Now that we've registered the <code class="literal">newNodeUrl</code>, what we have to do now is broadcast it to all the other nodes inside of the network. To do that, add the following line of code after the if block: </li></ol></div><pre class="programlisting">bitcoin.networkNodes.forEach(networkNodeUrl =&gt; {
    //... '/register-node' 

}</pre><p>In the preceding block of code, for each network node that is already present in the network or for every network node that is already present inside of the <code class="literal">networkNodes</code><span>array</span>, we want to register our <code class="literal">newNodeUrl</code> with each of these <code class="literal">networkNodes</code> by hitting the register node endpoint. To do this, we're going to have to make a request to every single node at this endpoint.</p><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li> We're going to make this request by importing a new library. Let's head over to the terminal to import the library. In the terminal, we're going to cancel our first network node and then type the following command: </li></ol></div><pre class="programlisting"><span class="strong"><strong>npm install request-promise --save</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Installing this <code class="literal">request-promise</code> library will allow us to make requests to all the other nodes in our network. Once the library has been installed, restart the first node again by typing <code class="literal">npm run node_1</code>.</li><li>Now let's go to the <code class="literal">dev/networkNode.js</code>file and import the library that we just downloaded to the code. Import the library by typing the following line of code at the start: </li></ol></div><pre class="programlisting">const rp = require('request-promise');</pre><p>In the preceding line of code, <code class="literal">rp</code> stands for the request promise.</p><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>Now let's use this library in the <code class="literal">register-and-broadcast-node</code> endpoint. Over here, we have to broadcast our <code class="literal">newNodeUrl</code> to all the other nodes in our network. Do this with the help of  the <code class="literal">request-promise</code> library that we just imported.</li></ol></div><p>The next couple of steps that we are going to add to the code might look a little bit confusing as we're going through them, but don't worry. After the steps are complete, we'll walk through <span> the code</span>  step by step to make sure that everything is <span>clear to you</span>. Now let's take a look at the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>The first thing that we want to do for our <code class="literal">request-promise</code> library is define some options that we're going to use, so type in the <span>following</span><a id="id325702208" class="indexterm"></a> highlighted lines of code: </li></ol></div><pre class="programlisting">bitcoin.networkNodes.forEach(networkNodeUrl =&gt; {
<span class="strong"><strong>const requestOptions = {</strong></span>

<span class="strong"><strong>    }</strong></span>

}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Inside of this object, we want to define the options that we want to use for each request.</li><li>The first option that we want to define is what URI/URL we want to hit. We know that we want to hit the <code class="literal">register-node</code> endpoints on all of our other <code class="literal">networkNodeUrl</code>. Consequently, we will add the following highlighted line of code to our preceding block:  </li></ol></div><pre class="programlisting">bitcoin.networkNodes.forEach(networkNodeUrl =&gt; {
    const requestOptions = {
<span class="strong"><strong>uri<span>:</span> networkNodeUrl <span>+</span><span><span>'</span>/register-node<span>'</span></span>,</strong></span>
    }

}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Next, we want to define the method that we want to use. To hit the <code class="literal">register-node</code> endpoint, we'll have to use the <code class="literal">POST</code> method, so add the following code to the preceding code block:</li></ol></div><pre class="programlisting">method<span>:</span><span><span>'</span>POST<span>'</span></span>,</pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Then we want to find out what data we're going to pass along with this request, so add the following: </li></ol></div><pre class="programlisting">body: { newNodeUrl: newNodeUrl }</pre><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Finally, we're going to set the <code class="literal">json</code> option to true so that we can send it as JSON data:</li></ol></div><pre class="programlisting">json: true</pre><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>These are the options that we want to use for each request we make. Now let's see how we can use these options. After the <code class="literal">requestOptions</code> block, add the following line of code: </li></ol></div><pre class="programlisting">rp(requestOptions)</pre><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>The preceding request is going to return a promise to us, and we want to get all of these promises back in a single array. So, before and inside of the <code class="literal">forEach</code> loop, carry out the following highlighted changes: </li></ol></div><pre class="programlisting"><span class="strong"><strong>const regNodesPromises = [];</strong></span>
bitcoin.networkNodes.forEach(networkNodeUrl =&gt; {
    const requestOptions = {
        uri: networkNodeUrl + '/transaction',
        method: 'POST',
        body: newTransaction,
        json: true
    };
<span class="strong"><strong>regNodesPromises.push(rp(requestOptions));</strong></span>
});</pre><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Now, outside of the <code class="literal">forEach</code> loop, we want to run all of the <span>promises</span><a id="id326130190" class="indexterm"></a> that we had requested. Add the following code after the loop: </li></ol></div><pre class="programlisting">Promise.all(regNodesPromises)
.then(data =&gt; {
    //use the data...
});</pre><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec28"></a>Continuing to work on the /register-and-broadcast-node endpoint </h3></div></div></div><p>In this section, let's <span>continue</span><a id="id326167485" class="indexterm"></a> to build our <code class="literal">register-and-broadcast-node</code> endpoint. So far, we have registered the new node with the current network node that we're on and we have broadcast the new node to all the other nodes in our network. Consequently, we're hitting the <code class="literal">register-node</code> endpoint on all the other nodes inside of our network. Also, for now, we're assuming that those other nodes are registering the new node, which we haven't built yet, but we're assuming that it's working.</p><p>After the whole broadcast is completed, we must register all of the nodes that are currently inside of our network with the one new node that we are adding to the network. For that, we're going to use our <code class="literal">request-promise</code> library. Therefore, we need to define some options, as highlighted in the following code:</p><pre class="programlisting">Promise.all(regNodesPromises)
.then(data =&gt; {
<span class="strong"><strong> const bulkRegisterOptions = { </strong></span>
<span class="strong"><strong>uri: newNodeUrl + '/register-nodes-bulk'</strong></span>
<span class="strong"><strong>method: 'POST',</strong></span>
<span class="strong"><strong>        body: {allNetworkNodes: [...bitcoin.networkNodes,
        bitcoin.currentNodeUrl]} </strong></span>
<span class="strong"><strong>        json:true</strong></span>
<span class="strong"><strong>    };    </strong></span>
  });
});</pre><p>In the preceding code, the options that we want to use (such as <code class="literal">uri</code>) are defined, along with the <code class="literal">POST</code> method. In the body option, we defined the <code class="literal">allNetworkNodes</code> array, and inside of this array, we want all of the URLs of all the nodes in our network, plus the URL of the node that we're currently on. Furthermore, you might have noticed that we used a spread operator <code class="literal">...</code> in the array because <code class="literal">bitcoin.networkNodes</code>is an array and we don't want one inside of another. Instead,  we want to spread out all the elements of this array and put them inside of our outer array. <span>Finally, we want to define <code class="literal">json</code> as being <code class="literal">true</code>. </span></p><p>Next, we want to make the request, so after the options block, add the following: </p><pre class="programlisting">return rp(bulkRegisterOptions);</pre><p>After this, add the following: </p><pre class="programlisting">.then (data =&gt; {

})</pre><p>The <code class="literal">data</code> variable present in the preceding line of code will actually be the data that we receive from the aforementioned promise. We're not going to do anything with this data, but we want to use <code class="literal">.<span>then</span></code> because we want to do the next step inside of our endpoint. However, we can only do this after the aforementioned promise has completed. </p><p>The last step that we must <span>complete</span><a id="id326176507" class="indexterm"></a> inside of this endpoint is send a response back to whoever called it. Therefore, type the following highlighted lines of code: </p><pre class="programlisting">.then (data =&gt; {
    res.json({ note: 'New Node registered with network successfully' });
});</pre><p> That is it for our <code class="literal">register-and-broadcast-node</code> endpoint.</p><p> </p><p> </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl3sec4"></a>A quick recap of how the register-and-broadcast-node endpoint functions </h4></div></div></div><p>Now let's run through this <span>endpoint</span><a id="id326191389" class="indexterm"></a> again for a quick <span>summary</span> of what we did in this endpoint so that we have a better understanding of this. Whenever we want to register a new node with our network, the <code class="literal">register-and-broadcast-node</code> endpoint is the first point that we want to hit. The first thing that we're doing inside of this endpoint is taking the <code class="literal">newNodeUrl</code> and registering it with the current node by pushing it into our <code class="literal">networkNodes</code> array.</p><p>The next step that we have to make is to broadcast this <code class="literal">newNodeUrl</code> to the rest of the nodes in our network. We are doing that inside of the <code class="literal">forEach</code> loop. All that's happening inside of this for loop is we're making a request to each of the other nodes in our network. We're making this request to the <code class="literal">register-node</code> endpoint. We are then pushing all of these requests into our <code class="literal">register-node</code> promises array, and then we're simply running all of those requests.</p><p>Once all of these requests are completed without any errors, we can assume that the <code class="literal">newNodeUrl</code> has been registered successfully with all of our other network nodes.</p><p>After our broadcast is complete, the next thing that we want to do is register all of the network nodes that are already present inside of our network with our new node. To do this, we make a single request to our new node and we hit the <code class="literal">register-nodes-bulk</code> endpoint. The data that we pass along to this endpoint is the URLs of all the nodes that are already present inside of our network.</p><p>We then run <code class="literal">rp(bulkRegisterOptions);</code>, and even though we haven't built the <code class="literal">register-nodes-bulk</code> endpoint yet, we're going to assume that it's working and that all of our network nodes have been registered with our new nodes successfully. Once that has happened, all of our calculations are complete, and we simply send back a note saying that the new node has been registered with the network successfully.</p><p>This may seem like a lot to take in at this point, but don't worry; it is recommended that you continue moving forward. In further sections, we're going to build our <code class="literal">register-node</code> endpoint, followed by our <code class="literal">register-nodes-bulk</code> endpoint. As we do this, everything should become clearer to you.</p><p> </p></div></div></div>