<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec34"></a>Building the  /register-node endpoint</h2></div></div><hr /></div><p>Now that we have <span>built</span><a id="id325268059" class="indexterm"></a> the <code class="literal">/register-and-broadcast-node</code> endpoint, it's time we move on to some things that are a little less complex. In this section, let's begin building the <code class="literal">register-node</code> endpoint. This is going to be very straightforward compared to the endpoint that we built in the previous section. </p><p>This <code class="literal">register-node</code> endpoint is where every node in the network is going to receive the broadcast that is sent out by our <code class="literal">register-and-broadcast-node</code> endpoint. The only thing that this <code class="literal">register-node</code> endpoint has to do is register the new node with the node that receives the request for it.</p><p>To begin building the <code class="literal">register-node</code> endpoint,  follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>The first thing that we'll have to do is define the <code class="literal">newNodeUrl</code>; therefore, add the following highlighted line of code: </li></ol></div><pre class="programlisting">// register a node with the network
app.post('/register-node', function(req, res) {
<span class="strong"><strong> const newNodeUrl = req.body.newNodeUrl;</strong></span>
});</pre><p>The preceding line of code is simply stating <span>to use the value of</span> <code class="literal">newNodeUrl</code> that is sent to <code class="literal">req.body</code>. This is the data that we send to the <code class="literal">/register-node</code> endpoint, and we're going to save that new <code class="literal">nodeNodeUrl</code> as the <code class="literal">newNodeUrl</code> variable.</p><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Next, we want to register the <code class="literal">newNodeUrl</code> variable with the node that received the request. To do that, add the following highlighted line of code:</li></ol></div><pre class="programlisting">// register a node with the network
app.post('/register-node', function(req, res) {
<span class="strong"><strong></strong></span>const newNodeUrl = req.body.newNodeUrl;<span class="strong"><strong>
       bitcoin.networkNodes.push(newNodeUrl);</strong></span>
});</pre><p>The preceding line of code will register our new node with the node that we are currently on. All we'll do here is simply push the <code class="literal">newNodeUrl</code> into the current node's <code class="literal">networkNodes</code> array.  </p><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Now, the final thing that we have to do is send back a response, so type the following <span>highlighted line of code</span>: </li></ol></div><pre class="programlisting">// register a node with the network
app.post('/register-node', function(req, res) {
<span class="strong"><strong></strong></span>const newNodeUrl = req.body.newNodeUrl;<span class="strong"><strong>
</strong></span>bitcoin.networkNodes.push(newNodeUrl);
<span class="strong"><strong><span>res</span>.<span>json</span>({ note<span>:</span><span><span>'</span>New node registered successfully.<span>'</span></span> });</strong></span>
});</pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Next, we want to do some error handling inside of this endpoint. The only thing that we want to do is add <code class="literal">newNodeUrl</code> to our <code class="literal">networkNodes</code> array, if it doesn't already exist in that array. <span>To do this,</span>  we are going to add an if statement at the start of <code class="literal">bitcoin.networkNodes.push(newNodeUrl)</code>.  But before that, let's define a variable, as follows: </li></ol></div><pre class="programlisting">// register a node with the network
app.post('/register-node', function(req, res) {
<span class="strong"><strong></strong></span>const newNodeUrl = req.body.newNodeUrl;
<span class="strong"><strong>       const nodeNotAlreadyPresent = 
         bitcoin.networkNodes.indexOf(newNodeUrl) == -1; 
</strong></span>bitcoin.networkNodes.push(newNodeUrl);
<span>res</span>.<span>json</span>({ note<span>:</span><span><span>'</span>New node registered successfully.<span>'</span></span> });
});</pre><p>What this preceding highlighted line is stating is that if the index of the <code class="literal">newNodeUrl</code> is negative 1, or, in other words, if the <code class="literal">newNodeUrl</code> does not exist in our network nodes, then the <code class="literal">nodeNotAlreadyPresent</code> variable will be true. If the <code class="literal">newNodeUrl</code> already exists in our <code class="literal">networkNodes</code> array, then this variable will be false.  </p><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Inside of the if statement, what we're going to state is that if the <code class="literal">newNodeUrl</code> is not present in our <code class="literal">networkNodes</code> array then add it by running <code class="literal">bitcoin.networkNodes.push(newNodeUrl)</code>:</li></ol></div><pre class="programlisting">if (nodeNotAlreadyPresent ) bitcoin.networkNodes.push(newNodeUrl);</pre><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Next, there's one other case that we want to handle, which is that we do not want to push the <code class="literal">newNodeUrl</code> into our <code class="literal">networkNodes</code> array if the <code class="literal">newNodeUrl</code> is actually the URL of the current node that we're on. <span>To mention this condition in the code</span>, let's first have to define a variable:</li></ol></div><pre class="programlisting">const notCurrentNode = bitcoin.currentNodeUrl !== newNodeUrl;</pre><p>The preceding line is simply evaluating the <code class="literal">bitcoin.currentNodeUrl !== newNodeUrl</code> expression, which states whether or not the<code class="literal">currentNodeUrl</code>equals the<code class="literal">newNodeUrl</code>. If not, then the<code class="literal">notCurrentNode</code> variable will be true. If they do equal each other, then the variable will be false.</p><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>Next, we just <span>want</span><a id="id325812508" class="indexterm"></a> to add the <code class="literal">notCurrentNode</code> variable to our if statement, as follows:</li></ol></div><pre class="programlisting">if (nodeNotAlreadyPresent &amp;&amp; <span class="strong"><strong>notCurrentNode</strong></span> ) bitcoin.networkNodes.push(newNodeUrl);</pre><p>What's happening in this if statement is that if the new node is not already present in our <code class="literal">networkNodes</code> array and if the new node is not the same URL as the current node that we're on, then we just want to add the new node to our <code class="literal">networkNodes</code> array.</p><p>Everything that we have learned here is error handling inside of the endpoint.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec29"></a>Testing the  /register-node endpoint</h3></div></div></div><p>In this section, let's test the <code class="literal">/register-node</code> endpoint to <span>make</span><a id="id325812657" class="indexterm"></a> sure that it works properly and to get a better understanding of how it works.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl3sec5"></a>Installing the request library</h4></div></div></div><p>Before we get into testing the endpoint, there is a <span>small</span><a id="id325812672" class="indexterm"></a> update that we need to carry out. The update is regarding installing the request library. A few sections prior, we installed the <code class="literal">request-promise</code> library. Now, to test the endpoints that we just created, it might be necessary for us to also install the request library, depending on what version of the <code class="literal">request-promise</code> library we have.</p><p>To install the request library, simply go to your terminal, and inside of the <code class="literal">blockchain</code> directory run the following command:</p><pre class="programlisting"><span class="strong"><strong>npm install request --save</strong></span></pre></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec30"></a>Endpoint testing</h3></div></div></div><p>Before we get into testing, check <span>whether</span><a id="id325826634" class="indexterm"></a> you have all five of our network nodes running inside of your terminal. If not, then you will have to set them up.  Let's test the <code class="literal">register-node</code> endpoint by using Postman:</p><p> </p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>To start with, we're going to type <code class="literal">http://localhost:3001/register-node</code> in the address bar, as shown in the following screenshot: </li></ol></div><div class="mediaobject"><img src="/graphics/9781789618822/graphics/391ac174-6327-4b4e-ac66-7846b582f369.png" /></div><p>When we hit this endpoint, we are expected to send in a <code class="literal">newNodeUrl</code> as data on our <code class="literal">req.body</code>. We'll have to set that up now. So, in the <strong class="userinput"><code>Body</code></strong> tab inside of the Postman, we want to have <strong class="userinput"><code>raw</code></strong> selected and<strong class="userinput"><code>JSON (application/json)</code></strong>selected as the text.</p><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Then, inside the textbox, make an object and add the following code: </li></ol></div><pre class="programlisting">{
    "newNodeUrl":""
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Now let's say that we want to register our node that is running on port <code class="literal">3002</code> with our node that's running on port <code class="literal">3001</code>. Add the following to our preceding code: </li></ol></div><pre class="programlisting">{
    "newNodeUrl":<span class="strong"><strong>"http://localhost:3002"</strong></span>
}</pre><p>So far, we have registered our <span>node</span><a id="id325853834" class="indexterm"></a> that's running on <code class="literal">localhost:3002</code> with our node that's running on <code class="literal">localhost:3001</code>. Therefore, when we hit <code class="literal">http://localhost:3001/register-node</code>, our <code class="literal">localhost:3002</code> should show up in the <code class="literal">networkNodes</code> array of our first node (that is, <code class="literal">localhost:3001</code>) because this <code class="literal">register-node</code> endpoint registers a node by placing it into the <code class="literal">networkNodes</code> array.</p><p> </p><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>To verify this, go to Postman and click on the <strong class="userinput"><code>Send</code></strong> button. You will get the response <strong class="userinput"><code>New node registered successfully</code></strong>. Now go over to your browser and  type <code class="literal">localhost:3001/blockchain</code> into the address bar, followed by pressing <span class="emphasis"><em>Enter</em></span>. You will see an output similar to what's shown in the following screenshot: </li></ol></div><div class="mediaobject"><img src="/graphics/9781789618822/graphics/7e0cd98d-f6bb-493d-a4a4-0646fd487b14.png" /></div><p>Since we had just registered our second node with our current node on <code class="literal">localhost:3001</code>, we have our second node's URL inside of this array.</p><p>Following the same procedure, you can try to register other nodes too. Try experimenting with this. This will help you in gaining a clear understanding of the nodes that are registered. If you come across any issues, try to read through the whole procedure again.  </p><p>One important thing that we want to <span>notice</span><a id="id325893208" class="indexterm"></a> here is that if we now go to <code class="literal">localhost:3002/blockchain</code>, we get to observe that there are no network nodes registered in the <code class="literal">networkNodes</code> array. </p><p>Ideally, what we want to happen is that when we register a new node, we want it to reverse register as well. So, if we register <code class="literal">localhost:3002</code> with the node on <code class="literal">3001</code>, then our node on <code class="literal">3002 </code>should register <code class="literal">localhost:3001</code>. That way, both of these nodes will be aware of each other.</p><p>We've actually already built this functionality inside of our <code class="literal">register-and-broadcast-node</code> endpoint. Once we build all three of these endpoints, the functionality that we mentioned will work properly.</p></div></div>