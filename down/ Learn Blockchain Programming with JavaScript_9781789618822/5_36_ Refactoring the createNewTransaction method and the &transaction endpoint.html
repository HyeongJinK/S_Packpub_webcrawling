<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec39"></a>Refactoring the createNewTransaction method and the /transaction endpoint</h2></div></div><hr /></div><p>In this section, let's refactor the <code class="literal">createNewTransaction</code> method by splitting it <span>into</span><a id="id325458919" class="indexterm"></a> two separate parts. One part will simply create a new <span>transaction</span><a id="id325458928" class="indexterm"></a> and then return that transaction, and the other part will push the new transaction into the <code class="literal">pendingTransactions</code> array. We'll do the latter part by creating a separate method for it. We also create a new transaction endpoint called <code class="literal">/transaction/broadcast</code>. This endpoint will allow us to broadcast transactions throughout the entire blockchain network, so that every node has the same data and so that the entire network is synchronized.</p><p> </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec32"></a>Modifications to the createNewTransaction method</h3></div></div></div><p>Here, let's split up the <code class="literal">createNewTransaction</code> method <span>into</span><a id="id325458956" class="indexterm"></a> two separate methods, by modifying it as follows: </p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Go to the <code class="literal">createNewTransaction</code> method in your <code class="literal">dev/blockchain.js</code> file. We built this method in <a class="link" href="#" linkend="ch02">Chapter 2</a>, <span class="emphasis"><em>Building a Blockchain</em></span> in the <span class="emphasis"><em>Creating createNewTransaction method</em></span> section. For reference, take a look at the following <code class="literal">createNewTransaction</code> method: </li></ol></div><pre class="programlisting">Blockchain.prototype.createNewTransaction = function (amount, sender, recipient) {
    const newTransaction = {
        amount: amount,
        sender: sender,
        recipient: recipient,
    };
    this.newTransactions.push(newTransaction);
    return.this.getlastBlock() ['index'] + 1;
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Let's make the following highlighted modifications to the method: </li></ol></div><pre class="programlisting">Blockchain.prototype.createNewTransaction = function (amount, sender, recipient) {
    const newTransaction = {
        amount: amount,
        sender: sender,
        recipient: recipient,
<span class="strong"><strong>transactionId: uuid().split('-').join('')</strong></span>
    };
<span class="strong"><strong>return newTransaction;</strong></span>
}</pre><p>Here, an ID is added to every transaction. To create this ID, a unique string is used, which is very similar to what we had used for creating the node addresses in <a class="link" href="#" linkend="ch03">Chapter 3</a>, <span class="emphasis"><em>Accessing the Blockchain through an API.</em></span> </p><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Unique strings for the IDs are created with the use of the <code class="literal">uuid</code> library. Therefore, at the start of the <code class="literal">dev/blockchain.js </code>file, where all the constants are defined, you need to add the following line of code in order to use the <code class="literal">uuid</code> library in our project: </li></ol></div><pre class="programlisting">const uuid = require('uuid/v1');</pre><p>In the modified method, you can observe that the following line of code was added to create unique strings for the <code class="literal">transactionId</code> values. This is where the use of the <code class="literal">uuid</code> library was implemented:</p><pre class="programlisting">transactionId: uuid().split('-').join('')</pre><p>Here, the <code class="literal">.split()</code> function will take out the dashes that are added to the unique string, and then, the <code class="literal">.join()</code> function will rejoin the string to give an output of a unique <code class="literal">Id</code> for each transaction.  </p><p> </p><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec33"></a>Building the addTransactionToPendingTransactions method </h3></div></div></div><p>Next, we need to push the <code class="literal">newTransaction</code> that <span>was</span><a id="id325853847" class="indexterm"></a> returned to the <code class="literal">pendingTransactions</code> array of the blockchain. Therefore, let's create another method, called <code class="literal">addTransactionToPendingTransactions</code>: </p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In the <code class="literal">dev/blockchain.js</code> file, the <code class="literal">addTransactionToPendingTransactions</code> method will be defined as follows:  </li></ol></div><pre class="programlisting">Blockchain.prototype.addTransactionToPendingTransactions = function(transactionObj) {
};</pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Next, take the <code class="literal">transactionObj</code> and push it to the <code class="literal">pendingTransactions</code> array of the blockchain: </li></ol></div><pre class="programlisting">Blockchain.prototype.addTransactionToPendingTransaction = function(transactionObj) {
<span class="strong"><strong> this.pendingTransactions.push(transactionObj);</strong></span>

};</pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Then, we simply want to return the index of the block to which the transaction is added:</li></ol></div><pre class="programlisting">Blockchain.prototype.addTransactionToPendingTransaction = function(transactionObj) {
    this.pendingTransaction.push(transactionObj);
<span class="strong"><strong>return this.getLastBlock()['index'] + 1;</strong></span>
};</pre><p>To recap quickly, we modified the <code class="literal">createNewTransaction</code> method which creates a new transaction, and returns that new transaction. We then created a new method, called <code class="literal">addTransactionToPendingTransactions</code>. This method takes in a <code class="literal">transactionObj</code> and adds it to the <code class="literal">pendingTransactions</code> array on the blockchain. After that, we simply returned the index of the block to which the new transaction was added.</p></div></div>