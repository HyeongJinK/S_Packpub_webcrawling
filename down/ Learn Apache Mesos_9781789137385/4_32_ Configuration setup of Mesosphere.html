<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec36"></a>Configuration setup of Mesosphere</h2></div></div><hr /></div><p>In this section, we will work on the <span>configuration</span><a id="id325092395" class="indexterm"></a> of our resources. In the following manner, we will configure ZooKeeper connection information for Mesos, and then we will work on the ZooKeeper configuration setup on our master servers. </p><p>We completed the installation part of our project in the previous section. During the ZooKeeper configuration setup, we will define a unique ID on all the master servers and then do a mapping of ZooKeeper IDs to actual hosts before restarting ZooKeeper. Then, we will perform Mesos configurations on the master server: we will set up a quorum, then we will configure our hostname and IP address, and then we will see how to start and stop the Mesos master. Then, we will have a look at how to configure Marathon services. We will first install Java, then we will set up ZooKeeper's configuration to connect to our Mesos cluster and then set up our configuration to store Marathon information in ZooKeeper. Then, we will see how to start and stop Marathon services, and we will allow communication between subnets in AWS.</p><p>As you know, we have already created two subnets in AWS, and there are different hosts that are divided between those subnets. We want these two subnets to communicate with each other, so we will create some rules so that our server instances can communicate from one subnet to another. Then, we will allow inbound access to the Mesos and Marathon consoles in AWS. Then, once our configuration is done, we will access the Mesos UI and Marathon. For that, we need to allow access in AWS, after which we will test high availability for our Mesos and Marathon services.</p><p>We will see how cluster setup is done, and then we will stop one server and see how Mesos responds, and how the leader election takes place after the leader is down. Next, we will see how Marathon services work. As we have two Marathon services, we will stop one and see how to deploy the services on Mesos using the other Marathon.</p><p> </p><p>We will test higher availability for Mesos and Marathon services by stopping one of them, and seeing if the Marathon services are still accessible. Then, we will start Mesos slaves and register those slaves in the Mesos cluster.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec22"></a>Configuring ZooKeeper connection information for Mesos</h3></div></div></div><p>Our initial step is to create ZooKeeper <span>connection</span><a id="id325092422" class="indexterm"></a> information for Mesos. This <span>configuration</span><a id="id325092430" class="indexterm"></a> enables all of our servers to connect to the correct master server. The ZooKeeper cluster will only consist of our master server's information. The master server will be only the member of our ZooKeeper cluster, and all of the servers will communicate with our master using the following configuration file. Let's see that configuration file:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/42996f6f-e7e1-461f-8594-19f19741525a.png" /></div><p>This is the ZooKeeper configuration file.</p><p>We need to complete this step by editing the file and adding the information of our three master servers. As you can see, the lines will start with <code class="literal">zk</code> and end with <code class="literal">/mesos</code>, and in-between, you'll need to paste your master server's IP addresses and ZooKeeper ports.</p><p>We will now add the master server's IP to this file:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/a4db9021-8cb8-4278-bc76-4bed2b75ad8c.png" /></div><p>We will get the following output:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/0143ca1b-2726-4ad4-b530-77a35c7765f1.png" /></div><p>Remove <span>the</span><a id="id325245169" class="indexterm"></a> local information, as <span>shown</span><a id="id325245177" class="indexterm"></a> here:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/7f128910-ff8b-430b-a659-a932986db51f.png" /></div><p>As you can see, it has given us a warning; Warning: Changing read only file. Just exit this by entering the <code class="literal">:q</code> command.</p><p>Let's work on adding the master server's IP address to this file:</p><pre class="programlisting">sudo vi zk</pre><p>We will get the following output:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/dd4f395e-4b37-44cd-bde0-406f2fd8847e.png" /></div><p>Let's change the IP address, as shown here:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/ebadcb25-1e50-45a5-87a6-09f6bc426351.png" /></div><p><code class="literal">10.0.1.203:2181</code> is our second master server, and <code class="literal">10.0.2.123:2181</code> is the third one.</p><p><code class="literal">10.0.2.123:2181</code> is from another availability zone, so our third master server is in another availability zone. Let's save the file. Now, use the <code class="literal">cat</code> command to read the file, as <span>shown</span><a id="id325493926" class="indexterm"></a> in <span>the</span><a id="id325493934" class="indexterm"></a> following screenshot:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/fab9f825-3531-45e6-b28f-f882d603e2bd.png" /></div><p>Copy the marked area, because we need to add this identical entry to each of our master and slave servers. This will help each individual server to connect to the correct master server in order to communicate with the cluster.</p><p>Here, we need to enter the following commands:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/0f69df47-49dd-4e64-8bbc-a54a3bbde27c.png" /></div><p>We get the following output:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/6235c087-11be-4315-a1fb-be7b82bad24c.png" /></div><p>Next, paste in the line of IP addresses that we copied:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/010a7c54-38a8-492d-ad23-2db50e82a137.png" /></div><p>Repeat the same steps for <code class="literal">master3</code>. Delete <code class="literal">zk</code> <code class="literal">1L</code>, <code class="literal">26C</code>, then insert and paste in our line of IPs:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/f6d6d435-9078-43bb-b4b9-1181509b98b7.png" /></div><p>Here, we make sure our entries are identical on all the master and slave servers, otherwise it will impact the servers communicating with the master server.</p><p>Do the same with the <code class="literal">slave3</code> server, which is our last server.</p><p>Let's quickly verify whether all <span>three</span><a id="id325092584" class="indexterm"></a> servers are here <span>with</span><a id="id325092594" class="indexterm"></a> the following command:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/5a2a4eae-fbfd-427d-9c9c-12a8f1e65aee.png" /></div><p>You have to make sure that the line starts with <code class="literal">zk</code> and ends with <code class="literal">/mesos</code>. In between, you have the IP address of the master server and the ZooKeeper port. We have added these identical entries in each of our master servers, so our next step is to configure the master server's ZooKeeper configuration.</p><p>On your master servers, we will need to do some additional ZooKeeper configuration. We need to define a unique ID number, starting from 1 up to 255, for each of our master servers. This information is kept inside; the path is as follows:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/7b418cf7-59c6-4c93-9ec7-32281f29e6e7.png" /></div><p>We need to make a file here with the name <code class="literal">myid</code>, as shown here:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/aea3a6ef-058a-4332-9731-eb4645b6bf6b.png" /></div><p>Open the file using <code class="literal">vi</code> command and enter the value as <code class="literal">1</code> since this is our first master server.</p><p>We will now move to the <span>second</span><a id="id325092730" class="indexterm"></a> master server. We will follow the same path as before, except that for our <code class="literal">myid</code> value, we will add 2 instead. This is our second master. Similarly, for our third <span>master</span><a id="id325092742" class="indexterm"></a> server, we will enter <code class="literal">myid</code> as 3.</p><p>We have now completed the second step in our setup, where we have changed the ZooKeeper configuration by adding a unique ID number for all three master servers to a file called <code class="literal">myid</code> under <code class="literal">var/lib/zookeeper</code>. Let's move to the next step.</p><p>Our next step is to change our ZooKeeper configuration file to map our ZooKeeper IDs to the actual host. This will ensure that the service can correctly resolve each host from the ID system that it uses.</p><p>Let's open the ZooKeeper configuration file:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/d422c8e7-f0a8-4179-a584-07f307c8b441.png" /></div><div class="mediaobject"><img src="/graphics/9781789137385/graphics/12ef4f4d-c325-4fb5-bd55-cc118bd6314f.png" /></div><p>This is the path where <code class="literal">zoo.cfg</code> is stored. This is <span>our</span><a id="id325092793" class="indexterm"></a> ZooKeeper <span>configuration</span><a id="id325092803" class="indexterm"></a> file:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/8d510cfc-ac67-42ef-bbd0-255a08e0b6b4.png" /></div><p>We get the following warning, Changing a read-only file. This means that we need to use <code class="literal">sudo</code>:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/5596f8ce-437d-4d2e-9b72-b4d607f52055.png" /></div><p>Press <span class="emphasis"><em>Enter</em></span>, and you will get the ZooKeeper configuration file again. Go to the last line and add the following parameters:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/193c8452-a2d8-448b-8164-ce75d0072691.png" /></div><p>We have server.1, which is <span>our</span><a id="id325092857" class="indexterm"></a> ID; <code class="literal">10.0.1.42</code>, which is our IP address; and our port <span>details</span><a id="id325092870" class="indexterm"></a> are at the end. Similarly, we have <code class="literal">server.2</code> and <code class="literal">server.3</code>. Now, let's save the file and run <code class="literal">cat</code>:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/cd129314-8aeb-4cc3-b958-2ce05a1cf495.png" /></div><p> </p><p>Here, within this file, we mapped each ID to a host. The host specification includes two ports; the first for communicating with the leader, and the second for handling election when a new leader is required.</p><p>The ZooKeeper servers are identified by server, followed by dot and their ID number (for example, <code class="literal">server.1</code>). For this guide, we will be using the default port for each function, while our IDs are 1, 2, and 3. This is what our file looks like now:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/f72271e3-ba1d-441a-8fe8-4da05f8e92f1.png" /></div><p>We will add the same mappings in each of our master servers' configuration files. Let's copy this and go to the <code class="literal">master1</code> server:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/a09d3c8a-2c94-467f-b3a7-ee04c6ceb853.png" /></div><p>Go to the end and insert the identical instances of all of <span>our</span><a id="id325092974" class="indexterm"></a> master servers in the <span>ZooKeeper</span><a id="id325092983" class="indexterm"></a> configuration.</p><p>Go to <code class="literal">master2</code>, as shown here:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/274b3d3b-4531-4627-a5ad-0e84678f255a.png" /></div><p>Go to the end with <span class="emphasis"><em>Shift</em></span> + <span class="emphasis"><em>G</em></span>, and add the entry, as shown here:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/df7d53c5-3c76-4c36-98be-862e58a23840.png" /></div><p>We have <span>now</span><a id="id325093029" class="indexterm"></a> added <code class="literal">server1</code>, <code class="literal">server2</code>, and <code class="literal">server3</code>. With this, our <span>ZooKeeper</span><a id="id325493978" class="indexterm"></a> configuration is completed.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec23"></a>Configuring Mesos on the master server</h3></div></div></div><p>We will start by <span>changing</span><a id="id325493993" class="indexterm"></a> the quorum settings. The quorum settings should reflect your cluster size.</p><p>We need to change quorum to make decisions while electing a leader. This setting will stipulate the number of servers necessary for a cluster to be in a functioning state. The quorum setting should be so that 50 percent of master members must be present to make decisions.</p><p>We have three master servers, so the only setting that satisfies the quorum parameter is <code class="literal">2</code>. We will now open the configuration file. Go to the <code class="literal">master1</code> server. Clear the screen and enter the following:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/578c9c05-50ed-43f7-877a-cc940fd0c110.png" /></div><p>Change the value <code class="literal">1</code> to <code class="literal">2</code>. Value 1 was the default setting. After you've updated the value, save and close the file. Repeat this on each of our remaining master servers.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec24"></a>Configuring the hostname and IP address</h3></div></div></div><p>In this step, we will provide the <span>hostname</span><a id="id325494039" class="indexterm"></a> and IP <span>address</span><a id="id325494048" class="indexterm"></a> for each of our master servers. We will be using the IP address for the hostname so that our instance will not have any trouble resolving. Since you have defined the details in the hostname, you should be good, but we will not use hostname, we use the IP address only.</p><p>For our master servers, the IP address needs to be placed in this file:</p><pre class="programlisting">cd /etc/mesos-master/</pre><p>We will get the following output:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/b78a5163-f23f-4995-af8c-82d09f57036e.png" /></div><p>We need to create a file with the name IP and hostname. Let's create a file with IP:</p><pre class="programlisting">sudo touch ip
sudo vi ip,</pre><p>We need to provide the following:</p><pre class="programlisting">10.0.1.42</pre><p>Save the file. Now, we need to create a filename with the hostname, except we will use the IP address. For this, copy the <code class="literal">ip</code> file create and name it as hostname by using the following command:</p><pre class="programlisting">sudo cp ip hostname</pre><p>Run <code class="literal">ls -rlt</code> command and you will find that both files are present:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/757b1d18-6997-4fc4-a777-36d9b5b11f2f.png" /></div><p>So, we <span>have</span><a id="id325494186" class="indexterm"></a> now created <span>both</span><a id="id325494195" class="indexterm"></a> files, as shown here:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/9e77c349-09d1-43cd-9194-bbdcfeb0fb03.png" /></div><p>Similarly, we need to do this for each of our master servers.</p><p>We <span>have</span><a id="id325494218" class="indexterm"></a> thus completed the <span>configuration</span><a id="id325494227" class="indexterm"></a> of adding the IP address and hostname for the Mesos master.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec25"></a>Configuring Marathon services</h3></div></div></div><p>Now that we have completed Mesos configuration, we will start on <span>configuring</span><a id="id325494243" class="indexterm"></a> Marathon. Marathon will run on two separate hosts, <code class="literal">marathon1</code> and <code class="literal">marathon2</code>, and will be used to assign jobs to Mesos. Only the Mesos master server will be able to schedule jobs. Before we begin, let's first install Java using the following command:</p><pre class="programlisting">sudo yum insall java-1.8.0-openjdk-devel</pre><p>We are using Java 1.8. To validate the version by using <code class="literal">java -version</code> command, you can see that we have installed version 1.8.0_161. Copy the command to install Java and execute it on <code class="literal">marathon2</code> server. With that, we are done with the installation of Java.</p><p>Now, we need to define the list of ZooKeeper masters that Marathon will connect to for information and scheduling. We will be using the same ZooKeeper connection that we have been using for Mesos. To add a list of ZooKeeper master servers, go to the following directory, <code class="literal">/etc/systemd/system/multi-user.target.wants</code>, and open the <code class="literal">marathon.service</code> file.</p><p> </p><p> </p><p> </p><p>Here, in the ExecStart section, we need to add <code class="literal">--master</code> and the details of the ZooKeeper server IP and port at the end of the line. You will find these details in our master servers, which can be read using the following command:</p><pre class="programlisting">cat /etc/mesos/zk</pre><p>Copy the configuration and add it at the end of the line ExecStart. This configuration will allow our Marathon service to connect to the Mesos cluster. We also want Marathon to store its own state information in ZooKeeper. This can be done by adding the ZooKeeper information as <code class="literal">--zk</code>. Paste the ZooKeeper IP again, and now change mesos to marathon at the end of the IP. Now, we will provide the hostname, which is our IP address. IP addresses can be found by using <code class="literal">ifconfig</code>. Hence, the final <code class="literal">ExecStart</code> will look something similar to the following <span><span>screenshot</span></span>:</p><p>You need to copy the information that you just wrote, as we need to put this information in our <code class="literal">marathon1</code> server. In <code class="literal">marathon1</code>, navigate to <code class="literal">/etc/systemd/system</code>, and open the file <span>using</span><a id="id325494363" class="indexterm"></a> the following command:</p><pre class="programlisting">sudo vi marathon.service</pre><p>Go to the <code class="literal">ExecStart</code> line and paste the content you copied. Now, you need to change the hostname, which is found using <code class="literal">ipconfig</code>. Paste the hostname and save the file. Once the file is closed, and you've restarted the Marathon service, it will start the Marathon service with the information we have given it on Mesos and Marathon. This setup for Marathon will be used to configure during Marathon's startup. That is, while starting up, it will look up those details and start the Marathon services with those configurations.</p><p>Now, let's start all the services and verify Marathon and Mesos using the browser. Before doing that, we need to allow communication between the subnets. We will make changes in the security group to allow inbound connections from another subnet. Travel to the EC2 Dashboard and click on Running Instances. Here, you will find the eight servers that we have created. Select the server on one subnet with the address of 10.0.1.42.</p><p>Just a reminder that we created two subnets. You can verify this by visiting the VPC Dashboard and click on <strong class="userinput"><code>Subnets</code></strong>. As you are aware, we have a server inside this subnet, and our goal is to make sure that the subnets communicate with each other on the ports, as Marathon, and on one of the master servers. We have deliberately kept one of the masters on on subnet, and all of the other servers on another subnet. Our Marathon master and slave is on one subnet, and another group of Marathon masters is on another subnet.</p><p>Here, we want these two subnets to communicate with each other, so we need to allow communication between them. To achieve this, we need to make changes in security groups. Let's go to EC2 Instances, click on Running Instances, and then click on one of the instances and check the security group. Click on the security group, and you can check the inbound tab.</p><p>Since we need to allow this traffic. Click on edit and you will find one inbound rule present that we added while creating the server, which is SSH. Before we allow communication, let's check if these subnets can communicate between themselves or not. We will be using telnet to check communication. The following command contains the IP of <code class="literal">master3</code>, which is on another server:</p><pre class="programlisting">telnet 10.0.2.123 5050</pre><p>You will notice that we are not able to connect to the server. Let's try <span>using</span><a id="id325494406" class="indexterm"></a> the ZooKeeper port to check; you will find that you are not able to connect to the server that way either.</p><p>Now, navigate to the EC2 Dashboard, and click on <strong class="userinput"><code>Running Instances</code></strong>. Now, select another subnet, <code class="literal">10.0.2.0/24</code>, and click the security group. You can see that only SSH is allowed for now. To add more rules, click on Edit, and then Add Rule. Under the type dropdown, select All traffic, and enter the IP as 10.0.1.0/24. This is for restricting our traffic. This means that, apart from this subnet, no one can access those servers on those ports. Click on <strong class="userinput"><code>Save</code></strong> and our security group will similar.</p><p>Add another rule to allow traffic into another subnet as well. This time, add the IP as <code class="literal">10.0.2.0/24</code>. Here, we are restricting access only to this subnet. Click on <strong class="userinput"><code>Save</code></strong>, and then we are done allowing traffic between the two subnets.</p><p>Let's verify what we did by using telenet <code class="literal">10.0.2.123</code> on <code class="literal">master1</code> again. This time, you will see that we are able to connect to it. Check the same for the ZooKeeper port and you will notice that we are able to connect there also.</p><p>Now, you need to check whether you are able to connect to the internal subnet on <code class="literal">10.0.1.203</code>. You should find that you are not able to connect. You can see that our ports are active, but still, we are not able to connect the internet to the subnet. We are able, however, to connect another subnet to the first subnet. To allow us to connect to this, let's first add one more rule in the security group. Go to Mesos, click on <strong class="userinput"><code>Security Group</code></strong>, then click <strong class="userinput"><code>Edit</code></strong>, and add <strong class="userinput"><code>Rule</code></strong>. Here, we will select type as All traffic, and add <code class="literal">0.0.1.0/24</code> as the IP, then click on <strong class="userinput"><code>Save</code></strong>. We need to add this rule so that our instances can communicate with each other inside that security group. Now, make the same changes for the other security group. Here, we will add <code class="literal">10.0.2.0/24</code> as the IP. Quickly validate both the security groups, and we can see that we have added a rule where instances can communicate with each other from different security groups, as well as from inside the same security group. We will try to communicate between <code class="literal">master1</code> and <code class="literal">master2</code>. Quickly check this using the command telnet <code class="literal">10.0.1.203 2181</code>. Now, we are able to successfully communicate between our instances.</p><p>Let's go ahead and restart the services. First, we will stop all the services and then we will start them again, starting from mesos in <code class="literal">master1</code>. The following are the commands to stop the services:</p><pre class="programlisting">sudo service mesos-master stop
sudo service mesos-slave stop
sudo service zookeeper stop</pre><p>Now, stop all the services in <code class="literal">master2</code> and <code class="literal">master3</code>, and then stop the slave <span>services</span><a id="id325494498" class="indexterm"></a> in all slaves instances using the <code class="literal">sudo service mesos-slave stop</code> command. Once all the services are stopped, we will now start them all again.</p><p>Let's go to <code class="literal">master1</code>, and enter <code class="literal">sudo service mesos-master stop</code>. To check the status, run the <code class="literal">sudo service mesos-master status</code> command. It gives an error, stating <code class="literal">ZOO_ERROR@handle_socket_error: Socket</code>, Connection refused: server refused to accept the client. That means that it is trying to check ZooKeeper.</p><p>To avoid this error, we will stop <code class="literal">mesos-master</code> first, and then we will start ZooKeeper:</p><pre class="programlisting">sudo service zoopkeeer start</pre><p>Check the status and start ZooKeeper only on all the masters. Once you have started all of the ZooKeeper instances, and up on checking the status, you will find that it has started performing the negotiation.</p><p>Let's start the master server now, with the following command:</p><pre class="programlisting">service mesos-master start, do sudo, say status.</pre><p> </p><p>Now, we need to start all the services that we stopped previously in all our instances. This is <code class="literal">master2</code>, <code class="literal">master3</code>, and all 3 of the slave instances. Once all of the services are on, we will now start with Marathon service by using the <code class="literal">sudo service marathon start</code> command. We are getting an error which says, marathon.service change on disk. To find out more about the error, run <code class="literal">systemctl daemon-reload</code>. We changed the path earlier, hence we need to add the path as a parameter. Now we need to run the <code class="literal">systemctl daemon-reload</code>. Again, start the services. So, we have executed this service. Use service marathon start to start the service. It will take a long time to find out why this is the case, visit <code class="literal">var/log/</code> messages with the following commands:</p><pre class="programlisting">cd /var/log/
sudo vi messages</pre><p>Here, you can see we get the same error: <code class="literal">java.lang.UnsatisfiedLinkError:</code> no mesos in <code class="literal">java.library.path</code>.</p><p>This means that we need to install Mesos here, too, by <span>using</span><a id="id325494619" class="indexterm"></a> the following command:</p><pre class="programlisting">sudo yum install mesos</pre><p>We will just use those libraries to start our Marathon. Here, we are done with installation of Mesos.</p><p>Let's start the Marathon service using the following:</p><pre class="programlisting">service marathon start</pre><p>Check the message file again to view if there are still any errors. This is done by using the following commands:</p><pre class="programlisting">cd /var/log/ sudo vi messages
sudo tail -f messages</pre><p>Now, you will see that we are not able to see any errors, which means that we have all of services up and running. This means that we have successfully started Marathon.</p><p>You will see the Marathon log in <code class="literal">var/log/messages</code>. Now, we need to perform the installation that we just did in <code class="literal">Marathon2</code>.</p><p>Let's install Apache Mesos. Mesos is already installed here, so we may not find any issue during installation here, so let's quickly start the services. Use service marathon start to see the status. We can see it's active and running. Just check the status -l to see the logs-this shows that we have got all the services up and running, so Marathon must be started now. Our next step is to browse these services. So, let's quickly grab the IP of all three masters, and see if we are able to access the services through a browser. Let's go to EC2 Instances, click <strong class="userinput"><code>Running Instances</code></strong>, and <span>check</span><a id="id325494666" class="indexterm"></a> your master IP, to find this, you need to check the Public IP.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec26"></a>Allowing inbound access to Mesos and Marathon console in AWS</h3></div></div></div><p>Let's make <span>changes</span><a id="id325494681" class="indexterm"></a> in our security <span>group</span><a id="id325494690" class="indexterm"></a> to allow access to the <span>ports</span><a id="id325494698" class="indexterm"></a> of Marathon <span>and</span><a id="id325494707" class="indexterm"></a> Mesos. Let's <span>go</span><a id="id325494716" class="indexterm"></a> to the VPC Dashboard and click on <strong class="userinput"><code>Security Groups</code></strong>:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/30707af6-e374-4246-91fc-ffc1d061bf01.png" /></div><p>We can search our security group for mesos as follows:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/653d64ef-029f-48ab-b9be-de4c9d201348.png" /></div><p>Then we need to check the Inbound Rules, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/69c75123-bd2b-46d6-8ee4-acd0605a2c94.png" /></div><p>You can see that currently, access has been granted to SSH on TCP Port 22 from any source. Let's click <strong class="userinput"><code>Edit</code></strong>, and then click on <strong class="userinput"><code>Add another rule</code></strong>. We will add a <span>custom</span><a id="id325494773" class="indexterm"></a> rule, with port <code class="literal">5050</code> and the <span>Destination</span><a id="id325494786" class="indexterm"></a> as anywhere. As a <span>best</span><a id="id325494794" class="indexterm"></a> practice, you <span>should</span><a id="id325494803" class="indexterm"></a> restrict the source to your IP address, but for this example, we will use any source. Save the following:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/551257e8-97f5-4cf9-a20d-32f4d66ceb84.png" /></div><p>We will add another rule-the first was for Marathon, and the other is for our Apache Mesos access.</p><p> </p><p> </p><p>Do the same thing for another security group: <strong class="userinput"><code>Edit</code></strong>, add custom rule, <code class="literal">5050</code>. Save it. Let's see if we can access it now:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/fe8c2395-9c00-4640-81d5-4cdca1aaa9bb.png" /></div><p>Yes, we are able to access it!</p><p>After accessing the console, we can see that the cluster and leader are unknown and unnamed. So, let's quickly see how we can resolve this issue.</p><p>Log into the console, and then log in to the three master servers and change it to the following:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/24d0bd2f-324d-4180-94dc-cbade75bd7d9.png" /></div><p>This gives us the following output:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/918f0943-f878-48f6-9332-536453113221.png" /></div><p>Here, you can see the <code class="literal">hostname</code>:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/19a95601-59a5-4e40-88b2-69036d66a7c9.png" /></div><p>We <span>get</span><a id="id325494892" class="indexterm"></a> an IP:</p><p>We will <span>change</span><a id="id325494903" class="indexterm"></a> this <code class="literal">hostname</code><span>to</span><a id="id325494914" class="indexterm"></a> our <span>actual</span><a id="id325487312" class="indexterm"></a> hostname:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/9a7460cb-2f09-41f9-a1be-0925cbf843fa.png" /></div><p>The hostname is the following:</p><pre class="programlisting"> mesos-master1 </pre><p>Then, we need to insert the <code class="literal">hostname</code> in the <code class="literal">hostname</code> file:</p><p><span class="strong"><strong><div class="mediaobject"><img src="/graphics/9781789137385/graphics/29825134-ce98-424a-9ebf-0ca151b2da44.png" /></div></strong></span></p><p>We need to do the same changes on all the servers. First, we check the hostname, and change it to <code class="literal">mesos-master</code>. Change the hostname to <code class="literal">mesos-master2</code>. Do the same changes in <code class="literal">master3</code>. Check the hostname, since we have changed the file from IP to hostname of the server. After this, we need to make sure that our host entries are correct.</p><p>Let's quickly check whether our host entries are correct or not by executing the following command line:</p><pre class="programlisting"><span class="strong"><strong>cat /etc/hosts</strong></span></pre><p>The preceding command line generates the following output:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/3b5e1ce4-0480-4ae9-9df4-97148b6cb362.png" /></div><p>As you see here, we have already made these changes to save ourselves time. This should point to our private IP on all the three servers.</p><p>We will quickly validate by <span>again</span><a id="id325487424" class="indexterm"></a> using the earlier <span>command</span><a id="id325487432" class="indexterm"></a> line, as <span>shown</span><a id="id325487441" class="indexterm"></a> in the <span>following</span><a id="id325487449" class="indexterm"></a> screenshot:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/ee8f6456-1e38-4e8b-8d7a-17ac41036f67.png" /></div><p>This is where you can see that I have made the host changes. We will restart the servers, starting with <code class="literal">master1</code>. First, we will start the ZooKeeper by executing the following command line:</p><pre class="programlisting"><span class="strong"><strong>sudo service zookeeper start</strong></span></pre><p>The preceding command line will generate the following output:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/6a3bb8d6-ed83-4d2e-a082-d68165a758ab.png" /></div><p>Let's check with the status of the server by executing the following command line:</p><pre class="programlisting"><span class="strong"><strong>sudo service zookeeper status</strong></span></pre><p>You can see that the server is running:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/8f16d90c-5dfe-4a02-9090-13909e68b270.png" /></div><p>Copy this and run it on all other servers where the ZooKeeper log shows status <code class="literal">-l</code>:</p><pre class="programlisting"><span class="strong"><strong>sudo service zookeeper status -1</strong></span></pre><p>You will see that it will <span>perform</span><a id="id325487523" class="indexterm"></a> all <span>the</span><a id="id325487531" class="indexterm"></a> work <span>required</span><a id="id325487540" class="indexterm"></a> to <span>elect</span><a id="id325487584" class="indexterm"></a> the leader:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/1b5bf14b-cc8d-4d14-9866-a23446c8ff48.png" /></div><p> </p><p>You can see this log in the <code class="literal">var/log/messages</code> files, as well, which has given the <code class="literal">QuorumPeer[myid]</code> by running the <code class="literal">sudo service zookeeper status</code> command:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/60eeb89e-cd7a-4c01-88b5-4e6242ec9020.png" /></div><p>Currently, we are <span>running</span><a id="id325487628" class="indexterm"></a> the <code class="literal">master3</code> server, which <span>will</span><a id="id325487640" class="indexterm"></a> give <span>the</span><a id="id325487649" class="indexterm"></a> ID as 3, and this will show <code class="literal">LEADER ELECTION TOOK 34</code> seconds:</p><p>This is all the info you will be able to. You can <span>even</span><a id="id325487664" class="indexterm"></a> go to <code class="literal">cd /var/log</code> and perform the <code class="literal">vi</code> messages by executing the <code class="literal">sudo vi</code> messages command, and you will see the same info as what you are trying to see in status <code class="literal">-l</code>:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/aec00436-93c4-45fc-90f5-51ff7673602e.png" /></div><p>This is how you can check the logs and troubleshoot if you come across any issues while connecting to ZooKeeper, because all three servers connect to each other and together elect the leader.</p><p>Now, let's quickly start our Mesos service by executing the following command line:</p><pre class="programlisting"><span class="strong"><strong>sudo service mesos-master start</strong></span></pre><p>The preceding command line starts our Mesos service as shown in the following screenshot:</p><p>You will see the server is in a <span>running</span><a id="id325487708" class="indexterm"></a> state and <span>now</span><a id="id325487717" class="indexterm"></a> keep <span>the</span><a id="id325487761" class="indexterm"></a> status as <code class="literal">-l</code> for detecting a new leader:</p><p>So, let's clear the screen and do the same stuff on all of the other servers again:</p><p>You will see that the server is in a running state.</p><p> </p><p> </p><p>To get more info, you can check with your ZooKeeper group PIDs. ZooKeeper is communicating with the Mesos master server to elect the leader, which is assigned status <code class="literal">-l</code>. We will try to log in to our Mesos console for all three servers when <code class="literal">= Mesos =</code> is running.</p><p>Before logging in to the server, we need to make sure that our DNS host entries are available on your local server, that is, the local desktop machine from which you are going to access the Mesos console. Do this by adding the public IP with the name of our <code class="literal">mesos-master1</code>, <code class="literal">master2</code>, and <code class="literal">master3</code> servers, and save them on the local system from which you will access Mesos.</p></div></div>