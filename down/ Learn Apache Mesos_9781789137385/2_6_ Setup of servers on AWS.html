<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec12"></a>Setup of servers on AWS</h2></div></div><hr /></div><p>To deploy Apache Mesos and the <span>pertinent</span><a id="id325246112" class="indexterm"></a> components, we need servers where <span>we</span><a id="id325246120" class="indexterm"></a> can install these components. So, in this module, we will work on creating EC2 instances on AWS.</p><p> </p><p><span>To</span> deploy Mesos on AWS, we should have a <span class="strong"><strong>Virtual Private Cloud</strong></span> (<span class="strong"><strong>VPC</strong></span>), a subnet, in <span>order</span><a id="id325246147" class="indexterm"></a> to launch our instances inside different subnets as per our requirements, a route table where our instances can communicate with each other, and an internet gateway for public access, and then we will create the EC2 instances. After the creation of EC2 instances, we will deploy our Mesos software and their components.</p><p>Before we start with EC2 instances, let's understand the architecture of our system. The following diagram shows the architecture in which we are working on AWS and creating a VPC. Now we will create the EC2 instance, which will have two Marathon servers and three Mesos master servers along with Mesos slave servers. This will be around eight servers where Mesos will be installed.</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/4e87e1e7-823b-4014-8a2b-ecffe8143169.png" /></div><p>Let's get started by setting up the AWS servers.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec6"></a>Creating a VPC on AWS</h3></div></div></div><p>In order to set up <span>servers</span><a id="id325245143" class="indexterm"></a> on AWS, perform <span>the</span><a id="id325245152" class="indexterm"></a> following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Log in to your AWS console and click on Your VPCs. </li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>In order to create a new one, click on <strong class="userinput"><code>Create VPC</code></strong> and name it <code class="literal">Mesos</code> (since we are working on installing Mesos). Provide a IP in CIDR block text. The <span>CIDR block is the range of the IP address that we want to create the subnet of, and then on each subnet we will have own IP address that our instances can use when launched in each subnet.</span> So, we will put <code class="literal">10.0.0.0/16</code>. Keep the IPv6 CIDR block as the default and set <strong class="userinput"><code>Tenancy</code></strong> as <strong class="userinput"><code>Default</code></strong>. Here, default means resources can run on shared hardware. As you are running on shared hardware, Amazon provides complete security for your VPC. Click on <strong class="userinput"><code>Yes, Create</code></strong>:</li></ol></div><div class="mediaobject"><img src="/graphics/9781789137385/graphics/fdab0f68-6f2a-4e64-a294-3ce901d484c9.png" /></div><p>The following screenshot shows the created VPC:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/43556b28-ee95-4b9a-b124-1d990d4b780d.png" /></div><p>Our next step will be to create subnets.</p><p> </p><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec7"></a>Creating subnets</h3></div></div></div><p>Subnets contain the <span>instance</span><a id="id325245273" class="indexterm"></a> resource and will have <span>their</span><a id="id325245282" class="indexterm"></a> own IP address ranges. So, when creating subnets, you should know how you will leverage the AWS availability zone. This will help us to create a reliable and available infrastructure for our application. In order to create the subnets, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Click on the <strong class="userinput"><code>Subnets</code></strong> tab present at the sidebar. Set the <strong class="userinput"><code>Name tag</code></strong> as <code class="literal">10.0.1.0-mesos</code>; this will help us to identify our subnet easily. Then we will select our VPC, which was created earlier, as shown:</li></ol></div><div class="mediaobject"><img src="/graphics/9781789137385/graphics/e782ede9-e0ea-4988-92a3-ad335d1ab345.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Create the availability zone. On selecting the drop-down, you can see there are six different availability zones. Here, we can create highly available servers on AWS, that is, <strong class="userinput"><code>us-east-1a</code></strong>.</li><li>Select the CIDR <span>block</span><a id="id325245333" class="indexterm"></a> that will be our IP range: <code class="literal">10.0.1.0/24</code>. By <span>giving</span><a id="id325245345" class="indexterm"></a> this IP address, our subnet will have IP address from <code class="literal">10.0.0.1</code>, <code class="literal">1.1</code>, <code class="literal">1.2</code>, <code class="literal">1.3</code>, and so on. Click <strong class="userinput"><code>Yes, Create</code></strong> to create the subnet.</li><li>Create one more subnet by clicking the <strong class="userinput"><code>Create Subnet</code></strong> tab and set the <strong class="userinput"><code>Name tag</code></strong> as <code class="literal">10.0.2.0 - mesos</code>, select the VPC, set the availability zone as <strong class="userinput"><code>us-east-1b</code></strong>, and select your IP ranges. This subnet will have IP ranges starting from <code class="literal">10.0.2.0/24</code>. <span>Clic</span>k on <strong class="userinput"><code>Yes, Create.</code></strong></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>We <span>ha</span><a id="id325092076" class="indexterm"></a><span>ve</span><a id="id325092084" class="indexterm"></a> created <span>two</span><a id="id325092092" class="indexterm"></a><span>subnets:</span></li></ol></div><div class="mediaobject"><img src="/graphics/9781789137385/graphics/6b70d95e-9354-426b-9a9f-a2507d418a47.png" /></div><p>Now let's go ahead and check out route tables.</p><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec8"></a>Creating a route table</h3></div></div></div><p>Once we select <strong class="userinput"><code>Route <span>Tables</span><a id="id325092162" class="indexterm"></a></code></strong> option on the left pane, we can see we <span>already</span><a id="id325092170" class="indexterm"></a> have a default route created for our VPC. When we created <code class="literal">vpc-6066b51b</code>, this route table was created:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/23031e2b-d090-4155-af94-652196a7faf0.png" /></div><p><span>T</span>he route table will help us to flow our traffic between the subnets. As we have created two subnets, this route table will help us to communicate between two subsets.</p><p>Click on the <span><strong class="userinput"><code>Subnets</code></strong> option</span>, and on the <strong class="userinput"><code>Route Table</code></strong> tab you will find that our subnet is correctly associated with our route table, which is <code class="literal">rtb-bd75b0c1</code>:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/e8459b41-6f60-4b75-8a51-3634ad30a1ad.png" /></div><p>You can cross-verify the route table by visiting the route table and <span>checking the name of our VPC</span>.</p><p>You probably will have <span>noticed</span><a id="id325092232" class="indexterm"></a> that the <strong class="userinput"><code>Target</code></strong> is <strong class="userinput"><code>local</code></strong>, which <span>means</span><a id="id325092247" class="indexterm"></a> any route inside this IP range will get routed and traffic will be served.</p><p>We will now work on creating our servers.</p><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec9"></a>Creating EC2 instances</h3></div></div></div><p>Now we will create the EC2 <span>instances</span><a id="id325092267" class="indexterm"></a> for our Mesos application. You will see <span>running</span><a id="id325092276" class="indexterm"></a> instance details on the <span>EC</span>2 dashboard:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/e79c2251-094d-4842-b8f6-514934742b52.png" /></div><p>Since at present we do not have any instances running, you will find it blank. Let's create instances for our Mesos application to be deployed on those servers.</p><p>Click on <strong class="userinput"><code>INSTANCES</code></strong> (on the sidebar) and click <strong class="userinput"><code>Launch Instances</code></strong>. This will direct you to the page for you to select the type of instances you want. F<span>or this example,</span> we are using CentOS. To use CentOS, we need to go the marketplace and search CentOS. <span>Select the CentOS 7 module and then click on <strong class="userinput"><code>Continue</code></strong>:</span></p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/14f9823c-a811-48b8-9c7a-95a7d2e9974f.png" /></div><p> </p><p><span>In the following screen, we will use</span> g<span>eneral-purpose insta</span>nce, which is free-tier eligible. On the following screen, we need to provide a few details to create the instance, such as network, number of instances, and select the VPC and one of the two subnets. Set <span>the</span><a id="id325092346" class="indexterm"></a><strong class="userinput"><code>Auto-assign Public IP</code></strong> to <strong class="userinput"><code>Enable</code></strong>. We will keep the rest of the fields <span>we</span><a id="id325092361" class="indexterm"></a> will be keeping as default:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/614393bd-2d1a-4fa9-b8fc-368486965dbb.png" /></div><p><span>We have to create eight instances, that is, two for Marathon, three for Mesos master, and three for slave. However, for the subnet that we selected, will be providing one for Marathon, two for Mesos master, and one for slave, which is a total of five instances.</span> Then we need to select the VPC that was created earlier and any of the subnets. Here we have selected the <code class="literal">10.0.1.0</code> subnet. Click on <strong class="userinput"><code>Next: Add Storage</code></strong>.</p><p><span>The following screen</span> d<span>isplays the <strong class="userinput"><code>Volume Type</code></strong>,</span><strong class="userinput"><code><span>Devi</span>ce</code></strong>, and <strong class="userinput"><code>Snapshot</code></strong> details that will be created by default. We will be using only 8 GB of space. Now we will change the <strong class="userinput"><code>Volume Type</code></strong> to <strong class="userinput"><code>General Purpose</code></strong> and click on <strong class="userinput"><code>Next</code></strong>. This will lead you to the <strong class="userinput"><code>Add tags</code></strong><span> page</span>, which we will not be providing at present, so click <strong class="userinput"><code>Next</code></strong> to go to <strong class="userinput"><code><span>Security Group</span></code></strong>. Here we will allow only port <code class="literal">22</code>, and change the <strong class="userinput"><code>Security Group</code></strong> name to <strong class="userinput"><code>Mesos</code></strong>. We are allowing port range as <code class="literal">22</code> only to access our server. The source can be any destination, but you can restrict to your public IP from where you want access to the server and then click the <strong class="userinput"><code>Review</code></strong> and <strong class="userinput"><code>Launch</code></strong> button. <span>This screen</span> will show you a summary of your selections. You can cross-verify and review the servers, number of instance files to provide storage details, and the tags, if you have any. Click on <strong class="userinput"><code>Launch</code></strong>:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/5b3703cf-f794-4a18-9ff5-3c5f1bf2cc93.png" /></div><p><span>Here you need to create a new key pair with <strong class="userinput"><code>mesos</code></strong> as the key pair name. Click on <strong class="userinput"><code>Download Key Pair</code></strong></span>, <span>as shown in the screenshot. It</span> will be required to log into the servers later, and then click on <strong class="userinput"><code>Launch Instances</code></strong>. It will take a few <span>minutes</span><a id="id325092571" class="indexterm"></a> for the <span>instances</span><a id="id325092580" class="indexterm"></a> to be created:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/3588421a-0707-48fc-a1f1-3e885a3acc69.png" /></div><p>Now let's check our EC2 instances. You will find all our five instances have been created and in the Initializing phase, so let's wait till it gets launched or started. The following screenshot shows that our checks are complete and our instances are in t<span>he running phas</span>e:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/fda403b6-9d84-43c4-a629-3ad8df92c2fe.png" /></div><p>Now we will try to connect to our server. You will see it has all the details when you select any of the instances. You can find the IP address, Public IP, and the Private IP under the <strong class="userinput"><code>Description</code></strong> tab. Note that the IP in our case is <code class="literal">34.239.228.166</code>. Copy it, and we will use PuTTY to log in to the server. <span>Enter the IP that you just copied</span> and click on<span> <strong class="userinput"><code>Open</code></strong></span>:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/e44b33a6-d30d-4ba8-93e1-0bf638a6789b.png" /></div><p>You will notice that we are not able to log in to the server. This is because our VPC is not exposed to the public. To do that, we should <span>have</span><a id="id325092650" class="indexterm"></a> the internet gateway attached to our VPC so our servers can connect to the server and are exposed on a public network, and we can access it. Let's create an internet <span>gateway</span><a id="id325092659" class="indexterm"></a> and a<span>ttach it to ou</span>r VPC. In<span> the VPC Dashboard,</span> select <strong class="userinput"><code>Internet Gateways</code></strong>, then <strong class="userinput"><code>Create Internet Gateway</code></strong>, and name it <code class="literal">mesos</code>:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/e10b65eb-10f9-46eb-aa03-a6cb92b0bf5e.png" /></div><p>On creating the gateways, you can see that it is in detached mode. We need to attach this internet gateway to our VPC. To attach the VPC to our gateway, right-click on the created gateway, click our VPC, and click on the <strong class="userinput"><code>Yes, Attach</code></strong> button. To provide internet access to our instances, we need to add another route to the table. Go to <strong class="userinput"><code>Route Tables</code></strong>, and under <strong class="userinput"><code>Routes</code></strong>, click on <strong class="userinput"><code>Add another route</code></strong>. In the <strong class="userinput"><code>Target</code></strong> we select our internet gateway, which we created, and our destination can be anything; we are keeping it as <code class="literal">0.0.0.0/0</code>. We have now added another route. Now click on <strong class="userinput"><code>Subnets</code></strong>. We need to make sure this route is attached to our subnet so it can have access to the internet. Remember the route table, which is <code class="literal">bd75b0c1</code>. Under the subnet, you can see our route is already been added because we have already attached this route table to our subnet earlier. This creates a route to connect to our internet gateway in order to access the internet:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/781c76f2-0b01-488a-b4b6-8557bba6e689.png" /></div><p>Let's again check whether we can access the instances using SSH. Go to <strong class="userinput"><code>EC2 Instances</code></strong>, click on any of the instances, and grab one of the IP addresses. Then, open PuTTY, load your configuration that was downloaded earlier, put in the IP address of the instances, and click on <strong class="userinput"><code>Open</code></strong>. You will be asked for login credentials. That means we have successfully connected our instance to the internet and now we can log in to the instances. Enter user as <code class="literal">centos</code>, and press <span class="emphasis"><em>Enter</em></span>. So, in the following way you can access your instances on the internet using an internet <span>gateway:</span></p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/cbf5cc49-ef81-4686-af54-799b721e1165.png" /></div><p>Here we have used PuTTY to connect, but if you are using a Linux Terminal, you can easily use SSH, right-click on the instance, and click on <strong class="userinput"><code>Connect</code></strong>. <span>It will show you how you can use your PEM to connect to your server. </span>Here is an example command to connect to the SSH:</p><pre class="programlisting"><span class="strong"><strong>Ssh -I "mesos.pem" root@34.201.25.46</strong></span></pre><p>However, in our case, first we need to convert your PEM to your PPK, which is the private key. You will find a different <span>converter</span><a id="id325092817" class="indexterm"></a> online, one of which will be PuTTYgen. In PuTTYgen, you <span>first</span><a id="id325092825" class="indexterm"></a> need to load the <span>PEM</span> file and save it as a PPK. Once you have converted the file, open PuTTY, expand the SSH, go in the <span><strong class="userinput"><code>Auth</code></strong> menu</span>, and add the path to the PPK file that was converted. You can now connect to the instances using PuTTY by selecting the method and clicking on <strong class="userinput"><code>Open</code></strong>:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/7ff7d9ab-99f7-4597-9173-3134a241f307.png" /></div><p>Next, we will provide names for the instances created: <code class="literal">marathon1</code>, <code class="literal">mesos-slave1</code>, <code class="literal">mesos-slave2</code>, <code class="literal">mesos-master1</code>, and <code class="literal">mesos-master2</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec10"></a>Creating backup</h3></div></div></div><p>What if your server goes down? To <span>avoid</span><a id="id325092954" class="indexterm"></a> that, we will create few more instances in another subnet to have high availability. This is how you can make sure your application is highly available and reliable.</p><p> </p><p><span>Let's</span> start by creating remaining three servers on another availability zone. This can be done by clicking on <strong class="userinput"><code>Launch Instance</code></strong>, and selecting the AMI from AWS Marketplace. This will be the same that we created earlier, which is CentOS7. Here, we will select <strong class="userinput"><code>t2.micro</code></strong> instances, just as before. We will <span>now</span> need three instances. S<span>elect our VPC but with another subnet that we created. We will select the <strong class="userinput"><code>Enable auto-assign Public IP</code></strong> option this time so that we'll have the auto-assigned IP address. Now we will change the <strong class="userinput"><code>Volume Type</code></strong> to <strong class="userinput"><code>General Purpose SSD</code></strong>, and rest we will keep as it is, including the <strong class="userinput"><code>Tags</code></strong> section</span>.</p><p>In the <strong class="userinput"><code>Configure Security Group</code></strong> section, <span>we will just allow port <code class="literal">22</code> right now, and name the group <code class="literal">mesos1</code>. Review the instance details and click on <strong class="userinput"><code>Launch</code></strong>. We will use the existing key pair, which we already have, and under <strong class="userinput"><code>Select a key pair</code></strong> we will pick our <strong class="userinput"><code>mesos</code></strong> key pair and click on <strong class="userinput"><code>Launch Instances</code></strong>. Since the instances have started, we will now go to EC2, and under <strong class="userinput"><code>Reserved Instances</code></strong> you will find the three instances we created:</span></p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/71ce662a-b111-45a2-aaac-724a0dacff7a.png" /></div><p> </p><p>Once these instances are in the starting phase, we will name the newly-created instances <code class="literal">marathon2</code>, <code class="literal">mesos-master3</code>, and <code class="literal">mesos-slave3</code>:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/6d05bd03-668b-4763-9a39-aae80d1088ae.png" /></div><p>With this, <span>we now know</span> how we can <span>launch</span><a id="id325093110" class="indexterm"></a> the different instances on different subnets to achieve high availability. <span>We will install components o</span>f Mesos on the EC2 instance and <span>have used</span> CentOS AMI to build our EC2 instance by logging in with the centos user.</p></div></div>