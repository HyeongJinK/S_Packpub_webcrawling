<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec50"></a>Installing Marathon-LB</h2></div></div><hr /></div><p>In this example, we will perform a blue/green deployment technique using the <code class="literal">zdd.py</code> Python script and special Marathon-LB labels in your <span>application</span><a id="id325092057" class="indexterm"></a> definitions.</p><p>You need to first install Marathon-LB, using a Docker image, by executing the following command:</p><pre class="programlisting"><span class="strong"><strong>docker run -d -p 9090:9090</strong></span></pre><p>As you can see in the preceding command, <code class="literal">9090</code> is the port to which your HAProxy will bind–you access the HAProxy web page to find out the status of your load balancer. Then, next is <code class="literal">-p 8081:10001</code>. This is where your services will run. Here, we set it to <code class="literal">10000</code> and <code class="literal">8081</code>. So, we have exposed the <code class="literal">8081</code> port where your application will get accessed; and inside Docker, <code class="literal">10000</code> will be used. So, this is how your port mapping will happen. After that, we defined <code class="literal">--add-host</code>.</p><p>This variable needs to be defined if you don't have any DNS. If you have DNS in your environment, you can skip this; your environment will make use of a DNS to resolve the hostname. Here, the hostname and IP address are defined manually, in a way that is understood by Docker. After that, <code class="literal">-e</code> is <code class="literal">PORTS</code>, which we have already mapped with 9090, which will bind the HAProxy. Then we have the Docker image <code class="literal">marathon-lb</code>. We also have SSE mode defined, in which Marathon-LB will connect to the Marathon endpoints to inspect the change in state of the application, after which we defined the Marathon URL. Marathon-LB will now connect to this port and IP address to inspect the state of the application.</p><p>By executing the <code class="literal">--group external</code> command, we define a group here. So, when we deploy the application inside our Mesos cluster, we'll need to define one global parameter with the <code class="literal">external</code> command. As we saw earlier, we need to define one command tag that Marathon-LB will use for deploying the application via Marathon, and examine the application state to start reporting on the <span>application</span><a id="id325490206" class="indexterm"></a> inside the Marathon-LB web console. So, let's hit <span class="emphasis"><em>Enter</em></span>, and you will get a long UID.</p><p>You can run the following command line to check the application state:</p><pre class="programlisting"><span class="strong"><strong>sudo docker ps -a</strong></span></pre><p>Here, you can see the results of the preceding command that we just ran:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/8f5bc1b6-6f84-404d-b2ab-78240ec7d1da.png" /></div><p>You can also remove another one, if it isn't required, by executing the following command line:</p><pre class="programlisting"><span class="strong"><strong>sudo docker rm 18b782a385cb</strong></span></pre><p>This will give you the following results:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/71d92570-0747-4191-a92d-b72d48224608.png" /></div><p>You can now check if another one has been <span>removed</span><a id="id325493468" class="indexterm"></a> by again executing this command:</p><pre class="programlisting"><span class="strong"><strong>sudo docker ps -a</strong></span></pre><p>So, let's quickly browse to port <code class="literal">9090</code>. You can even check the logs by executing the following command:</p><pre class="programlisting"><span class="strong"><strong>sudo docker logs 8d41f336afb0</strong></span></pre><p>This is what you can see in the logs. You won't see any errors here, so let's quickly browse to the HAProxy page, which is <a class="ulink" href="http://marathon1:9090/haproxy?stats" target="_blank">http://marathon1:9090/haproxy?stats</a>. You won't get to see any <span>applications</span><a id="id325493650" class="indexterm"></a> listed here, as we have not deployed anything via Marathon in our Mesos cluster:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/53777254-c4ec-4c39-bb5c-2ef6fe4197f9.png" /></div><p> </p><p>So, let's quickly understand what we are doing here:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/c50fbaf0-79cb-470f-9136-660af772824c.png" /></div><p>As you can see in the <span>preceding</span><a id="id325489719" class="indexterm"></a> diagram, we have three <span class="strong"><strong>Mesos Master Servers</strong></span>, three <span class="strong"><strong>Mesos Slave Servers</strong></span>, and two <span class="strong"><strong>Marathon</strong></span> master servers. We are <span>going</span><a id="id325489740" class="indexterm"></a> to <span>install</span><a id="id325489749" class="indexterm"></a> a <span class="strong"><strong>Marathon-lb HAproxy</strong></span> server, and <span>will</span><a id="id325489760" class="indexterm"></a> have Elastic Load <span>Balancer</span><a id="id325489767" class="indexterm"></a> to serve the traffic.</p></div>