<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec52"></a>Deploying an Apache web server</h2></div></div><hr /></div><p>Now that we have explored the blue <span>deployment</span><a id="id325092054" class="indexterm"></a> technique, let's learn something about the green deployment via an example.</p><p>Let's go to our Marathon console, and then type the following command to get the total number of files present:</p><pre class="programlisting"><span class="strong"><strong>ls -rlt</strong></span></pre><p>Let's open the <code class="literal">nginx.json</code> file using the following commands:</p><pre class="programlisting"><span class="strong"><strong>$ sudo cp nginx.json apache.json
$ ls -rlt</strong></span></pre><p>Now, let's open the <code class="literal">apache.json</code> file <span>using</span><a id="id325092096" class="indexterm"></a> the following command line:</p><pre class="programlisting"><span class="strong"><strong>vi apache.json</strong></span></pre><p>In this file, we need to <span>change</span><a id="id325092832" class="indexterm"></a> the <code class="literal">image</code> to <code class="literal">httpd</code> to create <code class="literal">apache.json</code> with HTTP, and save it with <code class="literal">:wq!</code>. Then we execute the <code class="literal">cat Apache.json</code> command to read the file.</p><p>Next we will go ahead and deploy the JSON file to see the results. As you can see in the following screenshot, once you deploy this JSON file, it will slowly and gradually deploy the <code class="literal">httpd</code>, and will remov<span>e the existing nginx deployment:</span></p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/32a1ca8d-641f-4758-95a8-b61bedd971ca.png" /></div><p>Hit the <span class="emphasis"><em>Enter</em></span> key.</p><p>You will see it's a <code class="literal">green</code> deployment.</p><p>Now, let's go to our console. Go to the application, and you will see the <span>green</span><a id="id325490213" class="indexterm"></a> deployment in progress: </p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/5076e4ac-9e9e-47dc-8663-eb938921e7e7.png" /></div><p>You will also still see your <span>application</span><a id="id325490232" class="indexterm"></a> gets sent to the nginx server. Try to open your nginx page and open it on the marathon1 server, and you will see that your app is still responding:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/bb54c92a-b9cb-4be8-b726-f6a3e7171bf4.png" /></div><p><span>You can see that currently, it's running using one CPU, and will slowly and gradually deploy</span><code class="literal">web-green</code> to <code class="literal">0.4</code> and <code class="literal">web-blue</code> to <code class="literal">0.1</code>.</p><p>Here, the existing app is <span>running</span><a id="id325493481" class="indexterm"></a> four instances, while the new app is running only one instance. You will see the update's status progress, as well, stating that <code class="literal">There are 1 draining listeners, about to kill the following tasks</code>.</p><p>After scaling down the old app by one instance, and scaling up the new app by two instances, you will see the output, showing the old app <span>running</span><a id="id325493642" class="indexterm"></a> three instances, and the new app running two instances, in our console.</p><p>You will see the <code class="literal">web-green</code> app is running two instances. And it's running three instances on the <span>console</span><a id="id325493656" class="indexterm"></a>, which is going to reduce the blue app (existing) and incr<span>ease the green app (new). </span>This is how blue/green deployment works. Without any downtime, it will <span>automatically</span><a id="id325092770" class="indexterm"></a> rotate the app. As you will see, our green app has been moved to 4. And old is <span>reduced</span><a id="id325092778" class="indexterm"></a> to 2, which will <span>slowly vanish later.</span></p><p>Eventually, you will see a <span>message</span><a id="id325092793" class="indexterm"></a> displaying <code class="literal">About to delete old app /web-blue</code>. Now, on the console, you will see that only the <code class="literal">web-green</code> app is running. So, let's quickly browse the <code class="literal">web-green</code> page on our <span>incognito</span><a id="id325092811" class="indexterm"></a> browser, which is our load balancer URL, and we get <code class="literal">It works!</code>:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/748974a8-0e0c-4482-aee6-8a4884c08a25.png" /></div><p>As shown in the preceding screenshot, this is httpd landing page.</p><p>So, we have installed Apache httpd as a green deployment. So now, what if you want to redeploy to an alternative deployment, as we did from blue to green earlier? To do so, check that the current status of your application is the green deployment. If you run that script again with the nginx web server definition, it will show you the blue deployments.</p><p>Let's quickly see now how this is done. Type this command and hit the <span class="emphasis"><em>Enter</em></span> key:</p><pre class="programlisting"><span class="strong"><strong>$ ./marathon-lb/zdd.py -j nginx.json -m http://10.0.1.191:8080 -f -l http://10.0.1.191:9090 -socket /dev/null</strong></span></pre><p>You will get the output <span>shown</span><a id="id325093158" class="indexterm"></a> in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/70be4860-b819-4abd-9915-e6b424a58f1d.png" /></div><p>You will see that the green deployment is already detected, so it says <code class="literal">blue</code>.</p><p>So now, it will start the blue <span>instances</span><a id="id325093182" class="indexterm"></a> and drain the green instances, and you will see that the <code class="literal">web-blue</code> deployment is initiated. The one instance is upon <code class="literal">slave2</code>, which will drain the existing app that is green and <span>scale the blue app, as shown here</span>:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/1c495845-317c-43a1-8de0-66e0df681b92.png" /></div><p>So in this way, the user can see the application, which still <span>works</span><a id="id325092429" class="indexterm"></a> without any downtime because your current application is not yet migrated.</p><p>Now if you see your application, it still works. This is still in the <span>scaling</span><a id="id325092440" class="indexterm"></a> phase where it will drain the existing one, and then will make the new deployment go live.</p><p> </p><p> </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec35"></a>Zero-downtime deployment (ZDD)</h3></div></div></div><p>Now that you've seen how the blue/green deployment works, let's understand the traffic splitting between the blue and green versions of the app. So, ZDD has support to split the traffic between two versions of the same app (that is, the blue version and the green version) by having instances of both versions live at the same time. This is supported by the <code class="literal">HAPROXY_DEPLOYMENT_NEW_INSTANCES</code> label. When you run ZDD with the <code class="literal">--new-instances</code> flag, it creates only the specified number of instances of the new app, and deletes the same number of instances from the old app. For example, if your blue deployment is running with the full wrap and the <code class="literal">--new-instances</code> flag, it shows <code class="literal">2</code>. So, it will just delete the existing two apps and will run the new app with new instances.</p><p>So, for example, consider the same nginx app example, where there are 10 instances of nginx running image version 1. Now we can use ZDD to create two instances of version 2, and retain 8 instances of version 1, so that traffic is split in a 80:20 ratio. Creating two instances of the new version automatically deletes two instances of the existing version by adding the <code class="literal">--new-instances 2</code> flag. This state, where you have instances of both old and new versions of the same app live at the same time, is called a hybrid state. When a deployment group is in a hybrid state, it needs to be converted completely into either the current version or the previous version, before deploying any further versions. This could be done with the help of the <code class="literal">--complete-cur</code> and <code class="literal">--complete-prev</code> flags in ZDD. So, let's quickly perform this demo to understand how the traffic splitting happens between the blue and green apps, and how you can convert the hybrid state completely to the current or previous version of the app. So now, you can see our <code class="literal">web-blue</code> app is completely installed. Let's split the traffic between the blue and green apps. We will install the Apache server and <span>change</span><a id="id325092491" class="indexterm"></a> the IP address to <code class="literal">10.0.1.191</code>. We need to run this <code class="literal">--new-instances 2</code>:</p><pre class="programlisting"><span class="strong"><strong>$ ./marathon-lb/zdd.py -j apache.json -m http://10.0.1.191:8080 -f -l http://10.0.1.191:9090 -syslog-socket /dev/null --new-instances 2</strong></span></pre><p>So here, our traffic will be split between four instances, of which two instances will be <code class="literal">blue</code>, and two instances will be <code class="literal">green</code>. Hit the <span class="emphasis"><em>Enter</em></span> key:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/2f46d153-9fe6-4c02-824f-e33d42bba2f1.png" /></div><p>Here, you will see the <code class="literal">HAPROXY_DEPLOYMENT_NEW_INSTANCES</code> flag is enabled with <code class="literal">2</code>; and your deployment color is <code class="literal">green</code>.</p><p>Here our green app has been deployed-currently, there is only one instance. So let's wait until it scales to put the app up to two instances, and then try accessing the website.</p><p>You will see the nginx page, because we have again deployed green to blue. So once the current installation is completed, we will see our request flows <span>between</span><a id="id325092549" class="indexterm"></a> Apache and nginx.</p><p>Here, you will see your traffic is split between the green and blue apps, so keep on refreshing and watch how it works.</p><p>So for now, you can either roll back to your existing app, or you can complete your current app deployment, using the flags that we saw earlier. Those flags are <code class="literal">--complete-cur</code> and <code class="literal">--complete-prev</code>. If you want to complete with the current deployment, you need to run the command again with the <code class="literal">--complete-cur</code> flag to delete the existing old app. This will create two more instances. If you want to deploy the application or roll back to the previous application, or if you don't want to go with the current deployment, you just have to use the <code class="literal">--complete-prev</code> command.</p><p>You have two instances of the blue app and two instances of the green app. You have to decide whether you need to roll back or continue with your current deployment. You can validate your URL, which is your load <span>balancer</span><a id="id325092579" class="indexterm"></a> URL, to see if your traffic is splitting or not.</p><p>Sometimes it goes to nginx, and you will be able see your HAProxy reloading, as per the status change from your application:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/f4e70dd7-844c-4174-872e-a218966c6e8c.png" /></div><p>So here, we're executing the <code class="literal">--complete-cur</code> command. Our <span>current</span><a id="id325092604" class="indexterm"></a> deployment was our Apache deployment, which was green.</p><p>Let's hit the <span class="emphasis"><em>Enter</em></span> key. It will display <code class="literal">Considering blue color as existing app and green color as new app</code>, giving you some information: <code class="literal">Existing app running 2 instances, new app running 2 instances</code>.</p><p>This will convert your app from split to only a single one, which is your green environment. Then it displays <code class="literal">Scaling new app up to 4 instances</code>.</p><p>Let's go to our Marathon console, and you will see that our <code class="literal">web-green</code> app has been scaled to four, as per our definition of <code class="literal">--complete-cur</code>. This is going to be trained now.</p><p>Let's check your <span>statistics</span><a id="id325092642" class="indexterm"></a> on HAProxy, as follows:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/cbb26055-0e9c-4c2c-bfb6-919e31c749a1.png" /></div><p>As you can see, these two are <span>going</span><a id="id325092663" class="indexterm"></a> to drain now, displaying <code class="literal">About to delete old app /web-blue</code>.</p><p>So let's quickly go to our console, and validate. You can see our green app is now with four instances and our blue app is deleted now.</p><p>So, that's how you can use multiple <span>development</span><a id="id325092679" class="indexterm"></a> environments as per your requirements. Next, we will learn how to deploy Cassandra on Apache Mesos. Before we start, we first need to understand what Cassandra is.</p></div></div>