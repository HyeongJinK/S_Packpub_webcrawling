<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec51"></a>Implementing the blue/green deployment with Marathon-LB</h2></div></div><hr /></div><p>Let's go ahead and start deploying the <span>application</span><a id="id325092839" class="indexterm"></a> to <span>understand</span><a id="id325092848" class="indexterm"></a> how blue/green deployment works, by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>We will create a new version of the web application that uses the nginx web server, as well as creating a definition file to deploy the nginx web server on our Mesos cluster using Marathon.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>We should focus on the following two new labels used for managing the blue/green deployment technique:
<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">HAPROXY_DEPLOYMENT_GROUP</code>: This label uniquely identifies a pair of apps belonging to a blue/green deployment, and will be used as the app name in the HAProxy configuration.</li><li style="list-style-type: disc"><code class="literal">HAPROXY_DEPLOYMENT_ALT_PORT</code>: An alternate service port is required because Marathon requires service ports to be unique across all apps.</li></ul></div></li><li>Then, we will install Python version 3, as required by <code class="literal">zdd.py</code>, Git, and our other dependencies.</li><li>Then, we will clone the Marathon-LB repository to get the <code class="literal">zdd.py</code> script.</li><li>Use the <code class="literal">zdd.py</code> script for deploying the application.</li><li>Validate the deployed services on Marathon and browse to the HAProxy page on the browser to see the nginx web server page.</li><li>After that, we will create a new version of our web application that uses the Apache web server instead of nginx.</li><li>Use the ZDD web-UI script to perform a zero-downtime deployment with a new version of the application.</li><li>So, without any downtime, we will replace the nginx web server with the Apache web server. We will see how this can be handled using Marathon-LB zero-downtime deployment.</li><li>Then we will return to the console and validate the progress, and reload the browser page. While browsing the page, we will discover how easily we deployed the Apache web server without any downtime.</li></ol></div><p>So, let's quickly go for a demo by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Create a definition file for our nginx web server by executing the following command line:</li></ol></div><pre class="programlisting"><span class="strong"><strong>sudo vi nginx.json</strong></span></pre><p> </p><p> </p><p>The preceding command line will <span>generate</span><a id="id325485780" class="indexterm"></a> the <span>following</span><a id="id325485788" class="indexterm"></a> output:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/6de5b148-f31f-435e-a032-ada2b67ece08.png" /></div><p>As you can see in the preceding screenshot, this is the definition file we have created. Here, you will see the container port is <code class="literal">80</code>, and the service port is <code class="literal">10000</code>, which was defined earlier while creating our Marathon-LB container. We have defined our instances as 4, our CPUs at 0.1, and memory at 65. Spot the <code class="literal">healthChecks</code> parameter we have added here, and, most importantly, the labels. We have already defined <code class="literal">HAPROXY_DEPLOYMENT_GROUP</code> as <code class="literal">web</code>. Then, our <code class="literal">HAPROXY_DEPLOYMENT_ALT_PORT</code> is <code class="literal">10001</code>. So, for blue/green deployment, it will use the <code class="literal">10001</code> port. As you have seen, we have defined <code class="literal">HAPROXY_GROUP</code>, which is external, while creating our Marathon-LB container. Let's quickly save this. With this, we are done with our first step of creating the nginx definition.</p><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Our next step is to install Python. Hit the command line to check your Python version, we <span>already</span><a id="id325485918" class="indexterm"></a> have 2.7.5 Python installed.</li><li>Exit using the <code class="literal">exit</code> command, or by pressing <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>D</em></span>.</li><li>Now, install the supported tools by executing the following command line:</li></ol></div><pre class="programlisting"><span class="strong"><strong>sudo yum installgit gcc openssl-devel and libcurl-devel</strong></span></pre><p>So, these are the supported tools required. Now, clear the screen.</p><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Enter the following command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>export PYCURL_SSL_LIBRARY=nss</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Now add some add-on <span>packages</span><a id="id325489693" class="indexterm"></a> using the <span>following</span><a id="id325490078" class="indexterm"></a> command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>sudo yum install epel-release</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>Use the following command to install <code class="literal">pip</code>:</li></ol></div><pre class="programlisting"><span class="strong"><strong>sudo yum install python-pip</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>Let's upgrade <code class="literal">pip</code> by <span>executing</span><a id="id325490124" class="indexterm"></a> the <span>following</span><a id="id325490198" class="indexterm"></a> command line:</li></ol></div><pre class="programlisting"><span class="strong"><strong>sudo pip install -upgrade pip</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Install some of the required dependencies by using the following command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>sudo pip install requests six jwt</strong></span></pre><p> </p><p> </p><p>The preceding command line will install the required dependencies, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/dd831dfb-fd51-4164-8141-0fe03a1c6faa.png" /></div><p>As you can see in the preceding screenshot, the required dependencies were installed with some errors, which can be ignored. Clear <span>the</span><a id="id325092224" class="indexterm"></a> screen.</p><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>Now, enter the <span>following</span><a id="id325092240" class="indexterm"></a> command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>sudo pip install pycurl -global-option="-with-nss"</strong></span></pre><p>These are the dependencies required to run our <code class="literal">zdd.py</code> script.</p><div class="orderedlist"><ol class="orderedlist arabic" start="11" type="1"><li>Let's clone the Marathon-LB repository using the <code class="literal">git clone</code>, by executing the following command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>git clone https://github.com/mesosphere/marathon-lb.git</strong></span></pre><p>We already have <code class="literal">marathon-lb</code> installed.</p><div class="orderedlist"><ol class="orderedlist arabic" start="12" type="1"><li>Run the <code class="literal">ls -rlt</code> command, which will fetch the Marathon app from the <code class="literal">marathon-lb</code> folder. You will see the <code class="literal">marathon-lb</code> folder as your present directory.</li><li>Let's install the <code class="literal">python-jwt</code> module, which is <span>again</span><a id="id325092342" class="indexterm"></a> required to <span>run</span><a id="id325092350" class="indexterm"></a> your Python script:</li></ol></div><pre class="programlisting"><span class="strong"><strong>sudo yum install  python-jwt</strong></span></pre><p>We already have this module, but you have to make sure you install it.</p><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="14" type="1"><li>After installing dependency tools, let's run your zero-deployment script. This is the script that we will run: </li></ol></div><pre class="programlisting"><span class="strong"><strong>zdd.pynginx.json</strong></span></pre><p>We have already created this file. It has all the definitions required to run the nginx web server.</p><p>Here, we have your master IP, and this is our Marathon-LB IP with port <code class="literal">9090</code>, which you have seen while running the LB container earlier. Let's hit <span class="emphasis"><em>Enter</em></span> to quickly troubleshoot this. So here, we have got data that shows <code class="literal">Connection refused</code>. This is because we have defined the incorrect IP address, which is <code class="literal">10.0.1.42</code>, hence, we need to define the correct Marathon IP as we have <span>defined</span><a id="id325092406" class="indexterm"></a> Marathon-LB here. In our case, our IP address will be the same, but if you are using a <span>different</span><a id="id325092414" class="indexterm"></a> server, your IP will get changed. So, let's quickly clear this screen, and start this process from top:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Correct the IP address in the following command line, and hit the <span class="emphasis"><em>Enter</em></span> key:</li></ol></div><pre class="programlisting"><span class="strong"><strong>./marathon-lbzdd.py -j nginx.json -m http://10.0.1.191:8080 -f -l http://10.0.1.191:9090 --syslog-socker /dev/null</strong></span></pre><p>The preceding command line will generate the following output:</p><div class="mediaobject"><img src="/graphics/9781789137385/graphics/83aa7eca-0972-4d18-8a22-0afa8a36b298.png" /></div><p>In the preceding screenshot, the important part is the labels that we have here. The HAProxy port reads the web, and the deployment color is blue, so currently, we are in blue deployment.</p><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Let's quickly go to your Marathon console, where you can see your <strong class="userinput"><code>web-blue</code></strong> application got deployed on the <code class="literal">mesos-slave1</code> server:</li></ol></div><div class="mediaobject"><img src="/graphics/9781789137385/graphics/188f2fc2-1fae-49e6-bda9-c234277ab49a.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>This is the <code class="literal">mesos-slave1</code> server. Now, you can <span>refresh</span><a id="id325093105" class="indexterm"></a> this, and you will see <span>your</span><a id="id325093113" class="indexterm"></a> web is running on port <code class="literal">10000</code>:</li></ol></div><div class="mediaobject"><img src="/graphics/9781789137385/graphics/eaa9fc7f-e51e-4f7c-92aa-0c5b98661bea.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>When you browse your application, you will see we have deployed the blue ID, which is <strong class="userinput"><code>web-blu</code></strong><strong class="userinput"><code>e</code></strong>:</li></ol></div><div class="mediaobject"><img src="/graphics/9781789137385/graphics/c161987a-9e1b-40a9-911d-18a99d607512.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Access this <span>application</span><a id="id325093160" class="indexterm"></a> via our Elastic Load Balancer on AWS, and validate the Elastic Load Balancer, which you can see is already set up <span>and</span><a id="id325093170" class="indexterm"></a> named <code class="literal">wordpress-lb</code>.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Now click on the <strong class="userinput"><code>Target Groups</code></strong> tab on the left, and you can see we have created the target groups here with the name <code class="literal">wordpress-lb</code>, which is our <code class="literal">marathon1</code> server on port <code class="literal">8081</code>:</li></ol></div><div class="mediaobject"><img src="/graphics/9781789137385/graphics/a7347dd9-8296-4200-9c7b-38202f408c77.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>Now, click on <strong class="userinput"><code>Load Balancers</code></strong> to <span>see</span><a id="id325245115" class="indexterm"></a> the <span>description</span><a id="id325245124" class="indexterm"></a> on the left.</li><li>Copy the <strong class="userinput"><code>DNS</code></strong> name from the <strong class="userinput"><code>Description</code></strong> tab and paste it into your browser. You will see the <strong class="userinput"><code>Welcome to nginx!</code></strong> landing page, which means we have successfully installed the nginx app on our Mesos cluster:</li></ol></div></div>