<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec54"></a>Normal Transformations</h2></div></div><hr /></div><p>Whenever vertices are transformed, <span class="strong"><strong>normal vectors</strong></span> should <span>also</span><a id="id325358912" class="indexterm"></a> be transformed so that they point in the right direction. We could consider using the Model-View matrix that transforms vertices to do this, but this approach is problematic: the Model-View matrix will not always keep the perpendicularity of normals, as illustrated by the following diagram:</p><div class="mediaobject"><img src="/graphics/9781788629690/graphics/d55fe831-764c-4c75-a28e-1aebaf733972.png" /></div><p>This problem occurs if there is a unidirectional (one axis) scaling transformation or a shearing transformation in the Model-View matrix. In our example, we have a triangle that has undergone a scaling transformation on the y-axis. As you can see, the <code class="literal">N'</code> normal is no longer perpendicular after this kind of transformation. How do we solve this?</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec67"></a>Calculating the Normal Matrix</h3></div></div></div><p>If you are not interested in <span>finding</span><a id="id325358953" class="indexterm"></a> out how we calculate the Normal matrix and just want the answer, feel free to jump to the end of this section. Otherwise, stick around to see some linear algebra in action!</p><p>Let's start with the mathematical definition of perpendicularity. Two vectors are perpendicular if their dot product is <code class="literal">0</code>. In our example, this will be:</p><pre class="programlisting"><div class="mediaobject"><img src="/graphics/9781788629690/graphics/cd6ba312-2ffd-42b8-8d6a-2cdfe8572477.png" /></div></pre><p>Here, <span class="emphasis"><em><code class="literal">S</code></em></span> is the surface vector and can be calculated as the difference of two vertices, as shown in the diagram at the beginning of this section.</p><p>Let <span class="emphasis"><em><code class="literal">M</code></em></span> be the Model-View matrix. We can use <span class="emphasis"><em><code class="literal">M</code></em></span> to transform <code class="literal"><span class="emphasis"><em>S</em></span></code> as follows:</p><pre class="programlisting"><div class="mediaobject"><img src="/graphics/9781788629690/graphics/e133e656-d294-4171-8b69-ee9f2d39093f.png" /></div></pre><p>This is because <code class="literal"><span class="emphasis"><em>S</em></span></code> is the difference of two vertices. We use <code class="literal"><span class="emphasis"><em>M</em></span></code> to transform vertices onto the viewing space.</p><p>We want to find a matrix, <code class="literal"><span class="emphasis"><em>K</em></span></code>, that allows us to transform normals in a similar way. For the <code class="literal"><span class="emphasis"><em>N</em></span></code> normal, we want the following:</p><pre class="programlisting"><div class="mediaobject"><img src="/graphics/9781788629690/graphics/5f71760a-d303-4afc-bb87-3d20a8c3ec64.png" /></div></pre><p>For the scene to be consistent after obtaining <code class="literal"><span class="emphasis"><em>N'</em></span></code> and <code class="literal"><span class="emphasis"><em>S'</em></span></code>, these two need to keep the perpendicularity that the original vectors <code class="literal"><span class="emphasis"><em>N</em></span></code> and <code class="literal"><span class="emphasis"><em>S</em></span></code> had. This is as follows:</p><pre class="programlisting"><div class="mediaobject"><img src="/graphics/9781788629690/graphics/011d0ca0-1cdd-4c13-9391-81496c260dbf.png" /></div></pre><p>Substituting <code class="literal"><span class="emphasis"><em>N'</em></span></code> and <code class="literal"><span class="emphasis"><em>S'</em></span></code>:</p><pre class="programlisting"><div class="mediaobject"><img src="/graphics/9781788629690/graphics/659c7bed-5703-4cfa-bfed-4e03728691db.png" /></div></pre><p>A dot product can also be written as a vector multiplication by transposing the first vector so that this still holds:</p><pre class="programlisting"><div class="mediaobject"><img src="/graphics/9781788629690/graphics/88781ecb-5809-4cf3-a716-0cc96f62453e.png" /></div></pre><p>The transpose of a product is the product of the transposes in the reverse order:</p><pre class="programlisting"><div class="mediaobject"><img src="/graphics/9781788629690/graphics/99c43670-d634-4b40-883c-5310a01878af.png" /></div></pre><p>Grouping the inner terms:</p><pre class="programlisting"><div class="mediaobject"><img src="/graphics/9781788629690/graphics/bc003de8-fd57-445c-851c-b5f55fd03f76.png" /></div></pre><p>Now, remember that <code class="literal"><div class="mediaobject"><img src="/graphics/9781788629690/graphics/42330d94-98ad-4079-8bdc-36a606c404bd.png" /></div></code> so <code class="literal"><div class="mediaobject"><img src="/graphics/9781788629690/graphics/14b36785-6f32-4009-b57b-b9db56047c81.png" /></div></code> (again, a dot product can be written as a vector multiplication). This means that in the previous equation, (<code class="literal"><div class="mediaobject"><img src="/graphics/9781788629690/graphics/11bc9811-5104-491a-aa1e-7bba2c55b3ef.png" /></div></code>) needs to be the Identity matrix, <code class="literal"><span class="emphasis"><em>I</em></span></code>, so the original condition of <code class="literal"><span class="emphasis"><em>N</em></span></code> and <code class="literal"><span class="emphasis"><em>S</em></span></code> being perpendicular holds:</p><pre class="programlisting"><div class="mediaobject"><img src="/graphics/9781788629690/graphics/97af638d-3c75-4c23-85a3-9aff6eed3f1d.png" /></div></pre><p>Applying a bit of algebra:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col /><col /></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal"><div class="mediaobject"><img src="/graphics/9781788629690/graphics/fc8406eb-0d1f-4002-82d0-12678fd7a3b5.png" /></div></code></p></td><td style="border-bottom: 0.5pt solid ; "><p>Multiply by the inverse of <code class="literal"><span class="emphasis"><em>M</em></span></code> on both sides.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal"><div class="mediaobject"><img src="/graphics/9781788629690/graphics/59f0ff9f-4f5a-4225-bd2c-5712c2852a50.png" /></div></code></p></td><td style="border-bottom: 0.5pt solid ; "><p>Because <code class="literal"><div class="mediaobject"><img src="/graphics/9781788629690/graphics/54fb7f18-f0ce-4d4a-9eba-a7c12eb1bffd.png" /></div></code><span class="emphasis"><em>.</em></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal"><div class="mediaobject"><img src="/graphics/9781788629690/graphics/be478141-589b-4abe-9ffb-1b637ecbba12.png" /></div></code></p></td><td style="border-bottom: 0.5pt solid ; "><p>Transposing on both sides.</p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p><code class="literal"><div class="mediaobject"><img src="/graphics/9781788629690/graphics/9e86aa31-4672-48b2-a182-ed3f4c183af6.png" /></div></code></p></td><td style=""><p>Double transpose of <code class="literal"><span class="emphasis"><em>K</em></span></code> is the original matrix <code class="literal"><span class="emphasis"><em>K</em></span></code>.</p></td></tr></tbody></table></div><p> </p><p>Conclusions:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="emphasis"><em><code class="literal">K</code> </em></span>is the correct matrix transform that keeps the normal vectors perpendicular to the surface of the object. We call <code class="literal"><span class="emphasis"><em>K</em></span></code> the <span class="strong"><strong>Normal matrix</strong></span>.</li><li style="list-style-type: disc"><span class="emphasis"><em><code class="literal">K</code> </em></span>is obtained by transposing the inverse of the Model-View matrix (<code class="literal"><span class="emphasis"><em>M</em></span></code>, in this example).
</li><li style="list-style-type: disc">We need to use <span class="emphasis"><em><code class="literal">K</code> </em></span>to multiply the <span>normal</span><a id="id325647197" class="indexterm"></a> vectors so that they keep being perpendicular to the surface when transformed.</li></ul></div></div></div>