<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec33"></a>Time for Action: Encoding and Decoding JSON</h2></div></div><hr /></div><p>Most modern web <span>browsers</span><a id="id325359415" class="indexterm"></a> support native JSON encoding <span>and</span><a id="id325359424" class="indexterm"></a> decoding. Let's examine the methods available inside this object:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col /><col /></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Method</strong></span></p></td><td style="border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Description</strong></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">JSON.stringify(object)</code></p></td><td style="border-bottom: 0.5pt solid ; "><p>We use <code class="literal">JSON.stringify</code> to convert JavaScript objects to JSON-formatted text.</p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p><code class="literal">JSON.parse(string)</code></p></td><td style=""><p>We use <code class="literal">JSON.parse</code> to convert text into JavaScript objects.</p></td></tr></tbody></table></div><p> </p><p>Let's learn how to encode and decode with the JSON notation by creating a simple model—a 3D line. Here, we will be focusing on how we do JSON encoding and decoding. Follow the given steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In your browser, open the interactive JavaScript console. Use the following table for assistance:</li></ol></div><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col /><col /></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Browser</strong></span></p></td><td style="border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Shortcut keys (PC/Mac)</strong></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Firefox</p></td><td style="border-bottom: 0.5pt solid ; "><p><span class="emphasis"><em>Ctrl </em></span>+ <span class="emphasis"><em>Shift </em></span>+<span class="emphasis"><em> K</em></span>/<span class="emphasis"><em>Command </em></span>+<span class="emphasis"><em> Alt </em></span>+<span class="emphasis"><em> K</em></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Safari</p></td><td style="border-bottom: 0.5pt solid ; "><p><span class="emphasis"><em>Ctrl </em></span>+<span class="emphasis"><em> Shift </em></span>+<span class="emphasis"><em> C</em></span>/<span class="emphasis"><em>Command </em></span>+<span class="emphasis"><em> Alt </em></span>+<span class="emphasis"><em> C</em></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p>Chrome</p></td><td style=""><p><span class="emphasis"><em>Ctrl </em></span>+<span class="emphasis"><em> Shift </em></span>+<span class="emphasis"><em> J</em></span>/<span class="emphasis"><em>Command </em></span>+<span class="emphasis"><em> Alt</em></span> +<span class="emphasis"><em> J</em></span></p></td></tr></tbody></table></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Create a JSON object by typing the following:</li></ol></div><pre class="programlisting">const model = { vertices: [0, 0, 0, 1, 1, 1], indices: [0, 1] };</pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Verify that the model is an object by writing the following:</li></ol></div><pre class="programlisting">typeof(model); // outputs "object"</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip29"></a>Note</h3><p><strong class="userinput"><code>JavaScript Type-Checking</code></strong>
Since many things in JavaScript are <span class="emphasis"><em>objects</em></span>, it is recommended that you are more rigorous with type-checking. We will just use <code class="literal">typeof</code><span class="strong"><strong> </strong></span>for demonstration purposes. Additionally, there are many utility libraries, such as Lodash (<a class="ulink" href="https://lodash.com/" target="_blank">https://lodash.com</a>), that extend JavaScript features to provide these operations and more.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Let's print the model attributes. Write <span>this</span><a id="id325358921" class="indexterm"></a> in the console (press <span class="emphasis"><em>Enter</em></span> at the end of each line):</li></ol></div><pre class="programlisting">model.vertices // outputs the vertices
model.indices // outputs the indices</pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Let's create a JSON text:</li></ol></div><pre class="programlisting">const text = JSON.stringify(model);
alert(text);</pre><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>What happens when you type <code class="literal">text.vertices</code>?</li><li>As you can see, you get a message saying that <code class="literal">text.vertices</code> is <code class="literal">undefined</code>. This happens because text is not a JavaScript object, but a <code class="literal">string</code> with the peculiarity of being written according to JSON notation to describe an <code class="literal">object</code>. Everything in it is text, and so it does not have any fields.</li><li>Let's convert the JSON text back into an object. Type the following:</li></ol></div><pre class="programlisting">const model2 = JSON.parse(text);
typeof(model2); // outputs "object"
model2.vertices; // outputs vertices</pre><p><span class="emphasis"><em><span class="strong"><strong>What just happened?</strong></span></em></span></p><p>We have learned to encode and decode JSON objects. These exercises are relevant because we will use the same process to define our <span>geometry</span><a id="id325358996" class="indexterm"></a> to be loaded from external files. In the next section, we will see how to download geometric models specified with JSON from a web server.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec34"></a>Asynchronous Loading with AJAX</h3></div></div></div><p>The <span>following</span><a id="id325359011" class="indexterm"></a> diagram summarizes <span>the</span><a id="id325359019" class="indexterm"></a> asynchronous loading of files by <span>the</span><a id="id325359028" class="indexterm"></a> web browser using AJAX:</p><div class="mediaobject"><img src="/graphics/9781788629690/graphics/737921a5-ac64-4135-92e1-61e27cd7b644.png" /></div><p>Let's analyze this more closely:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Request File</strong></span>: Indicates the path to the file you want to load. Remember that this file contains the geometry that we will be loading from the web server instead of coding the JavaScript arrays (vertices and indices) directly into the web page.</li><li style="list-style-type: disc"><span class="strong"><strong>AJAX Request</strong></span>: We need to write a function that will perform the AJAX request. Let's call this function <code class="literal">load</code>. The code looks like this:</li></ul></div><pre class="programlisting">// Given a path to a file, load the assets asynchronously
function load(filePath) {
// We return the promise so that, if needed, you can know when 
  // `load` has resolved
return fetch(filePath)
// Convert to a valid json
.then(res =&gt; res.json())
// Handle the parsed JSON data
.then(data =&gt; {
// Handle data
})
  .catch(error =&gt; {
// Handle error
});
}</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note30"></a>Note</h3><p><strong class="userinput"><code>AJAX Reques</code></strong><strong class="userinput"><code><strong class="userinput"><code>ts w</code></strong>ith Fetch</code></strong><span class="strong"><strong></strong></span> We are leveraging <code class="literal">fetch</code>, an AJAX API provided in modern browsers, for fetching resources. It is very convenient with a <span class="strong"><strong>Promise</strong></span>-based implementation. To learn more about <code class="literal">fetch</code>, visit <a class="ulink" href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API" target="_blank">https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API</a>.</p></div><p>For now, let's say that this function <span>will</span><a id="id325359140" class="indexterm"></a> perform <span>the</span><a id="id325359148" class="indexterm"></a> AJAX request.</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Retrieving the file</strong></span>: The web server <span>will</span><a id="id325359165" class="indexterm"></a> receive and treat our request as a regular HTTP request. In fact, the server does not know that <span>this</span><a id="id325359174" class="indexterm"></a> request is <span class="emphasis"><em>asynchronous </em></span>(it is asynchronous for the web browser since it does not wait for the answer). The server will look for our file and generate a response, regardless of whether it finds the request.</li><li style="list-style-type: disc"><span class="strong"><strong>Asynchronous response</strong></span>: Once a response is sent to the web browser, the <code class="literal">fetch</code> promise is resolved and the provided callback is invoked. This callback corresponds to the <code class="literal">then</code> request method. If the request is successful, we invoke the <code class="literal">then</code> callback; if it fails, we invoke the <code class="literal">catch</code> callback.</li><li style="list-style-type: disc"><span class="strong"><strong>Handling the loaded model</strong></span>: After our data is received and parsed, we attach a new callback to process the file retrieved from the server. Please notice that in the previous segment of code, we used the promise-based JSON parser to create a JavaScript object from the file before passing it to the next function. The code for the <code class="literal">load</code> function looks like this:</li></ul></div><pre class="programlisting">// Given a path to a file, load the assets asynchronously
function load(filePath) {
// We return the promise so that, if needed, you can know when
  // `load` has resolved
return fetch(filePath)
// Convert to a valid json
.then(res =&gt; res.json())
// Handle the parsed JSON data
.then(data =&gt; {
    model = data;

// Create VAO
vao = gl.createVertexArray();

// Bind VAO
gl.bindVertexArray(coneVAO);

const modelVertexBuffer = gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER, modelVertexBuffer);
gl.bufferData(gl.ARRAY_BUFFER, new 
     Float32Array(model.vertices), gl.STATIC_DRAW);

// Configure instructions
gl.enableVertexAttribArray(program.aVertexPosition);
gl.vertexAttribPointer(program.aVertexPosition, 3, gl.FLOAT, 
     false, 0, 0);

modelIndexBuffer = gl.createBuffer();
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, modelIndexBuffer);
gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new 
     Uint16Array(model.indices), gl.STATIC_DRAW);

// Clean
gl.bindVertexArray(null);
gl.bindBuffer(gl.ARRAY_BUFFER, null);
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, null);
})
// Display into the console if there are any errors
.catch(console.error);
}</pre><p>If you look closely, you’ll realize that this function is very similar to one of the functions we saw previously: the <code class="literal">initBuffers</code> function. This is reasonable, given that we cannot initialize the buffers until we retrieve the geometry data from the server. Just like <code class="literal">initBuffers</code>, we configure our VAO, VBO, and IBO and pass them the information contained in the JavaScript arrays of our model object.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl3sec10"></a>Setting up a Web Server</h4></div></div></div><p>Now that we're fetching <span>assets</span><a id="id325359271" class="indexterm"></a> from a server, we need to serve our application by using a server. If you do <span class="emphasis"><em>not</em></span> have a web server, we recommend that you <span>install</span><a id="id325359283" class="indexterm"></a> a lightweight web <span>server</span><a id="id325359291" class="indexterm"></a> from the following options:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Serve: </strong></span><a class="ulink" href="https://github.com/zeit/serve" target="_blank">https://github.com/zeit/serve</a></li><li style="list-style-type: disc"><span class="strong"><strong>Lighttpd: </strong></span><a class="ulink" href="http://www.lighttpd.net/" target="_blank">http://www.lighttpd.net</a></li><li style="list-style-type: disc"><span class="strong"><strong>Python Server: </strong></span><a class="ulink" href="https://developer.mozilla.org/en-US/docs/Learn/Common_questions/set_up_a_local_testing_server" target="_blank">https://developer.mozilla.org/en-US/docs/Learn/Common_questions/set_up_a_local_testing_server</a></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip31"></a>Note</h3><p><strong class="userinput"><code>Hosting Examples</code></strong><span class="strong"><strong></strong></span> Although any web server will be able to serve these examples, <code class="literal">serve</code> provides simplicity and great functionality. That being said, be sure to run your server from the root of the examples directory, since the <code class="literal">common</code> directory is a shared dependency across chapters.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl3sec11"></a>Working Around the Web Server Requirement</h4></div></div></div><p>If you have Firefox and <span>do</span><a id="id325628695" class="indexterm"></a> not want to install a web server, you can change <code class="literal">strict_origin_policy</code> to false in <code class="literal">about:config</code>.</p><p>If you are using Chrome and do not want to install a web server, make sure that you run it from the command line with the following modifier:</p><pre class="programlisting"><span class="strong"><strong>--allow-file-access-from-files</strong></span></pre><p>Let's use AJAX and JSON to load a cone from our web server.</p></div></div></div>