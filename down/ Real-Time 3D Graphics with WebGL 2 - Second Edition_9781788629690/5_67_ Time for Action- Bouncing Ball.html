<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec74"></a>Time for Action: Bouncing Ball</h2></div></div><hr /></div><p>Let's look at an <span>example</span><a id="id325357458" class="indexterm"></a> covering how we'd animate many objects in our scene:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Open <code class="literal">ch05_03_bouncing-balls.html</code> in your browser:</li></ol></div><div class="mediaobject"><img src="/graphics/9781788629690/graphics/6e44dbee-df13-40b6-a83e-9f3a085b9c9d.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>The orbiting camera is activated by default. Move the camera and you will see how all the objects adjust to the global transform (camera) and continue bouncing according to their local transforms.</li><li>Let's explain how we keep track of each ball in more detail.</li><li>Define the appropriate global variables and constants:</li></ol></div><pre class="programlisting">let
gl, scene, program, camera, transforms,
elapsedTime, initialTime,
fixedLight = false,
balls = [],
sceneTime = 0,
animationRate = 15,
gravity = 9.8,
ballsCount = 50;</pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Initialize the <code class="literal">balls</code> array. We use a <code class="literal">for</code> loop in the <code class="literal">load</code> function to achieve this:</li></ol></div><pre class="programlisting">function load() {
  scene.add(new Floor(80, 2));
for (let i = 0; i &lt; ballsCount; i++) {
    balls.push(new BouncingBall());
scene.load('/common/models/geometries/ball.json', `ball${i}`);
}
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>The <code class="literal">BouncingBall</code> class initializes the simulation variables for each ball in the <code class="literal">balls</code> array. One of these attributes is the position, which we select randomly. You can see how we do this by using the <code class="literal">generatePosition</code> function:</li></ol></div><pre class="programlisting">function generatePosition() {
return [
    Math.floor(Math.random() * 50) - Math.floor(Math.random() * 
     50),
Math.floor(Math.random() * 30) + 50,
Math.floor(Math.random() * 50)
  ];
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>After adding a new ball to the <code class="literal">balls</code> array, we add a new ball object (geometry) to the <code class="literal">scene</code> instance. Please note that the alias we create includes the current index of the ball object in the <code class="literal">balls</code> array. For example, if we add the 32nd ball to the array, the alias that the <span>corresponding</span><a id="id325643482" class="indexterm"></a> geometry will have in <code class="literal">scene</code> will be <code class="literal">ball32</code>.</li><li>The only other object that we add to the scene here is <code class="literal">Floor</code>. We have used this object in previous exercises. You can find the code for the <code class="literal">Floor</code> class in <code class="literal">common/js/Floor.js</code>.</li><li>Let's talk about the <code class="literal">draw</code> function. Here, we go through the elements of <code class="literal">scene</code> and retrieve each object's alias. If the alias contains the word <code class="literal">ball</code>, we know that the alias corresponds to its <code class="literal">index</code> in the ball array. We could have probably used an associative array here to make it look nicer, but doing so does not really change our goal. The main point here is to make sure that we can associate the simulation variables for each ball with the corresponding object (geometry) in <code class="literal">scene</code>.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>Notice that for each object (ball geometry) in <code class="literal">scene</code>, we extract the current position and the color from the respective <code class="literal">BouncingBall</code> instance in the <code class="literal">balls</code> array.</li><li>Alter the current Model-View matrix for each ball by using a matrix stack to handle local transformations, as described previously. In our case, we want the animation for each ball to be independent from the transformations of the camera and one another.</li><li>So far, we’ve described how the bouncing balls are created (<code class="literal">load</code>) and how they are rendered (<code class="literal">draw</code>). None of these functions modifies the current position of the balls. We do that by using <code class="literal">BouncingBall.update</code>. This code uses the animation time (the <code class="literal">sceneTime</code> global variable) to calculate the position for the bouncing ball. Since each <code class="literal">BouncingBall</code> has its own simulation parameters, we can calculate the position for each given position when <code class="literal">sceneTime</code> is provided . In short, the ball position is a function of time and, as such, it falls into the category of motion described by parametric curves.</li><li>The <code class="literal">BouncingBall.update</code> method is called inside the <code class="literal">animate</code> function. As we saw previously, this function is invoked by the animation timer each time the timer is up. Inside this function, you can see how the simulation variables are updated to reflect the current state of that ball in the simulation.</li></ol></div><p><span class="emphasis"><em><span class="strong"><strong>What just happened?</strong></span></em></span></p><p>We’ve learned how to handle several object-local transformations while preserving global transformations by using a matrix stack strategy. In the bouncing ball example, we used an animation timer for the animation that is independent from the rendering timer. Finally, we saw how the bouncing ball <code class="literal">update</code> method shows how parametric curves work.</p></div>