<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec110"></a>Rendering to an Offscreen Framebuffer</h2></div></div><hr /></div><p>In order to perform object <span>selection</span><a id="id325357458" class="indexterm"></a> using the offscreen framebuffer, we need to ensure that both framebuffers are synchronized. If the onscreen framebuffer and the offscreen framebuffer are not synchronized, we could miss crucial data, which may make our picking strategy inconsistent.</p><p>A lack of consistency will limit the ability to read colors from the offscreen framebuffer and use them to identify objects in the scene.</p><p>To ensure that the buffers are synchronized, we will create a custom <code class="literal">render</code> function. This function calls the <code class="literal">draw</code> function twice. First, when the offscreen buffer is bound, and a second time when the onscreen default framebuffer is bound. The code looks like this:</p><pre class="programlisting">function render() {
// off-screen rendering
gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
// we set the uniform to true because of an offscreen render
gl.uniform1i(program.uOffscreen, true);
draw();

// on-screen rendering
gl.bindFramebuffer(gl.FRAMEBUFFER, null);
// we set the uniform to false because of the default render
gl.uniform1i(program.uOffscreen, false);
draw();
}</pre><p>We tell our ESSL program to use only diffuse colors when rendering into the offscreen framebuffer using the <code class="literal">uOffscreen</code> uniform. The fragment shader contains the following code:</p><pre class="programlisting">void main(void) {

if (uOffscreen) {
    fragColor = uMaterialDiffuse;
return;
}

// ...
}</pre><p>The following diagram shows the behavior of the <code class="literal">render</code> function:</p><div class="mediaobject"><img src="/graphics/9781788629690/graphics/3ce1ad4f-bb52-4738-b1fe-4e767115a3ec.png" /></div><p>Therefore, every time the scene updates, the <code class="literal">render</code> function is called <span>instead</span><a id="id325617369" class="indexterm"></a> of calling the <code class="literal">draw</code> function.</p><p>We change this in the <code class="literal">init</code> function:</p><pre class="programlisting">function init() {
configure();
load();

  // instead of calling 'draw', we are now calling 'render'
clock.on('tick', render);
}</pre><p>This way, the <code class="literal">scene</code> will be periodically updated using the <code class="literal">render</code> function instead of the original <code class="literal">draw</code> function.</p></div>