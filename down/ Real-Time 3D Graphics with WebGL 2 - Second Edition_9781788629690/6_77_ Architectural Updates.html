<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec83"></a>Architectural Updates</h2></div></div><hr /></div><p>As we progress through this book, we continue to refine our architecture where appropriate to reflect what weâ€™ve learned. On this occasion, we will improve how we pass uniforms to our program and add support for handling a large number of uniforms to define multiple lights.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec108"></a>Adding Support for Light Objects</h3></div></div></div><p>Let's cover these <span>changes</span><a id="id325358919" class="indexterm"></a> in detail. We have created a new JavaScript module, <code class="literal">Lights.js</code>, that has two objects:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">Light</code>: Aggregates <span>light</span><a id="id325617371" class="indexterm"></a> properties (position, diffuse, specular, and so on) in a single entity.</li><li style="list-style-type: disc"><code class="literal">LightsManager</code>: Contains the lights in <span>our</span><a id="id325617384" class="indexterm"></a> scene. This allows us to retrieve each light by <code class="literal">index</code> or <code class="literal">name</code>.</li></ul></div><p><code class="literal">LightsManager</code> also contains the <code class="literal">getArray</code> method to flatten the arrays of properties by type:</p><pre class="programlisting">getArray(type) {
return this.list.reduce((result, light) =&gt; {
    result = result.concat(light[type]);
return result;
}, []);
}</pre><p>This will be useful when we use uniform arrays later on.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec32"></a>Improving How We Pass Uniforms to the Program</h4></div></div></div><p>We have also improved the way we pass <span>uniforms</span><a id="id325631888" class="indexterm"></a> to the program. In <code class="literal">configure</code>, we can see how we pass attributes and uniforms to <code class="literal">program.load</code> rather than manually attaching them to the instance like in the introductory chapters.</p><p>The <code class="literal">configure</code> function is the appropriate place to load the program. We are also going to create a dynamic mapping between JavaScript variables and uniforms. With this in mind, we have updated the <code class="literal">program.load</code> method to receive two arrays:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">attributes</code>: An array <span>containing</span><a id="id325638057" class="indexterm"></a> the names of the attributes that we will map between JavaScript and ESSL.</li><li style="list-style-type: disc"><code class="literal">uniforms</code>: An array <span>containing</span><a id="id325638068" class="indexterm"></a> the names of the uniforms that we will map between JavaScript and ESSL.</li></ul></div><p>The implementation of the function now looks as follows:</p><pre class="programlisting">// Load up the given attributes and uniforms from the given values
load(attributes, uniforms) {
this.useProgram();
this.setAttributeLocations(attributes);
this.setUniformLocations(uniforms);
}</pre><p>The last two lines correspond to the two new functions, <code class="literal">setAttributeLocations</code> and <code class="literal">setUniformLocations</code>:</p><pre class="programlisting">// Set references to attributes onto the program instance
setAttributeLocations(attributes) {
  attributes.forEach(attribute =&gt; {
this[attribute] = this.gl.getAttribLocation(this.program, attribute);
});
}

// Set references to uniforms onto the program instance
setUniformLocations(uniforms) {
  uniforms.forEach(uniform =&gt; {
this[uniform] = this.gl.getUniformLocation(this.program, uniform);
});
}</pre><p>As you can see, these functions look up the attribute and uniform lists, respectively, and then attach the location as a property to the <code class="literal">Program</code> instance.</p><p>In short, if we include the <code class="literal">uLightPosition</code> uniform name in the <code class="literal">uniforms</code> list to be passed to <code class="literal">program.load</code>, we will then have a <code class="literal">program.uLightPosition</code> property that will contain the location of the respective uniform! Neat!</p><p>Once we load the program in the <code class="literal">configure</code> function, we can initialize the values of the uniforms immediately with the following:</p><pre class="programlisting">gl.uniform3fv(program.uLightPosition, value);</pre></div></div></div>