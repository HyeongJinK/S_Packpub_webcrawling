<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec18"></a>Setting up a bastion</h2></div></div><hr /></div><p>We will use the first host we are <span>going</span><a id="id325750937" class="indexterm"></a> to launch as a bastion host that will allow us to connect to other servers that are only accessible from within the private side of our VPC network.</p><p>We will be creating a security group to allow SSH traffic to this instance. We will use the <code class="literal">aws ec2 create-security-group</code> command to create a security group for our bastion host, as shown in the following command. A security group is an abstraction that AWS provides in order to group related firewall rules together and apply them to groups of hosts:</p><pre class="programlisting"><span class="strong"><strong>$ BASTION_SG_ID=$(aws ec2 create-security-group \</strong></span><span class="strong"><strong>--group-name ssh-bastion \</strong></span><span class="strong"><strong> --description "SSH Bastion Hosts" \</strong></span><span class="strong"><strong> --vpc-id $VPC_ID \</strong></span><span class="strong"><strong> --query GroupId --output text)</strong></span></pre><p>Once we have created a security group, we can attach a rule to it to allow SSH ingress on port <code class="literal">22</code>, as shown in the following command. This will allow you to access your host with an SSH client. Here, I am allowing ingress from the CIDR range <code class="literal">0.0.0.0/0</code>, but if your internet connection has a stable IP address, you might want to limit access to just your own IP:</p><pre class="programlisting"><span class="strong"><strong>$ aws ec2 authorize-security-group-ingress \</strong></span><span class="strong"><strong>--group-id $BASTION_SG_ID \</strong></span><span class="strong"><strong>--protocol tcp \</strong></span><span class="strong"><strong>--port 22 \</strong></span><span class="strong"><strong>--cidr 0.0.0.0/0</strong></span></pre><p>Now that we have set up the security group for the bastion host, we can go about launching our first EC2 instance. In this chapter, I will be using Ubuntu Linux (a popular Linux distribution). Before we can launch the instance, we will need to discover the ID of the AMI (Amazon machine image) for the operating system we want to use.</p><p>The Ubuntu project regularly publishes updated images to their AWS account that can be used to launch EC2 instances. We can run the following command to discover the ID of the image that we require:</p><pre class="programlisting"><span class="strong"><strong>$ UBUNTU_AMI_ID=$(aws ec2 describe-images --owners 099720109477 \</strong></span><span class="strong"><strong>--filters Name=root-device-type,Values=ebs \</strong></span><span class="strong"><strong>        Name=architecture,Values=x86_64 \</strong></span><span class="strong"><strong>        Name=name,Values='*hvm-ssd/ubuntu-xenial-16.04*' \</strong></span><span class="strong"><strong>--query "sort_by(Images, &amp;Name)[-1].ImageId" --output text)</strong></span></pre><p>We are going to use a <code class="literal">t2.micro</code> instance for the bastion host (as shown in the following command), as the usage for this instance type is included in the AWS free tier, so you won't have to pay for it for the first 12 months after you set up your AWS account:</p><pre class="programlisting"><span class="strong"><strong>$ BASTION_ID=$(aws ec2 run-instances \</strong></span><span class="strong"><strong>--image-id $UBUNTU_AMI_ID \</strong></span><span class="strong"><strong>--instance-type t2.micro \</strong></span><span class="strong"><strong>--key-name eds_laptop \</strong></span><span class="strong"><strong>--security-group-ids $BASTION_SG_ID \</strong></span><span class="strong"><strong>--subnet-id $PUBLIC_SUBNET_ID \</strong></span><span class="strong"><strong>--associate-public-ip-address \</strong></span><span class="strong"><strong>--query "Instances[0].InstanceId" \</strong></span><span class="strong"><strong>--output text)</strong></span></pre><p>Note that we are passing the ID of the subnet we chose to use, the ID of the security group we just created, and the name of the key pair we uploaded.</p><p>Next, let's update the instance with a <code class="literal">Name</code> tag so we can recognize it when looking at the EC2 console, as shown in the following command:</p><pre class="programlisting"><span class="strong"><strong>$ aws ec2 create-tags \</strong></span><span class="strong"><strong>--resources $BASTION_ID \</strong></span><span class="strong"><strong>--tags Key=Name,Value=ssh-bastion</strong></span></pre><p>Once the instance has launched, you <span>should</span><a id="id325753326" class="indexterm"></a> be able to run the <code class="literal">aws ec2 describe-instances</code> command to discover the public IP address of your new instance, as follows:</p><pre class="programlisting"><span class="strong"><strong>$ BASTION_IP=$(aws ec2 describe-instances \</strong></span><span class="strong"><strong>--instance-ids $BASTION_ID \</strong></span><span class="strong"><strong>--query "Reservations[0].Instances[0].PublicIpAddress" \</strong></span><span class="strong"><strong>--output text)</strong></span></pre><p>You should now be able to access the instance with SSH, as follows:</p><pre class="programlisting"><span class="strong"><strong>$ ssh ubuntu@$BASTION_IP</strong></span></pre><p>As you log in, you should see a message like the following:</p><pre class="programlisting"><span class="strong"><strong>Welcome to Ubuntu 16.04.3 LTS (GNU/Linux 4.4.0-1052-aws x86_64)</strong></span><span class="strong"><strong>* Documentation:  https://help.ubuntu.com</strong></span><span class="strong"><strong>* Management:     https://landscape.canonical.com</strong></span><span class="strong"><strong>* Support:        https://ubuntu.com/advantage</strong></span><span class="strong"><strong>Get cloud support with Ubuntu Advantage Cloud Guest:</strong></span><span class="strong"><strong>    http://www.ubuntu.com/business/services/cloud</strong></span><span class="strong"><strong>0 packages can be updated.</strong></span><span class="strong"><strong>0 updates are security updates.</strong></span>
<span class="strong"><strong> To run a command as administrator (user "root"), use "sudo &lt;command&gt;".</strong></span><span class="strong"><strong> See "man sudo_root" for details.</strong></span><span class="strong"><strong>ubuntu@ip-10-0-26-86:~$</strong></span></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip16"></a>Note</h3><p>If you saved your key pair as something other than the default <code class="literal">~/.ssh/id_rsa</code>, you can pass the path to your key using the <code class="literal">-i</code> flag, as follows:<code class="literal"><span class="strong"><strong>ssh -i ~/.ssh/id_aws_rsa ubuntu@$BASTION_IP</strong></span></code>
As an alternative, you can add the key to your SSH agent first by running the following:<code class="literal"><span class="strong"><strong>ssh-add ~/.ssh/id_aws_rsa</strong></span></code></p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec26"></a>sshuttle</h3></div></div></div><p>It is possible to forward traffic <span>from</span><a id="id325759544" class="indexterm"></a> your workstation to the private network by just using SSH. However, we can make accessing servers via the bastion instance much more convenient by using the <code class="literal">sshuttle</code> tool.</p><p>It is simple to install <code class="literal">sshuttle</code> on your workstation.</p><p>You can install it on macOS using Homebrew, as follows:</p><pre class="programlisting"><span class="strong"><strong>brew install sshuttle</strong></span></pre><p>You can also install it on Linux (if you have Python installed), as follows:</p><pre class="programlisting"><span class="strong"><strong>pip install sshuttle</strong></span></pre><p>To transparently proxy traffic to the instances inside the private network, we can run the following command:</p><pre class="programlisting"><span class="strong"><strong>$ sshuttle -r ubuntu@$BASTION_IP 10.0.0.0/16 --dns</strong></span><span class="strong"><strong>[local sudo] Password:</strong></span><span class="strong"><strong>client: Connected.</strong></span></pre><p>Firstly, we pass the SSH login details of our <code class="literal">ubuntu@$BASTION_IP</code> bastion instance, followed by the CIDR of our VPC (so that only traffic destined for the private network passes over the tunnel); this can be found by running <code class="literal">aws ec2 describe-vpcs</code>. Finally, we pass the <code class="literal">--dns</code> flag so that DNS queries on your workstation will be resolved by the DNS servers of the remote instance.</p><p>Using <code class="literal">sshuttle</code> requires you to enter your local sudo password in order to set up its proxy server.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip17"></a>Note</h3><p>You might want to run <code class="literal">sshuttle</code> in a separate terminal or in the background so that you still have access to the shell variables we have been using.</p></div><p>We can validate that this setup is working correctly by trying to log in to our instance through its private DNS name, as follows:</p><pre class="programlisting"><span class="strong"><strong>$ aws ec2 describe-instances \</strong></span><span class="strong"><strong>--instance-ids $BASTION_ID \</strong></span><span class="strong"><strong>--query "Reservations[0].Instances[0].PrivateDnsName"</strong></span><span class="strong"><strong>"ip-10-0-21-138.eu-west-1.compute.internal"</strong></span><span class="strong"><strong>$ ssh ubuntu@ip-10-0-21-138.eu-west-1.compute.internal</strong></span></pre><p>This tests whether you can resolve a DNS entry from the private DNS provided by AWS to instances running within your VPC, and whether the private IP address now returned by that query is reachable.</p><p>If you have any difficulties, check <code class="literal">sshuttle</code> for any connection errors and ensure that you have remembered to enable DNS support in your VPC.</p></div></div>