<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec21"></a>Installing Kubeadm</h2></div></div><hr /></div><p>Next, we will install the packages <span>that</span><a id="id325162570" class="indexterm"></a> we need to set up a Kubernetes control plane on this host. These packages are described in the following list:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">kubelet</code>: The node agent that Kubernetes uses to control the container runtime. This is used to run all the other components of the control plane within Docker containers.</li><li style="list-style-type: disc"><code class="literal">kubeadm</code>: This utility is responsible for bootstrapping a Kubernetes cluster.</li><li style="list-style-type: disc"><code class="literal">kubectl</code>: The Kubernetes command-line client, which will allow us to interact with the Kubernetes API server.</li></ul></div><p>First, add the signing key for the apt repository that hosts the Kubernetes packages, as follows:</p><pre class="programlisting"><span class="strong"><strong>$ curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -</strong></span><span class="strong"><strong>OK</strong></span></pre><p>Next add the Kubernetes apt repository, as follows:</p><pre class="programlisting"><span class="strong"><strong>$ sudo apt-add-repository 'deb http://apt.kubernetes.io/ kubernetes-xenial main'</strong></span></pre><p>Then, resynchronize the package indexes, as follows:</p><pre class="programlisting"><span class="strong"><strong>$ sudo apt-get update</strong></span></pre><p>Then, install the required packages, as follows:</p><pre class="programlisting"><span class="strong"><strong>$ sudo apt-get install -y kubelet kubeadm kubectl</strong></span></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip18"></a>Note</h3><p>This will install the latest version of the packages. If you want to pin to a specific version of Kubernetes, try running <code class="literal">apt-cache madison kubeadm</code> to see the different versions available.
I have prepared this chapter using Kubernetes 1.10. If, you wanted to install the most recent release of Kubernetes 1.10, you could run the following command:<code class="literal"><span class="strong"><strong>sudo apt-get install kubeadm=1.10.* kubectl=1.10.* kubelet=1.10.*</strong></span></code></p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec28"></a>Building an AMI</h3></div></div></div><p>Now that we are done with installing <span>packages</span><a id="id325753353" class="indexterm"></a> on this instance, we can shut it down, as follows:</p><pre class="programlisting"><span class="strong"><strong>$ sudo shutdown -h now</strong></span><span class="strong"><strong>Connection to 10.0.13.93 closed by remote host.</strong></span><span class="strong"><strong>Connection to 10.0.13.93 closed.</strong></span></pre><p>We can use the <code class="literal">create-image</code> command to instruct AWS to snapshot the root volume of our instance and use it to produce an AMI, as shown in the following command (you might need to wait a few moments for the instance to fully stop before running the command):</p><pre class="programlisting"><span class="strong"><strong>$ K8S_AMI_ID=$(aws ec2 create-image \</strong></span>
<span class="strong"><strong>       --name k8s-1.10.3-001 \</strong></span>
<span class="strong"><strong>       --instance-id $K8S_AMI_INSTANCE_ID \</strong></span>
<span class="strong"><strong>       --description "Kubernetes v1.10.3" \</strong></span>
<span class="strong"><strong>       --query ImageId \ </strong></span>
<span class="strong"><strong>      --output text)</strong></span></pre><p>It can take a few minutes for the image to become available for you to use, but you can check on its status with the <code class="literal">describe-images</code> command, as follows:</p><pre class="programlisting"><span class="strong"><strong>aws ec2 describe-images \</strong></span><span class="strong"><strong> --image-ids $K8S_AMI_ID \</strong></span><span class="strong"><strong> --query "Images[0].State"</strong></span></pre><p>While the image is being built, you will see <code class="literal">pending</code>, but once it is ready to use the state will have changed to <code class="literal">available</code>.</p></div></div>