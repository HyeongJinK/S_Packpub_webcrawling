<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec13"></a>Your own Kubernetes</h2></div></div><hr /></div><p><span class="strong"><strong>Minikube</strong></span> is a tool that makes it <span>easy</span><a id="id325162573" class="indexterm"></a> to run a simple Kubernetes cluster on your workstation. It is very useful, as it allows you to test your applications and configurations locally <span>and</span><a id="id325749653" class="indexterm"></a> quickly iterate on your applications without needing access to a larger cluster. For our purposes, it is the ideal tool to get some practical hands-on experience with Kubernetes. It is very simple to install and configure, as you will discover.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec14"></a>Installation</h3></div></div></div><p>You will need a few tools to get <span>Kubernetes</span><a id="id326262675" class="indexterm"></a> running on your workstation:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">kubectl</code> is the Kubernetes command-line interface. Throughout this book, you will be using it to interact with Kubernetes.</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note8"></a>Note</h3><p>In the Kubernetes community, no one agrees how to pronounce <code class="literal">kubectl</code>.</p></div><p>Try out these different ways and choose your favorite:</p><pre class="programlisting"><span class="strong"><strong>kube-kuttle</strong></span><span class="strong"><strong>kube-control</strong></span><span class="strong"><strong>kube-cee-tee-ell</strong></span><span class="strong"><strong>kube-cuddle</strong></span></pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">minikube</code> is a command that manages Kubernetes on your local machine. It handles all the hard stuff, so you can get started with Kubernetes straight away.</li><li style="list-style-type: disc"><code class="literal">docker</code>, the <code class="literal">minikube</code> virtual machine, has the Docker daemon running internally, but you might need the Docker command line installed on your workstation if you want to interact with it directly.</li></ul></div><p>It is best to use Minikube in conjunction with a virtual machine, as platforms like macOS and Windows don't natively support Linux containers, and even on Linux it helps to keep your environment clean and isolated. There are various virtualization tools you can use with <code class="literal">minikube,</code> depending on your operating system:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>VirtualBox</strong></span>: It is simple to use <span>and</span><a id="id326354400" class="indexterm"></a> can be installed on macOS, Windows, and Linux.</li><li style="list-style-type: disc"><span class="strong"><strong>VMware Fusion</strong></span>: It is a commercial <span>tool</span><a id="id326354413" class="indexterm"></a> available on macOS.</li><li style="list-style-type: disc"><span class="strong"><strong>KVM</strong></span>: It is a well-known <span>Linux</span><a id="id326354425" class="indexterm"></a> virtualization tool.</li><li style="list-style-type: disc"><span class="strong"><strong>xhyve</strong></span>: It is an open source project that <span>utilizes</span><a id="id326354437" class="indexterm"></a> the native hypervisor framework in macOS. It performs very well but can be a little harder to install and use.</li><li style="list-style-type: disc"><span class="strong"><strong>Hyper-V</strong></span>: It is the <span>native</span><a id="id326354449" class="indexterm"></a> virtualization tool for Windows. Remember, you might need to manually enable it on your machine and set up its networking.</li></ul></div><p>In this book, we are going to cover the default option, VirtualBox, but if you are using Minikube regularly, you might want to explore some of the other options, as they can be more performant and reliable if set up correctly.</p><p>You can find some documentation about the different <span>drivers</span><a id="id326354460" class="indexterm"></a> available atÂ <a class="ulink" href="https://git.k8s.io/minikube/docs/drivers.md" target="_blank"><span>https://git.k8s.io/minikube/docs/drivers.md</span></a>.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl3sec4"></a>macOS</h4></div></div></div><p>On a Mac, the best <span>way</span><a id="id326354482" class="indexterm"></a> to install <code class="literal">minikube</code> and <code class="literal">kubectl</code> is with the Homebrew package manager.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note9"></a>Note</h3><p>The Homebrew package manager for macOS is a simple way to install development tools. You can find out how to install it on the website: <a class="ulink" href="https://brew.sh/" target="_blank">https://brew.sh/</a><a class="ulink" href="https://brew.sh/" target="_blank">.</a></p></div><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Start by installing <span>the</span><a id="id326354516" class="indexterm"></a> Kubernetes command-line client <code class="literal">kubectl</code>:</li></ol></div><pre class="programlisting"><span class="strong"><strong>brew install kubernetes-cli</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Next, install <code class="literal">minikube</code> and <code class="literal">virtualbox</code>:</li></ol></div><pre class="programlisting"><span class="strong"><strong>brew cask install minikube virtualbox</strong></span></pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl3sec5"></a>Linux</h4></div></div></div><p>On Linux, the simplest installation <span>method</span><a id="id326368763" class="indexterm"></a> is to download and install pre-built binaries:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>You should download the binaries for <code class="literal">minikube</code> and <code class="literal">kubectl</code>:</li></ol></div><pre class="programlisting"><span class="strong"><strong>curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64</strong></span><span class="strong"><strong>curl -LO https://dl.k8s.io/v1.10.6/bin/linux/amd64/kubectl</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Once you have downloaded the binaries, make them executable and move them to somewhere on your path:</li></ol></div><pre class="programlisting"><span class="strong"><strong>chmod +x minikube kubectl</strong></span><span class="strong"><strong>sudo mv minikube kubectl /usr/local/bin/</strong></span></pre><p>The method of installing <span>VirtualBox</span><a id="id326376361" class="indexterm"></a> on Linux will depend on your distribution.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note10"></a>Note</h3><p>Take a look at the instructions on the VirtualBox website: <a class="ulink" href="https://www.virtualbox.org/wiki/Linux_Downloads" target="_blank">https://www.virtualbox.org/wiki/Linux_Downloads</a>.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl3sec6"></a>Windows</h4></div></div></div><p>Installing Minikube on a Windows <span>machine</span><a id="id326376386" class="indexterm"></a> is as simple as it is on Linux or macOS.</p><p>Start by installing VirtualBox.</p><p>You can download the <span>Windows</span><a id="id326376398" class="indexterm"></a> installer for VirtualBox from <a class="ulink" href="https://www.virtualbox.org/wiki/Downloads" target="_blank"><span>https://www.virtualbox.org/wiki/Downloads</span></a>.</p><p>If you are using the chocolatey package manager, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Install <code class="literal">minikube</code>:</li></ol></div><pre class="programlisting"><span class="strong"><strong>C:\&gt; choco install minikube</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Install <code class="literal">kubectl</code>:</li></ol></div><pre class="programlisting"><span class="strong"><strong>C:\&gt; choco install kubernetes-cli</strong></span></pre><p>If you are not using chocolatey, you can manually install <code class="literal">minikube</code> and <code class="literal">kubectl</code>.</p><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Download <code class="literal">minikube</code> at <a class="ulink" href="https://storage.googleapis.com/minikube/releases/latest/minikube-windows-amd64.exe" target="_blank"><span>https://storage.googleapis.com/minikube/releases/latest/minikube-windows-amd64.exe</span></a> and rename it to <code class="literal">minikube.exe</code>. Then move it to a location on your path. Download <code class="literal">kubectl</code>: <a class="ulink" href="https://dl.k8s.io/v1.10.6/bin/windows/amd64/kubectl.exe" target="_blank"><span>https://dl.k8s.io/v1.10.6/bin/windows/amd64/kubectl.exe</span></a> and then move it to a location on your path.</li></ol></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec15"></a>Starting Minikube</h3></div></div></div><p>Once you have got <code class="literal">minikube</code> and your <span>chosen</span><a id="id326407285" class="indexterm"></a> virtualization tool installed, we can use it to build and start a local Kubernetes cluster.</p><p>If you choose to use <code class="literal">minikube</code> tool's default settings, doing so couldn't be simpler. Just run:</p><pre class="programlisting"><span class="strong"><strong>minikube start</strong></span></pre><p>You should then see some output, similar to the following:</p><pre class="programlisting"><span class="strong"><strong>Starting local Kubernetes v1.10.0 cluster...</strong></span><span class="strong"><strong>Starting VM...</strong></span><span class="strong"><strong>Getting VM IP address...</strong></span><span class="strong"><strong>Moving files into cluster...</strong></span><span class="strong"><strong>Setting up certs...</strong></span><span class="strong"><strong>Connecting to cluster...</strong></span><span class="strong"><strong>Setting up kubeconfig...</strong></span><span class="strong"><strong>Starting cluster components...</strong></span><span class="strong"><strong>Kubectl is now configured to use the cluster.</strong></span></pre><p><code class="literal">minikube</code> start has many options that can be used to configure the cluster that is launched. Try running <code class="literal">minikube</code> help start to find out what you can customize.</p><p>You might want to set <code class="literal">--cpus</code> and/or <code class="literal">--memory</code> to customize how much of your computer's resources are used for the Minikube VM.</p><p>Assuming that everything went as expected, that's it; you should have a cluster installed and running on your local machine.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note11"></a>Note</h3><p>The kubectl <code class="literal">config</code> file (found at <code class="literal">~/.kube/config</code> by default) defines contexts. A context links to a cluster and a user object. The cluster defines how.</p></div><p>The <code class="literal">minikube start</code> command creates a <code class="literal">kubectl</code> context pointing to the API server running within the Minikube VM, and is correctly configured with a user that will allow access to Kubernetes.</p><p>As you progress through this book, you will of course want to add additional contexts in order to connect to remote clusters that you many have set up. You should be able to switch back to the <code class="literal">minikube</code> context whenever you want to use <code class="literal">minikube</code> by running the following command:</p><pre class="programlisting"><span class="strong"><strong>kubectl config use-context minikube</strong></span></pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec16"></a>First steps with kubectl</h3></div></div></div><p>Let's start by validating that <code class="literal">kubectl</code> has indeed <span>been</span><a id="id326464444" class="indexterm"></a> configured to use your cluster correctly and that we can connect to it:</p><pre class="programlisting"><span class="strong"><strong>kubectl version</strong></span></pre><p>You should see some output like this:</p><pre class="programlisting"><span class="strong"><strong>Client Version: version.Info{Major:"1", Minor:"10", GitVersion:"v1.10.4", GitCommit:"5ca598b4ba5abb89bb773071ce452e33fb66339d", GitTreeState:"clean", BuildDate:"2018-06-18T14:14:00Z", GoVersion:"go1.9.7", Compiler:"gc", Platform:"darwin/amd64"}</strong></span><span class="strong"><strong>Server Version: version.Info{Major:"1", Minor:"10", GitVersion:"v1.10.0", GitCommit:"fc32d2f3698e36b93322a3465f63a14e9f0eaead", GitTreeState:"clean", BuildDate:"2018-03-26T16:44:10Z", GoVersion:"go1.9.3", Compiler:"gc", Platform:"linux/amd64"}</strong></span></pre><p>Your output might show slightly different version numbers, but assuming that you see a version number from both the client and the server, you can connect to the cluster.</p><p>If you can't see the server version, or you saw some other error message, skip forward to the <span class="emphasis"><em>Troubleshooting Minikube</em></span> section of this chapter.</p><p>Let's start interacting with the cluster with some of the <code class="literal">kubectl</code> commands that are going to be useful to us when we interact with our cluster.</p><p>The first command that we will explore is the <code class="literal">get</code> command. This lets us list basic information about the resources on the cluster. In this case, we are getting a list of all the node resources:</p><pre class="programlisting"><span class="strong"><strong>kubectl get nodes</strong></span><span class="strong"><strong>NAME       STATUS    AGE       VERSION</strong></span><span class="strong"><strong>minikube   Ready    20h       v1.10.0</strong></span></pre><p>As you can see, on our Minikube installation, this is not very exciting, as we only have one node. But on larger clusters with many nodes, being able to see this information about all the nodes (or some subset) could be very useful.</p><p>The next command will allow us to drill down and look at some more detailed information about a particular resource. Try running the following command against your installation to see what you can discover about the Minikube VM:</p><pre class="programlisting"><span class="strong"><strong>$ kubectl describe node/minikube</strong></span></pre><p>As you progress through this book, you will discover that being able to get and describe the various resources that the Kubernetes API exposes will become second nature to you whenever you want to discover what is happening on your cluster and why.</p><p>Before we move on, <code class="literal">kubectl</code> has one more trick to help us. Try running the following command for a description of each of the resource types available on the cluster and some examples:</p><pre class="programlisting"><span class="strong"><strong>kubectl describe -h</strong></span></pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec17"></a>Building Docker containers inside the cluster</h3></div></div></div><p>You might already have <span>Docker</span><a id="id326467981" class="indexterm"></a> installation on your workstation, but when you are working on an application it can improve your workflow to build your images on the Docker daemon running inside the Minikube VM that hosts your Kubernetes cluster. This means that you can skip pushing your images to a Docker repo before using them in Kubernetes. All you need do is build and tag your images, and then refer to them by name in your Kubernetes resources.</p><p>If you already have a Docker installation on your workstation, you should already have the command-line client installed that you need to interact with the Minikube Docker daemon. If you don't, it is quite easy to install, either by installing the Docker package for your platform or, if you just want the command-line tool, downloading the binary and copying it into your path.</p><p>To correctly configure the Docker CLI to communicate with the Docker demon inside the minikube VM, minikube provides a command that will return environment variables to configure the client:</p><pre class="programlisting"><span class="strong"><strong>minikube docker-env</strong></span></pre><p>On Mac or Linux, you can correctly expand these variables into your current shell environment by running:</p><pre class="programlisting"><span class="strong"><strong>eval $(minikube docker-env)</strong></span></pre><p>Try running some <code class="literal">docker</code> commands to check everything is set up correctly:</p><pre class="programlisting"><span class="strong"><strong>docker version</strong></span></pre><p>This should show you the version of Docker running inside the Minikube VM. You might notice that the server version of Docker running in the Minikube VM is a little bit behind the latest version of Docker, since it takes some time for Kubernetes to be tested against new versions of Docker to be considered stable.</p><p>Try listing the running containers. You should notice a container running the Kubernetes dashboard, as well as some other services that Kubernetes has launched, such as <code class="literal">kube-dns</code> and the <code class="literal">addon</code> manager:</p><pre class="programlisting"><span class="strong"><strong>docker ps</strong></span></pre></div></div>