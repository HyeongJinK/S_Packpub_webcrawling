<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec33"></a>Running the model on a browser using TensorFlow.js</h2></div></div><hr /></div><p>In this section, we are going to <span>deploy</span><a id="id325611670" class="indexterm"></a> the model on a browser.</p><p>The following steps demonstrate how to save the model:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Install TensorFlow.js, which will help us format our trained model in accordance with what can be consumed by the browser:</li></ol></div><pre class="programlisting"><span class="strong"><strong>pip install tensorflowjs</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Save the model in the TensorFlow.js format:</li></ol></div><pre class="programlisting"><span class="strong"><strong>import tensorflowjs as tfjs </strong></span>
<span class="strong"><strong>tfjs.converters.save_keras_model(model, OUTPUT_DIR)</strong></span></pre><p>This will create a json file called <code class="literal">model.json</code>, which will contain the meta-variables and some other files, such as <code class="literal">group1-shard1of1</code>. </p><p>Good job! Deploying the model in the HTML file is a little trickier, however:</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip26"></a>Note</h3><p>For running the code mentioned in the repository, please follow the <code class="literal">README.md</code> documentation carefully (note the troubleshooting part, if required) regarding the settings before running the <code class="literal">Run_On_Browser.html</code> file.</p></div><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Incorporate TensorFlow.js in your JavaScript through script tags:</li></ol></div><pre class="programlisting">&lt;script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.8.0"&gt;&lt;/script&gt;</pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Load the model and our <code class="literal">token_idx</code> dictionary. This will help us to <span>load</span><a id="id325091921" class="indexterm"></a> the relevant data before processing any review from the browser:</li></ol></div><pre class="programlisting"><span>async</span><span>function</span><span>createModel</span>()
{
<span>const</span><span>model</span><span>=</span><span>await</span>
<span>tf</span>.<span>loadModel</span>(<span><span>'</span>http://127.0.0.1:8000/model.json<span>'</span></span>)<span>
return model
</span>}
async function loadDict()
{
 await $.ajax({
 url: 'http://127.0.0.1:8000/token_index.csv',
 dataType: 'text',
 crossDomain : true}).done(success);
}
function success(data)
{
    var wd_idx = new Object();
    lst = data.split(/\r?\n|\r/)
    for(var i = 0 ; i &lt; lst.length ;i++){
        key = (lst[i]).split(',')[0]
        value = (lst[i]).split(',')[1]

        if(key == "")
            continue
        wd_idx[key] = parseInt(value) 
    }

    word_index = wd_idx
}


async function init()
{
 word_index = undefined
 console.log('Start loading dictionary')
 await loadDict()
 //console.log(word_index)
 console.log('Finish loading dictionary')
 console.log('Start loading model') 
 model = await createModel()
 console.log('Finish loading model') 
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Add some helper functions to process the review input from the browser. This includes processing text, mapping words to <code class="literal">token_idx</code>, and <span>creating</span><a id="id325607380" class="indexterm"></a> sequences for model predictions:</li></ol></div><pre class="programlisting">function process(txt)
{
 out = txt.replace(/[^a-zA-Z0-9\s]/, '')
 out = out.trim().split(/\s+/)
 for (var i = 0 ; i &lt; out.length ; i++)
 out[i] = out[i].toLowerCase()
 return out
}

function create_sequences(txt)
{
 max_tokens = 40 
 tokens = []
 words = process(txt)
 seq = Array.from(Array(max_tokens), () =&gt; 0) 
 start = max_tokens-words.length
 for(var i= 0 ; i&lt; words.length ; i++)
 {
     if (Object.keys(word_index).includes(words[i])){
         seq[i+start] = word_index[words[i]]
     } 
 }
 return seq
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Incorporate the predict function that processes the input sentence and uses the model's predict function to return a tensor with a predicted score, as shown in the previous section:</li></ol></div><pre class="programlisting">async function predict()
{
 txt = document.getElementById("userInput").value
 alert(txt);
 seq = create_sequences(txt) 
 input = tf.tensor(seq)
 input = input.expandDims(0)
 pred = model.predict(input)
 document.getElementById("Sentiment").innerHTML = pred;

 pred.print()
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>To illustrate the entire process from a user's point of view, open the <code class="literal">Run_on_Browser.html</code> file. You will see something similar to what's shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="/graphics/9781789132212/graphics/921e8b8f-bd5c-4d38-96e0-f571476e8e42.png" /></div><p>The left-hand side of the <span>screenshot</span><a id="id325615022" class="indexterm"></a> denotes the website's layout, while the right-hand side shows the console and outputs.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note27"></a>Note</h3><p>Note that we can load the dictionary and model beforehand to make the predictions faster.</p><p></p></div><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Type a review into the box provided and click submit to see the model's predicted score. Try running the application with the <code class="literal">Awesome Movie</code> text:</li></ol></div><div class="mediaobject"><img src="/graphics/9781789132212/graphics/e8bfaa81-6554-490c-b8aa-0375fc80335a.png" /></div><p>The predicted score is quite high, which indicates a positive sentiment. You can play around with different text to see the results.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note28"></a>Note</h3><p>Note that this is mainly for illustration purposes and that if you are up for it, you can improve the UI through JavaScript.</p></div></div>