<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec44"></a>Infrastructure as Code</h2></div></div><hr /></div><p>Now let's review what we have learned. An ARM template <span>has</span><a id="id324953579" class="indexterm"></a> a simple structure like the following:</p><pre class="programlisting">{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "",
  "parameters": {  },
  "variables": {  },
  "functions": {  },
  "resources": [  ],
  "outputs": {  }
}</pre><p>Expressions are written in JSON strings with brackets to start and end, and these expressions are evaluated when deployed.  These are basically like JavaScript functions and are formatted like <code class="literal">functionname (arg1,arg2,etc)</code>; let’s look at an example. You can develop a deeper understanding at <a class="ulink" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-templates-variables" target="_blank">https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-templates-variables</a>:</p><pre class="programlisting">"variables": {
    "appServiceName": "[concat(toLower(parameters('appServiceNamePrefix')), uniqueString(resourceGroup().id))]"
}</pre><p>What we are doing here is setting a variable name, <code class="literal">appServiceName</code>, which is a concatenation of a parameter name and the resource group ID to make it unique. The <code class="literal">parameters</code> are sections of the template that can be tailored <span>for, say, environment and such</span> that can be overwritten or can contain default values. Let's look at how this would look and tie it in to the previous variable. You can develop a deeper understanding at <a class="ulink" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-templates-parameters" target="_blank">https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-templates-parameters</a>:</p><pre class="programlisting">"parameters": {
  "appServiceNamePrefix": {
    "type": "string",
    “defaultValue”: “BookDemoAppService”
    "metadata": {
      "description": "The name prefix of the web app that you wish to create."
    }
  },
},</pre><p>The template system comes with some built-in templates, but you can also create your own, although there are some caveats you need to consider. Let’s go over them really quickly:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Variables and parameters cannot be accessed</li><li style="list-style-type: disc">You cannot call other user-defined functions</li><li style="list-style-type: disc">You cannot have default values</li></ul></div><p>Let’s look at a quick name creation user function. You can dive in deeper at <a class="ulink" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-authoring-templates#functions" target="_blank">https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-authoring-templates#functions</a>:</p><pre class="programlisting">"functions": [
  {
    "namespace": "bookdemo",
    "members": {
      "createName": {
        "parameters": [
          {
            "name": "namePrefix",
            "type": "string"
          }
        ],
        "output": {
          "type": "string",
          "value": "[concat(toLower(parameters('namePrefix')), uniqueString(resourceGroup().id))]"
        }
      }
    }
  }
],</pre><p>Let’s look at how to call <span>this</span><a id="id325433783" class="indexterm"></a> function within the template.</p><pre class="programlisting">"resources": [
  {
    "name": "[bookdemo.createName(parameters('webAppName'))]",
    ...
]</pre><p>The <code class="literal">resources</code> section of the template is for the resources you are looking to deploy with the template. Now, not all Azure resources can be deployed in a template; to get a deeper understanding, please review <a class="ulink" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-templates-resources" target="_blank">https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-templates-resources</a>.</p><p>You can also set up output parameters; they can be used in the deployment process to return variables from the <span>template</span><a id="id325438658" class="indexterm"></a> deployed and can be used in other parts of the release pipeline. A <span class="strong"><strong>release pipeline</strong></span> is the thing that needs to be released by a deployment.  For a deeper look at output parameters, see <a class="ulink" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-templates-outputs" target="_blank">https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-templates-outputs</a>.</p><p>Let’s look at how to begin creating a template in a Visual Studio project after you install the Azure Workload. <span>In <strong class="userinput"><code>Visual Studio</code></strong>, you select <span class="strong"><strong>File</strong></span></span>, <span>then <span class="strong"><strong>New Project</strong></span>, as you can see in the following screenshot:</span></p><div class="mediaobject"><img src="/graphics/9781786468659/graphics/4d5fcc23-8979-4275-9796-072545c0ffc8.png" /></div><p>Creating an Azure Resource Group</p><p>Now that we understand how to create an ARM template, I should also mention you can link or nest templates to create a module approach to template management. You can accomplish this by adding a resource hint to the main template; let's see how we do that:</p><pre class="programlisting">"resources": [
  {
      "apiVersion": "2017-05-10",
      "name": "linkedTemplate",
      "type": "Microsoft.Resources/deployments",
      "properties": {
          "mode": "Incremental",
          // Nested template or external template link //
      }
  }
]</pre><p>You can add the external link to a template and parameter file as follows:</p><pre class="programlisting">"templateLink": {
          "uri":"https://bookdemo.blob.core.windows.net/ARMTemplates/newStorageAccount.json",
          "contentVersion":"1.0.0.0"
       },
       "parametersLink": {
          "uri":"https:// bookdemo.blob.core.windows.net/ ARMTemplates /newStorageAccount.parameters.json",
          "contentVersion":"1.0.0.0"
       }</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note21"></a>Note</h3><p>It should be noted that nested templates do not allow you to use parameters or variables that are defined within the nested template. You can, however, use them from the parent template, unless you are using an external template as defined previously.</p></div><p>Now, within a template, you can <span>have</span><a id="id325439882" class="indexterm"></a> a resource dependent on another resource by using the <code class="literal">dependsOn</code> hint, like this for a resource to be dependent on a VNet:</p><pre class="programlisting">"dependsOn": [
  "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]"
]</pre><p>It is added to a resource as follows:</p><pre class="programlisting">{
  "type": "Microsoft.Compute/virtualMachine",
  "name": "[variables('myVMName')]",
  "location": "[variables('region')]",
  "apiVersion": "2016-03-30",
  "tags": {
    "displayName": "VMGroup"
  },
  "dependsOn": [
    "[variables('virtualNetworkName')]"
  ],
  ...
}</pre><p>ARM templates are an important piece to learn when using Azure; you can dive deeper by reviewing the Microsoft documentation at <a class="ulink" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/" target="_blank">https://docs.microsoft.com/en-us/azure/azure-resource-manager/</a>.</p></div>