<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec86"></a>Azure Event Grid and reactive architecture</h2></div></div><hr /></div><p>When working with multiple services in the cloud, you <span>often</span><a id="id325407661" class="indexterm"></a> need to have a centralized service responsible for routing events to a different endpoint. This makes the exchange of data a piece of cake—you do not have to maintain different URLs of APIs, as you can leverage a common event schema and custom routing <span>configuration</span><a id="id325407660" class="indexterm"></a> based on, for example, event type. In Azure, such a service is called Azure Event Grid—a serverless event gateway, which is one of the newer cloud components available. With a pay-as-you-go pricing model, you can quickly build a reactive architecture that inverts communication between your services and makes them passive. In this chapter, you will learn how to work with Event Grid<span class="emphasis"><em> </em></span>and integrate it with other Azure components.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec95"></a>Reactive architecture</h3></div></div></div><p>To get started, let's consider the architecture <span>shown</span><a id="id325143114" class="indexterm"></a> in the following diagram:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/ee19d85a-f37e-4268-b453-00b2e7682180.png" /></div><p>In this diagram, you can see an example flow of uploading, for instance, an image for an avatar from a user. A file is transferred through an <span class="strong"><strong>Azure App Service</strong></span> and put into <span class="strong"><strong>Azure Blob Storage</strong></span>. Then, it is processed by <span class="strong"><strong>Azure Functions</strong></span>. While such a setup is perfectly fine, consider the following disadvantage—to be able to process the image, <span class="strong"><strong>Azure Functions</strong></span> has to be notified about the fact that a new file was uploaded.</p><p> </p><p> </p><p>Since<span class="strong"><strong> Azure Blob Storage</strong></span> is unable to do so (at least with the functionality available publicly), the only way to achieve that is to pool a storage and somehow maintain processed files. While conceptually, this is not rocket science, you have to bear in mind that, in the cloud, when you use a resource, you pay for the time taken. So basically, in the preceding scenario, you would be paying even if no file was uploaded to the storage, since a trigger in <span class="strong"><strong>Azure Functions</strong></span> (here, a Blob trigger) will have to maintain a state of files available and check at intervals whether something new appeared, so you will often pay for nothing. Now, consider the following change:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/39101022-7fab-41fb-8b2d-781b21bcb506.png" /></div><p>As you can see, I put an <span class="strong"><strong>Azure Event Grid</strong></span><span class="emphasis"><em> </em></span>between <span class="strong"><strong>Azure Blob Storage<span class="emphasis"><em> </em></span></strong></span>and <span class="strong"><strong>Azure Functions</strong></span>. What has it changed? Well, functions processing a Blob do not have to pool storage to get info about uploaded files. This is possible thanks to version 2 of Azure Storage (you can find a link to a description in <span class="emphasis"><em>Further reading</em></span><span class="strong"><strong> </strong></span>section)—it can publish events to <span class="strong"><strong>Azure Event Grid</strong></span> so they can then be forwarded to all subscribers of that particular event type. Thanks to this, <span class="strong"><strong>Azure Functions</strong></span><span class="emphasis"><em> </em></span>can remain passive—they will be called by <span class="strong"><strong>Azure Event Grid</strong></span><span class="emphasis"><em> </em></span>when needed, so if nothing is uploaded, you will pay nothing. This is, of course, an element of serverless<span class="emphasis"><em> </em></span>architecture—being able to pay for usage makes such a setup possible.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note128"></a>Note</h3><p>Remember that you will not be charged if you only use the Consumption plan in Azure Functions. If you have to use an App Service Plan<span class="emphasis"><em> </em></span>for your functions, you will not be able to save money with the preceding architecture—on the other hand, you will save some compute power, which could be used for other workloads, so reactive architecture concepts will still be valid.</p></div><p>This is what we call <span class="strong"><strong>reactive architecture</strong></span>—a model where your components can remain idle and wait for upcoming requests. </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec96"></a>Topics and event subscriptions</h3></div></div></div><p>There are five main topics when it comes to working with <span>Azure</span><a id="id325317178" class="indexterm"></a> Event Grid:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Events</li><li style="list-style-type: disc">Event handlers</li><li style="list-style-type: disc">Event sources</li><li style="list-style-type: disc">Topics</li><li style="list-style-type: disc">Event subscriptions</li></ul></div><p>In this section, we will go through each of them to build a better understanding of this service.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch10lvl3sec55"></a>Event sources</h4></div></div></div><p>Currently, Azure Event Grid<span class="emphasis"><em> </em></span><span>supports</span><a id="id325407632" class="indexterm"></a> the following event sources:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Azure Blob Storage</li><li style="list-style-type: disc">Azure Media Services</li><li style="list-style-type: disc">Azure Subscriptions</li><li style="list-style-type: disc">Resource Groups</li><li style="list-style-type: disc">Azure Event Hubs</li><li style="list-style-type: disc">Azure IoT Hub</li><li style="list-style-type: disc">Azure Service Bus</li><li style="list-style-type: disc">Custom topics</li><li style="list-style-type: disc">Container Registry</li><li style="list-style-type: disc">Storage <span class="strong"><strong>General-purpose v2</strong></span> (<span class="strong"><strong>GPv2</strong></span>)</li></ul></div><p>As you can see, there are plenty of different services integrated and <span>available</span><a id="id325543707" class="indexterm"></a> when working with Event Grid. While we know which event sources we can use, we still have not defined what an event source<span class="strong"><strong> </strong></span>actually is. Take a look at the following diagram:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/7a1ce720-87fd-4408-b6d5-bfd6e8840b4b.png" /></div><p>In this scenario, a file uploaded to <span class="strong"><strong>Azure Blob Storage</strong></span><span class="emphasis"><em> </em></span>triggers an event, which is then fetched by <span class="strong"><strong>Azure Event Grid</strong></span><span class="emphasis"><em> </em></span>and passed further to the consumer. The event source<span class="strong"><strong> </strong></span>is the origin of an event that was then handled by Event Grid. When working with this service, all event sources have a way to publish an event and communicate with <span class="strong"><strong>Azure Event Grid</strong></span>. There is also one extra event source possible—it is Custom topics. It is possible to publish your own custom events directly to an Event Grid<span class="emphasis"><em> </em></span>endpoint—we will cover that later in this chapter.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch10lvl3sec56"></a>Event handlers</h4></div></div></div><p>In the previous example, we covered event sources. Let's take a <span>similar</span><a id="id325544044" class="indexterm"></a> scenario:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/c0142eca-5252-4f60-9bc0-2935f1f129c8.png" /></div><p>Once more, we have <span class="strong"><strong>Azure Blob Storage</strong></span><span class="emphasis"><em> </em></span>as a publisher, but this time, events are forwarded to both <span class="strong"><strong>Azure Functions</strong></span><span class="emphasis"><em> </em></span>and <span class="strong"><strong>Azure Event Hub</strong></span>. In that architecture, services presented on the right are event handlers. Here is a list of currently supported services:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Azure Functions</li><li style="list-style-type: disc">Azure Logic Apps</li><li style="list-style-type: disc">Azure Automation</li><li style="list-style-type: disc">WebHooks</li><li style="list-style-type: disc">Azure Queue Storage</li><li style="list-style-type: disc">Hybrid Connections</li><li style="list-style-type: disc">Azure Event Hubs</li><li style="list-style-type: disc">Microsoft Flow</li></ul></div><p>So what actually is an event handler? You can think about it as a processor of an event—based on the configuration, Azure Event Grid<span class="emphasis"><em> </em></span>will forward events to handlers, where they will be deserialized and analyzed.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note129"></a>Note</h3><p>In general, Azure Event Grid<span class="emphasis"><em> </em></span>uses a common event schema when delivering events to handlers. What is more, it can deliver more than just one event at the time—you have to be prepared for a possible batch of events. </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch10lvl3sec57"></a>Topics and subscriptions</h4></div></div></div><p>A topic is a general messaging concept <span>that</span><a id="id326372098" class="indexterm"></a> allows for one-to-many communication. It works with subscriptions in the following way—you publish a message to a topic in a messaging service, and then subscribe to it with your consumers. In Azure Event Grid,<span class="emphasis"><em> </em></span>you are responsible for creating a topic—that means that you have to publish a custom application that handles communication between publishers and the Event Grid<span class="emphasis"><em> </em></span>endpoint. You can have a single application, or many of them—this depends on your design and expected throughput. Additionally, you have to configure subscriptions—in the next section, you will see how to do that, and how to set up proper filtering. The general structure could look like this:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/d9f35f56-2dfc-49a1-88e1-272c67ba5ff1.png" /></div><p>The left side of the preceding diagram represents publishers and a topic (the line between a publisher and <span class="strong"><strong>Azure Event Grid</strong></span>) and subscriptions with handlers. Each line is a different topic and subscription. The whole configuration and routing resides within Event Grid and can be managed there.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note130"></a>Note</h3><p>Azure Event Grid<span class="emphasis"><em> </em></span>takes care of retrying undelivered messages. This can be configured with a custom policy that defines the rules for retrying. Additionally, when a custom topic is used, events have to be published in batches to make it work.</p></div><p>To sum up, we can define both a topic and a subscription as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Topic</strong></span>: A channel between a service and <span>Azure</span><a id="id326394403" class="indexterm"></a> Event Grid, which allows the former to push an event to the Azure service</li><li style="list-style-type: disc"><span class="strong"><strong>Subscription</strong></span>: A channel between <span>Azure</span><a id="id326394414" class="indexterm"></a> Event Grid and a service, which is used to retrieve events in the former</li></ul></div></div></div></div>