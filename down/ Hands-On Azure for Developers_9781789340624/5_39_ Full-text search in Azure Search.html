<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec43"></a>Full-text search in Azure Search</h2></div></div><hr /></div><p>The power of Azure Search comes when you need to perform a full-text search to find relevant documents that will satisfy your query. This Azure service uses <span class="strong"><strong>Apache Lucene</strong></span> under the hood, which is a well-known, high-performance search engine <span>written</span><a id="id325120021" class="indexterm"></a> in Java.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note71"></a>Note</h3><p>You can find more information about Lucene here: <a class="ulink" href="https://lucene.apache.org/core/" target="_blank">https://lucene.apache.org/core/</a>. It is an open source project available to download for everyone.</p></div><p>In this chapter, you will learn how to perform a full-text search, what is the syntax, and how to recognize potential issues.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec41"></a>Sending a request</h3></div></div></div><p>In the first section of <span>this</span><a id="id325117165" class="indexterm"></a> chapter, you created your Azure Search instance and saw <strong class="userinput"><code>Search explorer</code></strong>, which enables you to send simple queries. Now, we will extend our requests, so you can select which fields should be used for query analysis, to filter results, and to order by a particular property. Here is the basic URL, which you will use for all of your requests:</p><p><code class="literal">https://handsonazuresearch.search.windows.net/indexes/realestate-us-sample/docs?api-version=2016-09-01&amp;search=*</code></p><p>Of course, it will differ depending on the name of your Azure Search instance, the index name, and the version used. The URL template can be defined as follows:</p><p><code class="literal">https://[service name].search.windows.net/indexes/[index name]/docs?[query parameters]</code></p><p>As you can see, in this example I used <code class="literal">*</code>, which basically means that I am interested in all documents indexed. However, before we proceed, we need to do one more thing—as with most APIs, Azure Search is secured and requires a key to authorize a request. If you do not send it, you will get an <code class="literal">HTTP 403 response</code>. To obtain a key, go to Azure Portal and select the <strong class="userinput"><code>Keys</code></strong> blade:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/05ad81dd-75a1-49e6-9748-27d2a9ac6772.png" /></div><p>Now, with each request to your API, you will have to use the <code class="literal">api-key</code> header with the appropriate value. Here you can find an example:</p><pre class="programlisting">GET /indexes/realestate-us-sample/docs?api-version=2016-09-01&amp;search=* HTTP/1.1
Host: handsonazuresearch.search.windows.net
api-key: 38B4F66ACD480406328C62273C056CA4
Cache-Control: no-cache</pre><p>Nonetheless, in most cases, we are not interested in literally all documents available—we have specific parameters that we would like to use. Let's assume you would like to search for a specific city. In such a case, we have to use another endpoint and pass a valid payload, which will be used to build a query:</p><pre class="programlisting">POST /indexes/realestate-us-sample/docs/search?api-version=2016-09-01 HTTP/1.1
Host: handsonazuresearch.search.windows.net
api-key: {API_KEY}
Content-Type: application/json
Cache-Control: no-cache

{ 
    "search": "Sammamish", 
    "searchFields": "city"
 }</pre><p> </p><p> </p><p>As you can see, I changed the <code class="literal">HTTP</code> method to <code class="literal">POST</code> and used the <code class="literal">/search</code> endpoint for my request. The most important thing, however, is the body—for now, I used two fields:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">search</code>: This is our query string, which we are using to tell Azure Search what we are interested in</li><li style="list-style-type: disc"><code class="literal">searchFields</code>: Here we are passing fields, which should contain our query string</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note72"></a>Note</h3><p>Please remember that the fields passed in the request body are case-sensitive and you should follow camel case if there are multiple words.</p></div><p>If you run the preceding query on the sample index, you should be able to see some results returned. If you search for a city that is not in the indexed documents, you will see an empty result:</p><pre class="programlisting">{
    "@odata.context": "https://handsonazuresearch.search.windows.net/indexes('realestate-us-sample')/$metadata#docs",
    "value": []
}</pre><p>You may ask what are the rules for choosing a search field—the only requirement is that it has to be marked as <code class="literal">Searchable</code>. Take a look at what will happen if I use <code class="literal">beds</code> to search for records with a specific number of them:</p><pre class="programlisting">{
    "error": {
        "code": "",
        "message": "The field 'beds' in the search field list is not searchable.\r\nParameter name: searchFields"
    }
}</pre><p>It seems we cannot use any field we would like to. You can check which fields <span>can</span><a id="id324830087" class="indexterm"></a> be used for searching in the index screen:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/2057489d-a121-4d5c-85af-3a6ded5f8579.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note73"></a>Note</h3><p>In fact, you cannot use any field of the <code class="literal">Edm.Int32</code>typeas<code class="literal">Searchable</code>. There are some other types, which are also not supported (for example,<code class="literal">Edm.GeographyPoint</code>)—you can find information about them when building or modifying fields used in an index.</p></div><p>To overcome the aforementioned problem, you may use filters<strong class="userinput"><code>—</code></strong>these are expressions based on the OData syntax, which you can leverage to search for the entities you are interested in. The only requirement is to make a field you want to use into a filter using filterable. Here you can find all possible fields, which you can use in such an HTTP request:</p><pre class="programlisting">{
  "count": true | false(default),
  "facets": ["facet_expression_1", "facet_expression_2", ...],
  "filter": "odata_filter_expression",
  "highlight": "highlight_field_1, highlight_field_2, ...",
  "highlightPreTag": "pre_tag",
  "highlightPostTag": "post_tag",
  "minimumCoverage": #( % of index that must be covered to declare query successful; default 100),
  "orderby": "orderby_expression",
  "scoringParameters": ["scoring_parameter_1", "scoring_parameter_2", ...],
  "scoringProfile": "scoring_profile_name",
  "search": "simple_query_expression",
  "searchFields": "field_name_1, field_name_2, ...",
  "searchMode": "any" (default) | "all",
  "select": "field_name_1, field_name_2, ...",
  "skip": #(default 0),
  "top": #
}</pre><p>We will not cover them all as this would take this whole chapter, however, we will focus a little more on the actual syntax of queries sent to Azure Search. As you probably remember, this service uses the Lucene search engine to index data and handle requests. Lucene supports a variety of different query types such as fuzzy search, wildcard search, and many more. You can decide which parser should be used by sending the <code class="literal">queryType</code> parameter with <span>one</span><a id="id325128352" class="indexterm"></a> of the available values—simple or full (Lucene).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note74"></a>Note</h3><p>You can find supported query operations by Lucene by reading the following page: <a class="ulink" href="https://docs.microsoft.com/pl-pl/rest/api/searchservice/lucene-query-syntax-in-azure-search" target="_blank">https://docs.microsoft.com/pl-pl/rest/api/searchservice/lucene-query-syntax-in-azure-search</a>.</p></div></div></div>