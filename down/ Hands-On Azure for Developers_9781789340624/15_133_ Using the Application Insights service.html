<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch15lvl1sec127"></a>Using the Application Insights service</h2></div></div><hr /></div><p>One of the most important features when <span>developing</span><a id="id325540809" class="indexterm"></a> applications (especially hosted in the cloud) is the ability to easily monitor them and detect at an early stage any possible issues and flaws. To do so, you need a whole architecture of loggers, storage, and report tools, which you have to integrate, configure, and maintain daily. This requires an additional set of skills in your team and, of course, takes time—the bigger your application is, the more is required. With Azure Application Insights, all those operations are much simpler: you have a single service and endpoint for logging all required information, and the rest is done for you automatically.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec150"></a>Logging data in the cloud</h3></div></div></div><p>Let's assume you have the <span>following</span><a id="id325122058" class="indexterm"></a> architecture:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/ae22e7a3-93f0-4f1f-99d0-40b573dae0a5.png" /></div><p>It contains many different web apps, different storage capabilities (such as a SQL database or Azure Storage), and also Azure Functions. If we want to be able to monitor all those services, we will need the following components:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">A tool for saving logs (which is able to use different outputs such as storage or a file, possibly multiplatform)
</li><li style="list-style-type: disc">Storage able to store gigabytes of log data</li><li style="list-style-type: disc">Some kind of dashboard, which will get data from the storage and display it using different filters and parameters</li></ul></div><p>When you take all those into account, you may find the following caveats:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Storing raw data is not enough as you will need some kind of projections view, which can be quickly fetched and does not require extra transformations or processing.</li><li style="list-style-type: disc">You have to find a way to store data that allows users to query at will with different vectors—appending logs may seem great for checking recent records, but for creating an index of dynamic parameters it is not so good.</li><li style="list-style-type: disc">You have to implement some kind of data retention—most logs have no use after a fixed time period.</li><li style="list-style-type: disc">Performance for both applications and the reporting solution should be repeatable and should not change in time (for example, with the increased amount of data stored).</li><li style="list-style-type: disc">Having a dedicated team for issue tracking may not be the best allocation of resources—people with reporting and data analyzing skills are much more valuable when they work on actual business data.</li></ul></div><p>The ideal solution for the preceding problems would be a single component capable of doing everything we mentioned earlier:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/c60035fb-ea1c-439f-9428-6cc5e912c3e1.png" /></div><p> </p><p> </p><p>In Azure, such a component is Azure Application Insights, which we will cover in this chapter.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec151"></a>Azure Application Insights fundamentals</h3></div></div></div><p>Connecting to the Azure Application <span>Insights</span><a id="id325128288" class="indexterm"></a> service can differ depending on your circumstances. In general, you have multiple possibilities when integrating the service:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Seamless integration within the portal—no additional steps required, you just enable and configure a feature—the rest is already implemented</li><li style="list-style-type: disc">Using an appropriate SDK depending on the platform</li><li style="list-style-type: disc">Sending telemetry events directly to the service endpoints</li></ul></div><p>Depending on the concept you use, a different configuration will be used:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">For the portal, you need no extra steps as you are already authenticated, and a resource can be selected for example from a drop-down menu.</li><li style="list-style-type: disc">For SDK, you need an instrumentation key, which can be found in the portal—we will cover this topic later in this chapter.</li><li style="list-style-type: disc">Using REST APIs, there are different options available, such as App ID, key, or OAuth2 flow .</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip176"></a>Note</h3><p>Note that, depending on the method of logging used, different features and capabilities may be available. This is especially true for sending custom events or custom logging logic—such actions often will require using a dedicated SDK.</p></div><p>Besides some obvious features (such as the ability to log and store information about a request or an exception), Azure Application Insights has many different capabilities implemented:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Requests telemetry</strong></span>: You can <span>automatically</span><a id="id325128369" class="indexterm"></a> gather information regarding the request count, average latency, and failure rates. If using this service, for example, with Azure App Services, you are given full insights into your web application by just implementing the SDK.
</li><li style="list-style-type: disc"><span class="strong"><strong>Dependencies</strong></span>: Besides general telemetry, in <span>Azure</span><a id="id325128382" class="indexterm"></a> Application Insights you can find information about how your dependencies (such as Azure Table Storage and Azure SQL) perform. This is especially true if you have multiple services integrated and you want to know which one affects the latency the most.</li><li style="list-style-type: disc"><span class="strong"><strong>Exceptions</strong></span>: Having <span>information</span><a id="id325143080" class="indexterm"></a> about failed requests or dependencies is one thing, but a detailed dashboard displaying aggregated data about errors is a much more useful thing. In Azure Application Insights, you can easily check which type of error is connected to some specific subset of requests. This gives you a much better understanding of what is going on under the hood in your application and where to start fixing it.</li><li style="list-style-type: disc"><span class="strong"><strong>User telemetry</strong></span>: Do you want to know exactly how many users you have? Are you interested in what the flow is when they use your application? In Azure Application Insights, there are additional features that give you <span>information</span><a id="id325143094" class="indexterm"></a> about user and session counts, their behavior, and overall activities.</li></ul></div><p>Of course, I have not listed all the available features—there are even more, such as gathering information regarding AJAX calls, page view, and web performance; performance counters (for VMs), and host diagnostics from Docker. In fact, the availability of a feature also depends on the service you have chosen—a different telemetry is gathered for Azure Functions and for Azure App Services.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip177"></a>Note</h3><p>In reality, you can achieve the same level of granularity of your logs<span class="emphasis"><em> </em></span>with similar charts and diagnostics available in most services. What changes is the level of effort required—the less integration a service has with Azure Application Insights, the more you have to do on your own.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec152"></a>Creating Azure Application Insights in the portal</h3></div></div></div><p>To create an instance of Azure <span>Application</span><a id="id325143120" class="indexterm"></a> Insights, you have to search for the service in the marketplace.</p><p>You will have to fill in the following simple form to proceed:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/1e66332d-8edc-4522-ac37-f9a22e2b235b.png" /></div><p>In fact, it contains one field that you probably have not met yet:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Application Type</code></strong>: Depending on your choice (<strong class="userinput"><code>ASP.NET web application</code></strong>, <strong class="userinput"><code>Java</code></strong>, <strong class="userinput"><code>App Center</code></strong>, <strong class="userinput"><code>Node.js</code></strong>, or <strong class="userinput"><code>General</code></strong>), a different set of charts will be selected. This option does not affect the available features of a service. Rather, it ensures that, for a specific instance, you will see only the information you are most interested in.</li></ul></div><p>The rest of what your instance is capable of depends solely on the services integrated with it and the amount of data sent to it. </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip178"></a>Note</h3><p>Unlike most Azure services, in Azure Application Insights there is no requirement to have a unique service name for all instances globally—here you just cannot use the same name for multiple services within a service. This is because it does not use a DNS name to work and connect with other applications.</p></div><p> </p><p>When you click <strong class="userinput"><code>Create<span class="strong"><strong>,</strong></span> </code></strong>it should not take long to provision a new instance of a service, which should look similar to the following:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/2d263b6f-ea6a-4235-b765-66d1414b155d.png" /></div><p>As you can see, there is the <strong class="userinput"><code>Essentials </code></strong>section, hidden by default—it contains some common metadata and, what is more important, an instrumentation key— and an identifier, which uniquely identifies your instance of your service. We will use it to actually connect to Azure Application Insights—the rest of the feature will be described later in this chapter.</p></div></div>