<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec36"></a>Clusters in SF</h2></div></div><hr /></div><p>We have talked about clusters in SF, but how <span>can </span><a id="id325115399" class="indexterm"></a>you really understand such a concept in that <span>service?</span><span>You probably remember that, during the creation of a cluster, we had to choose both node types and their characteristics—the number of VMs and their type. If you choose to have three nodes with five machines in each one, you will end up with a cluster of fifteen machines in total. SF automatically balances it, so if you are changing its size, all services will be redeployed to achieve maximum utilization. In this chapter, we will talk a little about security, available features, and scalability.</span></p><p><span><span>The following is a conceptual diagram of a cluster organization:</span></span><a id="id324830075" class="indexterm"></a><span></span></p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/a1abf934-b5c4-4cdb-ac31-2a72ff759b13.png" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec35"></a>Cluster security</h3></div></div></div><p>If you go back to the creation of a cluster, you will notice <span>that</span><a id="id326400040" class="indexterm"></a> we always had to create or import a certificate—without it, there was no way to proceed. You have to remember that it is your responsibility to secure your environment and prevent unauthorized access. As the documentation states, it is impossible to create an insecure cluster—this is, of course, true. However, if you expose your endpoint (especially in production workloads) publicly, there is always the possibility <span>that</span><a id="id326400049" class="indexterm"></a> somebody will figure it out and start abusing it.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl3sec31"></a>Node-to-node security</h4></div></div></div><p>Let's assume <span>that</span><a id="id326400062" class="indexterm"></a> you have three different nodes for different types of workload:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/64240c87-1227-474d-a30e-791a379a0db5.png" /></div><p> </p><p>Those nodes could be exposed (or not exposed) to the external network. Now, you may wonder how SF ensures that communication is handled in a secure manner. In fact, there are two possibilities:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Certificate security</strong></span>: In such a scenario, a client (node) attaches <span>credentials</span><a id="id326400313" class="indexterm"></a> to each request and signs a message with the private key</li><li style="list-style-type: disc"><span class="strong"><strong>Windows security</strong></span>: Based on the <span>Kerberos</span><a id="id325120024" class="indexterm"></a> protocol</li></ul></div><p>The final solution depends on your actual needs.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl3sec32"></a>Client-to-node security</h4></div></div></div><p>Besides communicating within a cluster, you <span>may</span><a id="id325120041" class="indexterm"></a> need to allow authorized users to exchange messages with individual nodes. In fact, this is cover by similar security options as <span class="strong"><strong>node-to-node </strong></span>security—here you can choose between certificates and <span class="strong"><strong>Active Directory</strong></span> (<span class="strong"><strong>AD</strong></span>) security. What is the <span>advantage</span><a id="id325122104" class="indexterm"></a> of using AD in that scenario? There is one very important aspect—in most cases, you do not want to share certificates with your client (this could also be cumbersome with a large number of them). AD security can be set in the ARM template by providing additional options:</p><pre class="programlisting">"azureActiveDirectory": {
  "tenantId": "&lt;guid&gt;",
  "clusterApplication": "&lt;guid&gt;",
  "clientApplication": "&lt;guid&gt;"
}</pre></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec36"></a>Scaling</h3></div></div></div><p>Scaling is one of the most important features of SF as the <span>microservices</span><a id="id325124990" class="indexterm"></a> architecture is all about being able to scale out when you need and preserving a stable environment while doing so. In most cases, you will need to scale horizontally (by getting more machines running your workloads) but, of course, it is also possible to scale vertically (so more powerful machines become available and, in some scenarios, it is a better option than scaling out). In general, the answer to whether you need to scale out or up depends on the work your code needs to do:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">If your work can be parallelized, choose to scale out</li><li style="list-style-type: disc">If your work performs many calculations and is I/O-heavy and such actions cannot be distributed, choose to scale out</li></ul></div><p>What is more, each node type in SF is a separate VM scale set. That means that you can scale your nodes independently, according to your needs. This is a very important feature—you probably would not appreciate, if only one part of your system requires more computing power, having to update the whole cluster. </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip66"></a>Note</h3><p>In SF, each node has specific requirements when it comes to scaling, as it is important to keep the correct number of nodes running production workloads. Details can be found in the documentation; you can find a link to it in the <span class="emphasis"><em>Further reading</em></span><span class="strong"><strong> </strong></span>section at the end of this chapter.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl3sec33"></a>Scaling a cluster up or down</h4></div></div></div><p>In general, it is not recommended to scale a cluster up or down, as it is a <span>dangerous</span><a id="id325128272" class="indexterm"></a> operation (especially if you would like to change the VM SKU of the primary node). If you wonder why, please consider the following operation—you are about to scale down a node. This is an infrastructure operation, which requires changing available hardware for your application. If you do not monitor and orchestrate all operations correctly, you may end up with your stateful services losing data (for example, you temporarily lost access to a database) and even stateless services may become unstable. In fact, to scale up or down in a secure fashion, you should first create a new node type, and then gradually reduce the instance count of the old one, so SF is able to distribute the workload correctly before the old node is shut down.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note67"></a>Note</h3><p>The SF documentation states that it is highly inadvisable to change the SKU of VMs running a primary node. However, it is, of course, possible when done carefully; you can find a link to instructions in the <span class="emphasis"><em>Further reading</em></span><span class="strong"><strong> </strong></span>section at the end of this chapter.</p></div></div></div></div>