<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch18lvl1sec153"></a>Scaling Azure App Services</h2></div></div><hr /></div><p>We started our journey through Microsoft <span>Azure</span><a id="id325117195" class="indexterm"></a> by learning some basics of Azure App Services. This is a very common PaaS component, which is widely used amongst many Azure users, both for very simple websites and complex systems requiring high performance and reliability. To make sure that your Web App is always on, or to check if it is under pressure, you have to implement some kind of scaling rules. When it comes to this service, you have two options—either using manual scaling (and implementing some kind of alert, so that you know when such action should happen), or an autoscale feature, which makes things much easier in terms of maintenance. In this section, we will cover and compare both of them.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch18lvl2sec186"></a>Manual scaling</h3></div></div></div><p>Manual scaling is a feature that is <span>available</span><a id="id325117160" class="indexterm"></a> starting from the basic tier—it is not available for free or shared ones. Depending on the actual tier chosen, there will be a different amount of instances that can be used for your App Service.</p><p> </p><p>Here you can find how things look like for the B2<span class="strong"><strong> </strong></span>tier:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/c602dfeb-9aeb-43f6-b0bd-427a6aa8ee7d.png" /></div><p>In the preceding configuration, the maximum number of instances available is set to three. However, if I scale up to the standard<span class="strong"><strong> </strong></span>tier the result is as follows:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/f2123936-7c6c-4ec4-b1ab-be9f5fe90c15.png" /></div><p>Things look quite different—two features have changed:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>I can set the <strong class="userinput"><code>Instance count </code></strong>to the <span>maximum</span><a id="id325115432" class="indexterm"></a> number of <strong class="userinput"><code>10</code></strong></li><li>Autoscaling can be enabled</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip210"></a>Note</h3><p>Note that scaling up to the premium tier will allow you to set the maximum number of 20 instances for your App Service.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch18lvl2sec187"></a>Autoscaling</h3></div></div></div><p>While manual scaling can be fine for less <span>demanding</span><a id="id324830070" class="indexterm"></a> websites and systems (as they do not require quick actions when something happens), when your application is, for example, a popular e-commerce shop, you want things to happen quickly, including scaling out. Let us try to enable autoscaling for now—it will display a form that enables you to manage these settings:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/b19ca30d-8e99-4a98-beaf-4bc3c0c24d3a.png" /></div><p>In fact, you have two options here:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><strong class="userinput"><code>Scale based on a metric</code></strong>: Allows you to select a metric, which will be a trigger for autoscaling</li><li><strong class="userinput"><code>Sc</code></strong><strong class="userinput"><code>ale to a specific instance count</code></strong>: Executed by default (so should be used along with scaling based on a metric)</li></ol></div><p>To configure <strong class="userinput"><code>scale based on a metric</code></strong>, you will need a rule. You can add this by clicking on the <strong class="userinput"><code>+</code></strong><strong class="userinput"><code>Add a rule</code></strong><span class="strong"><strong> </strong></span>link. Doing so will display another form (which is far more complex than the current one), where you can select all that is interesting for you:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/710d2a8e-53d4-4701-a1db-9a45cda15542.png" /></div><p>In the preceding screenshot, you can see a rule that <span>will</span><a id="id325128282" class="indexterm"></a> trigger autoscaling when CPU utilization exceeds 70% over a 10 minute period. Once all conditions are met, the runtime will add another instance to the App Service. What is more, if the conditions are true after another 5 minutes (<strong class="userinput"><code>Cool down (minutes)</code></strong><span class="strong"><strong> </strong></span>period), the scaling out operation will be triggered once more. This will happen as long as the maximum number of instances, which you have set, are hit.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip211"></a>Note</h3><p>Remember that you can set more than a single rule for your application. What is more, it seems like a good idea to create a decreasing count by rule, which will remove additional instances if the load gets back to normal.</p></div><p>Once your rule is added, you can click <strong class="userinput"><code>Save </code></strong>to confirm your changes—now your application will be scaled out anytime a rule is considered active. Before we go further, I would like to show you two more things. You probably noticed two additional sections on the <strong class="userinput"><code>Scale-out</code></strong><span class="strong"><strong> </strong></span>blade, <strong class="userinput"><code>JSON </code></strong>and <strong class="userinput"><code>Notify</code></strong>. They give you some additional options when it comes to managing a service:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>JSON</code></strong>:<span class="strong"><strong> </strong></span>This generates a JSON template, which can be used with ARM Templates for automatic provisioning of your resource. It will automatically add scaling rules when a service is created.</li><li style="list-style-type: disc"><strong class="userinput"><code>Notify</code></strong>: This enables you to automatically send a notification to administrators of the resource in Azure, to notify them when something wrong happens there.</li></ul></div><p>Here you can find a JSON, which was generated for my rules:</p><pre class="programlisting">{
    "location": "West Europe",
    "tags": {
        "$type": "Microsoft.WindowsAzure.Management.Common.Storage.CasePreservedDictionary, Microsoft.WindowsAzure.Management.Common.Storage"
    },
    "properties": {
        "name": "handsonazure-euw-webapp-autoscale",
        "enabled": true,
        "targetResourceUri": "/subscriptions/1a2d5d1c-dee5-4deb-a93a-366cc83feb46/resourceGroups/handsonazure-euw-rg/providers/Microsoft.Web/serverfarms/handsonazure-euw-appserviceplan",
        "profiles": [
            {
                "name": "Auto created scale condition",
                "capacity": {
                    "minimum": "1",
                    "maximum": "10",
                    "default": "1"
                },
                "rules": [
                    {
                        "scaleAction": {
                            "direction": "Increase",
                            "type": "ChangeCount",
                            "value": "1",
                            "cooldown": "PT5M"
                        },
                        "metricTrigger": {
                            "metricName": "CpuPercentage",
                            "metricNamespace": "",
                            "metricResourceUri": "/subscriptions/1a2d5d1c-dee5-4deb-a93a-366cc83feb46/resourceGroups/handsonazure-euw-rg/providers/Microsoft.Web/serverFarms/handsonazure-euw-appserviceplan",
                            "operator": "GreaterThan",
                            "statistic": "Average",
                            "threshold": 70,
                            "timeAggregation": "Average",
                            "timeGrain": "PT1M",
                            "timeWindow": "PT10M"
                        }
                    }
                ]
            }
        ],
        "notifications": [],
        "targetResourceLocation": "West Europe"
    },
    "id": "/subscriptions/1a2d5d1c-dee5-4deb-a93a-366cc83feb46/resourceGroups/handsonazure-euw-rg/providers/microsoft.insights/autoscalesettings/handsonazure-euw-webapp-autoscale",
    "name": "handsonazure-euw-webapp-autoscale",
    "type": "Microsoft.Insights/autoscaleSettings"
}</pre></div></div>