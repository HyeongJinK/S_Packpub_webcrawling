<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch18lvl1sec154"></a>Scaling Azure Functions</h2></div></div><hr /></div><p>When using PaaS services, you can configure how your application <span>will</span><a id="id325125015" class="indexterm"></a> behave when CPU utilization hits the maximum allowed value, or the number of requests exceeds the threshold. However, Azure offers services in other models—one of the most interesting is serverless architecture, which abstracts the control even more in favor of easier configuration, minimum maintenance, and ability to focus on delivering a business value.</p><p>In this section, you will see the differences between Azure App Services and Azure Functions when it comes to scaling, both from the technical and conceptual point of view.</p><p> </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch18lvl2sec188"></a>Scaling serverless applications</h3></div></div></div><p>When you are using serverless services (such as <span>Azure</span><a id="id325124994" class="indexterm"></a> Functions, Azure Cosmos DB, or Azure Event Grid) you have limited options when it comes to configuring the feature. For example:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">In Azure Functions, you rely on the pricing model (consumption plan vs App Service Plan)</li><li style="list-style-type: disc">In Azure Cosmos DB you modify the number of RUs</li><li style="list-style-type: disc">In Azure Event Grid you have no way to define how the service will scale</li></ul></div><p>This is all caused by the fact that you do not control the application host—the underlying service engine is completely detached from your application and there is no possibility to directly modify it. What you can do is to control it indirectly, either by changing the number of processing units or via available configuration options, which can be interpreted and applied.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip212"></a>Note</h3><p>Note that serverless is meant to be a model where you are isolated from the runtime (and, in some cases, even from the cloud vendor). If the lack of control does not play well for you, it is better to try PaaS or IaaS models and services.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch18lvl2sec189"></a>Scaling Azure Functions</h3></div></div></div><p>In Azure Functions, there is no possibility to scale up, at least for the consumption plan. Of course, when using the App Service Plan, you can scale it up and get better hardware, but it does not affect the service itself. Instead it creates more resources to consume. On the other hand, you cannot scale out manually. The only possibility is to let Azure Functions scale automatically. To do so, this service implements the concept of a scale controller. This is an internal feature that constantly monitors how particular workers hosting the Function's runtime behave, and if one of them seems to be overloaded, another machine is added to the set.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note213"></a>Note</h3><p>Azure Functions scaling behavior is quite sophisticated and only partially described, as it contains parts that are either open sourced, or not available publicly. I will try to describe it in detail in this chapter, so you are aware of the exact algorithm of making a scaling decision.</p></div><p>Before your instance of <span>Azure</span><a id="id325120039" class="indexterm"></a> Functions will make a scaling decision, it will check the following:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><span class="strong"><strong>Scaling interval</strong></span>: Scaling only happens after a specific interval has passed.</li><li><span class="strong"><strong>Current workers number</strong></span>: If the number of workers (running the function's hosts) exceeds the configured maximum, a decision will be made to remove one from the working set.</li><li><span class="strong"><strong>Load factor</strong></span>: If the load factor approaches the maximum value, a new worker will be added. Alternatively, if the load factor drops, one worker will be removed.</li><li><span class="strong"><strong>Busy worker ratio</strong></span>: If the number of busy workers exceeds the configured maximum, another worker will be added to the set.</li><li><span class="strong"><strong>Free workers</strong></span>: If the number of free workers is greater than the defined maximum, one of them will be removed from the working set.</li></ol></div><p>Defined values for above actions can be found as follows:</p><pre class="programlisting">public const int DefaultMaxWorkers = 100;
public const int DefaultBusyWorkerLoadFactor = 80;
public const double DefaultMaxBusyWorkerRatio = 0.8;
public const int DefaultFreeWorkerLoadFactor = 20;
public const double DefaultMaxFreeWorkerRatio = 0.3;
public static readonly TimeSpan DefaultWorkerUpdateInterval = TimeSpan.FromSeconds(10);
public static readonly TimeSpan DefaultWorkerPingInterval = TimeSpan.FromSeconds(300);
public static readonly TimeSpan DefaultScaleCheckInterval = TimeSpan.FromSeconds(10);
public static readonly TimeSpan DefaultManagerCheckInterval = TimeSpan.FromSeconds(60);
public static readonly TimeSpan DefaultStaleWorkerCheckInterval = TimeSpan.FromSeconds(120);</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note214"></a>Note</h3><p>The above values come from the GitHub repository of Azure Functions Host. They may be changed after a while, but if you are interested, take a look at the following project: <a class="ulink" href="https://github.com/Azure/azure-functions-host" target="_blank">https://github.com/Azure/azure-functions-host</a></p></div><p>Additionally, you can control the maximum number of instances by providing the <code class="literal">WEBSITE_MAX_DYNAMIC_APPLICATION_SCALE_OUT</code> value in the <strong class="userinput"><code>Application settings</code></strong><span class="strong"><strong> </strong></span>of your Function App:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/116999d1-7c37-41ca-8f83-16fc04b997eb.png" /></div><p>What is more, if you connect the instance of your Function App to an instance of Azure Application Insights, you will be able to check how many workers it has by checking the <strong class="userinput"><code>Live Metrics Stream</code></strong><span class="strong"><strong> </strong></span>feature:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/f4d0b80f-6c0e-452d-8d1a-48c71208719d.png" /></div></div></div>