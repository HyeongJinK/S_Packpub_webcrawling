<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch12lvl1sec105"></a>Azure Event Hub security</h2></div></div><hr /></div><p>We have covered some topics regarding working with and developing applications using Azure Event Hub – now it is time to learn something more about the security features of this service. In the previous part of this chapter, you used shared access policies, which are the easiest options when you want to restrict access to a hub to some predefined operations (such as listening to events, sending them, or managing Event Hub). Now I will show <span>you</span><a id="id325544308" class="indexterm"></a> something more about the security model and restricting access to the whole namespace by IP filtering.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec127"></a>Event publishers</h3></div></div></div><p>When creating an Event Hub namespace instance, you had to choose a tier – you could choose between Basic<span class="strong"><strong> </strong></span>and Standard<span class="strong"><strong> </strong></span>tier. Besides features such as consumer groups or message retention, Standard<span class="strong"><strong> </strong></span>tier offers one more thing—the ability to create event publishers. An event publisher<span class="strong"><strong> </strong></span>acts as a virtual endpoint for sending messages to a hub. In fact, it enhances security by combining an SAS token with the <span>identity</span><a id="id325346333" class="indexterm"></a> of a sender. To generate a token, you have to use the following method:</p><pre class="programlisting">public static string SharedAccessSignatureTokenProvider.GetSharedAccessSignature(string keyName, string sharedAccessKey, string resource, TimeSpan tokenTimeToLive)</pre><p>To execute it correctly, you will need:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Key name</strong></span>: the name of an SAS policy</li><li style="list-style-type: disc"><span class="strong"><strong>Shared access key</strong></span>: the key generated for a policy</li><li style="list-style-type: disc"><span class="strong"><strong>Resource</strong></span>: the URL to a namespace in the following format: <code class="literal">sb://&lt;NAMESPACE&gt;.servicebus.windows.net/&lt;EVENT_HUB_NAME&gt;/publishers/&lt;PUBLISHER_NAME&gt;</code></li><li style="list-style-type: disc"><span class="strong"><strong>Token lifetime</strong></span>: how long a token will be valid</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip156"></a>Note</h3><p>Remember that <code class="literal">PUBLISHER_NAME</code> should be unique for each client.</p></div><p>When you generate a token, it will be in the following format:</p><pre class="programlisting">SharedAccessSignature sr=%2f%2fZvZExXejq40LO5vmRIikSpWLn9YlKMZ5cwC2Nk83%2bnE%3d.servicebus.windows.net%2fhandsonazurehub%2fpublishers%2fhandsonazurepublisher&amp;sig=UraqQnVck9O64h3pd8dcX9KdZZa2rb%2bxfR%2blyod2Ep2Q%3d&amp;se=1535279857&amp;skn=handsonazuresend</pre><p>To be able to actually use it, you will have to use <code class="literal">EventHubSender</code><span class="strong"><strong> </strong></span>instead of <code class="literal">EventHubClient</code>:</p><pre class="programlisting">private static EventHubSender CreateSender()
{
  var publisher = "handsonazurepublisher";
  var token = SharedAccessSignatureTokenProvider.GetSharedAccessSignature(KeyName, SASKey,
    $"sb://{Namespace}.servicebus.windows.net/{HubName}/publishers/{publisher}", TimeSpan.FromHours(24));
  var connectionString =
    ServiceBusConnectionStringBuilder.CreateUsingSharedAccessSignature(
      new Uri($"sb://{Namespace}.servicebus.windows.net"), HubName, publisher, token);
  var eventHubSender = EventHubSender.CreateFromConnectionString(connectionString);
  return eventHubSender;
}</pre><p>This is because when using event publishers <span>you</span><a id="id325120009" class="indexterm"></a> can only send events—they cannot be used for other Event Hub operations. </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip157"></a>Note</h3><p>Note that clients, in general, should not be aware of additional features that such generated SAS tokens supply. The most important thing is that they should not be generated by them; instead, you should introduce a service in which they can ask for a full connection string and use it.</p></div><p>Now, when you have control over who or what can access Azure Event Hub, there is one more thing you can do—revoke publisher, so it cannot access a hub anymore. To do so, you will need the following methods:</p><pre class="programlisting">var nsm = NamespaceManager.CreateFromConnectionString(manageString);
nsm.RevokePublisher(eventHubName, publisherId);</pre><p>Once you revoke a publisher, when it tries to send an event, it will receive <code class="literal">PublisherRevokedException</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec128"></a>IP filters</h3></div></div></div><p>It is possible to restrict access to Azure Event Hub by introducing IP filters; this feature (as shown next) allows <span>you</span><a id="id325120043" class="indexterm"></a> to secure the whole namespace by knowing which IP addresses should be rejected. By default, the IP filter is empty, that means that Event Hub accepts any connection (so this is equivalent to setting it as approve <code class="literal">0.0.0.0/0</code> IP address):</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/0c8f2151-6d1c-4fb0-a973-94cf57a3d6ee.png" /></div><p>You can easily create a rule by clicking on <strong class="userinput"><code>+ Add IP Filter Rule</code></strong><span class="strong"><strong>:</strong></span></p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/82e2792f-8b00-4b37-80e5-9d809f303b64.png" /></div><p>When I restrict access to my computer's IP, I will get the following message when I try to send an event:</p><pre class="programlisting">25.08.2018 13:11:39 &gt; Sending message: 0a7dd971-6600-458c-816d-fbbbee0d81cb
25.08.2018 13:11:40 &gt; Exception: Ip has been prevented to connect to the endpoint. TrackingId:9421f06c-3a1c-4e4e-8a25-fb76f1cacee6, SystemTracker:AmqpGatewayProvider, Timestamp:8/25/2018 11:11:36 AM</pre><p>You can choose to either restrict access from some specific IP addresses or allow a particular subset. </p></div></div>