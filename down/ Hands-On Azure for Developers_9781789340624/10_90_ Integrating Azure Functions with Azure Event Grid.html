<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec89"></a>Integrating Azure Functions with Azure Event Grid</h2></div></div><hr /></div><p>The last thing that we'll cover for Azure Event <span>Grid</span><a id="id325128281" class="indexterm"></a><span class="emphasis"><em> </em></span>is integration with Azure Functions. As <span>mentioned</span><a id="id325125014" class="indexterm"></a> earlier, if you use Event Grid<span class="emphasis"><em> </em></span>to publish events to Azure Functions triggered by an HTTP trigger, you will have to validate an endpoint. This is not the best solution, but fortunately, it is possible to use <code class="literal">EventGridTrigger</code>, which allows us to skip the endpoint validation step when configuring services. This topic itself is quite big, so we will not cover each and every problem possible; however, I will point you to the specific parts of the documentation, which will help you understand the topic even better.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec102"></a>EventGridTrigger in Azure Functions</h3></div></div></div><p>In general, the easiest way to integrate Azure <span>Functions</span><a id="id325125005" class="indexterm"></a><span class="emphasis"><em> </em></span>with Azure Event Grid<span class="emphasis"><em> </em></span>is to use <code class="literal">HttpTrigger</code>:</p><pre class="programlisting">[FunctionName("HttpTriggerCSharp")]
public static async Task&lt;HttpResponseMessage&gt; Run(
    [HttpTrigger(AuthorizationLevel.Function, "get", "post", Route = null)]HttpRequestMessage req, 
    TraceWriter log)
{
    (...)
}</pre><p> </p><p> </p><p> </p><p> </p><p>This is the most generic setup. It provides direct access to a request message and enables you to control its specific parts. There is, however, an alternative to the preceding setup—we can instead use <code class="literal">EventGridTrigger</code>:</p><pre class="programlisting">[FunctionName("EventGridTriggerCSharp")]
public static void Run([EventGridTrigger]JObject eventGridEvent, TraceWriter log)
{
  log.Info(eventGridEvent.ToString(Formatting.Indented));
}</pre><p>With <code class="literal">EventGridTrigger</code> here, you can directly access the payload of a request, which is pretty useful if you are not interested in the remaining part of it. Additionally, you do not have to validate an endpoint. The preceding function can be used a bit differently if you use version 2 of the Azure Functions<span class="emphasis"><em> </em></span>runtime:</p><pre class="programlisting">[FunctionName("EventGridTest")]
public static void EventGridTest([EventGridTrigger]EventGridEvent eventGridEvent, TraceWriter log)
{
  log.Info(eventGridEvent.Data.ToString());
}</pre><p>As you can see, instead of binding to <code class="literal">JObject</code><span class="strong"><strong> </strong></span>here, you can access a well defined <code class="literal">EventGridEvent</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip136"></a>Note</h3><p>It is possible to use <code class="literal">EventGridEvent</code><span class="strong"><strong> </strong></span>even with version 1 of the Azure Functions<span class="emphasis"><em> </em></span>runtime. To do so, you have to manually reference <code class="literal">Microsoft.Azure.EventGrid.Models.EventGridEvent</code> by installing the <code class="literal">Microsoft.Azure.EventGrid</code> NuGet package. </p></div><p>You can easily create a function triggered by Event Grid<span class="emphasis"><em> </em></span>using Azure Portal, as follows:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/f2907f7b-e16c-49c0-85c3-1e71ceb0fc3b.png" /></div><p>After creating the function, you will see a code snippet from where you can start working on the function. The important thing is to add the Event Grid subscription, which you will have to use to integrate the function with Azure Event Grid:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/58799f13-fb17-48b2-a27f-b5a3cbdcfa98.png" /></div><p> </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note137"></a>Note</h3><p>The generated code depends on the runtime version of your Function App—in my example, I used version 1, so I used <code class="literal">JObject</code> instead of <code class="literal">EventGridEvent</code>.</p></div><p>When you click on it, you will see a form that you can fill to create a subscription. In fact, it is very similar to the form you saw previously when creating a subscription from within the Event Grid<span class="emphasis"><em> </em></span>instance:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/d7c7c7a9-7350-438b-b099-e689500d18e5.png" /></div><p>The only difference is that some fields are filled automatically. After creation of a subscription, you can test it by sending, for example, a custom event to Event Grid. What is more, a newly <span>created</span><a id="id325117136" class="indexterm"></a> subscription should be visible on the <strong class="userinput"><code>Overview</code></strong><span class="strong"><strong> </strong></span>blade of your Azure Event Grid<span class="emphasis"><em> </em></span>instance:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/d58f7ec9-bf2e-4bfe-9c04-4fa1092e64b1.png" /></div><p> </p><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec103"></a>Testing Azure Event Grid and Azure Functions</h3></div></div></div><p>You are probably thinking about the options for testing Azure Event <span>Grid</span><a id="id325120003" class="indexterm"></a><span class="emphasis"><em> </em></span>and Azure Functions<span class="emphasis"><em> </em></span>locally. In fact, currently, you have two ways of doing this:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Capturing and resending events to your application</li><li style="list-style-type: disc">Using ngrok, available at <a class="ulink" href="https://ngrok.com/" target="_blank">https://ngrok.com/</a>, to forward requests to your local computer</li></ul></div><p>Which of these methods you choose will depend on your capabilities (for example, ngrok exposes your computer's port, so it can be a security concern), so you will have to figure out by yourself what the best option is. Both methods are described in the link mentioned in the <span class="emphasis"><em>Further reading</em></span><span class="strong"><strong> </strong></span>section. However, there is one interesting feature of Azure Functions, which can be used to test Event Grid locally. It can be found under the following endpoint:</p><pre class="programlisting">http://localhost:7071/admin/extensions/EventGridExtensionConfig?functionName={functionname} </pre><p>Here you can find an example request:</p><pre class="programlisting">POST /admin/extensions/EventGridExtensionConfig?functionName=Function1 HTTP/1.1
Host: localhost:7071
Content-Type: application/json
aeg-event-type: Notification
Cache-Control: no-cache

[
  {
    "subject": "example",
    "id": "1",
    "eventType": "SectionFinished",
    "eventTime": "2018-08-12T07:41:00.9584103Z",
    "data":{
      "section": 3
    },
    "dataVersion": "1",
  }
]</pre><p>Note one important thing here—you have to set <code class="literal">aeg-event-type</code> to <code class="literal">Notification</code>. If you fail to do so, you will receive an <code class="literal">HTTP 400</code> response. With such a setup, you can emulate how your function will behave when deployed to Azure. </p><p> </p><p> </p></div></div>