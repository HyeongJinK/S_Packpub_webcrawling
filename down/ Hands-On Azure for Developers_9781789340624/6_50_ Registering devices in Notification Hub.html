<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec53"></a>Registering devices in Notification Hub</h2></div></div><hr /></div><p>To be able to actually <span>send</span><a id="id325120001" class="indexterm"></a> a notification, you have to register a device in the PNS. Without using a service such as Notification Hub, you would have to know the individual logic of each PNS and storage device data somewhere. Such a challenge would be problematic in most cases, as usually you do not want to handle external dependencies by yourself; rather, your aim is to simplify the overall system logic. In this section, you will learn how device registration is handled in Notification Hub and how to monitor it.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec49"></a>Notification Hub device registration</h3></div></div></div><p>When you register a <span>device</span><a id="id325117165" class="indexterm"></a> in Notification Hub, you are actually associating it with a template of a notification and tag. To create such a link, you need a PNS handle, which can be understood as an identifier of a specific vendor (such as a token or GCM registration ID). In fact, there are two ways to register a device:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Use registration</strong></span>: Where <span>you</span><a id="id325117142" class="indexterm"></a> pass an identifier, tag, and template</li><li style="list-style-type: disc"><span class="strong"><strong>Use installation</strong></span>: An enhanced registration <span>with</span><a id="id325115456" class="indexterm"></a> an additional set of push-related properties</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note83"></a>Note</h3><p>Please note that, currently, if you want to use installation, there is no possibility to use a .NET SDK—you are limited to using the REST API of a service.</p></div><p>We have to also describe what tags and templates are to fully understand the process:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Tag</strong></span>: This is a way to <span>route</span><a id="id325115433" class="indexterm"></a> a notification to a particular set of (or all) registered devices. It allows you to segment users, so you can easily decide who is an addressee of a message; you can use, for example, <code class="literal">version_Beta</code> to send a notification to a limited group of devices using a preview version of your application.</li><li style="list-style-type: disc"><span class="strong"><strong>Template</strong></span>: This is a <span>particular</span><a id="id325631059" class="indexterm"></a> schema of data designed to be sent to a client application. It differs depending on the PNS used and varies from JSON data to XML documents. By using Notification Hub, you can create a platform-agnostic template, which can be reused between different platforms.</li></ul></div><p>Now we will try registering a device using both methods and understand the differences between them.</p><p> </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec37"></a>Creating a Notification Hub</h4></div></div></div><p>Before we start sending notifications, we have to <span>have</span><a id="id325143108" class="indexterm"></a> a notification service provisioned and working. To create a Notification Hub instance, go to the portal and click on the <strong class="userinput"><code>+ Create a resource</code></strong> button. Search for <strong class="userinput"><code>Notification Hub</code></strong> and click <strong class="userinput"><code>Create</code></strong>. Here, you can see a completed configuration:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/e2a41f2b-182d-41a8-945d-1f9a928a3f2a.png" /></div><p> </p><p> </p><p>As you can see, there is nothing unexpected on that screen—the only things that need clarification are <strong class="userinput"><code>Pricing tier</code></strong> and <strong class="userinput"><code>Namespace</code></strong>:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Namespace</code></strong>: You can have multiple Notification Hubs inside the same namespace. A namespace is a logical container for your hubs and holds the limit of available pushes for them.</li><li style="list-style-type: disc"><strong class="userinput"><code>Pricing tier</code></strong>: Depending on the selected tier (<strong class="userinput"><code>Free</code></strong>, <strong class="userinput"><code>Basic</code></strong>, or <strong class="userinput"><code>Standard</code></strong>) you will have different features available and a different number of available pushes for your hubs. Additionally, it defines the price of extra pushes and the number of active devices. What is more, the <strong class="userinput"><code>Standard</code></strong> tier comes with handy enterprise features such as multi-tenancy or scheduled push.</li></ul></div><p>For the purpose of this exercise, the <strong class="userinput"><code>Free</code></strong> tier will be more than enough. Once you are satisfied with your configuration, click on the <strong class="userinput"><code>Create</code></strong> button and wait a second for service creation. When it is created, you can go to its page where you will see an <strong class="userinput"><code>Overview</code></strong> blade:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/a119f452-9f8e-47ef-a630-b9007bd96d58.png" /></div><p>There, you can click on the hub you created to see its features. We will cover them later in this chapter.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec38"></a>Registering in an application</h4></div></div></div><p>In this section, we will try to <span>perform</span><a id="id325310855" class="indexterm"></a> a registration using a UWP application in Visual Studio. To get started, open the <code class="literal">HandsOnAzureApp</code> project from the source code for this chapter—you should see a blank UWP application with boilerplate code in it.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note84"></a>Note</h3><p>We will use a UWP application here because it is the easiest way to get started and work with Notification Hub. However, if you are a mobile developer, you can use any kind of project you want.</p></div><p>To get started with registration, you will have to install a package to work with Notification Hub—use the NuGet package manager and search for the <code class="literal">WindowsAzure.Messaging.Managed</code> package, which holds all of the components required for this particular exercise. In the <code class="literal">App.xaml.cs</code> file, you will have to add the following code:</p><pre class="programlisting">private async void RegisterADevice()
{
  var channel = await PushNotificationChannelManager.CreatePushNotificationChannelForApplicationAsync();
  var hub = new NotificationHub("&lt;hub-name&gt;", "&lt;connection-string&gt;");
  var result = await hub.RegisterNativeAsync(channel.Uri);

  if (result.RegistrationId == null) return;

  var dialog = new MessageDialog("Registration successful: " + result.RegistrationId);
  dialog.Commands.Add(new UICommand("OK"));
  await dialog.ShowAsync();
}</pre><p>What we are doing here can be described as follows:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>We are creating a notification channel to be used for a registration</li><li>We are defining a hub, which we will use to handle notifications and registrations</li><li>We are registering a device and displaying a dialog if an operation was successful</li></ol></div><p>You may wonder how to obtain the connection string used for the communication; to get it, go to Azure Portal, select your Notification Hub namespace and click on the <strong class="userinput"><code>Access Policies </code></strong>blade—there you will see a policy named <code class="literal">RootManageSharedAccessKey</code>, from which you can copy a connection string.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip85"></a>Note</h3><p>I am using a root policy only for the purpose of this exercise. In a production environment, it is always good to create an individual policy for each application and select only those permissions that are required for it.</p></div><p>When you enter your hub name and paste a connection string, call the <code class="literal">RegisterADevice()</code>method in <code class="literal">OnLaunched()</code>. Now, you can try to start an application. If everything is successful, you should see a screen similar to mine:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/f62cd9b1-f88a-471b-9bf5-904682643c61.png" /></div><p>Congratulations—you have just registered your very first device in Notification Hub!</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec39"></a>Checking available registrations</h4></div></div></div><p>Once you register a device, you need to <span>make</span><a id="id325631083" class="indexterm"></a> sure it is really available in Notification Hub. The easiest way to do so is to check device registrations in a service itself using <strong class="userinput"><code>Server Explorer</code></strong>, which can be accessed either by clicking on it in the <strong class="userinput"><code>View </code></strong>menu (<strong class="userinput"><code>View</code></strong> | <strong class="userinput"><code>Server Explorer</code></strong>) or by using the <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>W</em></span> + <span class="emphasis"><em>L </em></span>key combination:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/80a356fd-b86e-4912-ab1d-cd8a95dd8eba.png" /></div><p>Now, when you double-click on an Notification Hub instance you would like to check, you will see a new screen that contains two tabs—<strong class="userinput"><code>Test Send </code></strong>(which we will cover later) and <strong class="userinput"><code>Device Registrations</code></strong>.</p><p>By clicking on the latter, you will able to verify all available registrations:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/ae61be07-7d7d-4816-97bc-2e616e3d79f9.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec40"></a>Using installations</h4></div></div></div><p>Installations is a newer feature, which allows <span>you</span><a id="id326269493" class="indexterm"></a> to handle each device registration using a bit different syntax and tools. It has a few important advantages over registrations:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">While it is possible to duplicate registrations (by registering the same device twice), installations are idempotent. That means that sending the same installation multiple times will not result in the creation of more than one registration record.</li><li style="list-style-type: disc">By using <code class="literal">HTTP PATCH</code>, you are able to update a specific parameter in an installation.</li><li style="list-style-type: disc">It is easier to perform individual pushes, since each installation is automatically tagged using an installation identifier. In registrations, you would have to create such a tag by yourself and maintain it somehow to get the same functionality.</li></ul></div><p>As I said in a previous part of this book, it is not currently possible to use installations with the .NET SDK on the client side—to check this functionality, we will have to use the Notification Hub RESTful API or use SDK for the backend. Here, you can find an example request for calling an API method:</p><pre class="programlisting">PUT /&lt;hub&gt;/installations/12234?api-version=2015-01 HTTP/1.1
Host: &lt;namespace&gt;.servicebus.windows.net
Authorization: &lt;authorization token&gt;
Content-Type: application/json
Cache-Control: no-cache

{ 
    "installationId": "12234", 
    "platform": "wns", 
    "pushChannel": "&lt;push channel&gt;", 
    "templates": { 
        "myTemplate" : { 
            "body" : '&lt;toast&gt;&lt;visual lang="en-US"&gt;&lt;binding template="ToastTest01"&gt;&lt;text id="1"&gt;$myTextProp1&lt;/text&gt;&lt;/binding&gt;&lt;/visual&gt;&lt;/tile&gt;',
            "headers": { "X-WNS-Type": "wns/toast" }, 
            "tags": ["foo", "bar"] 
            } 
        } 
} </pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip86"></a>Note</h3><p>To generate an authorization token you will need to generate an SAS token. You can find a guide on how to generate it here  <a class="ulink" href="https://msdn.microsoft.com/library/azure/dn495627.aspx" target="_blank">https://msdn.microsoft.com/library/azure/dn495627.aspx</a>.</p></div></div></div></div>