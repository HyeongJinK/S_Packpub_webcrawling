<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch11lvl1sec98"></a>Object storage solution – Azure Storage Blobs</h2></div></div><hr /></div><p>The last capability of Azure Storage is Blob Storage. In the previous sections, we were using this service to store unstructured data using Table Storage, push messages to a <span>queue</span><a id="id325698774" class="indexterm"></a> with Queue Storage, and create file shares, thanks to File Storage. In the last section of this chapter, we will focus on developing solutions that store so-called blobs. You may wonder what exactly a blob is—well, there is no single definition for that. In general. blobs are files of different types, such as text files, images, or audio. You will see how to use them in your applications, how to secure them, and how you can achieve the maximum performance.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec118"></a>Blob Storage concepts</h3></div></div></div><p>Before we go deeper <span>into</span><a id="id325698172" class="indexterm"></a> the service, you will have to understand the basic concepts of Blob Storage. Here you can find a diagram that clearly defines three main topics:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/5a4c5026-d6a1-4903-94cf-5f194e5b44cd.png" /></div><p>As you can see, we have three different concepts:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Account</strong></span>: Which is basically your Storage <span>Account</span><a id="id325345649" class="indexterm"></a> and stores all data within a Blob Storage.</li><li style="list-style-type: disc"><span class="strong"><strong>Container</strong></span>: Which is a logical entity holding an unlimited amount of blobs inside it. An <span>account</span><a id="id325698792" class="indexterm"></a> can have an unlimited amount of containers.</li><li style="list-style-type: disc"><span class="strong"><strong>Blob</strong></span>: A file stored <span>within</span><a id="id325698811" class="indexterm"></a> a container.</li></ul></div><p>Additionally, there are three different <span>types</span><a id="id325698798" class="indexterm"></a> of blob:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Block blob</strong></span>: Text or binary data with a maximum size of 4.7 TB. Such a blob is made of smaller blocks.</li><li style="list-style-type: disc"><span class="strong"><strong>Append blobs</strong></span>: A more <span>specific</span><a id="id325310677" class="indexterm"></a> type of blob, which is the best for scenarios such as logging data, or storing events or transactional logs. They are optimized for append operations.</li><li style="list-style-type: disc"><span class="strong"><strong>Page blobs</strong></span>: Designed for storing <span>VHD</span> files <span>used</span><a id="id325310701" class="indexterm"></a> by VMs.</li></ul></div><p>With the newest version of Storage Accounts (v2), it is possible to use the latest features of this service. One of the most interesting additions is access tiers. Now it is possible to select whether you would like to use a hot or cool tier. The choice depends on the frequency of accessing your data—if you would like to read it often, hot will be the best choice, otherwise, it is better to use the cool tier or a general-purpose account.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip146"></a>Note</h3><p>The tiers aforementioned are available when you select Blob as your storage account type. They are not available for general-purpose accounts.</p></div><p>There is also one more tier; Archive—designed for storing blobs that are rarely accessed—although it is available only on the blob level. You probably wonder about the differences between these tiers. Here you can find a table that defines their pricing:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col /><col /><col /><col /></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Hot</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Archive</strong></span></p></td><td style="border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Cool</strong></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>First 50 TB/month</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span>$0.0184</span> per GB</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span>$0.01</span> per GB</p></td><td style="border-bottom: 0.5pt solid ; "><p><span>$0.002</span> per GB</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Next 450 TB/month</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span>$0.0177</span> per GB</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span>$0.01</span> per GB</p></td><td style="border-bottom: 0.5pt solid ; "><p><span>$0.002</span> per GB</p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p>Over 500 TB/month</p></td><td style="border-right: 0.5pt solid ; "><p><span>$0.017</span> per GB</p></td><td style="border-right: 0.5pt solid ; "><p><span>$0.01</span> per GB</p></td><td style=""><p><span>$0.002</span> per GB</p></td></tr></tbody></table></div><p> </p><p>In terms of storage, you can see that the hot<span class="strong"><strong> </strong></span>tier is the most expensive and the rest are much cheaper, especially archive. Now let us check the price for 10,000 read operations:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Hot</strong></span>: $0.004</li><li style="list-style-type: disc"><span class="strong"><strong>Cool</strong></span>: $0.01</li><li style="list-style-type: disc"><span class="strong"><strong>Archive</strong></span>: $5</li></ul></div><p>Ouch—the difference is huge here! This is why selecting the correct tier is so important—you may end up with a solution that costs many, many dollars, only because you misused the Blob Storage tier.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec119"></a>Inserting data into Blob Storage</h3></div></div></div><p>Now we will try to actually add <span>something</span><a id="id325697936" class="indexterm"></a> to our Blob Storage. Here you can find a piece of code that allows you to upload a single file to a container:</p><pre class="programlisting">using System;
using Microsoft.WindowsAzure.Storage;

namespace BlobStorage
{
    internal class Program
    {
        private static void Main()
        {
            var storageAccount = CloudStorageAccount.Parse("UseDevelopmentStorage=true");
            var cloudBlobClient = storageAccount.CreateCloudBlobClient();
            var container = cloudBlobClient.GetContainerReference("handsonazure");

            container.CreateIfNotExists();

            var blob = container.GetBlockBlobReference("foo.txt"); 
            blob.UploadText("This is my first blob!");

            Console.ReadLine();
        }
    }
}</pre><p>As in the previous examples, this one looks pretty similar. You will need to follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Firstly you have to create an instance of <code class="literal">CloudStorageAccount</code></li><li>Then you need to obtain a reference to a container, and create it if it does not exist</li><li>Finally, you have to get a reference to a blob, and upload some contents</li></ol></div><p>If I open Azure Storage Explorer, I can see that a new blob was uploaded to a container:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/540709b3-353e-4a36-9b92-f4d662482541.png" /></div><p>Of course, if I open the file, I will see that it contains the text that I uploaded:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/86f461c4-eb73-4d01-a317-3635b99dddcf.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec120"></a>Containers and permissions</h3></div></div></div><p>It is possible to select a proper <span>access</span><a id="id325698179" class="indexterm"></a> level when it comes to accessing a container stored within Blob Storage. If you go to Azure Portal and open your Azure Storage service, you can <span>find</span><a id="id325698187" class="indexterm"></a> the <strong class="userinput"><code>Blobs </code></strong>blade. Inside it, you can click on the <strong class="userinput"><code>+ Container</code></strong><span class="strong"><strong> </strong></span>button, which will open a small window:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/c9cdb3b5-2341-4b3a-b090-13f6d364f4b1.png" /></div><p>As you can see, besides providing a name for a container, you can select <strong class="userinput"><code>Public access level</code></strong>. Currently, you have three different options available:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Private</code></strong>: For no anonymous access</li><li style="list-style-type: disc"><strong class="userinput"><code>Blob</code></strong>: Anonymous access on a blob level</li><li style="list-style-type: disc"><strong class="userinput"><code>Container</code></strong>: Anonymous access on a container level</li></ul></div><p>You can click on a container you created to see another screen, where you can manage it. I will use it to actually upload a file to see what other options become available. Here you can find what it will look in the portal when a file is uploaded and I click on it:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/1534d3ee-02a2-4b34-bd38-501e52e68c50.png" /></div><p>Now I can see additional metadata regarding a file, manage like acquiring leases, or generate an SAS token.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip147"></a>Note</h3><p>If you want to make a file read-only, click on the <strong class="userinput"><code>Acquire lease</code></strong><span class="strong"><strong> </strong></span>button—while it will still be possible to change it, such an action will require providing a lease ID.</p></div><p>What is more, there is a <strong class="userinput"><code>URL </code></strong>property available, which can be used to access a blob directly, for example, using a browser. Here you can find how it looks like in my case:</p><p><code class="literal">https://handsonazurestore.blob.core.windows.net/blob/11047_01_01.PNG</code></p><p>Now you may wonder what the difference is between <strong class="userinput"><code>Blob </code></strong>and <strong class="userinput"><code>Container </code></strong>access. To find out, we will use the following code:</p><pre class="programlisting">using System;
using Microsoft.WindowsAzure.Storage.Blob;

namespace BlobStorage
{
    internal class Program
    {
        private static void Main()
        {
            var container = new CloudBlobContainer(new Uri("&lt;container-uri&gt;"));
            var blobs = container.ListBlobs();

            foreach (var blob in blobs)
            {
                Console.WriteLine(blob.Uri);
            }

            Console.ReadLine();
        }
    }
}</pre><p>I already created two different containers—one with <strong class="userinput"><code>Blob </code></strong>access, one with <strong class="userinput"><code>Container</code></strong>. If I execute the preceding code for a container with full public access, the following is what I will see:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/5d36618c-8cd6-4ae6-85ce-a7c5d501bb5e.png" /></div><p>Now let us run it for a container, which has public access for blobs only:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/4de028e9-a65e-4fba-8ef6-c90bbf277b80.png" /></div><p>As you can see, container-level operations are unavailable when its access level is blob or private. Of course, if you authorize using, for instance, an access key, you will list all blobs within a container, even if it is private. Of course, it is also possible to set a container-level <span>permission</span><a id="id325208873" class="indexterm"></a> directly <span>from</span><a id="id325208882" class="indexterm"></a> your code:</p><pre class="programlisting">using System;
using Microsoft.WindowsAzure.Storage;
using Microsoft.WindowsAzure.Storage.Blob;

namespace BlobStorage
{
    internal class Program
    {
        private static void Main()
        {
            var storageAccount = CloudStorageAccount.Parse("UseDevelopmentStorage=true");
            var cloudBlobClient = storageAccount.CreateCloudBlobClient();
            var container = cloudBlobClient.GetContainerReference("blob");

            container.CreateIfNotExists(BlobContainerPublicAccessType.Blob);

            var blob = container.GetBlockBlobReference("foo.txt"); 
            blob.UploadText("This is my first blob!");

            Console.ReadLine();
        }
    }
}</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec121"></a>Blob Storage: additional features</h3></div></div></div><p>One of the newest and coolest features of Blob <span>Storage</span><a id="id325208901" class="indexterm"></a> is the <strong class="userinput"><code>Soft delete</code></strong><span class="strong"><strong> </strong></span>feature. It allows you to perform an operation called a soft delete. What does this mean? In some cases, you may want to delete a file, but have the ability to easily revert the deletion within a fixed time period. In Blob Storage, that option is available via the <strong class="userinput"><code>Soft delete</code></strong><span class="strong"><strong> </strong></span>blade:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/72c0bed9-c7e4-420a-b305-2c567d3ef851.png" /></div><p>If you turn it on, any deleted blob will still be available within storage (but not for retrieval or modification) for a set number of days. Blob Storage also has two additional features, which can be used with two other Azure services:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Azure CDN</code></strong>: A Content Delivery Network service for serving static content to your customers—we will cover this later in the book.</li><li style="list-style-type: disc"><strong class="userinput"><code>Azure Search</code></strong>: As already discussed, here you can easily set your Blob Storage as a data source for a search engine.</li></ul></div><p>So as you can see, this is a very flexible and useful Azure Storage capability, which can be used for file storage, as an Azure Search document store, a logs database, and much, much more. </p></div></div>