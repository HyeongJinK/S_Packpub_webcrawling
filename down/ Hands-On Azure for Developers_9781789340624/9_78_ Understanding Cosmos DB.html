<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec78"></a>Understanding Cosmos DB</h2></div></div><hr /></div><p>When working with storage, you have probably <span>heard</span><a id="id325633079" class="indexterm"></a> about different kinds; relational databases, NoSQL databases, graph databases, document databases. There are plenty of different models available, with different characteristics, when it comes to storing data. If you need to easily maintain relationships between tables, in most cases you will choose something such as SQL Server. On the other hand, maybe you would like to save each record in the JSON file format, where the best solution would be an instance of MongoDB. While the choice is all yours, the biggest problem is that you need to have a different kind of service to serve the same purpose—storing data. This is where Azure Cosmos DB comes into play. With its multi-model capabilities, flexibility, and scalability it is a great choice for globally distributed and highly responsive applications. In this section, you will learn how to start working with this service and what its main functionalities are.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec78"></a>Creating a Cosmos DB instance in the portal</h3></div></div></div><p>We will start our journey with Azure CosmosDB by <span>creating</span><a id="id325128387" class="indexterm"></a> it in the Azure portal:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>When you click on <strong class="userinput"><code>+ Create a resource</code></strong><span class="strong"><strong> </strong></span>and search for <code class="literal">Azure Cosmos DB</code>, you will see a simple form that allows you to select the basic features of the service:</li></ol></div><div class="mediaobject"><img src="/graphics/9781789340624/graphics/2b5bf549-d383-45a7-84ed-b0de7a6b7f7b.png" /></div><p>There are, however, some not-so-obvious features, which will require a little bit of explaining:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong><strong class="userinput"><code>API</code></strong></strong></span>: As mentioned earlier, Azure Cosmos DB enables you to use one of a few different APIs during creation. Currently, there are five available APIs: SQL, MongoDB, Cassandra, Azure Table, and Gremlin. Depending on the API selected, you will have different capabilities available (and what is more, different packages will be required for communicating with your database in the application's code).
</li><li style="list-style-type: disc"><strong class="userinput"><code>Enable geo-redundancy</code></strong>: By selecting this option, your data will be distributed between two paired regions (depending on the one you selected in the <strong class="userinput"><code>Location </code></strong>drop-down), for example, <strong class="userinput"><code>West Europe</code></strong> and <strong class="userinput"><code>North Europe</code></strong> or <strong class="userinput"><code>Central US</code></strong> and <strong class="userinput"><code>East US 2</code></strong>.</li><li style="list-style-type: disc"><strong class="userinput"><code>Enable Multi Master</code></strong>: This is a new (and currently in preview) feature, where instead of having only a single master, you can have multiple master databases all around the globe. This greatly lowers latency when it comes to reading already saved data (as you do not have to wait for data propagation), and increases consistency and data integrity (as you have the possibility to write data to a master instance in a specific region).</li><li style="list-style-type: disc"><strong class="userinput"><code>Virtual networks</code></strong>:<span class="strong"><strong> </strong></span>Depending on the model you choose, you may be able to restrict access to an instance of Azure Cosmos DB by putting it into a specific virtual network and subnet. Currently, this is possible for two database models: SQL and MongoDB.</li></ul></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>When you are satisfied with all the entered data, you can create it by clicking on the <strong class="userinput"><code>Create </code></strong>button. Once your service is created, you can access the <strong class="userinput"><code>Overview </code></strong>blade to see how it works initially:</li></ol></div><div class="mediaobject"><img src="/graphics/9781789340624/graphics/e233b728-bf2b-44f8-b270-da970347aacf.png" /></div><p>As you can see, it displays a map in the <span>center</span><a id="id325310693" class="indexterm"></a> that tells you how your data is replicated across regions. If you click on the map, you will be able to reconfigure the initial settings. If you click on the <strong class="userinput"><code>Add new region</code></strong><span class="strong"><strong> </strong></span>button, you will be able to search for a particular one and select it as an additional read region. Alternatively, you can just click on a region icon:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/2791328b-ba45-47fa-a2b6-6825acb34f59.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip116"></a>Note</h3><p>In the current setup, you are unable to add additional write regions. To be able to do so, you have to use the multi-master feature I described previously.</p></div><p>Once you save additional regions, both <strong class="userinput"><code>Manual Failover</code></strong><span class="strong"><strong> </strong></span>and <strong class="userinput"><code>Automatic Failover</code></strong><span class="strong"><strong> </strong></span>will become active. The concept for failover is simple—if your write region goes down and becomes unavailable, another available read region can take its place. The only difference is whether you want to perform such failover manually or automatically.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip117"></a>Note</h3><p>If you opt for automatic failover, you can decide on the order of switching between read and write regions. If you want, for example, to switch from North Europe to West Europe in the first place, West Europe has to be the very first priority in the list.</p></div><p>If you go back to the <strong class="userinput"><code>Overview </code></strong>blade, you will notice some additional features:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Monitoring</code></strong>: Here you can easily find all requests to your database and their status.</li><li style="list-style-type: disc"><strong class="userinput"><code>Enable geo-redundancy</code></strong>: If you did not enable this feature when creating an instance of Azure Cosmos DB, you may do this now.</li><li style="list-style-type: disc"><strong class="userinput"><code>Data Explorer</code></strong>: By clicking on this button you can easily access an explorer, which allows you to insert and modify data.</li></ul></div><p>Additionally, you can go to the <strong class="userinput"><code>Quick start </code></strong>blade, where you will be able to start developing applications using this Azure service:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/84ef6a13-8816-44f8-be22-97e07d89cd35.png" /></div><p>Depending on the selected model of a database, you will have access to <span>different</span><a id="id325469468" class="indexterm"></a> initial configurations. Additionally, as you can see, you have a choice as to whether you would like to use .NET, Node.js, Java, or Python—all these languages can easily integrate with Azure Cosmos DB, making it an even better choice when it comes to creating a multi-platform application.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec79"></a>Using Azure Cosmos DB in Visual Studio</h3></div></div></div><p>Besides controlling Azure <span>Cosmos</span><a id="id325469483" class="indexterm"></a> DB in the portal, you are able to <span>access</span><a id="id325469492" class="indexterm"></a> it directly in your code and IDE, such as Visual Studio. Like many other services, you can use <strong class="userinput"><code>Cloud Explorer</code></strong><span class="strong"><strong> </strong></span>to browse all available instances of this database available within your subscription:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/c30db6b2-71f8-4c47-b4ca-25f2a9975ae9.png" /></div><p> </p><p> </p><p>Now let's try to communicate with it from a simple application. While initially an instance of Cosmos DB is empty, we can quickly add a table to it.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note118"></a>Note</h3><p>In this section, we will work with the table API in Cosmos DB. If you would like to work with any other type, you will have to consult tutorials in the <span class="emphasis"><em>Further reading</em></span><span class="strong"><strong> </strong></span>section.</p></div><p>Consider the following code snippet:</p><pre class="programlisting">using System;
using Microsoft.Azure.CosmosDB.Table;
using Microsoft.Azure.Storage;

namespace HandsOnAzureCosmosDB
{
    internal class Program
    {
        private static void Main()
        {
            // You can get the connection string from the <span class="strong"><strong>Quick start</strong></span> blade mentioned previously
            var connectionString = "&lt;connection-string&gt;";
            var storageAccount = CloudStorageAccount.Parse(connectionString);
            var tableClient = storageAccount.CreateCloudTableClient();

            var reference = tableClient.GetTableReference("handsonazure");
            var result = reference.CreateIfNotExists();

            Console.ReadLine();
        }
    }
}</pre><p>In the preceding code, we are creating an empty table, which should be immediately available within an instance of Cosmos DB. Now if I check <strong class="userinput"><code>Cloud Explorer</code></strong><span class="strong"><strong> </strong></span>once more, I see that, in fact, it is true:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/2531eadf-ab09-449f-8b39-abcf465d4325.png" /></div><p>Now we can add a record to it. We slightly modify our code as follows:</p><pre class="programlisting">using System;
using Microsoft.Azure.CosmosDB.Table;
using Microsoft.Azure.Storage;

namespace HandsOnAzureCosmosDB
{
    internal class Program
    {
        private static void Main()
        {
            // You can get the connection string from the <span class="strong"><strong>Quick start </strong></span>blade mentioned previously
            var connectionString = "&lt;connection-string&gt;";
            var storageAccount = CloudStorageAccount.Parse(connectionString);
            var tableClient = storageAccount.CreateCloudTableClient();

            var reference = tableClient.GetTableReference("handsonazure");
            var result = reference.CreateIfNotExists();

            var executionResult = reference.Execute(TableOperation.Insert(new TableEntity("handsonazure", Guid.NewGuid().ToString())));
            Console.WriteLine(executionResult.Result);

            Console.ReadLine();
        }
    }
}</pre><p>We now consult <strong class="userinput"><code>Data Explorer</code></strong><span class="strong"><strong> </strong></span>in the portal to see the difference <span>between</span><a id="id325618503" class="indexterm"></a> Visual Studio and the <span>Azure</span><a id="id325618512" class="indexterm"></a> portal. We should be able to see the entity we have just inserted:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/d58eeda3-af5a-4817-8896-2a8a016a929e.png" /></div><p>As you can see, all you need to start working with a database with multiple database models, which can be quickly configured for geo-redundancy and scaled across the globe, is just several lines of code. </p><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec80"></a>Pricing in Azure Cosmos DB</h3></div></div></div><p>Azure Cosmos DB is part of the <span>serverless</span><a id="id325618552" class="indexterm"></a> services available in Azure. This means that the chances of configuring and provisioning servers to run it are either maximally limited or not available. As you probably noticed, we were not able to define how many instances of a service we would like to run (or nodes or clusters). Instead, we have to define throughput for each collection individually:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/8783d46f-9f88-4208-bf98-7d57213e0903.png" /></div><p>A simple calculator display also estimates the costs of a collection per hour and day. The unit of throughput in Azure Cosmos DB is <span class="strong"><strong>request units</strong></span> (<span class="strong"><strong>RUs</strong></span>). During the creation of a container (or a collection—you can use both definitions), you specify also its type—whether it has fixed capacity or unlimited.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note119"></a>Note</h3><p>Once the type of collection is defined, you cannot change it later.</p></div><p>By selecting different options, you can select different limits for RUs:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">For fixed, you can select between 400 to 10,000 RUs</li><li style="list-style-type: disc">For unlimited, you can go from 1,000 to a maximum of 100,000 RUs</li></ul></div><p> </p><p>Regarding pricing, you are paying both for the amount of data stored ($0.25 GB/month), and reserved RUs ($.008/hour per every 100 RUs). Having those values, we can quickly calculate the smallest bill possible—it is around $23. Now there is a very important caveat. You are paying per each collection/table/container. That means that, if you have, for example, 20 different tables in your database, you will pay 20 * $23 = $462. In such a scenario, it is sometimes better to model your database in such a way that it will be possible to store all data within a single container.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note120"></a>Note</h3><p>While Azure Cosmos DB seems like a quite an expensive service, please do remember that it does many things for you, such as geo-redundancy, multiple read regions, multi-master models, and many more. You always have to calculate the best options for you (and if you are able to do the same with the similar results). To do so, take a look at the Capacity Planner described in the <span class="emphasis"><em>Further Reading</em></span> section.</p></div></div></div>