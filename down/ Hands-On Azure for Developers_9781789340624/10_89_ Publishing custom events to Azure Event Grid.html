<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec88"></a>Publishing custom events to Azure Event Grid</h2></div></div><hr /></div><p>So far, we have talked about integrating Azure Event <span>Grid</span><a id="id326372400" class="indexterm"></a><span class="emphasis"><em> </em></span>with already built-in publishers and topics, using Resource Group as an example. I mentioned at the beginning of this chapter that this service is capable of handling custom topics, making it a really flexible solution that can act as an event gateway. In this section, we will cover this topic and try to use Event Grid<span class="emphasis"><em> </em></span>as our router for handling and maintaining the routing of our events.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec100"></a>Event gateway concept</h3></div></div></div><p>Let's look at the <span>following</span><a id="id326372389" class="indexterm"></a> diagram:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/fa17014c-2179-4b61-8388-a1b03401be2a.png" /></div><p> </p><p> </p><p>Here, you have a single events producer and four different handlers. Now, if you imagine that <span class="strong"><strong>Publisher </strong></span>publishes only custom events, you can see that Event Grid<span class="emphasis"><em> </em></span>is able to distribute them among <code class="literal">N</code> different handlers (which do not have to be the same type—it can be a mix of any supported handlers available). Of course, this concept can also be used with publishers such as Resource Group, Azure Blob Storage, or Azure Event Hub—personally, I think that it is slightly more useful for custom scenarios. Let's take an example—you are publishing an <code class="literal">OrderCreated</code><code class="literal"><span class="strong"><strong> </strong></span></code>event. With Azure Event Grid,<span class="emphasis"><em> </em></span>you could now distribute it to different handlers:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">OrderConfirmation</code>: For example, for sending a confirmation via a mail message</li><li style="list-style-type: disc"><code class="literal">OrderProcessor</code>: For handling the actual logic of processing an order</li><li style="list-style-type: disc"><code class="literal">OrderNotification</code>: For notifying someone that there is an order that has to be validated</li></ul></div><p>Of course, the preceding steps rely only on your logic—it should, however, give you a hint of what can be done with routing and distributing events using Azure Event Grid.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec101"></a>Handling a custom event</h3></div></div></div><p>Before we send a custom event, we have to <span>take</span><a id="id325544061" class="indexterm"></a> a look at the Event Grid<span class="emphasis"><em> </em></span>event schema:</p><pre class="programlisting">[
  {
    "topic": string,
    "subject": string,
    "id": string,
    "eventType": string,
    "eventTime": string,
    "data":{
      object-unique-to-each-publisher
    },
    "dataVersion": string,
    "metadataVersion": string
  }
]</pre><p>As you can see, it is a simple JSON array, containing many different events. Let's describe each field here:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">topic</code>: This defines a full path to an event source (for example, Azure Blob Storage).
</li><li style="list-style-type: disc"><code class="literal">subject</code>:<span class="strong"><strong> </strong></span>This defines a path to an event subject (so, in the case of publishing events from a resource group, this could be a full path to an Azure resource, or, in the case of Azure Blob Storage, this would be a Blob path).</li><li style="list-style-type: disc"><code class="literal">id</code>: This is the unique identifier of an event.</li><li style="list-style-type: disc"><code class="literal">eventType</code>: A type of a published event (such as <code class="literal">Microsoft.Resources.ResourceWriteSuccess</code>).</li><li style="list-style-type: disc"><code class="literal">eventTime</code>: This defines when an event was published using the publisher's UTC time.</li><li style="list-style-type: disc"><code class="literal">data</code>: The payload of an event.</li><li style="list-style-type: disc"><code class="literal">dataVersion</code>: An event schema version defined by the publisher.</li><li style="list-style-type: disc"><code class="literal">metadataVersion</code>: A revision number of event metadata schema version, provided by Event Grid.</li></ul></div><p>Now, if you want to publish an event, you will have to do the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Always use an array of events, even if you are publishing a single one</li><li style="list-style-type: disc">Either use an empty topic or use the following syntax, which reflects the fact, that each topic is also an Azure resource <code class="literal">/subscriptions/&lt;subscription-id&gt;/resourceGroups/&lt;resource-group&gt;/providers/Microsoft.EventGrid/topics/&lt;eventgrid-name&gt;</code></li><li style="list-style-type: disc">Use <code class="literal">aeg-sas-key</code><span class="strong"><strong> </strong></span>or <code class="literal">aeg-sas-token</code><span class="strong"><strong> </strong></span>to authorize a request by providing a key from the <strong class="userinput"><code>Access keys</code></strong><span class="strong"><strong> </strong></span>blade</li></ul></div><p>Here, you can find an example request:</p><pre class="programlisting">POST /api/events HTTP/1.1
Host: handsonazure-eventgrid.westeurope-1.eventgrid.azure.net
Content-Type: application/json
aeg-sas-key: &lt;sas-key&gt;
Cache-Control: no-cache

[
  {
    "subject": "example",
    "id": "1",
    "eventType": "SectionFinished",
    "eventTime": "2018-08-12T07:41:00.9584103Z",
    "data":{
      "section": 3
    },
    "dataVersion": "1"
  }
]</pre><p>If everything is correct, you should see an <code class="literal">HTTP 200</code> response. Now, you may wonder how you can receive such a request. If you go to your instance of Azure Event Grid<span class="emphasis"><em> </em></span>and click on the <strong class="userinput"><code>+</code></strong><strong class="userinput"><code>Event Subscription<span class="strong"><strong> </strong></span></code></strong>button, you will see a form where you can create a new subscription:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/4c4e104e-4f73-4b12-b2bd-6a7ff134b0c1.png" /></div><p> </p><p> </p><p>You saw this form before, when we were discussing creating a subscription directly from a resource group. There are, however, some important things to mention:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Subscribe to all event types</code></strong><span class="strong"><strong>:</strong></span> You have an option to either route all events types to an endpoint, or just to the ones defined by you (you will be able to enter any event type you wish once you uncheck the checkbox). This is very useful for the proper events routing.</li><li style="list-style-type: disc"><strong class="userinput"><code>Endpoint Type</code></strong>: You have a choice of different endpoints, including WebHook, Azure Event Hub,<span class="emphasis"><em> </em></span>and Hybrid Connections.</li><li style="list-style-type: disc"><strong class="userinput"><code>Event Schema</code></strong>: You can choose to use either Event Grid<span class="emphasis"><em> </em></span>schema or a more common Cloud Events schema, the latter of which is an open standard specification and can be used to introduce a custom schema for all the components in your system.</li><li style="list-style-type: disc"><strong class="userinput"><code>FILTERS</code></strong>: You can additionally filter events of a specific type by filtering them with the subject field value.</li></ul></div><p>When you fill all values, click on <strong class="userinput"><code>Create</code></strong><span class="strong"><strong> </strong></span>to actually create it.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note134"></a>Note</h3><p>Remember that an endpoint has to be validated to successfully create a subscription!</p></div><p>Now, if you send an example request, you should be able to receive it in your handler (in my case, Azure Functions):</p><pre class="programlisting">2018-08-12T08:17:25.263 [Info] Function started (Id=8216a64d-19c5-436f-8cce-69fc49a3cff2)
2018-08-12T08:17:25.404 [Info] [
  {
    "subject": "example",
    "id": "1",
    "eventType": "SectionFinished",
    "eventTime": "2018-08-12T07:41:00.9584103Z",
    "data": {
      "section": 3
    },
    "dataVersion": "1",
    "metadataVersion": "1",
    "topic": "/subscriptions/.../resourceGroups/handsonazure-rg/providers/Microsoft.EventGrid/topics/handsonazure-eventgrid"
  }
]
2018-08-12T08:17:25.404 [Info] Function completed (Success, Id=8216a64d-19c5-436f-8cce-69fc49a3cff2, Duration=138ms)</pre><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p>You may wonder what will happen if your event handler doesn't return a <span>success</span><a id="id325310868" class="indexterm"></a> response to Azure Event Grid. In that scenario, a retry will be performed.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note135"></a>Note</h3><p>Azure Event Grid<span class="emphasis"><em> </em></span>considers only <code class="literal">HTTP 200</code> and <code class="literal">HTTP 202</code> responses as successful.</p></div><p>By default, Event Grid<span class="emphasis"><em> </em></span>uses an exponential backoff retry policy. This means that each consecutive retry will be performed with an increased delay between that one, and the next retry. You can customize this behaviour by providing a custom retry policy. A link to that feature can be found in the <span class="emphasis"><em>Further reading</em></span><span class="strong"><strong> </strong></span>section.</p></div></div>