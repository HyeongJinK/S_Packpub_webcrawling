<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec62"></a>Creating a function</h2></div></div><hr /></div><p>We discussed the overall serverless approach and <span>wen</span><a id="id325466411" class="indexterm"></a>t through local configuration to make sure that we have some basic understanding of what Azure Functions are and how we can start working with them. In the following of this chapter, I will show you what exactly this service offers and how to work with it on daily basis. This will help you start developing full projects with Functions—from the simplest to the most advanced ones.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec57"></a>Using Visual Studio</h3></div></div></div><p>In the previous section, you <span>created</span><a id="id325466398" class="indexterm"></a> a function using a wizard in <span>Visual</span><a id="id325466393" class="indexterm"></a> Studio. If you go back to this particular project and open its file, you will see some common code, which is always created with this particular template. Here, you can find the same code but without the custom code introduced by it:</p><pre class="programlisting">using System.Net.Http;
using System.Threading.Tasks;
using Microsoft.Azure.WebJobs;
using Microsoft.Azure.WebJobs.Extensions.Http;
using Microsoft.Azure.WebJobs.Host;

namespace HandsOnAzure.Function
{
    public static class Function1
    {
        [FunctionName("Function1")]
        public static async Task&lt;HttpResponseMessage&gt; Run(
            [HttpTrigger(AuthorizationLevel.Function, "get", "post", Route = null)]
            HttpRequestMessage req, TraceWriter log)
        {
        }
    }
}</pre><p>As you can see, I deleted the whole function body—this is the only part that is not a part of the service (remember our IaaS versus PaaS versus serverless comparison?). We can see some attributes, which decorate both a C# method and its parameters—they all are a part of the runtime that runs your functions. Let's compare it with a function that is triggered by Azure Storage Queue:</p><pre class="programlisting">using Microsoft.Azure.WebJobs;
using Microsoft.Azure.WebJobs.Host;

namespace HandsOnAzure.Function
{
    public static class Function2
    {
        [FunctionName("Function2")]
        public static void Run([QueueTrigger("myqueue-items", Connection = "connection-string")]
            string myQueueItem, TraceWriter log)
        {
        }
    }
}</pre><p>Here, you can see that still we have the <code class="literal">[FunctionName]</code> attribute and some kind of trigger attribute. What differs is, in fact, the type of trigger parameter—in HTTP, we had <code class="literal">HttpRequestMessage</code>, while in Queue, we have a simple <code class="literal">string</code> parameter. This parameter (and its type) directly define the type of message delivered to a function. In general, it is pretty clear—each HTTP request is deserialized and delivered as <code class="literal">HttpRequestMessage </code>(as in Web API, for example), and each in-queue service and each message is a string. However, how about the following signature:</p><pre class="programlisting">using System.Net.Http;
using Microsoft.Azure.WebJobs;
using Microsoft.Azure.WebJobs.Extensions.Http;
using Microsoft.Azure.WebJobs.Host;

namespace HandsOnAzure.Function
{
    public static class Function3
    {
        [FunctionName("Function3")]
        public static HttpResponseMessage Run(
            [HttpTrigger(AuthorizationLevel.Function, "get", "post", Route = "Function3/name/{name}")]
            HttpRequestMessage req, string name, TraceWriter log)
        {
        }
    }
}</pre><p>As you can see, the preceding example introduced one more parameter—<code class="literal">name</code>, which is a string, though the whole function is triggered by an HTTP request. This particular parameter will be used during the binding procedure, which will find that this function's route contains it in its URL template. This is the very same model as in traditional MVC/Web API frameworks, which provide the same feature. </p><p> </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note97"></a>Note</h3><p>The binding procedure itself is quite complicated and mostly depends on the type of used trigger. Unfortunately, it is out of the scope of this book, so I will not cover it in detail—fortunately, Azure Functions are OSS, so you can check how the host works directly in the code. </p></div><p>If you want to quickly add a new function to your project, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Right-click on your project in Visual Studio and search for the <strong class="userinput"><code>Add</code></strong> | <strong class="userinput"><code>New Azure Function...</code></strong> menu item.</li><li>This will display a screen where you can enter new function name.</li><li>When you click <strong class="userinput"><code>Add</code></strong>, you will see another screen, which allows you to select a function type with far more options than we initially saw:</li></ol></div><div class="mediaobject"><img src="/graphics/9781789340624/graphics/020f8906-92ad-4f72-8a26-71858f789927.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec58"></a>Using Azure Portal</h3></div></div></div><p>As with all other Azure services, it is also possible to <span>create</span><a id="id325128342" class="indexterm"></a> a function app instance by <span>creating</span><a id="id325128350" class="indexterm"></a> it directly in Azure Portal:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>When you log in, click on <strong class="userinput"><code>+ Create a resource</code></strong><span class="strong"><strong> </strong></span>and search for<strong class="userinput"><code> Function App.</code></strong></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>When you click <strong class="userinput"><code>Create</code></strong>, you will see a screen with a couple of fields that need to be filled in before processing occurs:</li></ol></div><div class="mediaobject"><img src="/graphics/9781789340624/graphics/3ede9f5f-3bf4-407b-9822-3c1a008074f5.png" /></div><p> </p><p>As you can see, the preceding form is familiar to the one we used when creating an App Service instance. This is because, under the hood, Azure Functions is powered by this particular service and multiple available features are shared between them. As you can see, you are able to select <strong class="userinput"><code>OS</code></strong>, which defines the runtime you will be able to use.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip98"></a>Note</h3><p>If you are interested in using .NET Core, you can start working with Linux as your OS. This is currently in preview, but allows for using the v2 version of the runtime. It has many enhancements and uses the newest .NET stack so, in many cases, it can be quicker than v1.</p></div><p>In the <strong class="userinput"><code>Hosting Plan </code></strong>drop-down menu, you are able to select whether you want to use the <strong class="userinput"><code>Consumption Plan</code></strong> or <strong class="userinput"><code>App Service</code></strong> model for pricing. We discussed the differences between these in the previous part of this chapter, so you should be able to decide on which one to use by yourself. Remember that you will have to select the <strong class="userinput"><code>B1 </code></strong>tier at least.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note99"></a>Note</h3><p>Azure Portal disallows you from using <strong class="userinput"><code>Shared </code></strong>or <strong class="userinput"><code>Free </code></strong>tiers as Azure Functions requires the <strong class="userinput"><code>Always On</code></strong><span class="strong"><strong> </strong></span>feature to be enabled—you probably remember that it is available only for <strong class="userinput"><code>Basic </code></strong>and higher tiers. While it is possible to create a function app with, for example, <strong class="userinput"><code>Free </code></strong>tier (using, for instance, ARM templates), it will not work correctly.</p></div><p>This wizard also gives you the possibility to enable<strong class="userinput"><code> Application Insights</code></strong> integration. Since we have not discussed this particular service yet, I will skip it in this chapter. However, if you are interested in monitoring your functions, it is a much better option than the integrated <strong class="userinput"><code>Monitor </code></strong>feature—it gives you much more detail and is much more intuitive in daily work.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip100"></a>Note</h3><p>Enabling <strong class="userinput"><code>Application Insights</code></strong><span class="emphasis"><em> </em></span>for your function app can drastically change the overall price of the whole service as, initially, each function produces many different traces and logs. For production, it is always a good idea to the lower logged severity of messages—you can find more information about configuration at: <a class="ulink" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-monitoring" target="_blank">https://docs.microsoft.com/en-us/azure/azure-functions/functions-monitoring</a>.</p></div><p>When you are satisfied with your settings, you can click <strong class="userinput"><code>Create</code></strong>. Azure Portal will validate all of the fields and initiate the service provisioning procedure. After several seconds, your function app should be ready for work. When you go to it, you will see the dashboard, which is the starting point for accessing all of the features of Azure Functions:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/d707fb61-e2fd-4184-87a9-79392eee9937.png" /></div><p>Now, if you want to create a function, move your mouse cursor over the <strong class="userinput"><code>Functions </code></strong>section and click on the plus sign (<strong class="userinput"><code>+</code></strong>). It will display a new wizard screen, where you can choose to either start with a premade function or create a custom one. For the purpose of this exercise, I decided to go with a timer function written in JavaScript:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/c4077184-7bda-44a9-a57c-2216e04f06ec.png" /></div><p>After clicking on the <strong class="userinput"><code>Create this function</code></strong><span class="strong"><strong> </strong></span>button, you will see that some function code has been generated. Azure Portal allows also you to edit a function directly in your browser window, so if you want to try out some custom code, there is nothing preventing you from doing so:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/eabbcd06-a444-41de-bf4e-ba365037a625.png" /></div><p>Additionally, you can click <strong class="userinput"><code>Run</code></strong>—this is the so-called <span class="strong"><strong>manual trigger</strong></span> and enables you to <span>start</span><a id="id325310869" class="indexterm"></a> a function immediately. The result of running a function will be visible in the <strong class="userinput"><code>Logs </code></strong>window:</p><pre class="programlisting">2018-07-22T09:15:36  Welcome, you are now connected to log-streaming service.
2018-07-22T09:15:57.252 [Info] Function started (Id=63d9f8ff-b807-4805-8b24-5f90edfc0134)
2018-07-22T09:15:57.377 [Info] JavaScript timer trigger function ran!: 2018-07-22T09:15:57.377Z
2018-07-22T09:15:57.377 [Info] Function completed (Success, Id=63d9f8ff-b807-4805-8b24-5f90edfc0134, Duration=128ms)
2018-07-22T09:17:36  No new trace in the past 1 min(s).
2018-07-22T09:18:36  No new trace in the past 2 min(s).</pre><p>Congratulations—you have learned how to <span>create</span><a id="id325317144" class="indexterm"></a> a function using both <span>Visual</span><a id="id325317166" class="indexterm"></a> Studio and Azure Portal. In the next section, I will describe more advanced scenarios and will focus on understanding further Azure Functions features.</p></div></div>