<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch12lvl1sec106"></a>Azure Event Hub Capture feature</h2></div></div><hr /></div><p>There is one feature of Azure Event Hub that requires an individual section itself to describe it in depth. It is capture, a functionality which allows <span>you</span><a id="id325117156" class="indexterm"></a> to automatically store events using a predefined storage solution (such as Azure Storage<span class="emphasis"><em> </em></span>or Azure Data Lake) and process it further. Unfortunately, this particular feature is often misused as its use cases are not so obvious; additionally, the way it works might sometimes be unclear. </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec129"></a>How Azure Event Hub Capture works</h3></div></div></div><p>In common use cases for Event Hub, <span>you</span><a id="id325117139" class="indexterm"></a> need a <span class="strong"><strong>producer</strong></span> and a <span class="strong"><strong>consumer</strong></span> to fetch data and process it. Let's consider the following scenario:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/cfa21921-c558-4d99-88e2-6b13356ff5fd.png" /></div><p>In this scenario, we have two consumers:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Consumer 1 </strong></span>for some generic processing</li><li style="list-style-type: disc"><span class="strong"><strong>Consumer 2 </strong></span>for archiving events</li></ul></div><p>We also introduced <span class="strong"><strong>storage </strong></span>for storing a log of events. As <span>you</span><a id="id325115404" class="indexterm"></a> can see, the downside of that solution is the fact that you need to maintain both consumers—two code bases and two instances. With Event Hub Capture, the scenario we are considering now will change a little bit:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/67517658-923b-457c-8ca0-51f6203d319f.png" /></div><p>Now we no longer require additional consumers as it will be Event Hub Capture's responsibility to store data. You may wonder how storing data works in that scenario; in general, it is based on a time window which, when it ends, triggers a capture of data.</p><p>It can be easily described using an example. Suppose you set your time window to 10 minutes; after that interval, all data which is stored within Azure Event Hub<span class="emphasis"><em> </em></span>will be captured and stored inside a selected database using <span class="strong"><strong>Apache Avro</strong></span> format.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip158"></a>Note</h3><p>An important thing is Capture pricing; it costs € 0.085/hour per each throughput unit. It means that if you have<span class="emphasis"><em> </em></span>Azure Event Hub<span class="emphasis"><em> </em></span>with 1 TU and Capture enabled, you will pay 80 EUR instead of 18 EUR. With 2 TUs, it will be 160 EUR instead of 37 EUR.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec130"></a>Enabling Event Hub Capture</h3></div></div></div><p>Event Hub Capture is a feature of an individual Event Hub, not the whole namespace. To enable it, <span>you</span><a id="id324830059" class="indexterm"></a> need to go to your hub and search for the <strong class="userinput"><code>Capture</code></strong><span class="strong"><strong> </strong></span>blade.</p><p>Now, when you enable Capture, you will see a full configuration of the feature, which  we will try to understand now:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/8227a9f6-4979-4621-9ec3-fc6509b927db.png" /></div><p>As you can see, it contains the following settings:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>Time window</strong></span>: It defines after how many minutes a capture is triggered.</li><li style="list-style-type: disc"><span class="strong"><strong>Size window</strong></span>: Alternatively, it is possible to trigger a capture after a window reaches the size limit. Whether it triggers because of time or size depends on which one reaches the limit first.</li><li style="list-style-type: disc"><span class="strong"><strong>Capture Provider</strong></span>: You can choose between Azure Storage<span class="emphasis"><em> </em></span>and Azure Data Lake Store. The choice is yours as it does not imply any additional features or limits.</li><li style="list-style-type: disc"><span class="strong"><strong>Azure Storage Container/Data Lake Store</strong></span>: Depending on your choice, <span>you</span><a id="id325143101" class="indexterm"></a> will have to choose a different kind of a container.</li><li style="list-style-type: disc"><span class="strong"><strong>Capture file name format</strong></span>: This Event Hub feature has a predefined set of formats for how your files will be stored. Unfortunately, it is impossible to make it fully customizable as it must contain the <code class="literal">{Namespace}</code>, <code class="literal">{EventHub}</code>, <code class="literal">{PartitionId}</code>, <code class="literal">{Year}</code>, <code class="literal">{Month}</code>, <code class="literal">{Day}</code>, <code class="literal">{Hour}</code>, <code class="literal">{Minute}</code> and <code class="literal">{Second}</code> fields.</li></ul></div><p>Once you are satisfied with your choice, you can save the form. After some time, your producers send data; you will see that data from each partition is captured:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/070e435d-875b-41da-9548-c0e889edbede.png" /></div><p> </p><p>What is more, they contain files with data in the following format:</p><pre class="programlisting">Objavro.codecnullavro.schema{"type":"record","name":"EventData","namespace ":"Microsoft.ServiceBus.Messaging","fields":[{"name":"SequenceNumber","type ":"long"},{"name":"Offset","type":"string"},{"name":"EnqueuedTimeUtc","type ":"string"},{"name":"SystemProperties","type":{"type":"map","values":["long ","double","string","bytes"]}},{"name":"Properties","type":{"type":"map","v alues":["long","double","string","bytes","null"]}},{"name":"Body","type":[" null","bytes"]}]}</pre><p>This data can be easily converted to JSON:</p><pre class="programlisting">{
  "definitions" : {
    "record:Microsoft.ServiceBus.Messaging.EventData" : {
      "type" : "object",
      "required" : [ "SequenceNumber", "Offset", "EnqueuedTimeUtc", "SystemProperties", "Properties", "Body" ],
      "additionalProperties" : false,
      "properties" : {
        "SequenceNumber" : {
          "type" : "integer",
          "minimum" : -9223372036854775808,
          "maximum" : 9223372036854775807
        },
        "Offset" : {
          "type" : "string"
        },
        "EnqueuedTimeUtc" : {
          "type" : "string"
        },
        "SystemProperties" : {
          "type" : "object",
          "additionalProperties" : {
            "oneOf" : [ {
              "type" : "integer",
              "minimum" : -9223372036854775808,
              "maximum" : 9223372036854775807
            }, {
              "type" : "number"
            }, {
              "type" : "string"
            }, {
              "type" : "string",
              "pattern" : "^[\u0000-y]*$"
            } ]
          }
        },
        "Properties" : {
          "type" : "object",
          "additionalProperties" : {
            "oneOf" : [ {
              "type" : "integer",
              "minimum" : -9223372036854775808,
              "maximum" : 9223372036854775807
            }, {
              "type" : "number"
            }, {
              "type" : "string"
            }, {
              "type" : "string",
              "pattern" : "^[\u0000-y]*$"
            }, {
              "type" : "null"
            } ]
          }
        },
        "Body" : {
          "oneOf" : [ {
            "type" : "null"
          }, {
            "type" : "string",
            "pattern" : "^[\u0000-y]*$"
          } ]
        }
      }
    }
  },
  "$ref" : "#/definitions/record:Microsoft.ServiceBus.Messaging.EventData"
}</pre><p>You will find more about Avro in the <span class="emphasis"><em>Further reading</em></span><span class="strong"><strong> </strong></span>section.</p></div></div>