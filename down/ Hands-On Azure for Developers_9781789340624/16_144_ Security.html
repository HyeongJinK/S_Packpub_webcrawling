<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch16lvl1sec137"></a>Security</h2></div></div><hr /></div><p>When it comes to Azure SQL<span class="emphasis"><em> </em></span>features, there are multiple different options you can use to make your solution secure. Things such as firewalls, full operation auditing, and data encryption are the common capabilities of this service and are available even for the Basic tier. In this section, we will <span>focus</span><a id="id325310861" class="indexterm"></a> on learning the afore mentioned capabilities, so your instance is secured and immune to most threats.</p><p> </p><p> </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch16lvl2sec163"></a>Firewall</h3></div></div></div><p>When browsing your SQL Database, you probably noticed the <strong class="userinput"><code>Set <span>server</span><a id="id325310841" class="indexterm"></a> firewall</code></strong><span class="strong"><strong> </strong></span>button that is available on the <strong class="userinput"><code>Overview</code></strong><span class="strong"><strong> </strong></span>blade:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/6e12257f-eca3-4be4-9188-1deae84600b1.png" /></div><p>This is the easiest way to set a firewall rule that allows traffic to Azure SQL.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note193"></a>Note</h3><p>In Azure SQL, initially all traffic is rejected—you have to whitelist all IPs of computers that should be allowed to communicate with the server.</p></div><p>Before we start configuring the firewall, you have to understand why we really need it. Here is what happens if I try to connect to my server using Microsoft SQL Server Management Studio:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/37d5576e-4c5c-4f0e-9571-3ac6756fabe6.png" /></div><p>As you can see, it automatically detects that my IP is not whitelisted, hence the server refuses to communicate with me. What we need here is to add a particular IP address, so the communication will be allowed.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip194"></a>Note</h3><p>In fact, the only machines allowed to communicate by default with Azure SQL<span class="emphasis"><em> </em></span>are those that are hosted within Azure. If you want to connect to the server from a local computer, you have to set up a firewall rule.</p></div><p>In the portal, you can add the rule by clicking on the <strong class="userinput"><code>Set <span>server</span><a id="id325128375" class="indexterm"></a> firewall</code></strong><span class="strong"><strong> </strong></span>button—it will display a screen, where you can explicitly set an IP address that should be able to communicate with the server:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/689ef536-36a9-4fcd-bf92-6bc793d9f2ad.png" /></div><p>From this screen, you can also prevent the Azure service from communicating with your instance of Azure SQL. Additionally, you can add a virtual network here—thanks to that feature, you can create the whole ecosystem with your applications and databases, so they are protected from accessing it with a very strict set of rules.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch16lvl2sec164"></a>Advanced Threat Protection</h3></div></div></div><p><span class="strong"><strong>Advanced Threat Protection</strong></span> (<span class="strong"><strong>ATP</strong></span>) is an advanced <span>feature</span><a id="id325143097" class="indexterm"></a> of Azure SQL that by default is not enabled in the service. Currently, it allows for a free trial of 60 days, during which you <span>can</span><a id="id325143106" class="indexterm"></a> test whether this capability is for you. You can enable it using<span class="strong"><strong><strong class="userinput"><code> </code></strong></strong></span>the <span class="strong"><strong><strong class="userinput"><code>Advanced Threat Protection</code></strong> </strong></span>blade:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/f6443d79-37a2-4533-a0a6-445e779ad0e4.png" /></div><p> </p><p> </p><p>As you can see, it consists of three separate features:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Data Discovery &amp; Classification</code></strong>: For analyzing data in terms of sensitivity and legal classification (for example—GDPR requirements)</li><li style="list-style-type: disc"><strong class="userinput"><code>Vulnerability Assessment</code></strong>: This checks your database for possible vulnerabilities using the best practices for SQL Server</li><li style="list-style-type: disc"><strong class="userinput"><code>Threat Detection</code></strong>: A feature which actively monitors your database for suspicious activities and logs them for you</li></ul></div><p>In the following, you can see how Azure SQL<span class="emphasis"><em> </em></span>classifies example data:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/22457a12-8a36-4923-80a2-657ccbbd6b9b.png" /></div><p>It turns out that it automatically detected the information type and declares its sensitivity label. Then it displays a summary, which gives you the overall picture of the shape of the data stored in a database.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip195"></a>Note</h3><p>This feature is a great tool for analyzing big databases for compliance with the new regulations—use it when in doubt as to whether you are storing some sensitive data.</p></div><p> </p><p>When it comes to <strong class="userinput"><code>Vulnerability Assesment</code></strong>, the following are the results of the example scans from my database:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/dee83dc5-db57-47bf-a92c-4997308e778f.png" /></div><p>Once a scan is finished, you are given the <span>result</span><a id="id325181976" class="indexterm"></a> of a security check – it checks things such as data classification, whether auditing is enabled, or who can access data. If, for example, you have many users with a wide range of permissions assigned, there will be an alert raised for that. There are almost 50 rules checked during a scan, which is a great addition on top of all other security features.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip196"></a>Note</h3><p>Even more security guides can be found in the relevant link in the <span class="emphasis"><em>Further reading</em></span><span class="strong"><strong> </strong></span>section.</p></div><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch16lvl2sec165"></a>Auditing</h3></div></div></div><p>If you want to know exactly what <span>happens</span><a id="id325194161" class="indexterm"></a> inside your server, you have to enable auditing:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/2f3687dc-2379-498d-b7e0-3d2d12ca3e92.png" /></div><p>This will log all operations within the selected storage (if, of course, you selected the <strong class="userinput"><code>Storage</code></strong> option). Currently, there are three different options for storing auditing logs:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Storage</code></strong></li><li style="list-style-type: disc"><strong class="userinput"><code>Log Analytics (Preview)</code></strong></li><li style="list-style-type: disc"><strong class="userinput"><code>Event Hub (Preview)</code></strong></li></ul></div><p> </p><p>While <strong class="userinput"><code>Storage</code></strong> is a little bit of a static option, you can use the remaining two for more dynamic integrations (especially when using Azure Event Hub). Once auditing is enabled, you can see all logged operations as well when you click on the <strong class="userinput"><code>View audit logs</code></strong><span class="strong"><strong> </strong></span>button:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/29d5efb1-4fa0-4bd8-9f1a-c35202ec3b5c.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch16lvl2sec166"></a>Dynamic Data Masking</h3></div></div></div><p>Sometimes you want to allow <span>somebody</span><a id="id325215571" class="indexterm"></a> to read data inside a database, yet at the same time you do not want him or her to read more sensitive data (such as birth date, addresses, or surnames). In Azure SQL,<span class="emphasis"><em> </em></span>there is a feature for that named <strong class="userinput"><code>Dynamic Data Maskin</code></strong>g:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/59132731-f3b0-4a3c-b0f7-31ccbaebc536.png" /></div><p>There are two ways to add a mask—either use the recommendation or click on the <strong class="userinput"><code>+ Add Mask</code></strong><span class="strong"><strong> </strong></span>button to add it manually:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/f75877bd-f3cd-407d-9c9c-54e209809fdc.png" /></div><p>What you will have to do select <strong class="userinput"><code>Schema</code></strong>, <strong class="userinput"><code>Table</code></strong>, <strong class="userinput"><code>Column</code></strong>, and the <strong class="userinput"><code>Mask field format</code></strong>—once you configure these and save the rule, users who are not administrators will see the masked values instead. The following shows the values for an admin:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/af27a993-fe00-4eda-9919-3831bb555f4c.png" /></div><p> </p><p> </p><p>The following shows the values for a user without admin rights:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/3154920f-7d5d-41ec-b425-a041017ae4cb.png" /></div><p>As you can see, <code class="literal">LastName</code><span class="strong"><strong> </strong></span>and <code class="literal">Email</code><span class="strong"><strong> </strong></span>are masked for a non-admin user, as planned.</p></div></div>