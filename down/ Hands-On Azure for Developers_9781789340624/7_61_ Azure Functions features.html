<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec63"></a>Azure Functions features</h2></div></div><hr /></div><p>Azure Functions is not <span>only</span><a id="id325128281" class="indexterm"></a> about providing executable code, which will be handled by the runtime. It allows for even more advanced scenarios, which make this service an excellent choice when you want to start developing quickly and with minimal configuration required. In this section, I will show you how to leverage more advanced features of functions<span class="emphasis"><em> </em></span>and how to progress with your skill in using this Azure component.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec59"></a>Platform features</h3></div></div></div><p>As you may remember, Azure Functions is built on top App Service, which <span>allows</span><a id="id325125016" class="indexterm"></a> you to use multiple already known features, such as <strong class="userinput"><code>Custom domains</code></strong>, <strong class="userinput"><code>Application settings</code></strong>, and <strong class="userinput"><code>Authentication/Authorization</code></strong>. To access all available <strong class="userinput"><code>Platform features</code></strong>,<span class="strong"><strong> </strong></span>go to your function app in Azure Portal and click on the appropriate tab:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/581a5a10-cbcb-4c89-aede-5931a609c0d5.png" /></div><p>As you can see, we have a variety of different features available—what you are interested in depends solely on your specific requirements. There is, however, one function-specific feature that I would like to describe: <strong class="userinput"><code>Function app settings</code></strong>.</p><p> </p><p> </p><p>When you click on this link, a new tab will open, with some crucial options that can be set:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/7564928f-2fe5-491f-9745-f80c295cfee9.png" /></div><p>In the preceding screenshot, you can see that most of the features are either not enabled or unavailable. This depends on the state of your function app—by design, all problematic functionalities are opt-out, so they will not interfere with your functions. Anyway, I will describe them here so that you can decide whether you need them or not:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Daily Usage Quota (GB-Sec)</code></strong>: If you want to set a hard limit for function app usage, you can set it here. Thanks to this, you can ensure that it will not exceed some predefined quota you are aiming at.</li><li style="list-style-type: disc"><strong class="userinput"><code>Runtime version</code></strong>: This setting defines the current runtime version your function app uses. Note that it is not possible to change v1 to beta (v2, in this case), as it is possible that the newer version introduces some changes that would break your application.
</li><li style="list-style-type: disc"><strong class="userinput"><code>Function app edit mode</code></strong>: If you decide to deploy your functions with any kind of CI/CD pipeline, this setting will be automatically set to <strong class="userinput"><code>Read Only</code></strong>. This ensures that it is not possible to introduce changes while in runtime without going through the automated process.</li><li style="list-style-type: disc"><strong class="userinput"><code>Slots </code></strong><strong class="userinput"><code>(preview)</code></strong>: If you want to perform blue/green deployment (to perform a rapid rollback if something goes wrong), this enables you to deploy a new version as a new instance and immediately swap it with the existing one.</li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec60"></a>Security</h3></div></div></div><p>We have not covered another important topic yet—Azure <span>Function</span><a id="id325115402" class="indexterm"></a><span class="emphasis"><em> </em></span>security. While it is possible to use, for example, Azure Active Directory or social providers as identity sources (and—as a result—add authentication to a function app), by default, functions are secured by their keys. You can check the available keys when you click on the <strong class="userinput"><code>Manage </code></strong>tab:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/fd7bec6f-4270-47d2-9727-bd05c2d61e68.png" /></div><p>Depending on the way a function is triggered, different options may be available. Here, you can see what another function app looks like when it is triggered by an HTTP trigger instead of a timer:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/56e674d0-626e-4a54-943e-415bac84f9e0.png" /></div><p>As you can see, we have two types of keys available:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>Function Keys</code></strong>: These are designed for this particular function</li><li style="list-style-type: disc"><strong class="userinput"><code>Host Keys</code></strong>: These allow for calling any function within a function app</li></ul></div><p>You can use keys as an easy way to implement authorization in your function app. You can generate a new one for each client, revoke them, and set a particular value. </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note101"></a>Note</h3><p>Note that function keys are designed for functions that are triggered by HTTP requests—there is no possibility to use them for other kinds of triggers.</p></div><p>There are two ways of using function keys to authorize a request. You can put them in the query string:</p><pre class="programlisting">https://handsonazurefunctionapp.azurewebsites.net/api/HttpTriggerJS1?code=awKhkdPqyQvYUwzn6zle6V4hqk460YwOBs9RyaQUthX/AWGBMjtRIA==</pre><p>Or you can use headers and introduce the <code class="literal">x-functions-key</code><span class="strong"><strong> </strong></span>header, which will contain a key inside it:</p><pre class="programlisting">GET /api/HttpTriggerJS1 HTTP/1.1
Host: handsonazurefunctionapp.azurewebsites.net
Content-Type: application/json
x-functions-key: awKhkdPqyQvYUwzn6zle6V4hqk460YwOBs9RyaQUthX/AWGBMjtRIA==
Cache-Control: no-cache</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec61"></a>Monitor</h3></div></div></div><p>Each call and each execution of a <span>function</span><a id="id325117160" class="indexterm"></a> is monitored and saved. When you click on the <strong class="userinput"><code>Monitor </code></strong>tab, you will see a screen that contains the next execution with some diagnostics data.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip102"></a>Note</h3><p>If you do not see a list, you will probably be asked to enable the <strong class="userinput"><code>Application Insights </code></strong>integration. To access standard view, click on the <strong class="userinput"><code>Switch to classic view</code></strong><span class="strong"><strong> </strong></span>button.</p></div><p>Here, you can see the log of executions of my function, triggered by a timer:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/5ad8d1ef-8839-4922-9c49-88e859090711.png" /></div><p>As you can see, it contains information about each particular execution, the success and error count, and invocation details. When you select a specific item, you will also see all of the logs from a function.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note103"></a>Note</h3><p>The <strong class="userinput"><code>Monitor </code></strong>feature is quite useful for quickly analyzing issues. For more detailed errors and logs, you will have to enable <strong class="userinput"><code>Application Insights</code></strong> and use its features.</p></div><p> </p><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec62"></a>Host.json</h3></div></div></div><p>When you create a function, you will see that a <code class="literal">host.json</code><span class="strong"><strong> </strong></span>file is  automatically created. While initially empty, it is a global configuration file that defines how triggers and <span>function</span><a id="id325317162" class="indexterm"></a> will behave. Here, you can find an example file with most features, such as bindings' configuration and generic features, available:</p><pre class="programlisting">{
    "aggregator": {
        "batchSize": 1000,
        "flushTimeout": "00:00:30"
    },
    "applicationInsights": {
        "sampling": {
          "isEnabled": true,
          "maxTelemetryItemsPerSecond" : 5
        }
    },
    "eventHub": {
      "maxBatchSize": 64,
      "prefetchCount": 256,
      "batchCheckpointFrequency": 1
    },
    "functions": [ "QueueProcessor", "GitHubWebHook" ],
    "functionTimeout": "00:05:00",
    "healthMonitor": {
        "enabled": true,
        "healthCheckInterval": "00:00:10",
        "healthCheckWindow": "00:02:00",
        "healthCheckThreshold": 6,
        "counterThreshold": 0.80
    },
    "http": {
        "routePrefix": "api",
        "maxOutstandingRequests": 20,
        "maxConcurrentRequests": 10,
        "dynamicThrottlesEnabled": false
    },
    "id": "9f4ea53c5136457d883d685e57164f08",
    "logger": {
        "categoryFilter": {
            "defaultLevel": "Information",
            "categoryLevels": {
                "Host": "Error",
                "Function": "Error",
                "Host.Aggregator": "Information"
            }
        }
    },
    "queues": {
      "maxPollingInterval": 2000,
      "visibilityTimeout" : "00:00:30",
      "batchSize": 16,
      "maxDequeueCount": 5,
      "newBatchThreshold": 8
    },
    "serviceBus": {
      "maxConcurrentCalls": 16,
      "prefetchCount": 100,
      "autoRenewTimeout": "00:05:00"
    },
    "singleton": {
      "lockPeriod": "00:00:15",
      "listenerLockPeriod": "00:01:00",
      "listenerLockRecoveryPollingInterval": "00:01:00",
      "lockAcquisitionTimeout": "00:01:00",
      "lockAcquisitionPollingInterval": "00:00:03"
    },
    "tracing": {
      "consoleLevel": "verbose",
      "fileLoggingMode": "debugOnly"
    },
    "watchDirectories": [ "Shared" ],
}</pre><p>As you can see, it contains things such as logger settings, function timeout value, and particular triggers configuration. In the <span class="emphasis"><em>Further reading</em></span><span class="strong"><strong> </strong></span>section, you will find a link where each section of the <code class="literal">host.json</code> file is described in detail.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec63"></a>Publish</h3></div></div></div><p>Azure Functions are published the <span>very</span><a id="id325674305" class="indexterm"></a> same way as App Service, since they share many common parts. If you right-click on your functions project in Visual Studio and select <strong class="userinput"><code>Publish</code></strong>, you will see a screen that's similar to the one we saw when working with App Services:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/03cede85-9aae-4e1a-87a4-7735002a9eea.png" /></div><p>Traditionally, you have the possibility to select to either create a new function app or use an existing one. When you use the existing one and click on the <strong class="userinput"><code>Publish </code></strong>button, you will be able to find a function app in a specific <strong class="userinput"><code>Resource Group</code></strong>:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/9a7c19c4-63cf-4e8e-9c82-d3c77b37d1a7.png" /></div><p>Now, when you click <strong class="userinput"><code>OK</code></strong>, a new publish profile will be created and the whole application will be deployed.</p></div></div>