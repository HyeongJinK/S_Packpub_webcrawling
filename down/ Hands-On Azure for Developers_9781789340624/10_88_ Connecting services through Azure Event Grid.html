<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec87"></a>Connecting services through Azure Event Grid</h2></div></div><hr /></div><p>Now that you know something about what <span>Azure</span><a id="id325143076" class="indexterm"></a> Event Grid<span class="emphasis"><em> </em></span>is and how it works, we will try to test it and create a working solution. We will start by creating an instance in Azure Portal and configuring it to accept and route events. You will see also what the schema of an event is and how to leverage it so you can send custom events that will be handled by Event Grid.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec97"></a>Creating Azure Event Grid in Azure Portal</h3></div></div></div><p>To get started with <span>Azure</span><a id="id325143083" class="indexterm"></a> Event Grid, do the following<span class="emphasis"><em> </em></span>in Azure Portal:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Click on + <strong class="userinput"><code>Create a resource</code></strong><span class="strong"><strong> </strong></span>and search for <code class="literal">Event Grid</code>. From the list, select <strong class="userinput"><code>Event Grid Topic</code></strong><span class="strong"><strong> </strong></span>and click <strong class="userinput"><code>Create</code></strong>.</li><li>You will see a really simple form, where you have to enter the name of an instance of a service:</li></ol></div><div class="mediaobject"><img src="/graphics/9781789340624/graphics/6929a214-3eda-426e-9d76-be578180b156.png" /></div><p> </p><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>When you click <strong class="userinput"><code>Create </code></strong>and wait a moment, an instance of a service will be created. Once it is finished, you can go to your resource to see an empty instance:</li></ol></div><div class="mediaobject"><img src="/graphics/9781789340624/graphics/37808196-280e-4d57-82cd-e0ecddc3c600.png" /></div><p> </p><p> </p><p>As you can see, there is no subscription created yet. What is more, there is also no topic, which is what would send events to our instance. Before we proceed, let's take a look what we have on the <strong class="userinput"><code>Overview</code></strong><span class="strong"><strong> </strong></span>blade. Besides the option to create a subscription, there is also one other important thing—<strong class="userinput"><code>Topic Endpoint</code></strong>. You will use this to publish events from your custom topics. There is also one important blade—<strong class="userinput"><code>Access keys</code></strong>. When you click on it, you will see two keys that can be used to authorize access to Azure Event Grid:</p><div class="mediaobject"><img src="/graphics/9781789340624/graphics/b458914b-70ff-4100-91ae-9a456b44c28d.png" /></div><p>Now let's try to create a topic with a subscription. To do so, we will use the following code snippet:</p><pre class="programlisting">$myEndpoint = "&lt;my-endpoint&gt;"

Set-AzureRmContext -Subscription "&lt;subcription-name&gt;"

New-AzureRmEventGridSubscription `
  -Endpoint $myEndpoint `
  -EventSubscriptionName "&lt;event-subscription-name&gt;"
  -ResourceGroupName "&lt;rg-name&gt;"</pre><p>This PowerShell code should create a Resource Group topic that will push events to an endpoint defined in the <code class="literal">$myEndpoint</code><span class="strong"><strong> </strong></span>variable. However, if you execute the code, the following error will occur:</p><pre class="programlisting">New-AzureRmEventGridSubscription : Long running operation failed with status 'Failed'. Additional Info:'The attempt to validate the provided endpoint &lt;your-endpoint&gt;. For more details, visit https://aka.ms/esvalidation.'</pre><p>What has happened? Well, it turns out that we <span>cannot</span><a id="id325115408" class="indexterm"></a> create a subscription, because our endpoint is not validated. How can we validate our endpoint so it will be possible to create a subscription? I will explain shortly.</p><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec98"></a>Azure Event Grid security</h3></div></div></div><p>Besides access tokens, Azure Event <span>Grid</span><a id="id325115426" class="indexterm"></a><span class="emphasis"><em> </em></span>also checks whether or not an endpoint is valid and secure. This validation will not happen for the following handler types:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Azure Logic Apps</li><li style="list-style-type: disc">Azure Automation</li><li style="list-style-type: disc">Azure Functions when <code class="literal">EventGridTrigger</code> is used</li></ul></div><p>The rest of the endpoints (and especially those triggered by an HTTP request) have to be validated to be used. Here is how that kind of validation is processed:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Firstly, <code class="literal">SubscriptionValidationEvent</code><span class="strong"><strong> </strong></span>is sent to an endpoint containing multiple fields, such as topic, validation code, and others. Additionally, a special <code class="literal">aeg-event-type: SubscriptionValidation</code> header is sent.</li><li>Secondly, Event Grid<span class="emphasis"><em> </em></span>expects a success response containing a validation code that was sent in the request.</li></ol></div><p>Here is an example of a validation event:</p><pre class="programlisting">[{
  "id": "3d178aaf-364c-67b-bq0c-e34519da4eww",
  "topic": "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "subject": "",
  "data": {
    "validationCode": "512d38b6-c7b8-40c8-89fe-f46f9e9622b6",
    "validationUrl": "&lt;validation-url&gt;"
  },
  "eventType": "Microsoft.EventGrid.SubscriptionValidationEvent",
  "eventTime": "2018-08-10T10:20:19.4556811Z",
  "metadataVersion": "1",
  "dataVersion": "1"
}]</pre><p>In this scenario, to validate an endpoint, you would have to return the following response:</p><pre class="programlisting">{
  "validationResponse": "512d38b6-c7b8-40c8-89fe-f46f9e9622b6"
}</pre><p>After that, you should be able to create a subscription.</p><p> </p><p> </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip131"></a>Note</h3><p>As you may have noticed, the validation event also contains the <code class="literal">validationUrl</code><span class="strong"><strong> </strong></span>property. It allows you to manually validate a subscription, instead of redeploying code with a proper application logic.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec99"></a>Creating a subscription</h3></div></div></div><p>Now that you are familiar with endpoint <span>validation</span><a id="id325120018" class="indexterm"></a> topic, we can try to create a subscription once more:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>To do so, I created a function that is triggered by an HTTP request. I wrote it quickly in CSX, so I did not have to compile and deploy it manually:</li></ol></div><pre class="programlisting">#r "Newtonsoft.Json"

using System.Net;
using Newtonsoft.Json;

public static async Task&lt;HttpResponseMessage&gt; Run(HttpRequestMessage req, TraceWriter log)
{
 var @event = JsonConvert.DeserializeObject(await req.Content.ReadAsStringAsync());
 log.Info(@event.ToString());

 return req.CreateResponse(HttpStatusCode.OK);
}</pre><p>Thanks to the preceding code, I can see that a validation event was sent to an endpoint. Now, depending on the version of toolset you have, you will have the <code class="literal">validationUrl</code> value in the payload.</p><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>To leverage this feature, you will have to install the Event Grid extension for Azure CLI 2.0—a link for download can be found in the <span class="emphasis"><em>Further reading</em></span><span class="strong"><strong> </strong></span>section. To progress without this feature, we will have to change the code of our function a little bit:</li></ol></div><pre class="programlisting">#r "Newtonsoft.Json"

using System.Net;
using Newtonsoft.Json;

public static async Task&lt;HttpResponseMessage&gt; Run(HttpRequestMessage req, TraceWriter log)
{
 var @event = JsonConvert.DeserializeObject&lt;ValidationEvent[]&gt;(await req.Content.ReadAsStringAsync())[0];

 return req.CreateResponse(HttpStatusCode.OK, new {validationResponse = @event.Data.ValidationCode} );
}

public class ValidationEvent {
 public ValidationEventData Data {get;set;}
}

public class ValidationEventData {
 public string ValidationCode {get;set;}
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Note that I am deserializing the validation event as <code class="literal">ValidationEvent[]</code>, so it is actually an array of events. It is important to bear this in mind to avoid possible issues.</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip132"></a>Note</h3><p>If events were sent to an endpoint that wasn't validated, the batch will be divided into two parts, one with a single validation event, and the second one with the actual events.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Now, if you execute PowerShell code that failed earlier, you should be able to create a subscription. To check whether it all works correctly, you can run the following command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>Get-AzureRmEventGridSubscription</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Here, you can see the result in my case:</li></ol></div><pre class="programlisting">PS C:\Users\kamz&gt; Get-AzureRmEventGridSubscription

 Name Topic ProvisioningState SubjectBeginsWith SubjectEndsWith Endpoint
 ---- ----- ----------------- ----------------- --------------- --------
rg-subscription /subscriptions/&lt;id&gt; Succeeded https://handsonazure-function.azurewebsites.net/api/HttpTriggerCSharp1</pre><p> </p><p> </p><p> </p><p> </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip133"></a>Note</h3><p>Note that subscriptions created with the API are not visible in the Portal. This should be changed soon, but as long as this issue persists, stick mainly to the <span class="strong"><strong>command-line interface</strong></span> (<span class="strong"><strong>CLI</strong></span>) for maintaining Azure Event Grid.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Now if, for example, you create a resource in the resource group that publishes <span>events</span><a id="id325543758" class="indexterm"></a> to Event Grid, an event similar to the following will occur:</li></ol></div><pre class="programlisting"> {
    "subject": "/subscriptions/.../Microsoft.Storage/storageAccounts/handsonazure",
    "eventType": "Microsoft.Resources.ResourceWriteSuccess",
    "eventTime": "2018-08-10T08:51:32.3888833Z",
    "id": "37f85f91-1af9-4ee3-84a6-ee1955c74edc",
    "data": {
      "authorization": {
        "scope": "/subscriptions/.../handsonazure-rg/providers/Microsoft.Storage/storageAccounts/handsonazure",
        "action": "Microsoft.Storage/storageAccounts/write",
        "evidence": {
          "role": "Subscription Admin"
        }
      },
      "claims": {
        "aud": "https://management.core.windows.net/",
        (...)
    } 
  }
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>It is also possible to create a connection like this without the CLI—if you go to your resource group, you will see the <strong class="userinput"><code>Events</code></strong><span class="strong"><strong> </strong></span>blade:</li></ol></div><div class="mediaobject"><img src="/graphics/9781789340624/graphics/d1dee499-3c66-4a4c-8a1b-d0c6c05f45d7.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>When you click on the <strong class="userinput"><code>+ Event subscription</code></strong><span class="strong"><strong> </strong></span>button, you will see a form that makes the whole process much easier. You can use this form if you prefer <span>configuring</span><a id="id326372372" class="indexterm"></a> services in the Portal, instead of the CLI:</li></ol></div><div class="mediaobject"><img src="/graphics/9781789340624/graphics/4600cf95-0add-4fb5-80fd-2ba655412d92.png" /></div></div></div>