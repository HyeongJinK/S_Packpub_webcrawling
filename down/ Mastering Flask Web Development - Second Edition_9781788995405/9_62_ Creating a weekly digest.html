<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec62"></a>Creating a weekly digest</h2></div></div><hr /></div><p>Say our blog has a lot of people who don't use RSS, and prefer mailing lists. We need some way to create a list of new posts at the end of every week to increase our site's traffic. To solve this problem, we will create a digest <span>task</span><a id="id324991592" class="indexterm"></a> that will be called by a beat worker at 10 am, every Saturday.</p><p>First, in <code class="literal">blog/tasks.py</code>, let's create our task as follows:</p><pre class="programlisting">@celery.task(
bind=True,
ignore_result=True,
default_retry_delay=300,
max_retries=5
)
def digest(self):
# find the start and end of this week
year, week = datetime.datetime.now().isocalendar()[0:2]
    date = datetime.date(year, 1, 1)
if (date.weekday() &gt; 3):
        date = date + datetime.timedelta(7 - date.weekday())
else:
        date = date - datetime.timedelta(date.weekday())
    delta = datetime.timedelta(days=(week - 1) * 7)
    start, end = date + delta, date + delta + 
    datetime.timedelta(days=6)

    posts = Post.query.filter(
        Post.publish_date &gt;= start,
Post.publish_date &lt;= end
    ).all()

if (len(posts) == 0):
return

msg = MIMEText(render_template("digest.html", posts=posts), 'html')

    msg['Subject'] = "Weekly Digest"
msg['From'] = current_app.config['SMTP_FROM']

try:
        smtp_server = smtplib.SMTP(current_app.config['SMTP_SERVER'])
        smtp_server.starttls()
        smtp_server.login(current_app.config['SMTP_USER'], 
        current_app.config['SMTP_PASSWORD'])
        smtp_server.sendmail("", [""], msg.as_string())
        smtp_server.close()

return
    except Exception as e:
        self.retry(exc=e)</pre><p>We will also need to add a periodic schedule to our configuration object in <code class="literal">config.py</code> to manage our task:</p><pre class="programlisting">from celery.schedules import crontab
...
CELERYBEAT_SCHEDULE = { 'weekly-digest': { 'task': 'blog.tasks.digest', 'schedule': crontab(day_of_week=6, hour='10') }, }</pre><p> </p><p> </p><p>We also need to configure our SMTP server so that we are able to send emails. This can be done using <span>Gmail or your corporate email credentials</span>. Add your chosen account information to the configuration object in <code class="literal">config.py</code> :</p><pre class="programlisting">...
SMTP_SERVER = "smtp.gmail.com"
SMTP_USER = "sometestemail@gmail.com"
SMTP_PASSWORD = "password"
SMTP_FROM = "from@flask.com"
...</pre><p>Finally, we need our email template. Unfortunately, HTML in email clients is terribly outdated. Every single email client has different rendering bugs and quirks, and the only way to find them is to open your email in all the clients. Many email clients don't even support CSS, and those that do support a very small amount of selectors and attributes. In order to compensate, we have to use the web development methods of 10 years ago; that is, designing tables with inline styles. Here is our <code class="literal">digest.html</code> file:</p><pre class="programlisting">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt; 
&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt; 
  &lt;head&gt; 
    &lt;meta http-equiv="Content-Type" 
      content="text/html; charset=UTF-8" /&gt; 
    &lt;meta name="viewport" 
      content="width=device-width, initial-scale=1.0"/&gt; 
    &lt;title&gt;Weekly Digest&lt;/title&gt; 
  &lt;/head&gt; 
  &lt;body&gt; 
    &lt;table align="center" 
      border="0" 
      cellpadding="0" 
      cellspacing="0" 
      width="500px"&gt; 
      &lt;tr&gt; 
        &lt;td style="font-size: 32px; 
          font-family: Helvetica, sans-serif; 
          color: #444; 
          text-align: center; 
          line-height: 1.65"&gt; 
          Weekly Digest 
        &lt;/td&gt; 
      &lt;/tr&gt; 
      {% for post in posts %} 
      &lt;tr&gt; 
        &lt;td style="font-size: 24px; 
          font-family: sans-serif; 
          color: #444; 
          text-align: center; 
          line-height: 1.65"&gt; 
          {{ post.title }} 
        &lt;/td&gt; 
      &lt;/tr&gt; 
      &lt;tr&gt; 
        &lt;td style="font-size: 14px; 
          font-family: serif; 
          color: #444; 
          line-height:1.65"&gt; 
          {{ post.text | truncate(500) | safe }} 
        &lt;/td&gt; 
      &lt;/tr&gt; 
      &lt;tr&gt; 
        &lt;td style="font-size: 12px; 
          font-family: serif; 
          color: blue; 
          margin-bottom: 20px"&gt; 
          &lt;a href="{{ url_for('.post', post_id=post.id) }}"&gt;Read 
             More&lt;/a&gt; 
        &lt;/td&gt; 
      &lt;/tr&gt; 
      {% endfor %} 
    &lt;/table&gt; 
  &lt;/body&gt; 
&lt;/html&gt; </pre><p>Now, at the end of every week, our digest <span>task</span><a id="id325371849" class="indexterm"></a> will be called, and will send an email to all the users present in our mailing list.</p></div>