<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec61"></a>Creating a reminder app</h2></div></div><hr /></div><p>Let's get into some real-world example applications of Celery. Suppose another page on our site now requires a reminders feature. Users can create reminders that will send an email to a specified location at a specified time. We will need a model, a task, and a way to call our <span>task</span><a id="id324991598" class="indexterm"></a> automatically every time a model is created.</p><p>Let's start with the following basic SQLAlchemy model:</p><pre class="programlisting">class Reminder(db.Model): 
    id = db.Column(db.Integer(), primary_key=True) 
    date = db.Column(db.DateTime()) 
    email = db.Column(db.String()) 
    text = db.Column(db.Text()) 
  
    def __repr__(self): 
        return "&lt;Reminder '{}'&gt;".format(self.text[:20]) </pre><p>Now, we need a task that will send an email to the location in the model. In our <code class="literal">blog/tasks.py</code> file, look up the following task:</p><pre class="programlisting">@celery.task(
bind=True,
ignore_result=True,
default_retry_delay=300,
max_retries=5
)
def remind(self, pk):
    reminder = Reminder.query.get(pk)
    msg = MIMEText(reminder.text)

    msg['Subject'] = "Your reminder"
msg['From'] = current_app.config['SMTP_FROM']
msg['To'] = reminder.email
try:
        smtp_server = smtplib.SMTP(current_app.config['SMTP_SERVER'])
        smtp_server.starttls()
        smtp_server.login(current_app.config['SMTP_USER'], 
        current_app.config['SMTP_PASSWORD'])
        smtp_server.sendmail("", [reminder.email], msg.as_string())
        smtp_server.close()
return
    except Exception as e:
        self.retry(exc=e)</pre><p> </p><p> </p><p>Note that our task takes a primary key, rather than a model. This is a hedge against a race condition, as a passed model could be stale by the time the worker finally gets around to processing it. You will also have to replace the placeholder emails and login details with your own login info.</p><p>How do we have our task called when the user creates a reminder model? We will use an SQLAlchemy feature, named <code class="literal">events</code>. SQLAlchemy allows us to register callbacks on our models that will be called when specific changes are made to our models. Our task will use the <code class="literal">after_insert</code> event, which is called after new data is entered into the database, whether the model is brand new or being updated.</p><p>We need a callback in <code class="literal">blog/tasks.py</code>:</p><pre class="programlisting">def on_reminder_save(mapper, connect, self): 
    remind.apply_async(args=(self.id,), eta=self.date) </pre><p>Now, in <code class="literal">blog/__init__.py</code>, we will register our callback on our model:</p><pre class="programlisting">from sqlalchemy import event
from .models import db, Reminder
from .tasks import on_reminder_save


def create_module(app, **kwargs):
<span class="strong"><strong>event.listen(Reminder, 'after_insert', on_reminder_save)</strong></span>
from .controllers import blog_blueprint
    app.register_blueprint(blog_blueprint)</pre><p>Now, every time a model is saved, a task is registered that will send an email to our user.</p></div>