<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec39"></a>OpenID</h2></div></div><hr /></div><p>To integrate OpenID <span>authentication</span><a id="id325378748" class="indexterm"></a> with our application, we are going to use a new Flask extension named <span class="strong"><strong>Flask-OpenID, </strong></span>implemented by the <span class="strong"><strong>Flask </strong></span>creator itself. As always, the extension needs to be added to the <code class="literal">requirements.txt</code> file, as follows:</p><pre class="programlisting">...<span class="strong"><strong>
Flask-OpenID
</strong></span>...</pre><p>Our app will also need a couple of things to implement OpenID:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">A new form object</li><li style="list-style-type: disc">The form validation in the login and registration pages</li><li style="list-style-type: disc">A callback after the form submission to log the user in or create a new user</li></ul></div><p>In the <code class="literal">auth/__init__.py</code> file, the <code class="literal">OpenID</code> object can be initialized as follows:</p><pre class="programlisting">...
from flask_openid import OpenID
...  
oid = OpenID() </pre><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p>In the <code class="literal">create_module</code> function, the <code class="literal">oid</code> object is registered to the <code class="literal">app</code> object, as follows:</p><pre class="programlisting">def create_module(app, **kwargs):
    ...
    oid.init_app(app)
    ...</pre><p>The new <code class="literal">form</code> object will only need the URL of the <code class="literal">OpenID</code> provider. In <code class="literal">auth/forms.py</code><span>, enter the following:</span></p><pre class="programlisting">from wtforms.validators import DataRequired, Length, EqualTo, URL
class OpenIDForm(Form): 
  openid = StringField('OpenID URL', [DataRequired(), URL()]) </pre><p>In the login and registration views, <code class="literal">OpenIDForm()</code> will be initialized, and if the data is valid, a login request will be sent. In <code class="literal">auth/views.py</code>, enter the following:</p><pre class="programlisting">...
 
@auth_blueprint.route('/login', methods=['GET', 'POST']) 
@oid.loginhandler 
def login(): 
  form = LoginForm() 
  <span class="strong"><strong>openid_form = OpenIDForm() 
  if openid_form.validate_on_submit(): 
    return oid.try_login( 
      openid_form.openid.data, 
      ask_for=['nickname', 'email'], 
      ask_for_optional=['fullname'] 
    )</strong></span> 
  if form.validate_on_submit(): 
    flash("You have been logged in.", category="success") 
    return redirect(url_for('blog.home')) 
  <span class="strong"><strong>openid_errors = oid.fetch_error() 
  if openid_errors: 
    flash(openid_errors, category="danger")</strong></span> 
  return render_template( 
    'login.html', 
    form=form, 
    <span class="strong"><strong>openid_form=openid_form</strong></span> 
  ) 
 
@main_blueprint.route('/register', methods=['GET', 'POST']) 
@oid.loginhandler 
def register(): 
  form = RegisterForm() 
  <span class="strong"><strong>openid_form = OpenIDForm() 
  if openid_form.validate_on_submit(): 
    return oid.try_login( 
      openid_form.openid.data, 
      ask_for=['nickname', 'email'], 
      ask_for_optional=['fullname'] 
    )</strong></span> 
  if form.validate_on_submit(): 
    new_user = User(form.username.data) 
    new_user.set_password(form.password.data) 
    db.session.add(new_user) 
    db.session.commit() 
    flash( 
      "Your user has been created, please login.", 
      category="success" 
    ) 
    return redirect(url_for('.login')) 
  <span class="strong"><strong>openid_errors = oid.fetch_error() 
  if openid_errors: 
    flash(openid_errors, category="danger")</strong></span> 
  return render_template( 
    'register.html', 
    form=form, 
    openid_form=openid_form 
  ) </pre><p>Both the views have the new decorator <code class="literal">@oid.loginhandler</code>, which tells Flask-OpenID to listen for authentication information coming back from the provider. With OpenID, logging in and registering are the same. It is possible to create a user from the login form and to log in from the registration form. The same field appears on both pages to avoid confusing the user.</p><p>To handle the user creation and login, a new function in the <code class="literal">auth/__init__.py</code> file is needed, as shown in the following code:</p><pre class="programlisting">@oid.after_login 
def create_or_login(resp): 
    from models import db, User 
    username = resp.fullname or resp.nickname or resp.email 
    if not username: 
      flash('Invalid login. Please try again.', 'danger') 
      return redirect(url_for('main.login')) 
    user = User.query.filter_by(username=username).first() 
    <span class="strong"><strong># if the user does not exist create it</strong></span>
    if user is None: 
      user = User(username) 
      db.session.add(user)</pre><p> </p><p> </p><p> </p><p> </p><pre class="programlisting">      db.session.commit() 
    <span class="strong"><strong>login_user(user)</strong></span>
    return redirect(url_for('main.index')) </pre><p>This function is called after every successful response from the provider. If the login is successful and a user object does not exist for the <span>identity</span>, then this function creates a new <code class="literal">User</code> object. If one already exists, the upcoming <span>authentication</span><a id="id324993940" class="indexterm"></a> methods will log the user in. OpenID does not require all possible information to be returned, so it is possible that not a full name, but only an email address will be returned. This is why the username can be the nickname, full name, or email address. The <code class="literal">db</code> and <code class="literal">User</code> object are imported inside the function to avoid cyclical imports from the <code class="literal">models.py</code> file that is importing the <code class="literal">bcrypt</code> object.</p></div>