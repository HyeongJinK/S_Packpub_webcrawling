<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec22"></a>Database migrations with Alembic</h2></div></div><hr /></div><p>The functionality of web apps <span>changes</span><a id="id325375206" class="indexterm"></a> all the time, and with every new functionality, we need to change the structure of our database. Whether it's adding or dropping new columns or creating new tables, our models will change throughout the life cycle of our app. However, problems quickly arise when the database changes often. When moving our changes from development to production, how can you be sure that you carried over every change without manually comparing each model and its corresponding table? Let's say that you want to go back into your Git history to see whether an earlier version of your app had the same bug that you are now encountering in production. How will you change your database back to the correct schema without a lot of extra work?</p><p>As programmers, we hate extra work. Thankfully, there is a tool called <span class="strong"><strong>Alembic</strong></span>, which automatically creates and tracks database migrations from the changes in our SQLAlchemy models. <span class="strong"><strong>Database migrations</strong></span> are records of all the <span>changes</span><a id="id325378667" class="indexterm"></a> of our schema. Alembic allows us to upgrade or downgrade our database to a specific saved version. Upgrading or downgrading by several versions will execute all the files between the two selected versions. The best thing about Alembic is that its history files are only Python files. When we create our first migration, we can see how simple the Alembic syntax is.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note13"></a>Note</h3><p>Alembic does not capture every possible change—for example, it does not record changes on the SQL indexes. After every migration, the reader is encouraged to review the migration file and make any necessary corrections.</p></div><p>We won't work directly with Alembic. Instead, we will use <span class="strong"><strong>Flask-Migrate</strong></span>, which is an <span>extension</span><a id="id325378688" class="indexterm"></a> created specifically for SQLAlchemy, and which works with the Flask CLI. You will find it in the <code class="literal">requirements.txt</code> file, as shown in the following code:</p><pre class="programlisting"><span class="strong"><strong>Flask-Migrate</strong></span></pre><p>To get started, we don't need to add anything to our <code class="literal">manage.py</code> file since Flask-Migrate already extends the Flask CLI with its own CLI options, as shown in the following code:</p><pre class="programlisting">from main import app, db, User, Post, Tag, migrate


@app.shell_context_processor
def make_shell_context():
    return dict(app=app, db=db, User=User, Post=Post, Tag=Tag, migrate=migrate)</pre><p>And on our <code class="literal">main.py</code>:</p><pre class="programlisting">import datetime

from flask import Flask
from flask_sqlalchemy import SQLAlchemy
<span class="strong"><strong>from flask_migrate import Migrate</strong></span>
from config import DevConfig

app = Flask(__name__)
app.config.from_object(DevConfig)

db = SQLAlchemy(app)
<span class="strong"><strong>migrate = Migrate(app, db)</strong></span></pre><p>To initialize the <code class="literal">Migrate</code> object with our app and our SQLAlchemy instance, run the following code:</p><pre class="programlisting">    # Tell Flask where is our app
<span class="strong"><strong>$ export FLASK_APP=main.py
</strong></span><span class="strong"><strong>$ flask db</strong></span></pre><p>To start tracking our changes, we use the <code class="literal">init</code> command, as follows:</p><pre class="programlisting"><span class="strong"><strong>$ flask db init</strong></span></pre><p>This will create a new folder in our directory named <code class="literal">migrations</code> that will hold all of our history. Now we start with our first migration, as shown in the following code:</p><pre class="programlisting"><span class="strong"><strong>$ flask db migrate -m"initial migration"</strong></span></pre><p>This command will cause Alembic to scan our SQLAlchemy object and find all the tables and columns that did not exist before this commit. As this is our first commit, the migration file will be rather long. Be sure to specify the migration message with <code class="literal">-m</code>, as it's the easiest way to identify what each migration is doing. Each migration file is stored in the <code class="literal">migrations/versions/</code> folder.</p><p>To apply the migration to your database and change your schema, run the following code:</p><pre class="programlisting"><span class="strong"><strong>$ flask db upgrade</strong></span></pre><p>If we want to check out all the SQLAlchemy generated DDL code, then we use the following code:</p><pre class="programlisting"><span class="strong"><strong>$ flask db upgrade --sql</strong></span></pre><p>To return to the previous version, find the version number with the <code class="literal">history</code> command and pass it to the <code class="literal">downgrade</code> command, as follows:</p><pre class="programlisting"><span class="strong"><strong>$ flask db history</strong></span>
&lt;base&gt; -&gt; 7ded34bc4fb (head), initial migration
<span class="strong"><strong>$ flask db downgrade 7ded34bc4fb</strong></span></pre><p>Like Git, a hash marks each migration. This is the main functionality of Alembic, but it is only surface level. Try to align your migrations with your Git commits in order to make it easier to downgrade or upgrade when reverting commits.</p><p>In the code for this book, you will find in each chapter an <span>initialization</span><a id="id325380343" class="indexterm"></a> script that will <span>create</span><a id="id324984560" class="indexterm"></a> a Python virtual environment, install all declared dependencies, and initialize the database. Take a look at the <code class="literal">init.sh</code> Bash script.</p></div>