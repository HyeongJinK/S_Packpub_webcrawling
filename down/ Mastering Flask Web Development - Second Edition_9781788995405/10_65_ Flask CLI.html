<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec64"></a>Flask CLI</h2></div></div><hr /></div><p>In <a class="link" href="#" linkend="ch01"><span>Chapter 1</span></a>, <span class="emphasis"><em>Getting Started</em></span>, we introduced some basic features and learned how to use Flask CLI. Now, we are going to see how to make good use of this feature.</p><p>In Flask CLI, you can create custom commands to be run within the <span>application</span><a id="id325375177" class="indexterm"></a> context. Flask CLI itself uses <span class="strong"><strong>Click</strong></span>,which is a library developed by the creator of Flask to create command-line tools <span>with</span><a id="id325375188" class="indexterm"></a> complex arguments early.</p><p> </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip37"></a>Note</h3><p>For further details on Click, take a look at the documentation, available at <a class="ulink" href="http://click.pocoo.org" target="_blank">http://click.pocoo.org</a>.</p></div><p>Our goal is to create a set of commands to help us manage and deploy our Flask app. The first problem to tackle is where and how we are going to create these command-line functions. Since our CLI is an <span>application global utility</span>, we are going to place it in <code class="literal">webapp/cli.py</code>:</p><pre class="programlisting">import logging
<span class="strong"><strong>import </strong></span><span class="strong"><strong>click</strong></span>
from .auth.models import User, db

log = logging.getLogger(__name__)

<span class="strong"><strong>def register(app):</strong></span>
<span class="strong"><strong>    @app.cli.command('create-user')</strong></span>
<span class="strong"><strong>    @click.argument('username')</strong></span>
<span class="strong"><strong>    @click.argument('password')</strong></span>
def create_user(username, password):
        user= User()
        user.username = username
        user.set_password(password)
try:
            db.session.add(user)
            db.session.commit()
            click.echo('User {0} Added.'.format(username))
except Exception as e:
            log.error("Fail to add new user: %s Error: %s" 
            % (username, e))
            db.session.rollback()
...</pre><p>We are going to develop all of our functions inside the <code class="literal">register</code> function, so that we don't have to import our Flask app from the main module. Doing so would result in a circular dependency import. Next, take note of the following decorators we use:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"> <code class="literal">@app.cli.command</code> registers that our function has a new command-line command; if no argument is passed, then <code class="literal">Click</code> will assume the function's name.</li><li style="list-style-type: disc"><code class="literal">@click.argument</code> adds a command-line argument; in our case, for username and password (needed to <span>create the user credentials</span>). Arguments are positional command-line options.</li></ul></div><p>We register all of our command-line functions in <code class="literal">main.py</code>. Note the highlighted text in the following snippet, where we call the previously created <code class="literal">register</code> method:</p><pre class="programlisting">import os
from webapp import create_app
<span class="strong"><strong>from webapp.cli import register</strong></span>

env = os.environ.get('WEBAPP_ENV', 'dev')
app = create_app('config.%sConfig' % env.capitalize())
<span class="strong"><strong>register(app)</strong></span>

if __name__ == '__main__':
    app.run()</pre><p>From the CLI, let's try our newly created command as follows:</p><pre class="programlisting"># First we need to export our FLASK_APP env var
<span class="strong"><strong>$ export FLASK_APP=main.py</strong></span>
<span class="strong"><strong>$ flask create-user user10 password</strong></span>
User user10 Added.
<span class="strong"><strong>$ flask run
</strong></span> * Serving Flask app "main"
2018-08-12 20:25:43,031:INFO:werkzeug: * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)<span class="strong"><strong>
</strong></span></pre><p>Next, you can go to your web browser and log in to our blog using the newly created <code class="literal">user10</code> credentials.</p><p>The provided code also includes a <code class="literal">list-users</code> command, but its implementation should be straightforward for you by now, without any additional explanation here. Let's focus on a simple and handy function to show all of our app's routes:</p><pre class="programlisting">@app.cli.command('list-routes')
def list_routes():
for url in app.url_map.iter_rules():
        click.echo("%s %s %s" % (url.rule, url.methods, url.endpoint))</pre><p> </p><p>The <code class="literal">list-routes</code> command lists all of the routes registered on the <code class="literal">app</code> object, and the URL tied to that route. This is very useful while debugging Flask extensions, as it makes it trivial to see whether or not the registration of <span>its</span> blueprints is working.</p></div>