<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch15lvl1sec105"></a>Understanding HealthKit</h2></div></div><hr /></div><p><span class="strong"><strong>HealthKit</strong></span> is a <span>framework</span><a id="id325333120" class="indexterm"></a> that allows developers to interact with a user's health data. This data includes information like a user's weight, BMI, blood type, biological sex, skin type, date of birth, whether they use a wheelchair, and much more. In addition to these metrics, HealthKit also provides access to activity data, such as workouts or the amount of steps the user has walked on a given day.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note44"></a>Note</h3><p>HealthKit is available on the iPhone and Apple Watch only. The iPad does not have support for HealthKit, so you must take special precautions to determine whether HealthKit is available, by calling <code class="literal">isHealthDataAvailable()</code> on the <code class="literal">HKHealthStore</code> class.</p></div><p>Because health data is considered private and thus very sensitive, apps that want access to health data have to specify their reasons for wanting to read and/or write data to <span>HealthKit</span><a id="id325606068" class="indexterm"></a> in the <code class="literal">Info.plist</code>, under the following keys:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Privacy: Health Share Usage Description (<code class="literal">NSHealthShareUsageDescription</code>) for reading data from the HealthKit store</li><li style="list-style-type: disc">Privacy: Health Update Usage Description (<code class="literal">NSHealthUpdateUsageDescription</code>) for writing data to the HealthKit store</li><li style="list-style-type: disc">Privacy: Health Records Usage Description (<code class="literal">NSHealthClinicalHealthRecordsShareUsageDescription</code>) for reading record data from the HealthKit store</li></ul></div><p>In addition to adding the appropriate <code class="literal">Info.plist</code> entries, you must also enable the HealthKit capability in your app's Capabilities tab. This will configure your app with the required entitlements for accessing the HealthKit store. When you enable the HealthKit capability, you have the option to enable access to health records. Health records are specific records that contain clinical data.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec83"></a>Requesting access to the HealthKit Store</h3></div></div></div><p>Applications that want access to health-related data must ask permission for every type of data they want to access. If your app requires access to heart rate data, weight data, and activity data, that means that you must request access for each different data type. A single authorization request can ask for access to multiple data types at once, and the user can manually decide which data types can be accessed.</p><p>When you want to use certain data types from the <span>HealthKit</span><a id="id325607104" class="indexterm"></a> store, it's essential that you make sure your user understands why you need access to this data and to request access at an appropriate time. If your app has an onboarding flow, you could add a page that outlines the health data your app needs and asks the user for permission once they understand why you need access. The following <span>screenshot</span><a id="id325607112" class="indexterm"></a> shows the access dialog where users can configure the type of data an app is allowed to access:</p><div class="mediaobject"><img src="/graphics/9781789133202/graphics/1164efe8-fefd-4ff7-8ea6-2b74081ac3db.png" /></div><p></p><p>The preceding <span>screenshot</span><a id="id325607233" class="indexterm"></a> shows all the different categories that this app wants to have read and write access for. An authorization request is performed to request access to a set of HealthKit categories. The following code is an example of the request that was used for the screenshot:</p><pre class="programlisting">let objectTypes: Set&lt;HKSampleType&gt; = [HKObjectType.workoutType(), HKObjectType.quantityType(forIdentifier: .activeEnergyBurned)!, HKObjectType.quantityType(forIdentifier: .distanceWalkingRunning)!]

healthKitStore.requestAuthorization(toShare: objectTypes, read: objectTypes) { success, error in
  print(success)
  print(error)
}</pre><p>A user can revoke access to data at any time in the Health app, so apps must make sure that they presently have access to data before attempting to use it. The following code shows a sample of how to retrieve the authorization status for the <code class="literal">.distanceWalkingRunning</code> quantity type:</p><pre class="programlisting">let objectType = HKObjectType.quantityType(forIdentifier: .distanceWalkingRunning)!
let status = healthKitStore.authorizationStatus(for: objectType)</pre><p>The possible values for the authorization status are the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">.sharingAuthorized</code></li><li style="list-style-type: disc"><code class="literal">.sharingDenied</code></li><li style="list-style-type: disc"><code class="literal">.notDetermined</code></li></ul></div><p>Your app can't determine whether reading from the store is allowed. The reasoning for this is that denying an app access to data might hint that the user has something to hide. Since health data is very personal, it's important that apps can't make any assumptions based on the access they do or do not have the HealthKit. This means that if an app queries data while it doesn't have read access, HealthKit will return an empty result set. If the app has write access to HealthKit, only the results that the app wrote to the store will be returned.</p><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec84"></a>Storing and retrieving data with HealthKit</h3></div></div></div><p>All data that is stored in the <span>HealthKit</span><a id="id325609980" class="indexterm"></a> store is stored as an <code class="literal">HKSample</code> subclass, and is associated with a corresponding <code class="literal">HKObjectType</code> and an <code class="literal">HKObject</code>. Together, these objects describe what a user did, what value is associated with the sample, and when it occurred. The following code is a sample of adding a short walk of 100 meters to the <span>HealthKit</span><a id="id325611540" class="indexterm"></a> store:</p><pre class="programlisting">let object = HKQuantity(unit: HKUnit.meter(), doubleValue: 100)
let objectType = HKObjectType.quantityType(forIdentifier: .distanceWalkingRunning)
let distance = HKQuantitySample(type: objectType!, quantity: object, start: Date(), end: Date())

healthKitStore.save(distance) { success, error in
  print(success)
  print(error)
}</pre><p>To provide greater flexibility and unit conversion, HealthKit uses <code class="literal">HKUnit</code> objects to represent units like meters, inches, pounds, liters, and more. Because all HealthKit operations are asynchronous, the <code class="literal">save(_:withCompletion:)</code> method takes a completion callback that is called after the operation has completed.</p><p>To retrieve data from the HealthKit store, you use <code class="literal">HKQuery</code> objects. For instance, to retrieve a user's active energy burned for the past ten days, you would use a query that looks as follows:</p><pre class="programlisting">let predicate = NSPredicate(format: "%K &gt; %@", HKPredicateKeyPathStartDate, (Date() - 60 * 60 * 24 * 10) as NSDate)
let sortDescriptors = [NSSortDescriptor(key: HKSampleSortIdentifierStartDate, ascending: false)]
let objectType = HKObjectType.quantityType(forIdentifier: .activeEnergyBurned)!
let query = HKSampleQuery(sampleType: objectType, predicate: predicate, limit: Int(HKObjectQueryNoLimit), sortDescriptors: sortDescriptors]) { query, samples, error in
  print(samples)
  print(error)
  print(query)
}

healthKitStore.execute(query)</pre><p> </p><p> </p><p> </p><p> </p><p>The preceding sample sets up an <code class="literal">NSPredicate</code> to filter the results that are returned by the query. HealthKit provides several helpers, including <code class="literal">HKPredicateKeyPathStartDate</code>, so you don't have to manually type the correct key paths that are used to filter and sort data.</p><p>The records that you receive from <span>HealthKit</span><a id="id325617701" class="indexterm"></a> contain metadata about the record itself. For instance, you can read the value that is associated with the record, the start and end dates, and even the source that added the record to the <span>HealthKit</span><a id="id325617709" class="indexterm"></a> store. All data that you retrieve from HealthKit is immutable. This means that you can't modify existing records that have already been saved to HealthKit.</p><p>The previous samples for storing and fetching data used metrics that are expressed as <code class="literal">HKQuantitySample</code> objects. This type of object is for data that is represented as a certain number. Walking distance, calories burned, or even weight are examples of this.</p><p>HealthKit also records data in the form of <code class="literal">HKCategorySample</code>. The value for a category sample is expressed as an enum value. Sleep tracking is an example of a metric that is tracked as a category sample. The user is either in bed, asleep, or awake. You can't add custom values to this type of sample.</p><p>Now that you are up to speed with gaining access to the HealthKit store and know how to read and write data, let's implement a small application that tracks a user's walks.</p></div></div>