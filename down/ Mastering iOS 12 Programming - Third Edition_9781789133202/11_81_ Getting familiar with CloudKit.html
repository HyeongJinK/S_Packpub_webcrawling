<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch11lvl1sec79"></a>Getting familiar with CloudKit</h2></div></div><hr /></div><p><span class="strong"><strong>CloudKit</strong></span> is a <span>service</span><a id="id325333120" class="indexterm"></a> that Apple created as a simple tool for application developers to store data on a remote server. The beauty of this service is that any user with an iCloud account can be identified automatically by CloudKit, meaning you can begin connecting data to your user immediately without having them first sign up for your service.</p><p>Signup screens are often considered to be dealbreakers for users because they don't want to share their email address with certain apps, or just because they think signing up for a particular app isn't worth the effort. With CloudKit, you can remove all this friction because users are discretely logged into your app using the iCloud account that they already use on their device.</p><p>When you add CloudKit to your app, you will find that it offers a lot of great functionalities to help you keep the number of web requests as low as possible, and you can even have CloudKit notify your app when something changes on the remote server even when your app isn't running. Apple uses features such as these extensively in their own applications to try to make sure that their apps provide a seamless experience between devices.</p><p>To add CloudKit to the <span class="strong"><strong>MustC</strong></span> app, you don't need to do a lot of work. All you need to do is make sure your project is set up correctly and enable the required capabilities for your app.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec58"></a>Adding CloudKit to your project</h3></div></div></div><p><span>First, make</span> sure the <span>Xcode</span><a id="id325615341" class="indexterm"></a> project is set up correctly. Note that the <span>project</span><a id="id325617706" class="indexterm"></a> files in this book's code bundle have been modified in preparation of this chapter. If you want to follow along with the steps in this chapter, make sure to grab the <span class="strong"><strong>MustC</strong></span> starter project for this chapter from the code bundle. You need to have a unique bundle identifier for the <span class="strong"><strong>MustC</strong></span> app. The code bundle that goes with this book uses a bundle identifier of <code class="literal">com.donnywals.MustC</code>. Make sure that you change this to something unique. Also, make sure that you have selected a valid developer team under Xcode's signing options. Refer to the following screenshot to see an example of what your <strong class="userinput"><code>General</code></strong> settings should look like:</p><div class="mediaobject"><img src="/graphics/9781789133202/graphics/2efefafa-fcf2-41c3-8623-a522499ab2ee.png" /></div><p>Next, open the <span class="strong"><strong>Capabilities</strong></span> tab in the project settings. Scroll down until you see the <span class="strong"><strong>iCloud</strong></span> capability. Make sure to toggle it so it's turned on and expand the iCloud section. Check the <span class="strong"><strong>CloudKit</strong></span> checkbox to enable CloudKit for your application, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781789133202/graphics/08429710-d6c9-421d-b221-dcfa07cc2c83.png" /></div><p>Toggling the iCloud capability has added an entitlements file to your project. This file is coupled to your Xcode signing identity and it makes sure that your app is allowed to use certain capabilities. You should not make manual changes to this file because Xcode will automatically ensure that it matches the <strong class="userinput"><code>Capabilities</code></strong> tab in your project settings.</p><p>Note that enabling iCloud and <span>CloudKit</span><a id="id325580668" class="indexterm"></a> also turns on the Push Notifications entitlement. This entitlement was added to your application so it can receive notifications about changes in your <span>CloudKit</span><a id="id325580677" class="indexterm"></a> database in the background. You'll learn more about this later in the chapter.</p><p>Technically this is all you need to do to add CloudKit to your app. Before you learn how to perform read and write operations on your CloudKit database, you should familiarize yourself with the heart of your CloudKit backend, the dashboard.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec59"></a>Exploring the CloudKit dashboard</h3></div></div></div><p>If you look at the <span class="strong"><strong>Capabilities</strong></span> tab in your project settings, there is a <strong class="userinput"><code><span>CloudKit</span><a id="id325580699" class="indexterm"></a> Dashboard</code></strong> button underneath your iCloud capability configuration. Click this button or navigate to <a class="ulink" href="https://icloud.developer.apple.com/dashboard/" target="_blank">https://icloud.developer.apple.com/dashboard/</a> in your web browser to go to the CloudKit dashboard. After logging into the dashboard, you'll see your developer teams and the containers that you have set up for each team.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note33"></a>Note</h3><p>Sometimes it takes a little while for a new container to show up in the CloudKit dashboard. If your project doesn't show up right away, don't worry. Just take a five-minute break and then check whether your container shows up.</p></div><p>A CloudKit container uses a unique identifier that is based on your app's bundle identifier. To explore your CloudKit container, click it. You should see a screen that resembles the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781789133202/graphics/1077ede0-18dc-45c3-9b90-e9d6f4b5087b.png" /></div><p>This screen is the starting point for your container. Every container has a development environment and a production environment. This is convenient because it allows you to experiment as much as you'd like in your development database without disrupting the production database where your user's data will live.</p><p>From this screen, you can monitor what your container is doing, how much it's used, and you can even access logs that help you with debugging issues if you encounter them. For now, go to the <strong class="userinput"><code>Data</code></strong> section so you can explore your <span>CloudKit</span><a id="id325580773" class="indexterm"></a> container's data store.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch11lvl3sec29"></a>Understanding your CloudKit database</h4></div></div></div><p>In order to efficiently use <span>CloudKit</span><a id="id325580788" class="indexterm"></a> to store data, you must understand how it stores data and what terminology is used for the different components that are used throughout your database. Every CloudKit container comes with a couple of different databases:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">A private database for each user</li><li style="list-style-type: disc">A shared database for each user</li><li style="list-style-type: disc">A public database that's shared for all users</li></ul></div><p>It's important that you use the correct database whenever you write data to CloudKit, you wouldn't want to accidentally store some sensitive user information in the public database because that could potentially expose the information to all users of your app. You should only use the public database for data that is suited for <span class="emphasis"><em>all</em></span> users of an application.</p><p>For instance, if you're building a news app, it would make sense to store all the news and possibly comments on news articles in the public database for your container. However, saving a user's to-do list should be stored in the private database because no other users have any business with another user's to-do list.</p><p>One exception to this is when a user shares their list or individual items with another user. This shared data can be stored in the shared database where only users that have explicitly gained access to the records are allowed to access them.</p><p>Now that you know about the different types of databases, let's have a look at the data page itself to see what kind of options you have to manage data there.</p><p>The leftmost tab in the data manager is the <span class="strong"><strong><strong class="userinput"><code>Zones</code></strong></strong></span> tab. You can use <span>zones</span><a id="id325580823" class="indexterm"></a> to logically group certain parts of your database together. For instance, you could create zones for data that originated from different origins. The private and public databases come with a default zone. You cannot create custom zones for the public database so all public data is automatically stored in the default zone. For the private and shared databases, you can create custom zones.</p><p>Note that the zones page has the option to <strong class="userinput"><code>Fetch zone changes since...</code></strong> This is a performance optimization that makes sure apps can load a minimal amount of data whenever they want to synchronize with the data from CloudKit. If you want to add a custom zone, you can do so by clicking on the <span class="strong"><strong><strong class="userinput"><code>Create new Zone..</code></strong>.</strong></span> button. While you're there, create a new zone for the private database and name it <span class="strong"><strong><code class="literal">moviesZone</code></strong></span>. This is where you'll store the data from the <span class="strong"><strong>MustC</strong></span> app later.</p><p>The second tab, <strong class="userinput"><code><span class="strong"><strong>Records</strong></span></code></strong>, is more interesting. On this tab, you can perform queries on the data that is stored in your databases and zones. This allows you to explore your data and make sure that everything is saved as you would expect. For privacy reasons, you can only see the data for your own private and shared database and the public database. You can never access a user's private database.</p><p>The records tab provides a window into your CloudKit database. Note that the records page also has a <strong class="userinput"><code>Changes</code></strong> tab. You can use this tab to retrieve changes to all records in the selected zone. Note that you can't do this for the default zone, so if you want to use this functionality in your app, you will need to create a custom zone on the <strong class="userinput"><code>Zones</code></strong> tab.</p><p>The third tab is the <strong class="userinput"><code>Record Types</code></strong> tab. This is where you define the objects you want to store in your CloudKit database and what properties they have. Note that record types are not connected to a zone. This means that you can write a certain record to any zone you'd like. Keep in mind though that records from different <span>zones</span><a id="id325580873" class="indexterm"></a> cannot reference each other. So if you consider the <span class="strong"><strong>MustC</strong></span> app, a family member and their favorite movies would have to exist in the same zone. If this isn't the case, the objects are not allowed to reference each other in CloudKit.</p><p>To prepare for storing data later, you should create your record types now. Click the <span class="strong"><strong><strong class="userinput"><code>Create New Type</code></strong></strong></span> button and name it <code class="literal">FamilyMember</code>. Add a field to it by clicking the <span class="strong"><strong><strong class="userinput"><code>Add field</code></strong></strong></span> button and call the field <strong class="userinput"><code>name</code></strong>. The type should be <strong class="userinput"><code>String</code></strong>. Add another field and call it <strong class="userinput"><code>movies</code></strong>, give it a type of <span class="strong"><strong><strong class="userinput"><code>Reference (list)</code></strong></strong></span>. The following screenshot shows what your fields should look like:</p><div class="mediaobject"><img src="/graphics/9781789133202/graphics/acd7d11e-03d9-4c66-8426-d0ee54126cf6.png" /></div><p> </p><p>Click the <strong class="userinput"><code>Create Record Type</code></strong> button to store your record type and create a second record type for the movie records. Use <span class="strong"><strong>Movie</strong></span> as the name for your record type and give it three properties, named <span class="strong"><strong>title</strong></span>, which should be a String, <span class="strong"><strong>rating</strong></span> (Double), and a <span class="strong"><strong>remoteId</strong></span> (Int64). Make sure to save this record type as well.</p><p>After you save a record type, CloudKit automatically adds some extra metadata properties to it. These properties are used internally by CloudKit to figure out what objects changed and when. You can't remove or modify these properties because CloudKit needs them.</p><p>The fourth tab in the dashboard is the <strong class="userinput"><code><span class="strong"><strong>Indexes</strong></span></code></strong> tab. This tab is used to specify which properties of a record will be optimized for querying. If you don't specify any indexes, you won't be able to easily fetch all records from your CloudKit database. Typically you will want to at least add an index for the <strong class="userinput"><code>recordName</code></strong> property. To do this, select your record type and click the <strong class="userinput"><code>Add Index</code></strong> button. Select the <strong class="userinput"><code>recordName</code></strong> property in the first dropdown and <strong class="userinput"><code>QUERYABLE</code></strong> from the second. Do this for both record types you created earlier.</p><p>The fifth tab is <strong class="userinput"><code>Subscriptions</code></strong>. This is where <span>you</span><a id="id325581014" class="indexterm"></a> can see the subscriptions that exist for a particular database. You can only look at the subscriptions for your own private and shared database, and the public database. You can use this tab to check whether you are correctly subscribing apps to database updates.</p><p>The next tab is <strong class="userinput"><code>Subscription types</code></strong>. There isn't much to do here other than explore the automatically-generated subscription types and check whether they match what you expect to find there.</p><p>The last tab is the <strong class="userinput"><code>Security Roles</code></strong> tab. This tab allows you to manage what permissions users have for record types in the public database. This allows you to limit the actions that a certain user can perform. For instance, you might want to allow all users to read news articles from the public database but restrict writing new articles to the database to your administrative users. You can manage all this in the security roles tab. The default values will suffice for the <span class="strong"><strong>MustC</strong></span> app.</p><p>Let's go back to your container overview page to discuss the other available sections briefly.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch11lvl3sec30"></a>Exploring the rest of your container</h4></div></div></div><p>From your container overview page, you can gain insights into several interesting and helpful metrics. You can use the <strong class="userinput"><code>Logs</code></strong> page to see real-time logs about what's going in your application. You can use these logs to make sure specific data is sent and received as you would expect, or to troubleshoot problems your users are having. Note that <span>you</span><a id="id325581048" class="indexterm"></a> can't see the private data that your users are storing, but you can look at the operations they are trying to perform on the CloudKit database.</p><p>The <strong class="userinput"><code>Telemetry</code></strong> page gives you insight into what's going on inside of your application. You can see performance-related statistics and learn how your CloudKit database is used. You can use this page together with <strong class="userinput"><code>Public Database Usage</code></strong> to understand where your implementation could be improved and how users use your app.</p><p>The last section is <strong class="userinput"><code>API Access</code></strong>. This section is relevant when you want to use the CloudKit store outside of iOS, for instance from a web page or web server.</p><p>This information should cover the most interesting bits of the CloudKit dashboard. Let's see how you can make your app communicate with CloudKit.</p></div></div></div>