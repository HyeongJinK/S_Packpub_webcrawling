<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch13lvl1sec95"></a>Setting up geofences</h2></div></div><hr /></div><p>Sometimes, your app doesn't really need to <span>know</span><a id="id325333116" class="indexterm"></a> the details of the user's whereabouts. Sometimes, you're only interested in tracking whether the user has exited or left a certain area, in order to show certain content in your app or to unlock some kind of special feature. Core Location has great support for monitoring geofences. A geofence is a certain area that is defined using a certain GPS coordinate and a circular radius around this point. In Core Location, geofences are set up using <code class="literal">CLRegion</code> subclasses. Core Location provides two different region types that you can use:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">CLCircularRegion</code></li><li style="list-style-type: disc"><code class="literal">CLBeaconRegion</code></li></ul></div><p>A <code class="literal">CLCircularRegion</code> type is used to set up a geofence, as described before. A <code class="literal">CLBeaconRegion</code> type is used with physical BLE iBeacons, and essentially provides geofencing in a very small radius, for instance, just a couple of meters. In this section you will learn how to set up a <code class="literal">CLCircularRegion</code> type that is set up around a user's first detected location. Setting up geofencing, or region monitoring, with both types of regions is very similar so all principles for monitoring a circular region also applies to beacon regions.</p><p>If you look at the <code class="literal">GeofenceViewController</code>, you'll notice that it has a button labelled <strong class="userinput"><code>Set Geofence</code></strong>. The <code class="literal">@IBAction</code> for this button does quite a lot of the work already, but one key element is missing—it doesn't inform the location manager about the region that should be monitored. Add the following code to the end of <code class="literal">setGeofence()</code> in <code class="literal">GeofenceViewController</code>:</p><pre class="programlisting">let region = CLCircularRegion(center: location.coordinate, radius: 30, identifier: "current-location-geofence")
locationHelper.setGeofence(at: region, exitHandler, enterHandler)</pre><p>The preceding code uses the location <span>that</span><a id="id325602535" class="indexterm"></a> was obtained from the user before, and uses it to create a circular region with a radius of 30 meters. The identifier that is passed to the region should be an identifier that uniquely defines the region. If you reuse an identifier, Core Location will stop monitoring the old region with that identifier, and will monitor the new region instead. For the LocationServices app, this is perfect, but if you want your app to observe multiple regions, you must make sure every region has its own unique identifier.</p><p> </p><p>Next, add the following implementation for <code class="literal">setGeofence(at:_:_:)</code> to the <code class="literal">LocationHelper</code>:</p><pre class="programlisting">func setGeofence(at region: CLRegion, _ exitHandler: @escaping () -&gt; Void, _ enterHandler: @escaping () -&gt; Void) {
  guard CLLocationManager.isMonitoringAvailable(for: CLCircularRegion.self)
    else { return }

  geofenceExitCallback = exitHandler
  geofenceEnterCallback = enterHandler
  locationManager.startMonitoring(for: region)
}</pre><p>The preceding method is again very similar to the other location helper methods. Let's move right on to implementing the <code class="literal">CLocationManagerDelegate</code> methods <span>that</span><a id="id325604103" class="indexterm"></a> the location manager will call:</p><pre class="programlisting">func locationManager(_ manager: CLLocationManager, didEnterRegion region: CLRegion) {
  geofenceEnterCallback?()
}

func locationManager(_ manager: CLLocationManager, didExitRegion region: CLRegion) {
  geofenceExitCallback?()
}</pre><p>The preceding two methods are part of the <code class="literal">CLocationManagerDelegate</code> protocol, and are called when a user enters or exits a certain area. Since there's no extra work to be done by the helper, the corresponding callbacks are immediately called so the <code class="literal">GeofenceViewController</code> can update its interface accordingly.</p><p>Try opening the app and tapping the <strong class="userinput"><code>Set Geofence</code></strong> button. An orange circle should now appear on the map to visualize the geofence you have set up. If you exit or enter the region, the status label should update accordingly, to show whether you have just entered or left the geofence. Note that it might take up to five minutes for iOS to properly register, monitor, and report updates about your geofence. Note that your user should have an active internet connection for region monitoring to work optimally.</p><p> </p><p> </p></div>