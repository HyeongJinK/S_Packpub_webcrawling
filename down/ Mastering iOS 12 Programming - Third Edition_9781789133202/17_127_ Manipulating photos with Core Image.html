<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch17lvl1sec119"></a>Manipulating photos with Core Image</h2></div></div><hr /></div><p>In this chapter, you have already seen that iOS has powerful capabilities for recording and playing media. In this section, you will learn how you can manipulate images with <code class="literal">Core Image</code>. The <code class="literal">Core Image</code> framework provides many different filters that you can use to process both images and video. You will expand on the photo-taking <span>capabilities</span><a id="id325333779" class="indexterm"></a> that you <span>implemented</span><a id="id325333787" class="indexterm"></a> in the <strong class="userinput"><code>Captured</code></strong> app so users can grayscale and crop images.</p><p>Every <code class="literal">Core Image</code> filter you apply to images is an instance of the <code class="literal">CIFilter</code> class. You can create instances of filters as follows:</p><pre class="programlisting">let filter = CIFilter(name: "CIPhotoEffectNoir")</pre><p>The name parameter in the filter's initializer is expected to be a string that refers to a specific filter. You can refer to Apple's documentation on Core Image and the Core Image Filter Reference guide to see an overview of all the filters that you can use in your apps.</p><p>Every filter has a certain set of parameters that you need to set on the <code class="literal">CIFilter</code> instance to use the filter. For instance, a grayscale filter requires you to provide an input image. Other filters might take an intensity, location, or other properties. The best way to see how you can apply a filter to an image is through an example. Add the following implementation for <code class="literal">applyGrayScale()</code> to <code class="literal">ImageViewController.swift</code> to implement a grayscale filter:</p><pre class="programlisting">@IBAction func applyGrayScale() {
  // 1
  guard let cgImage = selectedImage?.cgImage,
    // 2
    let initialOrientation = selectedImage?.imageOrientation,
    // 3
    let filter = CIFilter(name: "CIPhotoEffectNoir")
    else { return }

  // 4
  let sourceImage = CIImage(cgImage: cgImage)
  filter.setValue(sourceImage, forKey: kCIInputImageKey)

  // 5
  let context = CIContext(options: nil)
  guard let outputImage = filter.outputImage,
    let cgImageOut = context.createCGImage(outputImage, from: outputImage.extent)
    else { return }

  // 6
  selectedImage = UIImage(cgImage: cgImageOut, scale: 1, orientation: initialOrientation)
}</pre><p>The preceding code has a lot of small, interesting details, <span>highlighted</span><a id="id325333832" class="indexterm"></a> with <span>numbered</span><a id="id325333841" class="indexterm"></a> comments. Let's go over the comments one by one to see how the grayscale filter is applied:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>The <code class="literal">UIImage</code> instance that is stored in <code class="literal">selectedImage</code> is converted to a <code class="literal">CGImage</code> instance. Strictly speaking, this conversion isn't required, but it does make applying other filters to the <code class="literal">UIImage</code>instance later a bit easier.</li><li>One downside of using <code class="literal">CGImage</code>, instead of <code class="literal">UIImage</code>, is that the orientation information that is stored in the image is lost. To make sure the final image maintains its orientation, the initial orientation is stored.</li><li>This step creates an instance of the grayscale filter.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Since Core Image does not directly support <code class="literal">CGImage</code> instances, the <code class="literal">CGImage</code>instance is converted to a <code class="literal">CIImage</code>instance that can be used with Core Image. The <code class="literal">CIImage</code> instance is then assigned as the input image for the grayscale filter, by calling <code class="literal">setValue(_:forKey:)</code> on the filter.</li><li>The fifth step extracts the new image from the filter, and uses a <code class="literal">CIContext</code> object to export the <code class="literal">CIImage</code> output to a <code class="literal">CGImage</code> instance.</li><li>The sixth and final step is to create a new <code class="literal">UIImage</code> instance, based on the <code class="literal">CGImage</code> output. The initial orientation is passed to the new <code class="literal">UIImage</code> instance to make sure it has the same orientation as the original image.</li></ol></div><p>Even though there are a lot of steps involved, and <span>you</span><a id="id325606072" class="indexterm"></a> need to convert between <span>different</span><a id="id325606081" class="indexterm"></a> image types quite a bit, applying the filter is relatively simple. Most of the preceding code takes care of switching between image types, while the filter itself is set up in just a couple of lines. Try running the app now and taking a picture. The initial picture will be in full color. After you apply the grayscale filter, the image is automatically replaced with a grayscale version of the image, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781789133202/graphics/77916c08-beb8-41f2-a682-b465eb8e34b8.png" /></div><p></p><p>The next filter you will implement is a crop filter. The crop filter will crop the image so that it's a square, rather than a portrait or landscape picture. The process for implementing the crop filter is mostly the same as the grayscale filter, except for the values that need to be passed to the crop filter. Add the <span>following</span><a id="id325607093" class="indexterm"></a> implementation for <code class="literal">cropSquare()</code> to <span>implement</span><a id="id325607105" class="indexterm"></a> the crop filter:</p><pre class="programlisting">@IBAction func cropSquare() {
  let context = CIContext(options: nil)

  guard let cgImage = selectedImage?.cgImage,
    let initialOrientation = selectedImage?.imageOrientation,
    let filter = CIFilter(name: "CICrop")
    else { return }

  let size = CGFloat(min(cgImage.width, cgImage.height))
  let center = CGPoint(x: cgImage.width / 2, y: cgImage.height / 2)
  let origin = CGPoint(x: center.x - size / 2, y: center.y - size / 2)
  let cropRect = CGRect(origin: origin, size: CGSize(width: size, height: size))

  let sourceImage = CIImage(cgImage: cgImage)
  filter.setValue(sourceImage, forKey: kCIInputImageKey)
  filter.setValue(CIVector(cgRect: cropRect), forKey: "inputRectangle")

  guard let outputImage = filter.outputImage,
    let cgImageOut = context.createCGImage(outputImage, from: outputImage.extent)
    else { return }

  selectedImage = UIImage(cgImage: cgImageOut, scale: 1, orientation: initialOrientation)
}</pre><p>The preceding code performs several calculations to figure out the best way to crop the image into a square. The <code class="literal">CGRect</code> instance that specifies the crop coordinates and size, which are then used to create a <code class="literal">CIVector</code> object. This object is then passed to the filter as the value for the <code class="literal">inputRectangle</code> key. Apart from specifying the crop values, the process of applying the filter is identical, so the code should look familiar to you.</p><p>If you run the app now and tap the crop button, the image will be cropped, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781789133202/graphics/ee6dcaa5-dc56-40aa-bf8c-18ca7fe24bdc.png" /></div><p>There are many more filters available in <span>Core</span><a id="id325607244" class="indexterm"></a> Image, which you can play with to build pretty advanced filters. You can even apply multiple filters to a single image to create elaborate effects for the pictures in your apps. Because all filters work in very similar ways, it's relatively easy to apply any filter to your images once you understand how the general process of applying a filter works. You can always use the code from the preceding examples if you need a reminder about how to apply <span>Core</span><a id="id325609916" class="indexterm"></a> Image filters.</p><p> </p></div>