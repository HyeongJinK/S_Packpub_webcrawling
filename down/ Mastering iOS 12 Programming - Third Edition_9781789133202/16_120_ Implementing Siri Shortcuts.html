<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch16lvl1sec113"></a>Implementing Siri Shortcuts</h2></div></div><hr /></div><p>If you have used iOS for a while, you may have noticed that in places such as the notification center, Siri suggests certain apps you might want to use at a certain time. Siri can do this because it continuously learns about the apps you use, when you use them, and where you are <span>when</span><a id="id325333116" class="indexterm"></a> you use them. By learning your behavior, Siri can make accurate predictions about what you might want to do next.</p><p>With the introduction of iOS 12, Apple has announced a new, powerful feature for Siri. This feature is called <span class="strong"><strong>Siri Shortcuts</strong></span>, and it allows app developers to teach Siri about certain actions that a user performs in their apps. Siri then learns about these actions and offers them to the user at the appropriate time.</p><p>If you book a taxi home every day at a certain time, and the app you use has implemented Siri Shortcuts, Siri can offer you a shortcut to quickly book your taxi without having to go into the app. This is a great feature for users because it allows them to focus on the things that matter to them, without having to perform repetitive tasks inside of an app.</p><p>In this section, you will implement Siri Shortcuts for the Hairdressers app to enable users to quickly book appointments. There are two ways for apps to support shortcuts:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Through <code class="literal">NSUserActivity</code> objects</li><li style="list-style-type: disc">By donating <code class="literal">INInteraction</code> objects</li></ul></div><p>First, you will implement the <code class="literal">NSUserActivity</code> method for adding shortcuts. Then you will define your own custom intent, so you can donate activities through <code class="literal">INInteraction</code> objects, and handle shortcuts in the background by implementing a second <strong class="userinput"><code>Intents Extension</code></strong>.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch16lvl2sec89"></a>Implementing shortcuts through NSUserActivity</h3></div></div></div><p>The simplest way to implement Siri <span>Shortcuts</span><a id="id325333833" class="indexterm"></a> is to use <code class="literal">NSUserActivity</code> objects. An <code class="literal">NSUserActivity</code> object contains information about the current activity that a user is performing, and can be used to achieve several goals, one of which is to implement Siri Shortcuts. To find out about other <span>uses</span><a id="id325356869" class="indexterm"></a> of <code class="literal">NSUserActivity</code>, have a look at <a class="link" href="#" linkend="ch21">Chapter 21</a>, <span class="emphasis"><em>Improved Discoverability with Spotlight and Universal Links</em></span>.</p><p>Your app must register the identifiers, in the <code class="literal">Info.plist</code> file, for the user activity objects that it will handle. Add a new entry to the <code class="literal">Info.plist</code> for <strong class="userinput"><code>Hairdressers</code></strong>, and name it <strong class="userinput"><code>NSUserActivityTypes</code></strong>. The object type for this key should be an array. In this array, you should add the identifier for the user activity object you are going to use for Siri shortcuts. Usually, this will be a reverse domain name kind of identifier, such as, for example, <code class="literal">com.donnywals.hairdressers.appointment</code>.</p><p>After adding the identifier to your <code class="literal">Info.plist</code>, you are ready to implement user activities in your app. To nicely encapsulate all logic related to the appointment booking activity, add an extension called <code class="literal">NSUserActivity</code> to the extensions folder, and implement the following extension in it:</p><pre class="programlisting">extension NSUserActivity {
  static var identifierForAppointment: String {
    return "com.donnywals.hairdressers.appointment"
  }

  static func appointmentActivity() -&gt; NSUserActivity {
    return NSUserActivity(activityType: identifierForAppointment)
  }
}</pre><p>The preceding extension contains the identifier you entered earlier, and a convenience method to create a new user activity that uses the type identifier for an appointment booking activity.</p><p>Next, create a folder called <code class="literal">Helpers</code>, and add a file called <code class="literal">AppointmentShortcutHelper</code>. You will implement all the logic surrounding shortcuts in this file.</p><p>When a user books a new appointment, you should create a new user activity and pass it to Siri Shortcuts. Passing shortcuts to Siri Shortcuts is also called donating a shortcut. Every user activity you donate to Siri needs to have a <code class="literal">title</code> property, a <code class="literal">userInfo</code>, a <code class="literal">persistentIdentifier</code>, and it needs to be marked as <code class="literal">isEligibleForPrediction</code>.</p><p>The following helper method creates a user activity object and should be added to the <code class="literal">AppointmentShortcutHelper</code>:</p><pre class="programlisting">static func activityForAppointment(_ appointment: Appointment) -&gt; NSUserActivity {
  let userActivity = NSUserActivity.appointmentActivity()
  let title = "Book an appointment with \(appointment.hairdresser!) for \(appointment.day!)"

  userActivity.requiredUserInfoKeys = ["hairdresser", "day"]
  userActivity.userInfo = ["hairdresser": appointment.hairdresser!, "day": appointment.day!]
  userActivity.title = title
  userActivity.isEligibleForPrediction = true
  userActivity.persistentIdentifier = "\(appointment.hairdresser!)-\(appointment.day!)"
  userActivity.suggestedInvocationPhrase = title

  return userActivity
}</pre><p>The preceding block of code creates a user activity. Note that the sample code uses some force unwrapping with a <code class="literal">!</code> symbol used to keep the code brief and simple. Make sure to asses whether this is appropriate in your own app, and preferably use safe unwrapping instead. To use and donate the user activity that the preceding snippet creates, add the following code to <code class="literal">AddAppointmentViewController</code> in the <code class="literal">didTapSave()</code> method, right before <code class="literal">dismiss(animated:completion:)</code> is called:</p><pre class="programlisting">let activity = AppointmentShortcutHelper.activityForAppointment(appointment)
self.userActivity = activity</pre><p>To make an <span>activity</span><a id="id325578345" class="indexterm"></a> the current activity, you need to assign it as the current user activity for the current view controller. If you run the app now, creating a new <span>appointment</span><a id="id325578354" class="indexterm"></a> will donate that appointment to Siri. Normally, Siri will begin showing donations once the user has performed a certain action many times, so Siri is quite sure that it makes sense for your user to see the action offered to them. For debugging purposes, you can go to <strong class="userinput"><code>Settings</code></strong> | <strong class="userinput"><code>Developer</code></strong>, scroll down a bit, and then enable <strong class="userinput"><code>Display Recent Shortcuts</code></strong> and <strong class="userinput"><code>Display Donations on Lock Screen</code></strong>, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781789133202/graphics/5fe53373-6d8f-4e1d-8a12-72149ebeb6fd.png" /></div><p></p><p>Doing this will <span>immediately</span><a id="id325333876" class="indexterm"></a> show your new donated shortcuts in the <span>notification</span><a id="id325333884" class="indexterm"></a> center and on the lock screen, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781789133202/graphics/a0e09e27-27ac-46d6-9199-13b2045f39ea.png" /></div><p>If you only donate your shortcuts to Siri, you're not quite done yet. When a user taps on your shortcut, your application should receive the user activity object and then perform the action the user wants to perform—in this case, booking a repeat appointment with a certain hairdresser.</p><p>Add the following helper <span>method</span><a id="id325333907" class="indexterm"></a> to the <code class="literal">AppointmentShortcutHelper</code> to convert a user activity to an <span>appointment</span><a id="id325333920" class="indexterm"></a> and store it in Core Data:</p><pre class="programlisting">static func storeAppointmentForActivity(_ userActivity: NSUserActivity) {
  guard let userInfo = userActivity.userInfo,
    let hairdresser = userInfo["hairdresser"] as? String,
    let day = userInfo["day"] as? String
    else { return }

  let moc = PersistentHelper.shared.persistentContainer.viewContext

  moc.persist {
    let appointment = Appointment(context: moc)
    appointment.day = day
    appointment.hairdresser = hairdresser
  }
}</pre><p>When your app is asked to handle a user activity, the <code class="literal">application(_:continue:restorationHandler:)</code> method is called on your <code class="literal">AppDelegate</code>. Add the following implementation for this method to check whether the received user activity is related to booking an appointment, and pass it on to the helper method to store a new appointment:</p><pre class="programlisting">func application(_ application: UIApplication, continue userActivity: NSUserActivity, restorationHandler: @escaping ([UIUserActivityRestoring]?) -&gt; Void) -&gt; Bool {

  guard userActivity.userActivityType == NSUserActivity.identifierForAppointment
    else { return false }

  AppointmentShortcutHelper.storeAppointmentForActivity(userActivity)

  return true
}</pre><p>After you implement this code, go ahead and book an <span>appointment</span><a id="id325333947" class="indexterm"></a> in the Hairdressers app. You should see your appointment appear in the list of suggested shortcuts, and when you tap on your shortcut, a new appointment should immediately be created.</p><p>Users can also add their own voice command for the <span>shortcuts</span><a id="id325333958" class="indexterm"></a> you donate. Users can do this by navigating to the following page in the settings app: <strong class="userinput"><code>Hairdressers</code></strong> | <strong class="userinput"><code>Siri &amp; Search</code></strong> | <strong class="userinput"><code>My "Hairdressers" Shortcuts</code></strong>. A user can then tap on a shortcut to record their own phrase, which can then be used to execute the shortcut they chose, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781789133202/graphics/45c844e9-9151-47fb-a4f0-0b4df8494b2e.png" /></div><p>When you donate shortcuts using a user activity, your app will be launched to handle the shortcut. If you want to handle shortcuts in the background, you can create a custom intent and <strong class="userinput"><code>Intents extension</code></strong> to achieve this. Let's see how.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch16lvl2sec90"></a>Donating shortcuts with INinteractions</h3></div></div></div><p>Donating shortcuts with user <span>activities</span><a id="id325333998" class="indexterm"></a> is pretty <span>straightforward</span><a id="id325334007" class="indexterm"></a> and powerful. The only downside is that your app has to be launched to handle shortcuts when the user executes them. Sometimes this might be the behavior you need, but for the case of booking an ap</p><p> </p><p>To achieve this, you need to implement a custom intent, and an extension that can handle it. Let's set up the custom intent and prepare the app for donating and potentially handling the intent. After doing this, you will see how to implement an <strong class="userinput"><code>Intents extension</code></strong> that handles your custom intent.</p><p>The first step to implement your own custom intent is to create an intent definition file. Add a new file to your project and choose the <strong class="userinput"><code>SiriKit Intent Definition File</code></strong> type from the list of available files, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781789133202/graphics/9d3a59c5-b347-4626-8662-0baddd274e9a.png" /></div><p>When you select this file in Xcode, the intent editor is opened. In this editor, you can create your custom intents and configure them. Click the <strong class="userinput"><code>+</code></strong> icon in the bottom left corner of the editor to create a new intent. Name your new intent <code class="literal">BookAppointment</code>.</p><p>After creating your intent, you <span>need</span><a id="id325333163" class="indexterm"></a> to choose a <span>category</span><a id="id325333172" class="indexterm"></a> for your intent. There are many available categories to choose from. You should always pick the category that fits your needs as closely as possible. In this case, the <strong class="userinput"><code>Book</code></strong> category is a perfect choice. The next step is to give your intent a title and a description, as shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781789133202/graphics/c0eb1c63-12e2-47e3-8ce0-6f33f59d6fd1.png" /></div><p>The parameters for your intent are configured in the <strong class="userinput"><code>Parameters</code></strong> section. The appointment booking intent should have two parameters:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">hairdresser</code> (String)</li><li style="list-style-type: disc"><code class="literal">day</code> (String)</li></ul></div><p>These parameters should appear in Xcode as follows:</p><div class="mediaobject"><img src="/graphics/9781789133202/graphics/665b5fe3-bf51-433f-a93b-d0e16ab57b78.png" /></div><p>Xcode will generate several subclasses for your custom intent after you have configured it. The parameters you specify in the <strong class="userinput"><code>Parameters</code></strong> section will be available as properties on your custom intent.</p><p> </p><p>Now that you have the parameters prepared, you <span>need</span><a id="id325333269" class="indexterm"></a> to configure the <span>shortcut</span><a id="id325333277" class="indexterm"></a> that you want to donate. Every shortcut you base on the intent you just created will have a unique combination of parameters. These parameters can be used to generate a dynamic title for your shortcut.</p><p>Add a parameter combination for the <code class="literal">hairdresser</code> and <code class="literal">day</code> parameters, and create a title that uses these parameters. You can start typing the message, and Xcode will automatically suggest the parameters for you. The final shortcut should look like the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781789133202/graphics/25e8bb54-b49d-470c-970a-f1b7ff37c06a.png" /></div><p>After configuring the intent and shortcut, you can set up <span>response</span><a id="id325333306" class="indexterm"></a> parameters. You can use these parameters to create a helpful response that confirms information for the user. In this case, you can add a <code class="literal">hairdresser</code> property and use that to verify a user's appointment, as <span>shown</span><a id="id325333318" class="indexterm"></a> in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781789133202/graphics/c2e95f7b-ed2d-41e0-8607-343fc5e2af88.png" /></div><p>Now that the <span>custom</span><a id="id325333339" class="indexterm"></a> intent is set up, you can update the <code class="literal">AppointmentShortcutHelper</code> to donate an <code class="literal">INInteraction</code>, which contains the custom intent, to Siri. Add the following <span>implementation</span><a id="id325333354" class="indexterm"></a> for this helper to <code class="literal">AppointmentShortcutHelper</code>:</p><pre class="programlisting">static func donateInteractionForAppointment(_ appointment: Appointment) {
  let intent = BookAppointmentIntent()
  intent.hairdresser = appointment.hairdresser
  intent.day = appointment.day
  let title = "Book an appointment with \(appointment.hairdresser!) for \(appointment.day!)"
  intent.suggestedInvocationPhrase = title

  let interaction = INInteraction(intent: intent, response: nil)
  interaction.donate(completion: nil)
}</pre><p>Xcode has generated a <code class="literal">BookAppointmentIntent</code> class based on your custom intent definition. As mentioned before, this intent has the properties that you have defined in the editor, so that you can properly configure your intent.</p><p>After configuring the intent, it is wrapped in an <code class="literal">INInteraction</code> object. To donate the shortcut to Siri, you must call <code class="literal">donate(completion:)</code> on the interaction object. Next, replace the user activity-based donation code in <code class="literal">AddAppointmentViewController</code> with the following line:</p><pre class="programlisting">AppointmentShortcutHelper.donateInteractionForAppointment(appointment)<span>`</span></pre><p>If your application does happen to be launched by Siri to handle the intent, you should do so in the <code class="literal">application(_:continue:restorationHandler:)</code> method in <code class="literal">AppDelegate</code>. The user activity type for your custom intent will be the name of the intent you created. So, if you created an intent called <code class="literal">BookAppointment</code>, that will be the user activity type that Siri will use. Update the implementation of <code class="literal">application(_:continue:restorationHandler:)</code> as follows:</p><pre class="programlisting">func application(_ application: UIApplication, continue userActivity: NSUserActivity, restorationHandler: @escaping ([UIUserActivityRestoring]?) -&gt; Void) -&gt; Bool {

  var allowedActivities = [NSUserActivity.identifierForAppointment, "BookAppointment"]

  guard allowedActivities.contains(userActivity.activityType)
    else { return false }

  AppointmentShortcutHelper.storeAppointmentForActivity(userActivity)
  return true
}</pre><p>This wraps up the <span>configuration</span><a id="id325333418" class="indexterm"></a> of your app. The next step is to create an <strong class="userinput"><code>Intents Extension</code></strong> that can handle the new custom intent. Since you have already done this before, the processes won't be explained step by step. Instead, make sure you do all of the following:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Create an <code class="literal">Intents Extension</code>.</li><li>Enable <strong class="userinput"><code>App Groups</code></strong> for the extension.</li><li>Add the intent definition, managed object context extension, data helpers, and Core Data model to the new extension's target.</li><li>Configure the extension to support the <code class="literal">BookAppointment</code> intent.</li><li>Remove the boilerplate code from the <code class="literal">IntentHandler</code> class.</li></ol></div><p>Since the <code class="literal">IntentHandler</code> for the custom intent is only meant to handle a single intent, add the following <span>implementation</span><a id="id325333465" class="indexterm"></a> for the <code class="literal">IntentHandler</code> class:</p><pre class="programlisting">class IntentHandler: INExtension, BookAppointmentIntentHandling {

  override func handler(for intent: INIntent) -&gt; Any {
    return self
  }

  func handle(intent: BookAppointmentIntent, completion: @escaping (BookAppointmentIntentResponse) -&gt; Void) {
    guard let hairdresser = intent.hairdresser, let day = intent.day else {
      completion(BookAppointmentIntentResponse(code: .failure, userActivity: nil))
      return
    }

    let moc = PersistentHelper.shared.persistentContainer.viewContext

    moc.persist {
      let appointment = Appointment(context: moc)
      appointment.day = day
      appointment.hairdresser = hairdresser

      let response = BookAppointmentIntentResponse(code: .success, userActivity: nil)
      response.hairdresser = hairdresser
      completion(response)
    }
  }
}</pre><p>If you book a new appointment in the Hairdressers app and invoke the Siri Shortcut later, the <strong class="userinput"><code>Intents extension</code></strong> will be used to handle your intent rather than having to open the app. This is great, because it allows the user to go on with what they were doing, without having to look at your app for confirmation.</p><p>Now that your <span>extension</span><a id="id325580717" class="indexterm"></a> is in place, go ahead and play with your Siri Shortcuts a bit. The work for this chapter is completed—you have created an application that is tightly integrated with Siri in order to streamline the user's experience with your app.</p></div></div>