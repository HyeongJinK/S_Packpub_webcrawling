<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch22lvl1sec150"></a>Understanding sessions, messages, and conversations</h2></div></div><hr /></div><p>This chapter has mostly focused on user interface-related aspects of iMessage apps. When you create an iMessage app, your app will sooner or later have to send a message. To do this, you use the <code class="literal">MSMessage</code> and <code class="literal">MSSession</code> objects. In addition to messages and sessions, the <code class="literal">MSConversation</code> class represents the conversation context that your extension exists in. These three classes together allow you to send messages, identify <span>recipients</span><a id="id325333126" class="indexterm"></a> in conversations, and even update or <span>collapse</span><a id="id325333132" class="indexterm"></a> existing messages in the messages transcript.</p><p>When an iMessage extension is activated, <code class="literal">willBecomeActive(with:)</code> is called in <code class="literal">MessagesViewController</code>. This method receives an instance of <code class="literal">MSConversation</code> that you can use to send messages, stickers, and even attachments. More importantly, the conversation contains unique identifiers for participants in the <span>conversation</span><a id="id325333153" class="indexterm"></a> and the currently selected message.</p><p>The <code class="literal">localParticipantIdentifier</code> and <code class="literal">remoteParticipantIdentifier</code> properties identify the current user of your app or the person who is sending messages with your app, and the recipients of these messages, respectively. Note that these identifiers are unique to your app so you can't use this identifier to identify users across different iMessage apps. Also, these identifiers can change if the user uninstalls and then reinstalls your app. The participant identifiers are mostly meant to identify users in a group conversation.</p><p>The <code class="literal">selectedMessage</code> property is only set if your extension was launched due to a user tapping on a message that was sent by your extension. This is especially useful if you're building an app that sends multiple messages that build upon each other. In Apple's 2016 WWDC talk, <span class="emphasis"><em>iMessage Apps and Stickers, Part 2</em></span>, they demonstrated an ice-cream designer app. Each user designs a part of the ice cream and <code class="literal">selectedMessage</code> is used in combination with <code class="literal">MSSession</code> to collapse old messages so the message history does not get polluted with old pictures of ice creams. You will learn how to use this session <span>in a bit</span>. First, let's have a look at <code class="literal">MSMessage</code> to see how you can create messages.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch22lvl2sec120"></a>Composing a message</h3></div></div></div><p>The <code class="literal">MSMessage</code> class encapsulates all the <span>information</span><a id="id325580821" class="indexterm"></a> that is contained inside a message. When you initialize a message, you can initialize it with or without a session. If you instantiate a message with a session, other messages that are attached to this session will be collapsed to only show the message's <code class="literal">summaryText</code>. The summary is supposed to be a short, clear description of the message so that, even when the message is collapsed, the message still makes sense.</p><p>If possible, you should always aim to attach a <code class="literal">URL</code> and <code class="literal">accessibilityLabel</code> to your messages, depending on the types of message your app will send. If you're sending plain text messages like <span class="strong"><strong>The Daily Quote</strong></span> will, you don't need an accessibility label since iOS can simply read the text message out loud for users with accessibility needs. The <code class="literal">URL</code> property is mainly used by platforms that don't support iMessage extensions, such as macOS. Attaching a <code class="literal">URL</code> makes sure that users can still navigate to your content online. When you're sending plain text, this isn't an issue.</p><p>Finally, if you're sending a message that has media attached to it, you should make use of the <code class="literal">MSMessageTemplateLayout</code> class. <code class="literal">MSMessage</code> has a layout property that can be set to an instance of <code class="literal">MSMessageTemplateLayout</code>. The message layout template is highly configurable. You can assign an image or media to it, set a caption, an image title, a sub-caption, and more. Messages will make sure that your layout looks good and is laid out nicely depending on the information you set.</p><p>If you set both a media URL and an <span>image</span><a id="id325606035" class="indexterm"></a> on your message layout, the image will be used and the other media items are ignored. Any images you add should be 300x300 @3x. Avoid rendering text on the image as the scaling on different devices might degrade the quality of your image and render the text illegible. Instead, use the image title and image subtitle properties from the message layout object.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note54"></a>Note</h3><p>An <code class="literal">MSMessage</code> instance is always intended to either have some form of media associated with it or to be interactive.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch22lvl2sec121"></a>Sending a message</h3></div></div></div><p>Once you have <span>composed</span><a id="id325606058" class="indexterm"></a> a message, you need to attach it to a conversation. To do so, you can use the <code class="literal">activeConversation</code> property, which is already present on your <code class="literal">MSMessagesAppViewController</code>. There are several methods on <code class="literal">MSConversation</code> that will insert a message. You can insert an instance of <code class="literal">MSMessage</code> if you have composed one. Alternatively, you can insert a sticker or you can simply insert some text.</p><p>To share a quote with <span class="strong"><strong>The Daily Quote</strong></span> messages extension, this means that the text from the selected quote should be inserted into the conversation. Add the following implementation for <code class="literal">shareQuote(_:)</code> to implement the share feature:</p><pre class="programlisting">func shareQuote(_ quote: Quote) {
  guard let conversation = activeConversation
    else { return }

  conversation.insertText("(quote.text) - (quote.creator)", completionHandler: nil)
}</pre><p>If you run this code and try sharing a quote, two noteworthy things occur:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">The extensions presentation mode does not change to compact after sharing a quote so the user doesn't see that the quote is shared.</li><li style="list-style-type: disc">When you change the app to compact mode manually, the quote isn't actually sent yet. Instead, a message is prepared for the user to send manually. Users are always in control of when a certain message is sent. Extensions are only allowed to prepare messages for users so they can decide for themselves whether the message should be sent.</li></ul></div><p>To fix the problem with the extension not switching to compact mode after selecting a quote, you need to add a single line of code to <code class="literal">shareQuote(_:)</code>. After inserting the quote, add the following line:</p><pre class="programlisting">dismiss()</pre><p>This will dismiss the extension entirely, allowing the user to focus on the quote and send it to the recipient. Alternatively, you could call <code class="literal">requestPresentationStyle(_:)</code> with a <code class="literal">compact</code> presentation style to change the current presentation style for your messages extension.</p><p>Once the user decides that they want to send the message you've <span>composed</span><a id="id325607114" class="indexterm"></a> on their behalf, they must manually send the message. Once this happens, <code class="literal">didStartSending(_:conversation:)</code> is called on your messages view controller. You won't be notified when this message was successfully sent to the recipient. This means that you can't make any assumptions in your app about whether the message was delivered to the recipient.</p><p>If the user decided to not send your <code class="literal">MSMessage</code> instance, <code class="literal">didCancelSending(_:)</code> is called. You can use this method to clean up or do something else in response to the cancel event. Note that both the start and cancel methods are only called when you're working with <code class="literal">MSMessage</code> instances. If you're sending a simple text, as <span class="strong"><strong>The Daily Quote</strong></span> does, you won't be notified about these events at all.</p></div></div>