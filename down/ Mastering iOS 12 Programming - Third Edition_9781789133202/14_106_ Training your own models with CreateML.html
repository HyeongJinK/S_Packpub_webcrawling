<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch14lvl1sec101"></a>Training your own models with CreateML</h2></div></div><hr /></div><p>As part of Xcode 10 and Apple's latest <span>version</span><a id="id325333116" class="indexterm"></a> of macOS, called <span class="strong"><strong>Mojave</strong></span>, they have shipped a new tool that you can use to train your own machine learning models by adding specializations to existing models. This means that you can train your own natural language model that places certain texts in categories that you define. Or, you can <span>train</span><a id="id325580944" class="indexterm"></a> a model that recognizes certain product names or terms in a text that is specific to your application's domain.</p><p>If you're building a news app, you might want to <span>train</span><a id="id325580955" class="indexterm"></a> a CoreML model that can automatically categorize the articles in the app. You can then use this model to keep track of the articles your users read, and present articles that are most likely to fit their interests on a dedicated page in your app.</p><p>In this segment, you will learn how to train natural language models and how you can train an image recognition model based on the Vision framework. In doing so, you will find that creating a large and optimized training set is crucial when you want to train a machine learning model.</p><p>In the code bundle for this chapter, you will find a Playground called <code class="literal">CreateML</code>. This playground contains all the resources used for training the natural language models.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch14lvl2sec81"></a>Training a natural language model</h3></div></div></div><p>The Natural Language framework has <span>excellent</span><a id="id325605894" class="indexterm"></a> features to analyze text with. Bundled with the power of machine learning models, you can perform some powerful operations on text. Apple has <span>spent</span><a id="id325606029" class="indexterm"></a> a lot of time training several models with vast amounts of data to ensure that the natural language framework can detect names, places, and more.</p><p>However, sometimes you might want to add your own analysis tools. To facilitate this, Natural Language works well with CoreML and Apple's new CreateML framework. With CreateML, you can easily and quickly create your own machine learning models that you can use in your apps straight away.</p><p>You can use several different types of training for a Natural Language model. In this section, you will learn about two different models:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">A text classifier</li><li style="list-style-type: disc">A word tagger</li></ul></div><p>The <span class="strong"><strong>text classifier</strong></span> will classify a particular piece of text with a label. This is similar to the sentiment analysis you have implemented in the <strong class="userinput"><code>TextAnalyzer</code></strong> sample app. An example of an entry in your training data would look as follows:</p><pre class="programlisting">{
  "text": "We took an exclusive ride in a flying car",
  "label": "Tech"
}</pre><p>This is a sample of a news article headline that belongs in a category labeled <span class="emphasis"><em>Tech</em></span>. When you feed a large number of samples like this to your model, you could end up with a classifier that can apply labels to news articles based on their headlines. Of course, this assumes that the headlines are specific enough and contain enough information to train the classifier properly. In reality, you will find that short sentences like these will not make the best models. The sample Playground contains a JSON file with training data that attempts to separate news articles into two categories; politics and tech. Let's see how the model can be trained so you can then see for yourself how accurate the model is.</p><p>The following code trains and stores the custom CoreML model:</p><pre class="programlisting">import CreateML
import Foundation

let trainingData = try! MLDataTable(contentsOf: Bundle.main.url(forResource: "texts", withExtension: "json")!)
let model = try! MLTextClassifier(trainingData: trainingData, textColumn: "text", labelColumn: "label")
try! model.write(to: URL(fileURLWithPath: "/path/to/folder/TextClassifier.mlmodel"))</pre><p>Training the entire model <span>requires</span><a id="id325606078" class="indexterm"></a> only a couple of lines of code. All you need to do is obtain your training data, create the classifier, and save it somewhere on your machine. You can even do some quick testing to see whether your model works well, right inside of the playground. Note that the preceding code uses a <code class="literal">try!</code> statement. This is done to keep the code sample brief and simple. In your own apps, you should always strive for <span>proper</span><a id="id325606091" class="indexterm"></a> error handling to avoid surprising crashes.</p><p><span>The string that is passed to</span> the <code class="literal">URL(fileURLWithPath:)</code> initializer, represents the location where your model will be stored. Make sure to specify the full path here, so, for instance, use <code class="literal">/Users/donnywals/Desktop/TextClassifier.mlmodel</code>, and not <code class="literal">~/Desktop/TextClassifier.mlmodel</code>.</p><p>The following lines of code test two different headlines to see if the model correctly labels them:</p><pre class="programlisting">let techHeadline = try! model.prediction(from: "Snap users drop for first time, but revenue climbs")
let politicsHeadline = try! model.prediction(from: "Spike Lee says President Donald Trump is a 'bullhorn' for racism")</pre><p>If you're happy with the results of your model, you can grab the trained model from the place where you saved it, and immediately add it to your Xcode project. From there, you can use the model like you would use any other model.</p><p>Let's see another example of a Natural Language model. In this case, the model should label every word in a text to classify it as a certain type of word. For instance, you could train the model to recognize certain brand names, product names, or other words that have special meanings to your app. An example of training data that you could use to train a model like this is the following:</p><pre class="programlisting">{
  "tokens": ["Apple", "announced", "iOS 12", "and", "Xcode 10", "at", "WWDC 2018"],
  "labels": ["COMPANY", "NONE", "OPERATING_SYSTEM", "NONE", "SOFTWARE", "NONE", "EVENT"]
}</pre><p>By collecting many samples that include the words that you want to label, your model will be able to not only match tags based on the word itself, but even on the surrounding words. Essentially, the model would be aware of the context in which each word is used to then determine the correct tag. Once you have collected enough sample data, you can train the model in a similar way as the classifier:</p><pre class="programlisting">let labelTrainingData = try! MLDataTable(contentsOf: Bundle.main.url(forResource: "labels", withExtension: "json")!)
let model = try! MLWordTagger(trainingData: labelTrainingData, tokenColumn: "tokens", labelColumn: "labels")
try! model.write(to: URL(fileURLWithPath: "path/to/folder/TextTagger.mlmodel"))</pre><p>The amount of code to train the model hasn't changed. The only difference is that the previous model was based on the <code class="literal">MLTextClassifier</code> class, and the current model is based on the <code class="literal">MLWordTagger</code>. Again, you can immediately use the trained model to make some predictions that you can then use to validate whether the model was trained properly. Providing good data and testing often are the keys to building a great CoreML model.</p><p>In addition to text analysis models, CreateML can also help you to train your own image recognition models. Let's see how this works next.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch14lvl2sec82"></a>Training a Vision model</h3></div></div></div><p>In the <strong class="userinput"><code>ImageAnalyzer</code></strong> sample app, you saw that <span>picking</span><a id="id325607249" class="indexterm"></a> an image of a certain car would be classified as a sports car with a pretty low confidence score. You can train your own vision model that specializes in recognizing certain cars.</p><p>Collecting good training data for image classifiers is tough, because you have to make sure that you gather many pictures of your subjects from all sides and in many different environments. For instance, if all your car images feature cars that are next to trees, or on the road, the model might end up classifying anything with trees or a road to be a car. The only way to obtain a perfect training set is to experiment, tweak, and test.</p><p>Training a Vision model works slightly different <span>from</span><a id="id325609925" class="indexterm"></a> training a Natural Language model. You can't use a JSON file to feed your test data to the classifier. So, instead, you should create folders that contain your images where the folder name is the label you want to apply to each image inside that folder. The following screenshot is an example of a training set that contains two kinds of labels:</p><div class="mediaobject"><img src="/graphics/9781789133202/graphics/812be0d3-c38a-4135-ae8b-808b6bc4053a.png" /></div><p>Once you have collected your set of training data, you can store it anywhere on your computer—for instance, on the desktop. You will then pass the path for your training data to your model training code as follows:</p><pre class="programlisting">import CreateML
import Foundation

let dataUrl = URL(fileURLWithPath: "/path/to/trainingdata")
let source = MLImageClassifier.DataSource.labeledDirectories(at: dataUrl)
let classifier = try! MLImageClassifier(trainingData: source)
try! classifier.write(toFile: "~/Desktop/CarClassifier.mlmodel")</pre><p>Again, you only need a couple of lines of code to train a model. That's how powerful CreateML is. If you want, you can quickly test your image classifier by dropping the <code class="literal">.mlmodel</code> file in the <strong class="userinput"><code>ImageAnalyzer</code></strong> project, and using that, instead of the <code class="literal">MobileNet</code> classifier that you used before.</p><p>Apart from the simple ways of training models, there <span>are</span><a id="id325611540" class="indexterm"></a> certain <span>parameters</span><a id="id325611548" class="indexterm"></a> that you can pass to the different CreateML classifiers. If you have trouble training your models properly, you could tweak some of the parameters that are used by CreateML. For instance, you could apply more iterations to your training set, so the model gains a deeper understanding of the training data.</p><p>As mentioned before in this chapter, machine learning is a subject that could span several books on its own, and even though CreateML makes training models straightforward and simple, it's not easy to train a robust model without any prior machine learning experience.</p></div></div>