<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch15lvl1sec167"></a>Provisioning Linux VM using PowerShell script </h2></div></div><hr /></div><p>In this recipe, we will use a PowerShell script to create a <span>virtual</span><a id="id326637664" class="indexterm"></a> machine on Azure. In its essence, it is simply a series of instructions in PowerShell that are executed one after the other, as we have already seen in the <span>previous</span><a id="id326493109" class="indexterm"></a> chapters in this book.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec439"></a>Getting ready</h3></div></div></div><p>If you followed the recipes in the previous chapters, you should already have Visual Studio Code installed on your system. If not, go ahead and install VS Code, following the instructions in the <span class="emphasis"><em>Installing Visual Studio Code</em></span> recipe in <a class="link" href="#" linkend="ch02">Chapter 2</a>, <span class="emphasis"><em>Preparing for Administration Using PowerShell</em></span>.</p><p>Once you have Visual Studio Code installed, follow these steps to get started:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Launch Visual Studio Code</li><li>Open the integrated PowerShell Terminal</li><li>Load the <code class="literal">AzureRM.Netcore</code> module</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec440"></a>How to do it…</h3></div></div></div><p>We are now ready to write and execute the script:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>In the script pane, paste the following content:</li></ol></div><pre class="programlisting">Param( 
# Variables for common values 
    [string]$ResourceGroup = "packtpub-rg", 
    [string]$storageAcctName = "packtstorage", 
    [string]$Location = "East US", 
    [string]$VNetName = "packtpub-vnet", 
    [string]$NicName = "packtpub-vm-nic", 
    [string]$DiskName = "packtUbuntu", 
    [string]$VmName = "packtpub-ubuntu" 
) 

# Check for open session 
Connect-AzureRmAccount

# Create user object 
$Cred = Get-Credential -Message "Enter username and password of administrator credentials" 

# Create a resource group 
New-AzureRmResourceGroup -Name $ResourceGroup -Location $Location 

# Create a storage account 
New-AzureRmStorageAccount -Name $storageAcctName -ResourceGroupName $ResourceGroup -Type Standard_LRS -Location $Location 

# Create a subnet configuration 
$SubNetCfg = New-AzureRmVirtualNetworkSubnetConfig -Name mySubnet -AddressPrefix 10.0.1.0/24 

# Create a virtual network 
$VNet = New-AzureRmVirtualNetwork -Name $VNetName -ResourceGroupName $ResourceGroup -Location $Location -AddressPrefix 10.0.0.0/16 -Subnet $SubNetCfg 

# Create a public IP address and specify a DNS name 
$Ip = New-AzureRmPublicIpAddress -Name $NicName -ResourceGroupName $ResourceGroup -Location $Location -AlLocationMethod Dynamic

# Create a virtual network card and associate with public IP address and NSG 
$Nic = New-AzureRmNetworkInterface -Name $NicName -ResourceGroupName $ResourceGroup -Location $Location -SubnetId $VNet.Subnets[0].Id -PublicIpAddressId $Ip.Id

# Create a blob storage
$StorageAccount = Get-AzureRmStorageAccount -ResourceGroupName $ResourceGroup -Name $storageAcctName
$OsDiskUri = $StorageAccount.PrimaryEndpoints.Blob.ToString()+'vhds/'+$DiskName+".vhd"

# Create a virtual machine configuration
$Vm = New-AzureRmVMConfig -VMName $VmName -VMSize "Basic_A1"
$Vm = Set-AzureRmVMOperatingSystem -VM $Vm -Linux -ComputerName $VmName -Credential $Cred
$Vm = Set-AzureRmVMSourceImage -VM $Vm -PublisherName 'Canonical' -Offer 'UbuntuServer' -Skus '18.04-LTS' -Version 'latest'
$Vm = Add-AzureRmVMNetworkInterface -VM $Vm -Id $Nic.Id
$Vm = Set-AzureRmVMOSDisk -VM $Vm -Name $DiskName -VhdUri $OsDiskUri -CreateOption fromImage

# Create a virtual machine
New-AzureRmVM -ResourceGroupName $ResourceGroup -Location $Location -VM $Vm</pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Run the script by pressing the <span class="emphasis"><em>F5</em></span> key.</li><li>Watch out for errors. In most cases, there should be none. However, if you do get any, check whether the script has been pasted/typed verbatim.</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec441"></a>How it works…</h3></div></div></div><p>The script is an example of creating a Ubuntu 18.04-LTS virtual machine. At the beginning of the script, we define its parameters and their values.</p><p>This script is nothing but a collection of the commands you ran for the <span class="emphasis"><em>Provisioning a Ubuntu 18.04 LTS virtual machine using AzureRM.NetCore cmdlets</em></span> recipe, with the difference being the initial declaration of the parameters. These parameters can be declared in the beginning, just like in this script, or be configured to take in input based on your requirements.</p><p>How it works is simple: the commands are <span>run</span><a id="id326327481" class="indexterm"></a> one line after another, while <span>retaining</span><a id="id326327473" class="indexterm"></a> the values of the variables. Once the script finishes running and the virtual machine is created, the buffer is returned for further commands.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec442"></a>There's more…</h3></div></div></div><p>Do not clean up the resources this time if you plan to go through the next recipe, <span class="emphasis"><em>Performing management tasks using ARM PowerShell cmdlets</em></span>, immediately. If not, it is a good idea to clean up the resource group and redo this recipe when you plan to go through <span class="emphasis"><em>Performing management tasks using ARM PowerShell cmdlets</em></span>.</p></div></div>