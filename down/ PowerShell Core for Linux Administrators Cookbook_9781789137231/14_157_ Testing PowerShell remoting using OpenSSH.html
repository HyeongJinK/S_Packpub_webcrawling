<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch14lvl1sec153"></a>Testing PowerShell remoting using OpenSSH</h2></div></div><hr /></div><p>In this recipe, we'll <span>look</span><a id="id325898630" class="indexterm"></a> at how we can test <span>PowerShell</span><a id="id325892297" class="indexterm"></a> remoting using OpenSSH with the PowerShell 6 console. It is important to understand that you have to install OpenSSH on the local and remote machine. </p><p>You're going to see the PowerShell remoting connections between the following:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Windows to Windows</li><li>Windows to Linux</li><li>Linux to Windows</li><li>Linux to Linux</li></ol></div><p> </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch14lvl2sec391"></a>Getting ready</h3></div></div></div><p>It is important to understand that you have to install OpenSSH on the local and remote machine. It is required that you follow the previous recipe's setup instructions and configurations for each of the host machines. Complete this step to get ready for this recipe:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>To open the PowerShell console, type in <code class="literal">pwsh</code>.</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch14lvl2sec392"></a>How to do it…</h3></div></div></div><p>The<code class="literal">New-PSSession</code>, <code class="literal">Enter-PSSession</code>, and <code class="literal">Invoke-Command</code> cmdlets are the three cmdlets that help with the PowerShell remoting feature. Let's dig further to dissect the internals of PowerShell remoting:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>To create a session to a remote Windows machine, run the following command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; $Session= New-PSSession -HostName wintel01 -UserName ram</strong></span>
<span class="strong"><strong>ram@wintel01's password:</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>To display the session details, call the <code class="literal">$Session</code> variable on the PowerShell console:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; $session</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>To enter the remoting session, use the session parameter, along with the <code class="literal">Enter-PSSession</code> cmdlet:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Enter-PSSession -Session $session</strong></span>
<span class="strong"><strong>[wintel01]: PS&gt;</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>To invoke the script on a remote machine, run the <code class="literal">Invoke-Command</code> cmdlet:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Invoke-Command $session -ScriptBlock {Get-Process| Sort-Object CPU -Descending|Select-Object name,HandleCount,WorkingSet,PrivateMemorySize,VirtualMemorySize -Firs</strong></span>
<span class="strong"><strong>t 5|Format-Table -AutoSize}</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Run the simple cmdlet to prove that the session is open and able to execute the PowerShell cmdlets:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Get-Process |Sort-Object CPU |Select-Object -First 10</strong></span></pre><p> </p><p>A sample output from the preceding command is shown in the following screenshot:</p><div class="mediaobject"><img src="/graphics/9781789137231/graphics/2070bd26-853b-4204-bbc6-c2e189ac1511.png" /></div><p>Let's create a session to a remote Linux machine (Ubuntu - <code class="literal">10.2.6.68</code>) from a Windows host machine (Wintel01). The commands are no different for Windows, Linux, and macOS:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>To create a session to a remote Linux machine, run the following command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; New-PSSession -HostName 10.2.6.68 -UserName prashant</strong></span>
<span class="strong"><strong>prashant@10.2.6.68's password:</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>To assign session details to a variable, run the following command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; $session=New-PSSession -HostName 10.2.6.68 -UserName prashant</strong></span>
<span class="strong"><strong>prashant@10.2.6.68's password:</strong></span></pre><pre class="programlisting"><span class="strong"><strong>PS&gt; $Session</strong></span></pre><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>To enter the remote machine, use <code class="literal">Enter-PSSession</code>, along with the <code class="literal">Session</code> parameter:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt;  Enter-PSSession -Session $session</strong></span>
<span class="strong"><strong>[10.2.6.68]: PS&gt; cat /etc/lsb-release</strong></span>
<span class="strong"><strong>[10.2.6.68]: PS&gt; $IsLinux</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>To run the script on a remote <span>Linux</span><a id="id326261829" class="indexterm"></a> machine, call the <code class="literal">Invoke-Command</code> cmdlet:</li></ol></div><pre class="programlisting"><span class="strong"><strong>[10.2.6.68]: PS&gt; Invoke-Command $session -ScriptBlock {Get-Process| Sort-Object CPU -Descending|Select-Object name,HandleCount,WorkingSet,PrivateMemorySize,VirtualMemorySize -Firs</strong></span>
<span class="strong"><strong>t 5|Format-Table -AutoSize}</strong></span>
<span class="strong"><strong>
[10.2.6.68]: PS&gt; Get-Process |Sort-Object CPU |Select-Object -First 10</strong></span></pre><p>This results in the following output:</p><div class="mediaobject"><img src="/graphics/9781789137231/graphics/6956012e-fa13-4526-82bd-df04eea1c1a4.png" /></div><p> </p><p>Let's create a session to a remote Windows machine (wintel01) from a Linux host (Ubuntu – <code class="literal">10.2.6.68</code>) to prove that the commands and theories are applicable in the <span>same</span><a id="id326352518" class="indexterm"></a> way and that it is platform-independent:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>To create a session to a remote Windows machine, run the following command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Enter-PSSession -HostName wintel01 -UserName ram</strong></span>
<span class="strong"><strong>ram@wintel01's password:</strong></span>
<span class="strong"><strong>[wintel01]: PS&gt; hostname </strong></span>
<span class="strong"><strong>wintel01</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>To assign session details to a variable, run the following command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; $session=New-PSSession -HostName wintel01 -UserName ram</strong></span>
<span class="strong"><strong>ram@wintel01's password: </strong></span>
<span class="strong"><strong>PS&gt; $session</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>To enter a remote session, use <code class="literal">Enter-PSSession</code>, along with the <code class="literal">Session</code> parameter:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Enter-PSSession -Session $session </strong></span>
<span class="strong"><strong>[wintel01]: PS&gt; hostname </strong></span>
<span class="strong"><strong>wintel01</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>To run the script on a remote Windows machine, call the <code class="literal">Invoke-Command</code> cmdlet:</li></ol></div><pre class="programlisting"><span class="strong"><strong>[wintel01]: PS&gt; Invoke-Command $session -ScriptBlock {Get-Process| Sort-Object CPU -Descending|Select-Object name,HandleCount,WorkingSet,PrivateMemorySize,VirtualMemorySize -First 5|Format-Table -AutoSize} </strong></span>

<span class="strong"><strong>[wintel01]: PS&gt; hostname </strong></span>
<span class="strong"><strong>wintel01</strong></span>
<span class="strong"><strong>[wintel01]: PS&gt; $IsWindows</strong></span>
<span class="strong"><strong>True</strong></span>
<span class="strong"><strong>[wintel01]: PS&gt; Get-Process|Sort-Object CPU -Descending |Select-Object -First 5</strong></span></pre><p>This gives the following result:</p><div class="mediaobject"><img src="/graphics/9781789137231/graphics/48977aaa-d068-4b0b-9488-4e6198d89380.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch14lvl2sec393"></a>How it works…</h3></div></div></div><p><span>SSH always sets up an encrypted connection</span><span>between the remote and client machine.</span><span>With the established connection, a shell is created. It works the <span>same</span><a id="id325587114" class="indexterm"></a> way</span><span>as it does when you're locally logged on to the remote server.</span></p><p><span>The first time you connect to the remote server,</span><span>SSH <span>prompts</span><a id="id325587131" class="indexterm"></a> you with a window, asking you to accept the server's host key.</span> If it's your first time connecting to the server, this <span>is normal.</span> But if you've been connecting to an SSH server for a while and you suddenly see the message <strong class="userinput"><code>The authenticity of host 'wintel01 (10.7.2.204)' can't be established. ECDSA key fingerprint is SHA256:2GnYAODZGB+UEuJjuSXrpgOP3gP4xI+rGCtCWfcvHbc. Are you sure you want to continue connecting (yes/no)?</code></strong><span class="emphasis"><em>, </em></span>you might want to investigate a little bit before <span>accepting the key. After configuring SSH, you can run a command using the <code class="literal">Invoke-command</code> cmdlet or any other supported cmdlets, as shown in the preceding screenshot.</span></p><p> </p></div></div>