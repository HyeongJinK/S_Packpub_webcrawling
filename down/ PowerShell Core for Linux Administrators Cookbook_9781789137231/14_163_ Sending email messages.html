<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch14lvl1sec159"></a>Sending email messages</h2></div></div><hr /></div><p>In this recipe, you'll find out <span>how</span><a id="id325585847" class="indexterm"></a> to use the <code class="literal">Send-MailMessage</code> cmdlet to send an email to an intended recipient from within PowerShell.</p><p> </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch14lvl2sec413"></a>Getting ready</h3></div></div></div><p>This script is going to be an enhancement of the previous recipe. </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch14lvl2sec414"></a>How to do it…</h3></div></div></div><p>Here's the script that will send the email message:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Save the following content in the <code class="literal">PSHTMLReport.ps1</code> file:</li></ol></div><pre class="programlisting"># inputfile - filelocation of the CSV file
$inputfile='/tmp/input.CSV'

# Output file 
$outfile='/tmp/out.html'
#Email variable declaration
$from= 'donotreply@packtpublinux.com'
$to= 'pjayaram@gmail.com'
$cc= 'pjayaram@gmail.com'
$sub= 'Process Info-PowerShell Remoting'
$body= 'PowerShell script automation email to pull process related information from Windows and Linux machines'
$attachment= $outfile
$smtpserver= 'packpublinux@smtp.com'

#declare the array to hold multiple values
$Top=@()
#the output of import-csv is assigned to a variable
$process=Import-Csv $inputfile|% { Invoke-Command-HostName $_.Server-UserName $_.User-ScriptBlock { Param($Server)
Get-Process| Sort-Object CPU-Descending |`
Select-Object Handles, CPU,`
 @{name ="NPM"; Expression = {[int]($_.NPM/1024)}},`
 @{name ="PM"; Expression = {[int]($_.PM/1024)}},`
 @{name ="WS"; Expression = {[int]($_.WS/1024)}},`
 @{name ="VM"; Expression = {[int]($_.VM/1MB)}},`
 @{name ="ServerName"; Expression = {($server)}},`
 Id, ProcessName -First 5 }-Args $_.Server
}
foreach($procin$process)
{
$row=New-Object-Type PSObject -Property @{
 ServerName =$proc.Servername 
 ID =$proc.ID
 ProcessName =$proc.ProcessName
 NPM_KB =$proc.NPM
 PM_KB =$proc.PM
 WS_KB =$proc.WS
 VM_MB =$proc.VM
 CPU_S =$proc.CPU
 } 
$Top+=$row
 }
$Top|ConvertTo-Html|Out-File $outfile

#Send Email output to intended recipients

$message=new-objectSystem.Net.Mail.MailMessage
$message.From=$from
$message.To.Add($to)
$message.CC.Add($cc)
$message.IsBodyHtml=$True
$message.Subject=$sub
$attach=new-objectNet.Mail.Attachment($attachment)
$message.Attachments.Add($attach)
$message.body=$body
$smtp=new-objectNet.Mail.SmtpClient($smtpserver)
$smtp.Send($message)</pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>In the script, modify the following variable as per the environment:</li></ol></div><pre class="programlisting">#Ouput file 
$outfile='/tmp/out.html'
#Email variable declaration
$from= 'donotreply@packtpublinux.com'
$to= 'pjayaram@gmail.com'
$cc= 'pjayaram@gmail.com'
$sub= 'Process Info-PowerShell Remoting'
$body= 'PowerShell script automation email to pull process related information from Windows and Linux machines'
$attachment= $outfile
$smtpserver= 'packpublinux@smtp.com'

</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note86"></a>Note</h3><p>Nowadays, email notifications are vital for monitoring systems in real time. It's essential to know how to configure emails on servers. SMTP is a basic component that can be configured so that it can send email notifications. In this case, the configuration of SMTP is not discussed. It is assumed that you've preconfigured the SMTP server already.</p></div><p> </p><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Run the PowerShell script:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; ./PSHTMLReport.ps1</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Go to your inbox and verify whether the email has been received or not.</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch14lvl2sec415"></a>How it works…</h3></div></div></div><p>Turning the output of a PowerShell script into an <span>automated</span><a id="id325892150" class="indexterm"></a> email is a snap in PowerShell V2, thanks to a nifty new cmdlet called <code class="literal">Send-MailMessage</code>. <code class="literal">Send-MailMessage</code> sends out emails with the credentials of the current user (or an arbitrary user) and an SMTP server. <code class="literal">Send-MailMessage</code> can send HTML emails by using the <code class="literal">-BodyAsHtml</code> switch, and <code class="literal">ConvertTo-HTML</code> can take the output of a cmdlet and turn it into an HTML chunk.</p></div></div>