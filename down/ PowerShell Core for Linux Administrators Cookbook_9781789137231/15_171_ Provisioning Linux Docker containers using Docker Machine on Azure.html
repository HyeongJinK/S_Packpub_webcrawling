<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch15lvl1sec166"></a>Provisioning Linux Docker containers using Docker Machine on Azure</h2></div></div><hr /></div><p>In this recipe, you will understand some of the concepts of the <span>Docker</span><a id="id326326278" class="indexterm"></a> Machine tool and the steps that are required to deploy an Azure Docker container VM using <span>Docker</span><a id="id326326273" class="indexterm"></a> Machine.</p><p>Docker Machine is a tool that lets you install Docker Engine on virtual hosts and manage the hosts with commands. Using <code class="literal">docker-machine</code> commands, you can start, inspect, stop, and restart a managed host, upgrade the Docker client and daemon, and configure a Docker client to talk to your host. Docker Machine uses drivers to enable deployment to different platforms. In this recipe, we will go over the steps to provision a VM running Docker on Microsoft Azure.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec434"></a>Getting ready</h3></div></div></div><p>It is recommended that you meet the following listed prerequisites before proceeding with the recipe:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Open a session with your SU account.</li><li>To install <code class="literal">docker-machine</code>, run the following commands:</li></ol></div><pre class="programlisting"><span class="strong"><strong># base=https://github.com/docker/machine/releases/download/v0.14.0 &amp;&amp;</strong></span>
<span class="strong"><strong>&gt; curl -L $base/docker-machine-$(uname -s)-$(uname -m) &gt; /tmp/docker-machine &amp;&amp;</strong></span>
<span class="strong"><strong>&gt; sudo install /tmp/docker-machine /usr/local/bin/docker-machine</strong></span>
  % Total % Received % Xferd Average Speed Time Time Time Current
                                 Dload Upload Total Spent Left Speed
100 617 0 617 0 0 1458 0 --:--:-- --:--:-- --:--:-- 1458
100 26.7M 100 26.7M 0 0 5043k 0 0:00:05 0:00:05 --:--:-- 6265k</pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Open a PowerShell session by typing <code class="literal">pwsh</code>.</li><li>Import the <code class="literal">AzureRM.Netcore</code> module using <code class="literal">Import-Module</code>:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Import-Module -Name AzureRM.Netcore</strong></span></pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec435"></a>How to do it…</h3></div></div></div><p>We know that the modules have been loaded and that the <code class="literal">docker-machine</code> tool is installed. Now, we can manage our Docker VMs. Follow these steps to complete this recipe:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Connect to an Azure session. Run the following cmdlet and follow the instructions that appear as a warning:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Connect-AzureRmAccount</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Create a resource group by running the following command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; $ResourceGroup = 'packpub-demo' </strong></span>
<span class="strong"><strong>PS&gt; $Location = 'East US' </strong></span>
<span class="strong"><strong>PS&gt; New-AzureRmResourceGroup -Name $ResourceGroup -Location $Location </strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Create a new storage account:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; $StorageAcctName = 'packpubstorageacct'</strong></span>
<span class="strong"><strong>PS&gt; New-AzureRmStorageAccount -Name $StorageAcctName -ResourceGroupName $ResourceGroup -Type Standard_LRS -Location $Location</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Retrieve the Azure subscription ID and assign it to a variable:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; $SubscriptionId = (Get-AzureRmContext).Subscription.Id</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>To provision a VM, run the following <code class="literal">docker-machine</code> command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; docker-machine create --driver azure `</strong></span>
<span class="strong"><strong>--azure-subscription-id $SubscriptionId `</strong></span>
<span class="strong"><strong>--azure-resource-group $ResourceGroup `</strong></span>
<span class="strong"><strong>--azure-location $Location `</strong></span>
<span class="strong"><strong>--azure-ssh-user $env:USERNAME `</strong></span>
<span class="strong"><strong>--azure-open-port 22 `</strong></span>
<span class="strong"><strong>--azure-image "Canonical:UbuntuServer:18.04-LTS:latest" `</strong></span>
<span class="strong"><strong>--azure-size "Standard_D2_v2" `</strong></span>
<span class="strong"><strong>packtpub-ubuntu</strong></span></pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/acd496f8-aa9a-4cec-8595-bcca8d4b0cca.png" /></div><p></p><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Connect to the newly created <code class="literal">packtpub-ubuntu</code> VM:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; docker-machine ssh packtpub-ubuntu </strong></span>

<span class="strong"><strong>prashanth@packtpub-ubuntu:~$</strong></span></pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/ec0d786a-d432-473a-bbd2-ae00091dd2b2.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>Test the configuration:</li></ol></div><pre class="programlisting"><span class="strong"><strong>$ sudo -s</strong></span>
<span class="strong"><strong># ls</strong></span>
<span class="strong"><strong># yum</strong></span>

Command 'yum' not found, but can be installed with:

apt install yum

<span class="strong"><strong># apt install yum</strong></span></pre><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec436"></a>How it works…</h3></div></div></div><p> This recipe details how to use theDocker Machine tool to create hosts in Azure.The <code class="literal">docker-machine</code> command creates a Linux virtual machine in Azure and installs and configures the <span>Docker</span><a id="id325913500" class="indexterm"></a> engine. This lets you manage your <span>Docker</span><a id="id325913509" class="indexterm"></a> hosts in Azure using the same local tools and workflows. To use <code class="literal">docker-machine</code>, refer the installation document at <a class="ulink" href="https://docs.docker.com/machine/install-machine/" target="_blank">https://docs.docker.com/machine/install-machine/</a> and install it on the Linux machine.</p><p>Docker Machine is a tool that uses the Azure driver to enable the deployment of virtual machines on the Azure platform. In this recipe, we saw the steps to provision an Ubuntu VM by running the <code class="literal">docker-machine</code> command on Azure and deploying containers to the VM.</p><p>The provisioning of a new VM is no different than the process of VM creation.</p><p>To create a VM, the following default steps are carried out in a series:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Run and validate the pre-creation checks.</li><li>After completing the machine pre-creation checks, initiate the VM creation process.</li><li>Query to see whether the resource group <code class="literal">packtpub-dockerdemo</code> exists. The command reuses the same resource group since it is available.</li><li>Configure the availability set.</li><li>Configure the network security group for <code class="literal">packtpub-ubuntu-firewall</code> for the specified location.</li><li>Create a virtual network called <code class="literal">docker-machine-vnet</code> for the <code class="literal">packtpub-dockerdemo</code> resource group and, for the specified location, use <code class="literal">East US</code>.</li><li>Configure the <code class="literal">docker-machine</code> subnet for the <code class="literal">docker-machine-vnet</code> virtual network using CIDR <code class="literal">192.168.0.0/16</code>.</li><li>Create a dynamic public IP address named <code class="literal">packtpub-ubuntu-ip</code>.</li><li>Create a network interface called <code class="literal">packtpub-ubuntu-nic</code>.</li><li>Create a storage account called <code class="literal">vhdstk3mnxdlg5i9n65vcif0</code> under <code class="literal">Standard_LRS</code>.</li><li>Proceed to create the <code class="literal">packtpub-ubuntu</code> virtual machine with the specified VM size of <code class="literal">Standard_D2_v2</code>. We also specify the login username, followed by the OS image, <code class="literal">Canonical:UbuntuServer:18.04-LTS:latest</code>.</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec437"></a>There's more…</h3></div></div></div><p>To ensure that we don't coin new names and to save unwanted costs on the resources, clean up the resource group when your lab session ends. Run the following command to do so:</p><pre class="programlisting"><span class="strong"><strong>PS&gt; <span>Remove-AzureRmResourceGroup</span><span> -Name </span>$ResourceGroup</strong></span></pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec438"></a>See also</h3></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Docker Machine overview (<a class="ulink" href="https://docs.docker.com/machine/" target="_blank">https://docs.docker.com/machine/</a>)</li><li style="list-style-type: disc">To get the details of the different <span>Azure</span><a id="id326326338" class="indexterm"></a> regions, refer to <a class="ulink" href="https://azure.microsoft.com/en-in/global-infrastructure/regions/" target="_blank">https://azure.microsoft.com/en-in/global-infrastructure/regions/</a><a class="ulink" href="https://azure.microsoft.com/regions/" target="_blank">.</a></li></ul></div></div></div>