<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch12lvl1sec135"></a>Using the Main function</h2></div></div><hr /></div><p>It is a good practice to make a <span>function</span><a id="id325885491" class="indexterm"></a> do only one thing. This means that, when writing a script that must do a series of tasks, you will need multiple functions. In such a case, one function will call another to perform the task. The structure of the script, then, would be to have the called function written before the calling function. When working with several functions within a script, the entire structure could look upside-down.</p><p>Now, reading and understanding the script may feel a little challenging.</p><p>For instance, I wrote a script for one of my clients that helped them heal a Citrix Virtual Desktop Agent server if it unregistered itself from the Controller for any of several reasons. This script was over 300 lines long, and had a dozen functions that would do the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Find if a server was unregistered</li><li style="list-style-type: disc">Send out <code class="literal">server unregistered</code> and other notifications to the Service Desk and/or the concerned teams</li><li style="list-style-type: disc">Place the server in maintenance mode in order to prevent user connections</li><li style="list-style-type: disc">Attempt a restart of the Citrix Desktop Service and purge Prelogon connections</li><li style="list-style-type: disc">Wait and watch the resource consumption and perform a few diagnostics and troubleshooting steps</li><li style="list-style-type: disc">Send a notification to the connected users that the server will be taken down for maintenance</li><li style="list-style-type: disc">Attempt a server restart if nothing works by issuing a simple Restart-Computer account</li><li style="list-style-type: disc">If the restart doesn't work, connect using VMware PowerCLI and perform a forceful restart</li><li style="list-style-type: disc">Perform post-restart steps and, finally, check if the server was registered with the Controller</li></ul></div><p>At a glance, however, an administrator would not be able to understand what the script is doing, and which is the actual function that governs all of these tasks.</p><p> </p><p>Write two functions: one to generate filenames and another to create those files. Use the former function in conjunction with the latter to create 10 files. Ensure that the script is readable.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec350"></a>How to do it…</h3></div></div></div><p>We will only write the first function; we already have a function to create the files. Follow these steps to get started:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Write the function to generate the filenames. Make this function really simple and bare-bones:</li></ol></div><pre class="programlisting">function New-FileName {
    param (
        # The name of the file
        [Parameter(Mandatory=$false)]
        [string]
        $Prefix='File',

        # The number of files to be generated
        [Parameter(Mandatory=$false, Position=1)]
        [int]
        $Count=1
    )

    begin {
        $InitCount = 1
    }

    process {
        while ($InitCount -le $Count) {
            Write-Output $Prefix$InitCount
            $InitCount++
        }
    }
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li><p>Copy and paste the <code class="literal">New-File</code> function from <code class="literal">09-New-File.ps1</code>. You may want to remove the <code class="literal">ConfirmPreference</code> line from the function if you do not want the function to prompt you to confirm the file's creation.</p></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Add the following to the beginning of the script:</li></ol></div><pre class="programlisting">function Main {
    New-FileName -Count 10 | New-File
}</pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Call the <code class="literal">Main</code> function at the end:</li></ol></div><pre class="programlisting">Main</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec351"></a>How it works…</h3></div></div></div><p>This process of creating a main function and calling it in the end is just so that the reader knows the ultimate intent right at the beginning of the script, and that it is not an absolute necessity.</p><p>PowerShell works on the scripts in the same manner as it does on the terminal. This is done to give a unified experience, as well as to provide script writers with the ability to test out their snippets on the terminal if they want to, or even actually run the snippets on the terminal.</p><p>You can only run those functions that have already been declared; a <span>function</span><a id="id326584389" class="indexterm"></a> that is not yet written (or read by PowerShell) cannot be run. In the case of long-running scripts with several functions, it is possible for a user to feel lost, regarding what the script is actually supposed to achieve.</p><p>To be clear about the ultimate intent and call the functions sequentially, we use the <code class="literal">Main</code>, <code class="literal">Function1</code> – <code class="literal">FunctionN</code> construct and then, finally, call the <code class="literal">Main</code> function in the end. To maintain readability, the first thing we do is create the <code class="literal">Main</code> function. If there weren't the <code class="literal">Main</code> function, we would have had the following line at the end of the script:</p><pre class="programlisting">New-FileName -Count 10 | New-File</pre><p>We simply declare the <code class="literal">Main</code> function, write our functions that do the tasks, and then call the already declared <code class="literal">Main</code> function at the end. This way, we execute the functions in the right sequence and, at the same time, show the user what the actual intent is.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip78"></a>Note</h3><p>It is not necessary that the <code class="literal">Main</code> function be called <code class="literal">Main</code>. It is just a convention to call it so, especially because we are used to it in many languages, such as C++.</p></div><p> </p></div></div>