<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec48"></a>Scheduling jobs in PowerShell</h2></div></div><hr /></div><p>In this recipe, we will see how to schedule a job using <span>PowerShell</span><a id="id325892266" class="indexterm"></a> cmdlets.</p><p> </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec132"></a>Getting ready</h3></div></div></div><p>This recipe may involve some of the capabilities that work well only with super-user privileges. Therefore, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Log in to the Terminal using super-user privileges.</li><li>Open a PowerShell console using the <code class="literal">pwsh</code> command.</li><li>Import the module (refer to the recipe, <span class="emphasis"><em>Installing the CronTab PowerShell module</em></span>).</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec133"></a>How to do it…</h3></div></div></div><p>You need a script that needs to be scheduled. If you don't have a script, use a simple command:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>First, check the existence of the command or script that you want to schedule from the Terminal:</li></ol></div><pre class="programlisting"><span class="strong"><strong>$ pwsh -f "/tmp/DataLoading.PS1;"</strong></span></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note37"></a>Note</h3><p>The <code class="literal">DataLoading.PS1</code> script is from the <a class="link" href="#" linkend="ch16">Chapter 16</a>, <span class="emphasis"><em>Using PowerShell for SQL Database Management</em></span>, the <span class="emphasis"><em>Data formatting examples with PowerShell </em></span>recipe. This is just for the demo. You can use any of the scripts of your choice to run the code.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>To run the script based on a schedule, use the <code class="literal">New-CronJob</code> cmdlet:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; New-CronJob -Command 'pwsh -f "/tmp/DataLoading.PS1;"' -Minute 0,15,30,45 | Out-Host</strong></span>

<span class="strong"><strong>PS&gt; New-CronJob -Command 'pwsh -f "/tmp/DataLoading.PS1;"' -Minute */15 | Out-Host</strong></span>

<span class="strong"><strong>PS&gt; New-CronJob -Command 'pwsh -f "/tmp/DataLoading.PS1;"' -Minute */15 -Hour 10-12 | Out-Host </strong></span>

<span class="strong"><strong>PS&gt; New-CronJob -Command 'rm -rf /tmp/clr*' -Minute 15 -Hour 1 | Out-Host </strong></span>

<span class="strong"><strong>PS&gt; New-CronJob -Command 'pwsh -f "/tmp/DataLoading.PS1;"' -Minute */15 -Hour 10-12 -DayOfWeek sun,tue,fri -Month Jan,Mar,Jun,Sep,Dec | Out-Host</strong></span></pre><p> </p><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>To get the list of currently scheduled jobs, run the <code class="literal">Get-CronJob</code> cmdlet:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS /&gt; Get-CronJob |Format-Table -AutoSize</strong></span>
Minute Hour DayOfMonth Month DayOfWeek Command
------ ---- ---------- ----- --------- -------
2 * * * * python ./pythonexmaple.py
5 1 * * * rm -rf /tmp/clr*.*
15 * * * * /usr/bin/pwsh -c "cd /tmp/; ./DataLoading.PS1;"
*/15 * * * * /usr/bin/pwsh -c "cd /tmp/; ./DataLoading.PS1;"
0,15,30,45 * * * * /usr/bin/pwsh -c "cd /tmp/; ./DataLoading.PS1;"
*/15 10-12 * * * /usr/bin/pwsh -c "cd /tmp/; ./DataLoading.PS1;"
*/15 10-12 * Jan,Mar sun,tue,fri /usr/bin/pwsh -c "cd /tmp/; ./DataLoading.PS1;"</pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>To view the contents of scheduled jobs in the <code class="literal">crontab</code> configuration file, use <code class="literal">Get-CronJob</code>:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS &gt; Get-CronJob</strong></span>
2 * * * * python ./pythonexmaple.py
5 1 * * * rm -rf /tmp/clr*.*
*/15 * * * * /usr/bin/pwsh -c "cd /tmp/; ./DataLoading.PS1;"
0,15,30,45 * * * * /usr/bin/pwsh -c "cd /tmp/; ./DataLoading.PS1;"
*/15 10-12 * * * /usr/bin/pwsh -c "cd /tmp/; ./DataLoading.PS1;"
*/15 10-12 * Jan, Mar, Jun, Sep, Dec sun, tue, fri /usr/bin/pwsh -c "cd /tmp/; ./DataLoading.PS1;"</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec134"></a>How it works…</h3></div></div></div><p>The PowerShell implementation of <code class="literal">crontab</code> is technically a wrapper, which encapsulates the <code class="literal">crontab</code> commands that work in Linux. Why use PowerShell to schedule jobs if the underlying functions are that of <code class="literal">crontab</code>? The reason would be the uniformity of usage, the consistency, and the object-oriented approach. If you know how to use PowerShell, that is all you need in order to be able to use <code class="literal">crontab</code> as well. That is the goal.</p><p>The <code class="literal">New-CronTab</code> cmdlet is used to define new tasks. The parameters available define the frequency with which the tasks are to be executed. The Cron jobs are executed with the same privileges as with which the <code class="literal">New-CronTab</code> cmdlet was executed. In other words, if you launched PowerShell as a super-user and ran <code class="literal">New-CronTab</code> to define a schedule, the commands that would be run on the specified schedule would be run with super-user privileges.</p><p> </p><p>In the steps, the command to run is listed using the <code class="literal">-Command</code> parameter.</p><p>Let us also look briefly at what input the <code class="literal"><span>New-CronTab</span></code> accepts. There are two ways to run a command every 15 minutes: The first is where each minute is specified:</p><pre class="programlisting">0,15,30,45 * * * * /path/command</pre><p>Alternatively, you can simplify the same to <code class="literal">*/15</code>:</p><pre class="programlisting">*/15 * * * * /path/command</pre><p>A range can also be specified for scheduling a job. In our example, the job runs at 10 A.M., 11 A.M., and 12 P.M., using the range option:</p><pre class="programlisting">*/15 10-12 * * * /path/command</pre><p>In the last example (the <code class="literal"><span>Names</span></code> format), the job is scheduled to run using the <code class="literal"><span>DayOfweek</span></code> (<code class="literal">sun</code>, <code class="literal">tue</code>, <code class="literal">fri</code>) and <code class="literal"><span>Month</span></code><span>(<code class="literal">Jan</code></span>, <span><code class="literal">Mar</code></span>) parameters:</p><pre class="programlisting">*/15     10-12 *          Jan,Mar sun,tue,fri /usr/bin/pwsh -c "cd /tmp/; ./DataLoading.PS1;"</pre><p>The Cron table configuration is read using the <code class="literal">Get-CronTab</code> cmdlet. Each line represents a record of metadata about the scheduled job; it specifies the frequency and the command/script that should be executed.</p><p>The caveat as of now is that, if you set up Cron jobs incorrectly, they <span>appear</span><a id="id326352489" class="indexterm"></a> to silently fail. Cron has its own reserved <code class="literal">syslog</code> facility, so you should have a look at the <code class="literal">/etc/syslog.conf</code> file (or the equivalent file in your Linux distribution) to see where the messages from <code class="literal">cron</code> are sent. Common destinations include <code class="literal">/var/log/cron</code>, <code class="literal">/var/log/messages</code>, and <code class="literal">/var/log/syslog</code>.</p></div></div>