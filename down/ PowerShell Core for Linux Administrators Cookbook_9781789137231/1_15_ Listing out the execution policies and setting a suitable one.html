<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch01lvl1sec24"></a>Listing out the execution policies and setting a suitable one</h2></div></div><hr /></div><p>This is a Windows-only recipe. Skip this if <span>you</span><a id="id325901985" class="indexterm"></a> never plan to work on Windows.</p><p>There was a time when running scripts on Windows computers was a cakewalk. Windows computers <span>were</span><a id="id326090421" class="indexterm"></a> highly prone to remote script executions. With PowerShell, Microsoft added a safety belt that allowed the user some control over how PowerShell scripts were loaded. Some specific models of script executions got restricted, which plugged some holes in the system.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note24"></a>Note</h3><p>It is important to remember that execution policies are not a security feature. There are ways to circumvent this fence. Execution policies are in place only to ensure that users don't accidentally run scripts without awareness.</p></div><p>PowerShell Core on Windows and Windows PowerShell contain this feature. Running PowerShell scripts on Windows is still restricted by default. On PowerShell Core on Linux, execution policies do not work at the moment, and, based on the interactions in the community, it is uncertain whether this feature will ever make it to PowerShell on Linux. Regardless, if you are reading this book, you are more than capable of understanding the perils of scripts from unknown sources.</p><p>An execution policy determines what type of scripts can be executed. Here are the six execution policies (excluding Default):</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><code class="literal">AllSigned</code></li><li><code class="literal">RemoteSigned</code></li><li><code class="literal">Restricted</code></li><li><code class="literal">Unrestricted</code></li><li><code class="literal">Bypass</code></li><li><code class="literal">Undefined</code></li></ol></div><p>There are three scopes as well:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><code class="literal">Process</code></li><li><code class="literal">CurrentUser</code></li><li><code class="literal">LocalMachine</code></li></ol></div><p> </p><p>A combination of an execution policy and a scope are what determine the condition that scripts can be loaded under. Microsoft has documented in detail what each of the policies is. In general, <code class="literal">AllSigned</code> requires that all of the scripts that run on the computer are signed using a code-signing certificate by a trusted certification authority. If this policy is set, PowerShell will not run unsigned scripts, even if you were the one to create them.</p><p><code class="literal">Restricted</code> is the default policy: commands can be run, but not scripts. <code class="literal">RemoteSigned</code> allows scripts that have been created on your own computer to run. Scripts that have been downloaded from the internet cannot be run.</p><p><code class="literal">Bypass</code> is similar to <code class="literal">Unrestricted</code>, however, it is used in specific scenarios, such as when PowerShell forms the basis of a certain application, and the application has its own security implementation.</p><p><code class="literal">Unrestricted</code> means that all scripts and commands can run after a simple confirmation. <code class="literal">Undefined</code> means that no policy has been defined for a particular scope. Follow the recipe to find the execution policy that is effective on the session, and change it to suit your needs.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec60"></a>Getting ready</h3></div></div></div><p>This recipe can only be run on Windows. If you're running a pure Linux environment, you cannot work with this recipe. You may run the commands, but you will see the Unrestricted policy set at all levels.</p><p>If you have a Windows computer to work with, you can proceed with this recipe, regardless of whether it has PowerShell or Windows PowerShell.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec61"></a>How to do it…</h3></div></div></div><p>Open a PowerShell window by running <code class="literal">pwsh</code> or <code class="literal">powershell</code>. The <code class="literal">pwsh</code> command calls PowerShell, and <code class="literal">powershell</code> calls Windows PowerShell.</p><p>Windows PowerShell comes preinstalled on all modern Windows operating systems; PowerShell, on the other hand, has to be installed. Note that all of the current PowerShell cmdlets will run on Windows PowerShell as well:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>First, run the <code class="literal">Get-Command</code> cmdlet to find out how to work with execution policies:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Get-Command -Noun Execution*</strong></span></pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/05653024-31ce-407c-b846-343bbcf93996.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Now, let's get help on running the cmdlet:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Get-Help Get-ExecutionPolicy</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>We want to know the execution policy set on the machine. Therefore, we will run the following code:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Get-ExecutionPolicy</strong></span></pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/f3a35450-b90f-40a0-9e47-6042e92650de.png" /></div><p>This shows that the execution policy is currently effective on the current PowerShell session.</p><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>To list out the policies set at various scopes, run the following command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Get-ExecutionPolicy -List</strong></span></pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/bcadd887-c28d-486d-8a44-501183d33c09.png" /></div><p>We can see that the policy is only set at the <code class="literal">LocalMachine</code> level, and that it is set as <code class="literal">RemoteSigned</code>, which is the same as what is reflected in the previous step. The policy at the <code class="literal">LocalUser</code> and the <code class="literal">Process</code> scopes is <code class="literal">Undefined</code>, which made the session pick the execution policy from <code class="literal">LocalMachine</code>.</p><p>Now, let's set the execution policy for the <span>local</span><a id="id326093079" class="indexterm"></a> machine to be <code class="literal">Undefined</code> and see what our session picks up.</p><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>For this to work, close the current PowerShell session and open a new session as the administrator.</li><li>Next, run the following command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Get-Help Set-ExecutionPolicy</strong></span></pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/ecd75b49-53ab-4736-a036-da9b2b3316d3.png" /></div><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>The help document shows that the value of the <code class="literal">ExecutionPolicy</code> parameter is mandatory, and that <code class="literal">Undefined</code> is one of the valid values it will accept. We want to set the policy at the <code class="literal">LocalMachine</code> scope, and so we will use the following code:</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note25"></a>Note</h3><p>You will need to launch PowerShell (either Core or Windows) with elevated privileges to set the policy at the <code class="literal">LocalMachine</code> level.</p></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Set-ExecutionPolicy -ExecutionPolicy Undefined -Scope LocalMachine</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>Now, list the execution policies at the various scopes:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Get-ExecutionPolicy -List</strong></span></pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/a6c48d84-aa1c-44c8-b915-7f6b1d75d715.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Now, let's check the currently effective execution policy:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Get-ExecutionPolicy</strong></span></pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/6093f070-b4ba-4bee-b23f-6fc03f7fbad2.png" /></div><p> </p><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>Finally, let's set the execution policy back to how it was before we began the recipe. You may want to change the policy to suit your needs, based on what authority you have on the computer:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Set-ExecutionPolicy RemoteSigned -Scope LocalMachine</strong></span></pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec62"></a>How it works…</h3></div></div></div><p>Execution policies are nothing but conditions that are set on the system to avoid accidental script runs. They work at different scopes.</p><p>There are three scopes in PowerShell, as we have already stated. The <code class="literal">LocalSystem</code> scope is at the end of the chain. Right above it is the <code class="literal">CurrentUser</code> scope. At the top is the <code class="literal">Process</code> scope. The level of precedence is <code class="literal">Process</code> &gt; <code class="literal">CurrentUser</code> &gt; <code class="literal">LocalMachine</code>. Therefore, if any policy other than <code class="literal">Undefined</code> is set at the <code class="literal">Process</code> scope, the session will use the policy that's currently set on the process. In case it is <code class="literal">Undefined</code>, it <span>will</span><a id="id326311942" class="indexterm"></a> look for the policy set on the <code class="literal">CurrrentUser</code> scope. If <code class="literal">CurrentUser</code> has the policy marked as <code class="literal">Undefined</code> as well, the session will apply the policy that was applied at the <code class="literal">LocalMachine</code> level. If <code class="literal">LocalMachine</code> has <code class="literal">Undefined</code> set, the session will pick the <code class="literal">Default</code> policy, which is based on what PowerShell has defined as the policy, which may vary based on the version of your operating system. On Windows 2016, for instance, the default policy is <code class="literal">RemoteSigned</code>.</p><p>The policies set at the <code class="literal">CurrentUser</code> and <code class="literal">LocalMachine</code> levels are stored in the Windows Registry. The policy set on the Process scope is stored in the ephemeral environment variable, that is, <code class="literal">$env:PSExecutionPolicyPreference</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec63"></a>See also</h3></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span>About_Execution_Policies</span><a id="id326312036" class="indexterm"></a> (<a class="ulink" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-6" target="_blank">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-6</a>)</li></ul></div></div></div>