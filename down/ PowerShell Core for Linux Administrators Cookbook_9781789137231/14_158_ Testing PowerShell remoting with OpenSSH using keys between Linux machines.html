<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch14lvl1sec154"></a>Testing PowerShell remoting with OpenSSH using keys between Linux machines</h2></div></div><hr /></div><p>In this recipe, you'll look at how you can <span><span>configure</span><a id="id326207906" class="indexterm"></a> SSH to allow logins to a remote system</span> using <span>cryptographic key files between two Linux machines.</span></p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch14lvl2sec394"></a>Getting ready</h3></div></div></div><p><span>On the remote system, you</span><span>need to ensure that the SSH server package is installed.</span><span>I'll do that here with <code class="literal">apt install OpenSSH-server</code>.</span><span>And just like that, our system</span><span>is able to host SSH connections. However,</span><span> there are a few things we need to look at</span><span>before we use SSH.</span></p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch14lvl2sec395"></a>How to do it…</h3></div></div></div><p>Let's dive deep into the steps to connect to a remote Linux (Ubuntu) machine from another Linux machine (CentOS):</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p><span>On the CentOS Linux machine, check whether the SSH service is running or not. To do that, use the <code class="literal">systemctl</code> command:</span></p></li></ol></div><pre class="programlisting"><span class="strong"><strong><span># systemctl status sshd</span></strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Next, <span>check the firewall setting. By default, port 22 is open to allow inbound traffic:</span></li></ol></div><pre class="programlisting"><span><span class="strong"><strong># ufw status</strong></span>
</span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>To generate a key-pair, run the <code class="literal">ssh-keygen</code> command and save the keys to the default location:</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note84"></a>Note</h3><p>The passphrase is left blank, but this is not a recommended practice. Use the Linux SSH native command <code class="literal">ssh-keygen</code> to generate keys.</p></div><pre class="programlisting"><span class="strong"><strong>PS&gt; ssh-keygen</strong></span>
Generating public/private rsa key pair.
Enter file in which to save the key (/home/packpub/.ssh/id_rsa): 
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /home/packpub/.ssh/id_rsa.
Your public key has been saved in /home/packpub/.ssh/id_rsa.pub.
The key fingerprint is:
4a:a9:ca:63:85:b1:b2:f9:39:61:05:ef:1a:b8:e2:fd packpub@localhost.localdomain
The key's randomart image is:
+--[ RSA 2048]----+
| |
| . |

| o |
| . o . |
| . * o S |
|o * oo . |
| * =. . |
|=.*o |
|o+=+.E |
+-----------------+</pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>To copy the public key to the remote machine (Ubuntu -10.2.6.68), run the following command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; ssh-copy-id prashant@10.2.6.68</strong></span>
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
prashant@10.2.6.68's password: 

Number of key(s) added: 1

Now try logging into the machine, with: "ssh 'prashant@10.2.6.68'"
and check to make sure that only the key(s) you wanted were added.

<span class="strong"><strong>PS&gt; Enter-PSSession -HostName 10.2.6.68 -UserName prashant </strong></span>
<span class="strong"><strong>[10.2.6.68]: PS&gt; </strong></span></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip85"></a>Note</h3><p>Note: <code class="literal">ssh-copy-id</code> and <code class="literal">ssh-keygen</code> are Linux SSH native commands that are used in conjunction with PowerShell OpenSSH remoting.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>To take a look at the local <code class="literal">know_hosts</code> file, run the following command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>$ cat ~/.ssh/known_hosts</strong></span></pre><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Test the connection using a public key and run a few simple cmdlets on the remote machine:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Enter-PSSession -HostName 10.2.6.68 -UserName prashant </strong></span>
<span class="strong"><strong>[10.2.6.68]: PS&gt; $IsLinux</strong></span>
<span class="strong"><strong>True</strong></span>
<span class="strong"><strong>[10.2.6.68]: PS&gt; cat /etc/lsb-release</strong></span>
<span class="strong"><strong>[10.2.6.68]: PS&gt; Get-Process|Sort-Object CPU -Descending| Select-Obejct -First 5</strong></span>

</pre><p>This results in the following output:</p><div class="mediaobject"><img src="/graphics/9781789137231/graphics/000aa33c-57bc-4720-a854-5d06d10eed39.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch14lvl2sec396"></a>How it works…</h3></div></div></div><p><span>A key-pair is made up of two files: a private key file that <span>a user keeps and a public key that is stored</span><span>on the remote server. On using the SSH protocol,</span><span>the <span>user</span><a id="id325906065" class="indexterm"></a> tries to establish the connection between server and client with the</span><span>exchange key information to determine if</span><span>the user is allowed to log on.</span></span></p><p> </p><p><span>Let's take a look at the way we can generate a key-pair</span> using a tool <span>called SSH-keygen.</span><span>It offers a lot of different options for changing</span><span>the encryption algorithm, but in this case, the default values are used to generate a key-pair.</span></p><p><span>First, I'm asked where I want to save the key.</span><span>The tool suggests the hidden <code class="literal">.ssh</code> folder</span><span>in my <code class="literal">home</code> folder, under the name <code class="literal">id_RSA</code>.</span><span>This is the default, but you can set any name you like.</span><span>The SSH tool knows to look for a key here,</span><span>so keeping it named like this can save a little bit of time.</span></p><p><span>On running the <code class="literal">ssh-copy-id</code> command, two things happen.</span> <span>First, the local public key is copied across</span> <span>the network to the remote machine and stored</span> <span>in the user's <code class="literal">authorized_keys</code> file. S</span>econd, the fingerprint of the remote machine is<span> stored in the local user's <code class="literal">known_hosts</code> file.</span></p><p>After verifying every piece of the configuration, you will see that the test connections are successful.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch14lvl2sec397"></a>There's more…</h3></div></div></div><p>To enable port 22 on an Ubuntu machine, type in the following code:</p><pre class="programlisting"><span class="strong"><strong><span># ufw allow 22/tcp
# systemctl restart ufw
# ufw enable</span></strong></span></pre><p>In Ubuntu, you can check the firewall settings by using <code class="literal">ufw status</code> to check whether it's active or not. If it's inactive, add a rule to allow port 22 access, that is, <code class="literal">sudo ufw allow 22/tcp</code>, and restart the firewall with <code class="literal">systemctl restart ufw</code>. Now, enable the firewall with <code class="literal">sudo ufw enable</code> and check its status.</p></div></div>