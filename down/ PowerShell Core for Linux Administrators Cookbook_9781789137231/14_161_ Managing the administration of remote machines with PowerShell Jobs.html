<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch14lvl1sec157"></a>Managing the administration of remote machines with PowerShell Jobs</h2></div></div><hr /></div><p>In this recipe, you'll find out how to <span>manage</span><a id="id325892137" class="indexterm"></a> multiple servers using PowerShell remoting, and using PowerShell jobs. <span>PowerShell provides an interface that takes a command or the <span>script</span><a id="id325885502" class="indexterm"></a></span> <span>and runs them in the background.</span> PowerShell can run several different tasks simultaneously<span> and is able</span><span>to retrieve results.</span></p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch14lvl2sec405"></a>Getting ready</h3></div></div></div><p>Since you will be working with multiple servers and you are going to be sending multiple commands to the same remote machine, it is better to create a remote session and assign it to a variable. It is a much more efficient way to manage remote connections.</p><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch14lvl2sec406"></a>How to do it…</h3></div></div></div><p>When you start a PowerShell background or remote job, the job starts in two modes: background and remote. However, the results do not appear immediately. Instead, the command returns an object that represents the background or remote job. </p><p>Let's look at a few simple examples to understand how PowerShell Jobs work:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>To create a background job, run the <code class="literal">Start-job</code> cmdlet, followed by a <code class="literal">scriptblock</code> parameter:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; start-job -ScriptBlock { Get-Process}</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>To create a remote job, run <code class="literal">Invoke-Command</code> with the <code class="literal">-asjob</code> parameter:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; $session=New-PSSession -HostName hdf01 -UserName ssh-test</strong></span>
<span class="strong"><strong>$job=Invoke-Command -Session $session -ScriptBlock {Get-Process | Select-Object -First 5} -AsJob</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>To list the jobs, run the <code class="literal">Get-Job</code> command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Get-Job</strong></span>

Id Name PSJobTypeName State HasMoreData Location Command
-- ---- ------------- ----- ----------- -------- -------
22 Job22 RemoteJob Completed False hdf01 Get-Process | Select-O...
24 Job24 BackgroundJob Completed True localhost dir</pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>To create a local job on the remote machine, run the following command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; $j=Invoke-Command -Session $session -ScriptBlock {Start-Job -ScriptBlock {Get-Process}}</strong></span>
<span class="strong"><strong>PS&gt;  Enter-PSSession -Session $session</strong></span>
<span class="strong"><strong>[hdf01]: PS&gt; Get-Job</strong></span>

Id Name PSJobTypeName State HasMoreData Location Command
-- ---- ------------- ----- ----------- -------- -------
1 Job1 BackgroundJob Completed True localhost Get-Process | Select-O...</pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>To get the results of the remote job, run the <code class="literal">Receive-Job</code> command:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt;  Get-Job</strong></span>

Id Name PSJobTypeName State HasMoreData Location Command
-- ---- ------------- ----- ----------- -------- -------
42 Job42 RemoteJob Completed True hdf01 Get-Process | Select-O...

#Passing job name 'Job42' as a parameter to Recieve-Job cmdlet

<span class="strong"><strong>PS&gt; Receive-Job -Name job42</strong></span>

 NPM(K) PM(M) WS(M) CPU(s) Id SI ProcessName PSComputerName
 ------ ----- ----- ------ -- -- ----------- --------------
      8 1.41 1.29 0.00 1992 0 armsvc hdf01
     47 34.38 40.13 0.00 3048 0 CcmExec hdf01
      9 1.55 1.85 0.00 2020 0 CdfSvc hdf01
     16 5.38 1.93 0.00 1816 0 CmRcService hdf01
     21 18.34 1.12 0.00 2540 1 Code hdf01

# You can also pass job id 

<span class="strong"><strong>PS&gt; Receive-Job -id 42</strong></span>

 NPM(K) PM(M) WS(M) CPU(s) Id SI ProcessName PSComputerName
 ------ ----- ----- ------ -- -- ----------- --------------
      8 1.41 1.29 0.00 1992 0 armsvc hdf01
     47 34.38 40.13 0.00 3048 0 CcmExec hdf01
      9 1.55 1.85 0.00 2020 0 CdfSvc hdf01
     16 5.38 1.93 0.00 1816 0 CmRcService hdf01
     21 18.34 1.12 0.00 2540 1 Code hdf01</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch14lvl2sec407"></a>How it works…</h3></div></div></div><p>The <code class="literal">Start-Job</code> cmdlet starts a normal background job. The remote connection is handled within the job script block. The script block runs as a separate PowerShell process. The remote connection is managed by <code class="literal">Get-Process</code>, so it is destroyed when the data is returned. Note that the location says <code class="literal">localhost</code>, which means that the job is running locally.</p><p>In the second job, you're using <code class="literal">Invoke-Command</code> to run the command and control the connection to the remote machine. <code class="literal">Invoke-Command</code> uses standard PowerShell remoting for connectivity to remote machines. The <code class="literal">–AsJob</code> parameter brings the PowerShell job engine into play. Note that, this time, the <code class="literal">PSJobTypeName</code> is <code class="literal">RemoteJob</code> and that the location is <code class="literal">hdf01</code> (the remote machine).</p><p>The big difference is where the job runs. By using <code class="literal">Start-Job</code>, it runs locally and the code in the script block handles the connectivity. By using <code class="literal">Invoke-Command</code>, the job runs on the remote machine, but the results come back to the local machine.</p><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch14lvl2sec408"></a>There's more…</h3></div></div></div><p>To remove all of the jobs, run the following command:</p><pre class="programlisting"><span class="strong"><strong>PS&gt; Get-Job | Remove-Job</strong></span></pre></div></div>