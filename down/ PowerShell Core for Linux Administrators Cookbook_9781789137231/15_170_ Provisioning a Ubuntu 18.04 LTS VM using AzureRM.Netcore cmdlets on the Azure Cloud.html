<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch15lvl1sec165"></a>Provisioning a Ubuntu 18.04 LTS VM using AzureRM.Netcore cmdlets on the Azure Cloud</h2></div></div><hr /></div><p>In this recipe, we'll <span>discuss</span><a id="id325892298" class="indexterm"></a> the steps required to <span>build</span><a id="id325892290" class="indexterm"></a> an Ubuntu 18.04 virtual machine on Azure, using the <code class="literal">AzureRm.Netcore</code> cmdlets.</p><p>This activity involves the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Setting up a Resource Group and a Resource</li><li>Creating a Storage Account</li><li>Setting up a virtual network</li><li>Configuring the network interface</li><li>Configuring the virtual machine</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Setting up storage </li><li>Connecting to the VM</li></ol></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec430"></a>Getting ready</h3></div></div></div><p>To get ready for setting up a VM using <code class="literal">AzureRm.Netcore</code> cmdlets, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Open a Terminal.</li><li>Launch PowerShell.</li><li>Load the <code class="literal">AzureRM.Netcore</code> module.</li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec431"></a>How to do it…</h3></div></div></div><p>In this example, a virtual machine has been created with the name <code class="literal">myVM</code> and is running the latest version of Ubuntu:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Create a connection with Azure using the <code class="literal">Login-AzureRmAccount</code> cmdlet. Next, authenticate the device by following the instructions provided:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Login-AzureRmAccount</strong></span></pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/55a27344-a49b-4653-9204-78d6748ffa8e.png" /></div><p></p><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Create a resource group with the <code class="literal">New-AzureRmResourceGroup</code> cmdlet:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; $ResourceGroup = 'packpub-demo'</strong></span>
<span class="strong"><strong>PS&gt; $Location = 'East US'</strong></span>
<span class="strong"><strong>PS&gt; New-AzureRmResourceGroup -Name $ResourceGroup -Location $Location</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Create a storage account with the <code class="literal">New-AzureRmStorageAccount</code> cmdlet:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; $StorageAcctName = 'packpubstorage' </strong></span>
<span class="strong"><strong>PS&gt; New-AzureRmStorageAccount -Name $StorageAcctName -ResourceGroupName $ResourceGroup -Type Standard_LRS -Location $Location </strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>To set up and configure a virtual network, follow these commands:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; $VNet = 'packtpub-vnet'</strong></span>
<span class="strong"><strong>PS&gt; $Subnet = New-AzureRmVirtualNetworkSubnetConfig -Name FrontendSubnet -AddressPrefix 10.0.1.0/24</strong></span>

<span class="strong"><strong>PS&gt; $VNet = New-AzureRmVirtualNetwork -Name $VNet -ResourceGroupName $ResourceGroup -Location $Location -AddressPrefix 10.0.0.0/16 -Subnet $Subnet</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li> Set up a network interface for the Ubuntu Linux machine using the subnet ID:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; $NicName = 'vm-nic'</strong></span>
<span class="strong"><strong>PS&gt; $Ip = New-AzureRmPublicIpAddress -Name $NicName -ResourceGroupName $ResourceGroup -Location $Location -AllocationMethod Dynamic</strong></span>
<span class="strong"><strong>PS&gt; $Nic = New-AzureRmNetworkInterface -Name $NicName -ResourceGroupName $ResourceGroup -Location $Location -SubnetId $VNet.Subnets[0].Id -PublicIpAddressId $Ip.Id</strong></span></pre><p> </p><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Configure the virtual machine:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; $VmName = 'ubuntu-packtpub'</strong></span>
<span class="strong"><strong>PS&gt; $Vm = New-AzureRmVMConfig -VMName $VmName -VMSize 'Basic_A1'</strong></span>
<span class="strong"><strong>PS&gt; $cred=Get-Credential</strong></span>

PowerShell credential request
Enter your credentials.
User: PacktPubLinux@gmail.com
Password for user PacktPubLinux@gmail.com: *******
<span class="strong"><strong>PS&gt; $Vm = Set-AzureRmVMOperatingSystem -VM $Vm -Linux -ComputerName $VmName -Credential $Cred</strong></span></pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/3f9147a4-8fe4-4add-8e6b-b3ca4e33126a.png" /></div><p></p><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>Get the VM images. The <code class="literal">Get-AzureRmVMImage*</code> cmdlets are used to search the marketplace for images. These cmdlets help find the publisher, offer, SKU, and optionally a version of the specific image:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Get-AzureRmVMImagePublisher -Location $Location
PS&gt; Get-AzureRmVMImageOffer -Location $Location -PublisherName 'Canonical' 
PS&gt; Get-AzureRmVMImageSku -Location $Location -PublisherName 'Canonical' -Offer 'UbuntuServer'</strong></span></pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/25b524fd-ca7d-4b85-a1e7-f1a92848fb25.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>Set up the <span>image</span><a id="id326436923" class="indexterm"></a> source and add network configuration:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; $Vm = Set-AzureRmVMSourceImage -VM $Vm -PublisherName 'Canonical' -Offer 'UbuntuServer' -Skus '18.04-LTS' -Version 'latest'</strong></span>
<span class="strong"><strong>PS&gt; $Vm = Add-AzureRmVMNetworkInterface -VM $Vm -Id $Nic.Id</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Configure the disk <span class="strong"><strong>URI (Uniform Resource Identifier):</strong></span></li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; $DiskName = 'ub-disk-packtpub'</strong></span>
<span class="strong"><strong>PS&gt; $StorageAccount = Get-AzureRmStorageAccount -ResourceGroupName $ResourceGroup -Name $StorageAcctName</strong></span>
<span class="strong"><strong>PS&gt; $OsDiskUri = $StorageAccount.PrimaryEndpoints.Blob.ToString()+'vhds/'+$DiskName+'.vhd' </strong></span>
<span class="strong"><strong>PS&gt; $OsDiskUri</strong></span>
<span class="strong"><strong>https://packtpubstorageacct.blob.core.windows.net/vhds/ub-disk-packtpub.vhd</strong></span>
<span class="strong"><strong>PS&gt; $Vm = Set-AzureRmVMOSDisk -VM $Vm -Name $Diskname -VhdUri $OsDiskuri -CreateOption FromImage</strong></span></pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/85cd0b51-81b2-41e9-8c1e-9017749bee8b.png" /></div><p></p><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>Deploy the VM with a specific image. The command may take a while to complete:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; New-AzureRmVM -ResourceGroupName $resourceGroup -Location $location -VM $vm</strong></span>

RequestId IsSuccessStatusCode StatusCode ReasonPhrase
--------- ------------------- ---------- ------------
                         True OK OK</pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/a0601e95-9fb4-4e78-a8da-1be87041c0e3.png" /></div><p></p><div class="orderedlist"><ol class="orderedlist arabic" start="11" type="1"><li>To get the assigned public IP address of VM, use the <code class="literal">Get-AzureRMPublicIPAddress</code> cmdlet:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Get-AzureRmPublicIpAddress -ResourceGroupName $ResourceGroup</strong></span></pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/f17f9dcd-524b-44e5-b793-bc286cb9cf47.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="12" type="1"><li>Note down the IP address.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="13" type="1"><li>Open a new Terminal and connect to the newly created VM using SSH. Use <span>the</span><a id="id326493077" class="indexterm"></a> password that you used for your Azure account:</li></ol></div><pre class="programlisting"><span class="strong"><strong>$ ssh PacktPubLinux@gmail.com@168.62.42.54</strong></span>
PacktPubLinux@gmail.com@168.62.42.54's password: 
Welcome to Ubuntu 18.04 LTS (GNU/Linux 4.15.0-1013-azure x86_64)
-
-
-
<span class="strong"><strong>PacktPubLinux@gmail.com@ubuntu-packtpub:~$</strong></span></pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/d062ac06-d3b6-470b-adf9-540e37371452.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec432"></a>How it works…</h3></div></div></div><p>The primary point to note here is the Resource Group. A Resource Group in Azure is a logical container that contains assets, which could be anything that Azure offers: virtual disks, virtual machines, virtual networks, and so on. The usual practice is to group all of the resources that are related into a single Resource Group. For this demo, we created a resource group called <code class="literal">packtpub-demo</code>, in the <code class="literal">East US</code> region, using the <code class="literal">New-AzureRmResourceGroup</code> cmdlet. The location and the name are specified when creating the Resource Group.</p><p>The rest of the flow is straightforward. The next step is to create a Storage Account using <code class="literal">New-AzureRmStorageAccount</code>. While a Resource Group can contain several kinds of assets, a Storage Account contains storage-related assets, such as blobs (or binary large object), disks, or tables. Storage Accounts have types, the choices being Standard and Premium. We will choose Standard, and along with that, choose the replication as well: Locally Redundant Storage.</p><p>Next, we configure the virtual network with subnetting by using <code class="literal">New-AzureRmVirtualNetworkSubnetConfig</code> and <code class="literal">New-AzureRmVirtualNetwork</code>. Then, we create a dynamic IP configuration using <code class="literal">New-AzureRmPublicIpAddress</code>, create an NIC (<code class="literal">New-AzureRmNetworkInterface</code>), and assign the dynamic IP address to it, within the subnet.</p><p>Finally, we choose to build the virtual machine. We set the name and the size (<code class="literal">New-AzureRmVMConfig</code>), and then we set the credentials and operating system (<code class="literal">Set-AzureRmVMOperatingSystem</code>). We look for VM images (<code class="literal">Get-AzureRmVMImageSku</code>), set up the image source, and add the network configuration to the virtual machine (<code class="literal">Add-AzureRmVMNetworkInterface</code>). We configure the disk and create the string that will identify the disk in our resource group (this string must be a complete URI). We then tie in all of the disk-related configuration together using <code class="literal">Set-AzureRmVMOSDisk</code> and attach the image to it to build an OS disk. Finally, we tie all of the bits together and deploy the virtual machine using <code class="literal">New-AzureRmVM</code>.</p><p>We find the public IP address for the virtual machine using <code class="literal">Get-AzureRmPublicIpAddress</code> and make an SSH connection to it.</p><p>The one question that must be nagging some of us is why we use variables when we can simply pass the values when necessary. The reason for this is that variables facilitate not remembering arbitrary names and values. They offer the flexibility of simply using names. As you will discover in the <span class="emphasis"><em>There's more…</em></span> section of this recipe, they simplify calling more commands.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec433"></a>There's more…</h3></div></div></div><p>The <code class="literal">Remove-AzureRmResourceGroup</code> cmdlet removes the specified resource group and all of the resources contained within it. To clean up the deployment, run the following cmdlet:</p><pre class="programlisting"><span class="strong"><strong>PS&gt; <span>Remove-AzureRmResourceGroup</span><span> -Name </span>$ResourceGroup</strong></span></pre></div></div>