<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch15lvl1sec169"></a>PowerShell remoting to Azure VM using OpenSSH</h2></div></div><hr /></div><p>In this recipe, we will look at how to connect to a remote <span>Linux</span><a id="id325892152" class="indexterm"></a> VM using PowerShell remoting. OpenSSH, which <span>originated</span><a id="id325892144" class="indexterm"></a> as part of the OpenBSD project and is commonly used across the BSD, Linux, macOS, and Unix ecosystems, can now be used from PowerShell in Cloud Shell as well.</p><p>Let's try something different this time: go to Mobile First and use the Azure app on your phone to launch the Cloud Shell:</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note88"></a>Note</h3><p>At the time of writing this book, the PowerShell console you get on phones is Windows PowerShell (5.1) and not PowerShell. The remoting commands, as well as the protocols, are different on Windows PowerShell and PowerShell, and so we only use the mobile console to run the Linux commands.</p></div><p></p><div class="mediaobject"><img src="/graphics/9781789137231/graphics/c04da00d-cc15-466a-81f6-2d2473e657dd.png" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec446"></a>Getting ready</h3></div></div></div><p>You will need a Linux computer set up on the cloud for this recipe. Go ahead and run the script that we wrote in the <span class="emphasis"><em>Provisioning a Linux VM using a PowerShell Script</em></span> recipe to create all of the necessary resources, along with an Ubuntu VM.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec447"></a>How to do it…</h3></div></div></div><p>Let's walk through the following steps to enable PowerShell remoting using OpenSSH:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li> SSH into the Ubuntu machine:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; ssh prashanth@40.117.213.80</strong></span></pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/677cdd11-7d24-4cee-9ae8-9fabf4507d56.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>Register and download the PowerShell package repository:</li></ol></div><pre class="programlisting"># Import the public repository GPG keys
<span class="strong"><strong>$ curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -</strong></span>

# Register the Microsoft Ubuntu repository
<span class="strong"><strong>$ sudo curl -o /etc/apt/sources.list.d/microsoft.list https://packages.microsoft.com/config/ubuntu/18.04/prod.list</strong></span>

# Update the list of products
<span class="strong"><strong>$ sudo apt-get update</strong></span></pre><p> </p><div class="mediaobject"><img src="/graphics/9781789137231/graphics/98febbd6-6212-4b3b-ba0f-9e6e23364265.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Install PowerShell:</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip89"></a>Note</h3><p>At the time of writing this book, PowerShell Preview is available for Ubuntu 18.04, hence the installation of <code class="literal">powershell-preview</code> and the use of <code class="literal">pwsh-preview</code> in the subsystem entry. PowerShell Preview should be considered the bleeding edge and must be tested before implementation outside of the lab environment.</p></div><pre class="programlisting">$ # Install PowerShell
<span class="strong"><strong>$ sudo apt install -y pwsh</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Install the OpenSSH-Client <span>and</span><a id="id326089545" class="indexterm"></a> OpenSSH-Server packages. In Ubuntu 18.04 LTS, these packages are present by default:</li></ol></div><pre class="programlisting"><span class="strong"><strong>$ sudo apt install openssh-client openssh-server</strong></span></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note90"></a>Note</h3><p>The aforementioned steps are not needed in most modern distributions.</p></div><p></p><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Copy the <code class="literal">/etc/ssh/sshd_config</code> configuration file to <code class="literal">/etc/ssh/sshd_config_bakfile</code>:</li></ol></div><pre class="programlisting"><span class="strong"><strong>$ sudo -s</strong></span>
<span class="strong"><strong># cp /etc/ssh/sshd_config /etc/ssh/sshd_config_bakfile</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="6" type="1"><li>Edit the <code class="literal">/etc/ssh/sshd_config</code> configuration file <span>using</span><a id="id326090160" class="indexterm"></a> an editor of your choice:</li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip91"></a>Note</h3><p>Switch to a more conventional Terminal emulator to do this; editing configuration files using <code class="literal">vi</code> on your phone may not be the best of experiences. </p></div><pre class="programlisting"><span class="strong"><strong># vi /etc/ssh/sshd_config</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="7" type="1"><li>Ensure that password authentication is enabled; look for the following line:</li></ol></div><pre class="programlisting">PasswordAuthentication yes</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip92"></a>Note</h3><p>SSH support multiple ways to authenticate users using the <code class="literal">sshd_config</code> file. The most common method is using a login and a password but you can also authenticate user with a login and a public key. If you set <code class="literal">PasswordAuthentication</code> to <code class="literal">no</code>, you will no longer be able to use a login and password to authenticate. And you must use a login and public key.</p></div><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>Add an entry for the PowerShell subsystem into the file. If you're using <code class="literal">pwsh</code> instead of <code class="literal">pwsh-preview</code>, change the entry accordingly:</li></ol></div><pre class="programlisting">Subsystem powershell /usr/bin/pwsh -sshs -NoLogo -NoProfile</pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/437419af-32ab-48f4-98f1-530c7d261b14.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="9" type="1"><li>Restart the SSH service using the <code class="literal">systemctl</code> command:</li></ol></div><pre class="programlisting"><span class="strong"><strong># systemctl restart ssh</strong></span></pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/011207c3-fc0c-4dd6-8cf6-84c73e4f3685.png" /></div><p></p><div class="orderedlist"><ol class="orderedlist arabic" start="10" type="1"><li>Now the Linux machine on Azure is ready to accept PowerShell Remote connections (in other words, without using the <code class="literal">ssh</code> command). Exit all SSH sessions you opened on the virtual machine (your phone, your desktop, and so on).</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="11" type="1"><li>Open the Cloud Shell console and assign the IP address of your Linux virtual machine to a variable. If you so desire, you can use PowerShell on your local Linux computer instead:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; $VmIp = (Get-AzureRmPublicIpAddress -ResourceGroupName packtpub-rg).IpAddress</strong></span>
<span class="strong"><strong>PS&gt; New-PSSession -HostName $VmIp -UserName prashanth</strong></span></pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/520176bd-4215-4e97-bc54-fba436689017.png" /></div><div class="orderedlist"><ol class="orderedlist arabic" start="12" type="1"><li>A connection has been built to the Linux machine. Next, get the session details using <code class="literal">Get-PSSession</code>:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; Get-PSSession</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="13" type="1"><li>Query the remote machine using <code class="literal">Invoke-Command</code>:</li></ol></div><pre class="programlisting"><span class="strong"><strong>PS&gt; $Session = Get-PSSession</strong></span>
<span class="strong"><strong>PS&gt; Invoke-Command -Session $Session -ScriptBlock { Get-Process }</strong></span>

</pre><div class="mediaobject"><img src="/graphics/9781789137231/graphics/2ff9d45e-41cb-473d-8477-039762ecaa73.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch15lvl2sec448"></a>How it works…</h3></div></div></div><p>The easiest way to test remoting is to try it out on a single machine. In this recipe, we did the following:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>We connected to the newly provisioned Ubuntu machine <span>using</span><a id="id326250440" class="indexterm"></a> the familiar <code class="literal">ssh</code> tool</li><li>We installed PowerShell on it</li><li>We then verified that the <code class="literal">ssh-server</code> and the <code class="literal">ssh-client</code> packages were installed on the Ubuntu machine</li><li>We configured SSH in a way that it would facilitate PowerShell remoting</li><li>We launched a PowerShell remote session using the same SSH protocol</li></ol></div><p>We enabled password-based authentication in this recipe. Optionally, you can enable key-based authentication as well. PowerShell remote sessions are established over the SSH protocol and, once a session is connected to the remote PowerShell, the console will behave as if you are on the remote server. All of the commands that are run within the session will also run on the remote computer. This way, you can invoke commands <span>and</span><a id="id326250478" class="indexterm"></a> script blocks remotely.</p></div></div>