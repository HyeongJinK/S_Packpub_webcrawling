<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec31"></a>Working with vector data in R</h2></div></div><hr /></div><p>Due to the contribution of <span>many</span><a id="id325302954" class="indexterm"></a> developers in the form of R packages, we can now use R as a spatial analysis tool to perform different operations on vector data. To master these, we need to know the basics of spatial data manipulation in R. Some R packages, such as <code class="literal">sp</code>, <code class="literal">rgdal</code>, and <code class="literal">rgeos</code>, will be used frequently to accomplish these tasks.</p><p> </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec26"></a>Combining shapefiles in R</h3></div></div></div><p>In this example, we'll <span>merge</span><a id="id325937500" class="indexterm"></a> two shapefiles of two districts called Dhaka and Gazipur. Now, <code class="literal">BGD_adm3_data_re</code> is a shapefile containing all of the districts of Bangladesh as separate polygons. We have the shapefile of Dhaka but not of Gazipur, so we'll create a shapefile of Gazipur before we start merging these two shapefiles. Let's load the required packages now:</p><pre class="programlisting">library(sp)
library(rgdal)
library(maptools)</pre><p>Now, we'll load the <code class="literal">BGD_adm3_data_re.shp</code> shapefile; as we have seen before, the <code class="literal">NAME_3</code> field contains the names of the districts. We'll use this field to select the feature that corresponds to the Gazipur district:</p><pre class="programlisting">map_bd = readOGR("F:/Hands-on-Geospatial-Analysis-Using-R-and-QGIS/Chapter04/Data","BGD_adm3_data_re")
# make a logical vector that has true value only for Gazipur
isGazipur = map_bd$NAME_3 == "Gazipur"
# This will select only those feature(s) whose value equals to "Gazipur"
gazipur = map_bd[isGazipur, ]
# Now, save it using writeOGR()
writeOGR(obj=gazipur, dsn="F:/Hands-on-Geospatial-Analysis-Using-R-and-QGIS/Chapter04/Data", layer="gazipur", driver="ESRI Shapefile")</pre><p>Now, import this new shapefile and plot it:</p><pre class="programlisting"># Now import gazipur.shp and plot it
gazipur = readOGR("F:/Hands-on-Geospatial-Analysis-Using-R-and-QGIS/Chapter04/Data","gazipur")
plot(gazipur, col = "blue")</pre><p>This will show the map of Gazipur as follows:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/0dd161c7-e88f-4852-83b7-fe5e7110d897.png" /></div><p>Now, add the map of Dhaka.</p><p>We can merge these two <code class="literal">SpatialPolygonsDataFrame</code> shapefiles using the <code class="literal">union()</code> function of the <code class="literal">raster</code> package:</p><pre class="programlisting"># Let's merge these two shapefiles
dhaka_gazipur = raster::union(dhaka, gazipur)
str(dhaka_gazipur, max.level = 2)
plot(dhaka_gazipur)</pre><p>This will result in the following merged map. We can see that these two maps are now merged into a new one:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/b940fd4c-3f43-44b3-9bcf-fd9fec1d404c.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec27"></a>Clipping in R</h3></div></div></div><p>Here, we'll learn how to <span>clip</span><a id="id326002952" class="indexterm"></a> spatial points to a shapefile. For example, we have many data points over many places of Bangladesh and we want to clip these data points to the shapefile of Dhaka, named <code class="literal">dhaka.shp</code>. In this example, we have a CSV file, <code class="literal">arbitrary_indicator.csv</code>, which has two columns, <code class="literal">lon</code> and <code class="literal">lat</code>, containing the longitude and latitude of these points, respectively. To achieve our objective, we can take the following steps.</p><p>First, read the CSV file and then use <code class="literal">coordinates()</code> to turn it into a spatial object that R can recognize. In doing so, indicate the longitude and latitude fields followed by <code class="literal">~</code>:</p><pre class="programlisting">points = read.csv("F:/Hands-on Geospatial-Analysis-Using-R-and- QGIS/Chapter04/Data/arbitrary_indicator.csv")
coordinates(points) = ~ lon + lat
summary(points)</pre><p>Now we can see that <code class="literal">points</code> is a <code class="literal">SpatialPoints</code> data type:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/f515f597-47f4-4c8b-bc6d-338126984562.png" /></div><p>Let's now check how these points look by plotting them on the map of Bangladesh:</p><pre class="programlisting">plot(map_bd, col = "gray", border = "blue", main = "Map of Bangladesh with arbitrary points plotted")
plot(points, add = TRUE, pch=19, cex=.4, col = "red")</pre><p> </p><p>The points plotted on the map of Bangladesh appear as follows:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/23f1aa8b-912f-44b1-b45a-bc8cc65b5417.png" /></div><p>Now, we need do two things: first, make the two layers have the same projection system. Assign the projection of the <code class="literal">dhaka</code> layer to <code class="literal">points</code><code class="literal">SpatialPoints</code>. Now, subset <code class="literal">points</code> by the <code class="literal">dhaka</code> layer and that's it, clipping is done in R. We use <code class="literal">proj4string()</code> to get the projection system of <code class="literal">points</code> and use <code class="literal">CRS()</code> to set it to the projection of <code class="literal">dhaka</code>, which we get again by using <code class="literal">proj4string()</code>:</p><pre class="programlisting">proj4string(points) &lt;- CRS(proj4string(dhaka))
points_dhaka &lt;- points[dhaka, ]</pre><p>By adding <code class="literal">points_dhaka</code> on the Dhaka map, we can <span>see</span><a id="id326087794" class="indexterm"></a> that points have now been clipped to the Dhaka map:</p><pre class="programlisting">plot(dhaka, col = "gray", border = "blue", main = "Points clipped to the map of Dhaka")
plot(points_dhaka, add = TRUE, pch=20, cex=1, col = "red")</pre><p>We now see that we have been successful in clipping these points to the shapefile of Dhaka:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/c3e1d68e-a729-4f78-8728-587c6d4cead8.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec28"></a>Difference in R</h3></div></div></div><p>Now, what if we only want the <span>points</span><a id="id326087826" class="indexterm"></a> that are outside Dhaka? That's what the <code class="literal">gDifference()</code> function under the <code class="literal">rgeos</code> package in R helps us to do. With <code class="literal">gDifference()</code>, we provide <code class="literal">points</code> first, followed by <code class="literal">dhaka</code>. This is very straightforward to implement:</p><pre class="programlisting">not_dhaka = gDifference(points, dhaka)
plot(map_bd, col = "gray", border = "blue", main = "All the points except Dhaka's are plotted")
plot(not_dhaka, add = TRUE, pch=20, cex=0.4, col = "red")</pre><p>Here, we have plotted this new <code class="literal">SpatialLines</code><code class="literal">not_dhaka</code> on the map of Bangladesh to see whether we have been able to keep all of the points except Dhaka's (which are at the middle part of the map of Bangladesh). We'll get a result similar to the following:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/c9fe3601-c886-460d-b985-de5a4417aee3.png" /></div><p>It looks like there are no points on Dhaka, but to be sure, let's also plot these points on the map of Dhaka. If we had been successful in finding the difference, no points should be shown now:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/4dda9057-c23a-4a2c-a99d-a5ebc74620f4.png" /></div><p>Now we see points around Dhaka and not on Dhaka, as we anticipated, so our work with difference went smoothly.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec29"></a>Area calculation in R</h3></div></div></div><p>We can very easily calculate the <span>area</span><a id="id326088987" class="indexterm"></a> of all of the features of a polygon using <code class="literal">gArea()</code>. We use this to calculate the area, in square kilometers, of different districts in Bangladesh. First, we transform the area using <code class="literal">spTransform()</code> to <span class="strong"><strong>Universal Transverse Mercator</strong></span> (<span class="strong"><strong>UTM</strong></span>) with units in meters; this will make it easy to have the <span>area</span><a id="id326105293" class="indexterm"></a> in square kilometers. We'll use the reprojected map of Bangladesh with UTM in <code class="literal">gArea()</code> and use an additional argument, <code class="literal">byid = TRUE</code>, so that it computes the area for all unique features (in this case, districts). Now, as <code class="literal">gArea()</code> returns in square units of whatever unit in which the map was fetched, we'll get square meters returned by <code class="literal">gArea()</code>. So, divide this by 1,000 square to get square kilometers:</p><pre class="programlisting">bd_utm$area = gArea(bd_utm, byid = TRUE) / 1000^2
# We can now check that a new column data with area for each feature has bee created
head(bd_utm@data)</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note9"></a>Note</h3><p>For more details on using functions such as <code class="literal">gUnion()</code>, the <code class="literal">gDistance()</code> function of the <code class="literal">rgeos</code> package and on vector data manipulation, you can read Chapter 5 of<span class="emphasis"><em>Learning R for Geospatial Analysis</em></span>, by Michael Dorman. For more functionalities provided by QGIS for vector data processing, you can read Chapter 4 of<span class="emphasis"><em>Mastering QGIS</em></span>, by Menke et al.</p></div></div></div>