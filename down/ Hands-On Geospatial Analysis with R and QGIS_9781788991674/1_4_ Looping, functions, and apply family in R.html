<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch01lvl1sec12"></a>Looping, functions, and apply family in R</h2></div></div><hr /></div><p>Looping allows us to do repetitive <span>task</span><a id="id325752289" class="indexterm"></a> in a couple of lines of code, saving us much effort and time. Functions allow us to write a block of instructions that could be modified to <span>work</span><a id="id325752297" class="indexterm"></a> according to the way they are being called. Combining the power of looping, functions, and apply family in R allows us to loop through the <span>elements</span><a id="id325752306" class="indexterm"></a> of a data type, or similar, and apply a function or use a block of instructions on each of these.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec7"></a>Looping in R</h3></div></div></div><p>Suppose we want to loop <span>through</span><a id="id325752321" class="indexterm"></a> all the values of the <code class="literal">aug_price</code> column inside <code class="literal">all_prices4</code> and square them and return them. We can do so in the following way:</p><pre class="programlisting">jan = all_prices4$jan_price
for(price injan){
    print(price^2)
}</pre><p>This prints a square of all the prices in January as follows:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/313bff4c-b7ec-44e8-b92a-ef88ce93d968.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec8"></a>Functions in R</h3></div></div></div><p>We can also achieve the previous <span>result</span><a id="id325756077" class="indexterm"></a> by using a function. Let's name this function <code class="literal">square</code>:</p><pre class="programlisting">square = function(data){
    for(price in data){
       print(price^2)
    }
}</pre><p>Now call the function as follows:</p><pre class="programlisting">square(all_prices4$jan_price)</pre><p>The following output also shows the squared price of <code class="literal">jan_price</code>:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/77212dc4-22c9-43ce-86a7-d09243e53ca9.png" /></div><p>Now suppose we want to have the ability to take elements to any power, not just <code class="literal">square</code>. We can attain it by making a little tweak to the function:</p><pre class="programlisting">power_function = function(data, power){
  for(price in data){
    print(price^power)
  }
}</pre><p>Now suppose we want to take the power of <code class="literal">4</code> for the price in June, we can do the following:</p><pre class="programlisting">power_function(all_prices4$june_price, 4)</pre><p>We can see that the <code class="literal">june_price</code> column is taken to the fourth power as follows:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/01eea5f7-adae-4b4f-949d-617131c08c92.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec9"></a>Apply family – lapply, sapply, apply, tapply</h3></div></div></div><p>We discuss apply family here, which <span>allows</span><a id="id325756211" class="indexterm"></a> us not to have to write loops and reduces our workload. We will discuss four functions under this family: apply, lapply, sapply, and tapply.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl3sec6"></a>apply</h4></div></div></div><p><code class="literal">apply</code> works on arrays or matrices <span>and</span><a id="id325756228" class="indexterm"></a> gives us an easier way to compute something row-wise or column-wise. For the <code class="literal">apply()</code> function, this row- or column-wise consideration is denoted by a margin. The <code class="literal">apply()</code> function takes the following form: <code class="literal">apply(data, margin, function)</code>. This data has to be an array or a matrix, and the margin can be either <code class="literal">1</code> or <code class="literal">2</code>, where <code class="literal">1</code> stands for a row-wise operation and <code class="literal">2</code> stands for a column-wise operation. We will work with the matrix <code class="literal">all_prices</code>, which has the following structure:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/28553483-20cd-44a2-a1b6-dad216e1988b.png" /></div><p>Here, we have a record of prices of three different items in three different months (January, March, and June), where a row represents the prices of an item in three different months and a column represents the prices of three different items in any single month. Now, if we want to know which item's price fluctuated most over these three months, we would have to compute a standard deviation row-wise for each row. We can do this very easily using <code class="literal">margin = 1</code> in <code class="literal">apply()</code>.</p><pre class="programlisting">apply(all_prices, 1, sd)</pre><p>We can see the standard deviation for these three items as follows:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/a10044f9-8311-4fcc-a04c-2635905f64ca.png" /></div><p>Now suppose we want to know the month-wise total cost of all three items. As every column corresponds to different months, we can apply <code class="literal">apply()</code> with <code class="literal">margin = 2</code> and a function mean to achieve this:</p><pre class="programlisting">apply(all_prices, 2, sum)</pre><p>This gives the sum for all three months in a vector:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/1ecc9eb0-3487-4811-b87a-5154209b8ab4.png" /></div><p>We see that the total prices <span>were</span><a id="id325759355" class="indexterm"></a> the highest in June (the third column), totaling <code class="literal">78</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note4"></a>Note</h3><p>Note that the function that we use inside <code class="literal">apply()</code> has to be without <code class="literal">()</code>. We just need to write its name without parentheses. </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl3sec7"></a>lapply</h4></div></div></div><p>In the previously mentioned <code class="literal">power_function()</code> function, we had to use a <code class="literal">for</code> loop to loop through all the values of the <code class="literal">june_price</code> column of the <code class="literal">all_prices4</code> data frame. <code class="literal">lapply</code> allows us to <span>define</span><a id="id325761184" class="indexterm"></a> a function (or use an already existing function) over all the elements of a list or vector and it returns a list. Let's redefine <code class="literal">power_function()</code> to allow for the computation of different powers on elements and then use <code class="literal">lapply</code> to loop through each element of a list or vector and take the power of each of these elements on every iteration of the loop. <code class="literal">lapply()</code> has the following format:</p><pre class="programlisting">lapply(data, function, arguments_of_the_function)</pre><pre class="programlisting">power_function2 = function(data, power){
    data^power
}
lapply(all_prices4$june_price, power_function2, 4)</pre><p>As we saw in the last output, all the prices of <code class="literal">june_price</code> are taken to the fourth power and are returned as a list:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/3d38db92-963b-4f51-9d5d-c8b06eaa43dd.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip5"></a>Note</h3><p>What we get in return is a list. We can use <code class="literal">unlist()</code> to get a simple vector for our convenience.</p></div><pre class="programlisting">unlist(lapply(all_prices4$june_price, power_function2, 4))</pre><p>Now we are returned the fourth power of the <code class="literal">june_price</code> column as a vector.</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/5495ebc4-00bd-40bb-a31a-92a36de800b5.png" /></div><p>Now we will again work with a <span class="strong"><strong>combined</strong></span> array, which has the prices of different items in three different months each for 2017 and 2018. Do you remember the structure of it? It looked like this:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/7f5ac3e5-cd7b-4459-8c7a-b2379e790764.png" /></div><p>Here, the first matrix <span>corresponds</span><a id="id326017886" class="indexterm"></a> to prices for 2017 and the second matrix corresponds to 2018. We will now recreate this array to become a list of matrices in the following way:</p><pre class="programlisting">combined2 = list(matrix(c(jan_2018, mar_2018, june_2018), nrow = 3), 
 matrix(c(jan_2017, mar_2017, june_2017), nrow = 3))
combined2</pre><p>This returns us the following list of matrices:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/94b24c60-32e8-41af-8c5e-1476e37b7a37.png" /></div><p> </p><p>Now, if we want the prices for March for both 2017 and 2018, we can use <code class="literal">lapply()</code> in the following way:</p><pre class="programlisting">lapply(combined2, "[", 2,)</pre><div class="mediaobject"><img src="/graphics/9781788991674/graphics/5ffbb734-5875-474f-adac-557814132a69.png" /></div><p>So, what this has <span>done</span><a id="id326017938" class="indexterm"></a> is selected the second row from each list:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/772dad6c-0c0e-4606-a340-a51212dece69.png" /></div><p>Now we can modify it further to select a column, row, or any element according to our needs.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note6"></a>Note</h3><p><code class="literal">lapply()</code> can be used with data frames, lists, and vectors.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl3sec8"></a>sapply</h4></div></div></div><p>What we have got by using <code class="literal">unlist(lapply(data, function, arguments_of_the_function))</code> can be obtained <span>simply</span><a id="id326324051" class="indexterm"></a> by using <code class="literal">sapply(data, function, arguments_of_the_function)</code>.</p><pre class="programlisting">sapply(all_prices4$june_price, power_function2, 4)</pre><p> </p><p>We are returned with a vector again as follows:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/86f4efbd-0204-4763-9a67-81f7e73cf4c7.png" /></div><p>Now let's go back to the example of the <code class="literal">all_prices3</code> data frame. We can see this from the <span>screenshot</span><a id="id326324088" class="indexterm"></a> that follows:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/fc8300b7-58d2-4568-a668-40e04c03cac5.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl3sec9"></a>tapply</h4></div></div></div><p>Now, suppose instead of prices for 2018 only, we have prices for these items for 2017, 2016, and 2015 as well. This new <span>data</span><a id="id326324114" class="indexterm"></a> frame is defined as follows:</p><pre class="programlisting">all_prices = data.frame(items = rep(c("potato", "rice", "oil"), 4), 
            jan_price = c(10, 20, 30, 10, 18, 25, 9, 17, 24, 9, 19,27),
            mar_price = c(11, 22, 33, 13, 25, 32, 12, 21, 33, 15, 27,39),
            june_price = c(20, 25, 33, 21, 24, 40, 17, 22, 27, 13, 18,23)
                                                   )
all_prices</pre><p>The output for the preceding lines of code can be seen as follows:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/92495909-0a80-4e1f-8624-4e3e8410a783.png" /></div><p>Now suppose we want to take the mean price of different items for very March in all years. We can do this by using <code class="literal">tapply(numerical_variable, categorical_variable, function)</code>. So, we will need to convert the items column of the <code class="literal">all_prices</code> data frame to a categorical variable to take the mean price.</p><pre class="programlisting">tapply(all_prices$mar_price, factor(all_prices$items), mean)</pre><p>This gives us a mean March price for <code class="literal">oil</code>, <code class="literal">potato</code>, and <code class="literal">rice</code> in all years, as follows:</p><div class="mediaobject"><img src="/graphics/9781788991674/graphics/b6a5be43-c098-4dd4-9b6b-e15a4a3827e2.png" /></div><p>Note the use of <code class="literal">factor()</code> to convert the <span>items</span><a id="id326325000" class="indexterm"></a> column to a factor variable.</p><p>There are other <code class="literal">apply</code> functions, but that's it for now, folks. We will introduce new functions as and when it will be necessary as we proceed to new chapters for geospatial analysis.</p><p>To install a new package, we need to write <code class="literal">install.packages("package_name")</code>, and to use any package, we need to write <code class="literal">load.packages("package_name")</code>.</p></div></div></div>