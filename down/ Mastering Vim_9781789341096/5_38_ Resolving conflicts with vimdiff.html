<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec41"></a>Resolving conflicts with vimdiff</h2></div></div><hr /></div><p>Often, during the development, you'll find yourself needing to compare some files—be it <span>comparing</span><a id="id325898530" class="indexterm"></a> different output or versions of a file, or dealing with merge conflicts. Vim provides <code class="literal">vimdiff</code>, a standalone binary that excels at file comparison operations.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec42"></a>Comparing two files</h3></div></div></div><p>Using <code class="literal">vimdiff</code> to compare two files is <span>fairly</span><a id="id325881477" class="indexterm"></a> simple. Let's look at two files in <code class="literal">animal_farm/</code> : <code class="literal">animals/cat.py</code> and <code class="literal">animals/dog.py</code>. We'd like to know what's different between the two.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip95"></a>Note</h3><p>The files from this example are available from <a class="ulink" href="https://github.com/PacktPublishing/Mastering-Vim/tree/master/Chapter05/animal_farm" target="_blank">https://github.com/PacktPublishing/Mastering-Vim/tree/master/Chapter05/animal_farm</a>
move to previous line you can follow this section with any similar but somewhat different files.</p></div><p>Open the files with <code class="literal">vimdiff</code>:</p><pre class="programlisting"><span class="strong"><strong>$ vimdiff animals/cat.py animals/dog.py</strong></span></pre><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p>You will be greeted to the following screen (how colorful the screen is will depend on your <code class="literal">colorscheme</code>):</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/acc7a2f7-ea97-48ec-99d4-3d8290af5af1.png" /></div><p>You can see <code class="literal">animals/cat.py</code> open in a split on the left and <code class="literal">animals/dog.py</code> in a split on the right. Different lines are highlighted in one color, and different characters are highlighted in another color.</p><p>You can navigate from one change to another by using <code class="literal">]c</code> to move forward and <code class="literal">[c</code> to move backward.</p><p>You can pull and push changes from one file to another:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">do</code> or <code class="literal">:diffget</code> (<span class="strong"><strong>do</strong></span> stands for diff obtain) will move the change to the active window</li><li style="list-style-type: disc"><code class="literal">dp</code> or <code class="literal">:diffput</code> (stands for diff put) will push the change from the active window
</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip96"></a>Note</h3><p>If you want to copy the content of a whole file from one file into another, you can use the <code class="literal">:%diffget</code> or <code class="literal">:%diffput</code> commands<span class="emphasis"><em>.</em></span></p></div><p>For example, if you want to pull <code class="literal">self.kind = 'cat'</code> from <code class="literal">animals/cat.py</code> into <code class="literal">animals/dog.py</code>, you would navigate to the desired change using <code class="literal">]c</code> and press do to obtain it. The highlighting will disappear and the <code class="literal">animals/dog.py</code> buffer will now contain the desired change:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/f2a220df-fed3-456b-a374-bdc75307255c.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note97"></a>Note</h3><p><code class="literal">vimdiff</code> automatically updates the highlighting if you're using <code class="literal">:diffget</code> and <code class="literal">:diffput</code> to move changes between files. If you edit the files manually, you'll have to update the highlighting by running <code class="literal">:diffupdate</code>, or <code class="literal">:diffu</code> for short.</p></div><p>You can diff as many files as you'd like at the same time, however, you won't be able to use the <code class="literal">do</code> and <code class="literal">dp</code> shortcuts. Let's open three files with <code class="literal">vimdiff</code>:</p><pre class="programlisting"><span class="strong"><strong>$ vimdiff animals/cat.py animals/cat.py animals/sheep.py</strong></span></pre><p> </p><p> </p><p> </p><p> </p><p>You can <span>see</span><a id="id325844894" class="indexterm"></a> all three side by side:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/255bd2b2-4701-426e-b3fc-6541924afab4.png" /></div><p>Since there are multiple buffers now, you'll have to specify which buffer you would  like to get the changes to or from. Both <code class="literal">:diffget</code> and <code class="literal">:diffput</code> (which can be shortened to <code class="literal">:diffg</code> and <code class="literal">:diffp</code>) take the buffer specification argument, which can either be a buffer number (look it up from <code class="literal">:ls!</code>) or a partial buffer name.</p><p>For example, while in the <code class="literal">animals/dog.py</code> window, you can push the change under the cursor into <code class="literal">animals/sheep.py</code> by running the following:</p><pre class="programlisting"><span class="strong"><strong>:diffput sheep
</strong></span></pre><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p>The desired line will be <span>pushed</span><a id="id325845006" class="indexterm"></a> into the <code class="literal">animals/sheep.py</code> buffer:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/3fe1957f-db40-4387-a409-8605cc41d72d.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip98"></a>Note</h3><p>If you work with <code class="literal">vimdiff</code> a lot, don't forget to take the time to make useful aliases and key bindings as demonstrated in <a class="link" href="#" linkend="ch03">Chapter 3,</a><span class="emphasis"><em>Follow the Leader!</em></span> The default ones are rather long.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec43"></a>vimdiff and Git</h3></div></div></div><p>Using <code class="literal">vimdiff</code> as a Git <span>merge</span><a id="id325850097" class="indexterm"></a> tool can be pretty confusing—Vim bombards you with four windows, a number of keywords, and not a lot of explanation.</p><p> </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec23"></a>git config</h4></div></div></div><p>First and foremost, configure <span>Git</span><a id="id325853086" class="indexterm"></a> to use <code class="literal">vimdiff</code> as a merge tool:</p><pre class="programlisting"><span class="strong"><strong>$ git config --global merge.tool vimdiff</strong></span>
<span class="strong"><strong>$ git config --global merge.conflictstyle diff3</strong></span>
<span class="strong"><strong>$ git config --global mergetool.prompt false</strong></span></pre><p>This will set Git as the default merge tool, will display a common ancestor while merging, and will disable the prompt asking you to open <code class="literal">vimdiff</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec24"></a>Creating merge conflict</h4></div></div></div><p>Let's use the <code class="literal">animal_farm/</code> repository we <span>initialized</span><a id="id325868194" class="indexterm"></a> earlier in this chapter as an example (or you can follow this with your own example if you have a merge conflict you're trying to resolve):</p><pre class="programlisting"><span class="strong"><strong>$ cd animal_farm/</strong></span></pre><p>We'll create an additional branch which will conflict with the master branch. In the <code class="literal">animal-create</code> branch, we'll rename a <code class="literal">make_animal</code> method to create-animal while, in the master branch, we'll change it to <code class="literal">build_animal</code>. The order of operations is important in creating the conflict, so you may want to follow closely.</p><p>We can start by creating a branch and editing <code class="literal">animal_farm.py</code>:</p><pre class="programlisting"><span class="strong"><strong>$ git checkout -b create-animal
$ vim animal_farm.py</strong></span></pre><p>Let's replace our <code class="literal">make_animal</code> method with <code class="literal">create_animal</code>:</p><pre class="programlisting">...
def <span class="strong"><strong>create_animal</strong></span>(kind):
...
    animal_farm.add_animal(<span class="strong"><strong>create_animal</strong></span>(animal_kind))
...</pre><p>Now, commit the change:</p><pre class="programlisting"><span class="strong"><strong>$ git add animal_farm.py</strong></span>
<span class="strong"><strong>$ git commit -m "Rename make_animal to create_animal"
</strong></span></pre><p> </p><p> </p><p> </p><p> </p><p>We can now switch back to the master branch to make our next set of changes:</p><pre class="programlisting"><span class="strong"><strong>$ git checkout master</strong></span>
<span class="strong"><strong>$ vim animal_farm.py</strong></span></pre><p>This time, we'll replace <code class="literal">make_animal</code> with <code class="literal">build_animal</code>:</p><pre class="programlisting">...
def <span class="strong"><strong>build_animal</strong></span>(kind):
...
    animal_farm.add_animal(<span class="strong"><strong>build_animal</strong></span>(animal_kind))
...</pre><p>Commit the file:</p><pre class="programlisting"><span class="strong"><strong>$ git add animal_converter.py</strong></span>
<span class="strong"><strong>$ git commit -m "Rename make_animal to build_animal"</strong></span></pre><p>It's time to merge the <code class="literal">create-animal</code> branch with <code class="literal">master</code>:</p><pre class="programlisting"><span class="strong"><strong>$ git merge create-animal</strong></span></pre><p>Uh-oh! A merge conflict:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/87635e97-2b5d-467d-b7c6-8430a809dbdf.png" /></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec25"></a>Resolving a merge conflict</h4></div></div></div><p>Start the <span>Git</span><a id="id326342234" class="indexterm"></a> merge tool (which is <code class="literal">vimdiff</code>, since we configured it earlier):</p><pre class="programlisting"><span class="strong"><strong>$ git mergetool</strong></span></pre><p> </p><p> </p><p> </p><p> </p><p>You will be treated to quite a light show, with four windows and a lot of colors thrown at you:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/73a1583c-bc9b-43ae-8801-8ef455e9677b.png" /></div><p>It's okay to be scared, but it's not as terrifying as it looks.</p><p>Local changes (master branch in this case) are in the upper-left window, followed by a closest common ancestor and the <code class="literal">create-animal</code> branch in the upper-right corner. The result of the merge is in the bottom window.</p><p>To get into more detail, from left to right, top to bottom:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><strong class="userinput"><code>LOCAL</code></strong>:<span class="strong"><strong> </strong></span>This is file from the current branch (or whatever you're merging into)</li><li style="list-style-type: disc"><strong class="userinput"><code>BASE</code></strong>:<span class="strong"><strong> </strong></span>The common ancestor—how the file looked before both changes took place</li><li style="list-style-type: disc"><strong class="userinput"><code>REMOTE</code></strong>: The file you are merging from another branch (<code class="literal">no-dogs</code> in this case)</li><li style="list-style-type: disc"><strong class="userinput"><code>MERGED</code></strong>: The merge result—this is what gets saved as output</li></ul></div><p> </p><p>In the <strong class="userinput"><code>MERGED</code></strong> window, you'll see conflict markers. You don't need to interact with them directly, but it's good to have a vague idea of what they mean. Conflict markers are identified by <code class="literal">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</code> and <code class="literal">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</code>:</p><pre class="programlisting">&lt;&lt;&lt;&lt;&lt;&lt;&lt; [LOCAL commit/branch]
[LOCAL change]
||||||| merged common ancestors
[BASE - closest common ancestor]
=======
[REMOTE change]
&gt;&gt;&gt;&gt;&gt;&gt;&gt; [REMOTE commit/branch]</pre><p>Since we have multiple files, simply running <code class="literal">do</code> (<code class="literal">:diffget</code>) or <code class="literal">dp</code> (<code class="literal">:diffput</code>) without arguments would not be enough.</p><p>Assuming you want to keep the<code class="literal">REMOTE</code>change (from the <code class="literal">create-animal</code> branch), move your cursor to the window with<code class="literal">MERGED</code>file (the one at the bottom). Now move the cursor to the <span>next</span><a id="id326481784" class="indexterm"></a> change (in addition to regular movement keys, you can use <code class="literal">]c</code>and<code class="literal">[c</code>to move by changes). Now execute the following:</p><pre class="programlisting"><span class="strong"><strong>:diffget REMOTE</strong></span></pre><p>This will get the change from the <code class="literal">REMOTE</code> file and place it into the <code class="literal">MERGED</code> file. You can shorten these commands:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Get a <code class="literal">REMOTE</code> change using <code class="literal">:diffg R</code></li><li style="list-style-type: disc">Get a <code class="literal">BASE</code> change using <code class="literal">:diffg B</code></li><li style="list-style-type: disc">Get a <code class="literal">LOCAL</code> change using <code class="literal">:diffg L</code></li></ul></div><p>Repeat for every conflict. Once you're done addressing the conflicts, save the <code class="literal">MERGED</code> file and exit <code class="literal">vimdiff</code> (running <code class="literal">:wqa</code> would be the fastest way) to complete the merge (or move on to the next file if you have more conflicts).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip99"></a>Note</h3><p>Merge conflicts tend to leave <code class="literal">.orig</code> files in your working directory (for example, <code class="literal">animal_farm.py.orig</code>); feel free to discard those once you're done merging.</p></div><p>Don't forget to commit the merge results (<code class="literal">git commit -m "Fixed a pesky merge conflict"</code>) once you're done.</p><p> </p></div></div></div>