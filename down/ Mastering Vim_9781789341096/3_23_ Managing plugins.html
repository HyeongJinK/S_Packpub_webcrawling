<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec28"></a>Managing plugins</h2></div></div><hr /></div><p>You have already installed quite a few plugins so far, and the number will only keep going up, especially as you try to solve problems that are specific to whatever it is you're working on. Manually keeping plugins up to date requires quite a bit of work, but <span>luckily</span><a id="id326398573" class="indexterm"></a> there are plugin management solutions out there!</p><p>Plugin management becomes even more important if you often change or switch machines and have the need to keep multiple plugins updated.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note63"></a>Note</h3><p>For more tips on keeping Vim synced between multiple machines, see <a class="link" href="#" linkend="ch07">Chapter 7</a>, <span class="emphasis"><em>Making Vim Your Own</em></span>.</p></div><p>The plugin management landscape is ever changing, and there's no substitute for good old research when choosing a plugin manager. This chapter covers a few plugin managers that I've used throughout the years, which will hopefully be enough for you to base your own research on.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec26"></a>vim-plug</h3></div></div></div><p>The newest and the brightest in <span>plugin</span><a id="id326438001" class="indexterm"></a> management is vim-plug, a lightweight plugin that makes it easy to deal with a multitude of plugins. The plugin is available on GitHub at: <a class="ulink" href="https://github.com/junegunn/vim-plug" target="_blank">https://github.com/junegunn/vim-plug</a> (it has a rather friendly <code class="literal">README</code> file, but I've captured the gist of it in this section if you're feeling lazy).</p><p>There are some neat things about this plugin:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">It's lightweight and fits in a single file, allowing for some straightforward <span>installation</span><a id="id326438027" class="indexterm"></a> options</li><li style="list-style-type: disc">It supports parallel plugin load (if Vim is compiled with Python or Ruby enabled, which is true for all modern Vim setups)</li><li style="list-style-type: disc">It supports the lazy loading of most plugins, only invoking plugins for a particular command or a file type
</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip64"></a>Note</h3><p>In the previous chapter, you manually installed the plugins. This section provides a much better plugin experience, and you'll want to delete the plugins you downloaded manually. In order to do that, remove the manually added plugin directory (<code class="literal">rm -rf $HOME/.vim/pack</code> in Linux and <code class="literal">rmdir /s %USERPROFILE%\vimfiles\pack</code> in Windows).</p></div><p>Installing vim-plug <span>is</span><a id="id326450170" class="indexterm"></a> straightforward:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Fetch the plugin file from <a class="ulink" href="https://raw.github.com/junegunn/vim-plug/master/plug.vim" target="_blank">https://raw.github.com/junegunn/vim-plug/master/plug.vim</a>.</li><li>Save the file as <code class="literal">$HOME/.vim/autoload/plug.vim</code>.
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip65"></a>Note</h3><p>To fetch a single file from GitHub, you can use <code class="literal">curl</code> or <code class="literal">wget</code> on Linux or macOS, or just open the link in the browser, right-click, and choose <strong class="userinput"><code>Save as...</code></strong>. For instance, you could run the following <span>command to fetch the file in</span> Unix:<code class="literal">$ curl -fLo ~/.vim/autoload/plug.vim --create-dirs   https://raw.github.com/junegunn/vim-plug/master/plug.vim</code></p></div></li><li>Update your <code class="literal">.vimrc</code> file to include vim-plug initializers:
<pre class="programlisting">" Manage plugins with vim-plug.
call plug#begin()
call plug#end()</pre></li><li>Add some plugins between these two lines, using the last parts of the URL in GitHub (in &lt;username&gt;/&lt;repository&gt; format, for example scrooloose/nerdtree instead of <a class="ulink" href="https://github.com/scrooloose/nerdtree" target="_blank">https://github.com/scrooloose/nerdtree</a>) to identify the plugins:
<pre class="programlisting">" Manage plugins with vim-plug.
call plug#begin()

Plug 'scrooloose/nerdtree'
Plug 'tpope/vim-vinegar'
Plug 'ctrlpvim/ctrlp.vim'
Plug 'mileszs/ack.vim'
Plug 'easymotion/vim-easymotion'

call plug#end()</pre></li><li>Save your <code class="literal">.vimrc</code> file and reload it (<code class="literal">:w | source $MYVIMRC</code>) or restart Vim to apply the changes. Execute <code class="literal">:PlugInstall</code> to install the plugins.</li></ol></div><p>This will download the aforementioned plugins from GitHub:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/ee8b06f1-a4eb-4521-95d3-5eba9fb2c038.png" /></div><p> </p><p>There are two main commands you will use with vim-plug:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">:PlugUpdate</code> will update all of the plugins you have installed.</li><li style="list-style-type: disc"><code class="literal">:PlugClean</code> will delete the plugins you removed from your <code class="literal">.vimrc</code> file. If you don't run <code class="literal">:PlugClean</code>, the plugins you deactivated (by either commenting out or removing the relevant <code class="literal">Plug ...</code> line in your <code class="literal">.vimrc</code> file) will stay on <span>your</span><a id="id325978935" class="indexterm"></a> system.</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note66"></a>Note</h3><p>Running <code class="literal">:PlugUpdate</code> updates every plugin vim-plug manages besides itself. If you want to update vim-plug, you need to run <code class="literal">:PlugUpgrade</code> and reload your <code class="literal">.vimrc</code> file by either running <code class="literal">:source $MYVIMRC</code> or restarting Vim. </p></div><p>Lazy plugin loading is a useful tool to prevent plugins from slowing down Vim. The <code class="literal">Plug</code> directive supports optional parameters. For instance, if you wanted to load NERDTree when the <code class="literal">:NERDTreeToggle</code> command is called, you could use the <code class="literal">on</code> parameter:</p><pre class="programlisting">Plug <span><span>'</span>scrooloose/nerdtree<span>'</span></span>, { <span><span>'</span>on<span>'</span></span>:  <span><span>'</span>NERDTreeToggle<span>'</span></span> }</pre><p>If you wanted to only load a plugin for a particular file type, you could use the <code class="literal">for</code> parameter:</p><pre class="programlisting">Plug <span><span>'</span>junegunn/goyo.vim<span>'</span></span>, { <span><span>'</span>for<span>'</span></span>: <span><span>'</span>markdown<span>'</span></span> }</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip67"></a>Note</h3><p>Due to the way vim-plug is installed, its help pages are not available by default. If you'd like to be able to call <code class="literal">:help vim-plug</code>, add <code class="literal">Plug 'junegunn/vim-plug'</code> to a list of installed plugins and run <code class="literal">:PlugInstall</code>.</p></div><p>You can find the list of supported parameters in vim-plug's <code class="literal">README</code> file on GitHub at: <a class="ulink" href="https://github.com/junegunn/vim-plug" target="_blank">https://github.com/junegunn/vim-plug</a>.</p><p>If you only work on Linux or Mac machines (and Cygwin), you can add a following piece to your <code class="literal">.vimrc</code> file to install vim-plug whenever you transport your <code class="literal">.vimrc</code> file to a new machine:</p><pre class="programlisting"> " Install vim-plug if it's not already installed.
 if empty(glob('~/.vim/autoload/plug.vim'))
   silent !curl -fLo ~/.vim/autoload/plug.vim --create-dirs 
     \ https://raw.github.com/junegunn/vim-plug/master/plug.vim
   autocmd VimEnter * PlugInstall --sync | source $MYVIMRC
 endif

</pre><p>This will install vim-plug (and all the plugins you have listed) next time you open Vim.You can see a slightly longer solution that works for both Windows and Unix on my blog: <a class="ulink" href="https://www.rosipov.com/blog/cross-platform-vim-plug-setup" target="_blank">https://www.rosipov.com/blog/cross-platform-vim-plug-setup</a>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec27"></a>Honorable mentions</h3></div></div></div><p>There are many more plugin management alternatives to vim-plug. The following list is not in any <span>way</span><a id="id326012334" class="indexterm"></a> comprehensive, but highlights different styles of plugin management. Pick the one that's more suited to your taste, or maybe search the web for alternatives.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl3sec12"></a>Vundle</h4></div></div></div><p>Vundle is vim-plug's predecessor (and possibly an inspiration), which works along <span>similar</span><a id="id326025389" class="indexterm"></a> lines. Plugin installation is synchronous, and the plugin packs slightly <span>more</span><a id="id326025398" class="indexterm"></a> weight than vim-plug. One of the differentiating factors is the availability of plugin search; Vundle allows you to search for plugins straight from Vim. In addition, Vundle lets you test out the plugins before permanently installing them. Vundle and its installation instructions are available from GitHub at: <a class="ulink" href="https://github.com/VundleVim/Vundle.vim.git" target="_blank">https://github.com/VundleVim/Vundle.vim</a>.</p><p>Vundle works similar to vim-plug, with the <code class="literal">:PluginInstall</code>, <code class="literal">:PluginUpdate</code>, and <code class="literal">:PluginClean</code> commands <span>performing</span><a id="id326025422" class="indexterm"></a> the same functions.</p><p> </p><p>The search feature (possibly the most compelling argument to use Vundle) can be invoked by running <code class="literal">:PluginSearch &lt;string&gt;</code>. At the moment, Vundle only supports searching by plugin names. For example, let's look for a plugin that helps us manage making comments:</p><pre class="programlisting"><span class="strong"><strong>:PluginSearch comment</strong></span></pre><p>We'll get a list of potential matches in return:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/3e6bd4d9-a2f8-4e74-a098-2f5bc38748d0.png" /></div><p> </p><p>Hover your cursor over a small plugin that adds a few useful comment-related key bindings: <code class="literal">tComment</code>. Hit <code class="literal">i</code> (or execute <code class="literal">:PluginInstall</code>) with your cursor over it. The plugin is now immediately available in Vim, without any commitment. You can try using <code class="literal">tComment</code> by opening a file (say, your <code class="literal">.vimrc</code> file), and executing <code class="literal">gcc</code> to comment and uncomment the current line.</p><p>This will not install the plugin permanently, and to do so you would have to add the plugin to your <code class="literal">.vimrc</code> file.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl3sec13"></a>Do it yourself</h4></div></div></div><p>You could always decide to take the DIY route and implement your own solution for <span>storing</span><a id="id326026112" class="indexterm"></a> plugins. That's what we effectively did in the previous chapter, albeit with less bells and whistles.</p><p>Since most plugins are available on GitHub, a popular way of making sure that the plugins are up to date is installing them as Git submodules. If you're familiar with Git, you can initialize a repository in your <code class="literal">.vim</code> folder and install plugins as submodules.</p><p>Vim 8 introduced a native way to load plugins, by expecting the files to be in a directory tree under <code class="literal">.vim/pack</code>. Vim 8 expects the following structure of the files:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">.vim/pack/&lt;any-directory-name&gt;/opt/</code> is used for plugins you want to manually load</li><li style="list-style-type: disc"><code class="literal">.vim/pack/&lt;any-directory-name&gt;/start/</code> is used for plugins you always load</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note68"></a>Note</h3><p>If you're the curious type, you could learn more about how each individual plugin folder is structured in <a class="link" href="#" linkend="ch08">Chapter 8</a>, <span class="emphasis"><em>Transcending the Mundane with VimScript</em></span>.</p></div><p>You may want to use some explicit name for a directory under <code class="literal">.vim/pack/</code>. For instance, <code class="literal">plugins</code> might be a good choice.</p><p>You can use the <code class="literal">start/</code> directory for plugins that you always want to load.</p><p> </p><p>On the other hand, <code class="literal">opt/</code> only loads plugins when you execute <code class="literal">:packadd &lt;plugin-directory-name&gt;</code>. This lets you add <code class="literal">packadd</code> commands to your <code class="literal">.vimrc</code> file. Using the <code class="literal">opt/</code> and <code class="literal">packadd</code> commands lets you achieve plugin lazy-loading (just like vim-plug):</p><pre class="programlisting">" Load and run ack.vim plugin on :Ack command.
command! -nargs=* Ack :packadd ack.vim | Ack &lt;f-args&gt;
" Load an run Goyo plugin when opening Markdown files.
autocmd! filetype markdown packadd goyo.vim | Goyo</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note69"></a>Note</h3><p>If you decide to choose this route, do visit <a class="link" href="#" linkend="ch07">Chapter 7</a>, <span class="emphasis"><em>Making Vim Your Own</em></span>, which will cover some best practices when it comes to version controlling your Vim configuration.</p></div><p>In addition, you'll want to add the following two lines to your <code class="literal">.vimrc</code> file to load the documentation for all the plugins:</p><pre class="programlisting">packloadall           " Load all plugins.
silent! helptags ALL  " Load help for all plugins.</pre><p><code class="literal">packloadall</code> tells Vim to load every plugin in the <code class="literal">start/</code> directory (Vim automatically performs this step after <code class="literal">.vimrc</code> is loaded, but we want to call it earlier). <code class="literal">helptags ALL</code> loads all available help entries for our plugins, and the <code class="literal">silent!</code> prefix hides any output and errors you might receive when loading the help entries.</p><p>You can manage your plugins yourself (with some overhead) by using Git submodules to download the plugins and keep them up to date.</p><p>Initialize a Git repository in the <code class="literal">.vim</code> directory (a one-time step):</p><pre class="programlisting"><span class="strong"><strong>$ cd ~/.vim</strong></span>
<span class="strong"><strong>$ git init</strong></span></pre><p>Add a plugin as a submodule:</p><pre class="programlisting"><span class="strong"><strong>$ git submodule add</strong></span><span class="strong"><strong>https://github.com/scrooloose/nerdtree.git </strong></span><span class="strong"><strong>pack/plugins/start/nerdtree</strong></span>
<span class="strong"><strong>$ git commit -am "Add NERDTree plugin"</strong></span></pre><p>Now, every time you want to update your plugins, you can run the following:</p><pre class="programlisting"><span class="strong"><strong>$ git submodule update --recursive</strong></span>
<span class="strong"><strong>$ git commit -am "Update plugins"</strong></span></pre><p> </p><p> </p><p> </p><p> </p><p>To delete a plugin, remove the submodule with the following steps:</p><pre class="programlisting"><span class="strong"><strong>$ git submodule deinit -f -- pack/plugins/start/nerdtree</strong></span>
<span class="strong"><strong>$ rm -rf .git/modules/pack/plugins/start/nerdtree</strong></span>
<span class="strong"><strong>$ git rm -f pack/plugins/start/nerdtree</strong></span></pre><p>DIY is a great route to take if you're a tinkerer, a minimalist, or otherwise enjoy making your life harder than it needs to be.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl3sec14"></a>Pathogen</h4></div></div></div><p>This section is much more of a history lesson and a noteworthy mention.</p><p>By definition, Pathogen is a <code class="literal">runtimepath</code> manager and not a plugin manager. However, in practice, <code class="literal">runtimepath</code> manipulation translates into plugin management really well. After Vim 8.0, there's no <span>need</span><a id="id326167616" class="indexterm"></a> to manipulate <code class="literal">runtimepath</code> to install plugins. However, if you have to use Vim prior to 8.0 (and you don't want to use full-blown package managers), Pathogen might make your life noticeably easier.</p><p><span>Pathogen</span><a id="id326167971" class="indexterm"></a> was one of the earlier takes on plugin management and has heavily influenced the landscape of its successors. Many Vim users still use it today, but the influx of new adopters has stopped.</p><p><span>Pathogen</span><a id="id326167980" class="indexterm"></a> is available from GitHub at: <a class="ulink" href="https://github.com/tpope/vim-pathogen" target="_blank">https://github.com/tpope/vim-pathogen</a>.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec28"></a>Profiling slow plugins</h3></div></div></div><p>As you use Vim a lot, you might end up with numerous plugins installed. Sometimes, these <span>plugins</span><a id="id326168000" class="indexterm"></a> can cause Vim to become slow. Often, the culprit is a single unoptimized plugin, either due to the author's oversight or the unique way the plugin interacts with your system. Vim comes with built-in profiling support, which we'll learn to use.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl3sec15"></a>Profiling startup</h4></div></div></div><p>You can start <span>Vim</span><a id="id326168014" class="indexterm"></a> with a <code class="literal">--startuptime &lt;filename&gt;</code> flag, which will log every action Vim takes during startup into a file. For instance, here's how you write the startup log into <code class="literal">startuptime.log</code>:</p><pre class="programlisting"><span class="strong"><strong>$ vim --startuptime startuptime.log</strong></span></pre><p> </p><p> </p><p> </p><p> </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip70"></a>Note</h3><p>You can launch gvim in a similar manner with <code class="literal">gvim --startuptime startuptime.log</code>. The commands are the same in the Linux command line and in Windows <code class="literal">cmd.exe</code>.</p></div><p>Quit Vim, and open <code class="literal">startuptime.log</code>. You'll be greeted with something like this (I replaced sections of the file with <code class="literal">&lt;...&gt;</code> to make it easier to read):</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/59ab0e08-8b24-4b58-925b-a04fdfa64199.png" /></div><p> </p><p> </p><p> </p><p> </p><p> </p><p>In the preceding screenshot, you can see a set of timestamps (most in three columns), followed by an action measured by the timestamp. The timestamps are in milliseconds—1/1000 of a second. The first column indicates the number of milliseconds from starting Vim, while the last column indicates how long each action took.</p><p>It's the last column which is of interest to us. You'll be looking for any abnormalities in the file.</p><p>In our case, we don't have any particularly slow plugins, but for the sake of science, the slowest plugin we have installed is vim-unimpared (at 11 milliseconds—011.532). You'll have to get closer to 500 milliseconds (or half a second) for the plugin to have a noticeable effect on Vim startup times.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl3sec16"></a>Profiling specific actions</h4></div></div></div><p>If performing a particular action in <span>Vim</span><a id="id326168518" class="indexterm"></a> is slow, you can profile just a particular set of actions.</p><p>In this example, I created an obvious performance culprit. I downloaded the Python and Vim repositories from GitHub, and tried running the <code class="literal">:CtrlP</code> command that's provided by a CtrlP plugin (which we explored in <a class="link" href="#" linkend="ch02">Chapter 2</a>, <span class="emphasis"><em>Advanced Editing and Navigation</em></span>). <code class="literal">:CtrlP</code> will try to index all the files recursively starting at the current directory, which should be slow for such a large number of files.</p><p>Start Vim as usual, and execute the following set of commands:</p><pre class="programlisting"><span class="strong"><strong>:profile start profile.log</strong></span>
<span class="strong"><strong>:profile func *</strong></span>
<span class="strong"><strong>:profile file *</strong></span></pre><p>From now on, Vim will profile every action you'll perform. Run the slow command. In our case, let's run <code class="literal">:CtrlP</code> by pressing <span class="emphasis"><em>Ctrl</em></span> +<span class="emphasis"><em> p</em></span>. After the offending action has been performed, quit Vim (<code class="literal">:q</code>).</p><p> </p><p>Open <code class="literal">profile.log</code>, and you'll be greeted to something like this (you may want to have folds enabled with <code class="literal">set foldmethod=indent</code>, as the file is large and hard to navigate otherwise):</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/d704a293-7965-4ea8-ab3d-67824455783a.png" /></div><p>Scroll to the bottom of the file <code class="literal">(<span class="emphasis"><em>G</em></span>)</code> and you'll see a list of functions sorted by how long they took to execute:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/95cc164d-e732-4691-a98e-e8990b652c26.png" /></div><p>Many of the slowest functions are prefixed with <code class="literal">ctrlp#</code>, so it's becoming clear that CtrlP is likely to be the culprit of the slowness (and as we know—it is). If it is not explicitly obvious where the functions come from, we can search the file for the function name. For instance, <code class="literal">&lt;SNR&gt;29_GlobPath()</code> is responsible for nearly ~3.9 seconds of slowdown (hover over the function name and press <span class="emphasis"><em>*</em></span> to search for the word under the cursor):</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/e1771c0e-c9f9-4c95-b23f-19a8bdf43efa.png" /></div><p>As you can see by the number of CtrlP references, this function is likely <span>relate</span><a id="id326175466" class="indexterm"></a>d to the offending plugin.</p><p>If you were to try to profile real issue with Vim, the contents of <code class="literal">profile.log</code> could tell you which plugins are a likely cause of the slowdowns you are experiencing.</p><p> </p></div></div></div>