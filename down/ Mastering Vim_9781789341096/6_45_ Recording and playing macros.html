<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec47"></a>Recording and playing macros</h2></div></div><hr /></div><p>Macros are an extremely powerful tool <span>that</span><a id="id326292331" class="indexterm"></a> allow you to record and <span>replay</span><a id="id326292368" class="indexterm"></a> a set of actions.</p><p>Let's perform the same operation as before, using macros. We have the following code in <code class="literal">farm.py</code>:</p><pre class="programlisting">...
def act(self, target):
    for animal in self.animals:
        if animal.get_kind() == 'cat':
            print(animal.act(target, 'meows'))
        elif animal.get_kind() == 'dog':
            print(animal.act(target, 'barks'))
        elif animal.get_kind() == 'sheep':
            print(animal.act(target, 'baas'))
        else:
            print(animal.act(target, 'looks'))
...</pre><p>We'd like to reorder arguments in <code class="literal">animal.act</code> calls. Open <code class="literal">farm.py</code>, and move your cursor to the top of the file with <code class="literal">gg</code>:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/9f24c7ea-10e8-44c3-bd5f-70539a49184d.png" /></div><p>Enter macro recording mode using <code class="literal">q</code> followed by any register (let's pick <code class="literal">a</code>), as follows: <code class="literal">qa</code>. You'll see <code class="literal">recording @a</code> in a status line, which indicates that the macro is recording:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/63c71610-fe17-46c0-ab95-8e03015ea5e0.png" /></div><p>Every movement or edit you make <span>when</span><a id="id325545934" class="indexterm"></a> in macro mode will be repeated when you <span>replay</span><a id="id325545943" class="indexterm"></a> the macro later on. That's why it's important to be deliberate when recording macros, and try to consider replayability when moving or performing actions.</p><p>Let's navigate to the first instance by searching for <code class="literal">/animal.act</code>:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/f436d815-6219-4e00-a32a-d3d8db933ab0.png" /></div><p>We're searching (and not navigating by line numbers, for instance) to make it possible to apply the macro to the rest of the text.</p><p>Now, move your cursor to the word <code class="literal">target</code>. You can move by word (<code class="literal">4w</code>), or navigate to the opening parenthesis (<code class="literal">f(</code>) followed by moving one character to the right (<code class="literal">l</code>):</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/a96b410d-b16b-43a9-a703-e2182233193e.png" /></div><p> </p><p>Since we want to paste <code class="literal">target</code> later, let's copy it into a register. <code class="literal">"bdw</code> will delete the word target into the <code class="literal">b</code> register, as follows:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/4f6e8799-f857-4aad-beb4-6759d555d6b6.png" /></div><p>Now, let's delete the remaining comma (for this we don't need a special register, and we don't need to worry about overwriting <code class="literal">target</code> as it's been moved to its own register):</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/f3b7dcfa-ebee-4e24-b7a4-d084214c6166.png" /></div><p>Now navigate to the end of <code class="literal">meows</code> with <code class="literal">f'</code>:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/a567a69a-af22-466e-896a-0b2c82721d9f.png" /></div><p>Add the missing <span>comma</span><a id="id325633660" class="indexterm"></a> followed by a space: <code class="literal">a</code> (to <span>enter</span><a id="id325844894" class="indexterm"></a> insert after the cursor), <code class="literal">, </code>, followed by <span class="emphasis"><em>Esc</em></span>:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/601b5ba5-b062-42a0-8db2-127230e93f41.png" /></div><p>Now paste from the register <code class="literal">b</code>: <code class="literal">"bp</code>:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/55188fd8-50c6-4dc9-a983-809b9dfa6a90.png" /></div><p>Done! Hit<code class="literal">q</code>to finish recording the macro, you'll see that the<code class="literal">recording @a</code>line has disappeared.</p><p> </p><p>Fantastic! Now you can replay the macro using <code class="literal">@a</code>:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/2d42c227-5363-45e8-b5a6-e7bb58e033be.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip122"></a>Note</h3><p>A handy shortcut is <code class="literal">@@</code>. <code class="literal">@@</code> replays the last macro you ran.</p></div><p>You can repeat the macro multiple times by prefixing it with a number: <code class="literal">2@a</code>. However, if, for instance, you are searching as part of your macro, the search may wrap back to the beginning of the file and replay a macro on a portion of file you've already modified:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/fda0cc06-1a16-468d-80d5-d6b7c6a2ff63.png" /></div><p> </p><p>That's where working with macros can get messy. All macros do is record your actions and replay them back.</p><p>So, how can we make this macro not do this?</p><p>A macro stops executing if it encounters an error. If there are no patterns we're searching for below the cursor, Vim just looks for one above the cursor—without producing an error. So we just need to manually produce an error, to make sure the macro doesn't continue running when it doesn't have to.</p><p>In this particular case, we can tell search to stop wrapping back around, and, instead, produce an error when reaching the end of the file:</p><pre class="programlisting"><span class="strong"><strong>:set nowrapscan</strong></span></pre><p>If you replay the macro, you'll now get an error:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/2cbc17ec-13e3-4d06-9acc-1922c8e4e134.png" /></div><p>Now you can safely execute this macro any number of times.</p><p>Due to errors like these, or if you're not confident <span>about</span><a id="id325850106" class="indexterm"></a> the matches, sometimes it's useful to <span>carry</span><a id="id325853085" class="indexterm"></a> out a separate search. It might make sense to search for an occurrence outside the macro (such as <code class="literal">/animal.act</code>), and then play the macro if you decide that the change is warranted.</p><p>Then, you can run <code class="literal">n</code> to search for the next search occurrence of <code class="literal">animal.act</code>, decide whether you'd like to make changes, and run the macro again with <code class="literal">@a</code> or <code class="literal">@@</code>.</p><p> </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec57"></a>Editing macros</h3></div></div></div><p>Macros are stored in registers (the same ones <span>used</span><a id="id325865735" class="indexterm"></a> by yank and paste operations). You can view the contents of all your registers by executing <code class="literal">:reg</code>:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/bc36e79b-1420-4037-9c95-eaebe72aad7c.png" /></div><p>Close to the middle of the list you can see <code class="literal">"a</code>, the register containing our macro. You can also view the contents of, say, register <code class="literal">a</code> by executing <code class="literal">:echo @a</code>.</p><p>In the preceding screenshot, many special characters are represented differently. For instance, <code class="literal">^[</code> signifies the <span class="emphasis"><em>Esc</em></span> key, and <code class="literal">^M</code> is an <span class="emphasis"><em>Enter</em></span> key.</p><p>In fact, macros are nothing but registers: the <code class="literal">q</code> command lets you add keystrokes to the register, while <code class="literal">@</code> lets you replay the keystrokes from that register.</p><p>Since the macro is just a register, you can paste it using <code class="literal">p</code>. Open a new buffer with <code class="literal">:new</code>, and paste the contents of the register using <code class="literal">"ap</code>:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/f27212ca-5478-4fa4-bd88-ef5945e139fd.png" /></div><p>Now you can edit your macro without having to retype the whole thing.</p><p>When you're finished editing, copy it back into the register: <code class="literal">_"ay$. _</code> will <span>place</span><a id="id326291739" class="indexterm"></a> you to the beginning of the line, <code class="literal">"a</code> will tell <code class="literal">yank</code> to use register <code class="literal">a</code>, and <code class="literal">y$</code> will copy the text until the end of the line.</p><p>That's it. Paste the register with <code class="literal">"ap</code>, and place it back when you've finished editing using <code class="literal">_"ay$</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip123"></a>Note</h3><p>As with many Vim commands, you shouldn't try to remember the exact letters, but focus on what the command does. This one, for instance, goes to the beginning of the line and yanks the rest of the line into register <code class="literal">a</code>. That's much easier to remember than <code class="literal">_"ay$</code>.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec58"></a>Recursive macros</h3></div></div></div><p>Earlier we ran <span>macros</span><a id="id326450168" class="indexterm"></a> multiple times by prefixing <code class="literal">@</code> with a number. That's not very computer science-like, and we can do better.</p><p>Vim supports recursive macros, but there are a few quirks to be aware of.</p><p>First, you'll need to make sure the register you will be recording to is empty. You can do this by entering macro recording mode, and immediately exiting it. For instance, if you wanted to empty register <code class="literal">b</code>, you'll run <code class="literal">qbq</code> to clear it.</p><p>Then, record your macro as usual, and insert that same register into itself (for example, by using <code class="literal">@b</code>).</p><p> </p><p>Let's say we wanted to swap keys with values in a Python dictionary:</p><pre class="programlisting">animal_noises = {
    'bark': 'dog',
    'meow': 'cat',
    'silence': 'dogfish',
}</pre><p>We could record a macro as follows, starting with the cursor in the beginning of the line <code class="literal">'bark': 'dog'</code>:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/1132c979-8360-49a4-9ce1-505a7376c776.png" /></div><p>Let's record the macro into register <code class="literal">b</code>. First, we'll need to flush it and enter macro recording mode: <code class="literal">qbqqb</code> (<code class="literal">qbq</code> empties register <code class="literal">b</code>, and <code class="literal">qb</code> enters macro recording mode).</p><p>Now, as we want to swap <code class="literal">bark</code> and <code class="literal">dog</code>, we could yank one of these words into some temporary register (say <code class="literal">c</code>), and then move <code class="literal">dog</code> over using the default register.</p><p>Let's go ahead: <code class="literal">"cdi</code>' (delete inside single quotes into buffer <code class="literal">c</code>):</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/36afb34d-3a10-4601-b6e2-eee30437c7fc.png" /></div><p>Move over <code class="literal">'dog'</code> (<code class="literal">W</code>) and run <code class="literal">di'</code> to yank <code class="literal">dog</code> into the default register:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/cec9d1a7-a73d-49bb-afe9-f23958defb68.png" /></div><p> </p><p>Move one character to the left (either with <code class="literal">h</code> or <code class="literal">b</code>) and insert the word <code class="literal">bark</code> from register <code class="literal">c</code> (<code class="literal">"cp</code>):</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/9e306b1d-b3dd-48e4-bc46-40f3b6919f25.png" /></div><p>Now, move back to the beginning of the line (<code class="literal">_</code>) and paste <code class="literal">dog</code> from the default register (<code class="literal">p</code>):</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/869d6f2f-b051-4eb5-8fd9-43015b3033cd.png" /></div><p>Almost there! Go down one line (<code class="literal">j</code>), and move your cursor to the beginning of the line (<code class="literal">_</code>):</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/7bd5123c-586f-4519-8589-219eafd78724.png" /></div><p>Now, replay macro <code class="literal">b</code>: <code class="literal">@b</code>. Nothing will happen, since register <code class="literal">b</code> is still empty. Finish recording the macro (<code class="literal">q</code>).</p><p>Now replay the macro using <code class="literal">@b</code> once, and it will iterate through every line in your file:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/c42a542f-42e4-4916-ab70-c3432f4e292d.png" /></div><p> </p><p>That's it! You can make any macro recursive by appending to the register. To append to a register, you use the uppercase version of the register identifier. For example, if you wanted to make a macro in a register <code class="literal">b</code> recursive, run <code class="literal">qB@bq</code> to append <code class="literal">@b</code> to the end of the macro.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec59"></a>Running macros across multiple files</h3></div></div></div><p>If you wanted to <span>replay</span><a id="id326567446" class="indexterm"></a> a macro across multiple files, you can use (you guessed it) arglist. Arglist allows you to execute normal mode commands with <code class="literal">:normal</code> command. For instance, you could run a macro from register <code class="literal">a</code>, as follows:</p><pre class="programlisting"><span class="strong"><strong>:arg **<span class="emphasis"><em>/*</em></span> .py</strong></span>
<span class="strong"><strong>:argdo execute ":normal @a" | update</strong></span></pre><p>Here, <code class="literal">:normal @a</code> will execute macro <code class="literal">a</code> in normal mode, and <code class="literal">update</code> will save the buffer contents. You'll probably want to use arglist with recursive macros.</p></div></div>