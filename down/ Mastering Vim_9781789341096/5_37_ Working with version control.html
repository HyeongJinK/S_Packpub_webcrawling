<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec40"></a>Working with version control</h2></div></div><hr /></div><p>This section will illustrate <span>working</span><a id="id326481815" class="indexterm"></a> with <span class="strong"><strong>v</strong></span><span class="strong"><strong>ersion control systems</strong></span> (often abbreviated to <span class="strong"><strong>VCS</strong></span>) by using Git as an example.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note91"></a>Note</h3><p>Git seems to be the most popular version control system as of the time of writing this book. Suggestions in this section can be applied to whichever version control system you choose to work with (or, more likely, whichever VCS you're locked into).</p></div><p>Modern development is nearly impossible without version control and, if you're <span>working</span><a id="id325898551" class="indexterm"></a> with code, it's more than likely you'll have to deal with it. This section gives the reader a refresher on how to use one of the most popular version control systems today—Git. We then cover how to work with Git from within Vim, to make Git commands more robust and interactive.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec40"></a>Quick-and-dirty version control and Git introduction</h3></div></div></div><p>You can safely skip this section if you're comfortable with Git.</p><p>Git lets you track a history of <span>changes</span><a id="id325898566" class="indexterm"></a> to files, and helps ease the pain of multiple people working on the same set of files. Git is a distributed version control system, meaning every developer owns a mirrored copy of the code base on their system.</p><p>If you're on a Debian-flavored Linux distribution, you can install Git by running the following:</p><pre class="programlisting"><span class="strong"><strong>$ sudo apt-get install git</strong></span></pre><p>If you're on a different system, you can download the <span>binaries</span><a id="id325899235" class="indexterm"></a> or find more instructions from <a class="ulink" href="http://git-scm.com" target="_blank">git-scm.com/download</a>. You'll want to configure your username and your email address:</p><pre class="programlisting"><span class="strong"><strong>$ git config --global user.name 'Your Name'</strong></span>
<span class="strong"><strong>$ git config --global user.email 'your@email'</strong></span></pre><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p>You're now ready to use Git! If you find yourself stuck, Git has an extensive help system (in addition to a set of tutorials on <a class="ulink" href="http://git-scm.com" target="_blank">git-scm.com</a>):</p><pre class="programlisting"><span class="strong"><strong>$ git help</strong></span></pre><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec19"></a>Concepts</h4></div></div></div><p>Git represents history of changes to files using commits—atomic sets of changes to files. In addition to a diff of changes, each commit has a (hopefully) descriptive message attached to it (by the author of the commit), allowing you to determine what <span>changes</span><a id="id325899441" class="indexterm"></a> were made at any given point in time.</p><p>Commit history is not just linear and can branch, allowing Git users to work on multiple features without stepping on each other's toes. For example, in the following example (read from bottom to top), <code class="literal">feature A</code> was built in a master (main) branch, while <code class="literal">feature B</code> was developed in parallel in its own branch, called <code class="literal">feature-b</code>:</p><pre class="programlisting">* Merged feature B into a master branch
|\
* | Improved feature A
| * Finished making feature B
| * Started building feature B (feature-b branch)
|/
* Implemented feature A
* Initial commit (master branch)</pre><p>Git is a distributed version control system, meaning that there is no central place to talk to: every developer owns a full copy of the repository.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec20"></a>Setting up a new project</h4></div></div></div><p>In this example, we'll be working with <code class="literal">Chapter05/animal_farm/</code> from <a class="ulink" href="https://github.com/PacktPublishing/Mastering-Vim/tree/master/Chapter05/animal_farm" target="_blank">https://github.com/PacktPublishing/Mastering-Vim/tree/master/Chapter05/animal_farm</a>. You can also follow along with any project you'd like. Follow these <span>steps</span><a id="id325899481" class="indexterm"></a> if you're setting up a new Git repository:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Initialize the Git repository in the project's root directory:</li></ol></div><pre class="programlisting"><span class="strong"><strong>$ cd animal_farm/</strong></span>
<span class="strong"><strong>$ git init</strong></span></pre><p>2. Stage all files in a directory to be added to the initial commit:</p><pre class="programlisting"><span class="strong"><strong>$ git add .</strong></span></pre><p> </p><p> </p><p> </p><p> </p><p>3. Create an initial commit:</p><pre class="programlisting"><span class="strong"><strong>$ git commit -m "Initial commit"</strong></span></pre><p>Here's sample output from the previous commands:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/1f00a769-fe38-4d0b-9801-11e6a3a1c3b7.png" /></div><p>You should now be ready to work with your newly created repository.</p><p>If you want to have your repository backed up somewhere outside of your machine, you may want to use a service such as GitHub. See <a class="ulink" href="http://github.com/new" target="_blank">github.com/new</a> to create a new repository, and add the repository URL to your project (where <code class="literal">https://</code> needs to be replaced with the repository URL— something like <code class="literal">https://github.com/&lt;your-username&gt;/animal-farm.git</code>):</p><pre class="programlisting"><span class="strong"><strong>$ git remote add origin &lt;url&gt;</strong></span></pre><p>Now, you just need to push the changes from your local repository:</p><pre class="programlisting"><span class="strong"><strong>$ git push -u origin master</strong></span></pre><p>To keep the repositories in sync, you'll have to push every time you add a new commit; see the <span class="emphasis"><em>Working with Git</em></span> section for details. </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec21"></a>Cloning an existing repository</h4></div></div></div><p>If you already have code in a remote repository (for example, on GitHub), all you <span>need</span><a id="id325899828" class="indexterm"></a> to do is "clone" it—make a local copy. Find the repository URL, either over HTTPS (for example, <a class="ulink" href="https://github.com/vim/vim.git" target="_blank">https://github.com/vim/vim.git</a>) or SSH (for example, <a class="ulink" href="mailto:git@github.com" target="_blank">git@github.com:vim/vim.git</a>). Execute the following command (replacing <code class="literal">&lt;url&gt;</code> with the repository URL):</p><pre class="programlisting"><span class="strong"><strong>$ git clone &lt;url&gt;</strong></span></pre><p>This should download the repository to a directory with the project name on your machine.</p><p>Your local and remote repositories will now operate independently. If you want to update your local repository with changes from the remote repository (the one you cloned), you'll have to run <code class="literal">git pull --rebase</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl3sec22"></a>Working with Git</h4></div></div></div><p>Git is rather extensive, but here are some basic <span>command</span><a id="id325906594" class="indexterm"></a>s to get you started. Let's work in our newly created repository, <code class="literal">animal_farm/</code>.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec2"></a>Adding files, committing, and pushing</h5></div></div></div><p>Let's <span>add</span><a id="id325906612" class="indexterm"></a> a file to <span>our</span><a id="id325906620" class="indexterm"></a> repository, <code class="literal">animals/lion.py</code>:</p><pre class="programlisting">"""A lion."""

import animal

class Lion(animal.Animal):

    def __init__(self):
        self.kind = 'lion'

    def get_kind(self):
        return self.kind</pre><p> </p><p> </p><p> </p><p> </p><p>Next let's add a bit to <code class="literal">animal_farm.py</code> that <span>invokes</span><a id="id325906656" class="indexterm"></a> the file (the added lines are highlighted in bold):</p><pre class="programlisting">...
from animals import dog
<span class="strong"><strong>from animals import lion</strong></span>
from animals import sheep
...
    if kind == 'dog':
        return dog.Dog()
<span class="strong"><strong>    if kind == 'lion':</strong></span>
<span class="strong"><strong>        return lion.Lion()</strong></span>
    if kind == 'sheep':
        return sheep.Sheep()
...</pre><p>You can check the status of your files (to see which changes are going to make it into a commit) by running the following command:</p><pre class="programlisting"><span class="strong"><strong>$ git status
</strong></span></pre><p>The output of the command will show you that you swap <code class="literal">animal_farm.py</code> repository and added <code class="literal">animals/lion.py</code>:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/489a7ffb-14ac-4a60-9618-4b071d92524b.png" /></div><p>Whenever you want to save your files in history, you can stage the files. You can do so individually by executing the following:</p><pre class="programlisting"><span class="strong"><strong>$ git add &lt;filename&gt;</strong></span></pre><p> </p><p> </p><p> </p><p> </p><p>Alternatively, you can stage all of the files at once by running the following:</p><pre class="programlisting"><span class="strong"><strong>$ git add .</strong></span></pre><p>If you run <code class="literal">git status</code>, you'll see that the files are now staged to be committed:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/6fde1d6f-2e89-45ff-acbd-f69acdebac02.png" /></div><p>To commit a file or a set of files to history, execute the following:</p><pre class="programlisting"><span class="strong"><strong>$ git commit -m "&lt;informative message describing the changes&gt;"</strong></span></pre><p>For instance, here's how we would commit our changes to <code class="literal">animals/lion.py</code> and <code class="literal">animal_farm.py</code>:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/746056a9-c2db-4e22-9812-00f20bc177ec.png" /></div><p>To push your changes to a remote repository (if you created one earlier), run the following:</p><pre class="programlisting"><span class="strong"><strong>$ git push</strong></span></pre><p>To synchronize your changes with the changes other people made, run the <span>following</span><a id="id325983427" class="indexterm"></a> (in fact, it's usually wise to pull before pushing if you work with multiple people):</p><pre class="programlisting"><span class="strong"><strong>$ git pull --rebase</strong></span></pre><p>Now, if you want to <span>view</span><a id="id325983444" class="indexterm"></a> the commit history, run the following:</p><pre class="programlisting"><span class="strong"><strong>$ git log
</strong></span></pre><p> </p><p> </p><p> </p><p> </p><p>Here's how the <code class="literal">git log</code> output looks for our project so far:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/e4434ef9-2023-4b5a-bcd1-2b2a2a0ee109.png" /></div><p>At the top, we can see a commit we just created. Right below it is the initial commit.</p><p>If you'd like to pull a particular commit into your working copy (for example, to see <span>how</span><a id="id325983629" class="indexterm"></a> things were at the initial commit), run the following (where <code class="literal">&lt;sha1&gt;</code> is the alphanumeric commit ID, for example, <code class="literal">e1fec4ab2d14ee331498b6e5b2f2cca5b39daec0</code> for the <code class="literal">Initial commit</code> in the previous screenshot):</p><pre class="programlisting"><span class="strong"><strong>$ git checkout &lt;sha1&gt;</strong></span></pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="ch05lvl4sec3"></a>Creating and merging branches</h5></div></div></div><p>Separate branches are often <span>used</span><a id="id325983660" class="indexterm"></a> to create separate chunks of work. Once the feature is ready, the branches are <span>merged</span><a id="id325983669" class="indexterm"></a> back into the master (primary) branch. To create a new branch, run the following:</p><pre class="programlisting"><span class="strong"><strong>$ git checkout -b &lt;branch-name&gt;</strong></span></pre><p>For instance, we could create a branch in which we add a new animal type:</p><pre class="programlisting"><span class="strong"><strong>$ git checkout -b feature-leopard
</strong></span></pre><p>It will appear as the following:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/609ee3b7-e0d7-464e-86ad-0efb4f56b56a.png" /></div><p> </p><p> </p><p> </p><p> </p><p>Now, you can perform work on this branch as usual. For instance, we could add a new <code class="literal">animals/leopard.py</code> and modify <code class="literal">animal_farm.py</code> just like we did in the previous section:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/19a3e33f-e7ec-441b-b063-56939687c03c.png" /></div><p>Now that our feature is ready (we've added the leopard), we're ready to merge the <code class="literal">feature-leopard</code> branch back into the <code class="literal">master</code> (primary) branch. To see a list of all branches, run the following:</p><pre class="programlisting"><span class="strong"><strong>$ git branch -a
</strong></span></pre><p>The branch you are currently on is marked with an asterisk (<code class="literal">*</code>):</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/80ce4332-7d02-4f76-bf2c-8aa79cfe0a61.png" /></div><p>To move to another branch, run the following:</p><pre class="programlisting"><span class="strong"><strong>$ git checkout &lt;branch-name&gt;</strong></span></pre><p>In our case, let's move to the <code class="literal">master</code> branch:</p><pre class="programlisting"><span class="strong"><strong>$ git checkout master</strong></span></pre><p>Now, we just need to <span>merge</span><a id="id326005331" class="indexterm"></a> our feature branch into the <span>branch</span><a id="id326005339" class="indexterm"></a> we're currently on:</p><pre class="programlisting"><span class="strong"><strong>$ git merge feature-leopard</strong></span></pre><p> </p><p> </p><p> </p><p> </p><p>A helpful message will display the result of the merge:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/c988ebb6-49b6-40b4-b5e0-5f6de9c915f8.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note92"></a>Note</h3><p>If your repository is in GitHub, don't forget to run <code class="literal">git push</code> after you're done, to propagate your changes to the remote repository.</p></div></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec41"></a>Integrating Git with Vim (vim-fugitive)</h3></div></div></div><p>This section assumes that you understand the basics of working with Git. If you don't (or it's been a while), see the <span class="emphasis"><em>Quick and dirty version control and Git introduction</em></span> section.</p><p>Tim Pope's vim-fugitive is a plugin that makes sure you don't need to leave <span>Vim</span><a id="id326012298" class="indexterm"></a> to interact with Git. Since you're editing the files in Vim, you might as well take care of dealing with version control of said edits in the editor. The <span>plugin</span><a id="id326012307" class="indexterm"></a> is available from <a class="ulink" href="https://github.com/tpope/vim-fugitive" target="_blank">https://github.com/tpope/vim-fugitive</a>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note93"></a>Note</h3><p>If you're using vim-plug, you can install vim-fugitive by adding <code class="literal">Plug 'tpope</code><code class="literal">/vim-fugitive'</code> to your <code class="literal">.vimrc</code> file and running <code class="literal">:w | source $MYVIMRC | PlugInstall</code>.</p></div><p>A lot of the commands vim-fugitive provides are a mirror of external Git commands. However, the output is often a lot more interactive. Take <code class="literal">git status</code>, for example, invoked by running the following:</p><pre class="programlisting"><span class="strong"><strong>:Gstatus</strong></span></pre><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p>You'll see the familiar <code class="literal">git status</code> output in a split window (you may want to make some changes to the source files without committing them, to have some <code class="literal">git status</code> output to work with):</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/0eaafbb8-7799-4e20-9818-b351b6891069.png" /></div><p>Unlike the <code class="literal">git status</code> output, this window is interactive. Move your cursor over one of the files (<span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>n</em></span> and <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>p</em></span> allow you to cycle through files as well). Try some of the supported commands:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal"><span class="emphasis"><em>-</em></span></code> will stage or unstage the file</li><li style="list-style-type: disc"><code class="literal">cc</code> or <code class="literal">:Gcommit</code> will commit the staged files</li><li style="list-style-type: disc"><code class="literal">D</code> or <code class="literal">:GDiff</code> will open a diff</li><li style="list-style-type: disc"><code class="literal">g?</code> displays help with more commands
</li></ul></div></li></ul></div><p><code class="literal">:Glog</code> opens a history of commits related to the currently open file. Conveniently, the results are displayed in a quickfix window as follows:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/3daa6db5-9cf6-41d9-9b1e-2c8afdbf7ef0.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip94"></a>Note</h3><p>Use <code class="literal">:copen</code> to pop open the quickfix window. The <code class="literal">:cnext</code> and <code class="literal">:cprevious</code> commands navigate the quickfix window by displaying different file versions. See the section, <span class="emphasis"><em>Building and Testing – Quickfix Window,</em></span> to learn more about a quickfix window.</p></div><p> </p><p><code class="literal">git blame</code> is a command that lets you quickly figure out who changed every <span>line</span><a id="id326164662" class="indexterm"></a> of the file and when. This way, you can blame other developers (or, most often, yourself in the past) for bugs in your code! <code class="literal">:Gblame</code> displays interactive <code class="literal">git blame</code> output in a vertical split window:</p><div class="mediaobject"><img src="/graphics/9781789341096/graphics/194b8571-22dd-4780-9586-c4638aca737c.png" /></div><p><code class="literal">:Gblame</code> displays relevant commit ID, name of the commit author, and commit date and time (hidden in the screenshot) next to each line in the file.</p><p>Some useful shortcuts for <code class="literal">:Gblame</code> are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">C</code>, <code class="literal">A</code>, and <code class="literal">D</code> resize the blame window up until the commit, author, and date respectively</p></li><li style="list-style-type: disc"><p><span class="emphasis"><em>Enter</em></span> opens a diff of the chosen commit</p></li><li style="list-style-type: disc"><p><code class="literal">o</code> opens a diff of the chosen commit in a split window</p></li><li style="list-style-type: disc"><p><code class="literal">g?</code> displays help with more commands</p></li></ul></div><p><code class="literal">:Gblame</code> is an extremely useful tool for figuring out when things went wrong.</p><p>There are even more really handy wrappers provided in this tool, such as the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">:Gread</code> checks out the file straight into a buffer for a preview</li><li style="list-style-type: disc"><code class="literal">:Ggrep</code> wraps around <code class="literal">git grep</code> (Git provides a powerful <code class="literal">grep</code> command that lets you search through <span>tracked</span><a id="id326248827" class="indexterm"></a> files at any moment in time—see <a class="ulink" href="https://git-scm.com/docs/git-grep" target="_blank">https://git-scm.com/docs/git-grep</a> for details)</li><li style="list-style-type: disc"><code class="literal">:Gmove</code> moves the files (while renaming the buffers)</li><li style="list-style-type: disc"><code class="literal">:Gdelete</code> wraps <code class="literal">git remove</code> commands</li></ul></div><p>Don’t forget to use Vim help (for example, <code class="literal">:help fugitive</code>) to learn more about the plugins!</p></div></div>