<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec34"></a>Writing error handlers</h2></div></div><hr /></div><p>To register custom error handlers in Koa, we <span>simply</span><a id="id325859229" class="indexterm"></a> need to define  middleware with a <code class="literal">try... catch</code> statement to capture the errors, then send responses back to the client. This should be done at the top of the stack.</p><p>We can define error handlers based on various requirements to handle different types of errors for different types of clients. These error handlers can be used independently or combined, depending on the needs of the application. Let's define a set of error handlers and register them in our application:</p><pre class="programlisting">const jsonErrorHandler = async (ctx, next) =&gt; {
  try {
    await next();
  } catch (err) {
    const isJson = ctx.get('Accept') === 'application/json';
    if (isJson) {
      ctx.body = {
        error: 'An error just occurred'
      }
    } else {
      throw err;
    } 
  }
}

app.use(jsonErrorHandler);</pre><p>The first error handler defined is for catching errors on Ajax requests or requests that only accept JSON responses.</p><p>Next, we can define a catch-all error handler. This can be substituted with an error page in a real-life application:</p><pre class="programlisting">const errorHandler = async (ctx, next) =&gt; {
  try {
    await next();
  } catch (err) {
    ctx.status = err.status || 500;
    ctx.body = err.expose ? err.message : 'An error occurred!';
  }
}

app.use(errorHandler);</pre><p><span>Putting both error handlers together, they will look like the code block below:</span></p><pre class="programlisting">// define generic error handler
const errorHandler = async (ctx, next) =&gt; {
  try {
    await next();
  } catch (err) {
    ctx.status = err.status || 500;
    ctx.body = err.expose ? err.message : 'An error occurred!';
  }
}

// register generic error handler middleware
app.use(errorHandler);

// define json request error handler
const jsonErrorHandler = async (ctx, next) =&gt; {
  try {
    await next();
  } catch (err) {
    const isJson = ctx.get('Accept') === 'application/json';
    if (isJson) {
      ctx.status = err.status || 500;
      ctx.body = {
        error: `An error just occurred`
      }
    } else {
      throw err;
    } 
  }
}

// register json error handler middleware
app.use(jsonErrorHandler);</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note15"></a>Note</h3><p>
Note: We register the generic handler first, as it will be the last middleware to be executed as the middleware stack unwinds.</p></div></div>