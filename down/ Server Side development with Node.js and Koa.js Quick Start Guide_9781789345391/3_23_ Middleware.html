<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec29"></a>Middleware</h2></div></div><hr /></div><p>Middleware functions are a <span>common</span><a id="id325876634" class="indexterm"></a> concept in modern web development. A middleware function is one that has access to both the request and response objects in an application and can run the subsequent middleware after it is processed.</p><p>Middleware creation and registration in Koa is straightforward and is one of the reasons the framework is so widely adopted.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec13"></a>Cascading in Koa</h3></div></div></div><p>Koa takes advantage of async <span>functions</span><a id="id325851049" class="indexterm"></a> to make <span>middleware</span><a id="id325851040" class="indexterm"></a> functions run in a truly cascaded fashion. The registered middlewares run in a stack-like manner and run from one level to the other until there is no other middleware to run.</p><p> </p><p> </p><p>The use of async functions is an improvement over other frameworks that have tried to implement stack-like middleware, as callbacks in Node made it much harder. Koa contrasts Connect, for example, in that Connect simply passes control through a series of functions until one returns. In Koa, the middleware functions are invoked <span class="emphasis"><em>downstream</em></span>, and the control flows back <span class="emphasis"><em>upstream</em></span>.</p><p>Here is an example from the Koa documentation showing the use of middleware:</p><pre class="programlisting">const Koa = require('koa');
const app = new Koa();

// logger
app.use(async (ctx, next) =&gt; {
  await next();
  const rt = ctx.response.get('X-Response-Time');
  console.log(`${ctx.method} ${ctx.url} - ${rt}`);
});

// x-response-time
app.use(async (ctx, next) =&gt; {
  const start = Date.now();
  await next();
  const ms = Date.now() - start;
  ctx.set('X-Response-Time', `${ms}ms`);
});

// response
app.use(async ctx =&gt; {
  ctx.body = 'Hello World';
});

app.listen(3000);</pre><p>In the preceding code block, the request first flows through the <code class="literal">logger</code> middleware, and then the <code class="literal">x-response-time</code> middleware, which marks when the request started, and finally the response middleware, which sends the <code class="literal">Hello World</code> response. When a middleware calls <code class="literal">next()</code>, the middleware function suspends and passes control to the next middleware defined. Once no other middleware exists to execute downstream, the stack will <span>unwind</span><a id="id325850996" class="indexterm"></a> and each <span>middleware</span><a id="id325755168" class="indexterm"></a> is resumed to perform its upstream behavior.</p><p> </p><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec14"></a>Defining middleware</h3></div></div></div><p>Defining a middleware function in Koa involves creating an asynchronous function with two arguments—the context object (<code class="literal">ctx</code>), and the next method (<code class="literal">next</code>), which invokes the <code class="literal">next</code><span>middleware</span><a id="id325838424" class="indexterm"></a> function to be called. This is similar to the way middleware functions are defined in Express. One major difference in their approach is that Koa implements the context object in place of the individual request (<code class="literal">req</code>) and response (<code class="literal">res</code>) objects provided by Node. Another difference is that Koa makes use of the <code class="literal">async... await</code> paradigm in place of callback functions.</p><p>Let's define a simple middleware to log how long it takes our application to process requests. In the following code block, we define a middleware function, and in the next section, we will register it and get to see it in action:</p><pre class="programlisting">const responseTimer = async (ctx, next) =&gt; {
  const { method, path } = ctx.request;
  const start = Date.now();
  await next();
  const timeTaken = (Date.now() - start) / 1000; // divide by 1000 to get time in seconds
  console.log(`${method} request to ${path} took ${timeTaken}s`);
};</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec15"></a>Registering middleware</h3></div></div></div><p>Registering <span>middleware</span><a id="id325838457" class="indexterm"></a> in Koa is done with the <code class="literal">.use()</code> method found in the application object. <span>To register the middl</span>eware defined in the previous section:</p><pre class="programlisting">app.use(responseTimer);</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note12"></a>Note</h3><p>Ensure you pass in the function reference when registering the middleware, and not call the function instead. A common mistake is to pass in <code class="literal">responseTimer()</code> instead of <code class="literal">responseTimer</code>.</p></div><p>Next, we can define and register a middleware to send a response back for every route as shown here:</p><pre class="programlisting">// ...

app.use(async ctx =&gt; {
  ctx.body = 'Hello World';
});</pre><p> </p><p>The complete application will look like this:</p><pre class="programlisting">// koa-middleware.js

// initialize Koa
const Koa = require('koa');
const app = new Koa();

// create middleware function
const responseTimer = async (ctx, next) =&gt; {
  const { method, path } = ctx.request;
  const start = Date.now();
  await next();
  const timeTaken = (Date.now() - start) / 1000; // divide by 1000 to get time in seconds
  console.log(`${method} request to ${path} took ${timeTaken}s`);
};

// register middleware
app.use(responseTimer);

// send response back
app.use(async ctx =&gt; {
  ctx.body = 'Hello World';
});

// start application
app.listen(1234, () =&gt; {
  console.log('Server is running on port 1234')
});</pre><p>Next, we can run the app with the following command:</p><pre class="programlisting"><span class="strong"><strong>node koa-middleware.js</strong></span></pre><p>Making a request to an endpoint on the <span>application</span><a id="id325850977" class="indexterm"></a> would produce logs such as this on your console:</p><pre class="programlisting"><span class="strong"><strong>GET request to / took 0.023s</strong></span>
<span class="strong"><strong>GET request to /robots.txt took 0s</strong></span></pre><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec16"></a>Common middleware</h3></div></div></div><p>Some common middleware used in everyday <span>application</span><a id="id325859267" class="indexterm"></a> development in Koa includes the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">koa-router</code>: RESTful resource <span>router</span><a id="id325859283" class="indexterm"></a> for Koa</li><li style="list-style-type: disc"><code class="literal">koa-connect</code>: For mounting connect/express middleware</li><li style="list-style-type: disc"><code class="literal">kcors</code>: For <span>CORS</span><a id="id325876642" class="indexterm"></a> support</li><li style="list-style-type: disc"><code class="literal">koa-body</code>: For parsing HTTP <span>request</span><a id="id325876654" class="indexterm"></a> body</li><li style="list-style-type: disc"><code class="literal">koa-logger</code>: Development <span>style</span><a id="id325876667" class="indexterm"></a> logger for Koa</li></ul></div><p>A comprehensive list of supported middleware can be <span>found</span><a id="id325876678" class="indexterm"></a> on Koa's <a class="ulink" href="https://github.com/koajs/koa/wiki#middleware" target="_blank">middleware wiki</a>.</p></div></div>