<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec27"></a>The application object</h2></div></div><hr /></div><p>The application object in Koa is an object <span>containing</span><a id="id325755172" class="indexterm"></a> the Koa application instance. It also contains a list of the middleware functions in the application. It is responsible for managing and executing the middleware in a cascaded manner. It is also responsible for managing some key aspects of the application, as we will soon see in some of the following examples. Here is an excerpt from the Koa official documentation:</p><div class="blockquote"><blockquote class="blockquote"><p><span class="emphasis"><em>"A Koa application is an object containing an array of middleware functions which are composed and executed in a stack-like manner upon request. Koa is similar to many other middleware systems that you may have encountered such as Ruby's Rack, Connect, and so on—however, a key design decision was made to provide high level sugar at the otherwise low-level middleware layer. This improves interoperability, robustness, and makes writing middleware much more enjoyable."</em></span></p></blockquote></div><p>The application object also exposes methods for common tasks such as content-negotiation, cache freshness, proxy support, and so on. A useless Koa application that runs on port <code class="literal">1234</code> can be easily created in just a few lines of code, as shown here:</p><pre class="programlisting">const Koa = require('koa');
const app = new Koa();

const port = 1234;
app.listen(port, () =&gt; {
 console.log(`The app is running on port ${port}`);
});</pre><p>In the preceding application, the application object is referenced by the <code class="literal">app</code> variable by instantiating the application with <code class="literal">new Koa()</code>. We then use the application object to start the server with <code class="literal">app.listen()</code>, one of the various methods exposed on the application object.</p><p> </p><p> </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec8"></a>Useful application methods</h3></div></div></div><p>As mentioned earlier, the application object exposes some <span>methods</span><a id="id325859272" class="indexterm"></a> to make development easier and make some tasks easier to do. In this section, we will discuss some of the methods available in the application method:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">app.listen(...)</code>: The <code class="literal">app.listen()</code>method is used to create and return an HTTP Server. It is syntactical sugar around the native Node<code class="literal">server.listen()</code>method. It can be used as seen here: </li></ul></div><pre class="programlisting">      const Koa = require('koa');
      const app = new Koa();
      app.listen(3000);</pre><p>The preceding code block is essentially the same as the following one:</p><pre class="programlisting">const http = require('http');
const Koa = require('koa');
const app = new Koa();
http.createServer(app.callback()).listen(3000);</pre><p>One or more Koa applications can be mounted on the same HTTP server, as creating a Koa application does not directly map to starting a server. Here is an example where a single Koa application is started as HTTP and HTTPS on two different ports:</p><pre class="programlisting">const http = require('http');
const https = require('https');
const Koa = require('koa');
const app = new Koa();
http.createServer(app.callback()).listen(3000);
https.createServer(app.callback()).listen(3001);</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">app.callback()</code>: The <code class="literal">app.callback()</code>m<span>ethod returns a</span> callback function to be used by the<code class="literal">http.createServer()</code>method for handling a request. Its usage can be seen in the preceding examples, when we start a simple Koa app with the<code class="literal">http.createServer()</code>or<code class="literal">https.createServer()</code>methods.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">app.use(function)</code>: This is used for registering middleware to the application. It is similar to the <code class="literal">app.use()</code>method implemented in Express. It takes the middleware function as its only argument.</li></ul></div><p> </p><p>A simple middleware for logging the time a request is <span>made</span><a id="id325859562" class="indexterm"></a> can be defined with <code class="literal">app.use()</code> as seen here:</p><pre class="programlisting">app.use(async ctx =&gt; {
  const currentDateTime = new Date().toLocaleString();
  console.log(`${ctx.method} request made to ${ctx.url} at ${currentDateTime}`;
  await next();
});</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">app.keys=</code>: <span>This is used</span> to set signed cookie keys. The keys are passed to <code class="literal"><span>KeyGrip</span></code>, and can be set in the following ways:</li></ul></div><pre class="programlisting">      app.keys = ['first secret key', 'second secret key']; // passing 
      an array of keys

      app.keys = new KeyGrip(['first secret key', 'second secret key'], 
      'sha256'); // passing KeyGrip instance</pre><p>Keygrip is a library for signing and verifying data through a rotating credential system in Node.js. With KeyGrip, new server keys can be added and old ones removed regularly, without invalidating the client credentials.</p><p>Passing the KeyGrip instance as opposed to <span>passing</span><a id="id326007412" class="indexterm"></a> in an array of keys to <code class="literal">app.keys=</code> gives you the flexibility to set other options such as the <code class="literal">hmacAlgorithm</code> and <code class="literal">encoding</code> for your signed keys. The <span>documentation</span><a id="id326127920" class="indexterm"></a> for KeyGrip and what these options mean can be found here: <a class="ulink" href="https://www.npmjs.com/package/keygrip" target="_blank">https://www.npmjs.com/package/keygrip</a>.</p><p>The keys may be rotated and are used when signing cookies with the <code class="literal">signed: true</code> option:</p><pre class="programlisting">context.cookies.set('color', 'red', { signed: true });</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">app.context</code>: This <span>is the prototype from</span> which the <span>context</span><a id="id326128131" class="indexterm"></a> object (usually referred to as <code class="literal">ctx</code>) is created. It can be used to append more methods to the context object, so as to make them available throughout your application. This can be seen in this example, where a logger is attached:</li></ul></div><pre class="programlisting">      app.context.logger = logger();

      app.use(async ctx =&gt; {
        ctx.logger.info('Accessing middleware...')
     });</pre><p> </p><p> </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec9"></a>Settings</h3></div></div></div><p>The application settings are properties set on the <span>application</span><a id="id326244729" class="indexterm"></a> instance. <span>The following are currently supported:</span></p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">app.env</code>: This defaults to the <code class="literal">NODE_ENV</code> or <code class="literal">development</code>.</li><li style="list-style-type: disc"><code class="literal">app.proxy</code>: When set to <code class="literal">true</code>, proxy header fields will be trusted. This simply means that the <code class="literal">X-Forwarded-*</code> header fields may be trusted.</li><li style="list-style-type: disc"><code class="literal">app.subdomainOffset</code> offset of <code class="literal">.subdomains</code> to ignore. Its value is 2 by default. The use of this can be illustrated with an example taken from the Koa documentation:</li></ul></div><div class="blockquote"><blockquote class="blockquote"><p><span class="emphasis"><em>"...if the domain is <code class="literal">"tobi.ferrets.example.com"</code>: If<code class="literal">app.subdomainOffset</code>is not set,<code class="literal">ctx.subdomains</code>is<code class="literal">["ferrets", "tobi"]</code>. If<code class="literal">app.subdomainOffset</code>is<code class="literal">3</code>,<code class="literal">ctx.subdomains</code>is<code class="literal">["tobi"]</code>."</em></span></p></blockquote></div></div></div>