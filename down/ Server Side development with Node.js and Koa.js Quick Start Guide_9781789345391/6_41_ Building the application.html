<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec44"></a>Building the application</h2></div></div><hr /></div><p>In this section, we will build our blog. We will be able to <span>achieve</span><a id="id325755170" class="indexterm"></a> this by following the steps given:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Starting the server</li><li>Connecting to the database</li><li>Creating data models</li><li>Setting up the router</li><li>Setting up the views</li><li>Handling authentication</li><li>Creating controller functions</li></ol></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec32"></a>Starting the server</h3></div></div></div><p>We will not go into much detail on this, as it was <span>covered</span><a id="id325755144" class="indexterm"></a> in the previous chapter. To start our server, we will simply insert the following content into the <code class="literal">index.js</code> entry file:</p><pre class="programlisting">// ./index.js

const Koa = require('koa');
const app = new Koa();

const port = process.env.PORT || 3000;
app.listen(port, () =&gt; console.log(`Server running on http://localhost:${port}`));</pre><p>The server either runs on a specified port with the <code class="literal">PORT</code> environmental variable or on the default <code class="literal">3000</code> port.</p><p>To start our application, you can run this command from the project root:</p><pre class="programlisting"><span class="strong"><strong>node index.js</strong></span></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip26"></a>Note</h3><p>You can also use <code class="literal">nodemon</code> to start the app for automatic reloads anytime a change is made to a file in the project folder, <code class="literal">nodemon index.js</code></p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec33"></a>Connecting to the database</h3></div></div></div><p>We will define our MongoDB <span>connection</span><a id="id325022160" class="indexterm"></a> in a <code class="literal">./db.js</code> file. This will help keep our <code class="literal">index.js</code> file neat and allow us to keep our configurations modular.</p><p>To connect to our database, if you haven't already, create a <code class="literal">db.js</code> file in the root directory as given:</p><pre class="programlisting"><span class="strong"><strong>touch db.js</strong></span></pre><p>Then, insert the following into the file:</p><pre class="programlisting">// ./db.js

const mongoose = require('mongoose');

module.exports = () =&gt; {
  mongoose.connect(
    'mongodb://localhost:27017/koa-blog',
    { useNewUrlParser: true }
  );

  const db = mongoose.connection;
  db.on('error', error =&gt; {
    throw new Error(`error connecting to db: ${error}`);
  });
  db.once('open', () =&gt; console.log('database connected'));
};</pre><p>In the preceding code block, first, we require the <code class="literal">mongoose</code> ODM library, then we export a simple function that creates a connection to our database using the <code class="literal">mongoose.connect(dbUrl, [options])</code> method. We are creating a connection to the <code class="literal">koa-blog</code> database.</p><p>It should also be noted that we set up listeners in our database connection function. The <code class="literal">db.on('error')</code> listener is for when an error occurs when a connection is trying to be established. The <code class="literal">db.on('open')</code> listener is called when a successful connection occurs.</p><p>Now that we have exported our database <span>connection</span><a id="id325932988" class="indexterm"></a> function, we can make use of it in the <code class="literal">index.js</code> file as seen here:</p><pre class="programlisting">// ./index.js

// ...
const initDb = require('./db');

// initialize database
initDb();

// ...</pre><p>The complete <code class="literal">index.js</code> file will now look like this:</p><pre class="programlisting">const Koa = require('koa');
const initDb = require('./db');

// initialize database
initDb();

// create app instance
const app = new Koa();

// start server
const port = process.env.PORT || 3000;
app.listen(port, () =&gt; console.log(`Server running on http://localhost:${port}`));</pre><p>The next time our application starts, we should see messages similar to this one:</p><pre class="programlisting"><span class="strong"><strong>Server running on http://localhost:3000</strong></span>
<span class="strong"><strong>database connected</strong></span></pre><p>This indicates that the <span>connection</span><a id="id325950733" class="indexterm"></a> to the database was successful.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec34"></a>Creating data models</h3></div></div></div><p>Now that we have a successful <span>database</span><a id="id326291654" class="indexterm"></a> connection, we can go <span>ahead</span><a id="id326291674" class="indexterm"></a> to create data models that will control our interaction with our database.</p><p>In our application, we will need two data models:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">The <code class="literal">User</code> model: This will contain the schema for our user collection</li><li style="list-style-type: disc">The <code class="literal">Post</code> model: This will contain the schema for our post collection</li></ul></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec8"></a>The user model</h4></div></div></div><p>This is responsible for handling our database <span>interactions</span><a id="id325951158" class="indexterm"></a> with registered users of our application. It will contain the following fields:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">fullName</code>: This is a string value. The full name of the registered user. This is a required field, and should not be empty.</li><li style="list-style-type: disc"><code class="literal">email</code>: This is also a string value. It is the email address of the registered user. Note that this value should be unique. We will make use of the <code class="literal">mongoose-unique-validator</code> plugin here to ensure the value is unique across all our app's users. This is a required field, and should not be empty.</li><li style="list-style-type: disc"><code class="literal">password</code>: This is a hash of the user password. This should also be a string value. This is a required field, and should also not be empty.</li><li style="list-style-type: disc"><code class="literal">createdAt</code>: The date the document was created. This can be saved as a JavaScript date object. The default value is the current date.</li><li style="list-style-type: disc"><code class="literal">updatedAt</code>: The date the document was most recently updated. This can be saved as a JavaScript Date object. The default value is the current date.</li></ul></div><p>To create the data model, let us create a <code class="literal">User.js</code> file in the <code class="literal">./models</code> folder, and insert the following code into it:</p><pre class="programlisting">const mongoose = require('mongoose');
const uniqueValidator = require('mongoose-unique-validator');

const schema = new mongoose.Schema({
 fullName: {
  type: String,
  required: true
 },
 email: {
  unique: true,
  type: String,
  required: true
 },
 password: {
  type: String,
  required: true
 },
 createdAt: { type: Date, default: Date.now },
 updatedAt: { type: Date, default: Date.now }
});

schema.plugin(uniqueValidator);
module.exports = mongoose.model('User', schema);</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note27"></a>Note</h3><p>The <code class="literal">mongoose</code> reference created in the preceding code block when we <code class="literal">require('mongoose')</code> will be the same as the one that was returned when we initially connected to the database.</p></div><p>The <code class="literal">mongoose-unique-validator</code> plugin is <span>used</span><a id="id325962629" class="indexterm"></a> to add pre-save validation for unique fields within a Mongoose schema. After defining our schema, we export the model to be used in other places in our application.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec9"></a>The post model</h4></div></div></div><p>This model handles the interaction of our <span>application</span><a id="id325962644" class="indexterm"></a> with blog posts in the database. We will keep things very simple, so it will only have the following fields mentioned:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">title</code>: This is the title of the post. It is a string value. It should not be empty, which means it is a required field.</li><li style="list-style-type: disc"><code class="literal">content</code>: This is the body or content of the blog post. It should be a string value.</li><li style="list-style-type: disc"><code class="literal">image</code>: This is a link to the featured image for the post. It should also be a string value.</li><li style="list-style-type: disc"><code class="literal">author</code>: This the user who created the post. It is a reference to the <code class="literal">ObjectId</code> of the user who created this post on the user collection.</li><li style="list-style-type: disc"><code class="literal">createdAt</code>: The date the document was created. This can be saved as a JavaScript date object. The default value is the current date.</li><li style="list-style-type: disc"><code class="literal">updatedAt</code>: The date the document was most recently updated. This can be saved as a JavaScript date object. The default value is the current date.</li></ul></div><p>To create the post model, let's create a <code class="literal">Post.js</code> file in the <code class="literal">./models</code> folder, and insert the following code into it:</p><pre class="programlisting">const mongoose = require('mongoose');

const schema = new mongoose.Schema({
 title: {
   type: String,
   required: true
 },
 content: String,
 image: String,
 author: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User'
 },
 createdAt: { type: Date, default: Date.now },
 updatedAt: { type: Date, default: Date.now }
});

module.exports = mongoose.model('Post', schema);</pre><p>As usual, after our schema definition, we export the <span>model</span><a id="id326010695" class="indexterm"></a> to be used elsewhere in our application.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec35"></a>Setting up the router</h3></div></div></div><p>Next, we will set up our router to handle <span>routing</span><a id="id326010710" class="indexterm"></a> to different pages of our application. We will use <code class="literal">koa-router</code>, the popular RESTful routing middleware for Koa.</p><p>Let's create a <code class="literal">router.js</code> file as shown, which will contain all our route definitions in the <code class="literal">middleware</code> folder:</p><pre class="programlisting"><span class="strong"><strong>touch middleware/router.js</strong></span></pre><p>After creating the file, we can insert the following content into it:</p><pre class="programlisting">// ./middleware/router.js

const KoaRouter = require('koa-router');

const router = new KoaRouter();
router.get('/', ctx =&gt; (ctx.body = 'Welcome to the Koa Blog!'));

module.exports = router;</pre><p>In the preceding code block, we require <code class="literal">koa-router</code>, and then create a new instance of the middleware and register a simple route for the index route.</p><p>Next, we register our middleware in our entry file, updating <code class="literal">./index.js</code> as shown:</p><pre class="programlisting">// ./index.js

// ...
const router = require('./middleware/router');

// router
app.use(router.routes());

// ...</pre><p>After the addition, at <span>this</span><a id="id326018203" class="indexterm"></a> point, the complete <code class="literal">index.js</code> will look like this:</p><pre class="programlisting">const Koa = require('koa');
const router = require('./middleware/router');
const initDb = require('./db');

// initialize database
initDb();

// create app instance
const app = new Koa();

// register middlware
app.use(router.routes());

// start server
const port = process.env.PORT || 3000;
app.listen(port, () =&gt; console.log(`Server running on http://localhost:${port}`));</pre><p>Now that we have the router defined and registered, a request to http://localhost:3000 should produce a result similar to what is seen in this screenshot:</p><div class="mediaobject"><img src="/graphics/9781789345391/graphics/aed0714b-e571-4a1e-a0a2-5717ab17df1f.png" /></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note28"></a>Note</h3><p>
Remember to replace the port when visiting the app on your browser if you are using a different one than <code class="literal">3000</code>.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec36"></a>Setting up the views</h3></div></div></div><p>To serve HTML pages, we will need to <span>implement</span><a id="id326018245" class="indexterm"></a> a view <span>middleware</span><a id="id326018289" class="indexterm"></a> and a templating engine. The templating engine will help us pass and use data from our application in our views and make the views reusable. We will be making use of the <code class="literal">koa-views</code> publicly available middleware as our template rendering middleware. We will also use <code class="literal">ejs</code> along with it as the templating engine of choice.</p><p>To register our view renderer and templating engine, add the following line to the <code class="literal">./index.js</code> file as shown here:</p><pre class="programlisting">// ./index.js

// ...
const views = require('koa-views');

app.use(views(`${__dirname}/views`, {
  extension: 'ejs'
}));</pre><p>In the preceding code block, first, we require the <code class="literal">koa-views</code> middleware. Next, we register it using the <code class="literal">views(dirName, [options])</code> middleware function.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note29"></a>Note</h3><p>Ensure the views middleware is registered before the router middleware. This ensures that the <code class="literal">ctx.render()</code> method is available for use within our route definitions.</p></div><p>The middleware function takes the directory name containing the views as the first parameter, then an object of options as its second parameter. We pass in the <code class="literal">{ extension: 'ejs' }</code> option to specify that our views are <code class="literal">ejs</code> files; hence, we do not have to explicitly write the file extensions when using the <code class="literal">ctx.render()</code> function later. For the full list of <span>options</span><a id="id326018343" class="indexterm"></a> accepted by <code class="literal">koa-views</code>, you can check its documentation (<a class="ulink" href="https://www.npmjs.com/package/koa-views" target="_blank">https://www.npmjs.com/package/koa-views</a>).</p><p>Next, let's create a simple view to serve as our application's home page. We will <span>create</span><a id="id326018500" class="indexterm"></a> an <code class="literal">index.ejs</code> file in the <code class="literal">views</code> folder and insert the following content into it:</p><pre class="programlisting">&lt;!-- ./views/index.ejs --&gt;

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
  &lt;title&gt;Welcome - KoaBlog&lt;/title&gt;
  &lt;link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.min.css"&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;section class="section"&gt;
    &lt;div class="container"&gt;
      &lt;div class="columns"&gt;
        &lt;div class="column"&gt;
          &lt;h1 class="title"&gt;&lt;a href="/"&gt;KoaBlog&lt;/a&gt;&lt;/h1&gt;
          &lt;p class="subtitle"&gt;Blog built with Koa!&lt;/p&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/section&gt;
&lt;/body&gt;
&lt;/html&gt;</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note30"></a>Note</h3><p>
In the preceding markup, we include <code class="literal">bulma</code>, a popular CSS framework, to give us access to some pre-made styles out of the box. This helps to make our views look a bit prettier.</p></div><p>Finally, in our router middleware, we can <span>specify</span><a id="id326018530" class="indexterm"></a> that the file <span>should</span><a id="id326018538" class="indexterm"></a> be served using the now-available <code class="literal">ctx.render()</code> method as seen here:</p><pre class="programlisting">// ./middleware/router.js

router.get('/', ctx =&gt; ctx.render('index'));</pre><p>Now when we visit our index route, instead of plain text we should see the <code class="literal">index.ejs</code> file rendered as HTML as seen here:</p><div class="mediaobject"><img src="/graphics/9781789345391/graphics/45780dba-6e18-42c4-8503-d4086041145e.png" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec10"></a>Using partials</h4></div></div></div><p>To keep our template code reusable, we can <span>introduce</span><a id="id326019056" class="indexterm"></a> partials. We will essentially create two partials given here:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">header.ejs</code>: to contain all the markup common to our application's header</li><li style="list-style-type: disc"><code class="literal">footer.ejs</code>: similarly, to contain all common footer specific markup</li></ul></div><p>Both partials will be placed in a <code class="literal">partials</code> folder within the <code class="literal">views</code> folder. We can create both files and place the required contents in them. For the <code class="literal">header</code> file, use the code given:</p><pre class="programlisting">&lt;!-- ./views/partials/header.ejs --&gt;

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
  &lt;title&gt;Welcome - KoaBlog&lt;/title&gt;
  &lt;link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.min.css"&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;section class="section"&gt;
    &lt;div class="container"&gt;
      &lt;div class="columns"&gt;
        &lt;div class="column"&gt;
          &lt;h1 class="title"&gt;&lt;a href="/"&gt;KoaBlog&lt;/a&gt;&lt;/h1&gt;
          &lt;p class="subtitle"&gt;Blog built with Koa!&lt;/p&gt;
        &lt;/div&gt;
      &lt;/div&gt;</pre><p>We should also insert the following code block into the <code class="literal">footer.ejs</code> file:</p><pre class="programlisting">&lt;!-- ./views/partials/footer.ejs --&gt;

    &lt;/div&gt;
  &lt;/section&gt;
&lt;/body&gt;
&lt;/html&gt;</pre><p>Next, we can include them in the <code class="literal">index.ejs</code> file <span>using</span><a id="id326032761" class="indexterm"></a> the include helper function available within <code class="literal">ejs</code> as shown:</p><pre class="programlisting">&lt;!-- ./views/index.ejs --&gt;

&lt;%- include( 'partials/header.ejs' ) -%&gt; 

&lt;%- include( 'partials/footer.ejs' ) -%&gt;</pre><p>Now that we have our views implemented, we can go ahead to set up authentication on our app to protect some of the views that we will create.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec37"></a>Setting up sessions</h3></div></div></div><p>Before implementing authentication, we need to set up a session middleware for our application. This will help us store data relating to each browser session, and we will be <span>using</span><a id="id326032786" class="indexterm"></a> to store user details for each logged-in user.</p><p>To help us handle sessions, we will be using the <code class="literal">koa-session</code> middleware. To register it, let's update the <code class="literal">./index.js</code> file as shown:</p><pre class="programlisting">// ./index.js

// ...
const session = require('koa-session');

app.keys = ['secret key'];

app.use(session(app));

// ...</pre><p>Registering the <code class="literal">koa-session</code> middleware makes the <code class="literal">ctx.session</code> object available throughout our app, making it possible for us to use it to store and retrieve session data per user.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec38"></a>Handling authentication</h3></div></div></div><p>In this section, we will implement authentication on our app, to ensure that only <span>registered</span><a id="id326032824" class="indexterm"></a> users can carry out certain operations. To set up authentication, we need to <span>implement</span><a id="id326033038" class="indexterm"></a> the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><span class="strong"><strong>User registration and login</strong></span>: This involves <span>creating</span><a id="id326033056" class="indexterm"></a> views and <span>actions</span><a id="id326033064" class="indexterm"></a> for users to sign up and then log in to the application</li><li style="list-style-type: disc"><span class="strong"><strong>Authentication middleware</strong></span>: This <span>involves</span><a id="id326033078" class="indexterm"></a> implementing middleware to restrict and grant access to certain resources based on the visitor's authentication status</li></ul></div><p>Before we can implement registration and login, however, we need to register our body parser plugin, which will enable us to retrieve form data. We can easily do this in the <code class="literal">index.js</code> file, as shown here:</p><pre class="programlisting">// ./index.js

// ...
const bodyParser = require('koa-body');

app.use(bodyParser());

// ...</pre><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec11"></a>User registration and login</h4></div></div></div><p>To implement user registration and login, first, we will <span>create</span><a id="id326033105" class="indexterm"></a> an <code class="literal">auth</code> page that will house the two forms that we will use for registration and login. We can <span>create</span><a id="id326033116" class="indexterm"></a> the form view in the <code class="literal">views</code> folder and name it <code class="literal">auth.ejs</code>. Insert the following content into the file:</p><pre class="programlisting">&lt;%- include( 'partials/header.ejs' ) -%&gt; 
&lt;div class="columns"&gt;
  &lt;div class="column"&gt;
    &lt;h1 class="title"&gt;Register&lt;/h1&gt;

    &lt;form action="/auth/register" method="POST"&gt;
      &lt;div class="field"&gt;
        &lt;label class="label"&gt;Full Name&lt;/label&gt;
        &lt;div class="control"&gt;
          &lt;input class="input" type="text" placeholder="e.g Alex Smith" 
          name="fullName"&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div class="field"&gt;
        &lt;label class="label"&gt;Email&lt;/label&gt;
        &lt;div class="control"&gt;
          &lt;input class="input" type="email" placeholder="e.g. 
          alexsmith@gmail.com" name="email"&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div class="field"&gt;
        &lt;label class="label"&gt;Password&lt;/label&gt;
        &lt;div class="control"&gt;
          &lt;input class="input" type="password" name="password"&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div class="control"&gt;
        &lt;button class="button is-primary"&gt;Submit&lt;/button&gt;
      &lt;/div&gt;
    &lt;/form&gt;
  &lt;/div&gt;

  &lt;div class="column"&gt;
    &lt;h1 class="title"&gt;Login&lt;/h1&gt;

    &lt;form action="/auth/login" method="POST"&gt;
      &lt;div class="field"&gt;
        &lt;label class="label"&gt;Email&lt;/label&gt;
        &lt;div class="control"&gt;
          &lt;input class="input" type="email" placeholder="e.g. 
           alexsmith@gmail.com" name="email"&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div class="field"&gt;
        &lt;label class="label"&gt;Password&lt;/label&gt;
        &lt;div class="control"&gt;
          &lt;input class="input" type="password" name="password"&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div class="control"&gt;
        &lt;button class="button is-primary"&gt;Submit&lt;/button&gt;
      &lt;/div&gt;
    &lt;/form&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;%- include( 'partials/footer.ejs' ) -%&gt; </pre><p> </p><p>Now that we have our forms created, let's <span>create</span><a id="id326033141" class="indexterm"></a> the controller <span>actions</span><a id="id326033149" class="indexterm"></a> for serving and handling the forms. We will create an <code class="literal">AuthController</code> file in the <code class="literal">controllers</code> folder to hold all the actions needed. Insert the following content into the file:</p><pre class="programlisting">// ./controllers/AuthController.js

const User = require('../models/User');
const bcrypt = require('bcrypt');
const BCRYPT_SALT_ROUNDS = 12;

module.exports = {
  async index(ctx) {
    ctx.state = { title: 'Login or Register' };
    await ctx.render('auth');
  },

  async register(ctx) {
    const { body } = ctx.request;
    const userData = {
      ...body,
      password: await bcrypt.hash(body.password, BCRYPT_SALT_ROUNDS)
    };
    const user = await new User(userData).save();
    ctx.session.user = user;
    ctx.redirect('/');
  },

  async login(ctx) {
    const { body } = ctx.request;
    const user = await User.findOne({ email: body.email });
    if (!user) ctx.throw(404, 'user not found');
    const isValid = await bcrypt.compare(body.password, user.password);
    if (isValid) {
      ctx.session.user = user;
      ctx.redirect('/');
    } else {
      ctx.redirect('/auth');
    }
  },

  async logout(ctx) {
    delete ctx.session.user;
    ctx.redirect('/auth');
  }
};</pre><p>The controller created <span>contains</span><a id="id326033889" class="indexterm"></a> three <span>methods</span><a id="id326033897" class="indexterm"></a> that are given here:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">index</code>: This loads the <code class="literal">auth</code> page and shows the register and login forms.</li><li style="list-style-type: disc"><code class="literal">register</code>: This handles registration by doing the following:
<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Getting the user data submitted in the form.</li><li style="list-style-type: disc">Generating a hash of the user password using the <code class="literal">bcrypt</code> library.</li><li style="list-style-type: disc">Saving the user to the database.</li><li style="list-style-type: disc">Setting the user in the current session.</li><li style="list-style-type: disc">Redirecting the user to the home page.</li></ul></div></li><li style="list-style-type: disc"><code class="literal">login</code>: This handles user login by doing the following:
<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Getting the user data submitted via the form.</li><li style="list-style-type: disc">Retrieving a user matching the email address from the database.</li><li style="list-style-type: disc">Comparing the password supplied to the one in the database using the <code class="literal">bcrypt</code> library.</li><li style="list-style-type: disc">Setting the user in the current session if the password supplied is correct.</li><li style="list-style-type: disc">Redirecting the user based on the correctness of the password supplied.</li></ul></div></li><li style="list-style-type: disc"><code class="literal">logout</code>: This removes the user object from the session object. This means our application will no longer recognize the user as logged in.</li></ul></div><p>Next, we register these actions in our <code class="literal">router.js</code> file:</p><pre class="programlisting">// ./middleware/router.js

// ...

// we are passing the title variable to the view now
router.get('/', ctx =&gt; ctx.render('index', { title: 'Welcome' }));

const authController = require('../controllers/AuthController');

// auth routes
const auth = new KoaRouter()
  .get('/', authController.index)
  .post('/login', authController.login)
  .post('/register', authController.register)
  .get('/logout', authController.logout);
router.use('/auth', auth.routes());

// ...</pre><p>In the preceding code block, we create a new router instance for the <code class="literal">auth</code> routes and register them as sub-routes under our main router using <code class="literal">router.use('/auth', auth.routes())</code>. This means that all the <code class="literal">auth</code> routes will be accessible under the  <code class="literal">'/auth'</code> group.</p><p>We will also make changes to our <code class="literal"><span>header</span><a id="id326277943" class="indexterm"></a></code> file to <span>show</span><a id="id326277952" class="indexterm"></a> our page title, include a link to the <code class="literal">login/register</code> page, and show the current user if the person is logged in. Update the <code class="literal">header</code> file as shown:</p><pre class="programlisting">&lt;!-- ./views/partials/header.ejs --&gt;

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
  &lt;title&gt;&lt;%= title %&gt; - KoaBlog&lt;/title&gt;
  &lt;link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.min.css"&gt;
  &lt;script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;section class="section"&gt;
    &lt;div class="container"&gt;
      &lt;div class="columns"&gt;
        &lt;div class="column"&gt;
          &lt;h1 class="title"&gt;&lt;a href="/"&gt;KoaBlog&lt;/a&gt;&lt;/h1&gt;
          &lt;p class="subtitle"&gt;Blog built with Koa!&lt;/p&gt;
        &lt;/div&gt;

        &lt;div class="column"&gt;
          &lt;div class="has-text-grey-dark has-text-right"&gt;
            &lt;% if (locals.user) { %&gt;
            &lt;p&gt;
              Hi, &lt;%= user.fullName %&gt;. &lt;a 
              href="/auth/logout"&gt;Logout&lt;/a&gt;&lt;br&gt;
            &lt;/p&gt;
            &lt;% } else { %&gt;
            &lt;p&gt;&lt;a href="/auth"&gt;Login/Register&lt;/a&gt;&lt;/p&gt;
            &lt;% } %&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;hr&gt;</pre><p>Note that the user variable <span>used</span><a id="id326291559" class="indexterm"></a> in the preceding <span>template</span><a id="id326291568" class="indexterm"></a> has not yet been passed to the view. We will do that in the next step when we define authentication middleware. </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec12"></a>Authentication middleware</h4></div></div></div><p>We will be defining three simple <span>middlewares</span><a id="id326291584" class="indexterm"></a> to help with authentication. They are explained here:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">authenticated</code>: This is the middleware that ensures a user is signed in before they can have access to a resource. We define it by creating an <code class="literal">authenticated.js</code> file and putting the following content in it:</li></ul></div><pre class="programlisting">// ./middleware/authenticated.js

module.exports = () =&gt; {
  return async (ctx, next) =&gt; {
    const { user } = ctx.session;
    if (user) await next();
    else ctx.redirect('/auth');
  };
};</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">guest</code>: This middleware ensures that only not logged-in users can access a resource. We can define it by creating a <code class="literal">guest.js</code> in the <code class="literal">middleware</code> folder and putting the following content in it:</li></ul></div><pre class="programlisting">      // ./middleware/guest.js

      module.exports = () =&gt; {
        return async (ctx, next) =&gt; {
          const { user } = ctx.session;
          if (user) ctx.redirect('/');
          else await next();
        };
      };</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">user</code>: This middleware simply takes the current user in the session and makes it available in <code class="literal">ctx.state</code>, which is then passed to the views. We can define it by <span>creating</span><a id="id326291808" class="indexterm"></a> <code class="literal">user.js</code> in the <code class="literal">middleware</code> folder and putting the following content in it:</li></ul></div><pre class="programlisting">      // ./middleware/user.js

      module.exports = () =&gt; {
        return async (ctx, next) =&gt; {
          const { user } = ctx.session;
          if (user) ctx.state = { ...ctx.state, user };
          await next();
        };
      };</pre><p>Next, we can register all three middlewares by updating our <code class="literal">router</code> file as shown:</p><pre class="programlisting">// ./middleware/router.js

const authenticated = require('./authenticated');
const guest = require('./guest');
const user = require('./user');

router.use(user());

const auth = new KoaRouter()
  .get('/', guest(), authController.index)
  .post('/login', authController.login)
  .post('/register', authController.register)
  .get('/logout', authController.logout);
router.use('/auth', auth.routes());</pre><p>Now we can register, sign in, and sign out of our app! Next, we will <span>implement</span><a id="id326291838" class="indexterm"></a> the different actions needed for our blog posts.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl3sec13"></a>Creating controller functions</h4></div></div></div><p>Finally, we will create controller methods for the <span>various</span><a id="id326291853" class="indexterm"></a> actions we want our application to be able to carry out. These include the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">Index</code>: View all blog posts</li><li style="list-style-type: disc"><code class="literal">Create</code>: View a form to create a new blog post</li><li style="list-style-type: disc"><code class="literal">Store</code>: Save a new blog post to the database</li><li style="list-style-type: disc"><code class="literal">Show</code>: View a single blog post</li><li style="list-style-type: disc"><code class="literal">Edit</code>: View a form to edit a blog post</li><li style="list-style-type: disc"><code class="literal">Update</code>: Update a blog post in the database</li></ul></div><p>Let's create a controller file for our post actions name <code class="literal">PostController</code> in the <code class="literal">controllers</code> folder, and insert the following contents into it:</p><pre class="programlisting">// ./controllers/PostController.js

const Post = require('../models/Post');

module.exports = {
  async index(ctx) {
    const posts = await Post.find()
    .populate('author');
    ctx.state.posts = posts;
    ctx.state.title = 'Home';
    await ctx.render('index');
  },

  async create(ctx) {
    ctx.state.title = 'Create Post';
    await ctx.render('post/create');
  },

  async store(ctx) {
    const { body } = ctx.request;
    const postData = {
      ...body,
      author: ctx.session.user,
      image: 'https://picsum.photos/300/?random'
    };
    const post = await new Post(postData).save();
    ctx.redirect(`/post/${post.id}`);
  },

  async show(ctx) {
    const { id } = ctx.params;
    try {
      const post = await Post.findById(id).populate('author');
      ctx.state.post = post;
      ctx.state.title = post.title;
    } catch(e) {
      ctx.throw(404, "Post not found");
    }
    await ctx.render('post/show');
  },

  async edit(ctx) {
    const { id } = ctx.params;
    try {
      const post = await Post.findById(id).populate('author');
      ctx.state.post = post;
      ctx.state.title = `Edit Post - ${post.title}`;
    } catch(e) {
      ctx.throw(404, "Post not found");
    }
    await ctx.render('post/edit');
  },

  async update(ctx) {
    const { id } = ctx.params;
    const { body } = ctx.request;
    try {
      const postData = { ...body, createdAt: new Date() }
      const post = await Post.findByIdAndUpdate(id, postData);
      ctx.redirect(`/post/${post.id}`);
    } catch(e) {
      ctx.throw(e);
    }
  }
};</pre><p>We also need to create the corresponding <span>template</span><a id="id326393079" class="indexterm"></a> files for the needed actions. Let's create a post folder in the <code class="literal">views</code> folder to house the post specific views needed. This will contain the following files:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">create.ejs</code>:</li></ul></div><pre class="programlisting">      &lt;%- include( '../partials/header.ejs' ) -%&gt; 
      &lt;div class="columns"&gt;
        &lt;div class="column is-three-quarters"&gt;
          &lt;h1 class="title"&gt;Create Post&lt;/h1&gt;

          &lt;form action="/post/" method="POST"&gt;
           &lt;div class="field"&gt;
             &lt;label class="label"&gt;Title&lt;/label&gt;
             &lt;div class="control"&gt;
               &lt;input class="input" type="text" placeholder="e.g Koa is 
                awesome" name="title"&gt;
                  &lt;/div&gt;
               &lt;/div&gt;

            &lt;div class="field"&gt;
              &lt;label class="label"&gt;Content&lt;/label&gt;
             &lt;div class="control"&gt;
               &lt;textarea rows="12" class="textarea" placeholder="e.g. 
               Hello world" name="content"&gt;&lt;/textarea&gt;
              &lt;/div&gt;
            &lt;/div&gt;

            &lt;div class="control"&gt;
              &lt;button class="button is-primary"&gt;Submit&lt;/button&gt;
            &lt;/div&gt;
          &lt;/form&gt;
        &lt;/div&gt;

        &lt;div class="column"&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;%- include( '../partials/footer.ejs' ) -%&gt; </pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">edit.ejs</code>:</li></ul></div><pre class="programlisting">      &lt;%- include( '../partials/header.ejs' ) -%&gt; 
      &lt;div class="columns"&gt;
        &lt;div class="column is-three-quarters"&gt;
          &lt;h1 class="title"&gt;Create Post&lt;/h1&gt;

          &lt;form action="/post/&lt;%= post.id %&gt;/" method="POST"&gt;
            &lt;input type="hidden" name="method" value="PUT"&gt;
            &lt;div class="field"&gt;
              &lt;label class="label"&gt;Title&lt;/label&gt;
              &lt;div class="control"&gt;
                &lt;input value="&lt;%= post.title %&gt;" class="input" 
               type="text" placeholder="e.g Koa is awesome" 
               name="title"&gt;
              &lt;/div&gt;
            &lt;/div&gt;

            &lt;div class="field"&gt;
              &lt;label class="label"&gt;Content&lt;/label&gt;
              &lt;div class="control"&gt;
                &lt;textarea rows="12" class="textarea" placeholder="e.g. 
                Hello world" name="content"&gt;&lt;%= post.content %&gt;
                &lt;/textarea&gt;
              &lt;/div&gt;
            &lt;/div&gt;

            &lt;div class="control"&gt;
              &lt;button class="button is-primary"&gt;Submit&lt;/button&gt;
            &lt;/div&gt;
          &lt;/form&gt;
       &lt;/div&gt;

        &lt;div class="column"&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;%- include( '../partials/footer.ejs' ) -%&gt; </pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">show.ejs</code>:</li></ul></div><pre class="programlisting">      &lt;%- include( '../partials/header.ejs' ) -%&gt; 
      &lt;h2 class="title"&gt;&lt;%= post.title %&gt;&lt;/h2&gt;

      &lt;div class="columns"&gt;
       &lt;div class="column is-2"&gt;
       &lt;img src="&lt;%= post.image %&gt;" alt="&lt;%= post.title %&gt;"&gt;
       &lt;h5 class="subtitle"&gt;
        &lt;small&gt;by &lt;%= post.author.fullName %&gt;&lt;/small&gt;
       &lt;/h5&gt;
       &lt;% if (locals.user &amp;&amp; (post.author.id == user._id)) { -%&gt;
       &lt;p&gt;&lt;small&gt;&lt;a href="/post/&lt;%= post.id %&gt;/edit"&gt;Edit Post&lt;/a&gt;
        &lt;/small&gt;&lt;/p&gt;
       &lt;% } -%&gt;
       &lt;/div&gt;

       &lt;div class="column"&gt;
       &lt;p&gt;&lt;%= post.content %&gt;&lt;/p&gt;
      &lt;/div&gt;
      &lt;/div&gt;
      &lt;%- include( '../partials/footer.ejs' ) -%&gt; </pre><p>We also need to <span>update</span><a id="id326393129" class="indexterm"></a> our <code class="literal">index.ejs</code> file, as shown, to show the blog posts:</p><pre class="programlisting">&lt;!-- ./views/index.ejs --&gt;

&lt;%- include( 'partials/header.ejs' ) -%&gt; 
&lt;div class="columns"&gt;
  &lt;% posts.forEach(post =&gt; { %&gt;

  &lt;div class="column is-one-third"&gt;
    &lt;div class="card"&gt;
      &lt;div class="card-content"&gt;
        &lt;p class="title"&gt;
          &lt;%= post.title %&gt;
        &lt;/p&gt;
        &lt;p class="subtitle"&gt;
          &lt;small&gt;by &lt;%= post.author.fullName %&gt;&lt;/small&gt;
        &lt;/p&gt;
      &lt;/div&gt;
      &lt;footer class="card-footer"&gt;
        &lt;p class="card-footer-item"&gt;
          &lt;span&gt;
            &lt;a href="/post/&lt;%= post.id %&gt;"&gt;View Post&lt;/a&gt;
          &lt;/span&gt;
        &lt;/p&gt;
      &lt;/footer&gt;
    &lt;/div&gt;
  &lt;/div&gt;

  &lt;% }); %&gt;
&lt;/div&gt;
&lt;%- include( 'partials/footer.ejs' ) -%&gt; </pre><p>Next, let's register these actions in our router file. We will also make the index route of our application point to the index method defined previously. Update the router as shown:</p><pre class="programlisting">// ./middleware/router.js

const KoaRouter = require('koa-router');
const authenticated = require('./authenticated');
const guest = require('./guest');
const user = require('./user');
const authController = require('../controllers/AuthController');
const postController = require('../controllers/PostController');

const router = new KoaRouter();
router.use(user());

// base routes.
// authentication not required
router
 .get('/', postController.index)
 .get('/post/:id', postController.show);

// auth routes
const auth = new KoaRouter()
 .get('/', guest(), authController.index)
 .post('/login', authController.login)
 .post('/register', authController.register)
 .get('/logout', authController.logout);
router.use('/auth', auth.routes());

// blog post routes
const posts = new KoaRouter();
posts
 .use(authenticated())
 .post('/', postController.store)
 .get('/create', postController.create)
 .put('/:id', postController.update)
 .get('/:id/edit', postController.edit);
router.use('/post', posts.routes());

module.exports = router;</pre><p>To make put requests work, we need to implement a method overriding middleware. This will help us change the request method for the <code class="literal">post</code> request to <span>update</span><a id="id326393157" class="indexterm"></a> a post to be converted to a <code class="literal">put</code> request. We do this by creating a <code class="literal">method-override.js</code> file and putting the following contents as shown:</p><pre class="programlisting">// ./middleware/method-override.js

module.exports = () =&gt; {
  return async (ctx, next) =&gt; {
    const { method } = ctx.request.body;
    if (method) ctx.method = method;
    await next();
  };
};</pre><p>Then, we register the middleware in our <code class="literal">index.js</code> as given:</p><pre class="programlisting">// ./index.js

// ...

const methodOverride = require('./middleware/method-override');

app.use(methodOverride());

// ...</pre><p>And that's it! Our blog post built from <span>scratch</span><a id="id326432785" class="indexterm"></a> in Koa is complete.</p></div></div></div>