<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec28"></a>The context object</h2></div></div><hr /></div><p>The Koa c<span>ontext object</span> usually referred to as <code class="literal">ctx</code> is a <span>combination</span><a id="id325859261" class="indexterm"></a> of Node's request and response objects into a single object. A new context is created per request. It can be accessed in a middleware function as the first argument in the function.</p><p>It is often referenced in middleware as the <code class="literal">ctx</code> identifier, as seen in the following example:</p><pre class="programlisting">app.use(async ctx =&gt; {
  ctx; // context object
  ctx.request; // Request object
  ctx.response; // Response object
});</pre><p>The context object contains methods and properties which either belong specifically to the object or are aliases of methods and properties in the request and response objects.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note8"></a>Note</h3><p>Both the request and response objects will be discussed in detail in later sections</p></div><p> </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec10"></a>Context object API</h3></div></div></div><p>The context object exposes various methods and <span>properties</span><a id="id325756458" class="indexterm"></a> to help with HTTP application development and middleware creation. In this way, Koa varies from its predecessor, Express, in that the many functions needed for development can be accessed simply via the context object instead of needing to access the request (<code class="literal">req</code>) and response (<code class="literal">res</code>) objects separately.</p><p>Some of the methods and properties exposed on the Context <span>object</span><a id="id325756437" class="indexterm"></a> include the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">ctx.req</code>: This serves as a reference to the request object in Node. Note that this differs from the Koa request object.</li></ul></div><p>For example, you can access an object containing the request headers by using the <code class="literal">req.headers</code> property, as seen here:</p><pre class="programlisting">console.log(ctx.req.headers);

// =&gt; { host: 'localhost:1234',
//  'user-agent': 'curl/7.54.0',
//  accept: '*/*' }</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal"><span>ctx</span>.res</code>: Similar to <code class="literal">ctx.req</code>, this serves as a reference to the response object in Node. Note that bypassing Koa's response handling is not supported by Koa currently. Hence, Node response methods that directly attempt to write or manipulate the response body should be avoided, such as the following:<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">res.statusCode</code></li><li style="list-style-type: disc"><code class="literal">res.writeHead()</code></li><li style="list-style-type: disc"><code class="literal">res.write()</code></li><li style="list-style-type: disc"><code class="literal">res.end()</code></li></ul></div></li></ul></div><p>The <code class="literal">ctx.res</code> object can be used in the following manner:</p><pre class="programlisting">ctx.res.setHeader('Content-Type', 'text/html');

console.log(ctx.res.getHeader('Content-Type'));
// =&gt; text/html</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal"><span>ctx.</span>request:</code>This is an instance of the Koa request object. It provides access to all the request related methods and properties needed for HTTP application development. This object will be discussed in further details in later sections.</li></ul></div><p> </p><p>The request object can be used, for example, to retrieve the origin of a request, as seen in the example here:</p><pre class="programlisting">console.log(ctx.request.origin);

// =&gt; http://localhost:1234</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal"><span>ctx</span>.response</code>: This is an instance of the Koa response object. Similar to the Koa request object, it provides everyday functionality for building out HTTP applications. It will also be discussed in more detail in later sections of this chapter.</li></ul></div><p>Here is an example of how you can use the response <span>object</span><a id="id325754363" class="indexterm"></a> to set the HTTP status for a response in Koa:</p><pre class="programlisting">ctx.response.status = 200;

console.log(ctx.response.message);
// =&gt; Ok</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal"><span>ctx</span>.state</code>: This is the namespace recommend by Koa for passing data throughout your application. A good use case of this is passing some data across middleware and to your views, as seen in this example:</li></ul></div><pre class="programlisting">      // middleware for retrieving user details
      app.use(async ctx =&gt; {
        ctx.state.user = await User.find(id);
      });

      // middleware to send response back to user
      app.use(async ctx =&gt; {
        const { user } = ctx.state;
       ctx.body = `Hello, ${user.name}`;
      });</pre><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal"><span>ctx</span>.app</code>: This is a reference to the Koa application instance discussed earlier in this chapter. This reference allows us to make use of the application object in our middleware. For example, this is a middleware we can use to log information depending on the environment our application is running in:</li></ul></div><pre class="programlisting">      app.use(async (ctx, next) =&gt; {
        const { env } = ctx.app;
        if (env === 'development') {
          console.log(`request made to ${ctx.request.url}`);
        }
        await next();
      });</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal"><span>ctx</span>.cookies</code>: This object consists of two methods for interacting with cookies. Koa uses the <code class="literal">cookies</code>module and simply passes the options. The two methods available for use are:<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">ctx.cookies.get(name, [options])</code>: This returns the value of a cookie named <code class="literal">name</code>with<code class="literal">options</code>.</li><li style="list-style-type: disc"><code class="literal">ctx.cookies.set(name, [options])</code>: This sets cookie <code class="literal">name</code>with<code class="literal">options</code>.</li></ul></div></li></ul></div><p>These methods can be used in the <span>following</span><a id="id325876656" class="indexterm"></a> manner:</p><pre class="programlisting">ctx.cookies.set('SESSION_ID', '1234');

// after response has been sent and the
// cookie has been set on the client
console.log(ctx.cookies.get('SESSION_ID'));
// =&gt; 1234</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal"><span>ctx.</span>throw([status], [msg], [properties])</code>: This is a helper method that throws an HTTP error with a status as a response. This makes use of the <code class="literal">http-errors</code>module. Here are some simple example usages of the method:</li></ul></div><pre class="programlisting">      ctx.throw(401);
      ctx.throw(401, 'Unauthorized');
      ctx.throw(401, 'Unathourized', { user });</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal"><span>ctx</span>.assert(value, [status], [msg], [properties])</code>: This is a helper method that throws an error similar to the <code class="literal">ctx.throw</code>method when value is a<code class="literal">false value</code>. Koa makes use of<code class="literal">http-assert</code>for assertions.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">ctx.respond</code>: Koa's default response handling can be turned off by explicitly setting <code class="literal">ctx.respond</code>to<code class="literal">false</code>. This can be used if a decision is made to manually write to the<code class="literal">res</code>object, instead of utilizing Koa's response handling.<span>This behavior is currently not supported by Koa and could cause unexpected results</span>.</li></ul></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl3sec0"></a>Aliases</h4></div></div></div><p>The context object exposes <span>aliases</span><a id="id326432109" class="indexterm"></a> for common-use properties and methods the request and response objects. These are present to make development faster and reduce the amount of code developers need to write.</p><p>For example, the <code class="literal">.header</code> property that exists in the request object can be accessed directly from the context object, as seen in the code block as follows:</p><pre class="programlisting">console.log(ctx.header);

// =&gt; { host: 'localhost:1234',
//  'user-agent': 'curl/7.54.0',
//  accept: '*/</pre><p>Similarly, the <code class="literal">.body</code> setter that exists in the response object can be accessed directly via the context object, as seen in the following code block:</p><pre class="programlisting">ctx.body = 'Hello, World';</pre><p>These are the aliases present for the <code class="literal">Request</code> object:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">ctx.header</code></li><li style="list-style-type: disc"><code class="literal">ctx.headers</code></li><li style="list-style-type: disc"><code class="literal">ctx.method</code></li><li style="list-style-type: disc"><code class="literal">ctx.method=</code></li><li style="list-style-type: disc"><code class="literal">ctx.url</code></li><li style="list-style-type: disc"><code class="literal">ctx.url=</code></li><li style="list-style-type: disc"><code class="literal">ctx.originalUrl</code></li><li style="list-style-type: disc"><code class="literal">ctx.origin</code></li><li style="list-style-type: disc"><code class="literal">ctx.href</code></li><li style="list-style-type: disc"><code class="literal"><code class="literal">ctx.path</code></code></li><li style="list-style-type: disc"><code class="literal">ctx.path=</code></li><li style="list-style-type: disc"><code class="literal">ctx.query</code></li><li style="list-style-type: disc"><code class="literal">ctx.query=</code></li><li style="list-style-type: disc"><code class="literal">ctx.querystring</code></li><li style="list-style-type: disc"><code class="literal">ctx.querystring=</code></li><li style="list-style-type: disc"><code class="literal">ctx.host</code></li><li style="list-style-type: disc"><code class="literal">ctx.hostname</code></li><li style="list-style-type: disc"><code class="literal">ctx.fresh</code></li><li style="list-style-type: disc"><code class="literal">ctx.stale</code></li><li style="list-style-type: disc"><code class="literal">ctx.socket</code></li><li style="list-style-type: disc"><code class="literal">ctx.protocol</code></li><li style="list-style-type: disc"><code class="literal">ctx.secure</code></li><li style="list-style-type: disc"><code class="literal">ctx.ip</code></li><li style="list-style-type: disc"><code class="literal">ctx.ips</code></li><li style="list-style-type: disc"><code class="literal">ctx.subdomains</code></li><li style="list-style-type: disc"><code class="literal">ctx.is()</code></li><li style="list-style-type: disc"><code class="literal">ctx.accepts()</code></li><li style="list-style-type: disc"><code class="literal">ctx.acceptsEncodings()</code></li><li style="list-style-type: disc"><code class="literal">ctx.acceptsCharsets()</code></li><li style="list-style-type: disc"><code class="literal">ctx.acceptsLanguages()</code></li><li style="list-style-type: disc"><code class="literal">ctx.get()</code></li></ul></div><p>These are the <span>aliases</span><a id="id325880181" class="indexterm"></a> present for the <code class="literal">Response</code> object:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">ctx.body</code></li><li style="list-style-type: disc"><code class="literal">ctx.body=</code></li><li style="list-style-type: disc"><code class="literal">ctx.status</code></li><li style="list-style-type: disc"><code class="literal">ctx.status=</code></li><li style="list-style-type: disc"><code class="literal">ctx.message</code></li><li style="list-style-type: disc"><code class="literal">ctx.message=</code></li><li style="list-style-type: disc"><code class="literal">ctx.length=</code></li><li style="list-style-type: disc"><code class="literal">ctx.length</code></li><li style="list-style-type: disc"><code class="literal"><code class="literal">ctx.type=</code></code></li><li style="list-style-type: disc"><code class="literal">ctx.type</code></li><li style="list-style-type: disc"><code class="literal">ctx.headerSent</code></li><li style="list-style-type: disc"><code class="literal">ctx.redirect()</code></li><li style="list-style-type: disc"><code class="literal">ctx.attachment()</code></li><li style="list-style-type: disc"><code class="literal">ctx.set()</code></li><li style="list-style-type: disc"><code class="literal">ctx.append()</code></li><li style="list-style-type: disc"><code class="literal">ctx.remove()</code></li><li style="list-style-type: disc"><code class="literal">ctx.lastModified=</code></li><li style="list-style-type: disc"><code class="literal">ctx.etag=</code></li></ul></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec11"></a>The request object</h3></div></div></div><p>The Koa request object is similar to the <span>request</span><a id="id325887259" class="indexterm"></a> object in Node and Express. It can be described as an abstraction of Node's request object. It provides added functionality with its properties and methods for building out everyday HTTP servers.</p><p>The methods and properties it exposes include the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.header</code>: This returns an object <span>containing</span><a id="id325887277" class="indexterm"></a> the <span>request</span><a id="id325891861" class="indexterm"></a> headers. This is aliased in the context object, and can also be accessed with <code class="literal">ctx.header</code>. The following code block shows example usage of how the<code class="literal">request.header</code>property can be used to retrieve and log the headers from a request:</li></ul></div><pre class="programlisting">      // log the request headers

      console.log(ctx.header);
      // or
      console.log(ctx.request.header);</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.header=</code>: This can be used to set the request header object. This can also be accessed with the <code class="literal">ctx.header=</code>alias. In the following code block, we create a middleware to set the request header before passing control to the next middleware:</li></ul></div><pre class="programlisting">      // set request header
      app.use(async (ctx, next) =&gt; {
        const header = {
          'accept-encoding': 'gzip'
          // .. other header values
        };
        ctx.request.header = header;
        await next();
      });

      // send response back
      app.use(async ctx =&gt; {
        console.log(ctx.request.header)
        ctx.body = 'Hello World';
      });</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.headers</code>: This is used to access the <span>request</span><a id="id325891906" class="indexterm"></a> header object. It is an <span>alias</span><a id="id325891914" class="indexterm"></a> of the <code class="literal">request.header</code>property. It can be used in a similar manner to the<code class="literal">request.header</code>property as seen here:</li></ul></div><pre class="programlisting">     console.log(ctx.request.headers);

      // =&gt; { host: 'localhost:1234',
      //  'user-agent': 'curl/7.54.0',
      //  accept: '*/*' }</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.headers=</code>: This is used to set the request header object. It is an alias of the <code class="literal">request.header=</code> method. It can also be used to set request headers as seen here:</li></ul></div><pre class="programlisting">      ctx.request.headers = {
         'accept-encoding': 'gzip'
      };</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.method</code>: This is used to access the request method. This is particularly useful for situations where you need to decide on whether to carry out an action based on the HTTP method used. An example can be seen in the code block here:</li></ul></div><pre class="programlisting">      app.use(async ctx =&gt; {
        const { method } = ctx.request;
        if (method === 'POST') {
           // carry out validation
        }
      });</pre><p> </p><p> </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.method=</code>: This is used to set the request method. A good use case of this is to implement the popular <code class="literal">methodOverrides()</code>middleware. With this, you can modify request methods to fit what you have defined in your application. This is especially <span>useful</span><a id="id325902595" class="indexterm"></a> when you have a <span>client</span><a id="id325902603" class="indexterm"></a> that only supports simple HTTP verbs such as<code class="literal">GET</code>and<code class="literal">POST</code>. Here is an example of its usage:</li></ul></div><pre class="programlisting">      // override request method
      app.use(async (ctx, next) =&gt; {
              const { method } = ctx.request.query;
        if (method) {
          ctx.request.method = method;
        }
        await next();
      });</pre><p>The preceding example code checks whether a custom method type has been passed in the request query string, then overrides the request to fit the desired method.</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.length</code>: This returns the request <code class="literal">Content-Length</code>as a number, or<code class="literal">undefined</code>when the<code class="literal">Content-Length</code>is absent. A request with some data in the request body will show how this property works in the example here:</li></ul></div><pre class="programlisting">      // curl -X POST --data "test data" http://localhost:1234

      console.log(ctx.request.length);
      // =&gt; 9</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.url</code>: This returns the request URL.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.url=</code>: This sets the request URL. The following block can be used for URL rewriting:</li></ul></div><pre class="programlisting">      // url rewrite middleware
      app.use(async (ctx, next) =&gt; {
       ctx.request.url = '/hello';
       await next();
      });</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.originalUrl</code>: This returns the request original URL. For a simple app that implements a rewrite to the <code class="literal">/hello</code>route, a visit to the base<code class="literal">/</code>route <span>would</span><a id="id325905142" class="indexterm"></a> produce the <span>following</span><a id="id325905150" class="indexterm"></a> results:</li></ul></div><pre class="programlisting">      // rewrite url
      app.use(async (ctx, next) =&gt; {
        ctx.request.url = '/hello';
        await next();
      });

      app.use(async ctx =&gt; {
        console.log(ctx.request.url);
        // =&gt; /hello
        console.log(ctx.request.originalUrl);
        // =&gt; /
        ctx.body = 'Hello World';
      });</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.origin</code>: This returns the origin of URL, including the host and protocol. <span>For</span> a local app running on port <code class="literal">1234</code>:</li></ul></div><pre class="programlisting">      console.log(ctx.request.origin);
      // =&gt; http://localhost:1234</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.href</code>: This returns the full request URL with the <code class="literal">protocol</code>,<code class="literal">host</code>, and<code class="literal">url</code>:</li></ul></div><pre class="programlisting">      console.log(ctx.request.href);
      // =&gt; http://localhost:1234/?param=1</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.path</code>: This returns the request pathname. An example request to <code class="literal">http://localhost:1234/hello</code> would give the following:</li></ul></div><pre class="programlisting">      console.log(ctx.request.path);
      // =&gt; /hello</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.querystring</code>: This returns the raw query string without the prepending <code class="literal">?</code>.</li><li style="list-style-type: disc"><code class="literal">request.querystring=</code>: This sets the request raw query str<span>ing.</span></li><li style="list-style-type: disc"><code class="literal">request.search</code>: This returns the request raw query string, along with the prepending <code class="literal">?</code>.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.search=</code>: This sets the request raw query string.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.host</code>: This returns the request host (<code class="literal">hostname:port</code>). It supports the <code class="literal">X-Forwarded-Host</code> header when <code class="literal">app.proxy</code> is set to <code class="literal">true</code>; otherwise, it defaults to the <code class="literal">Host</code> header:</li></ul></div><pre class="programlisting">      console.log(ctx.request.host);
      // =&gt; localhost:1234</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.hostname</code>: This returns the request hostname when present. This also supports the <code class="literal">X-Forwarded-Host</code> header when <code class="literal">app.proxy</code> is set to <code class="literal">true</code>. If the host is IPv6, Koa delegates the parsing to the WHATWG URL API (<a class="ulink" href="https://nodejs.org/dist/latest-v8.x/docs/api/url.html#url_the_whatwg_url_api" target="_blank">https://nodejs.org/dist/latest-v8.x/docs/api/url.html#url_the_whatwg_url_api</a>). Delegating the parsing to the WHATWG URL API may affect performance.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.URL</code>: This returns the WHATWG (<a class="ulink" href="https://nodejs.org/dist/latest-v8.x/docs/api/url.html#url_the_whatwg_url_api" target="_blank">https://nodejs.org/dist/latest-v8.x/docs/api/url.html#url_the_whatwg_url_api</a>) parsed URL object.</li><li style="list-style-type: disc"><code class="literal">request.type</code></li></ul></div><p>This returns the <span>value</span><a id="id325921680" class="indexterm"></a> of the <code class="literal">Content-Type</code> header, if present, without <span>parameters</span><a id="id325965451" class="indexterm"></a> such as <code class="literal">charset</code>:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.charset</code></li></ul></div><p>This returns the request charset if present. Its default value is <code class="literal">undefined</code>:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.query</code>: This returns the parsed query string from a request. A request to <code class="literal">http://localhost:1234/?param1=1&amp;param2=2</code> would give the following:</li></ul></div><pre class="programlisting">      console.log(ctx.request.query);
      // =&gt; { param1: '1', param2: '2' }</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note9"></a>Note</h3><p>This getter does not support nested object parsing.</p></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.query=</code>: This method is used to set the query string to a supplied object:</li></ul></div><pre class="programlisting">      ctx.query = Object.assign(ctx.query, { param3: 3 });
      console.log(ctx.request.query);
      // =&gt; { param1: '1', param2: '2', param3: '3' }</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note10"></a>Note</h3><p>This setter does not support nested objects.</p></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.fresh</code>: This is used to check whether the contents of a request cache have not changed, as shown here:</li></ul></div><pre class="programlisting">      // check if cache is fresh
      if (ctx.request.fresh) {
        ctx.status = 304;
        return;
      }

      // cache is stale, return data
      ctx.body = "some data";</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.stale</code>: This is the inverse of the <code class="literal">request.fresh</code>method. It checks whether the contents of a request cache have changed.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.protocol</code>: This returns the request protocol—<code class="literal">http</code> or <code class="literal">https</code>. This supports the <code class="literal">X-Forwarded-Host</code> header when <code class="literal">app.proxy</code> is set to <code class="literal">true</code>. </li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.secure</code>: This simply <span>returns</span><a id="id325965570" class="indexterm"></a> a Boolean that is true <span>when</span><a id="id325965578" class="indexterm"></a> the request protocol is <code class="literal">https</code> and false when it's <code class="literal">http</code> as shown here:</li></ul></div><pre class="programlisting">      // https://example.com
      console.log(ctx.request.secure);
      // =&gt; true

      // http://example.com
      console.log(ctx.request.secure);
      // =&gt; false</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.ip</code>: This returns the request remote address. This supports <code class="literal">X-Forwarded-Host</code> when <code class="literal">app.proxy</code> is set to <code class="literal">true</code>. </li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.ips</code>: This returns an array of IPs from upstream to downstream, when the <code class="literal">X-Forwarded-Host</code> header is set and <code class="literal">app.proxy</code> is set to <code class="literal">true</code>. It returns an empty array otherwise.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.subdomains</code>: This returns the sub-domains on the request as an array. A good illustration of the behavior of this getter can be seen in the Koa docs:</li></ul></div><div class="blockquote"><blockquote class="blockquote"><p><span class="emphasis"><em>"For example, if the domain is <code class="literal">"tobi.ferrets.example.com"</code>: If app.subdomainOffset is not set, <code class="literal">ctx.subdomains</code> is <code class="literal">["ferrets", "tobi"]</code>. If <code class="literal">app.subdomainOffset</code> is <code class="literal">3</code>, <code class="literal">ctx.subdomains</code> is <code class="literal">["tobi"]</code>."</em></span></p></blockquote></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.is(types...)</code>: This checks the value of the <code class="literal">Content-Type</code>header and compares it to the values of the types supplied to find a match. If it <span>finds</span><a id="id325987184" class="indexterm"></a> a match, it <span>returns</span><a id="id325987192" class="indexterm"></a> the matching<code class="literal">Content-Type</code>. If no request body is not present, it returns<code class="literal">null</code>. If no<code class="literal">Content-Type</code>is present, or the match fails, then it returns<code class="literal">false</code>:</li></ul></div><pre class="programlisting">      // With Content-Type as text/html
      console.log(ctx.is('html'));
      // =&gt; 'html'
      console.log(ctx.is('text/html'));
      // =&gt; 'text/html'
      console.log(ctx.is('text/*', 'text/html'));
      // =&gt; 'text/html'</pre><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl3sec1"></a>Content negotiation</h4></div></div></div><p>The Koa request object includes some helper <span>methods</span><a id="id325987226" class="indexterm"></a> for content negotiation, powered by <code class="literal">accepts</code> and <code class="literal">negotiator</code>. These include the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.accepts(types...)</code>: This checks whether the given types are acceptable, then returns the best match when true. It returns false if the types are not acceptable. The <code class="literal">types</code>value may be a comma separated list of mime type strings or extension names, or an array. This is shown in the following block:</li></ul></div><pre class="programlisting">      // Accept: text/*, application/json
      ctx.accepts('text/html');
      // =&gt; "text/html"
      ctx.accepts(['html', 'json']);
      // =&gt; "json"
      ctx.accepts('png');
      // =&gt; false</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.acceptsEncodings(encodings)</code>: This checks whether the <code class="literal">encodings</code>supplied are acceptable and returns the best match when true. It returns<code class="literal">false</code>when no match exists. It returns all the accepted encodings as an array when no argument is given, as shown here:</li></ul></div><pre class="programlisting">      // Accept-Encoding: gzip, deflate, br
      ctx.acceptsEncodings()
      // =&gt; [ 'gzip', 'deflate', 'br', 'identity' ]</pre><p> </p><p> </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.acceptsLanguages(langs)</code>: T<span>his chec</span>ks whether the <code class="literal">langs</code>supplied are accepted and returns the best match when <code class="literal">true</code>. It returns<code class="literal">false</code>when no match exists. It returns all the accepted languages as an array when no argument is given:</li></ul></div><pre class="programlisting">      // Accept-Language: en-US,en;q=0.9,cy;q=0.8

      console.log(ctx.acceptsLanguages('en'));
      // =&gt; en

      console.log(ctx.acceptsLanguages('en', 'cy'));
      // =&gt; en

      console.log(ctx.acceptsLanguages(['en', 'cy']));
      // =&gt; en

      ctx.acceptsLanguages();
      // =&gt; [ 'en-US', 'en', 'cy' ]

      console.log(ctx.acceptsLanguages('es'));
      // =&gt; false</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.idempotent</code>: This returns a Boolean <span>specifying</span><a id="id325987322" class="indexterm"></a> whether the request is idempotent or not.</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note11"></a>Note</h3><p>A request is idempotent if multiple identical requests with that method have the same effect on the server as the effect for a single such request.</p></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.socket</code>: This returns the request socket.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">request.get(field)</code>: This returns the request header value for a specified field:</li></ul></div><pre class="programlisting">      // Accept-Language: en-US,en;q=0.9,cy;q=0.8

      ctx.request.get('Accept-Language');
      // =&gt; en-US,en;q=0.9,cy;q=0.8</pre></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec12"></a>The response object</h3></div></div></div><p>The Koa response object is an <span>abstraction</span><a id="id325997297" class="indexterm"></a> of Node's response object. Like the request object, it provides added functionality with its properties and methods for building out everyday HTTP servers.</p><p>The <span>methods</span><a id="id325997307" class="indexterm"></a> and <span>properties</span><a id="id325997316" class="indexterm"></a> it exposes include the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.header</code>: This returns the response header object.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.headers</code>: This returns the response header object. It is an alias of <code class="literal">response.header</code>.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.socket</code>: This returns the request socket.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.status</code>: This returns the response status code, which is 404 by default. This is in contrast to Vanilla Node, where the default status for <code class="literal">res.statusCode</code>is <code class="literal">200</code>.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.status=</code>: This is used to set the response status code to a valid HTTP numeric status code.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.message</code>: This returns the response status message. By default, this is associated with the <code class="literal">response.status</code>:</li></ul></div><pre class="programlisting">      ctx.response.status = 202;
      console.log(ctx.response.message);
      // =&gt; Accepted</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.message=</code>: This is used to set the response status message to the supplied value.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.length=</code>: This is used to set the response <code class="literal">Content-Length</code>header value to the given value.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.length</code>: This returns the <code class="literal">Content-Length</code>as a number when available. It can also return the length by evaluating the content from the<code class="literal">ctx.body</code>when possible. It returns undefined when both the<code class="literal">Content-Length</code>and<code class="literal">ctx.body</code>are unavailable.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.body</code>: This returns the response body. Popularly aliased as <code class="literal">ctx.body</code>.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.body=</code>: This sets the <span>response</span><a id="id326014615" class="indexterm"></a> body to <span>one</span><a id="id326014624" class="indexterm"></a> of the following:
<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">String</li><li style="list-style-type: disc">Buffer</li><li style="list-style-type: disc">Stream</li><li style="list-style-type: disc">Object/Array</li><li style="list-style-type: disc">Null
</li></ul></div></li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.get(field)</code>: This returns the value of the field header. The field comparison is case-insensitive, as shown:</li></ul></div><pre class="programlisting">      ctx.body = 'Hello World';
      console.log(ctx.response.get('content-length'));
      // =&gt; 11</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.set(field, value)</code>: This is used to set the response header <code class="literal">field</code>to a defined<code class="literal">value</code>as shown here:</li></ul></div><pre class="programlisting">      ctx.set('Content-Language', 'en');</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.append(field, value)</code>: This appends an additional header <code class="literal">field</code>with a<code class="literal">value</code>.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.set(fields)</code>: This sets several response header <code class="literal">fields</code>as an object as shown:</li></ul></div><pre class="programlisting">      ctx.set({
        'Content-Language': 'en',
        'Retry-After': 120
      });</pre><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.remove(field)</code>: This removes a header field.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.type</code>: This returns the response <code class="literal">Content-Type</code>.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.type=</code>: This sets the <code class="literal">Content-Type</code>via mime string or file extension.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.is(types...)</code>: This checks whether the response type is one of the <code class="literal">types</code>specified.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.redirect(url, [alt])</code>: This performs a <code class="literal">302</code>permanent redirect to a specified<code class="literal">url</code>. The string<code class="literal">back</code>provides referrer support. When the referrer is not present,<code class="literal">alt</code>or<code class="literal">/</code>is used.</li></ul></div><p>To alter the default <code class="literal">302</code> status, assign the <span>status</span><a id="id326052666" class="indexterm"></a> before or after the <span>redirect</span><a id="id326052675" class="indexterm"></a> call. To alter the response body, assign it after the call:</p><pre class="programlisting">ctx.response.status = 301;
ctx.redirect('back');
ctx.body = "redirecting you to the previous page...";</pre><p> </p><p> </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.attachment([filename])</code>: T<span>his sets</span> the <code class="literal">Content-Disposition</code>to<code class="literal">attachment</code>and optionally specifies the<code class="literal">filename</code>. Setting the<code class="literal">Content-Disposition</code>to attachment readies the client to receive the response as a download.</li><li style="list-style-type: disc"><code class="literal">response.headerSent</code>: This returns a Boolean specifying if a response header has already been sent.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.lastModified</code>: This returns the <code class="literal">Last-Modified</code>header as a<code class="literal">Date</code>if it exists.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.lastModified=</code>: This sets the last-modified to a UTC string. This method can either be supplied a <code class="literal">Date</code>object or a simple date string.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.etag=</code>: This sets the ETag header to a specified value.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.vary(field)</code>: This is used to set the value of the <code class="literal">Vary</code>header to a specified field.</li></ul></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><code class="literal">response.flushHeaders()</code>: This method flushes any set headers and begins the response body.</li></ul></div></div></div>