<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec32"></a>Making use of ordered sets</h2></div></div><hr /></div><p>Ordered sets are powerful features, but are not widely regarded as such and not widely known in the developer community. The <span>idea</span><a id="id326091089" class="indexterm"></a> is actually quite simple: data is grouped normally and then the data inside each group is ordered given a certain condition. The calculation is then performed on this sorted data.</p><p>A classic example would be the calculation of the median.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note28"></a>Note</h3><p>The median is the middle value. If you are, for example, earning the median income, the number of people earning less and more than you is identical; 50% of people do better and 50% of people do worse.</p></div><p>One way to get the median is to take sorted data and move 50% into the dataset. This is an example of what the <code class="literal">WITHIN GROUP</code> clause will ask PostgreSQL to do:</p><pre class="programlisting"><span class="strong"><strong>test=# SELECT region, 
   percentile_disc(0.5) WITHIN GROUP (ORDER BY production) 
FROM t_oil 
GROUP BY 1; </strong></span><span class="strong"><strong>
 region         | percentile_disc 
----------------+-----------------  
 Middle East    |            1082 
 North  America |            3054  
(2 rows) </strong></span></pre><p>The  <code class="literal">percentile_disc</code> function will skip 50% of the group and return the desired value.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note29"></a>Note</h3><p>Note that the median can significantly deviate from the average.</p></div><p>In economics, the deviation between the median and the average income can even be used as an indicator for social equality or inequality. The higher the median compared to the average, the greater the income inequality. To provide more flexibility, the ANSI standard does not just propose a median function. Instead, <code class="literal">percentile_disc</code> allows you to use any value between <code class="literal">0</code> and <code class="literal">1</code>.</p><p>The beauty is that you can even use ordered sets along with grouping <span>sets:</span></p><pre class="programlisting"><span class="strong"><strong>test=# SELECT region, 
              percentile_disc(0.5) WITHIN GROUP (ORDER BY production) 
FROM   t_oil 
GROUP BY ROLLUP (1); </strong></span><span class="strong"><strong>
 region         | percentile_disc 
----------------+-----------------  
 Middle East    |            1082 
 North  America |            3054 
                |            1696 
(3 rows)</strong></span></pre><p>In this case, PostgreSQL will again inject additional lines into the result set.</p><p>As proposed by the ANSI SQL standard, PostgreSQL provides you with two <code class="literal">percentile_</code> functions. The <code class="literal">percentile_disc</code> function will return a value that is really contained by the dataset. The <code class="literal">percentile_cont</code> function will <span>interpolate</span><a id="id326023049" class="indexterm"></a> a value if no exact match is found. The following example shows how this works:</p><pre class="programlisting"><span class="strong"><strong>test=# SELECT percentile_disc(0.62) WITHIN GROUP (ORDER BY id),    
    percentile_cont(0.62) WITHIN GROUP (ORDER BY id) 
FROM  generate_series(1, 5) AS id; </strong></span><span class="strong"><strong>
 percentile_disc | percentile_cont 
-----------------+----------------- 
 4               |            3.48 
(1 row)</strong></span></pre><p><code class="literal">4</code> is a value that really exists–<code class="literal">3.48</code> has been interpolated. The <code class="literal">percentile_</code> functions are not the only ones provided by PostgreSQL. To find the most frequent value within a group, the <code class="literal">mode</code> function is available. Before showing an example of how to use the <code class="literal">mode</code> function, I have compiled a query telling us a bit more about the content of the table:</p><pre class="programlisting"><span class="strong"><strong>test=# SELECT production, count(*) 
</strong></span><span class="strong"><strong>  FROM   t_oil 
</strong></span><span class="strong"><strong>  WHERE  country = 'Other Middle East' 
  GROUP  BY production 
  ORDER  BY 2 DESC 
  LIMIT  4; </strong></span><span class="strong"><strong>
 production | count 
------------+------- </strong></span>
<span class="strong"><strong> 50         |     5</strong></span>
<span class="strong"><strong> 48         |     5</strong></span>
<span class="strong"><strong> 52         |     5</strong></span>
<span class="strong"><strong> 53         |     4</strong></span>

<span class="strong"><strong>(4 rows)</strong></span></pre><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p>Three different values occur exactly five times. Of course, the <code class="literal">mode</code> function can only give us one of them:</p><pre class="programlisting"><span class="strong"><strong>test=# SELECT country, mode() WITHIN GROUP (ORDER BY production) 
  FROM  t_oil 
  WHERE country = 'Other Middle East'  
  GROUP BY 1; </strong></span><span class="strong"><strong>
 country            | mode 
--------------------+------  
 Other  Middle East | 48 
(1 row)</strong></span></pre><p>The most frequent value is returned but SQL won't tell us how often the number actually shows up. It might be that the number only shows up once.</p></div>