<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec73"></a>Making use of CREATE PUBLICATION and CREATE SUBSCRIPTION</h2></div></div><hr /></div><p>For version 10.0, the PostgreSQL <span>community</span><a id="id326659980" class="indexterm"></a> created two new commands: <code class="literal">CREATE PUBLICATION</code> and <code class="literal">CREATE SUBSCRIPTION</code>. These can be used for logical replication, which means that you can now selectively replicate data and achieve close-to-zero downtime upgrades. So far, binary replication <span>and</span><a id="id326659966" class="indexterm"></a> transaction log replication has been fully covered. However, sometimes, we might not want to replicate an entire database instance—replicating a table or two might be enough. This is exactly when logical replication is the right thing to use.</p><p>Before getting started, the first thing to do is change <code class="literal">wal_level</code> to <code class="literal">logical</code> in <code class="literal">postgresql.conf</code> and restart:</p><pre class="programlisting"><span class="strong"><strong><span class="strong"><strong>wal_level = logical</strong></span></strong></span></pre><p>Then, we can create a simple table:</p><pre class="programlisting"><span class="strong"><strong><span class="strong"><strong>test=# CREATE TABLE t_test (a int, b int);</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong>CREATE TABLE</strong></span></strong></span></pre><p>The same table layout has to exist in the second database as well to make this work. PostgreSQL will not automatically create those tables for us:</p><pre class="programlisting"><span class="strong"><strong><span class="strong"><strong>test=# CREATE DATABASE repl;</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong>CREATE DATABASE</strong></span></strong></span></pre><p>After creating the database, the identical table can be added:</p><pre class="programlisting"><span class="strong"><strong><span class="strong"><strong>repl=# CREATE TABLE t_test (a int, b int);</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong>CREATE TABLE</strong></span></strong></span></pre><p>The goal here is to publish the contents of the <code class="literal">t_test</code> table in the test database to somewhere else. In this case, it will simply be replicated into a database on the same instance. To publish those changes, PostgreSQL offers the <code class="literal">CREATE PUBLICATION</code> command:</p><pre class="programlisting"><span class="strong"><strong><span class="strong"><strong>test=# \h CREATE PUBLICATION</strong></span>
</strong></span><span class="strong"><strong><span class="strong"><strong>Command: CREATE PUBLICATION</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong> Description: define a new publication</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong> Syntax:</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong>CREATE PUBLICATION name</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong>  [ FOR TABLE [ ONLY ] table_name [ * ] [, ...]</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong>| FOR ALL TABLES ]</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong>[ WITH ( publication_parameter [= value] [, ... ] ) ]</strong></span></strong></span></pre><p>The syntax is actually pretty easy. All we need is a name and a list of all tables the system is supposed to replicate:</p><pre class="programlisting"><span class="strong"><strong><span class="strong"><strong>test=# CREATE PUBLICATION pub1 FOR TABLE t_test;</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong>CREATE PUBLICATION</strong></span></strong></span></pre><p>In the next step, the subscription can be created. The syntax is, again, pretty simple and really straightforward:</p><pre class="programlisting"><span class="strong"><strong><span class="strong"><strong>test=# \h CREATE SUBSCRIPTION</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong>Command: CREATE SUBSCRIPTION</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong>Description: define a new subscription</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong>Syntax:</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong>CREATE SUBSCRIPTION subscription_name</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong>  CONNECTION 'conninfo'</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong>PUBLICATION publication_name [, ...]</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong> [ WITH ( subscription_parameter [= value] [, ... ] ) ]</strong></span></strong></span></pre><p>Basically, creating a subscription directly is absolutely no problem. However, if we play this game inside the same instance from the test database to the <code class="literal">repl</code> database, it is necessary to create the replication slot in use manually. Otherwise, <code class="literal">CREATE SUBSCRIPTION</code> will never finish:</p><pre class="programlisting"><span class="strong"><strong><span class="strong"><strong>test=# SELECT pg_create_logical_replication_slot('sub1', 'pgoutput');</strong></span>
</strong></span><span class="strong"><strong><span class="strong"><strong> pg_create_logical_replication_slot </strong></span></strong></span><span class="strong"><strong>------------------------------------</strong></span>
<span class="strong"><strong>(sub1,0/27E2B2D0)</strong></span>
<span class="strong"><strong>(1 row)</strong></span></pre><p>In this case, the name of the slot created on the master <span>database</span><a id="id325664428" class="indexterm"></a> is called <code class="literal">sub1</code>. Then, we need to connect to the target database and run the <span>following</span><a id="id325664440" class="indexterm"></a> command:</p><pre class="programlisting"><span class="strong"><strong><span class="strong"><strong>repl=# CREATE SUBSCRIPTION sub1 </strong></span><span class="strong"><strong>        CONNECTION 'host=localhost dbname=test user=postgres'</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong>        PUBLICATION pub1 </strong></span></strong></span><span class="strong"><strong><span class="strong"><strong>        WITH (create_slot = false);</strong></span></strong></span><span class="strong"><strong><span class="strong"><strong>CREATE SUBSCRIPTION</strong></span></strong></span></pre><p>Of course, we have to adjust our database connect parameters. Then, PostgreSQL will <code class="literal">sync</code> the data, and we will be done.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note88"></a>Note</h3><p>Note that <code class="literal">create_slot = false</code> is only used because the test is running inside the same database server instance. If we happen to use different databases, there is no need for manually creating the slot and no need for <code class="literal">create_slot = false</code>.</p></div></div>