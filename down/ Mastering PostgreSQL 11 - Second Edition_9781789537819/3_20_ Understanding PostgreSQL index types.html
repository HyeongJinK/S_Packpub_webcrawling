<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec26"></a>Understanding PostgreSQL index types</h2></div></div><hr /></div><p>So far, only binary trees have <span>been</span><a id="id326453946" class="indexterm"></a> discussed. However, in many cases, btrees are just not enough. Why is that the case? As discussed in this chapter, btrees are basically based on sorting. Operators <code class="literal">&lt;</code>, <code class="literal">&lt;=</code>, <code class="literal">=</code>, <code class="literal">&gt;=</code>, and <code class="literal">&gt;</code> can be handled using btrees. The trouble is, not ever data type can be sorted in a useful way. Just imagine a polygon. How would you sort these objects in a useful way? Sure, you can sort by the area covered, its length or so on, but doing this won't allow you to actually find them using a geometric search.</p><p>The solution to the problem is to provide more than just one index type. Each index will serve a special purpose and do exactly what is needed. The following index types are available (as of PostgreSQL 10.0):</p><pre class="programlisting"><span class="strong"><strong>test=# SELECT </strong></span><span class="strong"><strong>* FROM pg_am;</strong></span>
<span class="strong"><strong> amname  </strong></span><span class="strong"><strong>| amhandler   | amtype</strong></span>
<span class="strong"><strong>---------+-------------+--------</strong></span>
<span class="strong"><strong> btree   | bthandler   | i</strong></span>
<span class="strong"><strong> hash    | hashhandler | i 
 GiST    | gisthandler | i 
 gin     | ginhandler  | i 
 spGiST  | spghandler  | i 
 brin    | brinhandler | i 
(6 rows)</strong></span></pre><p>There are six types of indexes. The btrees have already been discussed in great detail, but what are those other index types good for? The following sections will outline the purpose of each index type available in PostgreSQL.</p><p>Note that there are some extensions out there that can be used on top of what you can see here. Additional index types available on the web are rum, vodka, and in the future, cognac.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec31"></a>Hash indexes</h3></div></div></div><p>Hash indexes have <span>been</span><a id="id326453773" class="indexterm"></a> around for many years. The <span>idea</span><a id="id326453767" class="indexterm"></a> is to hash the input value and store it for later lookups. Having hash indexes actually makes sense. However, before PostgreSQL 10.0, it was not advised to use hash indexes because PostgreSQL had no WAL support for them. In PostgreSQL 10.0, this has changed. Hash indexes are now fully logged and are therefore ready for replication and are considered to be a 100% crash-safe.</p><p>Hash indexes are generally a bit larger than btree indexes. Suppose you want to index 4 million integer values. A btree will need around 90 MB of storage to do this. A hash index will need around 125 MB on disk. The assumption made by many people that a hash is super small on the disk is therefore, in many cases, just wrong.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec32"></a>GiST indexes</h3></div></div></div><p><span class="strong"><strong>Generalized Search Tree</strong></span> (<span class="strong"><strong>GiST</strong></span>) indexes are highly <span>important</span><a id="id325634094" class="indexterm"></a> index types because they are used for a variety of different things. GiST indexes can be used to implement R-tree behavior and it is even possible to act as a  btree. However, abusing GiST for btree <span>indexes</span><a id="id325634103" class="indexterm"></a> is not recommended.</p><p>Typical use cases for GiST are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Range types</li><li style="list-style-type: disc">Geometric indexes (for example, used by the highly popular PostGIS extension)</li><li style="list-style-type: disc">Fuzzy searching</li></ul></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl3sec13"></a>Understanding how GiST works</h4></div></div></div><p>To many people, GiST is <span>still</span><a id="id325634130" class="indexterm"></a> a black box. Therefore, I have decided to add a section to this chapter outlining how GiST works internally.</p><p>Consider the following diagram:</p><div class="mediaobject"><img src="/graphics/9781789537819/graphics/5da9f100-81db-4298-b67f-ec11e4685e7d.png" /></div><p>Take a look at the tree. You will see that <span class="strong"><strong>R1</strong></span> and <span class="strong"><strong>R2</strong></span> are on top. <span class="strong"><strong>R1</strong></span> and <span class="strong"><strong>R2</strong></span> are the bounding boxes containing everything else. <span class="strong"><strong>R3</strong></span>, <span class="strong"><strong>R4</strong></span>, and <span class="strong"><strong>R5</strong></span> are contained by <span class="strong"><strong>R1</strong></span>. <span class="strong"><strong>R8</strong></span>, <span class="strong"><strong>R9</strong></span>, and <span class="strong"><strong>R10</strong></span> are contained by <span class="strong"><strong>R3</strong></span>, and so on. A GiST index is therefore hierarchically organized. What you can see in the diagram is that some operations, which are not available in btrees are supported. Some of those operations are overlaps, left of, right of, and so on. The layout of a GiST tree is ideal for geometric indexing.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl3sec14"></a>Extending GiST</h4></div></div></div><p>Of course, it is also possible to come up with <span>your</span><a id="id326377773" class="indexterm"></a> own operator classes. The following strategies are supported:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col /><col /></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Operation</strong></span></p></td><td style="border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Strategy number</strong></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Strictly left of</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">1</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Does not extend to right of</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">2</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Overlaps</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">3</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Does not extend to left of</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">4</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Strictly right of</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">5</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Same</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">6</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Contains</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">7</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Contained by</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">8</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Does not extend above</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">9</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Strictly below</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">10</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Strictly above</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">11</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p><code class="literal">Does not extend below</code></p></td><td style=""><p><code class="literal">12</code></p></td></tr></tbody></table></div><p> </p><p>If you want to write operator classes for GiST, a couple of support functions have to be provided. In the case of a btree, there is only the same function—GiST indexes provide a lot more:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col /><col /><col /></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Function</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Description</strong></span></p></td><td style="border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Support function number</strong></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">consistent</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>The functions <span>determine</span><a id="id325870187" class="indexterm"></a> whether a key satisfies the query qualifier. Internally, strategies are looked up and checked.</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">1</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">union</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Calculates the <span>union</span><a id="id325870212" class="indexterm"></a> of a set of keys. In case of numeric values, simply the upper and lower values or a range are computed. It is especially important to geometries.</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">2</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">compress</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Computes a <span>compressed</span><a id="id325870340" class="indexterm"></a> representation of a key or value.</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">3</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">decompress</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>This is the counterpart of the <span>compress</span><a id="id325870364" class="indexterm"></a> function.</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">4</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">penalty</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>During insertion, the cost of inserting into the tree will be calculated. The cost determines where the new <span>entry</span><a id="id325870526" class="indexterm"></a> will go inside the tree. Therefore, a good penalty function is key to the good overall performance of the index.</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">5</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">picksplit</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Determines where to move <span>entries</span><a id="id325870552" class="indexterm"></a> in case of a page split. Some entries have to stay on the old page while others will go to the new page being created. Having a good picksplit function is essential to a good index performance.</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">6</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">equal</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>The equal function is <span>similar</span><a id="id325870577" class="indexterm"></a> to the same function you have already seen in btrees.</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">7</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">distance</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Calculates the distance (a number) between a key and the query value. The distance function is optional and is <span>needed</span><a id="id325870602" class="indexterm"></a> in case KNN search is supported.</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">8</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p><code class="literal">fetch</code></p></td><td style="border-right: 0.5pt solid ; "><p>Determines the <span>original</span><a id="id325870627" class="indexterm"></a> representation of a compressed key. This function is needed to handle index- only scans, as supported by the recent version of PostgreSQL.</p></td><td style=""><p><code class="literal">9</code></p></td></tr></tbody></table></div><p> </p><p>Implementing operator classes for GiST indexes is usually done in <code class="literal">C</code>. If you are interested in a good example, I advise you to check out the <code class="literal">btree_GiST</code> module in the <code class="literal">contrib</code> directory. It shows how to index standard data types using <code class="literal">GiST</code> and is a good source of information as well as inspiration.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec33"></a>GIN indexes</h3></div></div></div><p><span class="strong"><strong>Generalized inverted</strong></span> (<span class="strong"><strong>GIN</strong></span>) indexes are a good way to index text. Suppose you want to index a million text documents. A certain word may occur millions of times. In a normal b- tree, this would mean that the key is stored millions of times. This is not the case in a GIN. Each key (or word) is stored once and assigned to a document list. Keys are organized in a standard b- tree. Each entry will have a document list pointing to all entries in the table having the same key. A GIN index is very small and compact. However, it lacks an <span>important</span><a id="id325876168" class="indexterm"></a> feature found in the btrees-sorted data. In a GIN, the list of item pointers <span>associated</span><a id="id325876177" class="indexterm"></a> with a certain key is sorted by the position of the row in the table and not by some arbitrary criteria.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl3sec15"></a>Extending GIN</h4></div></div></div><p>Just like any other index, GIN <span>can</span><a id="id325876192" class="indexterm"></a> be extended. The following strategies are available:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col /><col /></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Operation</strong></span></p></td><td style="border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Strategy number</strong></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Overlap</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">1</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Contains</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">2</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Is contained by</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">3</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p><code class="literal">Equal</code></p></td><td style=""><p><code class="literal">4</code></p></td></tr></tbody></table></div><p> </p><p>On top of this, the following support <span>functions</span><a id="id325876277" class="indexterm"></a> are available:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col /><col /><col /></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Function</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Description</strong></span></p></td><td style="border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Support function number</strong></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">compare</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>The compare function is similar to the same function you have seen in btrees. If two keys are compared, it returns <code class="literal">-1</code> (lower), <code class="literal">0</code> (equal), or <code class="literal">1</code> (higher).</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">1</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">extractValue</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Extracts keys <span>from</span><a id="id325887858" class="indexterm"></a> a value to be indexed. A value can have many keys. For example, a text value might consist of more than one word.</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">2</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">extractQuery</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Extracts keys <span>from</span><a id="id325895940" class="indexterm"></a> a query condition.</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">3</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">consistent</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Checks whether a value <span>matches</span><a id="id325895964" class="indexterm"></a> a query condition.</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">4</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">comparePartial</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Compares a <span>partial</span><a id="id325896126" class="indexterm"></a> key from a query and a key from the index. Returns <code class="literal">-1</code>, <code class="literal">0</code>, or <code class="literal">1</code> (similar to the same function supported by btrees).</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">5</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p><code class="literal">triConsistent</code></p></td><td style="border-right: 0.5pt solid ; "><p>Determines whether a <span>value</span><a id="id325896161" class="indexterm"></a> matches a query condition (ternary variant). It is optional if the consistent function is present.</p></td><td style=""><p><code class="literal">6</code></p></td></tr></tbody></table></div><p> </p><p>If you are looking for a good example of how to extend GIN, consider looking at the <code class="literal">btree_gin</code> module in the PostgreSQL <code class="literal">contrib</code> directory. It is a valuable source of information and a good way to start your own implementation. </p><p>If you are interested in full-text search, more information will be provided later on in this chapter.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec34"></a>SP-GiST indexes</h3></div></div></div><p><span class="strong"><strong>Space partitioned GiST (SP-GiST)</strong></span> has mainly been designed for in-memory use. The reason for this is an SP-GiST stored on disk needs a fairly high number of disk <span>hits</span><a id="id325936987" class="indexterm"></a> to function. Disk hits are <span>way</span><a id="id325936996" class="indexterm"></a> more expensive than just following a couple of pointers in RAM.</p><p>The beauty is that SP-GiST can be used to implement various types of trees, such as quad- trees, k-d trees, and radix trees (tries).</p><p>The following strategies are provided:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col /><col /></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Operation</strong></span></p></td><td style="border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Strategy number</strong></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Strictly left of</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">1</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Strictly right of</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">5</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Same</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">6</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Contained by</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">8</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Strictly below</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">10</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p><code class="literal">Strictly above</code></p></td><td style=""><p><code class="literal">11</code></p></td></tr></tbody></table></div><p> </p><p>To write your own operator classes for <code class="literal">SP-GiST</code>, a couple of functions have to be provided:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col /><col /><col /></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Function</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Description</strong></span></p></td><td style="border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Support function number</strong></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">config</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Provides <span>information</span><a id="id325970194" class="indexterm"></a> about the <code class="literal">operator</code> class in use</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">1</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">choose</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Figures out how to <span>insert</span><a id="id325970221" class="indexterm"></a> a new value into an inner tuple</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">2</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">picksplit</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Figures out <span>how</span><a id="id325972397" class="indexterm"></a> to partition/split a set of values</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">3</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">inner_consistent</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Determines which <span>subpartitions</span><a id="id325972422" class="indexterm"></a> need to be searched for a query</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">4</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p><code class="literal">leaf_consistent</code></p></td><td style="border-right: 0.5pt solid ; "><p>Determines whether key <span>satisfies</span><a id="id325972789" class="indexterm"></a> the query qualifier</p></td><td style=""><p><code class="literal">5</code></p></td></tr></tbody></table></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec35"></a>BRIN indexes</h3></div></div></div><p><span class="strong"><strong>Block range indexes</strong></span> (<span class="strong"><strong>BRINs</strong></span>) are of great <span>practical</span><a id="id325972817" class="indexterm"></a> use. All <span>indexes</span><a id="id325972825" class="indexterm"></a> discussed until now need quite a lot of disk space. Although a lot of work has gone into shrinking GIN indexes and the like, they still need quite a lot because an index pointer is needed for each entry. So, if there are 10 million entries, there will be 10 million index pointers. Space is the main concern addressed by the BRINs indexes. A BRIN index does not keep an index entry for each tuple but will store the minimum and the maximum value of 128 (default) blocks of data (1 MB). The index is therefore very small but lossy. Scanning the index will return more data than we asked for. PostgreSQL has to filter out these additional rows in a later step.</p><p>The following example demonstrates how small a BRIN index really is:</p><pre class="programlisting"><span class="strong"><strong>test=# CREATE INDEX idx_brin ON t_test USING brin(id); 
CREATE INDEX 
test=# \di+ idx_brin 
                        List of relations 
 Schema | Name     | Type  | Owner | Table  | Size 
--------+----------+-------+-------+--------+-------
 public | idx_brin | index | hs    | t_test | 48 KB
(1 row)
</strong></span></pre><p>In my example, the BRIN index is 2,000 times smaller than a standard btree. The question naturally arising now is, why don't we always use BRIN indexes? To answer this kind of question, it is important to reflect on the layout of BRIN; the minimum and maximum values for 1 MB are stored. If the data is sorted (high correlation), BRIN is pretty efficient because we can fetch 1 MB of data, scan it, and we are done. However, what if the data is shuffled? In this case, BRIN won't be able to exclude chunks of data anymore because it is very likely that something close to the overall high and the overall low is within 1 MB of data. Therefore, BRIN is mostly made for highly correlated data. In reality, correlated data is quite likely in data warehousing applications. Often, data is loaded every day and therefore dates can be highly correlated.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl3sec16"></a>Extending BRIN indexes</h4></div></div></div><p>BRIN supports the same strategies as a btree and <span>therefore</span><a id="id325972851" class="indexterm"></a> needs the same set of operators. The code can be reused nicely:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col /><col /></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Operation</strong></span></p></td><td style="border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Strategy number</strong></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Less than</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">1</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Less than or equal</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">2</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Equal</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">3</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">Greater than or equal</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">4</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p><code class="literal">Greater than</code></p></td><td style=""><p><code class="literal">5</code></p></td></tr></tbody></table></div><p> </p><p>The support functions needed by BRIN are as follows:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col /><col /><col /></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Function</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Description</strong></span></p></td><td style="border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Support function number</strong></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">opcInfo</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Provides internal <span>information</span><a id="id326017643" class="indexterm"></a> about the indexed columns</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">1</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">add_value</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Adds an <span>entry</span><a id="id326017671" class="indexterm"></a> to an existing summary tuple</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">2</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">consistent</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Checks whether a <span>value</span><a id="id326017699" class="indexterm"></a> matches a condition</p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">3</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p><code class="literal">union</code></p></td><td style="border-right: 0.5pt solid ; "><p>Calculates <span>the</span><a id="id326017830" class="indexterm"></a> union of two summary entries (minimum/maximum values)</p></td><td style=""><p><code class="literal">4</code></p></td></tr></tbody></table></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec36"></a>Adding additional indexes</h3></div></div></div><p>Since PostgreSQL 9.6, there has been an <span>easy</span><a id="id326017851" class="indexterm"></a> way <span>t</span>o deploy entirely new index types as extensions. This is pretty cool because if those index types provided by PostgreSQL are not enough, it is possible to add additional ones serving precisely your purpose. The instruction to do this is <code class="literal">CREATE ACCESS METHOD</code>:</p><pre class="programlisting"><span class="strong"><strong>test=# \</strong></span><span class="strong"><strong>h CREATE ACCESS METHOD 

Command: CREATE ACCESS METHOD 
Description: define a new access method 
Syntax:
</strong></span><span class="strong"><strong>CREATE ACCESS METHOD name </strong></span>
<span class="strong"><strong>    TYPE access_method_type </strong></span>
<span class="strong"><strong>    HANDLER handler_function</strong></span></pre><p>Don't worry too much about this command—just in case you ever deploy your own index type, it will come as a ready-to-use extension.</p><p>One of these extensions implements bloom filters. Bloom filters are probabilistic data structures. They sometimes return too many rows but never too few. Therefore, a bloom filter is a good method to pre-filter data.</p><p>How does it work? A bloom filter is defined on a couple of columns. A bitmask is calculated based on the input values, which is then compared to your query. The upside of a bloom filter is that you can index as many columns as you want. The downside is that <span>the</span><a id="id326024451" class="indexterm"></a> entire bloom filter has to be read. Of course, the bloom filter is smaller than the underlying data and so it is, in many cases, very beneficial.</p><p>To use bloom filters, just activate the extension, which is a part of the PostgreSQL <code class="literal">contrib</code> package:</p><pre class="programlisting"><span class="strong"><strong>test=# CREATE EXTENSION bloom;  
CREATE EXTENSION</strong></span></pre><p>As stated previously, the idea behind a bloom filter, is that it allows you to index as many columns as you want. In many real-world applications, the challenge is to index many columns without knowing which combinations the user will actually need at runtime. In the case of a large table, it is totally impossible to create standard btree indexes on, say, 80 fields or more. A bloom filter might be an alternative in this case:</p><pre class="programlisting"><span class="strong"><strong>test=# CREATE TABLE t_bloom (x1 int, x2 int, x3 int, x4 int, 
                             x5 int, x6 int, x7 int); 
CREATE TABLE</strong></span></pre><p>Creating the index is easy:</p><pre class="programlisting"><span class="strong"><strong>test=# CREATE INDEX idx_bloom ON t_bloom USING bloom(x1, x2, x3, x4, 
                                                     x5, x6, x7);  
CREATE INDEX</strong></span></pre><p>If sequential scans are turned off, the index can be seen in action:</p><pre class="programlisting"><span class="strong"><strong>test=# SET enable_seqscan TO off; 
SET 
test=# explain SELECT * FROM t_bloom WHERE x5 = 9 AND x3 = 7; 
</strong></span><span class="strong"><strong>                   QUERY PLAN</strong></span>
<span class="strong"><strong>-------------------------------------------------------------------------</strong></span>
<span class="strong"><strong> Bitmap Heap Scan on t_bloom (cost=18.50..22.52 rows=1 width=28)</strong></span>
<span class="strong"><strong>   Recheck Cond: ((x3 = 7) AND (x5 = 9))</strong></span>
<span class="strong"><strong>   -&gt; Bitmap Index Scan on idx_bloom (cost=0.00..18.50 rows=1 width=0)</strong></span>
<span class="strong"><strong>         Index Cond: ((x3 = 7) AND (x5 = 9))</strong></span></pre><p>Note that I have queried a <span>combination</span><a id="id326024661" class="indexterm"></a> of random columns; they are not related to the actual order in the index. The bloom filter will still be beneficial.</p><p>If you are interested in <span>bloom</span><a id="id326024673" class="indexterm"></a> filters, consider checking out the following website: <a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>h</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>t</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>t</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>p</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>s</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>://</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>e</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>n</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>.</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>w</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>i</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>k</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>i</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>p</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>e</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>d</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>i</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>a</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>.</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>o</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>r</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>g</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>/</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>w</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>i</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>k</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>i</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>/</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>B</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>l</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>o</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>o</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>m</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>_</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>f</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>i</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>l</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>t</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>e</span></a><a class="ulink" href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank"><span>r</span></a>.</p></div></div>