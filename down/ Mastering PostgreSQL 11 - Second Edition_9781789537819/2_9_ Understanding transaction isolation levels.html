<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec16"></a>Understanding transaction isolation levels</h2></div></div><hr /></div><p>Up until now, you have seen how to handle <span>locking</span><a id="id326012738" class="indexterm"></a> as well as some basic concurrency. In this section, you will learn transaction isolation. To me, this is one of the most neglected topics in modern software development. Only a small fraction of software developers are actually aware of this issue, which in turn leads to mind-boggling bugs.</p><p>Here is an example of what can happen:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col /><col /></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Transaction 1</strong></span></p></td><td style="border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Transaction 2</strong></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">BEGIN;</code></p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">SELECT sum(balance) FROM t_account;</code></p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>User will see <code class="literal">300</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">BEGIN;</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">INSERT INTO t_account (balance) VALUES (100);</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">COMMIT;</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">SELECT sum(balance) FROM t_account;</code></p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>User will see <code class="literal">400</code></p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p><code class="literal">COMMIT;</code></p></td><td style=""><p></p></td></tr></tbody></table></div><p> </p><p>Most users would actually expect the left transaction to always return <code class="literal">300</code> regardless of the second transaction. However, this is not true. By default, PostgreSQL runs in the <code class="literal">READ COMMITTED</code> transaction isolation mode. This means that every statement inside a transaction will get a new snapshot of the data, which will be constant throughout the query.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note12"></a>Note</h3><p>A SQL statement will operate on the same snapshot and will ignore changes by concurrent transactions while it is running.</p></div><p>If you want to avoid this, you can use <code class="literal">TRANSACTION ISOLATION LEVEL REPEATABLE READ</code>. In this transaction isolation level, a <span>transaction</span><a id="id325565435" class="indexterm"></a> will use the same snapshot through the entire transaction. Here is what will happen:</p><p> </p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col /><col /></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Transaction 1</strong></span></p></td><td style="border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>Transaction 2</strong></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;</code></p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">SELECT sum(balance) FROM t_account;</code></p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>User will see <code class="literal">300</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">BEGIN;</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">INSERT INTO t_account (balance)</code></p><p><code class="literal">       VALUES (100);</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">COMMIT;</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">SELECT sum(balance) FROM t_account;</code></p></td><td style="border-bottom: 0.5pt solid ; "><p><code class="literal">SELECT sum(balance) FROM t_account;</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>User will see <code class="literal">300</code></p></td><td style="border-bottom: 0.5pt solid ; "><p>User will see <code class="literal">400</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p><code class="literal">COMMIT;</code></p></td><td style=""><p></p></td></tr></tbody></table></div><p>As just outlined, the first transaction will freeze its snapshot of the data and provide us with constant results throughout the entire transaction. This feature is especially important if you want to run reports. The first and the last page of a report should always be consistent and operate on the same data. Therefore, the repeatable read is key to consistent reports.</p><p>Note that isolation-related errors won't always pop up instantly. It can <span>happen</span><a id="id325856131" class="indexterm"></a> that trouble is noticed years after an application has been <span>moved</span><a id="id325856137" class="indexterm"></a> to production.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note13"></a>Note</h3><p>Repeatable read is not more expensive than read committed. There is no need to worry about performance penalties. For normal <span class="strong"><strong>online transaction processing</strong></span> (<span class="strong"><strong>OLTP</strong></span>), read committed has various advantages because changes can be seen much earlier and the odds of unexpected errors are usually lower.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec14"></a>Considering SSI transactions</h3></div></div></div><p>On top of read committed and <span>repeatable</span><a id="id325939002" class="indexterm"></a> read, PostgreSQL offers SSI transactions. So, in all, PostgreSQL supports three isolation levels. Note that read uncommitted (which still happens to be the default in some commercial databases) is not supported: if you try to start a read uncommitted transaction, PostgreSQL will silently map to read committed. Let us get back to the serializable isolation level.</p><p>The idea behind serializable isolation is simple; if a transaction is known to work correctly when there is only a single user, it will also work in the case of concurrency when this isolation level is chosen. However, users have to be prepared; transactions may fail (by design) and error out. In addition to this, a performance penalty has to be paid.</p><p>If you want to know more about this isolation level, consider <span>checking</span><a id="id325939015" class="indexterm"></a> out <a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>h</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>t</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>t</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>p</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>s</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>://</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>w</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>i</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>k</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>i</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>.</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>p</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>o</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>s</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>t</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>g</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>r</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>e</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>s</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>q</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>l</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>.</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>o</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>r</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>g</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>/</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>w</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>i</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>k</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>i</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>/</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>S</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>e</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>r</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>i</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>a</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>l</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>i</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>z</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>a</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>b</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>l</span></a><a class="ulink" href="https://wiki.postgresql.org/wiki/Serializable" target="_blank"><span>e</span>.</a></p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip14"></a>Note</h3><p>Consider using serializable isolation only when you have a decent understanding of what is going on inside the database engine.</p></div></div></div>