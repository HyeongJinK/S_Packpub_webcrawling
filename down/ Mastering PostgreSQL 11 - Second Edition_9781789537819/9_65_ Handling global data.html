<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec65"></a>Handling global data</h2></div></div><hr /></div><p>In the previous sections, we <span>learned</span><a id="id325565388" class="indexterm"></a> about <code class="literal">pg_dump</code> and <code class="literal">pg_restore</code>, which are two vital programs when it comes to creating backups. The thing is, <code class="literal">pg_dump</code> creates database dumps—it works on the database level. If we want to back up an entire instance, we have to make use of <code class="literal">pg_dumpall</code> or dump all of the databases separately. Before we dig into that, it makes sense to see how <code class="literal">pg_dumpall</code> works:</p><pre class="programlisting"><span class="strong"><strong>pg_dumpall &gt; /tmp/all.sql</strong></span></pre><p> </p><p> </p><p>Let's see, <code class="literal">pg_dumpall</code> will connect to one database after the other and send stuff to standard out, where you can process it with Unix. Note that <code class="literal">pg_dumpall</code> can be used just like <code class="literal">pg_dump</code>. However, it has some downsides. It does not support a custom or directory format, and therefore does not offer multicore support. This means that we will be stuck with one thread.</p><p>However, there is more to <code class="literal">pg_dumpall</code>. Keep in mind that users live on the instance level. If you create a normal database dump, you will get all of the permissions, but you won't get all of the <code class="literal">CREATE USER</code> statements. Those <code class="literal">globals</code> are not included in a normal dump—they will only be extracted by <code class="literal">pg_dumpall</code>.</p><p>If we only want the <code class="literal">globals</code>, we can run <code class="literal">pg_dumpall</code> using the <code class="literal">-g</code> option:</p><pre class="programlisting"><span class="strong"><strong>pg_dumpall -g &gt; /tmp/globals.sql</strong></span></pre><p>In most cases, you might want to run <code class="literal">pg_dumpall -g</code>, along with a custom or directory format dump to extract your instances. A simple backup script might look such as this:</p><pre class="programlisting"><span class="strong"><strong>#!/bin/sh</strong></span><span class="strong"><strong>BACKUP_DIR=/tmp/</strong></span><span class="strong"><strong>pg_dumpall -g &gt; $BACKUP_DIR/globals.sql</strong></span><span class="strong"><strong>for x in $(psql -c "SELECT datname FROM  pg_database</strong></span><span class="strong"><strong>   WHERE  datname NOT IN ('postgres', 'template0', 'template1')" postgres -A -t)</strong></span><span class="strong"><strong>do</strong></span><span class="strong"><strong>pg_dump -Fc $x &gt; $BACKUP_DIR/$x.fc done</strong></span></pre><p>It will first dump the globals and then loop <span>through</span><a id="id325565436" class="indexterm"></a> the list of databases to extract them one by one in a custom format.</p></div>