<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec57"></a>Exploring streaming sensor data from a weather station</h2></div></div><hr /></div><p>Let's get our hands dirty with <span>steaming</span><a id="id325337723" class="indexterm"></a> data. Assuming that you have your <span>virtual</span><a id="id325337715" class="indexterm"></a> machine on and ready to use, let's start with these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Open a Terminal shell. Change into the <code class="literal">sensor</code>directory. In this case, suppose that you have downloaded them into the <code class="literal">Downloads</code>folder, as follows:</li></ol></div><pre class="programlisting"><span class="strong"><strong>cd Downloads/HandsOnBigData/CH09/sensor</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="2" type="1"><li>View the streaming weather station data.<span class="strong"><strong> </strong></span>Run <code class="literal">stream-data.py</code> to see the streaming data from the weather station:</li></ol></div><pre class="programlisting">./stream-data.py</pre><p>Running the preceding script will generate output similar to the following:</p><div class="mediaobject"><img src="/graphics/9781788620901/graphics/816c3692-973a-4e33-907f-3750f638c96d.png" /></div><p>The <span>measurements</span><a id="id326023425" class="indexterm"></a> are appearing as they are produced by the <span>weather</span><a id="id326023436" class="indexterm"></a> station. By looking at the timestamp, we can see that the data arrives about every second. Additionally, different measurement types are produced at different frequencies. For example, <code class="literal">R1</code> is measured every second, but <code class="literal">R2</code> is less frequent. The following code snippet connects to the weather station and gets the streaming data:</p><pre class="programlisting">#!/usr/bin/python
import socket
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(('rtd.hpwren.ucsd.edu', 12020))
for i in range(0, 60):
d = s.recv(1024)
p = d.split('\t', 2)
print "{0}: {1}".format(i, p[2])
s.close()</pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Create a plot of the streaming data. We can plot the streaming data by running <code class="literal">stream-plot-data.py</code>, as follows:</li></ol></div><pre class="programlisting">./stream-plot-data.py Sm</pre><p>The code to plot the streaming data is as follows:</p><pre class="programlisting">#!/usr/bin/python

import sys
import re
import time
import matplotlib.pyplot as plt
import matplotlib.dates as mdate
from pytz import timezone

x = []
y = []

file = open(sys.argv[1], 'r')
for line in file:
   parts = re.split("\s+", line)

    data = parts[1].split(",")

    for field in data:
        match = re.match(sys.argv[2] + '=(\d+\.\d+).*', field)
        if match:
            timestamp = float(parts[0])
            x.append(timestamp)
            #time_parts = time.localtime(timestamp)
            y.append(float(match.group(1)))

file.close()

#fig, ax = plt.subplots()
fig = plt.figure()
ax = fig.add_subplot(111)

secs = mdate.epoch2num(x)

ax.plot_date(secs, y)

plt.xlabel('time')
plt.ylabel(sys.argv[2])

date_formatter = mdate.DateFormatter('%H:%M.%S', tz=timezone('US/Pacific'))
ax.xaxis.set_major_formatter(date_formatter)
fig.autofmt_xdate()

plt.show()</pre><p>From this <span>plot</span><a id="id325804934" class="indexterm"></a> diagram, we can see that the plot is updated less <span>frequently</span><a id="id325804942" class="indexterm"></a> than the first plot, since air temperature measurements are produced less frequently. To plot the graph, we used the <code class="literal">matplotlib</code> library. To format the time and date, we used the <code class="literal">timezone</code> library: </p><div class="mediaobject"><img src="/graphics/9781788620901/graphics/37b53b90-5a55-4ab3-9478-120c05ffa6c5.png" /></div><p>The preceding <span>plot</span><a id="id325806679" class="indexterm"></a> demonstrates the average wind speed (<span class="strong"><strong><strong class="userinput"><code>Sm</code></strong></strong></span>) and is <span>updated</span><a id="id325806786" class="indexterm"></a> every time a new measurement is generated. The plot is updated every second, as new data is pushed into the stack.</p></div>