<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec52"></a>Exploring streaming sensor data from the Twitter API</h2></div></div><hr /></div><p>In this section, we are going to use the Twitter <span>streaming</span><a id="id326266753" class="indexterm"></a> API to get some tweets. First we need to create a <span>Twitter</span><a id="id326267156" class="indexterm"></a> app. This can be done using the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Go to <a class="ulink" href="https://apps.twitter.com/" target="_blank">https://apps.twitter.com/</a>.
<div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc">Sign in using your Twitter account.</li><li style="list-style-type: disc">Sign up at <a class="ulink" href="https://twitter.com/signup" target="_blank">https://twitter.com/signup</a> if you don’t have a Twitter account.</li></ul></div></li><li>Click on <strong class="userinput"><code>Create New App.</code></strong></li><li>Fill in your application details and create the application.</li></ol></div><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>Notice that <code class="literal">consumer_key</code> and <code class="literal">consumer_secret</code> are already generated for you. Copy them and run the following commands, replacing the underlined variables with your unique values:</li></ol></div><pre class="programlisting"><span class="strong"><strong>$echo <span class="underline">consumer_key </span>&gt;&gt; auth
$echo <span class="underline">consumer_secret </span>&gt;&gt; auth</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="5" type="1"><li>Click <strong class="userinput"><code>Create my access token.</code></strong></li><li>Notice that <code class="literal">access_token</code> and <code class="literal">access_token_secret</code> now appear on your screen.</li><li>Copy them and run the following commands, replacing the underlined variables with your unique values:</li></ol></div><pre class="programlisting"><span class="strong"><strong>$echo <span class="underline">access_token</span> &gt;&gt; auth </strong></span>
<span class="strong"><strong>$echo <span class="underline">access_token_secret</span> &gt;&gt; auth</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="8" type="1"><li>Your authentication file, named <code class="literal">auth</code>, is ready with your credentials for use with <code class="literal">LiveTweets.py</code>.</li></ol></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec69"></a>Analyzing the streaming data</h3></div></div></div><p>Let's have a look at the <span>following</span><a id="id325808161" class="indexterm"></a> steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li>Open the command line interface of your choice.</li><li>Got to the required directory where you have downloaded the code file.</li></ol></div><pre class="programlisting"><span class="strong"><strong>cd Downloads/HandsOnBigData/CH08/json</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="3" type="1"><li>Let's use the script from here to view the contents of tweets in real time by running the <code class="literal">LiveTweets.py</code> script. To execute the <code class="literal">LiveTweets.py</code><span class="emphasis"><em> </em></span>script, run the following script:</li></ol></div><pre class="programlisting"><span class="strong"><strong>./LiveTweets.py president</strong></span></pre><p>The output displays two columns—the first is the timestamp of the tweet, and the second is the text of the tweet:</p><div class="mediaobject"><img src="/graphics/9781788620901/graphics/80a96412-dcd1-4acd-8370-c6d8a8c64c3b.png" /></div><p>The code snippet given for <code class="literal">LiveTweets.py</code> is given as follows:</p><pre class="programlisting">#!/usr/bin/python

import json
import sys
from tweepy import OAuthHandler, Stream
from tweepy.streaming import StreamListener

class TweetStreamListener(StreamListener):
 def on_data(self, data):
 tweet = json.loads(data)
 if "created_at" in tweet:
 print tweet["created_at"][4:-10] + " " + tweet["text"][:70] + "\n"
 return True

 def on_error(self, status):
 print status

auth = []
f = open("auth", "r")
for line in f:
 auth.append(line.strip())
f.close()

try:
 listener = TweetStreamListener()
 auth_key = OAuthHandler(auth[0], auth[1])
 auth_key.set_access_token(auth[2], auth[3])
 live_twitter_stream = Stream(auth_key, listener)
 live_twitter_stream.filter(track=[sys.argv[1]])
except KeyboardInterrupt, e:
 sys.exit()</pre><p>When you have enough <span>tweets</span><a id="id325813651" class="indexterm"></a> and think you are done, hit <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>C</em></span> to stop the script. We can also use the script to see tweets containing certain words. Let's execute the <code class="literal">LiveTweets.py</code><span class="emphasis"><em> </em></span>script to see tweets that include the word <code class="literal">time</code>:</p><pre class="programlisting"><span class="strong"><strong>./LiveTweets.py time</strong></span></pre><div class="orderedlist"><ol class="orderedlist arabic" start="4" type="1"><li>We can produce a plot displaying the frequency of tweets including a particular word. Run <code class="literal">PlotTweets.py president</code> to create the plot for the word <code class="literal">president</code>:</li></ol></div><pre class="programlisting"><span class="strong"><strong>./PlotTweets.py president
</strong></span></pre><p>The output is shown as follows:</p><div class="mediaobject"><img src="/graphics/9781788620901/graphics/cb0b540e-44c8-42d0-981c-8c2db3206fe0.png" /></div><p>The preceding graph demonstrates the variation of time and the number of <span>tweets</span><a id="id326106179" class="indexterm"></a> per second that include the word <code class="literal">president</code>. We can see that we got 11 tweets per second. To close, click in the Terminal window and press <span class="emphasis"><em>Enter</em></span>. The code snippet given for PlotTweet.py is given as follows:</p><pre class="programlisting">#!/usr/bin/python

import json
import matplotlib.pyplot as plt
import sys
from tweepy import OAuthHandler, Stream
from tweepy.streaming import StreamListener

class TweetStreamListener(StreamListener):

  def __init__(self):

        self.max_sec = 30

        fig = plt.figure()
        self.ax = fig.add_subplot(111)
        self.ax.set_autoscalex_on(False)
        self.ax.set_xlim(0, self.max_sec)
        self.ax.set_autoscaley_on(True)
        #self.ax.set_ylim(minVal,maxVal)

        plt.xlabel('Seconds')
        plt.ylabel('Count')
        fig.show()

        self.x = []
        self.y = []

        self.count = 0
        self.last_ts = "0"


    def on_data(self, data):
        tweet = json.loads(data)
        if "created_at" in tweet:
            ts = tweet["created_at"][11:-11]
            if ts == self.last_ts:
              self.count = self.count + 1
            else:
                #print(self.count)

                self.x.append(len(self.x))
                self.y.append(self.count)
                lines = plt.plot(self.x,self.y)
                plt.setp(lines,color='b')
                plt.draw()

                self.count = 1
                self.last_ts = ts

                if len(self.x) &gt; self.max_sec:
                    return False

        return True

    def on_error(self, status):
        print status


auth = []
f = open("auth", "r")
for line in f:
    auth.append(line.strip())
f.close()

try:
    listener = TweetStreamListener()
    auth_key = OAuthHandler(auth[0], auth[1])
    auth_key.set_access_token(auth[2], auth[3])
    live_twitter_stream = Stream(auth_key, listener)
    live_twitter_stream.filter(track=[sys.argv[1]])
    raw_input("Press &lt;enter&gt; to quit.")
except KeyboardInterrupt, e:
    sys.exit()</pre><p>The preceding <span>code</span><a id="id326106387" class="indexterm"></a> snippet plots the graph of live tweets. We are using <code class="literal">matplotlib</code> to plot the graph. To get the Twitter feed, we are using the <code class="literal">tweepy</code> library. The library provides functions to authenticate and get the stream data. We created a <code class="literal">python</code> class and called it using the command line. </p></div></div>